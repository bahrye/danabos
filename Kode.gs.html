/**
 * KONFIGURASI ID FILE
 * Tambahkan ID Folder Utama disini
 */
const CONFIG = {
  MASTER_DB_ID: '1ysd6zCjs7gE76LKG7S-PjvrbZroPh6ekGz6RB2dxTcc', 
  TEMPLATE_DB_ID: '1I1oIcDCQTGO-fJJBTcCgWwgNC-cOKUg_ES0b9ZAKwok',
  
  // ID FOLDER MASTER (Tempat menampung folder-folder sekolah)
  MASTER_PARENT_FOLDER_ID: '1jUXnLd0IR4v8kMzcu49PIFGncNoIoBQp',
  
  // ID TEMPLATE DOKUMEN
  TEMPLATE_ID_TOKO: '1Fl8Jaf4j6XIyF8TghkwUsmrqEKU7obVbuOWDxlIa56o',
  TEMPLATE_ID_GURU: '1pC4xjpoGpsCaidPqoWHjJAAFgwnuDnKPsONUrd3IeFg',
  TEMPLATE_ID_TUKANG: '1vNWFUOKIKob8SI0VX0ROxhZQ02Tl6eboiR2TZ7mzRqE'
};

/* --- ROUTING HALAMAN --- */
function doGet(e) {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Aplikasi LPJ BOS Sekolah')
    .setFaviconUrl("https://images.icon-icons.com/2760/PNG/512/correct_apply_done_icon_176355.png")
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

/* --- FUNGSI REGISTRASI & LOGIN --- */

/* --- FUNGSI REGISTRASI (UPDATE: SECURITY FIX) --- */
function registerSchool(form) {
  const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
  const data = ssMaster.getDataRange().getValues();
  
  // Cek Duplikasi Email
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email) return { status: 'error', message: 'Email sudah terdaftar!' };
  }

  try {
    // 1. Ambil Folder Utama
    const parentFolder = DriveApp.getFolderById(CONFIG.MASTER_PARENT_FOLDER_ID);

    // 2. Buat Folder [Nama Sekolah]
    const schoolFolder = parentFolder.createFolder(form.namaSekolah);
    const schoolFolderId = schoolFolder.getId();

    // 3. Buat Sub-Folder [Kop Sekolah] & [File Generate]
    const folderKop = schoolFolder.createFolder("Kop Sekolah");
    const folderGenerate = schoolFolder.createFolder("File Generate");

    // [SECURITY FIX] JANGAN SET FOLDER JADI PUBLIK
    // Baris di bawah ini dihapus/dikomentari agar folder tetap aman (Privat)
    // folderGenerate.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    // 4. Copy Template DB ke dalam Folder Sekolah
    const templateFile = DriveApp.getFileById(CONFIG.TEMPLATE_DB_ID);
    const newDbFile = templateFile.makeCopy('DB LPJ - ' + form.namaSekolah, schoolFolder);
    const newDbId = newDbFile.getId();

    // 5. Set Permission File DB (Agar bisa diedit user)
    // DB tetap perlu akses edit, tapi karena user login via Web App (Exec as Me),
    // sebenarnya user tidak butuh akses langsung ke file DB jika semua via Script.
    // Tapi untuk debugging, kita biarkan dulu atau bisa diperketat nanti.
    newDbFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.EDIT);

    // 6. SIMPAN ID FOLDER KE DATABASE SEKOLAH (Sheet DataPengaturan)
    const ssNew = SpreadsheetApp.openById(newDbId);
    let sheetSet = ssNew.getSheetByName('DataPengaturan');
    if (!sheetSet) {
      sheetSet = ssNew.insertSheet('DataPengaturan');
      sheetSet.appendRow(['KEY', 'VALUE']);
    }

    sheetSet.appendRow(['FOLDER_SEKOLAH_ID', schoolFolderId]);
    sheetSet.appendRow(['FOLDER_KOP_ID', folderKop.getId()]);
    sheetSet.appendRow(['FOLDER_PDF_ID', folderGenerate.getId()]);

    // 7. Simpan User ke Master Database
    ssMaster.appendRow([new Date(), form.namaSekolah, form.email, form.password, newDbId]);

    return { status: 'success', message: 'Registrasi berhasil! Folder & Database telah dibuat.' };

  } catch (e) {
    const pesan = beautifyError(
      "Gagal Mendaftarkan Sekolah", 
      e, 
      "Cek ID Folder Master di CONFIG apakah sudah benar. Pastikan akun memiliki akses Edit ke folder tersebut."
    );
    return { status: 'error', message: pesan };
  }
}

// Fungsi Login
function loginUser(form) {
  const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
  const data = ssMaster.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == form.email && data[i][3] == form.password) {
      return { status: 'success', token: data[i][4], namaSekolah: data[i][1] };
    }
  }
  return { status: 'error', message: 'Email atau Password salah!' };
}

/* --- FUNGSI CRUD DATA (User Spesifik) --- */

function simpanTransaksi(token, dataTransaksi) {
  try {
    const ss = SpreadsheetApp.openById(token); // Buka DB spesifik milik sekolah
    const sheet = ss.getSheetByName('Transaksi');
    
    // Generate ID Unik
    const id = Utilities.getUuid();
    
    sheet.appendRow([
      id,
      new Date(),
      dataTransaksi.nomorSurat,
      dataTransaksi.toko,
      JSON.stringify(dataTransaksi.items), // Item barang disimpan sbg JSON string
      dataTransaksi.total,
      dataTransaksi.terbilang
    ]);
    
    return { status: 'success', message: 'Data Transaksi Tersimpan!' };
  } catch (e) {
    return { status: 'error', message: 'Gagal menyimpan: ' + e.toString() };
  }
}

/* --- FUNGSI GENERATE PDF (UPDATE FIX: ITEM SAFETY & GAMBAR KOP SURAT) --- */
function generateLPJ(token, dataForm) {
  try {
    // [FIX A] Sanitasi Data Items (Mencegah crash jika items null)
    const itemsSafe = Array.isArray(dataForm.items) ? dataForm.items : [];

    const ss = SpreadsheetApp.openById(token);
    
    // Tentukan Template ID
    let templateId = '';
    const tipe = dataForm.tipe; 

    // [MODIFIKASI] Cek DataPengaturan dulu (Custom User), kalau kosong baru pakai CONFIG (Default)
    const customIdToko = getSettingValue(token, 'TEMPLATE_ID_TOKO');
    const customIdGuru = getSettingValue(token, 'TEMPLATE_ID_GURU');
    const customIdTukang = getSettingValue(token, 'TEMPLATE_ID_TUKANG');

    if (tipe === 'TOKO') {
        templateId = customIdToko && customIdToko !== "" ? customIdToko : CONFIG.TEMPLATE_ID_TOKO;
    } else if (tipe === 'GURU') {
        templateId = customIdGuru && customIdGuru !== "" ? customIdGuru : CONFIG.TEMPLATE_ID_GURU;
    } else if (tipe === 'TUKANG') {
        templateId = customIdTukang && customIdTukang !== "" ? customIdTukang : CONFIG.TEMPLATE_ID_TUKANG;
    }
    
    if (!templateId) return { status: 'error', message: 'ID Template tidak ditemukan.' };

    // --- AMBIL DATA DARI DATABASE (SURAT & TANGGAL) ---
    const sheetTrans = ss.getSheetByName('DataTransaksi');
    const rowsTrans = sheetTrans.getDataRange().getValues();
    let dbSurat = {}, dbTanggal = {};
    
    const transRow = rowsTrans.find(r => r[0] === dataForm.idTransaksi);
    if (transRow) {
        try { dbSurat = JSON.parse(transRow[9]); } catch(e) {}
        try { dbTanggal = JSON.parse(transRow[10]); } catch(e) {}
    }

    // Ambil Data Sekolah & Uraian
    const resSekolah = getDataSekolah(token);
    const ds = resSekolah.data || {}; 

    let nomorBuktiUraian = "-";
    const resUraian = getUraianList(token);
    if (resUraian.status === 'success' && resUraian.data) {
        const uraianFound = resUraian.data.find(u => u.uraian.trim() === dataForm.uraian.trim());
        if (uraianFound) nomorBuktiUraian = uraianFound.noBukti;
    }

    // --- PERBAIKAN PESAN ERROR ID TEMPLATE ---
    
    // 1. Cek apakah ID kosong
    if (!templateId || templateId.trim() === "") {
       return { status: 'error', message: 'ID Template masih kosong. Silakan isi ID Template di menu Cetak PDF > Pengaturan Template.' };
    }

    // 2. Coba ambil file, jika ID salah tangkap errornya
    let docFile;
    try {
      docFile = DriveApp.getFileById(templateId);
    } catch (e) {
      // PERBAIKAN: Pesan Error menggunakan format HTML (Lebih Keren)
      return { 
        status: 'error', 
        message: 
          '<div style="text-align: left; font-size: 0.95rem;">' +
            '<div style="background: #ffe6e6; border-left: 5px solid #dc3545; padding: 10px; margin-bottom: 10px; color: #a71d2a;">' +
              '<b>Gagal Membaca File Template!</b>' +
            '</div>' +
            
            '<p style="margin-bottom: 5px;">Sistem tidak dapat menemukan file dengan ID berikut:</p>' +
            
            '<div style="background: #f1f3f5; padding: 8px; border-radius: 4px; font-family: monospace; font-weight: bold; color: #333; border: 1px dashed #ccc; text-align: center; margin-bottom: 10px;">' + 
               templateId + 
            '</div>' +

            '<b>Kemungkinan Penyebab:</b>' +
            '<ul style="margin: 5px 0 10px 20px; color: #555;">' +
              '<li>ID Template salah ketik / terpotong.</li>' +
              '<li>File Google Doc tersebut sudah dihapus.</li>' +
              '<li>Akses file masih <i>Restricted</i> (Privat).</li>' +
            '</ul>' +

            '<b>Solusi:</b><br>' +
            'Pastikan setting Share file adalah <i>"Anyone with the link can view"</i>.' +
          '</div>' 
      };
    }

    const tempDocFile = docFile.makeCopy('LPJ_' + tipe + '_' + new Date().getTime());
    // -----------------------------------------
    const doc = DocumentApp.openById(tempDocFile.getId());
    const body = doc.getBody();
    const safeReplace = (key, val) => body.replaceText(key, val || '-');

    // =========================================================================
    // [FIX B] PERBAIKAN LOGIKA PENGGANTIAN GAMBAR KOP SURAT
    // =========================================================================
    
    // Fungsi Helper Lokal: Ganti Placeholder dengan Gambar (Dengan Safety Loop)
    const replaceAllWithImage = (container, placeholderText, blobImage) => {
      if (!container) return; 

      let searchResult = container.findText(placeholderText);
      let safetyCounter = 0;
      const MAX_LOOPS = 20; // Batasi maksimal 20 gambar per container untuk mencegah hang

      while (searchResult && safetyCounter < MAX_LOOPS) {
        safetyCounter++; 
        
        const textElement = searchResult.getElement();
        const parent = textElement.getParent();
        
        try {
          // Hapus teks placeholder
          textElement.removeFromParent();
          
          // Masukkan Gambar
          const imgBlobCopy = blobImage.copyBlob(); 
          // Insert di index 0 (paling atas dari elemen parent placeholder)
          const img = parent.insertInlineImage(0, imgBlobCopy);
          
          // Resize Logika (Max Lebar 600px)
          if (img.getWidth() > 600) {
             const ratio = img.getHeight() / img.getWidth();
             img.setWidth(600);
             img.setHeight(600 * ratio);
          }
        } catch(err) {
          // Jika gagal insert gambar, biarkan kosong agar tidak error fatal
          console.error("Gagal insert gambar: " + err);
        }

        // Cari lagi kejadian berikutnya
        searchResult = container.findText(placeholderText);
      }
    };

    // Eksekusi Penggantian Kop Surat
    const kopSuratId = getSettingValue(token, 'KOP_SURAT_ID');
    if (kopSuratId) {
      try {
        const kopFile = DriveApp.getFileById(kopSuratId);
        const kopBlob = kopFile.getBlob();

        // Ganti di Header & Body
        replaceAllWithImage(doc.getHeader(), '<<KOP SURAT>>', kopBlob);
        replaceAllWithImage(body, '<<KOP SURAT>>', kopBlob);

      } catch (e) {
        // Jika file kop tidak ketemu/error, hapus teksnya saja
        safeReplace('<<KOP SURAT>>', ''); 
      }
    } else {
       safeReplace('<<KOP SURAT>>', '');
    }
    // =========================================================================


    // --- REPLACE DATA UMUM ---
    safeReplace('<<Nomor Bukti Uraian>>', nomorBuktiUraian);
    safeReplace('<<Nama Sekolah>>', ds.namaSekolah);
    safeReplace('<<Nama Madrasah>>', ds.namaSekolah);
    safeReplace('<<Alamat Lengkap Sekolah>>', ds.alamat + ', ' + ds.kecamatan + ', ' + ds.kabupaten);
    safeReplace('<<Alamat TTD Sekolah>>', ds.tempatTTD);
    safeReplace('<<Kecamatan>>', ds.kecamatan);
    safeReplace('<<Kabupaten>>', ds.kabupaten);
    safeReplace('<<Provinsi>>', ds.provinsi);
    
    safeReplace('<<Total>>', formatRupiah(dataForm.total));
    safeReplace('<<Total Terbilang>>', terbilang(dataForm.total) + ' Rupiah');
    
    safeReplace('<<Nama Dana BOS>>', ds.danaBOS);
    safeReplace('<<Periode>>', ds.periodeAnggaran);
    safeReplace('<<Tahun Anggaran>>', ds.tahunAnggaran);
    
    safeReplace('<<NAMA KEPALA SEKOLAH>>', ds.namaKepala);
    safeReplace('<<Nama Kepala Sekolah>>', ds.namaKepala);
    safeReplace('<<NAMA BENDAHARA>>', ds.namaBendahara);

    // --- LOGIKA KHUSUS BERDASARKAN TIPE ---
    if (tipe === 'TUKANG') {
        let alamatTukang = "................................";
        const sheetTukang = ss.getSheetByName('DataTukang');
        if (sheetTukang) {
            const dataTukang = sheetTukang.getDataRange().getValues();
            const tkg = dataTukang.find(r => r[1] === dataForm.pihakKetiga);
            if (tkg) alamatTukang = tkg[2];
        }

        safeReplace('<<Nama Tukang>>', dataForm.pihakKetiga);
        safeReplace('<<NAMA TUKANG>>', dataForm.pihakKetiga.toUpperCase());
        safeReplace('<<Alamat Lengkap Tukang>>', alamatTukang);
        safeReplace('<<Uraian Pekerjaan>>', dataForm.uraian);

        let namaPemesan = dataForm.pemesan || "-"; 
        let nipPemesan = "-";
        const sheetGuru = ss.getSheetByName('DataGuru');
        if (sheetGuru) {
             const dataGuru = sheetGuru.getDataRange().getValues();
             const guruFound = dataGuru.find(r => String(r[1]).trim() === String(namaPemesan).trim());
             if (guruFound) nipPemesan = String(guruFound[2]).replace(/'/g, '') || "-";
        }
        safeReplace('<<NAMA PEMESAN TUKANG>>', namaPemesan);
        safeReplace('<<NIP PEMESAN TUKANG>>', nipPemesan);

        // Surat & Tanggal Tukang
        safeReplace('<<Surat Permintaan Tukang>>', dbSurat.permintaan || '-');
        safeReplace('<<Nomor Surat BA.PP>>', dbSurat.baPemeriksaan || '-');
        safeReplace('<<Nomor Surat BA.STP>>', dbSurat.baSerahTerima || '-');
        safeReplace('<<Nomor Surat BA.Bayar>>', dbSurat.baPembayaran || '-');

        const tglTrans = dataForm.tanggal;
        const tglMinta = dbTanggal.permintaan || tglTrans;
        safeReplace('<<Tanggal Surat Permintaan Tukang>>', formatTanggalIndo(tglMinta));

        const tglPP = dbTanggal.baPemeriksaan || tglTrans;
        const detPP = getIndonesianDateDetails(tglPP);
        safeReplace('<<Tgl BA.PP>>', formatTanggalIndo(tglPP));
        safeReplace('<<Tanggal BA.PP>>', formatTanggalIndo(tglPP));
        safeReplace('<<Hari Huruf Tanggal BA.PP>>', detPP.hari);
        safeReplace('<<Tanggal Huruf BA.PP>>', detPP.tanggal);
        safeReplace('<<Bulan Huruf Tanggal BA.PP>>', detPP.bulan);
        safeReplace('<<Tahun Huruf Tanggal BA.PP>>', detPP.tahun);

        const tglSTP = dbTanggal.baSerahTerima || tglTrans;
        const detSTP = getIndonesianDateDetails(tglSTP);
        safeReplace('<<Tanggal BA.STP>>', formatTanggalIndo(tglSTP));
        safeReplace('<<Hari Huruf Tanggal BA.STP>>', detSTP.hari);
        safeReplace('<<Tanggal Huruf BA.STP>>', detSTP.tanggal);
        safeReplace('<<Bulan Huruf Tanggal BA.STP>>', detSTP.bulan);
        safeReplace('<<Tahun Huruf Tanggal BA.STP>>', detSTP.tahun);

        const tglBayar = dbTanggal.baPembayaran || tglTrans;
        const detBayar = getIndonesianDateDetails(tglBayar);
        safeReplace('<<Tanggal BA.Bayar>>', formatTanggalIndo(tglBayar));
        safeReplace('<<Hari Huruf Tanggal BA.Bayar Tukang>>', detBayar.hari);
        safeReplace('<<Tanggal Huruf BA.Bayar Tukang>>', detBayar.tanggal);
        safeReplace('<<Bulan Huruf Tanggal BA.Bayar Tukang>>', detBayar.bulan);
        safeReplace('<<Tahun Huruf Tanggal BA.Bayar Tukang>>', detBayar.tahun);

    } else if (tipe === 'TOKO') {
        safeReplace('<<Nomor Surat Keluar>>', dataForm.nomorSurat); 
        safeReplace('<<Nama Toko>>', dataForm.pihakKetiga);
        safeReplace('<<Tanggal Transaksi>>', formatTanggalIndo(dataForm.tanggal));
        safeReplace('<<Tanggal BA.Bayar>>', formatTanggalIndo(dataForm.tanggal));

    } else if (tipe === 'GURU') {
        safeReplace('<<Uraian Kegiatan>>', dataForm.uraian);
        safeReplace('<<Keterangan>>', dataForm.pihakKetiga);
        safeReplace('<<Tanggal Transaksi>>', formatTanggalIndo(dataForm.tanggal));
        
        // [FIX A] Gunakan itemsSafe
        let namaPenerima = (itemsSafe.length > 0) ? itemsSafe[0].nama : "-";
        safeReplace('<<Nama Guru 1>>', namaPenerima);
        
        safeReplace('<<NAMA PEMESAN/GURU>>', dataForm.pemesan || "-");
    }

    // --- TABEL ITEM (FIX A) ---
    if (itemsSafe.length > 0) {
      const tables = body.getTables();
      let targetTable = null, rowIndexTemplate = -1;
      
      for (let t = 0; t < tables.length; t++) {
        for (let r = 0; r < tables[t].getNumRows(); r++) {
          if (tables[t].getRow(r).getText().includes('<<TABLE_ROW>>')) {
            targetTable = tables[t]; rowIndexTemplate = r; break;
          }
        }
        if (targetTable) break;
      }

      if (targetTable) {
        const templateRow = targetTable.getRow(rowIndexTemplate);
        
        itemsSafe.forEach((item, index) => {
           const newRow = targetTable.insertRow(rowIndexTemplate + index, templateRow.copy());
           try { newRow.getCell(0).setText((index + 1).toString()); } catch(e){}
           try { newRow.getCell(1).setText(item.nama || ""); } catch(e){} 
           try { newRow.getCell(2).setText((item.vol || 0).toString()); } catch(e){}
           try { newRow.getCell(3).setText(item.sat || ""); } catch(e){}
           try { newRow.getCell(4).setText(formatRupiah(item.harga || 0)); } catch(e){}
           try { newRow.getCell(5).setText(formatRupiah(item.jumlah || 0)); } catch(e){}
        });
        targetTable.removeRow(rowIndexTemplate + itemsSafe.length);
      }
    }
    
    doc.saveAndClose();

    // Konversi & Save PDF
    const pdfBlob = tempDocFile.getAs(MimeType.PDF);
    
    // [SECURITY FIX] Tambahkan UUID random 8 digit agar nama file tidak bisa ditebak
    // Contoh hasil: LPJ_TOKO_001_20251206120000_a1b2c3d4.pdf
    const uniqueSuffix = Utilities.formatDate(new Date(), "GMT+7", "yyyyMMddHHmmss");
    const randomCode = Utilities.getUuid().slice(0, 8); 
    const namaPdf = 'LPJ_' + tipe + '_' + (dbSurat.permintaan || 'DRAFT') + '_' + uniqueSuffix + '_' + randomCode + '.pdf';
    
    const pdfFile = DriveApp.createFile(pdfBlob).setName(namaPdf);
    
    // [SECURITY FIX] Set Permission HANYA untuk File ini saja (Bukan Folder)
    // Ini memungkinkan user membuka link PDF tanpa login Google, tapi tidak bisa melihat isi folder
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const folderGenerateId = getSettingValue(token, 'FOLDER_PDF_ID');
    if (folderGenerateId) {
       try {
         const folder = DriveApp.getFolderById(folderGenerateId);
         folder.addFile(pdfFile);
         DriveApp.getRootFolder().removeFile(pdfFile);
       } catch(e) {}
    }
    
    // Hapus File Doc Sementara
    tempDocFile.setTrashed(true);

    // Update Database dengan ID File PDF Baru
    const newFileId = pdfFile.getId();
    let sheetUpdate = ss.getSheetByName('DataTransaksi');
    if (sheetUpdate) {
      // [FIX C] Pastikan kolom File_PDF_ID ada
      const colIdxPdf = ensureColumn(sheetUpdate, 'File_PDF_ID');
      const colIdxId = ensureColumn(sheetUpdate, 'ID_Transaksi');

      const allData = sheetUpdate.getDataRange().getValues();
      for (let i = 1; i < allData.length; i++) {
        if (allData[i][colIdxId] == dataForm.idTransaksi) {
          // Update kolom PDF
          sheetUpdate.getRange(i + 1, colIdxPdf + 1).setValue(newFileId);
          
          // Hapus file PDF lama (Cek isi kolom PDF sebelumnya)
          const oldFileId = allData[i][colIdxPdf];
          if (oldFileId && oldFileId !== "-" && oldFileId !== newFileId) {
             try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {}
          }
          break;
        }
      }
    }
    
    return { status: 'success', url: pdfFile.getUrl() };

  } catch (e) {
    return { status: 'error', message: 'Gagal generate PDF: ' + e.toString() };
  }
}

/* --- HELPER DATE FORMATTING INDONESIA (UPDATE) --- */

function formatTanggalIndo(dateString) {
  if (!dateString) return "-";
  
  const d = new Date(dateString);
  const bulanIndo = [
    "Januari", "Februari", "Maret", "April", "Mei", "Juni", 
    "Juli", "Agustus", "September", "Oktober", "November", "Desember"
  ];

  // Ambil Tanggal (dd), Bulan (Index), dan Tahun (yyyy) zona waktu Jakarta
  const tanggal = Utilities.formatDate(d, "GMT+7", "dd");
  const bulanIndex = parseInt(Utilities.formatDate(d, "GMT+7", "M")) - 1; 
  const tahun = Utilities.formatDate(d, "GMT+7", "yyyy");

  // Pastikan index bulan valid
  if (bulanIndex < 0 || bulanIndex > 11) return "-";

  // Gabungkan: 07 + Desember + 2025
  return tanggal + " " + bulanIndo[bulanIndex] + " " + tahun;
}

function getIndonesianDateDetails(dateString) {
  if (!dateString) return { hari: '-', tanggal: '-', bulan: '-', tahun: '-' };
  
  const d = new Date(dateString);
  const hariArr = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
  const bulanArr = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
  
  const hariIndex = parseInt(Utilities.formatDate(d, "GMT+7", "u")) == 7 ? 0 : parseInt(Utilities.formatDate(d, "GMT+7", "u")); // Apps Script 'u' 1=Mon, 7=Sun
  
  // Ambil komponen
  const hariNama = hariArr[new Date(Utilities.formatDate(d, "GMT+7", "yyyy-MM-dd")).getDay()]; // getDay() 0=Sun
  const tglAngka = parseInt(Utilities.formatDate(d, "GMT+7", "d"));
  const blnIndex = parseInt(Utilities.formatDate(d, "GMT+7", "M")) - 1;
  const thnAngka = parseInt(Utilities.formatDate(d, "GMT+7", "yyyy"));
  
  return {
    hari: hariNama,
    tanggal: angkaKeTeks(tglAngka), // Fungsi konversi angka 1-31 ke teks
    bulan: bulanArr[blnIndex],
    tahun: angkaKeTeks(thnAngka)
  };
}

/* --- HELPER TERBILANG ANGKA (DENGAN PERBAIKAN SPASI) --- */
function angkaKeTeks(nilai) {
  const angka = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
  let temp = "";
  
  if (nilai < 12) {
    temp = " " + angka[nilai];
  } else if (nilai < 20) {
    temp = angkaKeTeks(nilai - 10) + " Belas";
  } else if (nilai < 100) {
    // Tambahkan spasi setelah "Puluh "
    temp = angkaKeTeks(Math.floor(nilai / 10)) + " Puluh " + angkaKeTeks(nilai % 10);
  } else if (nilai < 200) {
    // Tambahkan spasi setelah "Seratus "
    temp = " Seratus " + angkaKeTeks(nilai - 100);
  } else if (nilai < 1000) {
    // Tambahkan spasi setelah "Ratus "
    temp = angkaKeTeks(Math.floor(nilai / 100)) + " Ratus " + angkaKeTeks(nilai % 100);
  } else if (nilai < 2000) {
    // Tambahkan spasi setelah "Seribu "
    temp = " Seribu " + angkaKeTeks(nilai - 1000);
  } else if (nilai < 1000000) {
    // Tambahkan spasi setelah "Ribu "
    temp = angkaKeTeks(Math.floor(nilai / 1000)) + " Ribu " + angkaKeTeks(nilai % 1000);
  } else if (nilai < 1000000000) {
    // Tambahkan spasi setelah "Juta "
    temp = angkaKeTeks(Math.floor(nilai / 1000000)) + " Juta " + angkaKeTeks(nilai % 1000000);
  }
  
  // Hapus spasi berlebih di awal/akhir
  return temp.trim(); 
}

function formatRupiah(angka) {
  return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka);
}

// Fungsi Terbilang (Dengan Perbaikan Spasi & Trim)
function terbilang(nilai) {
  var bilangan = Math.abs(nilai);
  var angka = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
  var temp = "";
  
  if (bilangan < 12) {
    temp = " " + angka[bilangan];
  } else if (bilangan < 20) {
    temp = terbilang(bilangan - 10) + " Belas";
  } else if (bilangan < 100) {
    // Tambahkan spasi kiri-kanan pada "Puluh"
    temp = terbilang(Math.floor(bilangan / 10)) + " Puluh " + terbilang(bilangan % 10);
  } else if (bilangan < 200) {
    // Tambahkan spasi kiri-kanan pada "Seratus"
    temp = " Seratus " + terbilang(bilangan - 100);
  } else if (bilangan < 1000) {
    // Tambahkan spasi kiri-kanan pada "Ratus"
    temp = terbilang(Math.floor(bilangan / 100)) + " Ratus " + terbilang(bilangan % 100);
  } else if (bilangan < 2000) {
    // Tambahkan spasi kiri-kanan pada "Seribu"
    temp = " Seribu " + terbilang(bilangan - 1000);
  } else if (bilangan < 1000000) {
    // Tambahkan spasi kiri-kanan pada "Ribu"
    temp = terbilang(Math.floor(bilangan / 1000)) + " Ribu " + terbilang(bilangan % 1000);
  } else if (bilangan < 1000000000) {
    // Tambahkan spasi kiri-kanan pada "Juta"
    temp = terbilang(Math.floor(bilangan / 1000000)) + " Juta " + terbilang(bilangan % 1000000);
  }
  
  // PENTING: Hapus spasi di awal string agar rata kiri
  return temp.trim();
}

/* --- FUNGSI DATA SEKOLAH --- */

// 1. Ambil Data Sekolah (Update: Validasi Token & Error Handling)
function getDataSekolah(token) {
  try {
    // [PERBAIKAN 1] Validasi Token di Awal
    if (!token || typeof token !== 'string') {
      throw new Error("Token sesi tidak valid atau kosong. Silakan login ulang.");
    }

    // [PERBAIKAN 2] Coba Buka Spreadsheet dengan Error Catching Spesifik
    let ss;
    try {
      ss = SpreadsheetApp.openById(token);
    } catch (err) {
      // Jika gagal buka (misal file terhapus atau ID salah), lempar error yang jelas
      throw new Error("Database Sekolah tidak ditemukan atau Anda tidak memiliki akses. (ID: " + token + ")");
    }

    let sheet = ss.getSheetByName('DataSekolah');
    
    if (!sheet) {
      sheet = ss.insertSheet('DataSekolah');
      const headers = [
        "Nama Sekolah", "NPSN", "NSM", "Alamat Lengkap", "Provinsi", 
        "Kabupaten", "Kecamatan", "Kelurahan", "Tempat TTD",
        "Nama Kepala", "NIP Kepala", "Nama Bendahara", "NIP Bendahara", 
        "No Telp", "Email", "Nama Dana BOS",
        "Jumlah Anggaran", "Tahun Anggaran", "Periode Anggaran"
      ];
      sheet.appendRow(headers);
    }

    // Pastikan ada data di baris ke-2 (Baris Data)
    if (sheet.getLastRow() < 2) {
       // Return data kosong default jika belum ada isinya
       return {
         status: 'success',
         data: {
           namaSekolah: '', npsn: '', nsm: '', alamat: '', provinsi: '', kabupaten: '',
           kecamatan: '', kelurahan: '', tempatTTD: '', namaKepala: '', nipKepala: '',
           namaBendahara: '', nipBendahara: '', noTelp: '', email: '', danaBOS: '',
           jumlahAnggaran: 0, tahunAnggaran: '', periodeAnggaran: ''
         }
       };
    }

    // Ambil range diperluas jadi 19 kolom (A sampai S)
    // Gunakan pengecekan kolom terakhir untuk menghindari error "Range out of bounds"
    const lastCol = sheet.getLastColumn();
    // Kita butuh minimal 19 kolom, tapi jika sheetnya baru mungkin kurang.
    // getRange(row, col, numRows, numCols)
    const data = sheet.getRange(2, 1, 1, Math.max(lastCol, 19)).getValues()[0];
    
    return {
      status: 'success',
      data: {
        namaSekolah: data[0] || '',
        npsn: data[1] || '',
        nsm: data[2] || '',
        alamat: data[3] || '',
        provinsi: data[4] || '',
        kabupaten: data[5] || '',
        kecamatan: data[6] || '',
        kelurahan: data[7] || '',
        tempatTTD: data[8] || '',
        namaKepala: data[9] || '',
        nipKepala: data[10] || '',
        namaBendahara: data[11] || '',
        nipBendahara: data[12] || '',
        noTelp: data[13] || '',
        email: data[14] || '',
        danaBOS: data[15] || '',
        jumlahAnggaran: data[16] || 0,
        tahunAnggaran: data[17] || '',
        periodeAnggaran: data[18] || '' 
      }
    };
  } catch (e) {
    const pesan = beautifyError(
      "Database Tidak Ditemukan", 
      e, 
      "Sistem tidak bisa membuka file Database Sekolah. Kemungkinan file terhapus atau Anda login menggunakan akun yang berbeda."
    );
    return { status: 'error', message: pesan };
  }
}

// 2. Simpan Data Sekolah (Update: Simpan kolom Periode terpisah)
function simpanDataSekolah(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataSekolah');
    if (!sheet) return { status: 'error', message: 'Sheet DataSekolah tidak ditemukan!' };

    // Format Text
    const npsnText = "'" + form.npsn; 
    const nsmText = form.nsm ? "'" + form.nsm : "";
    const telpText = "'" + form.noTelp;
    const nipKepalaText = form.nipKepala ? "'" + form.nipKepala : "";
    const nipBendaharaText = form.nipBendahara ? "'" + form.nipBendahara : "";

    // Pastikan header kolom periode ada (jika user lama)
    if(sheet.getLastColumn() < 19) {
       sheet.getRange(1, 19).setValue("Periode Anggaran");
    }

    const rowData = [
      form.namaSekolah,
      npsnText,
      nsmText,
      form.alamat,
      form.provinsi,
      form.kabupaten,
      form.kecamatan,
      form.kelurahan,
      form.tempatTTD, 
      form.namaKepala,
      nipKepalaText,
      form.namaBendahara,
      nipBendaharaText,
      telpText,
      form.email,
      form.danaBOS,       // Nama BOS murni
      form.jumlahAnggaran,
      form.tahunAnggaran,
      form.periodeAnggaran // <-- Simpan Periode disini
    ];

    sheet.getRange(2, 1, 1, rowData.length).setValues([rowData]);

    return { status: 'success', message: 'Data Sekolah berhasil disimpan!' };
  } catch (e) {
    const pesan = beautifyError(
      "Gagal Menyimpan Transaksi", 
      e, 
      "Cobalah refresh halaman. Jika masih gagal, lakukan 'Maintenance Database' di menu Data Sekolah untuk memperbaiki struktur tabel."
    );
    return { status: 'error', message: pesan };
  }
}

/* --- FUNGSI DATA URAIAN PEKERJAAN --- */

// 1. Ambil List Uraian
function getUraianList(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataUraian');
    
    // Jika belum ada, buat sheet baru
    if (!sheet) {
      sheet = ss.insertSheet('DataUraian');
      sheet.appendRow(["ID", "Nomor Bukti", "Uraian Pekerjaan"]); // Header
    }

    const data = sheet.getDataRange().getValues();
    // Hapus header (baris 1) dari hasil return
    const result = data.slice(1).map(row => {
      return { id: row[0], noBukti: row[1], uraian: row[2] };
    });

    return { status: 'success', data: result };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Simpan Uraian Baru
function simpanUraianBaru(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataUraian');
    if (!sheet) return { status: 'error', message: 'Sheet DataUraian tidak ditemukan' };

    const id = Utilities.getUuid(); // ID Unik untuk keperluan hapus/edit
    
    // Pakai tanda kutip (') untuk No Bukti agar format terjaga
    sheet.appendRow([id, "'" + form.noBukti, form.uraian]);

    return { status: 'success', message: 'Uraian berhasil ditambahkan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Hapus Uraian
function hapusUraianItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataUraian');
    const data = sheet.getDataRange().getValues();
    
    // Loop cari ID (kolom ke-0)
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1); // +1 karena index sheet mulai dari 1
        return { status: 'success', message: 'Data berhasil dihapus' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- TAMBAHAN DI FUNGSI DATA URAIAN --- */

// 4. Edit / Update Uraian
function editUraianItem(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataUraian');
    const data = sheet.getDataRange().getValues();
    
    // Loop cari ID yang cocok
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == form.id) { // Kolom 0 adalah ID
        
        // Update Baris Tersebut (Ingat +1 karena index array mulai 0, sheet mulai 1)
        // Kita update Kolom 2 (No Bukti) dan Kolom 3 (Uraian)
        
        const noBuktiText = "'" + form.noBukti; // Jaga format text
        
        sheet.getRange(i + 1, 2).setValue(noBuktiText);
        sheet.getRange(i + 1, 3).setValue(form.uraian);
        
        return { status: 'success', message: 'Data berhasil diperbarui!' };
      }
    }
    return { status: 'error', message: 'ID Data tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- TAMBAHAN: FUNGSI AMBIL REFERENSI MASTER (AUTOCOMPLETE) --- */
function getReferensiUraianMaster(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('Uraian');
    
    // Jika sheet tidak ada (file lama sebelum update), kembalikan array kosong
    if (!sheet) return { status: 'success', data: [] };

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return { status: 'success', data: [] }; // Hanya header atau kosong

    // Ambil Kolom A dari baris 2 sampai akhir
    const data = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    
    // Flatten array 2D [[val], [val]] menjadi 1D [val, val] dan filter yang kosong
    const cleanData = data.map(r => r[0]).filter(val => val !== "");

    return { status: 'success', data: cleanData };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI DATA TOKO --- */

// 1. Ambil List Toko
function getTokoList(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataToko');
    
    if (!sheet) {
      sheet = ss.insertSheet('DataToko');
      // Header: ID, Nama, Jenis, Alamat, Telp, Pemilik, Tempat TTD
      sheet.appendRow(["ID", "Nama Toko", "Jenis Toko", "Alamat Lengkap", "No Telp", "Nama Pemilik", "Tempat TTD"]);
    }

    const data = sheet.getDataRange().getValues();
    // Hapus header
    const result = data.slice(1).map(row => {
      return {
        id: row[0],
        nama: row[1],
        jenis: row[2],
        alamat: row[3],
        telp: row[4],
        pemilik: row[5],
        tempat: row[6]
      };
    });

    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Simpan Toko Baru
function simpanTokoBaru(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataToko');
    if (!sheet) return { status: 'error', message: 'Sheet DataToko tidak ditemukan' };

    const id = Utilities.getUuid();
    
    // Gunakan kutip satu (') untuk No Telp agar formatnya Text
    const telpText = "'" + form.telp;

    sheet.appendRow([
      id, 
      form.nama, 
      form.jenis, 
      form.alamat, 
      telpText, 
      form.pemilik, 
      form.tempat
    ]);

    return { status: 'success', message: 'Data Toko berhasil ditambahkan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Edit Data Toko
function editTokoItem(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataToko');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == form.id) {
        
        // Update Baris (Index + 1)
        const rowIdx = i + 1;
        const telpText = "'" + form.telp;

        // Update sel satu per satu sesuai kolom
        sheet.getRange(rowIdx, 2).setValue(form.nama);
        sheet.getRange(rowIdx, 3).setValue(form.jenis);
        sheet.getRange(rowIdx, 4).setValue(form.alamat);
        sheet.getRange(rowIdx, 5).setValue(telpText);
        sheet.getRange(rowIdx, 6).setValue(form.pemilik);
        sheet.getRange(rowIdx, 7).setValue(form.tempat);
        
        return { status: 'success', message: 'Data Toko berhasil diperbarui!' };
      }
    }
    return { status: 'error', message: 'ID Toko tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 4. Hapus Toko
function hapusTokoItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataToko');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Data Toko dihapus' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI DATA TUKANG --- */

// 1. Ambil List Tukang
function getTukangList(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataTukang');
    
    // Jika belum ada, buat sheet baru
    if (!sheet) {
      sheet = ss.insertSheet('DataTukang');
      // Header: ID, Nama Lengkap, Alamat Lengkap
      sheet.appendRow(["ID", "Nama Lengkap", "Alamat Lengkap"]);
    }

    const data = sheet.getDataRange().getValues();
    // Hapus header (baris 1) dan mapping data
    const result = data.slice(1).map(row => {
      return {
        id: row[0],
        nama: row[1],
        alamat: row[2]
      };
    });

    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Simpan Tukang Baru
function simpanTukangBaru(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataTukang');
    if (!sheet) return { status: 'error', message: 'Sheet DataTukang tidak ditemukan' };

    const id = Utilities.getUuid();
    
    sheet.appendRow([
      id, 
      form.nama, 
      form.alamat
    ]);

    return { status: 'success', message: 'Data Tukang berhasil ditambahkan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Edit Data Tukang
function editTukangItem(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTukang');
    const data = sheet.getDataRange().getValues();
    
    // Loop cari ID
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == form.id) {
        const rowIdx = i + 1;
        // Update kolom 2 (Nama) dan 3 (Alamat)
        sheet.getRange(rowIdx, 2).setValue(form.nama);
        sheet.getRange(rowIdx, 3).setValue(form.alamat);
        
        return { status: 'success', message: 'Data Tukang berhasil diperbarui!' };
      }
    }
    return { status: 'error', message: 'ID Tukang tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 4. Hapus Tukang
function hapusTukangItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTukang');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Data Tukang dihapus' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI DATA PEMESAN/GURU --- */

// 1. Ambil List Guru
function getGuruList(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataGuru');
    
    // Jika belum ada, buat sheet baru
    if (!sheet) {
      sheet = ss.insertSheet('DataGuru');
      // Header: ID, Nama Lengkap, NIP
      sheet.appendRow(["ID", "Nama Lengkap", "NIP"]);
    }

    const data = sheet.getDataRange().getValues();
    // Hapus header (baris 1)
    const result = data.slice(1).map(row => {
      return {
        id: row[0],
        nama: row[1],
        nip: row[2]
      };
    });

    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Simpan Guru Baru
function simpanGuruBaru(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataGuru');
    if (!sheet) return { status: 'error', message: 'Sheet DataGuru tidak ditemukan' };

    const id = Utilities.getUuid();
    
    // Format NIP sebagai text (pakai kutip satu) jika diisi
    const nipText = form.nip ? "'" + form.nip : "";

    sheet.appendRow([
      id, 
      form.nama, 
      nipText
    ]);

    return { status: 'success', message: 'Data Guru berhasil ditambahkan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Edit Data Guru
function editGuruItem(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataGuru');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == form.id) {
        const rowIdx = i + 1;
        const nipText = form.nip ? "'" + form.nip : "";

        // Update kolom 2 (Nama) dan 3 (NIP)
        sheet.getRange(rowIdx, 2).setValue(form.nama);
        sheet.getRange(rowIdx, 3).setValue(nipText);
        
        return { status: 'success', message: 'Data Guru berhasil diperbarui!' };
      }
    }
    return { status: 'error', message: 'ID Guru tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 4. Hapus Guru
function hapusGuruItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataGuru');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Data Guru dihapus' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI PENGATURAN KOP SURAT --- */

// 1. Simpan Kop Surat (Upload ke Drive & Simpan ID ke DB)
/* --- FUNGSI SIMPAN KOP SURAT (UPDATE: SIMPAN KE FOLDER KOP SEKOLAH) --- */
function simpanKopSurat(token, fileData) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    let oldFileId = null; 
    let rowIdxKop = -1;
    let folderKopId = null;

    // Cari ID File Lama dan ID Folder Kop dari Sheet Pengaturan
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'KOP_SURAT_ID') {
        oldFileId = data[i][1];
        rowIdxKop = i + 1;
      }
      if (data[i][0] === 'FOLDER_KOP_ID') {
        folderKopId = data[i][1];
      }
    }

    // Hapus File Lama
    if (oldFileId) { try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {} }

    // Upload File Baru
    const blob = Utilities.newBlob(Utilities.base64Decode(fileData.base64), fileData.mimeType, "KopSurat_" + Utilities.formatDate(new Date(), "GMT+7", "yyyyMMddHHmmss"));
    const file = DriveApp.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // --> PINDAHKAN KE FOLDER 'Kop Sekolah' JIKA ADA CONFIG ID-NYA
    if (folderKopId) {
      try {
        const folder = DriveApp.getFolderById(folderKopId);
        folder.addFile(file);
        DriveApp.getRootFolder().removeFile(file);
      } catch(e) {}
    }

    const newFileId = file.getId();

    // Simpan ID File ke Spreadsheet
    if (rowIdxKop !== -1) {
      sheet.getRange(rowIdxKop, 2).setValue(newFileId);
    } else {
      sheet.appendRow(['KOP_SURAT_ID', newFileId]);
    }

    return { status: 'success', message: 'Kop Surat berhasil diupload!', fileId: newFileId };
  } catch (e) {
    const pesan = beautifyError(
      "Gagal Upload Kop Surat", 
      e, 
      "Pastikan file berupa Gambar (JPG/PNG) dan ukurannya tidak lebih dari 2MB. Cek juga koneksi internet Anda."
    );
    return { status: 'error', message: pesan };
  }
}

// 2. Ambil Kop Surat (Untuk ditampilkan saat load)
function getKopSurat(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'success', fileId: null };

    const data = sheet.getDataRange().getValues();
    let fileId = null;

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'KOP_SURAT_ID') {
        fileId = data[i][1];
        break;
      }
    }

    return { status: 'success', fileId: fileId };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Hapus Kop Surat
function hapusKopSurat(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'error', message: 'Data tidak ditemukan' };

    const data = sheet.getDataRange().getValues();
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'KOP_SURAT_ID') {
        const fileId = data[i][1];
        // Hapus file di Drive
        try { DriveApp.getFileById(fileId).setTrashed(true); } catch(e) {}
        
        // Hapus data di Sheet
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Kop Surat dihapus.' };
      }
    }
    return { status: 'success', message: 'Tidak ada kop surat.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI BANTUAN TRANSAKSI --- */

// Cari fungsi ini dan update isinya
function getAllOptions(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    
    // 1. Ambil Uraian, Toko, Tukang, Guru (Code Lama)
    const uraian = getUraianList(token).data || [];
    const toko = getTokoList(token).data || [];
    const tukang = getTukangList(token).data || [];
    const guru = getGuruList(token).data || [];

    // 2. TAMBAHAN: Ambil Data Satuan
    let satuan = [];
    const sheetSatuan = ss.getSheetByName('Satuan');
    if (sheetSatuan) {
      const lastRow = sheetSatuan.getLastRow();
      if (lastRow >= 2) {
        // Ambil kolom A baris 2 sampai bawah
        const dataSat = sheetSatuan.getRange(2, 1, lastRow - 1, 1).getValues();
        // Flatten array dan filter yang kosong
        satuan = dataSat.map(r => r[0]).filter(val => val !== ""); 
      }
    }

    return {
      status: 'success',
      data: {
        uraian: uraian,
        toko: toko,
        tukang: tukang,
        guru: guru,
        satuan: satuan // <--- Kirim data satuan ke Client
      }
    };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI SIMPAN TRANSAKSI --- */

function simpanTransaksiBaru(token, data) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataTransaksi');

    // 1. Buat Sheet Transaksi jika belum ada
    if (!sheet) {
      sheet = ss.insertSheet('DataTransaksi');
      // Header Database
      sheet.appendRow([
        "ID_Transaksi", 
        "Tanggal", 
        "Tipe",         // Toko / Tukang
        "Uraian", 
        "Pihak_Ketiga", // Nama Toko / Nama Tukang
        "Pemesan",      // Nama Guru
        "Items_JSON",   // Detail Barang (disimpan format JSON text)
        "Total_Biaya",
        "Waktu_Input"
      ]);
    }

    // 2. Format Data
    const id = Utilities.getUuid();
    const timestamp = new Date();
    
    // Konversi Object Items menjadi String JSON agar masuk 1 sel
    const itemsString = JSON.stringify(data.items);
    
    // Pastikan data string aman (pakai kutip satu untuk teks)
    const rowData = [
      id,
      "'" + data.tanggal, // Format Text agar tanggal tidak berubah format
      data.tipe,
      data.uraian,
      data.pihakKetiga,
      data.pemesan,
      itemsString,
      data.total,
      timestamp
    ];

    // 3. Simpan
    sheet.appendRow(rowData);

    return { status: 'success', message: 'Transaksi berhasil disimpan!' };

  } catch (e) {
    return { status: 'error', message: 'Gagal menyimpan: ' + e.toString() };
  }
}

/* --- TAMBAHAN UPDATE: FUNGSI CRUD TRANSAKSI --- */

/* --- UPDATE: GET TRANSAKSI LIST (DYNAMIC COLUMNS) --- */
function getTransaksiList(token, tipe) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    if (!sheet) return { status: 'success', data: [] };

    // [FIX C] PETA HEADER
    const h = getHeaderMap(sheet);
    
    // Cek kolom wajib, jika tidak ada berarti sheet kosong/rusak
    if (h['ID_Transaksi'] === undefined) return { status: 'success', data: [] };

    const data = sheet.getDataRange().getValues();
    const result = [];
    
    const formatDate = (dateObj) => {
      if(!dateObj) return "";
      return Utilities.formatDate(new Date(dateObj), "GMT+7", "yyyy-MM-dd");
    };
    const formatDateDisplay = (dateObj) => {
      if(!dateObj) return "";
      return Utilities.formatDate(new Date(dateObj), "GMT+7", "dd-MM-yyyy");
    };

    // Loop data mulai dari baris 2 (index 1)
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      
      // Ambil data menggunakan Map Index
      const rowTipe = row[h['Tipe']];
      
      if (rowTipe === tipe) {
        let items = [], surat = null, tglSurat = null;
        
        // Ambil JSON Items dengan aman
        if (h['Items_JSON'] !== undefined) {
           try { items = JSON.parse(row[h['Items_JSON']]); } catch (err) { items = []; }
        }

        // Ambil Data Surat
        // Header "Data_Surat_JSON" mungkin belum ada di file lama, jadi cek undefined
        if (h['Data_Surat_JSON'] !== undefined && row[h['Data_Surat_JSON']]) { 
            try { surat = JSON.parse(row[h['Data_Surat_JSON']]); } catch (err) { surat = null; } 
        }

        // Ambil Data Tanggal
        if (h['Data_Tanggal_JSON'] !== undefined && row[h['Data_Tanggal_JSON']]) { 
            try { tglSurat = JSON.parse(row[h['Data_Tanggal_JSON']]); } catch (err) { tglSurat = null; } 
        }

        // Ambil PDF ID (Header mungkin "File_PDF_ID" atau kolom ke-12 manual sebelumnya)
        // Kita standarkan nama kolom PDF menjadi "File_PDF_ID"
        let pdfId = null;
        if (h['File_PDF_ID'] !== undefined) {
           pdfId = row[h['File_PDF_ID']];
        } else if (row.length > 11) { 
           // Fallback untuk data lama yang belum punya header File_PDF_ID (kolom L / index 11)
           pdfId = row[11]; 
        }

        result.push({
          id: row[h['ID_Transaksi']],
          tanggal: formatDate(row[h['Tanggal']]),
          tanggalDisplay: formatDateDisplay(row[h['Tanggal']]),
          tipe: rowTipe,
          uraian: row[h['Uraian']],
          pihakKetiga: row[h['Pihak_Ketiga']],
          pemesan: row[h['Pemesan']],
          items: items,
          total: row[h['Total_Biaya']],
          dataSurat: surat,
          dataTanggal: tglSurat,
          pdfId: pdfId
        });
      }
    }
    
    // Sort Date Ascending
    result.sort((a, b) => {
      if (a.tanggal < b.tanggal) return -1;
      if (a.tanggal > b.tanggal) return 1;
      return 0;
    });

    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: EDIT TRANSAKSI (DYNAMIC COLUMNS) --- */
function editTransaksiItem(token, data) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    
    // [FIX C] PETA HEADER
    const h = getHeaderMap(sheet);
    const allData = sheet.getDataRange().getValues();

    // Pastikan ID ada
    if (h['ID_Transaksi'] === undefined) return { status: 'error', message: 'Struktur Data Transaksi rusak (ID_Transaksi hilang).' };

    for (let i = 1; i < allData.length; i++) {
      // Cek ID menggunakan index dari Map
      if (allData[i][h['ID_Transaksi']] == data.id) { 
        const rowIdx = i + 1;
        const itemsString = JSON.stringify(data.items);

        // Fungsi helper lokal untuk update sel jika kolom ada
        const updateCell = (headerName, val) => {
          if (h[headerName] !== undefined) {
            // index map 0-based, getRange kolom 1-based, jadi +1
            sheet.getRange(rowIdx, h[headerName] + 1).setValue(val);
          }
        };

        updateCell('Tanggal', "'" + data.tanggal);
        updateCell('Uraian', data.uraian);
        updateCell('Pihak_Ketiga', data.pihakKetiga);
        updateCell('Pemesan', data.pemesan);
        updateCell('Items_JSON', itemsString);
        updateCell('Total_Biaya', data.total);
        
        return { status: 'success', message: 'Transaksi berhasil diperbarui!' };
      }
    }
    return { status: 'error', message: 'ID Transaksi tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Hapus Transaksi
function hapusTransaksiItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Transaksi berhasil dihapus.' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- TAMBAHAN FITUR NOMOR SURAT --- */

/* --- UPDATE: SIMPAN NOMOR SURAT (DYNAMIC) --- */
function simpanDataSurat(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    
    // Pastikan Kolom "Data_Surat_JSON" ada, jika tidak, buatkan.
    const colIndex = ensureColumn(sheet, 'Data_Surat_JSON'); // 0-based
    const idIndex = ensureColumn(sheet, 'ID_Transaksi');
    
    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (data[i][idIndex] == form.id) {
        const suratJson = JSON.stringify(form.dataSurat);
        sheet.getRange(i + 1, colIndex + 1).setValue(suratJson);
        return { status: 'success', message: 'Nomor Surat berhasil disimpan!' };
      }
    }
    return { status: 'error', message: 'Transaksi tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: SIMPAN TANGGAL SURAT (DYNAMIC) --- */
function simpanTanggalSurat(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    
    // Pastikan Kolom "Data_Tanggal_JSON" ada
    const colIndex = ensureColumn(sheet, 'Data_Tanggal_JSON');
    const idIndex = ensureColumn(sheet, 'ID_Transaksi');

    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (data[i][idIndex] == form.id) {
        const tglJson = JSON.stringify(form.dataTanggal);
        sheet.getRange(i + 1, colIndex + 1).setValue(tglJson);
        return { status: 'success', message: 'Tanggal Surat berhasil disimpan!' };
      }
    }
    return { status: 'error', message: 'Transaksi tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI DASHBOARD (UPDATE LENGKAP) --- */

function getDashboardStats(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    
    // 1. Ambil Data Sekolah Lengkap
    let sheetSekolah = ss.getSheetByName('DataSekolah');
    let schoolProfile = {};
    let anggaran = 0;
    
    if (sheetSekolah) {
      // Pastikan mengambil minimal 18 kolom
      const data = sheetSekolah.getRange(2, 1, 1, 18).getValues()[0];
      
      // === UPDATE BAGIAN INI AGAR LENGKAP ===
      schoolProfile = {
        nama: data[0] || '-',
        npsn: String(data[1] || '').replace(/'/g, '') || '-',
        nsm: String(data[2] || '').replace(/'/g, '') || '-',
        alamat: data[3] || '-',
        
        // TAMBAHAN DATA BARU (Agar tidak undefined)
        provinsi: data[4] || '',
        kabupaten: data[5] || '',
        kecamatan: data[6] || '-',
        kelurahan: data[7] || '-',
        tempatTTD: data[8] || '-',
        noTelp: String(data[13] || '').replace(/'/g, '') || '-', // Kolom No Telp
        
        // Data Pejabat
        kepala: data[9] || '-',
        nipKepala: String(data[10] || '').replace(/'/g, '') || '-',
        bendahara: data[11] || '-',
        nipBendahara: String(data[12] || '').replace(/'/g, '') || '-',
        email: data[14] || '-'
      };
      
      anggaran = Number(data[16]) || 0; 
    }

    // 2. Hitung Total Pengeluaran & Jumlah Transaksi
    let sheetTrans = ss.getSheetByName('DataTransaksi');
    let totalPengeluaran = 0;
    let jumlahTransaksi = 0;

    if (sheetTrans) {
      const dataTrans = sheetTrans.getDataRange().getValues();
      for (let i = 1; i < dataTrans.length; i++) {
        let biaya = Number(dataTrans[i][7]) || 0;
        totalPengeluaran += biaya;
        jumlahTransaksi++;
      }
    }

    return {
      status: 'success',
      data: {
        anggaran: anggaran,
        pengeluaran: totalPengeluaran,
        jumlahTransaksi: jumlahTransaksi,
        profile: schoolProfile // Data Profil dikirim disini
      }
    };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI BARU: HELPER UNTUK BACA SETTING FOLDER --- */
function getSettingValue(token, keyName) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return null;
    
    const data = sheet.getDataRange().getValues();
    for(let i=0; i<data.length; i++) {
      if(data[i][0] === keyName) return data[i][1];
    }
    return null;
  } catch(e) { return null; }
}

/* --- FUNGSI PENGATURAN NOMOR OTOMATIS --- */

// 1. Simpan Pengaturan Nomor Otomatis
function simpanSettingNomor(token, settings) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    let rowIdx = -1;

    // Cari Key SETTING_NOMOR_OTOMATIS
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'SETTING_NOMOR_OTOMATIS') {
        rowIdx = i + 1;
        break;
      }
    }

    const jsonSettings = JSON.stringify(settings);

    if (rowIdx !== -1) {
      sheet.getRange(rowIdx, 2).setValue(jsonSettings);
    } else {
      sheet.appendRow(['SETTING_NOMOR_OTOMATIS', jsonSettings]);
    }

    return { status: 'success', message: 'Pengaturan Nomor Otomatis disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Ambil Pengaturan Nomor Otomatis
function getSettingNomor(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'success', data: null };

    const data = sheet.getDataRange().getValues();
    let settings = null;

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'SETTING_NOMOR_OTOMATIS') {
        try {
          settings = JSON.parse(data[i][1]);
        } catch (e) { settings = null; }
        break;
      }
    }

    return { status: 'success', data: settings };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- HELPER: DYNAMIC HEADER MAPPING --- */
// Fungsi ini membaca baris pertama (Header) dan membuat peta { "NAMA_KOLOM": index_0_based }
function getHeaderMap(sheet) {
  if (!sheet) return {};
  // Ambil baris pertama saja
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const map = {};
  headers.forEach((h, i) => {
    // Simpan nama kolom sebagai key (trim spasi) dan indexnya
    if(h) map[String(h).trim()] = i; 
  });
  return map;
}

// Fungsi Helper untuk memastikan kolom ada, jika tidak ada maka buat baru
function ensureColumn(sheet, headerName) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  let colIndex = headers.indexOf(headerName);
  
  if (colIndex === -1) {
    // Jika tidak ketemu, buat di kolom terakhir + 1
    colIndex = headers.length; 
    sheet.getRange(1, colIndex + 1).setValue(headerName);
  }
  return colIndex; // Return 0-based index
}

/* --- FUNGSI MAINTENANCE: PERBAIKI STRUKTUR HEADER OTOMATIS --- */

/**
 * Fungsi ini mendefinisikan struktur kolom yang WAJIB ada di setiap sheet.
 * Jika kode Anda berkembang, tambahkan nama kolom baru di sini.
 */
const DB_SCHEMA = {
  'DataSekolah': [
    "Nama Sekolah", "NPSN", "NSM", "Alamat Lengkap", "Provinsi", 
    "Kabupaten", "Kecamatan", "Kelurahan", "Tempat TTD",
    "Nama Kepala", "NIP Kepala", "Nama Bendahara", "NIP Bendahara", 
    "No Telp", "Email", "Nama Dana BOS",
    "Jumlah Anggaran", "Tahun Anggaran", "Periode Anggaran"
  ],
  'DataUraian': [
    "ID", "Nomor Bukti", "Uraian Pekerjaan"
  ],
  'DataToko': [
    "ID", "Nama Toko", "Jenis Toko", "Alamat Lengkap", "No Telp", "Nama Pemilik", "Tempat TTD"
  ],
  'DataTukang': [
    "ID", "Nama Lengkap", "Alamat Lengkap"
  ],
  'DataGuru': [
    "ID", "Nama Lengkap", "NIP"
  ],
  'DataTransaksi': [
    "ID_Transaksi", "Tanggal", "Tipe", "Uraian", "Pihak_Ketiga", "Pemesan", 
    "Items_JSON", "Total_Biaya", "Waktu_Input", 
    "Data_Surat_JSON", "Data_Tanggal_JSON", "File_PDF_ID"
  ],
  'DataPengaturan': [
    "KEY", "VALUE"
  ]
};

/**
 * Jalankan fungsi ini sekali-sekali (Manual atau via Menu) 
 * untuk memastikan header di Spreadsheet sinkron dengan Kode.
 */
function perbaikiSemuaHeader(token) {
  try {
    // Jika token tidak diberikan (dijalankan manual dari editor), 
    // ganti string di bawah ini dengan ID Spreadsheet Anda untuk testing.
    // Atau panggil fungsi ini dari console browser/frontend.
    if (!token) {
       // Opsional: Throw error atau gunakan ID default untuk debug
       // token = "ID_SPREADSHEET_ANDA_DISINI"; 
       return { status: 'error', message: 'Token/ID Spreadsheet diperlukan.' };
    }

    const ss = SpreadsheetApp.openById(token);
    let logPerbaikan = [];

    // Loop setiap nama sheet yang ada di SCHEMA
    for (const [sheetName, requiredHeaders] of Object.entries(DB_SCHEMA)) {
      
      let sheet = ss.getSheetByName(sheetName);
      
      // 1. Buat Sheet jika belum ada
      if (!sheet) {
        sheet = ss.insertSheet(sheetName);
        logPerbaikan.push(`Sheet baru dibuat: ${sheetName}`);
      }

      // 2. Ambil Header yang sudah ada
      // Jika sheet kosong, existingHeaders adalah array kosong
      let existingHeaders = [];
      if (sheet.getLastColumn() > 0) {
        existingHeaders = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
        // Trim spasi agar pencocokan akurat
        existingHeaders = existingHeaders.map(h => String(h).trim());
      }

      // 3. Cek Header Wajib
      requiredHeaders.forEach(headerName => {
        if (!existingHeaders.includes(headerName)) {
          // Jika header tidak ditemukan, tambahkan di kolom terakhir + 1
          const newColIndex = sheet.getLastColumn() + 1;
          sheet.getRange(1, newColIndex).setValue(headerName);
          
          // Style Header Baru (Bold & Abu-abu) biar rapi
          sheet.getRange(1, newColIndex).setFontWeight("bold").setBackground("#efefef");
          
          logPerbaikan.push(`Header ditambahkan di ${sheetName}: ${headerName}`);
        }
      });

      // 4. Opsional: Bekukan Baris 1 (Freeze Top Row)
      sheet.setFrozenRows(1);
    }

    if (logPerbaikan.length > 0) {
      return { status: 'success', message: 'Perbaikan Selesai:\n' + logPerbaikan.join('\n') };
    } else {
      return { status: 'success', message: 'Struktur Database sudah sesuai (Tidak ada perubahan).' };
    }

  } catch (e) {
    return { status: 'error', message: 'Gagal memperbaiki header: ' + e.toString() };
  }
}

/* --- PENGATURAN TEMPLATE CUSTOM --- */

// 1. Simpan ID Template Custom ke DataPengaturan
function simpanTemplateSettings(token, settings) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    
    // Helper untuk update atau insert key-value
    const updateOrInsert = (key, val) => {
      let found = false;
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === key) {
          sheet.getRange(i + 1, 2).setValue(val);
          found = true;
          break;
        }
      }
      if (!found) sheet.appendRow([key, val]);
    };

    updateOrInsert('TEMPLATE_ID_TOKO', settings.toko);
    updateOrInsert('TEMPLATE_ID_GURU', settings.guru);
    updateOrInsert('TEMPLATE_ID_TUKANG', settings.tukang);

    return { status: 'success', message: 'Pengaturan Template berhasil disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Ambil ID Template Custom
function getTemplateSettings(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'success', data: { toko:'', guru:'', tukang:'' } };

    const data = sheet.getDataRange().getValues();
    let res = { toko: '', guru: '', tukang: '' };

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'TEMPLATE_ID_TOKO') res.toko = data[i][1];
      if (data[i][0] === 'TEMPLATE_ID_GURU') res.guru = data[i][1];
      if (data[i][0] === 'TEMPLATE_ID_TUKANG') res.tukang = data[i][1];
    }
    return { status: 'success', data: res };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- HELPER FORMAT PESAN ERROR (Agar Tampil Keren) --- */
function beautifyError(judul, errorObj, saran) {
  const errorText = errorObj ? errorObj.toString() : "Unknown Error";
  
  return '<div style="text-align: left; font-size: 0.9rem;">' +
           // Header Merah
           '<div style="background: #ffe6e6; border-left: 5px solid #dc3545; padding: 10px; margin-bottom: 15px; color: #a71d2a;">' +
             '<i class="fas fa-exclamation-triangle"></i> <b>' + judul + '</b>' +
           '</div>' +
           
           // Detail Error Teknis
           '<p style="margin-bottom: 5px; font-weight:bold;">Detail Pesan Sistem:</p>' +
           '<div style="background: #f8f9fa; color: #555; padding: 10px; border-radius: 4px; border: 1px dashed #ccc; font-family: monospace; font-size: 0.85rem; margin-bottom: 15px; word-wrap: break-word;">' + 
              errorText + 
           '</div>' +

           // Saran / Solusi
           '<div style="background: #e7f1ff; border-left: 5px solid #0d6efd; padding: 10px; color: #084298;">' +
             '<b><i class="fas fa-lightbulb"></i> Solusi:</b><br>' +
             saran +
           '</div>' +
         '</div>';
}

/* --- FUNGSI PENCARIAN REFERENSI BARANG (FITUR BARU) --- */
function cariBarangReferensi(token, keyword) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('Data Barang');
    
    // Jika sheet tidak ada, kembalikan array kosong (atau bisa buat otomatis)
    if (!sheet) return { status: 'success', data: [] };

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return { status: 'success', data: [] };

    // Ambil Data Kolom A (Nama) dan B (Satuan)
    // Kita ambil semua dulu baru filter di script (lebih cepat untuk data < 5000 baris)
    const data = sheet.getRange(2, 1, lastRow - 1, 2).getValues(); 
    
    const lowerKey = keyword.toLowerCase();
    
    // Filter data yang mengandung keyword
    const results = data
      .filter(row => row[0] && String(row[0]).toLowerCase().includes(lowerKey))
      .map(row => ({
        nama: row[0],
        satuan: row[1] || ''
      }));

    // Batasi hasil maksimal 15 agar tidak memberatkan UI
    return { status: 'success', data: results.slice(0, 15) };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}
