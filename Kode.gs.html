/**
 * KONFIGURASI ID FILE
 * Tambahkan ID Folder Utama disini
 */
const CONFIG = {
  MASTER_DB_ID: '1ysd6zCjs7gE76LKG7S-PjvrbZroPh6ekGz6RB2dxTcc', 
  TEMPLATE_DB_ID: '1I1oIcDCQTGO-fJJBTcCgWwgNC-cOKUg_ES0b9ZAKwok',
  
  // ID FOLDER MASTER (Tempat menampung folder-folder sekolah)
  MASTER_PARENT_FOLDER_ID: '1jUXnLd0IR4v8kMzcu49PIFGncNoIoBQp',
  
  // ID TEMPLATE DOKUMEN
  TEMPLATE_ID_TOKO: '1Fl8Jaf4j6XIyF8TghkwUsmrqEKU7obVbuOWDxlIa56o',
  TEMPLATE_ID_GURU: '1pC4xjpoGpsCaidPqoWHjJAAFgwnuDnKPsONUrd3IeFg',
  TEMPLATE_ID_TUKANG: '1vNWFUOKIKob8SI0VX0ROxhZQ02Tl6eboiR2TZ7mzRqE'
};

/* --- ROUTING HALAMAN --- */
function doGet(e) {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Aplikasi LPJ BOS Sekolah')
    .setFaviconUrl("https://images.icon-icons.com/2760/PNG/512/correct_apply_done_icon_176355.png")
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

/* --- HELPER KEAMANAN: HASH & SALT --- */

/**
 * Membuat Salt (kode acak unik) untuk setiap user
 */
function generateSalt() {
  return Utilities.getUuid(); // Menggunakan UUID sebagai salt yang unik
}

/**
 * Mengubah Password + Salt menjadi Hash SHA-256
 */
function hashPassword(password, salt) {
  if (!password || !salt) return "";
  
  // Gabungkan password dengan salt
  const raw = String(password) + String(salt);
  
  // Proses Hashing menggunakan SHA-256
  const digest = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, raw);
  
  // Konversi byte array ke String Hexadecimal
  let hash = "";
  for (let i = 0; i < digest.length; i++) {
    let byte = digest[i];
    if (byte < 0) byte += 256; // Handle signed byte
    let byteStr = byte.toString(16);
    if (byteStr.length == 1) byteStr = "0" + byteStr;
    hash += byteStr;
  }
  
  return hash;
}

/* --- FUNGSI REGISTRASI (UPDATE: DENGAN LOCK SERVICE) --- */
function registerSchool(form) {
  // A. MEMULAI PENGUNCIAN
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000); // Tunggu antrean maks 30 detik
  } catch (e) {
    return { status: 'error', message: 'Pendaftaran sedang padat. Mohon coba sesaat lagi.' };
  }

  try {
    const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
    const data = ssMaster.getDataRange().getValues();
    
    // Normalisasi nama sekolah & email
    const newSchoolNameClean = normalizeName(form.namaSekolah);
    const newEmailClean = form.email.trim().toLowerCase();

    // LOOP CEK DUPLIKASI (Sekarang aman dari race condition)
    for (let i = 1; i < data.length; i++) {
      const existingNameRaw = data[i][1]; 
      const existingEmail = data[i][2];   
      
      if (String(existingEmail).toLowerCase() === newEmailClean) {
        return { status: 'error', message: '<b>Email sudah terdaftar!</b><br>Silakan login atau reset password.' };
      }

      const existingNameClean = normalizeName(existingNameRaw);
      if (existingNameClean === newSchoolNameClean) {
        return { 
          status: 'error', 
          message: '<b>Sekolah Sudah Terdaftar!</b><br>Nama sekolah: "'+ form.namaSekolah +'" mirip dengan data yang sudah ada.' 
        };
      }
    }

    // PROSES SETUP FOLDER & FILE
    // (Proses ini agak lama, tapi dengan Lock, kita pastikan data di DB User tidak terduplikasi)
    
    // 1. Setup Folder & File Sekolah
    const parentFolder = DriveApp.getFolderById(CONFIG.MASTER_PARENT_FOLDER_ID);
    const schoolFolder = parentFolder.createFolder(form.namaSekolah);
    
    const folderKop = schoolFolder.createFolder("Kop Sekolah");
    const folderGenerate = schoolFolder.createFolder("File Generate");

    const templateFile = DriveApp.getFileById(CONFIG.TEMPLATE_DB_ID);
    const newDbFile = templateFile.makeCopy('DB LPJ - ' + form.namaSekolah, schoolFolder);
    const newDbId = newDbFile.getId();

    newDbFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.EDIT);

    // 2. Simpan Config Folder di Database Sekolah Baru
    const ssNew = SpreadsheetApp.openById(newDbId);
    let sheetSet = ssNew.getSheetByName('DataPengaturan');
    if (!sheetSet) {
      sheetSet = ssNew.insertSheet('DataPengaturan');
      sheetSet.appendRow(['KEY', 'VALUE']);
    }
    sheetSet.appendRow(['FOLDER_SEKOLAH_ID', schoolFolder.getId()]);
    sheetSet.appendRow(['FOLDER_KOP_ID', folderKop.getId()]);
    sheetSet.appendRow(['FOLDER_PDF_ID', folderGenerate.getId()]);

    // --- PROSES SECURITY ---
    const salt = generateSalt(); 
    const passwordHash = hashPassword(form.password, salt); 

    // 3. SIMPAN DATA KE DATABASE MASTER (USER)
    // appendRow sekarang aman karena dikunci
    ssMaster.appendRow([
      new Date(), 
      form.namaSekolah, 
      newEmailClean, 
      passwordHash, 
      newDbId, 
      "",            
      "", 
      salt, 
      ""  
    ]);

    return { 
      status: 'success', 
      message: 'Registrasi berhasil! Silakan login.' 
    };

  } catch (e) {
    const pesan = beautifyError("Gagal Registrasi", e, "Hubungi Admin.");
    return { status: 'error', message: pesan };
  } finally {
    // B. LEPASKAN KUNCI
    lock.releaseLock();
  }
}

/* --- FITUR RESET PASSWORD OTP (NEW) --- */

/**
 * Tahap 1: Request OTP
 * - Cek Email
 * - Cek Batas Harian (Maks 1x per hari)
 * - Generate OTP & Kirim Email
 */
/* --- UPDATE: REQUEST OTP DENGAN VALIDASI 1X KIRIM --- */
function requestResetOtp(emailInput) {
  const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
  const data = ssMaster.getDataRange().getValues();
  const targetEmail = emailInput.trim().toLowerCase();
  
  const today = Utilities.formatDate(new Date(), "GMT+7", "yyyy-MM-dd");
  const now = new Date();

  for (let i = 1; i < data.length; i++) {
    const dbEmail = String(data[i][2]).toLowerCase(); // Kolom C (Index 2)
    
    if (dbEmail === targetEmail) {
      const rowIdx = i + 1;
      
      // 1. CEK BATAS SUKSES RESET HARIAN (Kolom L / Index 11)
      const lastReset = data[i][11]; 
      let lastResetDate = "";
      if (lastReset) {
         lastResetDate = Utilities.formatDate(new Date(lastReset), "GMT+7", "yyyy-MM-dd");
      }

      if (lastResetDate === today) {
        return { 
          status: 'error', 
          message: '<b>Batas Terlampaui!</b><br>Anda sudah berhasil mereset password hari ini.<br>Akses reset dibatasi 1 kali per 24 jam.' 
        };
      }

      // 2. [BARU] CEK APAKAH SUDAH ADA OTP AKTIF (BELUM DIPAKAI)
      const existingOtp = data[i][9];       // Kolom J (Index 9)
      const existingExpiry = data[i][10];   // Kolom K (Index 10)
      
      // Jika ada OTP, DAN belum kadaluarsa
      if (existingOtp && existingOtp !== "" && existingExpiry && new Date(existingExpiry) > now) {
         return { 
          status: 'error', 
          message: '<b>Kode OTP Sudah Dikirim!</b><br>Sistem mendeteksi kode OTP aktif telah dikirim ke email ini dan belum kadaluarsa.<br><br>Silakan cek Inbox/Spam Anda, atau gunakan menu <b>"Sudah punya kode?"</b> untuk memasukkan kode tersebut.' 
        };
      }

      // --- JIKA LOLOS VALIDASI, BARU GENERATE BARU ---

      const otpCode = Math.floor(100000 + Math.random() * 900000).toString(); // 6 Digit
      const expiryTime = new Date(now.getTime() + (24 * 60 * 60 * 1000)); // +24 Jam
      
      // Simpan ke DB (Kolom J & K)
      ssMaster.getRange(rowIdx, 10).setValue(otpCode);
      ssMaster.getRange(rowIdx, 11).setValue(expiryTime);

      try {
        MailApp.sendEmail({
          to: targetEmail,
          subject: "[LPJ BOS] Kode Verifikasi Reset Password",
          htmlBody: `
            <h3>Permintaan Reset Password</h3>
            <p>Kode OTP Anda adalah:</p>
            <h1 style="background:#f4f4f4; padding:10px 20px; display:inline-block; letter-spacing:5px; border-radius:5px;">${otpCode}</h1>
            <p>Kode berlaku 24 jam. Jangan berikan kode ini ke siapapun.</p>
          `
        });
      } catch (e) {
        return { status: 'error', message: 'Gagal kirim email: ' + e.toString() };
      }

      return { status: 'success', message: 'Kode OTP telah dikirim ke email Anda.' };
    }
  }

  return { status: 'error', message: 'Email tidak terdaftar.' };
}

/**
 * Tahap 2: Verifikasi OTP & Ganti Password
 * - Cek Kesesuaian OTP
 * - Cek Expiry OTP
 * - Update Password
 * - Update Last Reset Date (Untuk kunci harian)
 */
function confirmResetOtp(form) {
  const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
  const data = ssMaster.getDataRange().getValues();
  
  const targetEmail = form.email.trim().toLowerCase();
  const inputOtp = String(form.otp).trim();
  const newPass = form.newPassword;
  
  const todayDateObj = new Date(); // Waktu sekarang untuk update last reset

  for (let i = 1; i < data.length; i++) {
    const dbEmail = String(data[i][2]).toLowerCase();
    
    if (dbEmail === targetEmail) {
      const rowIdx = i + 1;
      
      const dbOtp = String(data[i][9]); // Kolom J
      const dbExpiry = new Date(data[i][10]); // Kolom K

      // 1. Validasi OTP Kosong/Salah
      if (!dbOtp || dbOtp === "" || dbOtp !== inputOtp) {
        return { status: 'error', message: 'Kode OTP salah.' };
      }

      // 2. Validasi Kadaluarsa (24 Jam)
      if (new Date() > dbExpiry) {
        return { status: 'error', message: 'Kode OTP sudah kadaluarsa. Silakan minta kode baru.' };
      }

      // 3. SUKSES - UPDATE DATA
      
      const newSalt = generateSalt(); // Generate Salt Baru
      const newHash = hashPassword(newPass, newSalt); // Hash Password Baru
      
      // Update Password Hash (Kolom D / 4)
      ssMaster.getRange(rowIdx, 4).setValue(newHash);

      // Update Salt (Kolom H / 8) -> PENTING: Simpan salt baru juga
      ssMaster.getRange(rowIdx, 8).setValue(newSalt);
      
      // Update Last Reset Date (Kolom L / 12) -> Kunci agar tidak bisa reset lagi hari ini
      ssMaster.getRange(rowIdx, 12).setValue(todayDateObj);

      // Hapus OTP agar tidak bisa dipakai ulang (Opsional, tapi secure)
      ssMaster.getRange(rowIdx, 10).setValue(""); 
      ssMaster.getRange(rowIdx, 11).setValue("");

      return { status: 'success', message: 'Password berhasil diubah! Silakan login.' };
    }
  }
  
  return { status: 'error', message: 'Terjadi kesalahan sistem. Akun tidak ditemukan.' };
}

/* --- KONFIGURASI SESI --- */
// Batas waktu toleransi untuk menganggap user "Sedang Online"
// Jika browser mengirim sinyal dalam 60 detik terakhir, dianggap masih aktif.
const ACTIVE_THRESHOLD_SEC = 60; 

// Batas waktu sesi di database (30 menit)
const MAX_IDLE_TIME_MINUTES = 30; 

/* HELPER: CACHE SERVICE */
function setSessionCache(email, data) {
  const cache = CacheService.getScriptCache();
  // Simpan data sesi selama 6 jam di memori server
  cache.put('SESI_' + email.toLowerCase(), JSON.stringify(data), 21600); 
}

function getSessionCache(email) {
  const cache = CacheService.getScriptCache();
  const data = cache.get('SESI_' + email.toLowerCase());
  return data ? JSON.parse(data) : null;
}

function clearSessionCache(email) {
  const cache = CacheService.getScriptCache();
  cache.remove('SESI_' + email.toLowerCase());
}

/* --- 1. LOGIN USER (LOGIKA ANTI-DOUBLE LOGIN) --- */
function loginUser(form) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000); 
  } catch (e) {
    return { status: 'error', message: 'Antrean login padat. Coba lagi.' };
  }

  try {
    const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
    
    // 1. Cari User di Database
    const finder = ssMaster.getRange("C:C").createTextFinder(form.email).matchEntireCell(true);
    const found = finder.findNext();

    if (!found) {
      return { status: 'error', message: 'Email tidak ditemukan.' };
    }

    const rowIdx = found.getRow();
    // Ambil data user: [Time, Nama, Email, PassHash, DbID, SessionID, RecCode, SALT]
    const userData = ssMaster.getRange(rowIdx, 1, 1, 8).getValues()[0];

    const storedHash = String(userData[3]); 
    const storedSalt = String(userData[7]); 

    // 2. Verifikasi Password
    const inputHash = hashPassword(form.password, storedSalt);

    if (inputHash === storedHash) {
      const email = form.email.trim().toLowerCase();
      const now = new Date().getTime();
      
      // --- PENGECEKAN LOGIN GANDA DIMULAI DISINI ---
      const cachedSession = getSessionCache(email);
      
      if (cachedSession) {
        const lastPing = cachedSession.lastPing || 0;
        const diffSec = (now - lastPing) / 1000; // Selisih waktu dalam detik

        // LOGIKA ANDA:
        // Jika selisih waktu < 60 detik, berarti ada perangkat lain yang BARU SAJA aktif.
        // Maka kita TOLAK login baru ini.
        if (diffSec < ACTIVE_THRESHOLD_SEC) { 
           return { 
            status: 'error', 
            message: '<b>Login Ganda Terdeteksi!</b><br>Akun ini sedang aktif digunakan di perangkat lain.<br>Harap logout dari perangkat sebelumnya atau tunggu 1 menit.' 
          };
        }
        
        // JIKA LEBIH DARI 60 DETIK:
        // Berarti sesi lama sudah "bangkai" (orangnya tutup tab/idle lama).
        // Kita BIARKAN login ini masuk, dan sesi lama otomatis tertimpa (terhapus).
      }
      // ---------------------------------------------

      // 3. BUAT SESI BARU (Menimpa sesi lama jika ada)
      const newSessionId = Utilities.getUuid();
      
      // Simpan ke Cache Server (Agar fungsi heartbeat/updateUserActivity bisa jalan)
      setSessionCache(email, {
        token: newSessionId,
        lastPing: now
      });

      // Simpan Token ke Database Spreadsheet (Agar persist)
      ssMaster.getRange(rowIdx, 6).setValue(newSessionId);

      return { 
        status: 'success', 
        token: userData[4],        
        namaSekolah: userData[1],  
        sessionToken: newSessionId 
      };
    }
    
    return { status: 'error', message: 'Password salah!' };

  } catch (e) {
    return { status: 'error', message: 'Error: ' + e.toString() };
  } finally {
    lock.releaseLock();
  }
}

/* --- 2. HEARTBEAT (Update Waktu Aktif & Auto Logout DB) --- */
function updateUserActivity(email, clientToken) {
  const cachedSession = getSessionCache(email);
  const now = new Date().getTime();
  
  // A. JIKA CACHE KOSONG (Mungkin karena dibersihkan saat simpan data, atau server restart)
  if (!cachedSession) {
    // --- [PERBAIKAN] LOGIKA SELF-HEALING (FALLBACK KE DB) ---
    // Jangan langsung logout! Cek dulu ke Database Master.
    try {
      const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
      // Cari user berdasarkan email
      const finder = ssMaster.getRange("C:C").createTextFinder(email).matchEntireCell(true);
      const found = finder.findNext();

      if (found) {
        const rowIdx = found.getRow();
        const dbSession = ssMaster.getRange(rowIdx, 6).getValue(); // Ambil Session ID di DB (Kolom F)

        // JIKA TOKEN DI DB COCOK DENGAN CLIENT
        if (dbSession === clientToken) {
          // KEMBALIKAN CACHE (RESTORE/HEAL)
          setSessionCache(email, {
            token: dbSession,
            lastPing: now
          });
          return { valid: true }; // User selamat, tidak jadi logout
        }
      }
    } catch (e) {
      console.error("Gagal cek DB saat heartbeat: " + e.toString());
    }

    // Jika di DB juga tidak cocok/kosong, baru lakukan logout paksa
    hapusSesiDiDatabase(email); 
    return { valid: false }; 
  }

  // B. VALIDASI TOKEN (Kunci Anti-Ganda)
  if (cachedSession.token !== clientToken) {
    return { valid: false }; // Token beda -> Logout
  }

  // C. Auto Logout jika idle > 30 menit
  const lastPing = cachedSession.lastPing || 0;
  const diffMin = (now - lastPing) / 1000 / 60;

  if (diffMin > MAX_IDLE_TIME_MINUTES) {
    clearSessionCache(email); 
    hapusSesiDiDatabase(email); 
    return { valid: false }; 
  }

  // D. Update Waktu Ping Terakhir (User Masih Aktif)
  cachedSession.lastPing = now;
  setSessionCache(email, cachedSession);
  
  return { valid: true };
}

/* --- HELPER BARU: HAPUS SESI DI SPREADSHEET --- */
function hapusSesiDiDatabase(email) {
  try {
    const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
    const data = ssMaster.getDataRange().getValues();
    
    // Loop cari email dan hapus kolom Session ID (Kolom F / Index 5)
    for (let i = 1; i < data.length; i++) {
      // Bandingkan email (Kolom C / Index 2)
      if (String(data[i][2]).toLowerCase() === String(email).toLowerCase()) {
        // Hapus token di Kolom F (Baris i+1, Kolom 6)
        ssMaster.getRange(i + 1, 6).setValue("");
        break;
      }
    }
  } catch (e) {
    console.error("Gagal menghapus sesi DB: " + e.toString());
  }
}

/* --- 3. LOGOUT (HAPUS CACHE) --- */
function logoutUserServer(email, clientToken) {
  const cachedSession = getSessionCache(email);

  // Hanya hapus jika token cocok (Mencegah A menghapus sesi B)
  if (cachedSession && cachedSession.token === clientToken) {
    clearSessionCache(email); // Hapus dari memori
    
    // Opsional: Hapus juga di Spreadsheet agar sinkron (tapi tidak wajib untuk realtime)
    const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
    const data = ssMaster.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][2] == email) {
        ssMaster.getRange(i + 1, 6).setValue("");
        break;
      }
    }
  }
}

/* --- FUNGSI CEK STATUS SESI (OPTIMIZED: CACHE FIRST) --- */
function checkSessionStatus(email, clientSessionToken) {
  // Normalisasi email
  const targetEmail = email.trim().toLowerCase();

  // 1. CEK CACHE TERLEBIH DAHULU (Sangat Cepat & Hemat Kuota)
  // CacheService jauh lebih ringan daripada membuka Spreadsheet
  const cachedSession = getSessionCache(targetEmail);

  if (cachedSession) {
    // Jika data sesi ada di memori cache server
    if (cachedSession.token === clientSessionToken) {
      return { valid: true }; // Token Cocok -> Sesi Valid
    } else {
      // Token di cache berbeda dengan yang dikirim browser
      // Artinya user ini baru saja login di perangkat lain
      return { valid: false };
    }
  }

  // 2. FALLBACK KE SPREADSHEET (Hanya jika Cache Kosong)
  // Ini adalah jaring pengaman. Cache bisa hilang (expired) atau server restart.
  // Jika cache kosong, barulah kita "terpaksa" buka Spreadsheet.
  try {
    const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
    const data = ssMaster.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      const dbEmail = String(data[i][2]).toLowerCase();

      if (dbEmail === targetEmail) {
        const dbSession = data[i][5]; // Kolom F (Session ID di DB)

        // Validasi: Apakah Token di DB cocok dengan Client?
        if (dbSession && dbSession === clientSessionToken) {
          
          // SELF-HEALING: Kembalikan data ke Cache agar request berikutnya cepat lagi
          // Ini mencegah pembukaan spreadsheet berulang-ulang untuk user yang sama
          setSessionCache(targetEmail, {
            token: dbSession,
            lastPing: new Date().getTime()
          });
          
          return { valid: true };
        }
        return { valid: false }; // Token di DB sudah berubah/kosong
      }
    }
  } catch (e) {
    // Jika Spreadsheet gagal dibuka (misal limit kuota Google habis),
    // kita return false agar user diminta login ulang demi keamanan.
    console.error("Error checkSessionStatus: " + e.toString());
    return { valid: false };
  }

  // Jika email tidak ditemukan di DB
  return { valid: false };
}

/* --- FUNGSI CRUD DATA (User Spesifik) --- */

function simpanTransaksi(token, dataTransaksi) {
  try {
    const ss = SpreadsheetApp.openById(token); // Buka DB spesifik milik sekolah
    const sheet = ss.getSheetByName('Transaksi');
    
    // Generate ID Unik
    const id = Utilities.getUuid();
    
    sheet.appendRow([
      id,
      new Date(),
      dataTransaksi.nomorSurat,
      dataTransaksi.toko,
      JSON.stringify(dataTransaksi.items), // Item barang disimpan sbg JSON string
      dataTransaksi.total,
      dataTransaksi.terbilang
    ]);
    
    return { status: 'success', message: 'Data Transaksi Tersimpan!' };
  } catch (e) {
    return { status: 'error', message: 'Gagal menyimpan: ' + e.toString() };
  }
}

/* --- FUNGSI GENERATE PDF YANG SUDAH DIOPTIMASI (UPDATE FORMAT NAMA & GELAR) --- */
function generateLPJ(token, dataForm) {
  try {
    // 1. Validasi Token & Items
    if (!token) throw new Error("Token tidak valid.");
    const itemsSafe = Array.isArray(dataForm.items) ? dataForm.items : [];

    // 2. Buka Spreadsheet (HANYA SEKALI SAJA)
    const ss = SpreadsheetApp.openById(token);

    // --- OPTIMASI 1: BACA SEMUA PENGATURAN SEKALIGUS ---
    let settingsMap = {};
    const sheetSet = ss.getSheetByName('DataPengaturan');
    if (sheetSet) {
      const dataSet = sheetSet.getDataRange().getValues();
      dataSet.forEach(row => {
        if (row[0]) settingsMap[row[0]] = row[1];
      });
    }

    // Tentukan Template ID
    let templateId = '';
    const tipe = dataForm.tipe;
    
    if (tipe === 'TOKO') templateId = settingsMap['TEMPLATE_ID_TOKO'] || CONFIG.TEMPLATE_ID_TOKO;
    else if (tipe === 'GURU') templateId = settingsMap['TEMPLATE_ID_GURU'] || CONFIG.TEMPLATE_ID_GURU;
    else if (tipe === 'TUKANG') templateId = settingsMap['TEMPLATE_ID_TUKANG'] || CONFIG.TEMPLATE_ID_TUKANG;

    if (!templateId) return { status: 'error', message: 'ID Template kosong.' };

    // 3. Proses File Template
    let docFile;
    try {
      docFile = DriveApp.getFileById(templateId);
    } catch (e) {
      return { status: 'error', message: 'Gagal membaca File Template (ID Salah/Akses Ditolak).' };
    }

    const tempDocFile = docFile.makeCopy('LPJ_' + tipe + '_' + new Date().getTime());
    const doc = DocumentApp.openById(tempDocFile.getId());
    const body = doc.getBody();
    const safeReplace = (key, val) => body.replaceText(key, val || '-');

    // --- OPTIMASI 2: AMBIL DATA SEKOLAH LANGSUNG ---
    let ds = {};
    const sheetSekolah = ss.getSheetByName('DataSekolah');
    if (sheetSekolah && sheetSekolah.getLastRow() >= 2) {
      const d = sheetSekolah.getRange(2, 1, 1, 19).getValues()[0];
      ds = {
        namaSekolah: d[0], npsn: String(d[1]).replace(/'/g,''), nsm: String(d[2]).replace(/'/g,''),
        alamat: d[3], provinsi: d[4], kabupaten: d[5], kecamatan: d[6], kelurahan: d[7], tempatTTD: d[8],
        namaKepala: d[9], nipKepala: String(d[10]).replace(/'/g,''), 
        namaBendahara: d[11], nipBendahara: String(d[12]).replace(/'/g,''),
        noTelp: String(d[13]).replace(/'/g,''), email: d[14], danaBOS: d[15],
        jumlahAnggaran: d[16], tahunAnggaran: d[17], periodeAnggaran: d[18]
      };
    }

    // --- OPTIMASI 3: AMBIL URAIAN LANGSUNG ---
    let nomorBuktiUraian = "-";
    const sheetUraian = ss.getSheetByName('DataUraian');
    if (sheetUraian) {
      const dataUr = sheetUraian.getDataRange().getValues();
      for(let i=1; i<dataUr.length; i++){
        if(String(dataUr[i][2]).trim() === String(dataForm.uraian).trim()){
          nomorBuktiUraian = dataUr[i][1];
          break;
        }
      }
    }

    // --- AMBIL DATA TRANSAKSI (DB SURAT & TANGGAL) ---
    let dbSurat = {}, dbTanggal = {};
    const sheetTrans = ss.getSheetByName('DataTransaksi');
    if (sheetTrans) {
      const rowsTrans = sheetTrans.getDataRange().getValues();
      const transRow = rowsTrans.find(r => r[0] === dataForm.idTransaksi);
      if (transRow) {
          // Asumsi index kolom JSON Surat & Tanggal sesuai struktur DB (Kolom 10 & 11 / Index 9 & 10)
          // Jika menggunakan getHeaderMap di fungsi lain, disini kita hardcode atau pakai logika deteksi sederhana
          // Tapi agar aman, kita coba akses kolom terakhir - 2 dan - 3 jika struktur dinamis
          try { dbSurat = JSON.parse(transRow[9]); } catch(e) {}
          try { dbTanggal = JSON.parse(transRow[10]); } catch(e) {}
      }
    }

    // =========================================================================
    // OPTIMASI GAMBAR KOP SURAT
    // =========================================================================
    const kopSuratId = settingsMap['KOP_SURAT_ID']; 
    if (kopSuratId) {
      try {
        const kopFile = DriveApp.getFileById(kopSuratId);
        const kopBlob = kopFile.getBlob(); 
        const processContainer = (container) => {
           let searchResult = container.findText('<<KOP SURAT>>');
           let safety = 0;
           while (searchResult && safety < 10) {
             safety++;
             const textEl = searchResult.getElement();
             const parent = textEl.getParent();
             try {
               textEl.removeFromParent();
               const img = parent.insertInlineImage(0, kopBlob); 
               if (img.getWidth() > 600) {
                 const ratio = img.getHeight() / img.getWidth();
                 img.setWidth(600);
                 img.setHeight(600 * ratio);
               }
             } catch(err) {}
             searchResult = container.findText('<<KOP SURAT>>');
           }
        };
        processContainer(doc.getHeader());
        processContainer(body);
      } catch (e) { safeReplace('<<KOP SURAT>>', ''); }
    } else { safeReplace('<<KOP SURAT>>', ''); }
    
    // --- REPLACE DATA UMUM ---
    safeReplace('<<Nomor Bukti Uraian>>', String(nomorBuktiUraian).replace(/'/g, ''));
    safeReplace('<<Nama Sekolah>>', ds.namaSekolah);
    safeReplace('<<Nama Madrasah>>', ds.namaSekolah);
    safeReplace('<<Alamat Lengkap Sekolah>>', (ds.alamat||'') + ', ' + (ds.kecamatan||'') + ', ' + (ds.kabupaten||''));
    safeReplace('<<Alamat TTD Sekolah>>', ds.tempatTTD);
    safeReplace('<<Kecamatan>>', ds.kecamatan);
    safeReplace('<<Kabupaten>>', ds.kabupaten);
    safeReplace('<<Provinsi>>', ds.provinsi);
    
    safeReplace('<<Total>>', formatRupiah(dataForm.total));
    safeReplace('<<Total Terbilang>>', terbilang(dataForm.total) + ' Rupiah');
    
    safeReplace('<<Nama Dana BOS>>', ds.danaBOS);
    safeReplace('<<Periode>>', ds.periodeAnggaran);
    safeReplace('<<Tahun Anggaran>>', ds.tahunAnggaran);
    
    // [UPDATE] NAMA KEPALA & BENDAHARA -> Format Kapital + Gelar Baku
    safeReplace('<<NAMA KEPALA SEKOLAH>>', formatNamaKapital(ds.namaKepala));
    safeReplace('<<Nama Kepala Sekolah>>', formatNamaKapital(ds.namaKepala));
    safeReplace('<<NIP Kepala Sekolah>>', ds.nipKepala || "-");

    safeReplace('<<NAMA BENDAHARA>>', formatNamaKapital(ds.namaBendahara));
    safeReplace('<<NIP Bendahara>>', ds.nipBendahara || "-");


    // --- LOGIKA TIPE ---
    if (tipe === 'TUKANG') {
        let alamatTukang = "................................";
        const sheetTukang = ss.getSheetByName('DataTukang');
        if (sheetTukang) {
            const dataTukang = sheetTukang.getDataRange().getValues();
            const tkg = dataTukang.find(r => r[1] === dataForm.pihakKetiga);
            if (tkg) alamatTukang = tkg[2];
        }

        // [UPDATE] Format Nama Tukang
        const namaTukangFormatted = formatNamaKapital(dataForm.pihakKetiga);
        safeReplace('<<Nama Tukang>>', namaTukangFormatted);
        safeReplace('<<NAMA TUKANG>>', namaTukangFormatted);
        safeReplace('<<Alamat Lengkap Tukang>>', alamatTukang);
        safeReplace('<<Uraian Pekerjaan>>', dataForm.uraian);

        let namaPemesan = dataForm.pemesan || "-"; 
        let nipPemesan = "-";
        const sheetGuru = ss.getSheetByName('DataGuru');
        if (sheetGuru) {
             const dataGuru = sheetGuru.getDataRange().getValues();
             const guruFound = dataGuru.find(r => String(r[1]).trim() === String(namaPemesan).trim());
             if (guruFound) nipPemesan = String(guruFound[2]).replace(/'/g, '') || "-";
        }
        
        // [UPDATE] Format Nama Pemesan Tukang
        safeReplace('<<NAMA PEMESAN TUKANG>>', formatNamaKapital(namaPemesan));
        safeReplace('<<NIP PEMESAN TUKANG>>', nipPemesan);

        // Surat & Tanggal Tukang
        safeReplace('<<Surat Permintaan Tukang>>', dbSurat.permintaan || '-');
        safeReplace('<<Nomor Surat BA.PP>>', dbSurat.baPemeriksaan || '-');
        safeReplace('<<Nomor Surat BA.STP>>', dbSurat.baSerahTerima || '-');
        safeReplace('<<Nomor Surat BA.Bayar>>', dbSurat.baPembayaran || '-');

        const tglTrans = dataForm.tanggal;
        const doDateReplace = (suffix, dateVal) => {
           const det = getIndonesianDateDetails(dateVal);
           safeReplace('<<Tanggal ' + suffix + '>>', formatTanggalIndo(dateVal));
           safeReplace('<<Hari Huruf Tanggal ' + suffix + '>>', det.hari);
           safeReplace('<<Tanggal Huruf ' + suffix + '>>', det.tanggal);
           safeReplace('<<Bulan Huruf Tanggal ' + suffix + '>>', det.bulan);
           safeReplace('<<Tahun Huruf Tanggal ' + suffix + '>>', det.tahun);
        };
        
        safeReplace('<<Tanggal Surat Permintaan Tukang>>', formatTanggalIndo(dbTanggal.permintaan || tglTrans));
        doDateReplace('BA.PP', dbTanggal.baPemeriksaan || tglTrans);
        doDateReplace('BA.STP', dbTanggal.baSerahTerima || tglTrans);
        doDateReplace('BA.Bayar Tukang', dbTanggal.baPembayaran || tglTrans);


    } else if (tipe === 'TOKO') {
        let alamatToko="-", telpToko="-", pemilikToko="-", jenisToko="-", tempatToko="-";
        const sheetToko = ss.getSheetByName('DataToko');
        if (sheetToko) {
            const dataToko = sheetToko.getDataRange().getValues();
            const tokoFound = dataToko.find(r => String(r[1]).trim() === String(dataForm.pihakKetiga).trim());
            if (tokoFound) {
                jenisToko = tokoFound[2] || "-";
                alamatToko = tokoFound[3] || "-";
                telpToko = String(tokoFound[4]).replace(/'/g, '') || "-"; 
                pemilikToko = tokoFound[5] || "-";
                tempatToko = tokoFound[6] || "-";
            }
        }

        // Nama Toko biasanya Badan Usaha, jadi cukup Uppercase biasa
        safeReplace('<<Nama Toko>>', String(dataForm.pihakKetiga).toUpperCase());
        safeReplace('<<Jenis Toko>>', jenisToko);
        safeReplace('<<Alamat Lengkap Toko>>', alamatToko);
        safeReplace('<<Telp Toko>>', telpToko);
        
        // [UPDATE] Format Nama Pemilik Toko (Siapa tahu ada gelar)
        safeReplace('<<NAMA PEMILIK TOKO>>', formatNamaKapital(pemilikToko));
        safeReplace('<<Alamat TTD Toko>>', tempatToko); 
        
        safeReplace('<<Nomor Surat Keluar>>', dbSurat.permintaan || '-');
        safeReplace('<<Nomor Surat BA.PB>>', dbSurat.baPemeriksaan || '-');
        safeReplace('<<Nomor Surat BA.STB>>', dbSurat.baSerahTerima || '-');
        safeReplace('<<Nomor Surat BA.Bayar>>', dbSurat.baPembayaran || '-');

        const tglTrans = dataForm.tanggal;
        safeReplace('<<Tanggal Pesanan>>', formatTanggalIndo(dbTanggal.permintaan || tglTrans));
        safeReplace('<<Tanggal Penawaran>>', formatTanggalIndo(dbTanggal.penawaran || tglTrans));
        
        const doDateReplaceToko = (suffix, dateVal) => {
           const det = getIndonesianDateDetails(dateVal);
           safeReplace('<<Tanggal ' + suffix + '>>', formatTanggalIndo(dateVal));
           safeReplace('<<Hari Huruf ' + suffix + '>>', det.hari);
           safeReplace('<<Tanggal Huruf ' + suffix + '>>', det.tanggal);
           safeReplace('<<Bulan Huruf ' + suffix + '>>', det.bulan);
           safeReplace('<<Tahun Huruf ' + suffix + '>>', det.tahun);
        };

        doDateReplaceToko('BA.PB', dbTanggal.baPemeriksaan || tglTrans);
        doDateReplaceToko('BA.STB', dbTanggal.baSerahTerima || tglTrans);
        doDateReplaceToko('BA.Bayar', dbTanggal.baPembayaran || tglTrans);

        safeReplace('<<Uraian Pesanan>>', dataForm.uraian);
        
        // [UPDATE] Format Nama Pemesan (Guru) di LPJ Toko
        safeReplace('<<Nama Pemesan>>', formatNamaKapital(dataForm.pemesan));
        
        let nipPemesan = "-";
        const sheetGuru = ss.getSheetByName('DataGuru');
        if (sheetGuru) {
             const dataGuru = sheetGuru.getDataRange().getValues();
             const guruFound = dataGuru.find(r => String(r[1]).trim() === String(dataForm.pemesan).trim());
             if (guruFound) nipPemesan = String(guruFound[2]).replace(/'/g, '') || "-";
        }
        safeReplace('<<NIP PEMESAN>>', nipPemesan);

    } else if (tipe === 'GURU') {
        safeReplace('<<Uraian Kegiatan>>', dataForm.uraian);
        safeReplace('<<Keterangan>>', dataForm.pihakKetiga);
        safeReplace('<<Tanggal Transaksi>>', formatTanggalIndo(dataForm.tanggal));
        safeReplace('<<Tanggal BA.Bayar>>', formatTanggalIndo(dbTanggal.baPembayaran || dataForm.tanggal));

        let namaPenerima = (itemsSafe.length > 0) ? itemsSafe[0].nama : "-";
        
        // [UPDATE] Format Nama Penerima (Guru 1)
        safeReplace('<<Nama Guru 1>>', formatNamaKapital(namaPenerima));

        let nipGuru1 = "-";
        const sheetGuru = ss.getSheetByName('DataGuru');
        if (sheetGuru) {
             const dataGuru = sheetGuru.getDataRange().getValues();
             const guruFound = dataGuru.find(r => String(r[1]).trim() === String(namaPenerima).trim());
             if (guruFound) nipGuru1 = String(guruFound[2]).replace(/'/g, '') || "-";
        }
        safeReplace('<<NIP Guru 1>>', nipGuru1);
        
        // [UPDATE] Format Nama Pemesan/Penanggung Jawab Kegiatan
        safeReplace('<<NAMA PEMESAN/GURU>>', formatNamaKapital(dataForm.pemesan));
    }

    // --- TABEL ITEM ---
    if (itemsSafe.length > 0) {
      const tables = body.getTables();
      tables.forEach(table => {
        let rowIndexTemplate = -1;
        for (let r = 0; r < table.getNumRows(); r++) {
          if (table.getRow(r).getText().includes('<<TABLE_ROW>>')) {
            rowIndexTemplate = r;
            break; 
          }
        }

        if (rowIndexTemplate !== -1) {
          const templateRow = table.getRow(rowIndexTemplate);
          
          itemsSafe.forEach((item, index) => {
             const newRow = table.insertTableRow(rowIndexTemplate + index, templateRow.copy());
             const numCells = newRow.getNumCells();
             let namaItemTabel = item.nama || "";
             
             // [UPDATE] Format Nama di Tabel (Khusus Honor Guru)
             if (tipe === 'GURU') {
                namaItemTabel = formatNamaKapital(namaItemTabel);
             }

             try { newRow.getCell(0).setText((index + 1).toString()); } catch(e){} 
             try { newRow.getCell(1).setText(namaItemTabel); } catch(e){}        

             if (numCells === 5) {
                const volSat = (item.vol || 0).toString() + " " + (item.sat || "");
                try { newRow.getCell(2).setText(volSat); } catch(e){}
                try { newRow.getCell(3).setText(formatRupiah(item.harga || 0)); } catch(e){}
                try { newRow.getCell(4).setText(formatRupiah(item.jumlah || 0)); } catch(e){}
             } else {
                try { newRow.getCell(2).setText((item.vol || 0).toString()); } catch(e){} 
                try { newRow.getCell(3).setText(item.sat || ""); } catch(e){} 
                try { newRow.getCell(4).setText(formatRupiah(item.harga || 0)); } catch(e){} 
                try { newRow.getCell(5).setText(formatRupiah(item.jumlah || 0)); } catch(e){} 
             }
          });
          table.removeRow(rowIndexTemplate + itemsSafe.length);
        }
      });
    }
    
    doc.saveAndClose(); // Wajib sebelum convert PDF

    // 4. Konversi PDF & Hapus Temp
    const pdfBlob = tempDocFile.getAs(MimeType.PDF);
    const uniqueSuffix = Utilities.formatDate(new Date(), "GMT+7", "yyyyMMddHHmmss");
    const namaPdf = 'LPJ_' + tipe + '_' + (dbSurat.permintaan || 'DRAFT') + '_' + uniqueSuffix + '.pdf';
    
    const pdfFile = DriveApp.createFile(pdfBlob).setName(namaPdf);
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const folderGenerateId = settingsMap['FOLDER_PDF_ID']; 
    if (folderGenerateId) {
       try {
         const folder = DriveApp.getFolderById(folderGenerateId);
         folder.addFile(pdfFile);
         DriveApp.getRootFolder().removeFile(pdfFile);
       } catch(e) {}
    }
    
    tempDocFile.setTrashed(true); // Hapus doc sementara

    // 5. Update Database ID PDF (Tanpa Buka Spreadsheet Lagi)
    const newFileId = pdfFile.getId();
    if (sheetTrans) {
      // Logic standar: header map via getHeaderMap (jika ada) atau fallback
      // Disini kita gunakan header map dinamis sederhana
      let colIdxPdf = -1; let colIdxId = -1;
      const headers = sheetTrans.getRange(1, 1, 1, sheetTrans.getLastColumn()).getValues()[0];
      headers.forEach((h, i) => {
         if(h === 'File_PDF_ID') colIdxPdf = i;
         if(h === 'ID_Transaksi') colIdxId = i;
      });

      // Jika kolom PDF belum ada, jangan error, tapi coba append header jika bisa (opsional)
      // Asumsi: Header sudah diperbaiki via fungsi perbaikiSemuaHeader
      if (colIdxPdf !== -1 && colIdxId !== -1) {
          const rowsTrans = sheetTrans.getDataRange().getValues();
          for (let i = 1; i < rowsTrans.length; i++) {
            if (rowsTrans[i][colIdxId] == dataForm.idTransaksi) {
              sheetTrans.getRange(i + 1, colIdxPdf + 1).setValue(newFileId);
              
              // Hapus file lama jika ada
              const oldFileId = rowsTrans[i][colIdxPdf];
              if (oldFileId && oldFileId !== "-" && oldFileId !== newFileId) {
                 try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {}
              }
              break;
            }
          }
      }
    }
    
    return { status: 'success', url: pdfFile.getUrl() };

  } catch (e) {
    return { status: 'error', message: 'Gagal generate PDF: ' + e.toString() };
  }
}

/* --- HELPER DATE FORMATTING INDONESIA (UPDATE) --- */

function formatTanggalIndo(dateString) {
  if (!dateString) return "-";
  
  const d = new Date(dateString);
  const bulanIndo = [
    "Januari", "Februari", "Maret", "April", "Mei", "Juni", 
    "Juli", "Agustus", "September", "Oktober", "November", "Desember"
  ];

  // Ambil Tanggal (dd), Bulan (Index), dan Tahun (yyyy) zona waktu Jakarta
  const tanggal = Utilities.formatDate(d, "GMT+7", "dd");
  const bulanIndex = parseInt(Utilities.formatDate(d, "GMT+7", "M")) - 1; 
  const tahun = Utilities.formatDate(d, "GMT+7", "yyyy");

  // Pastikan index bulan valid
  if (bulanIndex < 0 || bulanIndex > 11) return "-";

  // Gabungkan: 07 + Desember + 2025
  return tanggal + " " + bulanIndo[bulanIndex] + " " + tahun;
}

function getIndonesianDateDetails(dateString) {
  if (!dateString) return { hari: '-', tanggal: '-', bulan: '-', tahun: '-' };
  
  const d = new Date(dateString);
  const hariArr = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
  const bulanArr = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
  
  const hariIndex = parseInt(Utilities.formatDate(d, "GMT+7", "u")) == 7 ? 0 : parseInt(Utilities.formatDate(d, "GMT+7", "u")); // Apps Script 'u' 1=Mon, 7=Sun
  
  // Ambil komponen
  const hariNama = hariArr[new Date(Utilities.formatDate(d, "GMT+7", "yyyy-MM-dd")).getDay()]; // getDay() 0=Sun
  const tglAngka = parseInt(Utilities.formatDate(d, "GMT+7", "d"));
  const blnIndex = parseInt(Utilities.formatDate(d, "GMT+7", "M")) - 1;
  const thnAngka = parseInt(Utilities.formatDate(d, "GMT+7", "yyyy"));
  
  return {
    hari: hariNama,
    tanggal: angkaKeTeks(tglAngka), // Fungsi konversi angka 1-31 ke teks
    bulan: bulanArr[blnIndex],
    tahun: angkaKeTeks(thnAngka)
  };
}

/* --- HELPER TERBILANG ANGKA (DENGAN PERBAIKAN SPASI) --- */
function angkaKeTeks(nilai) {
  const angka = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
  let temp = "";
  
  if (nilai < 12) {
    temp = " " + angka[nilai];
  } else if (nilai < 20) {
    temp = angkaKeTeks(nilai - 10) + " Belas";
  } else if (nilai < 100) {
    // Tambahkan spasi setelah "Puluh "
    temp = angkaKeTeks(Math.floor(nilai / 10)) + " Puluh " + angkaKeTeks(nilai % 10);
  } else if (nilai < 200) {
    // Tambahkan spasi setelah "Seratus "
    temp = " Seratus " + angkaKeTeks(nilai - 100);
  } else if (nilai < 1000) {
    // Tambahkan spasi setelah "Ratus "
    temp = angkaKeTeks(Math.floor(nilai / 100)) + " Ratus " + angkaKeTeks(nilai % 100);
  } else if (nilai < 2000) {
    // Tambahkan spasi setelah "Seribu "
    temp = " Seribu " + angkaKeTeks(nilai - 1000);
  } else if (nilai < 1000000) {
    // Tambahkan spasi setelah "Ribu "
    temp = angkaKeTeks(Math.floor(nilai / 1000)) + " Ribu " + angkaKeTeks(nilai % 1000);
  } else if (nilai < 1000000000) {
    // Tambahkan spasi setelah "Juta "
    temp = angkaKeTeks(Math.floor(nilai / 1000000)) + " Juta " + angkaKeTeks(nilai % 1000000);
  }
  
  // Hapus spasi berlebih di awal/akhir
  return temp.trim(); 
}

function formatRupiah(angka) {
  return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka);
}

// Fungsi Terbilang (Dengan Perbaikan Spasi & Trim)
function terbilang(nilai) {
  var bilangan = Math.abs(nilai);
  var angka = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
  var temp = "";
  
  if (bilangan < 12) {
    temp = " " + angka[bilangan];
  } else if (bilangan < 20) {
    temp = terbilang(bilangan - 10) + " Belas";
  } else if (bilangan < 100) {
    // Tambahkan spasi kiri-kanan pada "Puluh"
    temp = terbilang(Math.floor(bilangan / 10)) + " Puluh " + terbilang(bilangan % 10);
  } else if (bilangan < 200) {
    // Tambahkan spasi kiri-kanan pada "Seratus"
    temp = " Seratus " + terbilang(bilangan - 100);
  } else if (bilangan < 1000) {
    // Tambahkan spasi kiri-kanan pada "Ratus"
    temp = terbilang(Math.floor(bilangan / 100)) + " Ratus " + terbilang(bilangan % 100);
  } else if (bilangan < 2000) {
    // Tambahkan spasi kiri-kanan pada "Seribu"
    temp = " Seribu " + terbilang(bilangan - 1000);
  } else if (bilangan < 1000000) {
    // Tambahkan spasi kiri-kanan pada "Ribu"
    temp = terbilang(Math.floor(bilangan / 1000)) + " Ribu " + terbilang(bilangan % 1000);
  } else if (bilangan < 1000000000) {
    // Tambahkan spasi kiri-kanan pada "Juta"
    temp = terbilang(Math.floor(bilangan / 1000000)) + " Juta " + terbilang(bilangan % 1000000);
  }
  
  // PENTING: Hapus spasi di awal string agar rata kiri
  return temp.trim();
}

/* --- HELPER UPDATE: FORMAT NAMA KAPITAL DENGAN KAMUS GELAR --- */
function formatNamaKapital(rawName) {
  // 1. Cek Kosong
  if (!rawName || rawName === '-' || rawName === '') return "_______________________";
  
  const str = String(rawName).trim();
  const firstCommaIndex = str.indexOf(',');

  // KASUS A: ADA KOMA (Format: Nama, Gelar)
  if (firstCommaIndex !== -1) {
    
    // Bagian Nama: Selalu Kapital (Huruf Besar)
    const namaDepan = str.substring(0, firstCommaIndex).toUpperCase();
    
    // Bagian Gelar: Ambil teks setelah koma
    let gelarRaw = str.substring(firstCommaIndex + 1).trim();
    
    // --- KAMUS GELAR (DATABASE) ---
    // Kunci: huruf kecil tanpa titik | Nilai: Format Baku
    const mapGelar = {
        "se": "S.E.",
        "spd": "S.Pd.",
        "spdi": "S.Pd.I.",
        "sag": "S.Ag.",
        "sh": "S.H.",
        "st": "S.T.",
        "skom": "S.Kom.",
        "ssos": "S.Sos.",
        "sip": "S.I.P.",
        "skm": "S.K.M.",
        "skep": "S.Kep.",
        "sfarm": "S.Farm.",
        "spsi": "S.Psi.",
        "ss": "S.S.",
        "ssn": "S.Sn.",
        "strt": "S.Tr.T.",
        "mpd": "M.Pd.",
        "mpdi": "M.Pd.I.",
        "mm": "M.M.",
        "msi": "M.Si.",
        "mag": "M.Ag.",
        "mh": "M.H.",
        "mkom": "M.Kom.",
        "mt": "M.T.",
        "amd": "A.Md.",
        "drs": "Drs.",
        "dra": "Dra.",
        "dr": "Dr.",
        "lc": "Lc.",
        "ma": "M.A."
    };

    // Bersihkan input gelar (hapus titik, hapus spasi, lowercase) untuk pencarian
    // Contoh input: " S.E ", "S.E.", "SE", "s.e" -> menjadi "se"
    const cleanKey = gelarRaw.toLowerCase().replace(/[^a-z]/g, '');

    let gelarJadi = "";

    // CEK 1: Apakah ada di Kamus?
    if (mapGelar[cleanKey]) {
        gelarJadi = mapGelar[cleanKey];
    } else {
        // CEK 2: Fallback (Jika gelar tidak dikenal di kamus)
        // Logika: Split berdasarkan titik atau spasi, lalu Title Case
        
        // Hapus titik di akhir agar bersih dulu
        while(gelarRaw.endsWith('.')) gelarRaw = gelarRaw.slice(0, -1);
        
        let parts = [];
        if (gelarRaw.includes('.')) {
             parts = gelarRaw.split('.');
        } else {
             // Jika input "MBA" (tanpa titik), biarkan tetap "MBA" jika pendek, atau split spasi
             if (gelarRaw.length <= 4 && !gelarRaw.includes(' ')) {
                 parts = [gelarRaw.toUpperCase()]; // Paksa Kapital semua jika singkatan pendek tak dikenal
             } else {
                 parts = gelarRaw.split(' ');
             }
        }

        gelarJadi = parts.map(p => {
            const c = p.trim();
            if(!c) return "";
            // Jika part sudah kapital semua (seperti MBA), biarkan. Jika campuran, format Title Case.
            if (c === c.toUpperCase() && c.length > 1) return c; 
            return c.charAt(0).toUpperCase() + c.slice(1).toLowerCase();
        }).join('.');

        // Pastikan diakhiri titik jika formatnya singkatan (mengandung titik di tengah atau hasil join)
        if (!gelarJadi.endsWith('.')) gelarJadi += '.';
    }

    return namaDepan + ', ' + gelarJadi;

  } else {
    // KASUS B: TIDAK ADA KOMA (Hanya Nama) -> Kapital Semua
    return str.toUpperCase();
  }
}

/* --- FUNGSI DATA SEKOLAH --- */

// 1. Ambil Data Sekolah (Update: Validasi Token & Error Handling)
function getDataSekolah(token) {
  try {
    // [PERBAIKAN 1] Validasi Token di Awal
    if (!token || typeof token !== 'string') {
      throw new Error("Token sesi tidak valid atau kosong. Silakan login ulang.");
    }

    // [PERBAIKAN 2] Coba Buka Spreadsheet dengan Error Catching Spesifik
    let ss;
    try {
      ss = SpreadsheetApp.openById(token);
    } catch (err) {
      // Jika gagal buka (misal file terhapus atau ID salah), lempar error yang jelas
      throw new Error("Database Sekolah tidak ditemukan atau Anda tidak memiliki akses. (ID: " + token + ")");
    }

    let sheet = ss.getSheetByName('DataSekolah');
    
    if (!sheet) {
      sheet = ss.insertSheet('DataSekolah');
      const headers = [
        "Nama Sekolah", "NPSN", "NSM", "Alamat Lengkap", "Provinsi", 
        "Kabupaten", "Kecamatan", "Kelurahan", "Tempat TTD",
        "Nama Kepala", "NIP Kepala", "Nama Bendahara", "NIP Bendahara", 
        "No Telp", "Email", "Nama Dana BOS",
        "Jumlah Anggaran", "Tahun Anggaran", "Periode Anggaran"
      ];
      sheet.appendRow(headers);
    }

    // Pastikan ada data di baris ke-2 (Baris Data)
    if (sheet.getLastRow() < 2) {
       // Return data kosong default jika belum ada isinya
       return {
         status: 'success',
         data: {
           namaSekolah: '', npsn: '', nsm: '', alamat: '', provinsi: '', kabupaten: '',
           kecamatan: '', kelurahan: '', tempatTTD: '', namaKepala: '', nipKepala: '',
           namaBendahara: '', nipBendahara: '', noTelp: '', email: '', danaBOS: '',
           jumlahAnggaran: 0, tahunAnggaran: '', periodeAnggaran: ''
         }
       };
    }

    // Ambil range diperluas jadi 19 kolom (A sampai S)
    // Gunakan pengecekan kolom terakhir untuk menghindari error "Range out of bounds"
    const lastCol = sheet.getLastColumn();
    // Kita butuh minimal 19 kolom, tapi jika sheetnya baru mungkin kurang.
    // getRange(row, col, numRows, numCols)
    const data = sheet.getRange(2, 1, 1, Math.max(lastCol, 19)).getValues()[0];
    
    return {
      status: 'success',
      data: {
        namaSekolah: data[0] || '',
        npsn: data[1] || '',
        nsm: data[2] || '',
        alamat: data[3] || '',
        provinsi: data[4] || '',
        kabupaten: data[5] || '',
        kecamatan: data[6] || '',
        kelurahan: data[7] || '',
        tempatTTD: data[8] || '',
        namaKepala: data[9] || '',
        nipKepala: data[10] || '',
        namaBendahara: data[11] || '',
        nipBendahara: data[12] || '',
        noTelp: data[13] || '',
        email: data[14] || '',
        danaBOS: data[15] || '',
        jumlahAnggaran: data[16] || 0,
        tahunAnggaran: data[17] || '',
        periodeAnggaran: data[18] || '' 
      }
    };
  } catch (e) {
    const pesan = beautifyError(
      "Database Tidak Ditemukan", 
      e, 
      "Sistem tidak bisa membuka file Database Sekolah. Kemungkinan file terhapus atau Anda login menggunakan akun yang berbeda."
    );
    return { status: 'error', message: pesan };
  }
}

// 2. Simpan Data Sekolah (Update: Format Nama, Sync Master, Clear Cache & FLUSH)
function simpanDataSekolah(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataSekolah');
    if (!sheet) return { status: 'error', message: 'Sheet DataSekolah tidak ditemukan!' };

    // --- [PERBAIKAN 1] FORMAT NAMA OTOMATIS ---
    if (form.namaKepala) {
      form.namaKepala = formatNamaTitleCase(form.namaKepala);
    }
    if (form.namaBendahara) {
      form.namaBendahara = formatNamaTitleCase(form.namaBendahara);
    }
    // ------------------------------------------

    // Format Text
    const npsnText = "'" + form.npsn; 
    const nsmText = form.nsm ? "'" + form.nsm : "";
    const telpText = "'" + form.noTelp;
    const nipKepalaText = form.nipKepala ? "'" + form.nipKepala : "";
    const nipBendaharaText = form.nipBendahara ? "'" + form.nipBendahara : "";

    // Header Periode
    if(sheet.getLastColumn() < 19) {
       sheet.getRange(1, 19).setValue("Periode Anggaran");
    }

    const rowData = [
      form.namaSekolah,
      npsnText,
      nsmText,
      form.alamat,
      form.provinsi,
      form.kabupaten,
      form.kecamatan,
      form.kelurahan,
      form.tempatTTD, 
      form.namaKepala, // <--- Nama Baru (Formatted)
      nipKepalaText,
      form.namaBendahara,
      nipBendaharaText,
      telpText,
      form.email,
      form.danaBOS,       
      form.jumlahAnggaran,
      form.tahunAnggaran,
      form.periodeAnggaran 
    ];

    sheet.getRange(2, 1, 1, rowData.length).setValues([rowData]);

    // --- [PERBAIKAN 2] SINKRONISASI KE MASTER DB ---
    try {
       const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
       const dataUsers = ssMaster.getDataRange().getValues();
       let userEmail = null;
       
       for (let i = 1; i < dataUsers.length; i++) {
         if (dataUsers[i][4] === token) {
           ssMaster.getRange(i + 1, 2).setValue(form.namaSekolah);
           userEmail = String(dataUsers[i][2]); 
           break;
         }
       }

       if (userEmail) {
         clearSessionCache(userEmail); 
       }
    } catch (err) {
       console.error("Warning: Gagal sinkronisasi master - " + err);
    }

    // --- [PERBAIKAN UTAMA] FLUSH SPREADSHEET ---
    // Ini kuncinya! Memaksa Spreadsheet menyimpan data DETIK INI JUGA.
    // Sehingga saat halaman Berkas Pencairan dibuka, datanya sudah pasti baru.
    SpreadsheetApp.flush(); 
    // -------------------------------------------

    return { status: 'success', message: 'Data Sekolah berhasil disimpan!' };
  } catch (e) {
    const pesan = beautifyError(
      "Gagal Menyimpan Data", 
      e, 
      "Cobalah refresh halaman. Jika masih gagal, lakukan 'Maintenance Database' di menu Data Sekolah."
    );
    return { status: 'error', message: pesan };
  }
}

/* --- FUNGSI DATA URAIAN PEKERJAAN --- */

// 1. Ambil List Uraian
function getUraianList(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataUraian');
    
    // Jika belum ada, buat sheet baru
    if (!sheet) {
      sheet = ss.insertSheet('DataUraian');
      sheet.appendRow(["ID", "Nomor Bukti", "Uraian Pekerjaan"]); // Header
    }

    const data = sheet.getDataRange().getValues();
    // Hapus header (baris 1) dari hasil return
    const result = data.slice(1).map(row => {
      return { id: row[0], noBukti: row[1], uraian: row[2] };
    });

    return { status: 'success', data: result };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Simpan Uraian Baru
function simpanUraianBaru(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataUraian');
    if (!sheet) return { status: 'error', message: 'Sheet DataUraian tidak ditemukan' };

    const id = Utilities.getUuid(); // ID Unik untuk keperluan hapus/edit
    
    // Pakai tanda kutip (') untuk No Bukti agar format terjaga
    sheet.appendRow([id, "'" + form.noBukti, form.uraian]);

    return { status: 'success', message: 'Uraian berhasil ditambahkan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Hapus Uraian
function hapusUraianItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataUraian');
    const data = sheet.getDataRange().getValues();
    
    // Loop cari ID (kolom ke-0)
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1); // +1 karena index sheet mulai dari 1
        return { status: 'success', message: 'Data berhasil dihapus' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 4. Edit / Update Uraian (UPDATE SINKRONISASI)
function editUraianItem(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataUraian');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == form.id) { 
        
        // --- LOGIKA BARU: Simpan Uraian Lama (Kolom ke-3 / Index 2) ---
        const oldUraian = String(data[i][2]);
        // --------------------------------------------------------------

        const noBuktiText = "'" + form.noBukti; 
        
        sheet.getRange(i + 1, 2).setValue(noBuktiText);
        sheet.getRange(i + 1, 3).setValue(form.uraian);
        
        // --- LOGIKA BARU: Sinkronisasi ---
        if (oldUraian !== form.uraian) {
          sinkronisasiDataTransaksi(token, 'URAIAN', oldUraian, form.uraian);
        }
        // ---------------------------------

        return { status: 'success', message: 'Uraian diperbarui & Riwayat disinkronkan!' };
      }
    }
    return { status: 'error', message: 'ID Data tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: AMBIL REF URAIAN LENGKAP (KOLOM A s.d D) --- */
function getReferensiUraianMaster(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('Uraian');
    
    // Jika sheet tidak ada, kembalikan array kosong
    if (!sheet) return { status: 'success', data: [] };

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return { status: 'success', data: [] };

    // PERBAIKAN: Ambil 4 Kolom (A, B, C, D)
    // Kolom A = Uraian
    // Kolom B = Kode Kegiatan
    // Kolom C = Standar Nasional Pendidikan
    // Kolom D = Nama Kegiatan
    const data = sheet.getRange(2, 1, lastRow - 1, 4).getDisplayValues();
    
    const cleanData = data.map(r => ({
      uraian: String(r[0]).trim(),  // Col A
      kode: String(r[1]).trim(),    // Col B
      standar: String(r[2]).trim(), // Col C
      kegiatan: String(r[3]).trim() // Col D
    })).filter(obj => obj.uraian !== ""); 

    return { status: 'success', data: cleanData };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI DATA TOKO --- */

// 1. Ambil List Toko
function getTokoList(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataToko');
    
    if (!sheet) {
      sheet = ss.insertSheet('DataToko');
      // Header: ID, Nama, Jenis, Alamat, Telp, Pemilik, Tempat TTD
      sheet.appendRow(["ID", "Nama Toko", "Jenis Toko", "Alamat Lengkap", "No Telp", "Nama Pemilik", "Tempat TTD"]);
    }

    const data = sheet.getDataRange().getValues();
    // Hapus header
    const result = data.slice(1).map(row => {
      return {
        id: row[0],
        nama: row[1],
        jenis: row[2],
        alamat: row[3],
        telp: row[4],
        pemilik: row[5],
        tempat: row[6]
      };
    });

    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Simpan Toko Baru
function simpanTokoBaru(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataToko');
    if (!sheet) return { status: 'error', message: 'Sheet DataToko tidak ditemukan' };

    const id = Utilities.getUuid();
    
    // Gunakan kutip satu (') untuk No Telp agar formatnya Text
    const telpText = "'" + form.telp;

    sheet.appendRow([
      id, 
      form.nama, 
      form.jenis, 
      form.alamat, 
      telpText, 
      form.pemilik, 
      form.tempat
    ]);

    return { status: 'success', message: 'Data Toko berhasil ditambahkan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Edit Data Toko (UPDATE SINKRONISASI)
function editTokoItem(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataToko');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == form.id) {
        
        // --- LOGIKA BARU: Simpan Nama Lama ---
        const oldName = String(data[i][1]); // Kolom Nama ada di index 1
        // -------------------------------------

        // Update Baris (Index + 1)
        const rowIdx = i + 1;
        const telpText = "'" + form.telp;

        sheet.getRange(rowIdx, 2).setValue(form.nama);
        sheet.getRange(rowIdx, 3).setValue(form.jenis);
        sheet.getRange(rowIdx, 4).setValue(form.alamat);
        sheet.getRange(rowIdx, 5).setValue(telpText);
        sheet.getRange(rowIdx, 6).setValue(form.pemilik);
        sheet.getRange(rowIdx, 7).setValue(form.tempat);
        
        // --- LOGIKA BARU: Jalankan Sinkronisasi ---
        if (oldName !== form.nama) {
          sinkronisasiDataTransaksi(token, 'TOKO', oldName, form.nama);
        }
        // ------------------------------------------

        return { status: 'success', message: 'Data Toko diperbarui & Riwayat disinkronkan!' };
      }
    }
    return { status: 'error', message: 'ID Toko tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 4. Hapus Toko
function hapusTokoItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataToko');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Data Toko dihapus' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI DATA TUKANG --- */

// 1. Ambil List Tukang
function getTukangList(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataTukang');
    
    // Jika belum ada, buat sheet baru
    if (!sheet) {
      sheet = ss.insertSheet('DataTukang');
      // Header: ID, Nama Lengkap, Alamat Lengkap
      sheet.appendRow(["ID", "Nama Lengkap", "Alamat Lengkap"]);
    }

    const data = sheet.getDataRange().getValues();
    // Hapus header (baris 1) dan mapping data
    const result = data.slice(1).map(row => {
      return {
        id: row[0],
        nama: row[1],
        alamat: row[2]
      };
    });

    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Simpan Tukang Baru
function simpanTukangBaru(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataTukang');
    if (!sheet) return { status: 'error', message: 'Sheet DataTukang tidak ditemukan' };

    const id = Utilities.getUuid();
    
    sheet.appendRow([
      id, 
      form.nama, 
      form.alamat
    ]);

    return { status: 'success', message: 'Data Tukang berhasil ditambahkan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Edit Data Tukang (UPDATE SINKRONISASI)
function editTukangItem(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTukang');
    const data = sheet.getDataRange().getValues();
    
    // Loop cari ID
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == form.id) {
        
        // --- LOGIKA BARU: Simpan Nama Lama ---
        const oldName = String(data[i][1]); 
        // -------------------------------------

        const rowIdx = i + 1;
        sheet.getRange(rowIdx, 2).setValue(form.nama);
        sheet.getRange(rowIdx, 3).setValue(form.alamat);
        
        // --- LOGIKA BARU: Sinkronisasi ---
        if (oldName !== form.nama) {
          sinkronisasiDataTransaksi(token, 'TUKANG', oldName, form.nama);
        }
        // ---------------------------------

        return { status: 'success', message: 'Data Tukang diperbarui & Riwayat disinkronkan!' };
      }
    }
    return { status: 'error', message: 'ID Tukang tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 4. Hapus Tukang
function hapusTukangItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTukang');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Data Tukang dihapus' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI DATA PEMESAN/GURU --- */

// 1. Ambil List Guru
function getGuruList(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataGuru');
    
    // Jika belum ada, buat sheet baru
    if (!sheet) {
      sheet = ss.insertSheet('DataGuru');
      // Header: ID, Nama Lengkap, NIP
      sheet.appendRow(["ID", "Nama Lengkap", "NIP"]);
    }

    const data = sheet.getDataRange().getValues();
    // Hapus header (baris 1)
    const result = data.slice(1).map(row => {
      return {
        id: row[0],
        nama: row[1],
        nip: row[2]
      };
    });

    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Simpan Guru Baru
function simpanGuruBaru(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataGuru');
    if (!sheet) return { status: 'error', message: 'Sheet DataGuru tidak ditemukan' };

    const id = Utilities.getUuid();
    
    // Format NIP sebagai text (pakai kutip satu) jika diisi
    const nipText = form.nip ? "'" + form.nip : "";

    sheet.appendRow([
      id, 
      form.nama, 
      nipText
    ]);

    return { status: 'success', message: 'Data Guru berhasil ditambahkan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Edit Data Guru (UPDATE SINKRONISASI)
function editGuruItem(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataGuru');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == form.id) {
        
        // --- LOGIKA BARU: Simpan Nama Lama ---
        const oldName = String(data[i][1]); 
        // -------------------------------------

        const rowIdx = i + 1;
        const nipText = form.nip ? "'" + form.nip : "";

        sheet.getRange(rowIdx, 2).setValue(form.nama);
        sheet.getRange(rowIdx, 3).setValue(nipText);
        
        // --- LOGIKA BARU: Sinkronisasi ---
        if (oldName !== form.nama) {
          sinkronisasiDataTransaksi(token, 'GURU', oldName, form.nama);
        }
        // ---------------------------------
        
        return { status: 'success', message: 'Data Guru diperbarui & Riwayat disinkronkan!' };
      }
    }
    return { status: 'error', message: 'ID Guru tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 4. Hapus Guru
function hapusGuruItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataGuru');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Data Guru dihapus' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI PENGATURAN KOP SURAT --- */

// 1. Simpan Kop Surat (Upload ke Drive & Simpan ID ke DB)
/* --- FUNGSI SIMPAN KOP SURAT (UPDATE: SIMPAN KE FOLDER KOP SEKOLAH) --- */
function simpanKopSurat(token, fileData) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    let oldFileId = null; 
    let rowIdxKop = -1;
    let folderKopId = null;

    // Cari ID File Lama dan ID Folder Kop dari Sheet Pengaturan
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'KOP_SURAT_ID') {
        oldFileId = data[i][1];
        rowIdxKop = i + 1;
      }
      if (data[i][0] === 'FOLDER_KOP_ID') {
        folderKopId = data[i][1];
      }
    }

    // Hapus File Lama
    if (oldFileId) { try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {} }

    // Upload File Baru
    const blob = Utilities.newBlob(Utilities.base64Decode(fileData.base64), fileData.mimeType, "KopSurat_" + Utilities.formatDate(new Date(), "GMT+7", "yyyyMMddHHmmss"));
    const file = DriveApp.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // --> PINDAHKAN KE FOLDER 'Kop Sekolah' JIKA ADA CONFIG ID-NYA
    if (folderKopId) {
      try {
        const folder = DriveApp.getFolderById(folderKopId);
        folder.addFile(file);
        DriveApp.getRootFolder().removeFile(file);
      } catch(e) {}
    }

    const newFileId = file.getId();

    // Simpan ID File ke Spreadsheet
    if (rowIdxKop !== -1) {
      sheet.getRange(rowIdxKop, 2).setValue(newFileId);
    } else {
      sheet.appendRow(['KOP_SURAT_ID', newFileId]);
    }

    return { status: 'success', message: 'Kop Surat berhasil diupload!', fileId: newFileId };
  } catch (e) {
    const pesan = beautifyError(
      "Gagal Upload Kop Surat", 
      e, 
      "Pastikan file berupa Gambar (JPG/PNG) dan ukurannya tidak lebih dari 2MB. Cek juga koneksi internet Anda."
    );
    return { status: 'error', message: pesan };
  }
}

// 2. Ambil Kop Surat (Untuk ditampilkan saat load)
function getKopSurat(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'success', fileId: null };

    const data = sheet.getDataRange().getValues();
    let fileId = null;

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'KOP_SURAT_ID') {
        fileId = data[i][1];
        break;
      }
    }

    return { status: 'success', fileId: fileId };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Hapus Kop Surat
function hapusKopSurat(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'error', message: 'Data tidak ditemukan' };

    const data = sheet.getDataRange().getValues();
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'KOP_SURAT_ID') {
        const fileId = data[i][1];
        // Hapus file di Drive
        try { DriveApp.getFileById(fileId).setTrashed(true); } catch(e) {}
        
        // Hapus data di Sheet
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Kop Surat dihapus.' };
      }
    }
    return { status: 'success', message: 'Tidak ada kop surat.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI BANTUAN TRANSAKSI --- */

function getAllOptions(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    
    // 1. Uraian
    const uraianData = getUraianList(token);
    const listUraian = (uraianData.status === 'success') ? uraianData.data : [];

    // 2. Toko
    const tokoData = getTokoList(token);
    const listToko = (tokoData.status === 'success') ? tokoData.data : [];

    // 3. Guru
    const guruData = getGuruList(token);
    const listGuru = (guruData.status === 'success') ? guruData.data : [];

    // 4. Satuan (Ambil dari sheet 'Satuan' Col A)
    let listSatuan = [];
    const sheetSat = ss.getSheetByName('Satuan');
    if (sheetSat && sheetSat.getLastRow() > 1) {
       listSatuan = sheetSat.getRange(2, 1, sheetSat.getLastRow()-1, 1).getValues()
                    .flat().filter(v => v !== "");
    }

    // 5. Barang (Ambil dari sheet 'Data Barang' Col A)
    let listBarang = [];
    const sheetBarang = ss.getSheetByName('Data Barang');
    if (sheetBarang && sheetBarang.getLastRow() > 1) {
       // Kita ambil Col A sebagai nama barang
       const rawBarang = sheetBarang.getRange(2, 1, sheetBarang.getLastRow()-1, 1).getValues();
       listBarang = rawBarang.map(r => ({ nama: r[0] })).filter(r => r.nama !== "");
    }

    return {
      status: 'success',
      data: {
        uraian: listUraian,
        toko: listToko,
        guru: listGuru,
        satuan: listSatuan,
        dataBarang: listBarang
      }
    };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI SIMPAN TRANSAKSI --- */

function simpanTransaksiBaru(token, data) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataTransaksi');

    // 1. Buat Sheet Transaksi jika belum ada
    if (!sheet) {
      sheet = ss.insertSheet('DataTransaksi');
      // Header Database
      sheet.appendRow([
        "ID_Transaksi", 
        "Tanggal", 
        "Tipe",         // Toko / Tukang
        "Uraian", 
        "Pihak_Ketiga", // Nama Toko / Nama Tukang
        "Pemesan",      // Nama Guru
        "Items_JSON",   // Detail Barang (disimpan format JSON text)
        "Total_Biaya",
        "Waktu_Input"
      ]);
    }

    // 2. Format Data
    const id = Utilities.getUuid();
    const timestamp = new Date();
    
    // Konversi Object Items menjadi String JSON agar masuk 1 sel
    const itemsString = JSON.stringify(data.items);
    
    // Pastikan data string aman (pakai kutip satu untuk teks)
    const rowData = [
      id,
      "'" + data.tanggal, // Format Text agar tanggal tidak berubah format
      data.tipe,
      data.uraian,
      data.pihakKetiga,
      data.pemesan,
      itemsString,
      data.total,
      timestamp
    ];

    // 3. Simpan
    sheet.appendRow(rowData);

    return { status: 'success', message: 'Transaksi berhasil disimpan!' };

  } catch (e) {
    return { status: 'error', message: 'Gagal menyimpan: ' + e.toString() };
  }
}

/* --- TAMBAHAN UPDATE: FUNGSI CRUD TRANSAKSI --- */

/* --- UPDATE: GET TRANSAKSI LIST (DYNAMIC COLUMNS) --- */
function getTransaksiList(token, tipe) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    if (!sheet) return { status: 'success', data: [] };

    // [FIX C] PETA HEADER
    const h = getHeaderMap(sheet);
    
    // Cek kolom wajib, jika tidak ada berarti sheet kosong/rusak
    if (h['ID_Transaksi'] === undefined) return { status: 'success', data: [] };

    const data = sheet.getDataRange().getValues();
    const result = [];
    
    const formatDate = (dateObj) => {
      if(!dateObj) return "";
      return Utilities.formatDate(new Date(dateObj), "GMT+7", "yyyy-MM-dd");
    };
    const formatDateDisplay = (dateObj) => {
      if(!dateObj) return "";
      return Utilities.formatDate(new Date(dateObj), "GMT+7", "dd-MM-yyyy");
    };

    // Loop data mulai dari baris 2 (index 1)
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      
      // Ambil data menggunakan Map Index
      const rowTipe = row[h['Tipe']];
      
      if (rowTipe === tipe) {
        let items = [], surat = null, tglSurat = null;
        
        // Ambil JSON Items dengan aman
        if (h['Items_JSON'] !== undefined) {
           try { items = JSON.parse(row[h['Items_JSON']]); } catch (err) { items = []; }
        }

        // Ambil Data Surat
        // Header "Data_Surat_JSON" mungkin belum ada di file lama, jadi cek undefined
        if (h['Data_Surat_JSON'] !== undefined && row[h['Data_Surat_JSON']]) { 
            try { surat = JSON.parse(row[h['Data_Surat_JSON']]); } catch (err) { surat = null; } 
        }

        // Ambil Data Tanggal
        if (h['Data_Tanggal_JSON'] !== undefined && row[h['Data_Tanggal_JSON']]) { 
            try { tglSurat = JSON.parse(row[h['Data_Tanggal_JSON']]); } catch (err) { tglSurat = null; } 
        }

        // Ambil PDF ID (Header mungkin "File_PDF_ID" atau kolom ke-12 manual sebelumnya)
        // Kita standarkan nama kolom PDF menjadi "File_PDF_ID"
        let pdfId = null;
        if (h['File_PDF_ID'] !== undefined) {
           pdfId = row[h['File_PDF_ID']];
        } else if (row.length > 11) { 
           // Fallback untuk data lama yang belum punya header File_PDF_ID (kolom L / index 11)
           pdfId = row[11]; 
        }

        result.push({
          id: row[h['ID_Transaksi']],
          tanggal: formatDate(row[h['Tanggal']]),
          tanggalDisplay: formatDateDisplay(row[h['Tanggal']]),
          tipe: rowTipe,
          uraian: row[h['Uraian']],
          pihakKetiga: row[h['Pihak_Ketiga']],
          pemesan: row[h['Pemesan']],
          items: items,
          total: row[h['Total_Biaya']],
          dataSurat: surat,
          dataTanggal: tglSurat,
          pdfId: pdfId
        });
      }
    }
    
    // Sort Date Ascending
    result.sort((a, b) => {
      if (a.tanggal < b.tanggal) return -1;
      if (a.tanggal > b.tanggal) return 1;
      return 0;
    });

    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: EDIT TRANSAKSI (DYNAMIC COLUMNS) --- */
function editTransaksiItem(token, data) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    
    // [FIX C] PETA HEADER
    const h = getHeaderMap(sheet);
    const allData = sheet.getDataRange().getValues();

    // Pastikan ID ada
    if (h['ID_Transaksi'] === undefined) return { status: 'error', message: 'Struktur Data Transaksi rusak (ID_Transaksi hilang).' };

    for (let i = 1; i < allData.length; i++) {
      // Cek ID menggunakan index dari Map
      if (allData[i][h['ID_Transaksi']] == data.id) { 
        const rowIdx = i + 1;
        const itemsString = JSON.stringify(data.items);

        // Fungsi helper lokal untuk update sel jika kolom ada
        const updateCell = (headerName, val) => {
          if (h[headerName] !== undefined) {
            // index map 0-based, getRange kolom 1-based, jadi +1
            sheet.getRange(rowIdx, h[headerName] + 1).setValue(val);
          }
        };

        updateCell('Tanggal', "'" + data.tanggal);
        updateCell('Uraian', data.uraian);
        updateCell('Pihak_Ketiga', data.pihakKetiga);
        updateCell('Pemesan', data.pemesan);
        updateCell('Items_JSON', itemsString);
        updateCell('Total_Biaya', data.total);
        
        return { status: 'success', message: 'Transaksi berhasil diperbarui!' };
      }
    }
    return { status: 'error', message: 'ID Transaksi tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI BARU: SINKRONISASI PERUBAHAN MASTER KE TRANSAKSI --- */
function sinkronisasiDataTransaksi(token, jenisPerubahan, nilaiLama, nilaiBaru) {
  if (nilaiLama === nilaiBaru) return; // Tidak perlu update jika nama sama

  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    if (!sheet) return;

    // Peta Header untuk mengetahui posisi kolom
    const h = getHeaderMap(sheet);
    
    // Pastikan kolom-kolom penting ada
    if (h['Uraian'] === undefined || h['Pihak_Ketiga'] === undefined || h['Pemesan'] === undefined) return;

    const data = sheet.getDataRange().getValues();
    
    // Loop semua baris transaksi (Mulai index 1 untuk skip header)
    for (let i = 1; i < data.length; i++) {
      let isUpdated = false;
      const row = data[i];
      const rowIdx = i + 1;

      // 1. UPDATE URAIAN (Jika yang diedit adalah Uraian Pekerjaan)
      if (jenisPerubahan === 'URAIAN') {
        if (String(row[h['Uraian']]).trim() === String(nilaiLama).trim()) {
          sheet.getRange(rowIdx, h['Uraian'] + 1).setValue(nilaiBaru);
        }
      }

      // 2. UPDATE PIHAK KETIGA (Toko atau Tukang)
      if (jenisPerubahan === 'TOKO' || jenisPerubahan === 'TUKANG') {
        // Cek Kolom Pihak Ketiga
        if (String(row[h['Pihak_Ketiga']]).trim() === String(nilaiLama).trim()) {
          sheet.getRange(rowIdx, h['Pihak_Ketiga'] + 1).setValue(nilaiBaru);
        }
      }

      // 3. UPDATE PEMESAN / GURU
      if (jenisPerubahan === 'GURU') {
        // A. Cek Kolom Pemesan (Untuk Transaksi Toko/Tukang yang dipesan guru ini)
        if (String(row[h['Pemesan']]).trim() === String(nilaiLama).trim()) {
          sheet.getRange(rowIdx, h['Pemesan'] + 1).setValue(nilaiBaru);
        }

        // B. Cek Kolom Pihak Ketiga (Khusus Transaksi Honor Guru)
        if (row[h['Tipe']] === 'GURU' && String(row[h['Pihak_Ketiga']]).trim() === String(nilaiLama).trim()) {
           sheet.getRange(rowIdx, h['Pihak_Ketiga'] + 1).setValue(nilaiBaru);
        }

        // C. Cek Detail Items JSON (Karena nama guru juga disimpan di dalam JSON item honor)
        if (row[h['Tipe']] === 'GURU') {
          let items = [];
          try { items = JSON.parse(row[h['Items_JSON']]); } catch (e) {}
          
          let jsonChanged = false;
          items.forEach(item => {
            if (String(item.nama).trim() === String(nilaiLama).trim()) {
              item.nama = nilaiBaru; // Update nama di dalam JSON
              jsonChanged = true;
            }
          });

          if (jsonChanged) {
             sheet.getRange(rowIdx, h['Items_JSON'] + 1).setValue(JSON.stringify(items));
          }
        }
      }
    }
    
    console.log("Sinkronisasi Selesai: " + nilaiLama + " -> " + nilaiBaru);

  } catch (e) {
    console.error("Gagal Sinkronisasi: " + e.toString());
  }
}

// 3. Hapus Transaksi
function hapusTransaksiItem(token, idToDelete) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == idToDelete) {
        sheet.deleteRow(i + 1);
        return { status: 'success', message: 'Transaksi berhasil dihapus.' };
      }
    }
    return { status: 'error', message: 'ID tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- TAMBAHAN FITUR NOMOR SURAT --- */

/* --- UPDATE: SIMPAN NOMOR SURAT (DYNAMIC) --- */
function simpanDataSurat(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    
    // Pastikan Kolom "Data_Surat_JSON" ada, jika tidak, buatkan.
    const colIndex = ensureColumn(sheet, 'Data_Surat_JSON'); // 0-based
    const idIndex = ensureColumn(sheet, 'ID_Transaksi');
    
    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (data[i][idIndex] == form.id) {
        const suratJson = JSON.stringify(form.dataSurat);
        sheet.getRange(i + 1, colIndex + 1).setValue(suratJson);
        return { status: 'success', message: 'Nomor Surat berhasil disimpan!' };
      }
    }
    return { status: 'error', message: 'Transaksi tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: SIMPAN TANGGAL SURAT (DYNAMIC) --- */
function simpanTanggalSurat(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataTransaksi');
    
    // Pastikan Kolom "Data_Tanggal_JSON" ada
    const colIndex = ensureColumn(sheet, 'Data_Tanggal_JSON');
    const idIndex = ensureColumn(sheet, 'ID_Transaksi');

    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (data[i][idIndex] == form.id) {
        const tglJson = JSON.stringify(form.dataTanggal);
        sheet.getRange(i + 1, colIndex + 1).setValue(tglJson);
        return { status: 'success', message: 'Tanggal Surat berhasil disimpan!' };
      }
    }
    return { status: 'error', message: 'Transaksi tidak ditemukan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI DASHBOARD (UPDATE LENGKAP) --- */

/* --- UPDATE FUNGSI DASHBOARD (MENYERTAKAN RECOVERY CODE) --- */
function getDashboardStats(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    
    // 1. Ambil Data Sekolah Lengkap (Existing Code)
    let sheetSekolah = ss.getSheetByName('DataSekolah');
    let schoolProfile = {};
    let anggaran = 0;
    
    if (sheetSekolah) {
      const data = sheetSekolah.getRange(2, 1, 1, 19).getValues()[0]; // Pastikan range mencakup semua kolom
      schoolProfile = {
        nama: data[0] || '-',
        npsn: String(data[1] || '').replace(/'/g, '') || '-',
        nsm: String(data[2] || '').replace(/'/g, '') || '-',
        alamat: data[3] || '-',
        provinsi: data[4] || '',
        kabupaten: data[5] || '',
        kecamatan: data[6] || '-',
        kelurahan: data[7] || '-',
        tempatTTD: data[8] || '-',
        noTelp: String(data[13] || '').replace(/'/g, '') || '-',
        kepala: data[9] || '-',
        nipKepala: String(data[10] || '').replace(/'/g, '') || '-',
        bendahara: data[11] || '-',
        nipBendahara: String(data[12] || '').replace(/'/g, '') || '-',
        email: data[14] || '-'
      };
      anggaran = Number(data[16]) || 0; 
    }

    // 2. Hitung Pengeluaran (Existing Code)
    let sheetTrans = ss.getSheetByName('DataTransaksi');
    let totalPengeluaran = 0;
    let jumlahTransaksi = 0;
    if (sheetTrans) {
      const dataTrans = sheetTrans.getDataRange().getValues();
      for (let i = 1; i < dataTrans.length; i++) {
        let biaya = Number(dataTrans[i][7]) || 0;
        totalPengeluaran += biaya;
        jumlahTransaksi++;
      }
    }

    // --- 3. [BARU] AMBIL KODE PEMULIHAN DARI MASTER DB ---
    let recCode = "-";
    try {
      const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
      const masterData = ssMaster.getDataRange().getValues();
      
      // Cari baris dimana Kolom E (Index 4) == Token Sekolah saat ini
      // Token = ID Spreadsheet Sekolah
      const foundUser = masterData.find(row => row[4] === token);
      
      // Kode Pemulihan ada di Kolom G (Index 6)
      if (foundUser && foundUser[6]) {
        recCode = foundUser[6];
      }
    } catch (e) {
      // Abaikan error jika gagal baca master, biarkan default "-"
      console.error("Gagal baca Master DB untuk Rec Code: " + e);
    }
    // -----------------------------------------------------

    return {
      status: 'success',
      data: {
        anggaran: anggaran,
        pengeluaran: totalPengeluaran,
        jumlahTransaksi: jumlahTransaksi,
        profile: schoolProfile,
        recoveryCode: recCode // <--- Kirim ke Frontend
      }
    };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI BARU: HELPER UNTUK BACA SETTING FOLDER --- */
function getSettingValue(token, keyName) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return null;
    
    const data = sheet.getDataRange().getValues();
    for(let i=0; i<data.length; i++) {
      if(data[i][0] === keyName) return data[i][1];
    }
    return null;
  } catch(e) { return null; }
}

/* --- FUNGSI PENGATURAN NOMOR OTOMATIS --- */

// 1. Simpan Pengaturan Nomor Otomatis
function simpanSettingNomor(token, settings) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    let rowIdx = -1;

    // Cari Key SETTING_NOMOR_OTOMATIS
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'SETTING_NOMOR_OTOMATIS') {
        rowIdx = i + 1;
        break;
      }
    }

    const jsonSettings = JSON.stringify(settings);

    if (rowIdx !== -1) {
      sheet.getRange(rowIdx, 2).setValue(jsonSettings);
    } else {
      sheet.appendRow(['SETTING_NOMOR_OTOMATIS', jsonSettings]);
    }

    return { status: 'success', message: 'Pengaturan Nomor Otomatis disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Ambil Pengaturan Nomor Otomatis
function getSettingNomor(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'success', data: null };

    const data = sheet.getDataRange().getValues();
    let settings = null;

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'SETTING_NOMOR_OTOMATIS') {
        try {
          settings = JSON.parse(data[i][1]);
        } catch (e) { settings = null; }
        break;
      }
    }

    return { status: 'success', data: settings };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- HELPER: DYNAMIC HEADER MAPPING --- */
// Fungsi ini membaca baris pertama (Header) dan membuat peta { "NAMA_KOLOM": index_0_based }
function getHeaderMap(sheet) {
  if (!sheet) return {};
  // Ambil baris pertama saja
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const map = {};
  headers.forEach((h, i) => {
    // Simpan nama kolom sebagai key (trim spasi) dan indexnya
    if(h) map[String(h).trim()] = i; 
  });
  return map;
}

// Fungsi Helper untuk memastikan kolom ada, jika tidak ada maka buat baru
function ensureColumn(sheet, headerName) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  let colIndex = headers.indexOf(headerName);
  
  if (colIndex === -1) {
    // Jika tidak ketemu, buat di kolom terakhir + 1
    colIndex = headers.length; 
    sheet.getRange(1, colIndex + 1).setValue(headerName);
  }
  return colIndex; // Return 0-based index
}

/* --- FUNGSI MAINTENANCE: PERBAIKI STRUKTUR HEADER OTOMATIS --- */

/**
 * Fungsi ini mendefinisikan struktur kolom yang WAJIB ada di setiap sheet.
 * UPDATE: Menambahkan sheet referensi (Satuan & Data Barang) agar ikut disinkronisasi.
 */
const DB_SCHEMA = {
  'DataSekolah': [
    "Nama Sekolah", "NPSN", "NSM", "Alamat Lengkap", "Provinsi", 
    "Kabupaten", "Kecamatan", "Kelurahan", "Tempat TTD",
    "Nama Kepala", "NIP Kepala", "Nama Bendahara", "NIP Bendahara", 
    "No Telp", "Email", "Nama Dana BOS",
    "Jumlah Anggaran", "Tahun Anggaran", "Periode Anggaran"
  ],
  'DataUraian': [
    "ID", "Nomor Bukti", "Uraian Pekerjaan"
  ],
  'DataToko': [
    "ID", "Nama Toko", "Jenis Toko", "Alamat Lengkap", "No Telp", "Nama Pemilik", "Tempat TTD"
  ],
  'DataTukang': [
    "ID", "Nama Lengkap", "Alamat Lengkap"
  ],
  'DataGuru': [
    "ID", "Nama Lengkap", "NIP"
  ],
  'DataTransaksi': [
    "ID_Transaksi", "Tanggal", "Tipe", "Uraian", "Pihak_Ketiga", "Pemesan", 
    "Items_JSON", "Total_Biaya", "Waktu_Input", 
    "Data_Surat_JSON", "Data_Tanggal_JSON", "File_PDF_ID"
  ],
  'DataPengaturan': [
    "KEY", "VALUE"
  ],
  // --- TAMBAHAN BARU UNTUK REFERENSI ---
  'Satuan': [
    "Nama Satuan", "Kategori", "Contoh Penggunaan"
  ],
  'Data Barang': [
    "Nama Barang", "Satuan", "Harga Referensi", "Kategori", "Nama Kategori"
  ],
  'Uraian': [
    "Daftar Referensi Uraian" // Header tunggal untuk master uraian
  ]
};

/**
 * Jalankan fungsi ini sekali-sekali (Manual atau via Menu) 
 * untuk memastikan header di Spreadsheet sinkron dengan Kode.
 */
function perbaikiSemuaHeader(token) {
  try {
    // Jika token tidak diberikan (dijalankan manual dari editor), 
    // ganti string di bawah ini dengan ID Spreadsheet Anda untuk testing.
    // Atau panggil fungsi ini dari console browser/frontend.
    if (!token) {
       // Opsional: Throw error atau gunakan ID default untuk debug
       // token = "ID_SPREADSHEET_ANDA_DISINI"; 
       return { status: 'error', message: 'Token/ID Spreadsheet diperlukan.' };
    }

    const ss = SpreadsheetApp.openById(token);
    let logPerbaikan = [];

    // Loop setiap nama sheet yang ada di SCHEMA
    for (const [sheetName, requiredHeaders] of Object.entries(DB_SCHEMA)) {
      
      let sheet = ss.getSheetByName(sheetName);
      
      // 1. Buat Sheet jika belum ada
      if (!sheet) {
        sheet = ss.insertSheet(sheetName);
        logPerbaikan.push(`Sheet baru dibuat: ${sheetName}`);
      }

      // 2. Ambil Header yang sudah ada
      // Jika sheet kosong, existingHeaders adalah array kosong
      let existingHeaders = [];
      if (sheet.getLastColumn() > 0) {
        existingHeaders = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
        // Trim spasi agar pencocokan akurat
        existingHeaders = existingHeaders.map(h => String(h).trim());
      }

      // 3. Cek Header Wajib
      requiredHeaders.forEach(headerName => {
        if (!existingHeaders.includes(headerName)) {
          // Jika header tidak ditemukan, tambahkan di kolom terakhir + 1
          const newColIndex = sheet.getLastColumn() + 1;
          sheet.getRange(1, newColIndex).setValue(headerName);
          
          // Style Header Baru (Bold & Abu-abu) biar rapi
          sheet.getRange(1, newColIndex).setFontWeight("bold").setBackground("#efefef");
          
          logPerbaikan.push(`Header ditambahkan di ${sheetName}: ${headerName}`);
        }
      });

      // 4. Opsional: Bekukan Baris 1 (Freeze Top Row)
      sheet.setFrozenRows(1);
    }

    if (logPerbaikan.length > 0) {
      return { status: 'success', message: 'Perbaikan Selesai:\n' + logPerbaikan.join('\n') };
    } else {
      return { status: 'success', message: 'Struktur Database sudah sesuai (Tidak ada perubahan).' };
    }

  } catch (e) {
    return { status: 'error', message: 'Gagal memperbaiki header: ' + e.toString() };
  }
}

/* --- PENGATURAN TEMPLATE CUSTOM --- */

// 1. Simpan ID Template Custom ke DataPengaturan
function simpanTemplateSettings(token, settings) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    
    // Helper untuk update atau insert key-value
    const updateOrInsert = (key, val) => {
      let found = false;
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === key) {
          sheet.getRange(i + 1, 2).setValue(val);
          found = true;
          break;
        }
      }
      if (!found) sheet.appendRow([key, val]);
    };

    updateOrInsert('TEMPLATE_ID_TOKO', settings.toko);
    updateOrInsert('TEMPLATE_ID_GURU', settings.guru);
    updateOrInsert('TEMPLATE_ID_TUKANG', settings.tukang);

    return { status: 'success', message: 'Pengaturan Template berhasil disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Ambil ID Template Custom
function getTemplateSettings(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'success', data: { toko:'', guru:'', tukang:'' } };

    const data = sheet.getDataRange().getValues();
    let res = { toko: '', guru: '', tukang: '' };

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'TEMPLATE_ID_TOKO') res.toko = data[i][1];
      if (data[i][0] === 'TEMPLATE_ID_GURU') res.guru = data[i][1];
      if (data[i][0] === 'TEMPLATE_ID_TUKANG') res.tukang = data[i][1];
    }
    return { status: 'success', data: res };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- HELPER FORMAT PESAN ERROR (Agar Tampil Keren) --- */
function beautifyError(judul, errorObj, saran) {
  const errorText = errorObj ? errorObj.toString() : "Unknown Error";
  
  return '<div style="text-align: left; font-size: 0.9rem;">' +
           // Header Merah
           '<div style="background: #ffe6e6; border-left: 5px solid #dc3545; padding: 10px; margin-bottom: 15px; color: #a71d2a;">' +
             '<i class="fas fa-exclamation-triangle"></i> <b>' + judul + '</b>' +
           '</div>' +
           
           // Detail Error Teknis
           '<p style="margin-bottom: 5px; font-weight:bold;">Detail Pesan Sistem:</p>' +
           '<div style="background: #f8f9fa; color: #555; padding: 10px; border-radius: 4px; border: 1px dashed #ccc; font-family: monospace; font-size: 0.85rem; margin-bottom: 15px; word-wrap: break-word;">' + 
              errorText + 
           '</div>' +

           // Saran / Solusi
           '<div style="background: #e7f1ff; border-left: 5px solid #0d6efd; padding: 10px; color: #084298;">' +
             '<b><i class="fas fa-lightbulb"></i> Solusi:</b><br>' +
             saran +
           '</div>' +
         '</div>';
}

/* --- UPDATE: PENCARIAN SERVER MENGAMBIL KATEGORI JUGA --- */
function cariBarangReferensi(token, keyword) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('Data Barang');
    
    if (!sheet) return { status: 'success', data: [] };

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return { status: 'success', data: [] };

    // PERBAIKAN DISINI:
    // Sebelumnya hanya ambil 3 kolom -> .getRange(..., 3)
    // Sekarang ambil 5 kolom (A s/d E) agar Kategori terbawa
    const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues(); 
    
    const lowerKey = keyword.toLowerCase();
    
    // Filter & Map
    let rawResults = data
      .filter(row => {
         // Filter berdasarkan Nama Barang ATAU Kategori (biar makin canggih)
         const namaBrg = String(row[0]).toLowerCase();
         const katNama = String(row[4]).toLowerCase(); // Kolom E
         return (namaBrg.includes(lowerKey) || katNama.includes(lowerKey));
      })
      .map(row => ({
        nama: String(row[0]).trim(), // Kolom A
        satuan: row[1] || '',        // Kolom B
        harga: row[2] || 0,          // Kolom C
        katKode: row[3] || '',       // Kolom D (Opsional)
        katNama: row[4] || ''        // Kolom E (Kategori) -> INI KUNCINYA
      }));

    // LOGIKA HAPUS DUPLIKAT (Priority Logic)
    const uniqueResults = [];
    const seenNames = new Set();

    rawResults.forEach(item => {
      if (!seenNames.has(item.nama)) {
        seenNames.add(item.nama);
        uniqueResults.push(item);
      }
    });

    // SORTING (Sama seperti logika frontend agar konsisten)
    uniqueResults.sort((a, b) => {
      const nameA = String(a.nama).toLowerCase();
      const nameB = String(b.nama).toLowerCase();
      
      // Prioritas 1: Persis Sama
      if (nameA === lowerKey && nameB !== lowerKey) return -1;
      if (nameB === lowerKey && nameA !== lowerKey) return 1;
      
      // Prioritas 2: Diawali
      const startA = nameA.startsWith(lowerKey);
      const startB = nameB.startsWith(lowerKey);
      if (startA && !startB) return -1;
      if (!startA && startB) return 1;
      
      // Prioritas 3: Abjad
      return nameA.length - nameB.length;
    });

    // Batasi hasil agar ringan
    return { status: 'success', data: uniqueResults.slice(0, 30) };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI BARU: AMBIL DATA BARANG LENGKAP UNTUK MODAL --- */
function getReferensiBarangLengkap(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('Data Barang');
    if (!sheet) return { status: 'error', message: 'Sheet Data Barang tidak ditemukan.' };

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return { status: 'success', data: [] };

    // Ambil Kolom A s/d E (5 Kolom)
    const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
    
    // Mapping Data
    const result = data.map(r => ({
      nama: r[0],         // A
      satuan: r[1],       // B
      harga: r[2] || 0,   // C
      katKode: r[3] || '',// D
      katNama: r[4] || '' // E
    }));

    // Sort by Kategori lalu Nama Barang
    result.sort((a, b) => {
      if (a.katNama < b.katNama) return -1;
      if (a.katNama > b.katNama) return 1;
      return a.nama.localeCompare(b.nama);
    });

    return { status: 'success', data: result };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI BARU: UPDATE HARGA REFERENSI --- */
function updateHargaReferensi(token, namaBarang, hargaBaru) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('Data Barang');
    if (!sheet) return { status: 'error', message: 'Sheet tidak ditemukan' };
    
    const data = sheet.getDataRange().getValues();
    const cleanNama = String(namaBarang).trim().toLowerCase();
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]).trim().toLowerCase() === cleanNama) {
        // Update Kolom C (Index 3 -> getRange kolom ke-3)
        sheet.getRange(i + 1, 3).setValue(hargaBaru);
        return { status: 'success', message: 'Harga berhasil diperbarui.' };
      }
    }
    return { status: 'error', message: 'Barang tidak ditemukan di database.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- TAMBAHAN: FUNGSI AMBIL INFO SATUAN LENGKAP --- */
function getReferensiSatuanLengkap(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('Satuan');
    
    // Jika sheet belum ada
    if (!sheet) return { status: 'error', message: 'Sheet Satuan tidak ditemukan.' };

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return { status: 'success', data: [] }; // Kosong

    // Ambil Kolom A (Nama), B (Kategori), C (Penggunaan/Contoh)
    // getRange(row, col, numRows, numCols) -> Mulai baris 2, Kolom 1, Sebanyak data, 3 Kolom
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    
    // Mapping array ke object agar rapi
    const result = data.map(r => ({
      nama: r[0],
      kategori: r[1] || '-',
      contoh: r[2] || '-'
    }));

    // Urutkan berdasarkan Nama Satuan (A-Z)
    result.sort((a, b) => a.nama.localeCompare(b.nama));

    return { status: 'success', data: result };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/**
 * Fungsi Helper untuk menstandarkan Nama Sekolah
 * Contoh: "SMA NEGERI 1 BLK" -> "sman1blk"
 * Contoh: "SMAN 1 BLK" -> "sman1blk"
 * Contoh: "SMA.N 1 - BLK" -> "sman1blk"
 */
function normalizeName(name) {
  if (!name) return "";
  return name.toString().toLowerCase()
    .replace(/\s+/g, '')        // Hapus semua spasi
    .replace(/negeri/g, 'n')    // Ganti kata 'negeri' jadi 'n' (SMAN, SMPN, MTSN)
    .replace(/[^a-z0-9]/g, ''); // Hapus simbol (titik, koma, strip, dll)
}

/* --- FUNGSI GENERATE RECOVERY CODE SUSULAN (UNTUK AKUN LAMA) --- */
function generateRecoveryCodeOnly(token) {
  try {
    const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
    const data = ssMaster.getDataRange().getValues();
    
    // Cari user berdasarkan Token (ID Spreadsheet Sekolah)
    // Token ada di Kolom E (Index 4)
    for (let i = 1; i < data.length; i++) {
      if (data[i][4] === token) {
        
        // Cek apakah sudah ada kode? (Opsional, tapi untuk safety)
        if (data[i][6] && data[i][6] !== "" && data[i][6] !== "-") {
           return { status: 'error', message: 'Kode pemulihan sudah ada.' };
        }

        // Generate Kode Baru
        const newCode = "REC-" + Utilities.getUuid().slice(0, 8).toUpperCase();
        
        // Simpan ke Kolom G (Index 6)
        ssMaster.getRange(i + 1, 7).setValue(newCode);
        
        return { status: 'success', newCode: newCode };
      }
    }
    return { status: 'error', message: 'User tidak ditemukan.' };
    
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

function testKirimEmailManual() {
  // Ganti dengan email Anda sendiri untuk tes
  MailApp.sendEmail({
    to: "emailanda@gmail.com", 
    subject: "Tes Izin Script",
    htmlBody: "Jika email ini masuk, berarti izin sudah oke."
  });
  console.log("Email berhasil dikirim");
}

function migrasiPasswordKeHash() {
  const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
  const data = ssMaster.getDataRange().getValues();
  
  // Mulai dari baris ke-2 (Index 1) karena baris 1 adalah Header
  for (let i = 1; i < data.length; i++) {
    const currentPass = String(data[i][3]); // Kolom D (Password)
    const currentSalt = data[i][7];         // Kolom H (Salt)
    
    // Cek apakah data ini belum di-hash (misal: Salt-nya masih kosong)
    // Asumsi: Password hash SHA-256 panjangnya 64 karakter. Jika < 64 kemungkinan masih plain text.
    // Atau cek kolom Salt kosong.
    if (!currentSalt || currentSalt === "" || currentPass.length < 64) {
      
      const salt = generateSalt();
      const hash = hashPassword(currentPass, salt);
      
      // Simpan kembali ke Spreadsheet (Baris = i+1)
      ssMaster.getRange(i + 1, 4).setValue(hash); // Update Kolom D (Password jadi Hash)
      ssMaster.getRange(i + 1, 8).setValue(salt); // Update Kolom H (Isi Salt)
      
      Logger.log("Berhasil migrasi user: " + data[i][1]);
    }
  }
  Logger.log("Migrasi Selesai.");
}

/* --- FUNGSI UBAH PASSWORD (USER LOGGED IN) --- */
function changeUserPassword(form) {
  const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID).getSheetByName('Users');
  
  // 1. Cari User berdasarkan Email
  const finder = ssMaster.getRange("C:C").createTextFinder(form.email).matchEntireCell(true);
  const found = finder.findNext();

  if (!found) {
    return { status: 'error', message: 'User tidak ditemukan.' };
  }

  const rowIdx = found.getRow();
  // Ambil data user saat ini [Time, Nama, Email, PassHash, DbID, SessionID, RecCode, SALT]
  // Password Hash ada di kolom 4 (D), Salt ada di kolom 8 (H)
  const userData = ssMaster.getRange(rowIdx, 1, 1, 8).getValues()[0];
  
  const storedHash = String(userData[3]); 
  const storedSalt = String(userData[7]); 

  // 2. Verifikasi Password Lama
  const oldHashInput = hashPassword(form.oldPass, storedSalt);

  if (oldHashInput !== storedHash) {
    return { status: 'error', message: 'Password Lama salah!' };
  }

  // 3. Proses Ganti Password Baru
  const newSalt = generateSalt();             // Buat Salt Baru
  const newHash = hashPassword(form.newPass, newSalt); // Hash Password Baru dengan Salt Baru

  // 4. Simpan ke Database
  // Update Kolom D (Password Hash)
  ssMaster.getRange(rowIdx, 4).setValue(newHash);
  // Update Kolom H (Salt)
  ssMaster.getRange(rowIdx, 8).setValue(newSalt);

  return { status: 'success', message: 'Password berhasil diubah.' };
}

/* --- FUNGSI KHUSUS PENGATURAN SAMPUL (COVER) --- */

// 1. Simpan Logo Sampul
function simpanLogoSampul(token, fileData) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    let oldFileId = null; 
    let rowIdx = -1;

    // Cek apakah sudah ada ID Logo sebelumnya
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'COVER_LOGO_ID') {
        oldFileId = data[i][1];
        rowIdx = i + 1;
        break;
      }
    }

    // Hapus File Lama di Drive agar hemat storage
    if (oldFileId) { try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {} }

    // Upload File Baru
    const blob = Utilities.newBlob(Utilities.base64Decode(fileData.base64), fileData.mimeType, "LogoSampul_" + Utilities.formatDate(new Date(), "GMT+7", "yyyyMMddHHmmss"));
    const file = DriveApp.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // Simpan ID ke Spreadsheet
    if (rowIdx !== -1) {
      sheet.getRange(rowIdx, 2).setValue(file.getId());
    } else {
      sheet.appendRow(['COVER_LOGO_ID', file.getId()]);
    }

    return { status: 'success', message: 'Logo Sampul berhasil diupload!', fileId: file.getId() };
  } catch (e) {
    return { status: 'error', message: 'Gagal Upload: ' + e.toString() };
  }
}

// 2. Simpan Konfigurasi Sampul Lengkap (Header, Judul, Periode)
function simpanDetailSampul(token, config) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    
    // Helper untuk update/insert
    const upsert = (key, val) => {
      let found = false;
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === key) {
          sheet.getRange(i + 1, 2).setValue(val);
          found = true;
          break;
        }
      }
      if (!found) sheet.appendRow([key, val]);
    };

    upsert('COVER_HEADER_TEXT', config.header);
    upsert('COVER_TITLE_TEXT', config.title);
    upsert('COVER_PERIOD_TEXT', config.period);

    return { status: 'success', message: 'Konfigurasi Sampul berhasil disimpan.' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 3. Ambil Pengaturan Sampul Lengkap
function getCoverSettings(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    
    let result = { 
      headerText: 'KEMENTERIAN AGAMA', 
      titleText: 'LAPORAN PENGGUNAAN DANA BOS',
      periodText: '',
      logoId: null 
    };

    if (sheet) {
      const data = sheet.getDataRange().getValues();
      for (let i = 0; i < data.length; i++) {
        const key = data[i][0];
        const val = data[i][1];
        
        if (key === 'COVER_HEADER_TEXT') result.headerText = val;
        if (key === 'COVER_TITLE_TEXT') result.titleText = val;
        if (key === 'COVER_PERIOD_TEXT') result.periodText = val;
        if (key === 'COVER_LOGO_ID') result.logoId = val;
      }
    }
    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI SURAT PENGANTAR (DATABASE) --- */

// 1. Simpan Data Surat Pengantar ke DataPengaturan
function simpanDataSuratPengantar(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    
    // Helper untuk update/insert
    const upsert = (key, val) => {
      let found = false;
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === key) {
          sheet.getRange(i + 1, 2).setValue(val);
          found = true;
          break;
        }
      }
      if (!found) sheet.appendRow([key, val]);
    };

    // Kita simpan dengan KEY khusus berawalan SP_
    upsert('SP_NOMOR', form.nomor);
    upsert('SP_TEMPAT', form.tempat);
    upsert('SP_TANGGAL', form.tanggal);

    return { status: 'success', message: 'Data Surat Pengantar tersimpan di Database!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Ambil Data Surat Pengantar
function getDataSuratPengantar(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    
    let result = { nomor: '', tempat: '', tanggal: '' };

    if (sheet) {
      const data = sheet.getDataRange().getValues();
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === 'SP_NOMOR') result.nomor = data[i][1];
        if (data[i][0] === 'SP_TEMPAT') result.tempat = data[i][1];
        if (data[i][0] === 'SP_TANGGAL') {
           // Format tanggal agar aman dikirim ke frontend (YYYY-MM-DD)
           const rawDate = data[i][1];
           if (rawDate) {
             try {
               result.tanggal = Utilities.formatDate(new Date(rawDate), "GMT+7", "yyyy-MM-dd");
             } catch(e) { result.tanggal = ''; }
           }
        }
      }
    }
    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI LEMBAR VERIFIKASI (BARU) --- */

// 1. Simpan Data Verifikasi
function simpanDataVerifikasi(token, data) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const sheetData = sheet.getDataRange().getValues();
    let rowIdx = -1;

    // Cari Key VERIFIKASI_DATA
    for (let i = 0; i < sheetData.length; i++) {
      if (sheetData[i][0] === 'VERIFIKASI_DATA') {
        rowIdx = i + 1;
        break;
      }
    }

    const jsonString = JSON.stringify(data);

    if (rowIdx !== -1) {
      sheet.getRange(rowIdx, 2).setValue(jsonString);
    } else {
      sheet.appendRow(['VERIFIKASI_DATA', jsonString]);
    }

    return { status: 'success', message: 'Data Verifikasi berhasil disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

// 2. Ambil Data Verifikasi
function getDataVerifikasi(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) return { status: 'success', data: null };

    const data = sheet.getDataRange().getValues();
    let result = null;

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'VERIFIKASI_DATA') {
        try {
          result = JSON.parse(data[i][1]);
        } catch (e) { result = null; }
        break;
      }
    }
    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- HELPER: AMBIL ID DEFAULT DARI MASTER DB --- */
function getMasterDefaultId(kodeTipe) {
  try {
    const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID);
    const sheet = ssMaster.getSheetByName('Cetak_Lainnya');
    if (!sheet) return null;

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return null;

    // Ambil Kolom A (Kode) dan C (ID)
    // Ingat: Data dimulai dari baris 2
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues(); 
    
    // Cari baris pertama yang KODE-nya cocok (misal: "SP" atau "VERIF")
    // row[0] = Kode, row[1] = Nama, row[2] = ID
    const found = data.find(r => String(r[0]).toUpperCase() === kodeTipe.toUpperCase());
    
    return found ? found[2] : null;

  } catch (e) {
    console.error("Gagal ambil default master: " + e.toString());
    return null;
  }
}

/* --- UPDATE: FUNGSI AMBIL LIST COVER DARI MASTER DB (FILTER 'COVER') --- */
function getCoverTemplateList(token) {
  try {
    // 1. Ambil Template Bawaan (System/Master)
    let systemTemplates = [];
    try {
      const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID);
      const sheet = ssMaster.getSheetByName('Cetak_Lainnya');
      
      if (sheet) {
        const lastRow = sheet.getLastRow();
        if (lastRow >= 2) {
          // Ambil 3 Kolom: Kode, Nama, ID
          const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
          
          // FILTER HANYA YANG KODE-NYA 'COVER'
          systemTemplates = data
            .filter(r => String(r[0]).toUpperCase() === 'COVER' && r[2] !== "")
            .map(r => ({
              name: r[1], // Nama Desain
              id: r[2]    // ID File
            }));
        }
      }
    } catch (e) {
      console.error("Gagal baca Master Cetak_Lainnya: " + e.toString());
    }

    // 2. Cek User Custom ID (Sama seperti sebelumnya)
    const ssUser = SpreadsheetApp.openById(token);
    const sheetSet = ssUser.getSheetByName('DataPengaturan');
    let customId = "";
    
    if (sheetSet) {
      const dataSet = sheetSet.getDataRange().getValues();
      for (let i = 0; i < dataSet.length; i++) {
        if (dataSet[i][0] === 'TEMPLATE_ID_COVER_CUSTOM') {
          customId = dataSet[i][1];
          break;
        }
      }
    }

    return { 
      status: 'success', 
      system: systemTemplates,
      userCustomId: customId
    };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: SIMPAN SETTING DOKUMEN PENDUKUNG --- */
function simpanSettingDokumenPendukung(token, settings) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    
    const updateOrInsert = (key, val) => {
      let found = false;
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === key) {
          sheet.getRange(i + 1, 2).setValue(val);
          found = true;
          break;
        }
      }
      if (!found) sheet.appendRow([key, val]);
    };

    // Kita hanya menyimpan yang Custom untuk cover, sisanya biasa
    updateOrInsert('TEMPLATE_ID_COVER_CUSTOM', settings.coverCustom);
    updateOrInsert('TEMPLATE_ID_SP', settings.sp);
    updateOrInsert('TEMPLATE_ID_VERIFIKASI', settings.verif);

    return { status: 'success', message: 'Pengaturan template berhasil disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: AMBIL SETTING DOKUMEN PENDUKUNG --- */
function getSettingDokumenPendukung(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    // Default values
    let res = { coverCustom: '', sp: '', verif: '' };

    if (sheet) {
      const data = sheet.getDataRange().getValues();
      for (let i = 0; i < data.length; i++) {
        const key = data[i][0];
        const val = data[i][1];
        
        if (key === 'TEMPLATE_ID_COVER_CUSTOM') res.coverCustom = val;
        if (key === 'TEMPLATE_ID_SP') res.sp = val;
        if (key === 'TEMPLATE_ID_VERIFIKASI') res.verif = val;
      }
    }
    return { status: 'success', data: res };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- [BARU] HELPER FOLDER GENERATE TAMBAHAN --- */
function ensureFolderPendukung(token) {
  const ss = SpreadsheetApp.openById(token);
  let sheet = ss.getSheetByName('DataPengaturan');
  if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

  const data = sheet.getDataRange().getValues();
  let folderId = null;
  let sekolahFolderId = null;

  // Cari ID Folder Pendukung & Folder Sekolah Utama
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === 'FOLDER_PENDUKUNG_ID') folderId = data[i][1];
    if (data[i][0] === 'FOLDER_SEKOLAH_ID') sekolahFolderId = data[i][1];
  }

  // Jika Folder Pendukung belum ada
  if (!folderId || folderId === "") {
    if (!sekolahFolderId) throw new Error("Folder Sekolah Induk tidak ditemukan.");
    
    const parentFolder = DriveApp.getFolderById(sekolahFolderId);
    const newFolder = parentFolder.createFolder("File Generate Tambahan");
    folderId = newFolder.getId();

    // Simpan ID Folder Baru ke Database
    sheet.appendRow(['FOLDER_PENDUKUNG_ID', folderId]);
  }

  return folderId;
}

/* --- [UPDATE] GENERATE DOKUMEN PENDUKUNG (DENGAN ERROR HANDLING TEMPLATE) --- */
function generateDokumenPendukung(token, tipe, formData) {
  try {
    const ss = SpreadsheetApp.openById(token);
    
    // 1. Ambil Data Sekolah
    let ds = {};
    const sheetSekolah = ss.getSheetByName('DataSekolah');
    if (sheetSekolah && sheetSekolah.getLastRow() >= 2) {
      const d = sheetSekolah.getRange(2, 1, 1, 19).getValues()[0];
      ds = {
        namaSekolah: d[0], npsn: String(d[1]).replace(/'/g,''), nsm: String(d[2]).replace(/'/g,''),
        alamat: d[3], provinsi: d[4], kabupaten: d[5], kecamatan: d[6], kelurahan: d[7], tempatTTD: d[8],
        namaKepala: d[9], nipKepala: String(d[10]).replace(/'/g,''), 
        namaBendahara: d[11], nipBendahara: String(d[12]).replace(/'/g,''),
        danaBOS: d[15], tahunAnggaran: d[17], periodeAnggaran: d[18]
      };
    }

    // 2. Persiapan Folder & ID File Lama
    const folderId = ensureFolderPendukung(token);
    const folder = DriveApp.getFolderById(folderId);
    
    // Key untuk menyimpan ID file hasil generate di DataPengaturan
    const outputKey = 'OUTPUT_ID_' + tipe; // Contoh: OUTPUT_ID_COVER
    
    // Ambil Data Pengaturan
    const sheetSet = ss.getSheetByName('DataPengaturan');
    let settingsMap = {};
    let rowIdxOutput = -1;
    const dataSet = sheetSet.getDataRange().getValues();
    
    dataSet.forEach((row, index) => {
      settingsMap[row[0]] = row[1];
      if (row[0] === outputKey) rowIdxOutput = index + 1;
    });

    // --- HAPUS FILE LAMA JIKA ADA ---
    const oldFileId = settingsMap[outputKey];
    if (oldFileId && oldFileId !== "") {
      try {
        DriveApp.getFileById(oldFileId).setTrashed(true);
      } catch (e) {
        // Abaikan jika file sudah tidak ada
      }
    }

    // 3. Tentukan Template ID
    let templateId = '';
    let coverLogoId = settingsMap['COVER_LOGO_ID'];
    let kopSuratId = settingsMap['KOP_SURAT_ID'];

    if (tipe === 'COVER') {
      if (formData.desain === 'CUSTOM') templateId = settingsMap['TEMPLATE_ID_COVER_CUSTOM'];
      else templateId = formData.desain;
    } else if (tipe === 'SP') {
      templateId = settingsMap['TEMPLATE_ID_SP'] || getMasterDefaultId('SP');
    } else if (tipe === 'VERIFIKASI') {
      templateId = settingsMap['TEMPLATE_ID_VERIFIKASI'] || getMasterDefaultId('VERIF');
    }

    if (!templateId || templateId.trim() === "") {
       return { status: 'error', message: 'ID Template belum disetting. Silakan pilih desain atau masukkan ID di menu Pengaturan Template.' };
    }

    // 4. Proses File Template (DENGAN PENGECEKAN ID VALID)
    let templateFile;
    try {
      templateFile = DriveApp.getFileById(templateId);
    } catch (e) {
      // INI BAGIAN PENTING: Tangkap error jika ID salah
      return { 
        status: 'error_template', 
        message: 'Kode ID Template Salah / File Tidak Ditemukan',
        detail: 'Sistem gagal mengambil file Google Doc dengan ID: <b>' + templateId + '</b>. <br>Pastikan ID benar dan akses file diatur ke "Siapa saja yang memiliki link dapat melihat".'
      };
    }

    const tempDocFile = templateFile.makeCopy('TEMP_PROC_' + new Date().getTime());
    const doc = DocumentApp.openById(tempDocFile.getId());
    const body = doc.getBody();
    const safeReplace = (key, val) => body.replaceText(key, val || '-');
    const formatNipLengkap = (val) => (val && String(val).trim() !== "" && String(val).trim() !== "-") ? "NIP. " + String(val).trim() : "NIP. -";

    // Helper Replace Gambar
    const replaceWithImage = (placeholder, imageId) => {
      if (imageId && imageId.trim() !== "") {
        try {
          const imgFile = DriveApp.getFileById(imageId);
          const imgBlob = imgFile.getBlob();
          let searchResult = body.findText(placeholder);
          if (!searchResult) { const header = doc.getHeader(); if(header) searchResult = header.findText(placeholder); }
          if (searchResult) {
            const textElement = searchResult.getElement();
            const parent = textElement.getParent();
            textElement.removeFromParent();
            const img = parent.asParagraph().insertInlineImage(0, imgBlob);
            const width = img.getWidth(); const height = img.getHeight();
            if (placeholder.includes('LOGO')) {
                const MAX = 200; const scale = Math.min(MAX/width, MAX/height, 1);
                if (scale < 1) { img.setWidth(Math.round(width*scale)); img.setHeight(Math.round(height*scale)); }
            } else {
                if (width > 600) { const ratio = height/width; img.setWidth(600); img.setHeight(Math.round(600*ratio)); }
            }
          }
        } catch(err) { body.replaceText(placeholder, ''); }
      } else { body.replaceText(placeholder, ''); }
    };

    // Replace Data Umum
    safeReplace('<<Nama Sekolah>>', ds.namaSekolah);
    safeReplace('<<NSM>>', ds.nsm);
    safeReplace('<<NPSN>>', ds.npsn);
    safeReplace('<<Alamat Lengkap Sekolah>>', (ds.alamat||'') + ', ' + (ds.kelurahan||'') + ', ' + (ds.kecamatan||'') + ', ' + (ds.kabupaten||''));
    safeReplace('<<Alamat Sekolah>>', ds.alamat);
    safeReplace('<<Kecamatan>>', ds.kecamatan);
    safeReplace('<<Kabupaten>>', ds.kabupaten);
    safeReplace('<<Provinsi>>', ds.provinsi);
    safeReplace('<<Kelurahan>>', ds.kelurahan);
    safeReplace('<<Tahun Anggaran>>', ds.tahunAnggaran);
    safeReplace('<<Periode>>', ds.periodeAnggaran);
    
    // [UPDATE] Format Nama Kepala Sekolah (Untuk SP dan Cover)
    safeReplace('<<Nama Kepala Sekolah>>', formatNamaKapital(ds.namaKepala));
    safeReplace('<<NAMA KEPALA SEKOLAH>>', formatNamaKapital(ds.namaKepala));
    safeReplace('<<NIP Kepala Sekolah>>', formatNipLengkap(ds.nipKepala)); 

    if (tipe === 'COVER') {
        safeReplace('<<Header>>', formData.header);
        safeReplace('<<Judul>>', formData.judul);
        safeReplace('<<Keterangan Periode>>', formData.periode);
        replaceWithImage('<<LOGO>>', coverLogoId);
        replaceWithImage('<<KOP SURAT>>', coverLogoId);
    } else if (tipe === 'SP') {
        safeReplace('<<Nomor Surat>>', formData.nomor);
        safeReplace('<<Tempat TTD>>', formData.tempat);
        safeReplace('<<Tanggal Surat>>', formatTanggalIndo(formData.tanggal));
        replaceWithImage('<<KOP SURAT>>', kopSuratId);
    } else if (tipe === 'VERIFIKASI') {
        // [UPDATE] Format Nama Verifikator dengan helper formatNamaKapital
        safeReplace('<<Nama Verifikator 1>>', formatNamaKapital(formData.verifikator1.nama));
        safeReplace('<<NIP Verifikator 1>>', formatNipLengkap(formData.verifikator1.nip));
        
        safeReplace('<<Nama Verifikator 2>>', formatNamaKapital(formData.verifikator2.nama));
        safeReplace('<<NIP Verifikator 2>>', formatNipLengkap(formData.verifikator2.nip));
        
        safeReplace('<<Nama Pengawas>>', formatNamaKapital(formData.pengawas.nama));
        safeReplace('<<NIP Pengawas>>', formatNipLengkap(formData.pengawas.nip));

        const items = formData.rows || [];
        const tables = body.getTables();
        tables.forEach(table => {
          let rowIndexTemplate = -1;
          for (let r = 0; r < table.getNumRows(); r++) {
            if (table.getRow(r).getText().includes('<<TABLE_ROW>>')) { rowIndexTemplate = r; break; }
          }
          if (rowIndexTemplate !== -1) {
            const templateRow = table.getRow(rowIndexTemplate);
            items.forEach((itemText, index) => {
               const newRow = table.insertTableRow(rowIndexTemplate + index, templateRow.copy());
               try { newRow.getCell(0).setText((index + 1).toString()); } catch(e){} 
               try { newRow.getCell(1).setText(itemText); } catch(e){} 
               newRow.replaceText('<<TABLE_ROW>>', '');
            });
            table.removeRow(rowIndexTemplate + items.length);
          }
        });
    }

    doc.saveAndClose();

    // 5. Simpan PDF ke Folder Khusus
    const pdfBlob = tempDocFile.getAs(MimeType.PDF);
    const pdfName = tipe + '_' + ds.namaSekolah + '.pdf';
    const pdfFile = folder.createFile(pdfBlob).setName(pdfName);
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // Hapus Temp Doc
    tempDocFile.setTrashed(true);

    const newFileId = pdfFile.getId();

    // 6. Update ID File Baru ke Database
    if (rowIdxOutput !== -1) {
      sheetSet.getRange(rowIdxOutput, 2).setValue(newFileId);
    } else {
      sheetSet.appendRow([outputKey, newFileId]);
    }

    return { 
      status: 'success', 
      url: pdfFile.getUrl(),
      fileId: newFileId 
    };

  } catch (e) {
    // Tangkap error umum lainnya
    return { status: 'error', message: 'Gagal generate: ' + e.toString() };
  }
}

function getDokumenPendukungStatus(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    
    // Default Result Object (TAMBAHKAN PKS_PDF dan PKS_DOC)
    let result = {
      COVER: null, 
      SP: null, 
      VERIF: null,
      PKS_PDF: null, // <-- Tambahan Baru
      PKS_DOC: null, // <-- Tambahan Baru
      PERMOHONAN_PDF: null, 
      PERMOHONAN_DOC: null, 
      KUITANSI_PDF: null, 
      KUITANSI_DOC: null
    };

    if (sheet) {
      const data = sheet.getDataRange().getValues();
      for (let i = 0; i < data.length; i++) {
        const key = data[i][0];
        const val = data[i][1];

        // Mapping Key Database ke Result Object
        if (key === 'OUTPUT_ID_COVER') result.COVER = val;
        if (key === 'OUTPUT_ID_SP') result.SP = val;
        if (key === 'OUTPUT_ID_VERIFIKASI') result.VERIF = val;
        
        // --- TAMBAHAN LOGIKA PKS ---
        if (key === 'OUTPUT_ID_PKS_PDF') result.PKS_PDF = val;
        if (key === 'OUTPUT_ID_PKS_DOC') result.PKS_DOC = val;
        // ---------------------------

        if (key === 'OUTPUT_ID_PERMOHONAN_PDF') result.PERMOHONAN_PDF = val;
        if (key === 'OUTPUT_ID_PERMOHONAN_DOC') result.PERMOHONAN_DOC = val;
        
        if (key === 'OUTPUT_ID_KUITANSI_PDF') result.KUITANSI_PDF = val;
        if (key === 'OUTPUT_ID_KUITANSI_DOC') result.KUITANSI_DOC = val;
      }
    }
    return { status: 'success', data: result };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI AGREGATOR: AMBIL SEMUA DATA PENDUKUNG SEKALIGUS --- */
function getAllPendukungData(token) {
  try {
    // 1. Ambil Data Sekolah (Untuk Default Value)
    const resSekolah = getDataSekolah(token);
    const sekolah = (resSekolah.status === 'success') ? resSekolah.data : {};

    // 2. Ambil Setting Cover
    const resCover = getCoverSettings(token);
    const cover = (resCover.status === 'success') ? resCover.data : {};

    // 3. Ambil Opsi Desain Cover (System + Custom)
    const resDesain = getCoverTemplateList(token);
    const desain = (resDesain.status === 'success') ? resDesain : { system: [], userCustomId: '' };

    // 4. Ambil Data Surat Pengantar
    const resSP = getDataSuratPengantar(token);
    const sp = (resSP.status === 'success') ? resSP.data : {};

    // 5. Ambil Data Verifikasi
    const resVerif = getDataVerifikasi(token); // Mengembalikan {verifikator1, verifikator2, pengawas, rows}
    
    // Perbaikan format Data Verifikasi agar konsisten
    let verifData = null;
    if (resVerif.status === 'success' && resVerif.data) {
       verifData = resVerif.data;
    }

    // 6. Ambil Setting ID Template (Docs)
    const resDoc = getSettingDokumenPendukung(token);
    const docSettings = (resDoc.status === 'success') ? resDoc.data : {};

    // 7. Ambil Status File PDF (Sudah generate atau belum)
    const resStatus = getDokumenPendukungStatus(token);
    const fileStatus = (resStatus.status === 'success') ? resStatus.data : {};

    return {
      status: 'success',
      data: {
        sekolah: sekolah,
        cover: cover,
        desain: desain,
        sp: sp,
        verif: verifData,
        docSettings: docSettings,
        fileStatus: fileStatus
      }
    };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- TAMBAHKAN FUNGSI INI DI Kode.gs --- */

function hapusLogoSampul(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    
    if (!sheet) return { status: 'success', message: 'Data sudah bersih.' };

    const data = sheet.getDataRange().getValues();
    
    // Loop cari key COVER_LOGO_ID
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'COVER_LOGO_ID') {
        const fileId = data[i][1];
        
        // 1. Hapus File di Google Drive (Jika ada)
        if (fileId) {
          try { DriveApp.getFileById(fileId).setTrashed(true); } catch(e) {}
        }
        
        // 2. Hapus Baris di Spreadsheet
        sheet.deleteRow(i + 1);
        
        return { status: 'success', message: 'Logo berhasil dihapus.' };
      }
    }
    return { status: 'success', message: 'Tidak ada logo tersimpan.' };
    
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: SIMPAN DATA PKS TERMASUK TAHUN & JUMLAH --- */
function simpanDataPKS(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) {
      sheet = ss.insertSheet('DataPengaturan');
      sheet.appendRow(['KEY', 'VALUE']);
    }
    const data = sheet.getDataRange().getValues();
    
    // Helper Upsert
    const upsert = (key, val) => {
      let found = false;
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === key) {
          sheet.getRange(i + 1, 2).setValue(val);
          found = true;
          break;
        }
      }
      if (!found) sheet.appendRow([key, val]);
    };

    // Simpan Data Utama
    upsert('PKS_NAMA_SINGKAT', form.namaSingkat);
    upsert('PKS_NOMOR_PKS', form.nomorPks);
    upsert('PKS_NOMOR_SURAT', form.nomorSurat);
    upsert('PKS_TANGGAL', form.tanggalPks); 
    upsert('PKS_NO_REK', "'" + form.noRek);
    upsert('PKS_NAMA_REK', form.namaRek);
    
    // Override Fields
    upsert('PKS_OVERRIDE_NAMA', form.namaLengkap);
    upsert('PKS_OVERRIDE_BOS', form.danaBos);
    upsert('PKS_OVERRIDE_ALAMAT', form.alamat);
    
    // [PENTING] SIMPAN TAHUN & JUMLAH KE DATABASE
    upsert('PKS_TAHUN', form.tahun);
    upsert('PKS_JUMLAH', form.jumlah);

    return { status: 'success', message: 'Data PKS berhasil disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- UPDATE: AMBIL DATA PKS (TAMBAHAN TAHUN & JUMLAH) --- */
function getDataPKS(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    
    // Inisialisasi object result
    let res = { 
      namaSingkat: '', nomorPks: '', nomorSurat: '', tanggalPks: '', 
      noRek: '', namaRek: '', 
      namaLengkap: '', danaBos: '', alamat: '', 
      tahun: '', jumlah: '', // [BARU]
      pdfId: null, docId: null 
    };

    if (sheet) {
      const data = sheet.getDataRange().getValues();
      for (let i = 0; i < data.length; i++) {
        const key = data[i][0];
        const val = data[i][1];

        if (key === 'PKS_NAMA_SINGKAT') res.namaSingkat = val;
        if (key === 'PKS_NOMOR_PKS') res.nomorPks = val;
        if (key === 'PKS_NOMOR_SURAT') res.nomorSurat = val;
        if (key === 'PKS_TANGGAL' && val) {
          try { res.tanggalPks = Utilities.formatDate(new Date(val), "GMT+7", "yyyy-MM-dd"); } catch(e) { res.tanggalPks = ""; }
        }
        if (key === 'PKS_NO_REK') res.noRek = String(val);
        if (key === 'PKS_NAMA_REK') res.namaRek = val;
        
        if (key === 'PKS_OVERRIDE_NAMA') res.namaLengkap = val;
        if (key === 'PKS_OVERRIDE_BOS') res.danaBos = val;
        if (key === 'PKS_OVERRIDE_ALAMAT') res.alamat = val;

        // [BARU] Ambil Tahun & Jumlah
        if (key === 'PKS_TAHUN') res.tahun = val;
        if (key === 'PKS_JUMLAH') res.jumlah = val;

        if (key === 'OUTPUT_ID_PKS_PDF') res.pdfId = val;
        if (key === 'OUTPUT_ID_PKS_DOC') res.docId = val;
      }
    }
    return { status: 'success', data: res };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- HELPER FORMAT TEXT BARU --- */
function toTitleCase(str) {
  if (!str) return "";
  return str.replace(/\w\S*/g, function(txt) {
    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
  });
}

/* --- UPDATE: GENERATE BERKAS DENGAN DATA DARI PKS --- */
function generateBerkasPencairan(token, tipe, formData) {
  try {
    // 1. Validasi Token
    if (!token) throw new Error("Token tidak valid.");
    
    // 2. Buka Spreadsheet & Data Sekolah
    const ss = SpreadsheetApp.openById(token);
    
    // Ambil Data Sekolah (ds) sebagai fallback
    let ds = {};
    const sheetSekolah = ss.getSheetByName('DataSekolah');
    if (sheetSekolah && sheetSekolah.getLastRow() >= 2) {
      const d = sheetSekolah.getRange(2, 1, 1, 19).getValues()[0];
      ds = {
        namaSekolah: d[0], danaBOS: d[15], jumlahAnggaran: d[16], tahunAnggaran: d[17],
        namaKepala: d[9], nipKepala: String(d[10]).replace(/'/g,''), 
        tempatTTD: d[8]
      };
    }

    // [KUNCI] PRIORITASKAN DATA DARI FORM (PKS) DIBANDING DATA SEKOLAH
    // Jika formData.tahun/jumlah dikirim dari client (hasil input PKS), gunakan itu.
    let tahunFinal = (formData.tahun && formData.tahun !== "") ? formData.tahun : (ds.tahunAnggaran || "");
    let jumlahRaw  = (formData.jumlah !== undefined && formData.jumlah !== "") ? formData.jumlah : (ds.jumlahAnggaran || 0);
    
    const jumlahFmt = formatRupiah(jumlahRaw);
    const terbilangFmt = terbilang(jumlahRaw) + ' Rupiah';

    // 3. Siapkan Folder Output & Pengaturan
    const folderId = ensureFolderPendukung(token);
    const folder = DriveApp.getFolderById(folderId);
    
    let sheetSet = ss.getSheetByName('DataPengaturan');
    if (!sheetSet) { sheetSet = ss.insertSheet('DataPengaturan'); sheetSet.appendRow(['KEY', 'VALUE']); }
    
    const updateOutputId = (key, newId) => {
      const data = sheetSet.getDataRange().getValues();
      let rowIdx = -1; let oldId = null;
      for(let i=0; i<data.length; i++){
        if(data[i][0] === key) { rowIdx = i+1; oldId = data[i][1]; break; }
      }
      if(oldId && oldId !== "") { try { DriveApp.getFileById(oldId).setTrashed(true); } catch(e){} }
      if(rowIdx !== -1) { sheetSet.getRange(rowIdx, 2).setValue(newId); } 
      else { sheetSet.appendRow([key, newId]); }
    };

    // 4. Ambil Template ID
    let templateId = getMasterDefaultId(tipe); 
    if (!templateId) return { status: 'error', message: 'ID Template ' + tipe + ' belum disetting.' };

    // 5. Proses Template
    let templateFile;
    try { templateFile = DriveApp.getFileById(templateId); } 
    catch(e) { return { status: 'error', message: 'File Template Master tidak ditemukan.' }; }
    
    const tempDocFile = templateFile.makeCopy(tipe + '_' + ds.namaSekolah + '_' + new Date().getTime());
    const doc = DocumentApp.openById(tempDocFile.getId());
    const body = doc.getBody();
    const safeReplace = (key, val) => body.replaceText(key, val || '-');

    // --- REPLACE UMUM (MENGGUNAKAN DATA UPDATE PKS) ---
    safeReplace('<<Tahun Anggaran>>', tahunFinal);       // Menggunakan Tahun PKS
    safeReplace('<<Jumlah Dana>>', jumlahFmt);           // Menggunakan Jumlah PKS
    safeReplace('<<Jumlah Dana Terbilang>>', terbilangFmt); 
    safeReplace('<<Total>>', jumlahFmt);
    safeReplace('<<Total Terbilang>>', terbilangFmt);

    // --- REPLACE SPESIFIK TIPE ---
    if (tipe === 'PKS') {
      const namaSekolahRaw = formData.namaLengkap || "";
      safeReplace('<<Nama Sekolah Lengkap.B>>', namaSekolahRaw.toUpperCase());
      safeReplace('<<Nama Sekolah Lengkap.K>>', toTitleCase(namaSekolahRaw));
      safeReplace('<<Nama Sekolah Lengkap>>', namaSekolahRaw);
      
      const namaKamadRaw = ds.namaKepala || "";
      safeReplace('<<Nama Kamad.B>>', formatNamaKapital(namaKamadRaw));
      safeReplace('<<Nama Kamad>>', formatNamaKapital(namaKamadRaw));
      safeReplace('<<Nama Kamad.K>>', formatNamaTitleCase(namaKamadRaw));
      
      safeReplace('<<Nama Sekolah Singkat>>', formData.namaSingkat);
      safeReplace('<<Nama Dana BOS>>', formData.danaBos || formData.danaBOS);
      safeReplace('<<Alamat Lengkap Madrasah>>', formData.alamat);
      safeReplace('<<Nomor PKS>>', formData.nomorPks);
      safeReplace('<<Nomor Surat Madrasah>>', formData.nomorSurat);
      
      // Tanggal PKS
      const tglInput = formData.tanggalPks;
      if (tglInput) {
        const d = new Date(tglInput);
        const hariArr = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const dayOfWeek = parseInt(Utilities.formatDate(d, "GMT+7", "u"));
        const namaHari = (dayOfWeek === 7) ? "Minggu" : hariArr[dayOfWeek];
        const tglTeks = terbilang(parseInt(Utilities.formatDate(d, "GMT+7", "d")));
        const blnTeks = terbilang(parseInt(Utilities.formatDate(d, "GMT+7", "M")));
        const thnTeks = terbilang(parseInt(Utilities.formatDate(d, "GMT+7", "yyyy")));
        
        safeReplace('<<Hari PKS>>', namaHari);
        safeReplace('<<Tanggal PKS>>', toTitleCase(tglTeks));
        safeReplace('<<Bulan PKS>>', toTitleCase(blnTeks));
        safeReplace('<<Tahun PKS>>', toTitleCase(thnTeks));
        safeReplace('<<Tanggal PKS Lengkap>>', formatTanggalIndo(tglInput));
      } else {
        safeReplace('<<Hari PKS>>', '................');
        safeReplace('<<Tanggal PKS>>', '................');
        safeReplace('<<Bulan PKS>>', '................');
        safeReplace('<<Tahun PKS>>', '................');
      }
      safeReplace('<<Nomor Rekening>>', formData.noRek);
      safeReplace('<<Nama Rekening>>', formData.namaRek);

    } else if (tipe === 'PERMOHONAN') {
      simpanDataPermohonan(token, { nomorSurat: formData.nomorSurat, tempat: formData.tempat, tanggal: formData.tanggal });
      
      safeReplace('<<Nomor PKS>>', formData.nomorPks);
      safeReplace('<<Nama Sekolah Lengkap.K>>', toTitleCase(formData.namaSekolah || ds.namaSekolah));
      safeReplace('<<Nama Kamad.B>>', formatNamaKapital(ds.namaKepala));
      safeReplace('<<Nama Dana BOS>>', formData.danaBos || ds.danaBOS);
      
      safeReplace('<<Nomor Surat Permohonan>>', formData.nomorSurat);
      safeReplace('<<Tempat TTD>>', formData.tempat);
      safeReplace('<<Tanggal TTD>>', formatTanggalIndo(formData.tanggal));
      processKopSurat(doc, body, ss);

    } else if (tipe === 'KUITANSI') {
      simpanDataKuitansi(token, { nomorSurat: formData.nomorSurat, tempat: formData.tempat, tanggal: formData.tanggal });
      
      safeReplace('<<Nomor PKS>>', formData.nomorPks);
      safeReplace('<<Tanggal PKS>>', formatTanggalIndo(formData.tanggalPks));
      safeReplace('<<Nama Kamad.B>>', formatNamaKapital(ds.namaKepala));
      
      safeReplace('<<Nomor Surat Kuitansi>>', formData.nomorSurat);
      safeReplace('<<Tempat TTD>>', formData.tempat);
      safeReplace('<<Tanggal TTD>>', formatTanggalIndo(formData.tanggal));
      safeReplace('<<Untuk Pembayaran>>', "Pencairan Dana BOS Tahun " + tahunFinal);
      processKopSurat(doc, body, ss);
    }

    doc.saveAndClose();

    // 6. Convert & Save
    const pdfBlob = tempDocFile.getAs(MimeType.PDF);
    const fileNameBase = tipe + '_' + ds.namaSekolah;
    const pdfFile = folder.createFile(pdfBlob).setName(fileNameBase + '.pdf');
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const docFile = DriveApp.getFileById(tempDocFile.getId());
    docFile.setName(fileNameBase + ' (Master).docx');
    docFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    try { folder.addFile(docFile); DriveApp.getRootFolder().removeFile(docFile); } catch(e) {}

    updateOutputId('OUTPUT_ID_' + tipe + '_PDF', pdfFile.getId());
    updateOutputId('OUTPUT_ID_' + tipe + '_DOC', docFile.getId());

    return { status: 'success', url: pdfFile.getUrl(), pdfId: pdfFile.getId(), docId: docFile.getId() };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- HELPER LOKAL UNTUK INSERT KOP SURAT --- */
// Fungsi ini diekstrak agar tidak duplikat kode di Permohonan dan Kuitansi
function processKopSurat(doc, body, ss) {
  try {
    const sheetSet = ss.getSheetByName('DataPengaturan');
    const dataSet = sheetSet.getDataRange().getValues();
    let kopSuratId = null;
    for (let i = 0; i < dataSet.length; i++) {
      if (dataSet[i][0] === 'KOP_SURAT_ID') { kopSuratId = dataSet[i][1]; break; }
    }
    
    if (kopSuratId) {
        const kopFile = DriveApp.getFileById(kopSuratId);
        const kopBlob = kopFile.getBlob();
        
        const replaceInContainer = (container) => {
          if(!container) return;
          let searchResult = container.findText('<<KOP SURAT>>');
          let safety = 0;
          while (searchResult && safety < 5) {
             safety++;
             const textEl = searchResult.getElement();
             const parent = textEl.getParent();
             try {
               textEl.removeFromParent();
               const img = parent.asParagraph().insertInlineImage(0, kopBlob);
               if (img.getWidth() > 600) {
                   const ratio = img.getHeight() / img.getWidth();
                   img.setWidth(600); img.setHeight(600 * ratio);
               }
             } catch(err) {}
             searchResult = container.findText('<<KOP SURAT>>');
          }
        };

        // Cek Header
        replaceInContainer(doc.getHeader());
        // Cek Body
        replaceInContainer(body);

    } else {
        // Hapus placeholder jika tidak ada gambar
        if(doc.getHeader()) doc.getHeader().replaceText('<<KOP SURAT>>', '');
        body.replaceText('<<KOP SURAT>>', '');
    }
  } catch(e) { 
     // Error handling (Hapus placeholder jika gagal load gambar)
     if(doc.getHeader()) doc.getHeader().replaceText('<<KOP SURAT>>', '');
     body.replaceText('<<KOP SURAT>>', ''); 
  }
}

/* --- FUNGSI BARU: SIMPAN & AMBIL DATA PERMOHONAN --- */
function simpanDataPermohonan(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    let keyMap = new Map();
    for (let i = 0; i < data.length; i++) {
      keyMap.set(data[i][0], i + 1); 
    }

    const setVal = (key, val) => {
      const valStr = (val === null || val === undefined) ? "" : String(val);
      if (keyMap.has(key)) {
        sheet.getRange(keyMap.get(key), 2).setValue(valStr);
      } else {
        sheet.appendRow([key, valStr]);
        keyMap.set(key, sheet.getLastRow()); 
      }
    };

    setVal('PM_NOMOR_SURAT', form.nomorSurat);
    setVal('PM_TEMPAT', form.tempat);
    setVal('PM_TANGGAL', form.tanggal); // Format YYYY-MM-DD

    return { status: 'success', message: 'Data Permohonan berhasil disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

function getDataPermohonan(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    
    let res = { nomorSurat: '', tempat: '', tanggal: '' };

    if (sheet) {
      const data = sheet.getDataRange().getValues();
      for (let i = 0; i < data.length; i++) {
        const key = data[i][0];
        const val = data[i][1];
        
        if (key === 'PM_NOMOR_SURAT') res.nomorSurat = val;
        if (key === 'PM_TEMPAT') res.tempat = val;
        if (key === 'PM_TANGGAL') {
           if (val) {
             try { res.tanggal = Utilities.formatDate(new Date(val), "GMT+7", "yyyy-MM-dd"); }
             catch(e) { res.tanggal = ""; }
           }
        }
      }
    }
    return { status: 'success', data: res };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI BARU: SIMPAN & AMBIL DATA KUITANSI --- */
function simpanDataKuitansi(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) { sheet = ss.insertSheet('DataPengaturan'); sheet.appendRow(['KEY', 'VALUE']); }

    const data = sheet.getDataRange().getValues();
    let keyMap = new Map();
    for (let i = 0; i < data.length; i++) {
      keyMap.set(data[i][0], i + 1); 
    }

    const setVal = (key, val) => {
      const valStr = (val === null || val === undefined) ? "" : String(val);
      if (keyMap.has(key)) {
        sheet.getRange(keyMap.get(key), 2).setValue(valStr);
      } else {
        sheet.appendRow([key, valStr]);
        keyMap.set(key, sheet.getLastRow()); 
      }
    };

    setVal('KW_NOMOR_SURAT', form.nomorSurat);
    setVal('KW_TEMPAT', form.tempat);
    setVal('KW_TANGGAL', form.tanggal);

    return { status: 'success', message: 'Data Kuitansi berhasil disimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

function getDataKuitansi(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    
    let res = { nomorSurat: '', tempat: '', tanggal: '' };

    if (sheet) {
      const data = sheet.getDataRange().getValues();
      for (let i = 0; i < data.length; i++) {
        const key = data[i][0];
        const val = data[i][1];
        
        if (key === 'KW_NOMOR_SURAT') res.nomorSurat = val;
        if (key === 'KW_TEMPAT') res.tempat = val;
        if (key === 'KW_TANGGAL') {
           if (val) {
             try { res.tanggal = Utilities.formatDate(new Date(val), "GMT+7", "yyyy-MM-dd"); }
             catch(e) { res.tanggal = ""; }
           }
        }
      }
    }
    return { status: 'success', data: res };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/**
 * UPDATE: getAllPencairanData
 * Menambahkan data SPTJM ke dalam objek respon agar tersinkron sekaligus.
 */
function getAllPencairanData(token) {
  try {
    // 1. Ambil Data Sekolah (Untuk Default)
    const resSekolah = getDataSekolah(token);
    const sekolah = (resSekolah.status === 'success') ? resSekolah.data : {};
    
    // 2. Ambil Data PKS
    const resPks = getDataPKS(token);
    const pks = (resPks.status === 'success') ? resPks.data : {};
    
    // 3. Ambil Data Permohonan
    const resPm = getDataPermohonan(token);
    const permohonan = (resPm.status === 'success') ? resPm.data : {};
    
    // 4. Ambil Data Kuitansi
    const resKw = getDataKuitansi(token);
    const kuitansi = (resKw.status === 'success') ? resKw.data : {};
    
    // 5. [BARU] Ambil Data SPTJM
    const resSptjm = getDataSptjm(token);
    const sptjm = (resSptjm.status === 'success') ? resSptjm.data : {};

    // 6. Ambil Status File
    const resStatus = getDokumenPendukungStatus(token);
    const fileStatus = (resStatus.status === 'success') ? resStatus.data : {};

    return {
      status: 'success',
      data: {
        sekolah: sekolah,
        pks: pks,
        permohonan: permohonan,
        kuitansi: kuitansi,
        sptjm: sptjm, // <-- Data SPTJM masuk disini
        fileStatus: fileStatus
      }
    };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- HELPER BARU: FORMAT NAMA TITLE CASE (DEPAN BESAR) + GELAR BAKU --- */
function formatNamaTitleCase(rawName) {
  if (!rawName || rawName === '-' || rawName === '') return "-";
  
  const str = String(rawName).trim();
  const firstCommaIndex = str.indexOf(',');

  // --- KAMUS GELAR (Sama dengan formatNamaKapital) ---
  const mapGelar = {
      "se": "S.E.", "spd": "S.Pd.", "spdi": "S.Pd.I.", "sag": "S.Ag.",
      "sh": "S.H.", "st": "S.T.", "skom": "S.Kom.", "ssos": "S.Sos.",
      "sip": "S.I.P.", "skm": "S.K.M.", "skep": "S.Kep.", "sfarm": "S.Farm.",
      "spsi": "S.Psi.", "ss": "S.S.", "ssn": "S.Sn.", "strt": "S.Tr.T.",
      "mpd": "M.Pd.", "mpdi": "M.Pd.I.", "mm": "M.M.", "msi": "M.Si.",
      "mag": "M.Ag.", "mh": "M.H.", "mkom": "M.Kom.", "mt": "M.T.",
      "amd": "A.Md.", "drs": "Drs.", "dra": "Dra.", "dr": "Dr.", 
      "lc": "Lc.", "ma": "M.A.", "mhum": "M.Hum."
  };

  if (firstCommaIndex !== -1) {
    // 1. Bagian Nama: Format Title Case (Awal Kata Besar)
    const namaDepanRaw = str.substring(0, firstCommaIndex);
    const namaDepan = toTitleCase(namaDepanRaw); 
    
    // 2. Bagian Gelar: Format Baku
    let gelarRaw = str.substring(firstCommaIndex + 1).trim();
    const cleanKey = gelarRaw.toLowerCase().replace(/[^a-z]/g, '');
    let gelarJadi = "";

    if (mapGelar[cleanKey]) {
        gelarJadi = mapGelar[cleanKey];
    } else {
        // Fallback: Split per titik/spasi dan Title Case per bagian
        while(gelarRaw.endsWith('.')) gelarRaw = gelarRaw.slice(0, -1);
        let parts = gelarRaw.includes('.') ? gelarRaw.split('.') : gelarRaw.split(' ');
        
        gelarJadi = parts.map(p => {
            const c = p.trim();
            if(!c) return "";
            if (c === c.toUpperCase() && c.length > 1) return c; // Biarkan singkatan pendek (cth: MBA)
            return c.charAt(0).toUpperCase() + c.slice(1).toLowerCase();
        }).join('.');
        if (!gelarJadi.endsWith('.')) gelarJadi += '.';
    }
    
    return namaDepan + ', ' + gelarJadi;

  } else {
    // Tidak ada gelar -> Format Title Case biasa
    return toTitleCase(str);
  }
}

/* --- FITUR SPTJM (BARU) --- */

// A. SIMPAN DATA (Tambah key SPTJM_NIK)
function simpanDataSptjm(token, form) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheet = ss.getSheetByName('DataPengaturan');
    if (!sheet) {
      sheet = ss.insertSheet('DataPengaturan');
      sheet.appendRow(['KEY', 'VALUE']);
    }
    const data = sheet.getDataRange().getValues();
    
    // Helper Upsert
    const keyMap = new Map();
    for (let i = 0; i < data.length; i++) keyMap.set(data[i][0], i + 1);

    const setVal = (key, val) => {
      const valStr = (val === null || val === undefined) ? "" : String(val);
      if (keyMap.has(key)) sheet.getRange(keyMap.get(key), 2).setValue(valStr);
      else { sheet.appendRow([key, valStr]); keyMap.set(key, sheet.getLastRow()); }
    };

    setVal('SPTJM_NIK', form.nik); // <--- SIMPAN NIK
    setVal('SPTJM_TEMPAT', form.tempat);
    setVal('SPTJM_TANGGAL', form.tanggal);

    return { status: 'success', message: 'Data SPTJM tersimpan!' };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/**
 * UPDATE: getDataSptjm
 * Pastikan fungsi ini membaca NIK, Tempat, Tanggal, serta ID File.
 */
function getDataSptjm(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    const sheet = ss.getSheetByName('DataPengaturan');
    let res = { nik: '', tempat: '', tanggal: '', pdfId: '', docId: '' };
    
    if (sheet) {
      const data = sheet.getDataRange().getValues();
      data.forEach(row => {
        if (row[0] === 'SPTJM_NIK') res.nik = row[1];
        if (row[0] === 'SPTJM_TEMPAT') res.tempat = row[1];
        // Konversi tanggal jika ada
        if (row[0] === 'SPTJM_TANGGAL' && row[1]) {
           try { res.tanggal = Utilities.formatDate(new Date(row[1]), "GMT+7", "yyyy-MM-dd"); } 
           catch(e) { res.tanggal = ""; }
        }
        if (row[0] === 'SPTJM_PDF') res.pdfId = row[1];
        if (row[0] === 'SPTJM_DOC') res.docId = row[1];
      });
    }
    return { status: 'success', data: res };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/**
 * FUNGSI GENERATE SPTJM (PERBAIKAN: FORMAT NAMA & SUMBER DATA PKS)
 */
function generateSptjm(token, formData) {
  try {
    // 1. AKSES MASTER DB UNTUK CARI TEMPLATE ID
    const ssMaster = SpreadsheetApp.openById(CONFIG.MASTER_DB_ID); 
    const sheetCetak = ssMaster.getSheetByName('Cetak_Lainnya');
    
    if (!sheetCetak) {
      throw new Error("Sheet 'Cetak_Lainnya' tidak ditemukan di Database Master.");
    }
    
    let TEMPLATE_ID = '';
    const dataCetak = sheetCetak.getDataRange().getValues();
    
    // Loop baris Master DB untuk mencari "SPTJM"
    for (let i = 0; i < dataCetak.length; i++) {
      const namaDesain = String(dataCetak[i][1]).trim().toUpperCase(); 
      if (namaDesain === 'SPTJM') { 
        TEMPLATE_ID = dataCetak[i][2];
        break;
      }
    }
    
    if (!TEMPLATE_ID) {
      throw new Error("Template SPTJM belum disetting di Database Master.");
    }

    // 2. AKSES DATABASE SEKOLAH & PENGATURAN (PKS)
    const ss = SpreadsheetApp.openById(token);
    const sheetSet = ss.getSheetByName('DataPengaturan');
    
    // --- [PERBAIKAN UTAMA 2] AMBIL DATA PKS DARI DB (Agar Sinkron dengan Input PKS) ---
    let pksNama = "";
    let pksAlamat = "";
    let pksTahun = ""; // [BARU] Variabel untuk Tahun dari DB PKS
    let oldPdfId = null;
    let oldDocId = null;

    if (sheetSet) {
      const dataSet = sheetSet.getDataRange().getValues();
      for (let i = 0; i < dataSet.length; i++) {
        const key = dataSet[i][0];
        const val = dataSet[i][1];
        
        // Ambil Data PKS Tersimpan
        if (key === 'PKS_OVERRIDE_NAMA') pksNama = val;
        if (key === 'PKS_OVERRIDE_ALAMAT') pksAlamat = val;
        if (key === 'PKS_TAHUN') pksTahun = val; // [BARU] Ambil Tahun tersimpan
        
        // Cek File Lama
        if (key === 'OUTPUT_ID_SPTJM_PDF') oldPdfId = val;
        if (key === 'OUTPUT_ID_SPTJM_DOC') oldDocId = val;
      }
    }

    // Hapus File Lama
    if (oldPdfId && oldPdfId !== "") { try { DriveApp.getFileById(oldPdfId).setTrashed(true); } catch(e) {} }
    if (oldDocId && oldDocId !== "") { try { DriveApp.getFileById(oldDocId).setTrashed(true); } catch(e) {} }
    
    // Ambil Data Sekolah (sebagai fallback)
    let ds = {};
    const sheetSekolah = ss.getSheetByName('DataSekolah');
    if (sheetSekolah && sheetSekolah.getLastRow() >= 2) {
      const d = sheetSekolah.getRange(2, 1, 1, 19).getValues()[0];
      ds = {
        namaSekolah: d[0],       
        alamat: d[3],            
        kelurahan: d[7],         
        kecamatan: d[6],         
        kabupaten: d[5],         
        provinsi: d[4],          
        namaKepala: d[9],        
        tahunAnggaran: d[17]     
      };
    }

    // --- LOGIKA DATA SUMBER FINAL ---
    // Prioritas: Database PKS (pksNama) > Form Input (formData) > Data Sekolah (ds)
    
    const finalNamaSekolah = pksNama || formData.namaSekolah || ds.namaSekolah;
    
    let finalAlamat = pksAlamat || formData.alamat; 
    if (!finalAlamat) {
        finalAlamat = (ds.alamat || "") + ", " + (ds.kelurahan || "") + ", " + (ds.kecamatan || "") + ", " + (ds.kabupaten || "");
    }

    // [BARU] Logika Prioritas Tahun Anggaran (Form > DB PKS > Data Sekolah)
    const finalTahun = formData.tahun || pksTahun || ds.tahunAnggaran;

    // 3. PROSES GENERATE FILE BARU
    const folderId = ensureFolderPendukung(token); 
    const folder = DriveApp.getFolderById(folderId);
    
    const docFileMaster = DriveApp.getFileById(TEMPLATE_ID);
    const tempFile = docFileMaster.makeCopy('SPTJM_' + finalNamaSekolah + '_' + new Date().getTime());
    const doc = DocumentApp.openById(tempFile.getId());
    const body = doc.getBody();
    
    const safeReplace = (key, val) => body.replaceText(key, val || '-');

    // 4. REPLACE DATA PLACEHOLDER
    
    // --- [PERBAIKAN UTAMA 1] FORMAT NAMA KAMAD (Nama Saja, Gelar Baku) ---
    // .B = Nama UPPERCASE, Gelar Baku (Contoh: BUDI SANTOSO, S.Pd.)
    safeReplace('<<Nama Kamad.B>>', formatNamaKapital(ds.namaKepala));

    // .K = Nama Title Case, Gelar Baku (Contoh: Budi Santoso, S.Pd.)
    safeReplace('<<Nama Kamad.K>>', formatNamaTitleCase(ds.namaKepala));
    
    // ---------------------------------------------------------------------

    // Data Sekolah & Alamat (Menggunakan Data PKS)
    safeReplace('<<Nama Sekolah Lengkap.K>>', finalNamaSekolah); // Isi apa adanya dari PKS
    safeReplace('<<Alamat Lengkap Madrasah>>', finalAlamat);     // Isi apa adanya dari PKS
    safeReplace('<<Alamat Sekolah>>', finalAlamat); 

    // Data Lain
    // [UPDATE] Menggunakan finalTahun (Sesuai inputan PKS)
    safeReplace('<<Tahun Anggaran>>', finalTahun);
    
    safeReplace('<<NIK>>', formData.nik); 
    safeReplace('<<Tempat TTD>>', formData.tempat);
    safeReplace('<<Tanggal TTD>>', formatTanggalIndo(formData.tanggal));

    // Kop Surat
    processKopSurat(doc, body, ss); 

    doc.saveAndClose();

    // 5. FINISHING & SAVE
    const pdfBlob = tempFile.getAs(MimeType.PDF);
    const pdfFile = folder.createFile(pdfBlob).setName('SPTJM - ' + finalNamaSekolah + '.pdf');
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const finalDocFile = DriveApp.getFileById(tempFile.getId());
    finalDocFile.setName('SPTJM - ' + finalNamaSekolah + ' (Master).docx');
    
    try { 
      folder.addFile(finalDocFile); 
      DriveApp.getRootFolder().removeFile(finalDocFile); 
    } catch(e) {}

    // 6. SIMPAN LOG
    simpanOutputId(ss, 'OUTPUT_ID_SPTJM_PDF', pdfFile.getId());
    simpanOutputId(ss, 'OUTPUT_ID_SPTJM_DOC', finalDocFile.getId());
    simpanOutputId(ss, 'SPTJM_NIK', formData.nik);

    return { 
      status: 'success', 
      url: pdfFile.getUrl(), 
      pdfId: pdfFile.getId(), 
      docId: finalDocFile.getId() 
    };

  } catch (e) {
    return { status: 'error', message: 'Gagal Generate SPTJM: ' + e.toString() };
  }
}

// --- HELPER KECIL (JIKA BELUM ADA DI KODE.GS ANDA) ---
// Jika fungsi ini belum ada, silakan sertakan juga di bawah kode tadi.

function simpanOutputId(ss, key, val) {
  let sheet = ss.getSheetByName('DataPengaturan');
  if (!sheet) {
    sheet = ss.insertSheet('DataPengaturan');
    sheet.appendRow(['KEY', 'VALUE']);
  }
  
  const data = sheet.getDataRange().getValues();
  let found = false;
  
  // Cari apakah Key sudah ada
  for(let i=0; i<data.length; i++) {
    if(data[i][0] === key) {
      sheet.getRange(i+1, 2).setValue(val);
      found = true; 
      break;
    }
  }
  
  // Jika belum ada, buat baris baru
  if(!found) sheet.appendRow([key, val]);
}

/* --- FUNGSI IMPORT DATA (BATCH) --- */
function importDataBatch(token, type, data) {
  try {
    const ss = SpreadsheetApp.openById(token);
    let sheetName = '';
    let mapFunc = null;

    // Tentukan Target Sheet & Mapping Data
    if (type === 'URAIAN') {
      sheetName = 'DataUraian';
      mapFunc = (row) => {
        const id = Utilities.getUuid();
        // Pastikan nama kolom di Excel sesuai dengan key di row
        // Key JSON dari SheetJS biasanya sesuai header Excel
        return [id, "'" + (row['Nomor Bukti'] || ''), row['Uraian Pekerjaan'] || ''];
      };
    } 
    else if (type === 'TOKO') {
      sheetName = 'DataToko';
      mapFunc = (row) => {
        return [
          Utilities.getUuid(),
          row['Nama Toko'] || '',
          row['Jenis Toko'] || '',
          row['Alamat Lengkap'] || '',
          "'" + (row['No Telp'] || ''), // Pakai kutip biar jadi teks
          row['Nama Pemilik'] || '',
          row['Tempat TTD'] || ''
        ];
      };
    }
    else if (type === 'TUKANG') {
      sheetName = 'DataTukang';
      mapFunc = (row) => {
        return [
          Utilities.getUuid(),
          row['Nama Tukang'] || '',
          row['Alamat Lengkap'] || ''
        ];
      };
    }
    else if (type === 'GURU') {
      sheetName = 'DataGuru';
      mapFunc = (row) => {
        return [
          Utilities.getUuid(),
          row['Nama Lengkap'] || '',
          "'" + (row['NIP'] || '')
        ];
      };
    }
    else if (type === 'TRANSAKSI') {
      sheetName = 'DataTransaksi';
      
      // Pastikan kolom database lengkap (Data_Surat_JSON, dll)
      // Kita panggil ensureColumn helper jika ada, atau pastikan header lewat 'perbaikiSemuaHeader'
      // Untuk amannya, kita asumsikan struktur sudah benar atau akan dihandle oleh array panjang
      
      mapFunc = (row) => {
        const id = Utilities.getUuid();
        
        // Item Belanja
        const items = [{
          nama: row['Nama Barang'] || '',
          vol: row['Volume'] || 0,
          sat: row['Satuan'] || '',
          harga: row['Harga Satuan'] || 0,
          jumlah: (row['Volume'] || 0) * (row['Harga Satuan'] || 0)
        }];
        const total = items[0].jumlah;

        // Data Surat (Construct JSON)
        const dataSurat = {
          permintaan: row['Nomor Surat Permintaan'] || '',
          penawaran: row['Nomor Surat Penawaran'] || '',
          baPemeriksaan: row['Nomor BA Pemeriksaan'] || '',
          baSerahTerima: row['Nomor BA Serah Terima'] || '',
          baPembayaran: row['Nomor BA Pembayaran'] || ''
        };

        // Data Tanggal (Construct JSON)
        // Pastikan format di Excel YYYY-MM-DD
        const dataTanggal = {
          permintaan: row['Tanggal Surat Permintaan'] || '',
          penawaran: row['Tanggal Surat Penawaran'] || '',
          baPemeriksaan: row['Tanggal BA Pemeriksaan'] || '',
          baSerahTerima: row['Tanggal BA Serah Terima'] || '',
          baPembayaran: row['Tanggal BA Pembayaran'] || ''
        };

        // Return Array sesuai urutan kolom DB (Lihat DB_SCHEMA)
        // Urutan: ID, Tanggal, Tipe, Uraian, Pihak, Pemesan, Items, Total, Waktu, Surat_JSON, Tgl_JSON, PDF_ID
        return [
          id,
          "'" + (row['Tanggal (YYYY-MM-DD)'] || ''),
          row['Tipe (TOKO/TUKANG/GURU)'] || 'TOKO',
          row['Uraian Pekerjaan'] || '',
          row['Pihak Ketiga'] || '',
          row['Pemesan'] || '',
          JSON.stringify(items),
          total,
          new Date(),
          JSON.stringify(dataSurat),   // Kolom 10
          JSON.stringify(dataTanggal), // Kolom 11
          ""                           // Kolom 12 (PDF ID Kosong)
        ];
      };
    }

    if (!sheetName) return { status: 'error', message: 'Tipe import tidak dikenali.' };

    let sheet = ss.getSheetByName(sheetName);
    // Buat sheet jika belum ada (Basic Columns)
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      // Header akan otomatis tertambah saat data masuk di bawahnya, 
      // tapi idealnya sheet sudah ada dari fungsi lain.
    }

    // Proses Data menjadi Array
    const rowsToAdd = data.map(mapFunc);

    if (rowsToAdd.length > 0) {
      // Tulis sekaligus (Batch Write) agar cepat
      const lastRow = sheet.getLastRow();
      sheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    }

    return { 
      status: 'success', 
      message: 'Data berhasil diimport ke Database.',
      count: rowsToAdd.length
    };

  } catch (e) {
    return { status: 'error', message: 'Gagal Import: ' + e.toString() };
  }
}

/* --- TAMBAHAN: FUNGSI KHUSUS DATA TEMPLATE EXCEL --- */
function getTemplateRefData(token) {
  try {
    const ss = SpreadsheetApp.openById(token);
    
    // 1. Helper untuk ambil data kolom tertentu
    const getList = (sheetName, colIndex) => {
      const sheet = ss.getSheetByName(sheetName);
      if (!sheet || sheet.getLastRow() < 2) return [];
      // Ambil range dari baris 2 sampai akhir
      const vals = sheet.getRange(2, colIndex, sheet.getLastRow() - 1, 1).getValues();
      // Filter yang kosong & unik
      return [...new Set(vals.flat().filter(String).map(s => String(s).trim()))];
    };

    // 2. Ambil Data
    return {
      status: 'success',
      data: {
        uraian: getList('DataUraian', 3), // Kolom C (Uraian)
        toko:   getList('DataToko', 2),   // Kolom B (Nama Toko)
        tukang: getList('DataTukang', 2), // [BARU] Ambil Data Tukang (Kolom B/2)
        guru:   getList('DataGuru', 2),   // Kolom B (Nama Guru)
        barang: getList('Data Barang', 1),// Kolom A (Nama Barang)
        satuan: getList('Satuan', 1)      // Kolom A (Nama Satuan)
      }
    };
  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}

/* --- FUNGSI GENERATE TEMPLATE (REVISI: SUPPORT MASTER DATA) --- */
function createExcelTemplateFromServer(type, refData) {
  
  // 1. GENERATE TEMPLATE MASTER DATA (URAIAN, TOKO, TUKANG, GURU)
  // Jika tipe BUKAN Transaksi, buat sheet sederhana
  if (type !== 'TRANSAKSI') {
    var timestamp = Utilities.formatDate(new Date(), "GMT+7", "yyyyMMdd_HHmm");
    var fileName = "Template_" + type + "_" + timestamp;
    var ss = SpreadsheetApp.create(fileName);
    var sheet = ss.getSheets()[0];
    sheet.setName("Data " + type);

    var headers = [];
    if (type === 'URAIAN') {
      headers = ["Nomor Bukti", "Uraian Pekerjaan"];
    } else if (type === 'TOKO') {
      headers = ["Nama Toko", "Jenis Toko", "Alamat Lengkap", "No Telp", "Nama Pemilik", "Tempat TTD"];
    } else if (type === 'TUKANG') {
      headers = ["Nama Tukang", "Alamat Lengkap"];
    } else if (type === 'GURU') {
      headers = ["Nama Lengkap", "NIP"];
    }

    if (headers.length > 0) {
      // Set Header dengan Style
      var headerRange = sheet.getRange(1, 1, 1, headers.length);
      headerRange.setValues([headers]);
      headerRange.setFontWeight("bold");
      headerRange.setBackground("#fff2cc"); // Warna kuning muda
      headerRange.setBorder(true, true, true, true, true, true);
      
      // Atur Lebar Kolom agar rapi
      headers.forEach(function(h, i) {
        sheet.setColumnWidth(i + 1, 200);
      });
      
      // Bekukan Baris 1
      sheet.setFrozenRows(1);
      
      // Format Seluruh Kolom menjadi Teks (Agar NIP/No Telp tidak error)
      sheet.getRange(2, 1, 100, headers.length).setNumberFormat("@");
    }

    return { status: 'success', url: ss.getUrl() };
  }

  // 2. GENERATE TEMPLATE TRANSAKSI (LOGIKA LAMA - 3 SHEET)
  // Hanya dijalankan jika type === 'TRANSAKSI'
  
  var ss = SpreadsheetApp.create("Template_Transaksi_" + Utilities.formatDate(new Date(), "GMT+7", "yyyyMMdd_HHmm"));
  
  try {
    // A. SETUP DATA REFERENSI (Disembunyikan)
    var createRefSheet = function(name, data) {
      if (!data || data.length === 0) return null;
      var sheetName = "Ref_" + name;
      var newSheet = ss.insertSheet(sheetName);
      var values = data.map(function(item) { return [item]; });
      newSheet.getRange(1, 1, values.length, 1).setValues(values);
      newSheet.hideSheet(); 
      return newSheet.getRange(1, 1, values.length, 1);
    };

    var rangeUraian = createRefSheet("Uraian", refData.uraian);
    var rangeToko   = createRefSheet("Toko", refData.toko);
    var rangeTukang = createRefSheet("Tukang", refData.tukang);
    var rangeGuru   = createRefSheet("Guru", refData.guru);
    var rangeBarang = createRefSheet("Barang", refData.barang);
    var rangeSatuan = createRefSheet("Satuan", refData.satuan);

    // B. DEFINISI HEADER TRANSAKSI
    var headers = [
      "No", "Tipe", "Uraian Pekerjaan", "Pihak Ketiga / Keterangan", "Pemesan / Penanggung Jawab",
      "Nomor Surat Permintaan", "Tanggal Surat Permintaan",
      "Nomor Surat Penawaran", "Tanggal Surat Penawaran",
      "Nomor BA Pemeriksaan", "Tanggal BA Pemeriksaan",
      "Nomor BA Serah Terima", "Tanggal BA Serah Terima",
      "Nomor BA Pembayaran", "Tanggal BA Pembayaran",
      "Nama Barang", "Volume", "Satuan", "Harga Satuan"
    ];

    // C. FUNGSI PEMBUAT SHEET
    var setupSheet = function(sheetName, tipeDefault, rulePihak, rulePemesan) {
      var sheet = ss.insertSheet(sheetName);
      var maxRows = 100;

      sheet.getRange(1, 1, 1, headers.length)
           .setValues([headers])
           .setFontWeight("bold")
           .setBackground("#e0e0e0")
           .setBorder(true, true, true, true, true, true);
      sheet.setFrozenRows(1);

      sheet.getRange(2, 2, maxRows, 1).setValue(tipeDefault).setFontColor("#808080");

      if (rangeUraian) {
        var rule = SpreadsheetApp.newDataValidation().requireValueInRange(rangeUraian).setAllowInvalid(true).build();
        sheet.getRange(2, 3, maxRows, 1).setDataValidation(rule);
      }

      if (rulePihak) sheet.getRange(2, 4, maxRows, 1).setDataValidation(rulePihak);
      else sheet.getRange(2, 4, maxRows, 1).clearDataValidations();

      if (rulePemesan) sheet.getRange(2, 5, maxRows, 1).setDataValidation(rulePemesan);

      var dateRule = SpreadsheetApp.newDataValidation().requireDate().setAllowInvalid(false).setHelpText("Format Tanggal Salah").build();
      [7, 9, 11, 13, 15].forEach(function(col) { sheet.getRange(2, col, maxRows, 1).setDataValidation(dateRule); });

      if (rangeBarang) sheet.getRange(2, 16, maxRows, 1).setDataValidation(SpreadsheetApp.newDataValidation().requireValueInRange(rangeBarang).setAllowInvalid(true).build());
      if (rangeSatuan) sheet.getRange(2, 18, maxRows, 1).setDataValidation(SpreadsheetApp.newDataValidation().requireValueInRange(rangeSatuan).setAllowInvalid(true).build());

      sheet.setColumnWidth(3, 250);
      sheet.setColumnWidth(4, 200);
      sheet.setColumnWidth(16, 200);
    };

    // D. EKSEKUSI PEMBUATAN 3 SHEET
    var valToko = rangeToko ? SpreadsheetApp.newDataValidation().requireValueInRange(rangeToko).setAllowInvalid(false).build() : null;
    var valGuru = rangeGuru ? SpreadsheetApp.newDataValidation().requireValueInRange(rangeGuru).setAllowInvalid(true).build() : null;
    setupSheet("TOKO", "TOKO", valToko, valGuru);

    var valTukang = rangeTukang ? SpreadsheetApp.newDataValidation().requireValueInRange(rangeTukang).setAllowInvalid(false).build() : null;
    setupSheet("TUKANG", "TUKANG", valTukang, valGuru);

    setupSheet("GURU", "GURU", null, null); 

    var s1 = ss.getSheetByName("Sheet1");
    if(s1) ss.deleteSheet(s1);

    return { status: 'success', url: ss.getUrl() };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  }
}
