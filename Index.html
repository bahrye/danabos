<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
      /* Update pada bagian CSS body */
      body { 
        background-color: #f4f6f9; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        /* Hapus overflow-x: hidden global, ganti dengan penanganan horizontal yang lebih baik */
        width: 100%;
        overflow-x: hidden; 
        -webkit-overflow-scrolling: touch; /* PENTING: Agar scroll licin di mobile */
      }

      /* Tambahan: Pastikan konten utama tidak melebar */
      .panel-content {
        width: 100%;
        overflow-x: hidden;
      }

      /* Perbaikan Input agar tidak zoom in otomatis di HP saat diklik */
      input, select, textarea {
        font-size: 16px !important; /* Mencegah auto-zoom browser HP */
      }
      
      /* Login & Register Styles */
      .card-login { max-width: 400px; margin: 50px auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
      
      /* Layout Styles */
      /* --- CSS UPDATE RESPONSIVE --- */

      /* 1. Sidebar Default (Desktop) */
      .sidebar {
        min-height: 100vh;
        background: #2c3e50;
        color: white;
        transition: all 0.3s;
      }

      /* 2. CSS Khusus Mobile (Layar < 768px) */
      @media (max-width: 767.98px) {
        /* Sidebar disembunyikan di kiri layar (offcanvas manual) */
        .sidebar {
          position: fixed;
          top: 0;
          left: -250px; /* Sembunyi ke kiri */
          width: 250px;
          height: 100%;
          z-index: 1050; /* Di atas konten */
          overflow-y: auto;
        }

        /* Class untuk memunculkan sidebar */
        .sidebar.show {
          left: 0;
        }

        /* Konten Utama padding lebih kecil */
        .col-md-9.col-lg-10.p-4 {
          padding: 1rem !important; /* Ganti p-4 jadi p-3/p-2 di mobile */
        }

        /* Font tabel lebih kecil agar muat */
        .table {
          font-size: 0.8rem; 
        }
        
        /* Sembunyikan kolom yang kurang penting di mobile (Opsional) */
        /* .hide-mobile { display: none; } */
      }

      /* 3. Overlay Gelap saat Menu Mobile Aktif */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040; /* Di bawah sidebar, di atas konten */
      }

      .sidebar-overlay.show {
        display: block;
      }

      .nav-link { color: rgba(255,255,255,0.8); margin-bottom: 5px; cursor: pointer; }
      .nav-link:hover { background: #34495e; color: white; border-radius: 5px; }
      .nav-link.active { background: #3498db; color: white; border-radius: 5px; font-weight: bold; }
      
      /* Utility Classes */
      .hidden { display: none !important; }
      .cursor-pointer { cursor: pointer; }
      
      /* Loading Overlay */
      .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }

      /* --- STYLE TAB CUSTOM --- */
      /* Keadaan Tidak Aktif (Default) */
      .nav-tabs .nav-link {
        color: black !important;          /* Teks Hitam */
        background-color: #e9ecef;        /* Background abu muda */
        border: 1px solid #dee2e6;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        font-weight: 600;
      }

      /* Keadaan Aktif (Terpilih) */
      .nav-tabs .nav-link.active {
        color: white !important;          /* Teks Putih */
        background-color: #0d6efd !important; /* Background Biru Utama */
        border-color: #0d6efd !important;
      }

      /* Hover Effect */
      .nav-tabs .nav-link:hover {
        background-color: #dfe6ed;
        color: #000;
      }

      /* --- STYLE TAMBAHAN UNTUK NAV PILLS (Tab Setting) --- */
      
      /* 1. Style Dasar Tombol */
      .nav-pills .nav-link {
        background-color: #e9ecef; /* Warna abu-abu terang default */
        color: #495057;            /* Warna teks abu tua */
        margin-right: 5px;
        border: 1px solid #dee2e6; 
        transition: all 0.2s;      /* Animasi halus */
      }

      /* 2. Efek Hover HANYA untuk Tab yang TIDAK AKTIF */
      .nav-pills .nav-link:not(.active):hover {
        background-color: #dfe6ed; /* Berubah jadi abu agak gelap saat hover */
        color: #000;
      }

      /* 3. Style Tab AKTIF (Termasuk saat di-hover) */
      .nav-pills .nav-link.active,
      .nav-pills .nav-link.active:hover { 
        background-color: #0d6efd; /* Tetap Biru */
        color: white;
        border-color: #0d6efd;
        cursor: default; /* Opsional: Ubah kursor agar user tahu ini sedang aktif */
      }

      /* --- STYLE CUSTOM TOGGLE SWITCH --- */
      .toggle-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .toggle-card:hover {
        border-color: #0d6efd; /* Warna biru primary saat dihover */
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
      }

      /* Memperbesar ukuran saklar bawaan Bootstrap */
      .custom-switch-lg .form-check-input {
        width: 3.5em;  /* Lebih lebar */
        height: 1.75em; /* Lebih tinggi */
        cursor: pointer;
      }
      
      .custom-switch-lg .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
      }

      /* --- STYLE UNTUK AUTOCOMPLETE LIST --- */
      .autocomplete-wrapper {
        position: relative;
      }

      .suggestion-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: none; /* Tersembunyi default */
      }

      .suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f1f1f1;
        font-size: 0.9rem;
      }

      .suggestion-item:hover {
        background-color: #e9ecef;
        color: #0d6efd;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }
    </style>
  </head>
  <body>

    <div id="loading" class="loading-overlay hidden">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div id="view-login" class="container view-section">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-primary"><i class="fas fa-book-open"></i> LPJ BOS</h3>
        <p class="text-center text-muted">Sistem Manajemen LPJ Sekolah</p>
        <form id="formLogin" onsubmit="handleLogin(event)">
          <div class="mb-3">
            <label class="form-label">Email Sekolah</label>
            <input type="email" class="form-control" id="loginEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="loginPass" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Masuk</button>
        </form>
        <div class="text-center mt-3">
          <small>Belum punya akun? <span class="text-primary cursor-pointer text-decoration-underline" onclick="switchView('view-register')">Daftar disini</span></small>
        </div>
      </div>
    </div>

    <div id="view-register" class="container view-section hidden">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-success"><i class="fas fa-school"></i> Daftar Sekolah</h3>
        <form id="formRegister" onsubmit="handleRegister(event)">
          <div class="mb-3">
            <label class="form-label">Nama Sekolah</label>
            <input type="text" class="form-control" id="regNama" placeholder="Contoh: MTS Negeri 1..." required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="regEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="regPass" required>
          </div>
          <button type="submit" class="btn btn-success w-100">Daftar Sekarang</button>
        </form>
        <div class="text-center mt-3">
          <small>Sudah punya akun? <span class="text-primary cursor-pointer text-decoration-underline" onclick="switchView('view-login')">Login disini</span></small>
        </div>
      </div>
    </div>

    <div id="view-admin" class="container-fluid view-section hidden p-0"> <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="row g-0"> <div id="sidebarMenu" class="col-md-3 col-lg-2 sidebar p-3">
          <div class="d-flex justify-content-between align-items-center">
              <h4 class="text-center py-3 border-bottom w-100"><i class="fas fa-user-shield"></i> Admin LPJ</h4>
              <button class="btn btn-sm text-white d-md-none" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
          </div>
          <ul class="nav flex-column mt-4">
            <li class="nav-item">
              <a onclick="navigasiKe('panel-dashboard', this)" class="nav-link active" style="cursor: pointer;">
                <i class="fas fa-home me-2"></i> Dashboard
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Data Master</small></li>
            
            <li class="nav-item">
              <a onclick="navigasiKe('panel-data-sekolah', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-school me-2"></i> Data Sekolah
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-uraian', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-list-ul me-2"></i> Data Uraian Pekerjaan
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-toko', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-store me-2"></i> Data Toko
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-tukang', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-hammer me-2"></i> Data Tukang
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-guru', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-user-tie me-2"></i> Data Pemesan/Guru
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Pengaturan</small></li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-kop', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-image me-2"></i> Kop Surat
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-nomor-surat', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-list-ol me-2"></i> Nomor Surat
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-tanggal-surat', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-calendar-alt me-2"></i> Tanggal Surat
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Transaksi</small></li>
            
            <li class="nav-item">
              <a onclick="navigasiKe('panel-transaksi', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-shopping-cart me-2"></i> Transaksi Belanja
              </a>
            </li>

            <li class="nav-item mt-2">
              <small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Cetak</small>
            </li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-cetak-pdf', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-print me-2"></i> Cetak PDF
              </a>
            </li>
            
            <li class="nav-item mt-5 pt-5 border-top">
              <a onclick="logout()" class="nav-link text-danger" style="cursor: pointer;">
                <i class="fas fa-sign-out-alt me-2"></i> Keluar
              </a>
            </li>
          </ul>
        </div>

        <div class="col-md-9 col-lg-10 p-0 p-md-4"> <div class="w-100 p-3 p-md-2">
          
          <div class="d-md-none mb-3 d-flex align-items-center justify-content-between">
            <button class="btn btn-primary" onclick="toggleSidebar()">
              <i class="fas fa-bars me-1"></i> Menu
            </button>
            <span class="fw-bold text-secondary">LPJ BOS App</span>
          </div>

          <div id="panel-dashboard" class="panel-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Dashboard <span id="schoolNameDisplay" class="text-primary fs-5"></span></h2>
              <button class="btn btn-primary" onclick="navigasiKe('panel-transaksi')">
                <i class="fas fa-plus me-1"></i> Transaksi Belanja
              </button>
            </div>

            <div class="row g-3 mb-4">
              
              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-primary text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Jumlah Anggaran</h6>
                    <i class="fas fa-wallet fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashAnggaran">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Dana BOS Tahunan</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-danger text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Total Pengeluaran</h6>
                    <i class="fas fa-shopping-cart fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashPengeluaran">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Toko, Tukang & Guru</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card p-3 shadow-sm h-100 text-white" id="cardSisaAnggaran" style="background-color: #ffc107;"> <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Sisa Anggaran</h6>
                    <i class="fas fa-chart-pie fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashSisa">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Saldo Tersedia</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-info text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Jumlah Transaksi</h6>
                    <i class="fas fa-list-ol fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashJmlTrans">0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Total Item Data</small>
                </div>
              </div>

            </div>

            <div class="card shadow-sm border-0 mt-4">
              <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-school text-primary me-2"></i> Identitas Sekolah</h5>
                
                <button class="btn btn-sm btn-outline-primary" 
                  onclick="navigasiKe('panel-data-sekolah', document.querySelector(`a[onclick*='panel-data-sekolah']`))">
                  <i class="fas fa-edit me-1"></i> Ubah Data
                </button>
              </div>
              
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 border-end-md">
                     <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Profil Sekolah</h6>
                     <table class="table table-borderless table-sm mb-0" style="font-size: 0.95rem;">
                      <tr>
                        <td width="35%" class="text-muted">Nama Sekolah</td>
                        <td class="fw-bold" id="dashNamaSekolah">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">NPSN / NSM</td>
                        <td><span id="dashNpsn" class="fw-bold">-</span> / <span id="dashNsm">-</span></td>
                      </tr>
                      <tr>
                        <td class="text-muted">Alamat</td>
                        <td id="dashAlamat">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Desa/Kelurahan</td>
                        <td id="dashKelurahan">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Kecamatan</td>
                        <td id="dashKecamatan">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Kab/Kota</td>
                        <td id="dashKabupaten">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">No. Telp / HP</td>
                        <td class="fw-bold text-success" id="dashTelp">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Email</td>
                        <td id="dashEmail">-</td>
                      </tr>
                     </table>
                  </div>

                  <div class="col-md-6 ps-md-4 mt-4 mt-md-0">
                     <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Pejabat Sekolah</h6>
                     <table class="table table-borderless table-sm mb-0" style="font-size: 0.95rem;">
                       <tr>
                         <td width="35%" class="text-muted">Kepala Sekolah</td>
                         <td class="fw-bold" id="dashKepala">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NIP Kepala</td>
                         <td id="dashNipKepala">-</td>
                       </tr>
                       <tr><td colspan="2" class="py-2"></td></tr>
                       <tr>
                         <td class="text-muted">Bendahara</td>
                         <td class="fw-bold" id="dashBendahara">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NIP Bendahara</td>
                         <td id="dashNipBendahara">-</td>
                       </tr>
                     </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-toko" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-store text-primary"></i> Data Toko / Rekanan</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Toko</div>
                  <div class="card-body">
                    <form id="formToko" onsubmit="submitToko(event)">
                      <input type="hidden" id="tkId">

                      <div class="mb-3">
                        <label class="form-label">Nama Toko</label>
                        <input type="text" class="form-control" id="tkNama" placeholder="Contoh: Toko Amanah" required>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label class="form-label">Jenis Toko</label>
                          <input type="text" class="form-control" id="tkJenis" placeholder="ATK, Elektronik, dll" required>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">No. Telp/HP</label>
                          <input type="text" class="form-control" id="tkTelp" placeholder="0812...">
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Nama Pemilik</label>
                        <input type="text" class="form-control" id="tkPemilik" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Tempat TTD (Alamat/Kota/Kab)</label>
                        <input type="text" class="form-control" id="tkTempat" placeholder="Contoh: Bulukumba">
                        <small class="text-muted">Alamat/Kota tempat penandatanganan nota.</small>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Alamat Lengkap Toko</label>
                        <textarea class="form-control" id="tkAlamat" rows="2" placeholder="Jalan, No, Desa..." required></textarea>
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanToko" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan Toko
                        </button>
                        <button type="button" id="btnBatalToko" class="btn btn-secondary hidden" onclick="batalEditToko()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Toko Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-sm text-nowrap" style="font-size: 0.9rem;">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Toko</th>
                            <th>Pemilik</th>
                            <th>Jenis</th>
                            <th>Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelTokoBody">
                          <tr><td colspan="4" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-tukang" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-hammer text-primary"></i> Data Tukang / Pekerja</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Tukang</div>
                  <div class="card-body">
                    <form id="formTukang" onsubmit="submitTukang(event)">
                      <input type="hidden" id="tkgId">

                      <div class="mb-3">
                        <label class="form-label">Nama Lengkap Tukang</label>
                        <input type="text" class="form-control" id="tkgNama" placeholder="Nama sesuai KTP" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Alamat Lengkap</label>
                        <textarea class="form-control" id="tkgAlamat" rows="3" placeholder="Jalan, RT/RW, Desa..." required></textarea>
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanTukang" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        <button type="button" id="btnBatalTukang" class="btn btn-secondary hidden" onclick="batalEditTukang()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Tukang Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Lengkap</th>
                            <th>Alamat</th>
                            <th style="width: 100px;">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelTukangBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-guru" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-user-tie text-primary"></i> Data Pemesan / Guru</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Guru</div>
                  <div class="card-body">
                    <form id="formGuru" onsubmit="submitGuru(event)">
                      <input type="hidden" id="grId">

                      <div class="mb-3">
                        <label class="form-label">Nama Lengkap Guru</label>
                        <input type="text" class="form-control" id="grNama" placeholder="Nama Lengkap & Gelar" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">NIP <small>(Opsional)</small></label>
                        <input type="text" class="form-control" id="grNip" placeholder="19...">
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanGuru" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        <button type="button" id="btnBatalGuru" class="btn btn-secondary hidden" onclick="batalEditGuru()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Guru Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Lengkap</th>
                            <th>NIP</th>
                            <th style="width: 100px;">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelGuruBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-nomor-surat" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-file-alt text-primary"></i> Pengaturan Nomor Surat</h2>

            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-surat-toko" onclick="bukaTabSurat('toko')">
                  <i class="fas fa-store me-2"></i> Transaksi Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-surat-tukang" onclick="bukaTabSurat('tukang')">
                  <i class="fas fa-hammer me-2"></i> Transaksi Tukang
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-surat-setting" onclick="bukaTabSurat('setting')">
                  <i class="fas fa-cogs me-2"></i> Setting Nomor Otomatis
                </button>
              </li>
            </ul>

            <div id="view-surat-list"> 
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <div class="row g-2 mb-3 align-items-center">
                      <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                      <div class="col-auto">
                        <select id="fltTahun_surat" class="form-select form-select-sm" onchange="jalankanFilter('tabelSuratBody', 'fltTahun_surat', 'fltBulan_surat')"></select>
                      </div>
                      <div class="col-auto">
                        <select id="fltBulan_surat" class="form-select form-select-sm" onchange="jalankanFilter('tabelSuratBody', 'fltTahun_surat', 'fltBulan_surat')">
                          <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                        </select>
                      </div>
                    </div>

                    <div class="table-responsive">
                      <table class="table table-hover align-middle text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Tanggal</th>
                            <th>Uraian Belanja/Pekerjaan</th>
                            <th>Pihak Ketiga</th>
                            <th>Status Dokumen</th>
                            <th width="15%">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelSuratBody">
                          <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
            </div>

            <div id="view-surat-setting" class="hidden">
              <div class="card shadow-sm border-0">
                <div class="card-body">
                  
                  <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i> <strong>Panduan Format Otomatis:</strong><br>
                    Gunakan placeholder berikut dalam format surat Anda:
                    <ul>
                      <li><code>[nomor]</code> : Untuk input nomor urut surat (Contoh: 001, 002).</li>
                      <li><code>[bulan]</code> : Otomatis mengambil bulan dari tanggal transaksi (Contoh: 08, 12).</li>
                      <li><code>[tahun]</code> : Otomatis mengambil tahun dari tanggal transaksi (Contoh: 2025).</li>
                      <li><code>[apapun]</code> : Kata dalam kurung siku lain akan menjadi kolom input manual (Contoh: [kode], [romawi]).</li>
                    </ul>
                    Contoh Format: <code>B.[nomor]/MTs.21/[bulan]/[tahun]</code>
                  </div>

                  <ul class="nav nav-pills mb-3" id="pills-tab-setting" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="pills-set-toko-tab" data-bs-toggle="pill" data-bs-target="#pills-set-toko" type="button" role="tab">Setting Toko</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-set-tukang-tab" data-bs-toggle="pill" data-bs-target="#pills-set-tukang" type="button" role="tab">Setting Tukang</button>
                    </li>
                  </ul>

                  <div class="tab-content" id="pills-tabContent-setting">
                    
                    <div class="tab-pane fade show active" id="pills-set-toko" role="tabpanel">
                      
                      <div class="toggle-card p-3 rounded-3 d-flex justify-content-between align-items-center mb-4">
                        <div>
                          <label class="fw-bold d-block text-dark mb-1" for="toggleAutoToko" style="cursor: pointer;">
                            <i class="fas fa-robot text-primary me-2"></i> Penomoran Otomatis Toko
                          </label>
                          <small class="text-muted d-block" style="line-height: 1.2;">
                            Sistem akan mengisi nomor surat secara otomatis sesuai format.
                          </small>
                        </div>
                        
                        <div class="form-check form-switch custom-switch-lg mb-0">
                          <input class="form-check-input" type="checkbox" id="toggleAutoToko" onchange="toggleFormSetting('toko')">
                        </div>
                      </div>

                      <div id="formAutoToko" class="border p-4 rounded-3 bg-white shadow-sm hidden">
                          <h6 class="border-bottom pb-2 mb-3 text-primary fw-bold">Konfigurasi Format Surat Toko</h6>
                          
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Permintaan</label>
                            <input type="text" class="form-control" id="fmtTokoPermintaan" placeholder="Contoh: B.[nomor]/MTs.../[bulan]/[tahun]">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Penawaran</label>
                            <input type="text" class="form-control" id="fmtTokoPenawaran">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pemeriksaan</label>
                            <input type="text" class="form-control" id="fmtTokoPemeriksaan">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Serah Terima (BAST)</label>
                            <input type="text" class="form-control" id="fmtTokoBAST">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pembayaran</label>
                            <input type="text" class="form-control" id="fmtTokoBayar">
                          </div>
                      </div>
                    </div>

                    <div class="tab-pane fade" id="pills-set-tukang" role="tabpanel">
                      
                      <div class="toggle-card p-3 rounded-3 d-flex justify-content-between align-items-center mb-4">
                        <div>
                          <label class="fw-bold d-block text-dark mb-1" for="toggleAutoTukang" style="cursor: pointer;">
                            <i class="fas fa-magic text-warning me-2"></i> Penomoran Otomatis Tukang
                          </label>
                          <small class="text-muted d-block" style="line-height: 1.2;">
                            Aktifkan fitur ini untuk generate nomor surat tukang otomatis.
                          </small>
                        </div>
                        
                        <div class="form-check form-switch custom-switch-lg mb-0">
                          <input class="form-check-input" type="checkbox" id="toggleAutoTukang" onchange="toggleFormSetting('tukang')">
                        </div>
                      </div>
                      
                      <div id="formAutoTukang" class="border p-4 rounded-3 bg-white shadow-sm hidden">
                        <h6 class="border-bottom pb-2 mb-3 text-warning fw-bold text-dark">Konfigurasi Format Surat Tukang</h6>

                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Permintaan</label>
                          <input type="text" class="form-control" id="fmtTukangPermintaan">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pemeriksaan</label>
                          <input type="text" class="form-control" id="fmtTukangPemeriksaan">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Serah Terima (BAST)</label>
                          <input type="text" class="form-control" id="fmtTukangBAST">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pembayaran</label>
                          <input type="text" class="form-control" id="fmtTukangBayar">
                        </div>
                      </div>
                    </div>

                  </div>
                  
                  <div class="mt-4 border-top pt-3 text-end">
                    <button class="btn btn-primary" onclick="simpanSettingNomor()"><i class="fas fa-save me-1"></i> Simpan Pengaturan</button>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalSurat" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Kelola Nomor Surat</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="formInputSurat" onsubmit="simpanSurat(event)">
                    <input type="hidden" id="suratTransId">
                    <input type="hidden" id="suratTransTipe">
                    <input type="hidden" id="suratTransTanggal"> 
                    
                    <div id="alertManualMode" class="alert alert-info py-2 mb-3">
                      <small><i class="fas fa-info-circle"></i> Mode Manual: Silakan ketik nomor surat lengkap.</small>
                    </div>
                    
                    <div id="alertAutoMode" class="alert alert-success py-2 mb-3 hidden">
                      <small><i class="fas fa-robot"></i> Mode Otomatis: Masukkan variabel yang diminta.</small>
                    </div>

                    <div id="containerInputSurat">
                        </div>

                    <div class="modal-footer px-0 pb-0 mt-4">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="submit" id="btnSimpanSurat" class="btn btn-primary"><i class="fas fa-save me-1"></i> Simpan Dokumen</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-tanggal-surat" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-calendar-alt text-primary"></i> Pengaturan Tanggal Surat</h2>

            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-tgl-toko" onclick="bukaTabTanggal('toko')">
                  <i class="fas fa-store me-2"></i> Transaksi Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-tgl-tukang" onclick="bukaTabTanggal('tukang')">
                  <i class="fas fa-hammer me-2"></i> Transaksi Tukang
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                <div class="row g-2 mb-3 align-items-center">
                  <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                  <div class="col-auto">
                    <select id="fltTahun_tgl" class="form-select form-select-sm" onchange="jalankanFilter('tabelTanggalBody', 'fltTahun_tgl', 'fltBulan_tgl')"></select>
                  </div>
                  <div class="col-auto">
                    <select id="fltBulan_tgl" class="form-select form-select-sm" onchange="jalankanFilter('tabelTanggalBody', 'fltTahun_tgl', 'fltBulan_tgl')">
                      <option value="">Semua Bulan</option>
                      <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                      <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                      <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                      <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                    </select>
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table table-hover align-middle text-nowrap">
                    <thead class="table-light">
                      <tr>
                        <th>Tanggal Transaksi</th>
                        <th>Uraian</th>
                        <th>Pihak Ketiga</th>
                        <th>Status Tanggal</th>
                        <th width="15%">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="tabelTanggalBody">
                      <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalTanggal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title"><i class="fas fa-calendar-day me-2"></i> Atur Tanggal Dokumen</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="formInputTanggal" onsubmit="simpanTanggal(event)">
                    <input type="hidden" id="tglTransId">
                    <input type="hidden" id="tglTransTipe">
                    
                    <div class="alert alert-success py-2 mb-3">
                      <small><i class="fas fa-info-circle"></i> Tanggal Surat Permintaan otomatis mengikuti tanggal transaksi.</small>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. Surat Permintaan</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control bg-light" id="tglSuratPermintaan" readonly>
                        <div class="form-text text-success"><i class="fas fa-lock me-1"></i> Terkunci (Sesuai Tgl Transaksi)</div>
                      </div>
                    </div>

                    <div class="mb-3 row" id="wrapTglPenawaran">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. Surat Penawaran</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglSuratPenawaran">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Pemeriksaan</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaPemeriksaan">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Serah Terima</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaSerahTerima">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Pembayaran</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaPembayaran">
                      </div>
                    </div>

                    <div class="modal-footer px-0 pb-0 mt-4">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="submit" id="btnSimpanTanggal" class="btn btn-success"><i class="fas fa-save me-1"></i> Simpan Tanggal</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalInfoSatuan" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content border-0 shadow-lg">
                
                <div class="modal-header bg-info text-white bg-gradient">
                  <h5 class="modal-title"><i class="fas fa-ruler-combined me-2"></i> Referensi Satuan</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                  
                  <div class="input-group mb-4 shadow-sm">
                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="cariSatuanInput" placeholder="Cari nama satuan atau kegunaan..." onkeyup="filterInfoSatuan()">
                  </div>

                  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th width="20%">Nama Satuan</th>
                          <th width="25%">Kategori</th>
                          <th>Penggunaan Umum / Contoh</th>
                        </tr>
                      </thead>
                      <tbody id="bodyInfoSatuan">
                        <tr><td colspan="3" class="text-center text-muted">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <div class="mt-3 text-end text-muted fst-italic" style="font-size: 0.8rem;">
                    <small>* Data diambil dari sheet "Satuan" di database.</small>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div id="panel-kop" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-image text-primary"></i> Pengaturan Kop Surat</h2>
            
            <div class="card shadow-sm border-0" style="max-width: 600px;">
              <div class="card-body p-4">
                
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-1"></i> Upload gambar kop surat (Header). Format: JPG/PNG. Ukuran optimal lebar 800px.
                </div>

                <div class="text-center mb-4 p-3 border rounded bg-light" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                  <img id="imgPreview" src="" alt="Preview Kop Surat" style="max-width: 100%; height: auto; display: none;">
                  <span id="txtNoImage" class="text-muted fst-italic">Belum ada kop surat yang diupload.</span>
                </div>

                <form id="formKop" onsubmit="uploadKop(event)">
                  <div class="mb-3">
                    <label class="form-label fw-bold">Pilih Gambar</label>
                    <input class="form-control" type="file" id="fileKop" accept="image/png, image/jpeg" onchange="previewImage(this)" required>
                  </div>

                  <div class="d-flex justify-content-between">
                    <button type="button" id="btnHapusKop" class="btn btn-danger hidden" onclick="aksiHapusKop()">
                      <i class="fas fa-trash-alt me-1"></i> Hapus Kop
                    </button>
                    <button type="submit" id="btnSimpanKop" class="btn btn-primary">
                      <i class="fas fa-cloud-upload-alt me-1"></i> Upload & Simpan
                    </button>
                  </div>
                </form>

              </div>
            </div>
          </div>

          <div id="panel-transaksi" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-shopping-cart text-primary"></i> Transaksi Belanja</h2>

            <ul class="nav nav-tabs mb-4" id="transaksiTabs">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-btn-toko" onclick="bukaTab('toko')">
                  <i class="fas fa-store me-2"></i> Belanja Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-btn-guru" onclick="bukaTab('guru')">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Honor Guru
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-btn-tukang" onclick="bukaTab('tukang')">
                  <i class="fas fa-hammer me-2"></i> Upah Tukang
                </button>
              </li>
            </ul>

            <div id="tab-content-toko" class="tab-section">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <form id="formBelanjaToko">
                    <input type="hidden" id="trTokoId"> <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Transaksi</label>
                        <input type="date" class="form-control" id="trTokoTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Belanja (RKAM)</label>
                        <select class="form-select" id="trTokoUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>

                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Pilih Toko / Rekanan</label>
                        <select class="form-select" id="trTokoNama" required>
                          <option value="">-- Pilih Toko --</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Pilih Data Pemesan</label>
                        <select class="form-select" id="trTokoPemesan" required>
                          <option value="">-- Pilih Guru/Pemesan --</option>
                        </select>
                      </div>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Daftar Barang Belanjaan</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap" id="tabelItemToko">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="30%">Nama Barang</th>
                            <th width="10%">Vol</th>
                            <th width="10%">Satuan</th>
                            <th width="20%">Harga (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="10%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL BELANJA:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trTokoTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trTokoTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="d-flex justify-content-between mt-3 align-items-end">
                      
                      <div class="d-flex gap-2 align-items-center flex-wrap">
                        <button type="button" class="btn btn-outline-primary" onclick="tambahBaris('toko')">
                          <i class="fas fa-plus me-1"></i> Tambah Baris
                        </button>

                        <div class="autocomplete-wrapper" style="min-width: 250px;">
                          <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" 
                                   placeholder="Cari Referensi Barang..." 
                                   oninput="handleCariBarang(this, 'toko')"
                                   autocomplete="off">
                          </div>
                          <div id="saran-barang-toko" class="suggestion-list"></div>
                        </div>
                      </div>
                      
                      <div>
                        <button type="button" class="btn btn-info text-white me-2" onclick="bukaModalSatuan()">
                          <i class="fas fa-eye me-1"></i> Info Satuan
                        </button>

                        <button type="button" id="btnBatalTokoTrans" class="btn btn-secondary me-2 hidden" onclick="batalEditTransaksi('toko')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        <button type="button" id="btnSimpanTokoTrans" class="btn btn-success" onclick="simpanTransaksi('toko')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>

                  </form>
                </div>
              </div>

              <div class="card shadow-sm border-0">
                  <div class="card-header bg-white fw-bold py-3">Riwayat Transaksi Toko</div>
                  <div class="card-body">

                      <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                        <div class="col-auto">
                          <select id="fltTahun_toko" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiToko', 'fltTahun_toko', 'fltBulan_toko')"></select>
                        </div>
                        <div class="col-auto">
                          <select id="fltBulan_toko" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiToko', 'fltTahun_toko', 'fltBulan_toko')">
                            <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                          </select>
                        </div>
                      </div>

                      <div class="table-responsive">
                          <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                              <thead class="table-light">
                                  <tr>
                                      <th>Tanggal</th>
                                      <th>Uraian</th>
                                      <th>Toko</th>
                                      <th>Total</th>
                                      <th>Aksi</th>
                                  </tr>
                              </thead>
                              <tbody id="listTransaksiToko">
                                  <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
            </div>

            <div id="tab-content-guru" class="tab-section hidden">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-info py-2 mb-3"><small><i class="fas fa-info-circle"></i> Mode Input: Pembayaran Honorarium / Transport Guru</small></div>
                  
                  <form id="formBelanjaGuru">
                    <input type="hidden" id="trGuruId"> 
                    
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Pembayaran</label>
                        <input type="date" class="form-control" id="trGuruTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Pekerjaan / Kegiatan</label>
                        <select class="form-select" id="trGuruUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="form-label">Keterangan <small class="text-muted">(Opsional)</small></label>
                      <textarea class="form-control" id="trGuruKeterangan" rows="2" placeholder="Contoh: Honorarium bulan Januari 2025..."></textarea>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Rincian Penerima Honor</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap" id="tabelItemGuru">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="30%">Nama Guru</th>
                            <th width="10%">Vol</th>
                            <th width="10%">Satuan</th>
                            <th width="20%">Honor/Upah (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="10%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL HONOR:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trGuruTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trGuruTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                      <button type="button" class="btn btn-outline-primary" onclick="tambahBaris('guru')">
                        <i class="fas fa-plus me-1"></i> Tambah Penerima
                      </button>

                      <div>
                        <button type="button" class="btn btn-info text-white me-2" onclick="bukaModalSatuan()">
                          <i class="fas fa-eye me-1"></i> Info Satuan
                        </button>

                        <button type="button" id="btnBatalGuruTrans" class="btn btn-secondary me-2 hidden" onclick="batalEditTransaksi('guru')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        <button type="button" id="btnSimpanGuruTrans" class="btn btn-success" onclick="simpanTransaksi('guru')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>

                  </form>
                </div>
              </div>

              <div class="card shadow-sm border-0">
                  <div class="card-header bg-white fw-bold py-3">Riwayat Pembayaran Honor</div>
                  <div class="card-body">
                      <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                        <div class="col-auto">
                          <select id="fltTahun_guru" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiGuru', 'fltTahun_guru', 'fltBulan_guru')"></select>
                        </div>
                        <div class="col-auto">
                          <select id="fltBulan_guru" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiGuru', 'fltTahun_guru', 'fltBulan_guru')">
                            <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                          </select>
                        </div>
                      </div>

                      <div class="table-responsive">
                          <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                              <thead class="table-light">
                                  <tr>
                                      <th>Tanggal</th>
                                      <th>Uraian Kegiatan</th>
                                      <th>Keterangan</th> <th>Total</th>
                                      <th>Aksi</th>
                                  </tr>
                              </thead>
                              <tbody id="listTransaksiGuru">
                                  <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
            </div>

            <div id="tab-content-tukang" class="tab-section hidden">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-warning py-2 mb-3"><small><i class="fas fa-info-circle"></i> Mode Input: Pembayaran Upah Tukang</small></div>
                  <form id="formBelanjaTukang">
                    <input type="hidden" id="trTukangId"> <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Transaksi</label>
                        <input type="date" class="form-control" id="trTukangTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Pekerjaan</label>
                        <select class="form-select" id="trTukangUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>

                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Pilih Tukang / Pekerja</label>
                        <select class="form-select" id="trTukangNama" required>
                          <option value="">-- Pilih Tukang --</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Pilih Data Pemesan</label>
                        <select class="form-select" id="trTukangPemesan" required>
                          <option value="">-- Pilih Guru --</option>
                        </select>
                      </div>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Rincian Upah / Bahan</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap" id="tabelItemTukang">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="30%">Jenis Pekerjaan/Item</th>
                            <th width="10%">Vol</th>
                            <th width="10%">Satuan</th>
                            <th width="20%">Upah/Harga (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="10%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL UPAH:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trTukangTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trTukangTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                      <div class="d-flex justify-content-between mt-3 align-items-end">
                        
                        <div class="d-flex gap-2 align-items-center flex-wrap">
                          <button type="button" class="btn btn-outline-primary" onclick="tambahBaris('tukang')">
                            <i class="fas fa-plus me-1"></i> Tambah Baris
                          </button>

                          <div class="autocomplete-wrapper" style="min-width: 250px;">
                            <div class="input-group input-group-sm">
                              <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                              <input type="text" class="form-control border-start-0 ps-0" 
                                    placeholder="Cari Referensi Material/Upah..." 
                                    oninput="handleCariBarang(this, 'tukang')"
                                    autocomplete="off">
                            </div>
                            <div id="saran-barang-tukang" class="suggestion-list"></div>
                          </div>
                        </div>

                        <div>
                          <button type="button" class="btn btn-info text-white me-2" onclick="bukaModalSatuan()">
                            <i class="fas fa-eye me-1"></i> Info Satuan
                          </button>

                          <button type="button" id="btnBatalTukangTrans" class="btn btn-secondary me-2 hidden" onclick="batalEditTransaksi('tukang')">
                            <i class="fas fa-times me-1"></i> Batal
                          </button>
                          <button type="button" id="btnSimpanTukangTrans" class="btn btn-success" onclick="simpanTransaksi('tukang')">
                            <i class="fas fa-save me-1"></i> Simpan Transaksi
                          </button>
                        </div>
                      </div>
                    </div>

                  </form>
                </div>
              </div>

              <div class="card shadow-sm border-0">
                  <div class="card-header bg-white fw-bold py-3">Riwayat Transaksi Tukang</div>
                  <div class="card-body">
                      <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                        <div class="col-auto">
                          <select id="fltTahun_tukang" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiTukang', 'fltTahun_tukang', 'fltBulan_tukang')"></select>
                        </div>
                        <div class="col-auto">
                          <select id="fltBulan_tukang" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiTukang', 'fltTahun_tukang', 'fltBulan_tukang')">
                            <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                          </select>
                        </div>
                      </div>
                      <div class="table-responsive">
                          <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                              <thead class="table-light">
                                  <tr>
                                      <th>Tanggal</th>
                                      <th>Uraian</th>
                                      <th>Tukang</th>
                                      <th>Total</th>
                                      <th>Aksi</th>
                                  </tr>
                              </thead>
                              <tbody id="listTransaksiTukang">
                                  <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
            </div>
          </div>

          <div id="panel-cetak-pdf" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-print text-primary"></i> Cetak Laporan PDF</h2>

            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-cetak-toko" onclick="bukaTabCetak('toko')">
                  <i class="fas fa-store me-2"></i> LPJ Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-cetak-guru" onclick="bukaTabCetak('guru')">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Honor Guru
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-cetak-tukang" onclick="bukaTabCetak('tukang')">
                  <i class="fas fa-hammer me-2"></i> Upah Tukang
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold text-dark" id="tab-cetak-setting" onclick="bukaTabCetak('setting')">
                  <i class="fas fa-cog me-2"></i> Pengaturan Template
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                
                <div id="view-cetak-toko" class="view-cetak">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Transaksi Belanja Toko Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_toko" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-toko', 'fltTahun_cetak_toko', 'fltBulan_cetak_toko')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_toko" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-toko', 'fltTahun_cetak_toko', 'fltBulan_cetak_toko')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Belanja</th>
                          <th>Nama Toko</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-toko">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-guru" class="view-cetak hidden">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Pembayaran Honor Guru Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_guru" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-guru', 'fltTahun_cetak_guru', 'fltBulan_cetak_guru')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_guru" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-guru', 'fltTahun_cetak_guru', 'fltBulan_cetak_guru')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Kegiatan</th>
                          <th>Keterangan</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-guru">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-tukang" class="view-cetak hidden">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Upah Tukang Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_tukang" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-tukang', 'fltTahun_cetak_tukang', 'fltBulan_cetak_tukang')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_tukang" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-tukang', 'fltTahun_cetak_tukang', 'fltBulan_cetak_tukang')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Pekerjaan</th>
                          <th>Nama Tukang</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-tukang">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-setting" class="view-cetak hidden">
                  <div class="row">
                    <div class="col-lg-5 mb-4">
                      <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold py-3 text-primary">
                          <i class="fas fa-file-word me-2"></i> Input ID Google Doc
                        </div>
                        <div class="card-body">
                          <div class="alert alert-warning py-2" style="font-size: 0.85rem;">
                            <i class="fas fa-exclamation-triangle me-1"></i> <strong>Penting:</strong> Pastikan Google Doc Template Anda aksesnya diatur menjadi <em>"Siapa saja yang memiliki link dapat melihat" (Anyone with the link can view)</em> agar sistem bisa membacanya.
                          </div>

                          <form id="formTemplate" onsubmit="simpanTemplate(event)">
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Laporan Toko</label>
                              <input type="text" class="form-control font-monospace" id="tplIdToko" placeholder="Contoh: 1Fl8Jaf4j6XI...">
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Honor Guru</label>
                              <input type="text" class="form-control font-monospace" id="tplIdGuru" placeholder="Contoh: 1pC4xjpoGps...">
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Upah Tukang</label>
                              <input type="text" class="form-control font-monospace" id="tplIdTukang" placeholder="Contoh: 1vNWFUOKI...">
                            </div>
                            
                            <div class="d-grid">
                              <button type="submit" id="btnSimpanTemplate" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Simpan Pengaturan
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <div class="col-lg-7">
                      <div class="card shadow-sm border-0">
                        <div class="card-body">
                          <h5 class="mb-3"><i class="fas fa-book-reader text-success me-2"></i> Panduan Pembuatan Template</h5>
                          
                          <div class="accordion" id="accordionPanduan">
                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                  1. Cara Mendapatkan ID Google Doc
                                </button>
                              </h2>
                              <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body bg-light">
                                  <ol class="small mb-0 ps-3">
                                    <li>Buka file Google Doc template Anda.</li>
                                    <li>Lihat pada Address Bar browser.</li>
                                    <li>Link biasanya seperti: <code>docs.google.com/document/d/<strong>ID_ADALAH_DISINI</strong>/edit</code></li>
                                    <li>Copy kode acak tersebut dan paste ke form di samping.</li>
                                  </ol>
                                </div>
                              </div>
                            </div>

                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                  2. Daftar Kode Placeholder (Wajib Copy-Paste)
                                </button>
                              </h2>
                              <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body p-0">
                                  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-striped mb-0 small">
                                      <thead class="table-dark sticky-top">
                                        <tr><th>Kode (Copy ke Doc)</th><th>Keterangan</th></tr>
                                      </thead>
                                      <tbody>
                                        <tr><td class="font-monospace">&lt;&lt;KOP SURAT&gt;&gt;</td><td>Akan diganti gambar Kop Sekolah</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Sekolah&gt;&gt;</td><td>Nama Sekolah Anda</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nomor Bukti Uraian&gt;&gt;</td><td>No. Bukti (dari Data Uraian)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Uraian Pekerjaan&gt;&gt;</td><td>Judul Uraian / Belanja</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Total&gt;&gt;</td><td>Total Angka (Rp)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Total Terbilang&gt;&gt;</td><td>Total Huruf (Terbilang)</td></tr>
                                        
                                        <tr><td colspan="2" class="fw-bold bg-warning bg-opacity-25">Khusus Tabel Barang</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;TABLE_ROW&gt;&gt;</td><td>Buat 1 baris tabel di Doc, tulis kode ini di salah satu kolom untuk menandai baris yang akan diulang (looping).</td></tr>
                                        
                                        <tr><td colspan="2" class="fw-bold bg-info bg-opacity-25">Khusus Toko</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Toko&gt;&gt;</td><td>Nama Pihak Ketiga</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nomor Surat Keluar&gt;&gt;</td><td>Nomor Surat Permintaan</td></tr>

                                        <tr><td colspan="2" class="fw-bold bg-info bg-opacity-25">Khusus Tukang</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Tukang&gt;&gt;</td><td>Nama Pekerja</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Alamat Lengkap Tukang&gt;&gt;</td><td>Alamat Pekerja</td></tr>

                                        <tr><td colspan="2" class="fw-bold bg-info bg-opacity-25">Pejabat TTD</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NAMA KEPALA SEKOLAH&gt;&gt;</td><td>Nama Kepala</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NAMA BENDAHARA&gt;&gt;</td><td>Nama Bendahara</td></tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                  3. Contoh Penggunaan Placeholder Template
                                </button>
                              </h2>
                              <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body">
                                  <p class="small text-muted mb-2">
                                    Berikut adalah contoh dokumen asli yang sudah dipasangi placeholder. Klik ikon mata untuk membuka dan melihat isinya.
                                  </p>
                                  
                                  <ul class="list-group list-group-flush small">
                                    
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-store text-primary me-2"></i>
                                          <span class="fw-bold text-dark">Template Laporan Toko</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1Fl8Jaf4j6XIyF8TghkwUsmrqEKU7obVbuOWDxlIa56o/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Toko">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-chalkboard-teacher text-success me-2"></i>
                                          <span class="fw-bold text-dark">Template Honor Guru</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1pC4xjpoGpsCaidPqoWHjJAAFgwnuDnKPsONUrd3IeFg/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Guru">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-hammer text-warning me-2"></i>
                                          <span class="fw-bold text-dark">Template Upah Tukang</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1vNWFUOKIKob8SI0VX0ROxhZQ02Tl6eboiR2TZ7mzRqE/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Tukang">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                  </ul>
                                </div>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div id="panel-uraian" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-list-ul text-primary"></i> Data Uraian Pekerjaan</h2>
            
            <div class="row">
              <div class="col-md-4">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Tambah Uraian Baru</div>
                  <div class="card-body">
                    <form id="formUraian" onsubmit="submitUraian(event)">
                      <input type="hidden" id="urId">
                      
                      <div class="mb-3">
                        <label class="form-label">Nomor Bukti</label>
                        <input type="text" class="form-control" id="urNoBukti" placeholder="Contoh: 01/BOS/..." required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Uraian Pekerjaan / Belanja</label>
                        <div class="autocomplete-wrapper">
                          <textarea class="form-control" id="urNama" rows="3" 
                            placeholder="Ketik minimal 3 huruf untuk cari referensi..." 
                            required 
                            oninput="handleInputUraian(this)" 
                            autocomplete="off"></textarea>
                          
                          <div id="listSaranUraian" class="suggestion-list"></div>
                        </div>
                        <small class="text-muted" style="font-size: 0.75rem;">*Pilih dari saran yang muncul atau ketik manual jika tidak ada.</small>
                      </div>
                      
                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanUraian" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        
                        <button type="button" id="btnBatalUraian" class="btn btn-secondary hidden" onclick="batalEdit()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-8">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Uraian Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th width="25%">No. Bukti</th>
                            <th>Uraian Pekerjaan</th>
                            <th width="10%">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelUraianBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-pengaturan" class="panel-content hidden">
            <h2 class="mb-4">Pengaturan Sekolah</h2>
            <div class="card shadow-sm border-0">
              <div class="card-body">
                <form>
                  <div class="mb-3">
                    <label class="form-label">Nama Kepala Sekolah</label>
                    <input type="text" class="form-control" placeholder="Nama Lengkap & Gelar">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">NIP Kepala Sekolah</label>
                    <input type="text" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nama Bendahara</label>
                    <input type="text" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Alamat Sekolah</label>
                    <textarea class="form-control" rows="3"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </form>
              </div>
            </div>
          </div>

          <div id="panel-data-sekolah" class="panel-content hidden">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-school text-primary"></i> Data Sekolah</h2>
              <button class="btn btn-primary" onclick="submitDataSekolah()"><i class="fas fa-save"></i> Simpan Data</button>
            </div>

            <div class="mt-4 pt-3 border-top">
              <h6 class="fw-bold text-danger"><i class="fas fa-tools"></i> Maintenance Database</h6>
              <p class="small text-muted">Klik tombol ini jika Anda mengalami error "Kolom tidak ditemukan" atau setelah update aplikasi.</p>
              <button class="btn btn-outline-danger btn-sm" onclick="jalankanMaintenance()">
                <i class="fas fa-sync"></i> Sinkronisasi Struktur Tabel
              </button>
            </div>

            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <form id="formDataSekolah">
                        
                  <h5 class="text-primary border-bottom pb-2 mb-3">Identitas Sekolah</h5>
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label fw-bold">Nama Sekolah <span class="text-danger">*</span></label>
                      <input type="text" class="form-control bg-light" id="dsNamaSekolah" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-bold">NPSN <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="dsNpsn" required placeholder="Contoh: 40319868">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">NSM <small>(Opsional Bagi Madrasah)</small></label>
                      <input type="text" class="form-control" id="dsNsm" placeholder="Contoh: 1212...">
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">No. Telp Sekolah</label>
                      <input type="text" class="form-control" id="dsTelp" placeholder="Contoh: 0812...">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Email Sekolah</label>
                      <input type="email" class="form-control" id="dsEmail">
                    </div>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Alamat Lengkap</h5>
                  <div class="mb-3">
                    <label class="form-label">Alamat Jalan/Dusun</label>
                    <textarea class="form-control" id="dsAlamat" rows="2" placeholder="Jl. Raya..."></textarea>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Provinsi</label>
                      <input type="text" class="form-control" id="dsProvinsi">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Kabupaten/Kota</label>
                      <input type="text" class="form-control" id="dsKabupaten">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Kecamatan</label>
                      <input type="text" class="form-control" id="dsKecamatan">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Kelurahan/Desa</label>
                      <input type="text" class="form-control" id="dsKelurahan">
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-bold">Tempat TTD (Alamat/Kota/Kab) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="dsTempatTTD" placeholder="Contoh: Bulukumba">
                    <small class="text-muted">Hanya isi nama Alamat/Kota/Kabupaten.</small>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Pejabat Sekolah</h5>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Nama Kepala Sekolah</label>
                      <input type="text" class="form-control" id="dsKepala" placeholder="Nama Lengkap & Gelar">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">NIP Kepala <small>(Opsional)</small></label>
                      <input type="text" class="form-control" id="dsNipKepala">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Nama Bendahara</label>
                      <input type="text" class="form-control" id="dsBendahara">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">NIP Bendahara <small>(Opsional)</small></label>
                      <input type="text" class="form-control" id="dsNipBendahara">
                    </div>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Pengaturan Default BOS</h5>
                  <div class="row mb-3">
                    
                    <div class="col-md-4">
                      <label class="form-label fw-bold">Nama Dana BOS</label>
                      
                      <select class="form-select" id="dsDanaBos" onchange="cekPeriodeBos()">
                        <option value="">-- Pilih Jenis --</option>
                        <option value="Lainnya">Lainnya (Manual)</option>
                        <option value="Dana BOS Tahap 1">Dana BOS Tahap 1</option>
                        <option value="Dana BOS Tahap 2">Dana BOS Tahap 2</option>
                        <option value="Dana BOS Triwulan 1">Dana BOS Triwulan 1</option>
                        <option value="Dana BOS Triwulan 2">Dana BOS Triwulan 2</option>
                        <option value="Dana BOS Triwulan 3">Dana BOS Triwulan 3</option>
                        <option value="Dana BOS Triwulan 4">Dana BOS Triwulan 4</option>
                      </select>

                      <small id="infoPeriode" class="text-muted fst-italic d-block mt-1"></small>

                      <div id="wrapManualBos" class="hidden mt-2">
                        <label class="form-label text-muted" style="font-size: 0.8rem;">Nama Dana BOS:</label>
                        <input type="text" class="form-control mb-2" id="dsDanaBosManual" placeholder="Contoh: BOS Afirmasi">
                        
                        <label class="form-label text-muted" style="font-size: 0.8rem;">Ketik Periode:</label>
                        <input type="text" class="form-control" id="dsPeriodeManual" placeholder="Contoh: Januari - Juni">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-bold">Jumlah Anggaran</label>
                      <div class="input-group">
                        <span class="input-group-text">Rp</span>
                        <input type="text" class="form-control" id="dsJumlahAnggaran" placeholder="0" oninput="this.value = formatRibuanInput(this.value)">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-bold">Tahun Anggaran</label>
                      <input type="number" class="form-control" id="dsTahun" placeholder="2025">
                    </div>
                  </div>

                  <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-primary px-4" onclick="submitDataSekolah()">
                      <i class="fas fa-save me-2"></i> Simpan Data
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

      let cacheDataGuru = [];
      let cacheSatuan = [];
      let cacheMasterUraian = [];


      /* --- LOGIKA NAVIGASI UTAMA (SPA) --- */
      
      // 1. Pindah Antara Login, Register, dan Admin Panel
      function switchView(viewId) {
        // Sembunyikan semua view utama
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        // Tampilkan view yang dipilih
        document.getElementById(viewId).classList.remove('hidden');
      }


      // 2. Pindah Menu Sidebar (Dashboard <-> Buat LPJ <-> Pengaturan)
      function navigasiKe(panelId, linkElement) {
        // 1. Mobile Sidebar logic
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById('sidebarMenu');
          const overlay = document.getElementById('sidebarOverlay');
          if(sidebar) sidebar.classList.remove('show'); // Tambahkan if
          if(overlay) overlay.classList.remove('show'); // Tambahkan if
        }

        // 2. Hide semua panel
        document.querySelectorAll('.panel-content').forEach(el => {
            if(el && el.classList) el.classList.add('hidden'); // Tambahkan cek if(el)
        });

        // 3. Show target panel
        const targetPanel = document.getElementById(panelId);
        if(targetPanel) {
            targetPanel.classList.remove('hidden');
            window.scrollTo(0, 0);
        } else {
            console.warn("Panel tidak ditemukan: " + panelId); // Debugging
        }

        // 4. Update Sidebar Active State
        if (linkElement) {
          document.querySelectorAll('.sidebar .nav-link').forEach(el => el.classList.remove('active'));
          // HANYA jalankan jika linkElement benar-benar elemen HTML
          if (linkElement.classList) { 
              linkElement.classList.add('active');
          }
        }

        // --- Logika Load Data ---
        if(panelId === 'panel-dashboard') loadDashboardStats();
        if(panelId === 'panel-data-sekolah') loadDataSekolah();
        if(panelId === 'panel-uraian') {
            loadUraianData();      // Data tabel CRUD yang sudah ada
            loadMasterReferensi(); // <-- TAMBAHKAN INI
        }
        if(panelId === 'panel-toko') loadTokoData();
        if(panelId === 'panel-tukang') loadTukangData();
        if(panelId === 'panel-guru') loadGuruData();
        if(panelId === 'panel-kop') loadKopSettings();
        
        if(panelId === 'panel-transaksi') {
          loadTransaksiOptions(); 
          if(document.getElementById('tabelItemToko').tBodies[0].rows.length === 0) tambahBaris('toko');
          if(document.getElementById('tabelItemTukang').tBodies[0].rows.length === 0) tambahBaris('tukang');
          if(document.getElementById('tabelItemGuru').tBodies[0].rows.length === 0) tambahBaris('guru');
          bukaTab('toko'); 
        }

        if(panelId === 'panel-nomor-surat') bukaTabSurat('toko');
        if(panelId === 'panel-tanggal-surat') bukaTabTanggal('toko');
        if(panelId === 'panel-cetak-pdf') bukaTabCetak('toko');
      }

      /* --- LOGIKA APLIKASI --- */

      window.onload = function() {
        const token = localStorage.getItem('userToken');
        if(token) {
          switchView('view-admin');
          document.getElementById('schoolNameDisplay').innerText = "(" + localStorage.getItem('userName') + ")";
          
          // Tambahkan ini agar saat login/refresh, data dashboard langsung muncul
          loadDashboardStats(); 
          
        } else {
          switchView('view-login');
        }
      };

      function toggleLoading(show) {
        const el = document.getElementById('loading');
        show ? el.classList.remove('hidden') : el.classList.add('hidden');
      }

      function handleLogin(e) {
        e.preventDefault();
        toggleLoading(true);
        
        const form = {
          email: document.getElementById('loginEmail').value,
          password: document.getElementById('loginPass').value
        };

        google.script.run
          .withFailureHandler(handleServerError) // [PERBAIKAN] Handler Error
          .withSuccessHandler(function(res){
            toggleLoading(false);
            if(res.status === 'success') {
              localStorage.setItem('userToken', res.token);
              localStorage.setItem('userName', res.namaSekolah);
              
              // Update tampilan nama sekolah di dashboard
              const elName = document.getElementById('schoolNameDisplay');
              if(elName) elName.innerText = "(" + res.namaSekolah + ")";
              
              // Pindah ke halaman admin dan load data dashboard
              switchView('view-admin');
              loadDashboardStats(); // Pastikan dashboard ter-load saat login
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Login Gagal',
                html: res.message
              });
            }
          })
          .loginUser(form);
      }

      function handleRegister(e) {
        e.preventDefault();
        toggleLoading(true);
        
        const form = {
          namaSekolah: document.getElementById('regNama').value,
          email: document.getElementById('regEmail').value,
          password: document.getElementById('regPass').value
        };

        google.script.run
          .withFailureHandler(handleServerError) // [PERBAIKAN] Handler Error
          .withSuccessHandler(function(res){
            toggleLoading(false);
            if(res.status === 'success') {
              Swal.fire('Berhasil', res.message, 'success');
              switchView('view-login');
            } else {
              Swal.fire({ icon: 'error', title: 'Registrasi Gagal', html: res.message });
            }
          })
          .registerSchool(form);
      }

      function logout() {
        Swal.fire({
          title: 'Yakin ingin keluar?',
          text: "Sesi Anda akan diakhiri.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Ya, Keluar',
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            // 1. Hapus Data Login dari LocalStorage
            localStorage.removeItem('userToken');
            localStorage.removeItem('userName');
            
            // 2. Reset Variabel Global (Penting agar data user sebelumnya tidak nyangkut)
            if (typeof cacheDataGuru !== 'undefined') {
                cacheDataGuru = [];
            }
            
            // 3. Reset Form Login (Agar bersih saat mau login lagi)
            const formLogin = document.getElementById('formLogin');
            if(formLogin) formLogin.reset();
            
            // 4. Bersihkan Tampilan Nama Sekolah di Dashboard (Opsional)
            const schoolNameDisplay = document.getElementById('schoolNameDisplay');
            if(schoolNameDisplay) schoolNameDisplay.innerText = "";

            // 5. Pindah ke Tampilan Login (Tanpa Reload Halaman agar tidak White Screen)
            switchView('view-login');
            
            // 6. Tampilkan Pesan Sukses
            Swal.fire({
              icon: 'success',
              title: 'Berhasil Keluar',
              text: 'Anda telah keluar dari aplikasi.',
              timer: 1500,
              showConfirmButton: false
            });
          }
        });
      }

      /* --- LOGIC DATA SEKOLAH --- */

      function loadDataSekolah() {
        const token = localStorage.getItem('userToken');
        const schoolName = localStorage.getItem('userName');
        
        document.getElementById('dsNamaSekolah').value = schoolName;

        toggleLoading(true);
        
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          toggleLoading(false);
          if (res.status === 'success') {
            const d = res.data;
            
            // BERSIHKAN TANDA KUTIP (') SAAT MENAMPILKAN DATA
            document.getElementById('dsNpsn').value = String(d.npsn).replace(/'/g, '');
            
            // Update untuk NSM
            document.getElementById('dsNsm').value = String(d.nsm).replace(/'/g, ''); 
            
            document.getElementById('dsAlamat').value = d.alamat;
            document.getElementById('dsProvinsi').value = d.provinsi;
            document.getElementById('dsKabupaten').value = d.kabupaten;
            document.getElementById('dsKecamatan').value = d.kecamatan;
            document.getElementById('dsKelurahan').value = d.kelurahan;
            document.getElementById('dsTempatTTD').value = d.tempatTTD;
            document.getElementById('dsKepala').value = d.namaKepala;
            document.getElementById('dsNipKepala').value = String(d.nipKepala).replace(/'/g, '');
            document.getElementById('dsBendahara').value = d.namaBendahara;
            document.getElementById('dsNipBendahara').value = String(d.nipBendahara).replace(/'/g, '');
            document.getElementById('dsTelp').value = String(d.noTelp).replace(/'/g, '');
            document.getElementById('dsEmail').value = d.email;

            /* --- LOGIKA LOAD DANA BOS & PERIODE (TERPISAH) --- */
            const savedBos = d.danaBOS; 
            const savedPeriode = d.periodeAnggaran; // Ambil data periode dari kolom baru
            
            const selectBos = document.getElementById('dsDanaBos');
            const inputBosManual = document.getElementById('dsDanaBosManual');
            const inputPeriodeManual = document.getElementById('dsPeriodeManual');

            // 1. Cek apakah Nama BOS ada di pilihan dropdown standar?
            let isMatch = false;
            for (let i = 0; i < selectBos.options.length; i++) {
              if (selectBos.options[i].value === savedBos) {
                isMatch = true;
                break;
              }
            }

            if (isMatch) {
              // KASUS 1: Pilihan Standar (misal: Dana BOS Tahap 1)
              selectBos.value = savedBos;
              inputBosManual.value = "";       // Kosongkan manual
              inputPeriodeManual.value = "";   // Kosongkan manual
            } else if (savedBos) {
              // KASUS 2: Pilihan Manual (misal: BOS Tulang)
              selectBos.value = "Lainnya";     // Set dropdown ke Lainnya
              inputBosManual.value = savedBos; // Isi kotak nama manual
              inputPeriodeManual.value = savedPeriode; // Isi kotak periode manual
            } else {
              // KASUS 3: Belum ada data
              selectBos.value = "";
            }

            // Update UI (Keterangan text dll)
            cekPeriodeBos();
            /* --- AKHIR LOGIKA LOAD --- */

            document.getElementById('dsJumlahAnggaran').value = formatRibuanInput(d.jumlahAnggaran);
            document.getElementById('dsTahun').value = d.tahunAnggaran;
          } 
        }).getDataSekolah(token);
      }

      function submitDataSekolah() {
        const token = localStorage.getItem('userToken');
        
        // Validasi
        if(!document.getElementById('dsNpsn').value) {
          Swal.fire('Peringatan', 'NPSN Wajib diisi!', 'warning'); return;
        }
        if(!document.getElementById('dsTempatTTD').value) {
          Swal.fire('Peringatan', 'Tempat TTD Wajib diisi!', 'warning'); return;
        }

        /* --- LOGIKA BARU: DATA TERPISAH --- */
        let finalNamaBos = "";
        let finalPeriode = "";

        const dropdownVal = document.getElementById('dsDanaBos').value;

        if (dropdownVal === 'Lainnya') {
            // Jika Manual: Ambil dari Input Ketikan User
            finalNamaBos = document.getElementById('dsDanaBosManual').value.trim();
            finalPeriode = document.getElementById('dsPeriodeManual').value.trim();
            
            if (!finalNamaBos || !finalPeriode) {
                Swal.fire('Peringatan', 'Nama Dana BOS dan Periode manual wajib diisi!', 'warning');
                return;
            }
        } else {
            // Jika Standar: Ambil Nama dari Dropdown, Tentukan Periode Otomatis
            finalNamaBos = dropdownVal;
            
            // Mapping Periode Otomatis (Sesuai fungsi cekPeriodeBos)
            if (dropdownVal === 'Dana BOS Tahap 1') finalPeriode = "Januari - Juni";
            else if (dropdownVal === 'Dana BOS Tahap 2') finalPeriode = "Juli - Desember";
            else if (dropdownVal === 'Dana BOS Triwulan 1') finalPeriode = "Januari - Maret";
            else if (dropdownVal === 'Dana BOS Triwulan 2') finalPeriode = "April - Juni";
            else if (dropdownVal === 'Dana BOS Triwulan 3') finalPeriode = "Juli - September";
            else if (dropdownVal === 'Dana BOS Triwulan 4') finalPeriode = "Oktober - Desember";
        }

        // Susun Form Data
        const formData = {
          namaSekolah: document.getElementById('dsNamaSekolah').value,
          npsn: document.getElementById('dsNpsn').value, 
          nsm: document.getElementById('dsNsm').value,
          alamat: document.getElementById('dsAlamat').value,
          provinsi: document.getElementById('dsProvinsi').value,
          kabupaten: document.getElementById('dsKabupaten').value,
          kecamatan: document.getElementById('dsKecamatan').value,
          kelurahan: document.getElementById('dsKelurahan').value,
          tempatTTD: document.getElementById('dsTempatTTD').value,
          namaKepala: document.getElementById('dsKepala').value,
          nipKepala: document.getElementById('dsNipKepala').value,
          namaBendahara: document.getElementById('dsBendahara').value,
          nipBendahara: document.getElementById('dsNipBendahara').value,
          noTelp: document.getElementById('dsTelp').value,
          email: document.getElementById('dsEmail').value,
          
          // KIRIM TERPISAH
          danaBOS: finalNamaBos,          
          periodeAnggaran: finalPeriode,  
          
          jumlahAnggaran: cleanRibuan(document.getElementById('dsJumlahAnggaran').value),
          tahunAnggaran: document.getElementById('dsTahun').value
        };

        // Kirim
        toggleLoading(true);
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          toggleLoading(false);
          if (res.status === 'success') {
            Swal.fire('Sukses', 'Data Sekolah berhasil disimpan!', 'success');
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanDataSekolah(token, formData);
      }

      /* --- FUNGSI LOGIKA PERIODE BOS (DIPERBARUI PISAH KOLOM) --- */
      function cekPeriodeBos() {
        const select = document.getElementById('dsDanaBos');
        const info = document.getElementById('infoPeriode');
        const wrapManual = document.getElementById('wrapManualBos');
        
        const inputNama = document.getElementById('dsDanaBosManual');
        const inputPeriode = document.getElementById('dsPeriodeManual');
        
        const val = select.value;
        let teksInfo = "";
        let isManual = false;

        // Set teks info periode untuk pilihan standar
        if (val === 'Dana BOS Tahap 1') teksInfo = "Periode Januari - Juni";
        else if (val === 'Dana BOS Tahap 2') teksInfo = "Periode Juli - Desember";
        else if (val === 'Dana BOS Triwulan 1') teksInfo = "Periode Januari - Maret";
        else if (val === 'Dana BOS Triwulan 2') teksInfo = "Periode April - Juni";
        else if (val === 'Dana BOS Triwulan 3') teksInfo = "Periode Juli - September";
        else if (val === 'Dana BOS Triwulan 4') teksInfo = "Periode Oktober - Desember";
        else if (val === 'Lainnya') {
          teksInfo = ""; // Info kosong jika manual, user ketik sendiri
          isManual = true;
        }

        // Tampilkan teks info kecil di bawah dropdown
        info.innerText = teksInfo;

        // Atur Visibilitas Input Manual
        if (isManual) {
          wrapManual.classList.remove('hidden');
          inputNama.required = true;
          inputPeriode.required = true;
        } else {
          wrapManual.classList.add('hidden');
          inputNama.required = false;
          inputPeriode.required = false;
        }
      }

      /* --- LOGIC URAIAN PEKERJAAN (UPDATE) --- */

      // 1. Update Tabel dengan Tombol Edit
      function loadUraianData() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelUraianBody');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = ''; 
            
            if (res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data uraian.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              const cleanNo = String(item.noBukti).replace(/'/g, ''); 
              
              // PENTING: Kita kirim data ke fungsi editUraian saat tombol diklik
              // Kita gunakan escape character untuk string agar aman
              const btnEdit = `
                <button class="btn btn-sm btn-outline-warning me-1" 
                  onclick="modeEdit('${item.id}', '${cleanNo}', '${item.uraian}')" 
                  title="Edit Data">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              `;

              const btnHapus = `
                <button class="btn btn-sm btn-outline-danger" 
                  onclick="hapusUraian('${item.id}')" 
                  title="Hapus Data">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;

              const row = `
                <tr>
                  <td class="fw-bold text-primary">${cleanNo}</td>
                  <td>${item.uraian}</td>
                  <td style="white-space:nowrap;">
                    ${btnEdit} ${btnHapus}
                  </td>
                </tr>
              `;
              tbody.innerHTML += row;
            });

          } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getUraianList(token);
      }

      // 2. Fungsi Mengaktifkan Mode Edit (Data Uraian)
      function modeEdit(id, noBukti, uraian) {
        // Isi form dengan data yang dipilih
        document.getElementById('urId').value = id;
        document.getElementById('urNoBukti').value = noBukti;
        document.getElementById('urNama').value = uraian;

        // Ubah Tampilan Tombol (Jadi Mode Edit - Kuning)
        const btnSimpan = document.getElementById('btnSimpanUraian');
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btnSimpan.classList.remove('btn-primary');
        btnSimpan.classList.add('btn-warning');

        // Munculkan Tombol Batal
        document.getElementById('btnBatalUraian').classList.remove('hidden');

        // PERBAIKAN SCROLL: Gunakan setTimeout agar tidak loncat di mobile
        // block: 'center' akan menempatkan form di tengah layar agar mudah dilihat
        setTimeout(() => {
          const form = document.getElementById('formUraian');
          form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 3. Fungsi Batal Edit (Reset Form)
      function batalEdit() {
        document.getElementById('formUraian').reset();
        document.getElementById('urId').value = ''; // Kosongkan ID

        // Kembalikan Tombol ke Mode Tambah
        const btnSimpan = document.getElementById('btnSimpanUraian');
        btnSimpan.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btnSimpan.classList.add('btn-primary');
        btnSimpan.classList.remove('btn-warning');

        // Sembunyikan Tombol Batal
        document.getElementById('btnBatalUraian').classList.add('hidden');
      }

      // 4. Update Logic Submit (Bisa Tambah Baru atau Edit)
      function submitUraian(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('urId').value; // Cek apakah ada ID?
        
        const formData = {
          id: idEdit, // Kirim ID (kosong jika baru, terisi jika edit)
          noBukti: document.getElementById('urNoBukti').value,
          uraian: document.getElementById('urNama').value
        };

        const btn = document.getElementById('btnSimpanUraian');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Proses...';
        btn.disabled = true;

        // LOGIC CABANG: Jika ada ID -> Edit, Jika tidak -> Baru
        if (idEdit) {
          // --- MODE EDIT ---
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
            finishSubmit(res, btn, originalText);
          }).editUraianItem(token, formData);
        } else {
          // --- MODE BARU ---
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
            finishSubmit(res, btn, originalText);
          }).simpanUraianBaru(token, formData);
        }
      }

      // Helper untuk membersihkan submit handler
      function finishSubmit(res, btn, originalText) {
        btn.innerHTML = originalText;
        btn.disabled = false;

        if (res.status === 'success') {
          batalEdit(); // Reset form & tombol
          loadUraianData(); // Reload tabel
          
          const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
          });
          Toast.fire({ icon: 'success', title: res.message });
        } else {
          Swal.fire({ icon: 'error', title: 'Gagal', html: res.message });
        }
      }

      /* --- LOGIC DATA TOKO --- */

      // 1. Load Data
      function loadTokoData() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTokoBody');
        
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if (res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Belum ada data toko.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              // [FIX] Gunakan escapeJsAttribute untuk data yang masuk ke onclick
              const btnEdit = `
                <button class="btn btn-sm btn-outline-warning" 
                  onclick="modeEditToko('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.jenis)}', '${escapeJsAttribute(item.alamat)}', '${escapeJsAttribute(item.telp)}', '${escapeJsAttribute(item.pemilik)}', '${escapeJsAttribute(item.tempat)}')" 
                  title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              `;
              
              const btnHapus = `
                <button class="btn btn-sm btn-outline-danger" onclick="hapusToko('${item.id}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;

              // [FIX] Gunakan escapeHtml untuk tampilan tabel
              const row = `
                <tr>
                  <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
                  <td>${escapeHtml(item.pemilik)}<br><small class="text-muted">${escapeHtml(item.telp)}</small></td>
                  <td><span class="badge bg-light text-dark border">${escapeHtml(item.jenis)}</span></td>
                  <td>${btnEdit} ${btnHapus}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });
          }
        }).getTokoList(token);
      }

      // 2. Submit (Tambah & Edit)
      function submitToko(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('tkId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('tkNama').value,
          jenis: document.getElementById('tkJenis').value,
          alamat: document.getElementById('tkAlamat').value,
          telp: document.getElementById('tkTelp').value,
          pemilik: document.getElementById('tkPemilik').value,
          tempat: document.getElementById('tkTempat').value
        };

        const btn = document.getElementById('btnSimpanToko');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditToko(); 
            loadTokoData();
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editTokoItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanTokoBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditToko(id, nama, jenis, alamat, telp, pemilik, tempat) {
        // [FIX] Data diterima sudah bersih (karena sudah di-escape di onclick), langsung pakai.
        document.getElementById('tkId').value = id;
        document.getElementById('tkNama').value = nama;
        document.getElementById('tkJenis').value = jenis;
        document.getElementById('tkAlamat').value = alamat;
        document.getElementById('tkTelp').value = telp;
        document.getElementById('tkPemilik').value = pemilik;
        document.getElementById('tkTempat').value = tempat;

        // Ubah tombol menjadi mode Edit
        const btn = document.getElementById('btnSimpanToko');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalToko').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formToko').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditToko() {
        document.getElementById('formToko').reset();
        document.getElementById('tkId').value = '';
        
        const btn = document.getElementById('btnSimpanToko');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan Toko';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalToko').classList.add('hidden');
      }

      // 5. Hapus Toko
      function hapusToko(id) {
        Swal.fire({
          title: 'Hapus Toko?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                loadTokoData();
                Swal.fire('Terhapus!', 'Data toko dihapus.', 'success');
              }
            }).hapusTokoItem(token, id);
          }
        });
      }

      // --- HELPER UNTUK MENCEGAH ERROR TANDA KUTIP DI HTML ---
      function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
      }

      function unescapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'");
      }

      /* --- LOGIC DATA TUKANG --- */

      // 1. Load Data
      function loadTukangData() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTukangBody');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if (res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data tukang.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              // [FIX] Gunakan escapeJsAttribute
              const btnEdit = `
                <button class="btn btn-sm btn-outline-warning" 
                  onclick="modeEditTukang('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.alamat)}')" 
                  title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              `;
              
              const btnHapus = `
                <button class="btn btn-sm btn-outline-danger" onclick="hapusTukang('${item.id}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;

              // [FIX] Gunakan escapeHtml
              const row = `
                <tr>
                  <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
                  <td>${escapeHtml(item.alamat)}</td>
                  <td>${btnEdit} ${btnHapus}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });
          }
        }).getTukangList(token);
      }

      // 2. Submit (Tambah & Edit)
      function submitTukang(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('tkgId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('tkgNama').value,
          alamat: document.getElementById('tkgAlamat').value
        };

        const btn = document.getElementById('btnSimpanTukang');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditTukang(); 
            loadTukangData();
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editTukangItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanTukangBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditTukang(id, nama, alamat) {
        document.getElementById('tkgId').value = id;
        document.getElementById('tkgNama').value = nama;
        document.getElementById('tkgAlamat').value = alamat;

        const btn = document.getElementById('btnSimpanTukang');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalTukang').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formTukang').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditTukang() {
        document.getElementById('formTukang').reset();
        document.getElementById('tkgId').value = '';
        
        const btn = document.getElementById('btnSimpanTukang');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalTukang').classList.add('hidden');
      }

      // 5. Hapus Tukang
      function hapusTukang(id) {
        Swal.fire({
          title: 'Hapus Data Tukang?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                loadTukangData();
                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              }
            }).hapusTukangItem(token, id);
          }
        });
      }

      /* --- LOGIC DATA GURU --- */

      // 1. Load Data
      function loadGuruData() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelGuruBody');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if (res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data guru.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              // [FIX] Gunakan escapeJsAttribute
              const btnEdit = `
                <button class="btn btn-sm btn-outline-warning" 
                  onclick="modeEditGuru('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.nip)}')" 
                  title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              `;
              
              const btnHapus = `
                <button class="btn btn-sm btn-outline-danger" onclick="hapusGuru('${item.id}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;

              // [FIX] Gunakan escapeHtml
              const row = `
                <tr>
                  <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
                  <td>${escapeHtml(item.nip)}</td>
                  <td>${btnEdit} ${btnHapus}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });
          }
        }).getGuruList(token);
      }

      // 2. Submit (Tambah & Edit)
      function submitGuru(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('grId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('grNama').value,
          nip: document.getElementById('grNip').value
        };

        const btn = document.getElementById('btnSimpanGuru');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditGuru(); 
            loadGuruData();
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editGuruItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanGuruBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditGuru(id, nama, nip) {
        document.getElementById('grId').value = id;
        document.getElementById('grNama').value = nama;
        // Handle jika NIP kosong/dash
        document.getElementById('grNip').value = (nip === '-' || !nip) ? '' : nip;

        const btn = document.getElementById('btnSimpanGuru');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalGuru').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formGuru').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditGuru() {
        document.getElementById('formGuru').reset();
        document.getElementById('grId').value = '';
        
        const btn = document.getElementById('btnSimpanGuru');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalGuru').classList.add('hidden');
      }

      // 5. Hapus Guru
      function hapusGuru(id) {
        Swal.fire({
          title: 'Hapus Data Guru?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                loadGuruData();
                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              }
            }).hapusGuruItem(token, id);
          }
        });
      }

      /* --- LOGIC PENGATURAN KOP SURAT --- */

      // 1. Load Gambar yang tersimpan (dari Server)
      function loadKopSettings() {
        const token = localStorage.getItem('userToken');
        const imgEl = document.getElementById('imgPreview');
        const txtEl = document.getElementById('txtNoImage');
        const btnHapus = document.getElementById('btnHapusKop');

        // Reset tampilan dulu
        imgEl.style.display = 'none';
        txtEl.style.display = 'block';
        btnHapus.classList.add('hidden');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success' && res.fileId) {
            // Trik menampilkan gambar dari Drive: gunakan endpoint thumbnail
            // atau export=view. Thumbnail lebih aman dari CORS biasanya.
            const imageUrl = "https://drive.google.com/thumbnail?id=" + res.fileId + "&sz=w1000"; 
            
            imgEl.src = imageUrl;
            imgEl.style.display = 'block';
            txtEl.style.display = 'none';
            btnHapus.classList.remove('hidden'); // Munculkan tombol hapus
          }
        }).getKopSurat(token);
      }

      // 2. Preview Gambar Lokal (Sebelum Upload)
      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const imgEl = document.getElementById('imgPreview');
            const txtEl = document.getElementById('txtNoImage');
            
            imgEl.src = e.target.result;
            imgEl.style.display = 'block';
            txtEl.style.display = 'none';
          }
          
          reader.readAsDataURL(input.files[0]);
        }
      }

      // 3. Upload Gambar ke Server
      function uploadKop(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileKop');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        
        // Validasi Ukuran (Misal Max 2MB agar script tidak timeout)
        if (file.size > 2 * 1024 * 1024) {
          Swal.fire('File Terlalu Besar', 'Maksimal ukuran file adalah 2MB', 'warning');
          return;
        }

        const btn = document.getElementById('btnSimpanKop');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengupload...';
        btn.disabled = true;

        // Baca File sebagai Base64
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function() {
          // Ambil string base64 murni (hapus 'data:image/jpeg;base64,')
          const rawBase64 = reader.result.split(',')[1]; 
          const payload = {
            base64: rawBase64,
            mimeType: file.type
          };

          const token = localStorage.getItem('userToken');

          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (res.status === 'success') {
              Swal.fire('Sukses', 'Kop Surat berhasil disimpan!', 'success');
              document.getElementById('formKop').reset();
              loadKopSettings(); // Reload gambar dari server
            } else {
              Swal.fire({ icon: 'error', title: 'Gagal Upload', html: res.message });
            }
          }).simpanKopSurat(token, payload);
        };
      }

      // 4. Hapus Kop Surat
      function aksiHapusKop() {
        Swal.fire({
          title: 'Hapus Kop Surat?',
          text: "Kop surat akan dihapus dari sistem.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if (res.status === 'success') {
                Swal.fire('Terhapus', 'Kop surat telah dihapus', 'success');
                loadKopSettings(); // Refresh tampilan
              } else {
                Swal.fire({ icon: 'error', title: 'Gagal Menghapus', html: res.message });
              }
            }).hapusKopSurat(token);
          }
        });
      }

      /* --- LOGIC TRANSAKSI BELANJA (DIPERBARUI) --- */

      // 1. Tab Switching (Diperbarui untuk load data list)
      function bukaTab(tabName) {
        // Hide semua content
        document.getElementById('tab-content-toko').classList.add('hidden');
        document.getElementById('tab-content-tukang').classList.add('hidden');
        document.getElementById('tab-content-guru').classList.add('hidden'); // Baru
        
        // Reset active buttons
        document.getElementById('tab-btn-toko').classList.remove('active');
        document.getElementById('tab-btn-tukang').classList.remove('active');
        document.getElementById('tab-btn-guru').classList.remove('active'); // Baru

        // Show selected
        document.getElementById('tab-content-' + tabName).classList.remove('hidden');
        document.getElementById('tab-btn-' + tabName).classList.add('active');

        // LOAD DATA LIST TRANSAKSI
        if(tabName === 'toko') loadTransaksiData('TOKO');
        if(tabName === 'tukang') loadTransaksiData('TUKANG');
        if(tabName === 'guru') loadTransaksiData('GURU'); // Baru
      }

      // 2. Load Data List Transaksi (PERBAIKAN: HANDLING TANDA KUTIP)
      function loadTransaksiData(tipe) {
        const token = localStorage.getItem('userToken');
        
        // 1. TENTUKAN TARGET TABLE BODY
        let targetId;
        if (tipe === 'TOKO') targetId = 'listTransaksiToko';
        else if (tipe === 'TUKANG') targetId = 'listTransaksiTukang';
        else targetId = 'listTransaksiGuru'; // Target untuk Guru

        const tbody = document.getElementById(targetId);

        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
            if (res.status === 'success') {
                tbody.innerHTML = '';
                if(res.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada riwayat transaksi.</td></tr>';
                    return;
                }

                res.data.forEach(item => {
                    // --- PERBAIKAN DISINI ---
                    // Tambahkan .replace(/'/g, "%27") agar aman dari tanda kutip satu
                    const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");
                    
                    // Tentukan parameter tipe untuk fungsi edit
                    let tipeKecil;
                    if (tipe === 'TOKO') tipeKecil = 'toko';
                    else if (tipe === 'TUKANG') tipeKecil = 'tukang';
                    else tipeKecil = 'guru';

                    const btnDetail = `
                        <button class="btn btn-sm btn-outline-info me-1" 
                            onclick="lihatDetailTransaksi('${dataJson}')" title="Lihat Rincian">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;

                    const btnEdit = `
                        <button class="btn btn-sm btn-outline-warning me-1" 
                            onclick="modeEditTransaksi('${tipeKecil}', '${dataJson}')" title="Edit">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    `;
                    const btnHapus = `
                        <button class="btn btn-sm btn-outline-danger" 
                            onclick="hapusTransaksi('${item.id}', '${tipeKecil}')" title="Hapus">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;

                    // Kolom Ke-3 berbeda untuk Guru (Bukan Pihak Ketiga, tapi Keterangan/Kosong)
                    const displayPihak = item.pihakKetiga; 

                    const row = `
                        <tr>
                            <td>${item.tanggalDisplay}</td> 
                            <td><div class="text-truncate" style="max-width: 200px;" title="${item.uraian}">${item.uraian}</div></td>
                            <td>${displayPihak}</td> 
                            <td class="fw-bold text-success">${formatRupiahJS(item.total)}</td>
                            <td style="white-space: nowrap;">${btnDetail} ${btnEdit} ${btnHapus}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
        }).getTransaksiList(token, tipe);
      }

      // 3. Mode Edit Transaksi (FUNGSI BARU & KOMPLEKS)
      function modeEditTransaksi(tipe, encodedData) {
        // 1. Decode Data JSON
        const data = JSON.parse(decodeURIComponent(encodedData));
        
        // 2. Mapping ID Form Header & Button berdasarkan Tipe
        let formId, tableId, btnSimpanId, btnBatalId;
        
        if (tipe === 'toko') {
          formId = 'formBelanjaToko';
          tableId = 'tabelItemToko';
          btnSimpanId = 'btnSimpanTokoTrans';
          btnBatalId = 'btnBatalTokoTrans';
          
          // Isi Header Toko
          document.getElementById('trTokoId').value = data.id;
          document.getElementById('trTokoTanggal').value = data.tanggal;
          setSelectValue('trTokoUraian', data.uraian);
          setSelectValue('trTokoNama', data.pihakKetiga);
          setSelectValue('trTokoPemesan', data.pemesan);
          
        } else if (tipe === 'tukang') {
          formId = 'formBelanjaTukang';
          tableId = 'tabelItemTukang';
          btnSimpanId = 'btnSimpanTukangTrans';
          btnBatalId = 'btnBatalTukangTrans';
          
          // Isi Header Tukang
          document.getElementById('trTukangId').value = data.id;
          document.getElementById('trTukangTanggal').value = data.tanggal;
          setSelectValue('trTukangUraian', data.uraian);
          setSelectValue('trTukangNama', data.pihakKetiga);
          setSelectValue('trTukangPemesan', data.pemesan);
                
        } else if (tipe === 'guru') {
          formId = 'formBelanjaGuru';
          tableId = 'tabelItemGuru';
          btnSimpanId = 'btnSimpanGuruTrans';
          btnBatalId = 'btnBatalGuruTrans';
          
          // Isi Header Guru
          document.getElementById('trGuruId').value = data.id;
          document.getElementById('trGuruTanggal').value = data.tanggal;
          setSelectValue('trGuruUraian', data.uraian);
          
          if(data.pihakKetiga === '-' || data.pihakKetiga === 'Honorarium Guru') {
              document.getElementById('trGuruKeterangan').value = '';
          } else {
              document.getElementById('trGuruKeterangan').value = data.pihakKetiga;
          }
        }

        // 3. Reset & Gambar Ulang Tabel Rincian (PENTING: Logika Render)
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = ''; // Kosongkan tabel dulu

        if (data.items && data.items.length > 0) {
          data.items.forEach(item => {
            const rowId = new Date().getTime() + Math.random();
            let colNamaInput = '';

            // --- LOGIKA KOLOM NAMA (Dropdown Guru vs Input Biasa) ---
            if (tipe === 'guru') {
              let isManual = true; 
              // Cek apakah nama guru ada di cache data sekolah
              if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
                  cacheDataGuru.forEach(g => {
                      if (g.nama.trim() === item.nama.trim()) isManual = false;
                  });
              }

              if (isManual) {
                  // Jika nama manual (tidak ada di master data guru)
                  const val = String(item.nama).replace(/"/g, '&quot;');
                  colNamaInput = `
                    <div class="input-group">
                      <input type="text" class="form-control item-nama" value="${val}" placeholder="Nama Guru (Manual)">
                      <button class="btn btn-outline-secondary" type="button" onclick="resetKeDropdown(this)" title="Kembali ke Pilihan">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  `;
              } else {
                  // Jika nama ada di master data, tampilkan sebagai dropdown
                  let opts = '<option value="">-- Pilih Guru --</option>';
                  opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
                  
                  if (typeof cacheDataGuru !== 'undefined') {
                    cacheDataGuru.forEach(g => {
                        const isSelected = (g.nama.trim() === item.nama.trim()) ? 'selected' : '';
                        const val = String(g.nama).replace(/"/g, '&quot;');
                        opts += `<option value="${val}" ${isSelected}>${g.nama}</option>`;
                    });
                  }
                  colNamaInput = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
              }
            } else {
              // Input Biasa (Untuk Toko & Tukang)
              const val = String(item.nama).replace(/"/g, '&quot;');
              colNamaInput = `<input type="text" class="form-control item-nama" value="${val}" placeholder="Nama Barang">`;
            }

            // --- LOGIKA FORMAT HARGA (Titik Ribuan) ---
            const hargaTampil = formatRibuanInput(item.harga);

            // --- TEMPLATE BARIS TABEL ---
            // --- TEMPLATE BARIS TABEL ---
            const row = `
              <tr id="row-${rowId}">
                <td>${colNamaInput}</td>
                
                <td>
                  <input type="number" class="form-control item-vol" value="${item.vol}" min="1" oninput="hitungBaris(this, '${tipe}')">
                </td>
                
                <td style="position: relative;">
                    <div class="autocomplete-wrapper">
                      <input type="text" class="form-control item-sat" value="${item.sat || ''}" placeholder="Satuan"
                        oninput="handleInputSatuan(this)" 
                        onfocus="handleInputSatuan(this)" 
                        autocomplete="off">
                      <div class="suggestion-list" style="display:none; min-width: 150px;"></div>
                    </div>
                </td>
                <td>
                  <input type="text" class="form-control item-harga" value="${hargaTampil}" oninput="hitungBaris(this, '${tipe}')">
                </td>
                
                <td>
                  <input type="text" class="form-control item-jumlah-display" readonly value="${formatRupiahJS(item.jumlah)}">
                  <input type="hidden" class="item-jumlah-value" value="${item.jumlah}">
                </td>
                
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="hapusBaris(this, '${tipe}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
            
            tbody.insertAdjacentHTML('beforeend', row);
          });
        } else {
          // Jika data item kosong (error case), buat 1 baris baru
          tambahBaris(tipe);
        }

        // 4. Hitung Ulang & Update UI Tombol
        hitungTotalSemua(tipe);

        const btnSimpan = document.getElementById(btnSimpanId);
        const btnBatal = document.getElementById(btnBatalId);
        
        // Ubah tombol jadi warna kuning (Mode Edit)
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btnSimpan.classList.remove('btn-success');
        btnSimpan.classList.add('btn-warning');
        
        btnBatal.classList.remove('hidden');

        // --- 5. PERBAIKAN SCROLL UNTUK MOBILE ---
        // Gunakan setTimeout agar rendering tabel selesai dulu sebelum scroll
        // Gunakan 'block: start' agar form mulai dari bagian atas layar
        setTimeout(() => {
          document.getElementById(formId).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 400); 
      }

      // Helper untuk set value select yang mungkin mengandung karakter spesial
      function setSelectValue(id, value) {
          const select = document.getElementById(id);
          // Cari option yang text/valuenya cocok
          for (let i = 0; i < select.options.length; i++) {
              // Decode HTML entities jika perlu, atau bandingkan langsung
              if (select.options[i].value === value || select.options[i].text === value) {
                  select.selectedIndex = i;
                  break;
              }
          }
      }

      // 4. Batal Edit (Reset Form & Mode)
      function batalEditTransaksi(tipe) {
        // 1. Reset Isi Form & Tabel
        resetFormTransaksi(tipe);

        // 2. Mapping ID Elemen berdasarkan Tipe
        let idHidden, btnSimpanId, btnBatalId;

        if (tipe === 'toko') {
          idHidden = 'trTokoId';
          btnSimpanId = 'btnSimpanTokoTrans';
          btnBatalId = 'btnBatalTokoTrans';
        } else if (tipe === 'tukang') {
          idHidden = 'trTukangId';
          btnSimpanId = 'btnSimpanTukangTrans';
          btnBatalId = 'btnBatalTukangTrans';
        } else { // guru
          idHidden = 'trGuruId';
          btnSimpanId = 'btnSimpanGuruTrans';
          btnBatalId = 'btnBatalGuruTrans';
        }

        // 3. Kosongkan ID Hidden (Indikator Mode Edit)
        document.getElementById(idHidden).value = '';

        // 4. Kembalikan Tombol Simpan ke Awal (Hijau)
        const btnSimpan = document.getElementById(btnSimpanId);
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Transaksi';
        btnSimpan.classList.remove('btn-warning');
        btnSimpan.classList.add('btn-success');
        btnSimpan.disabled = false;

        // 5. Sembunyikan Tombol Batal
        const btnBatal = document.getElementById(btnBatalId);
        btnBatal.classList.add('hidden');
      }

      // 5. Hapus Transaksi
      function hapusTransaksi(id, tipe) {
        Swal.fire({
          title: 'Hapus Transaksi?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                Swal.fire('Terhapus!', 'Transaksi dihapus.', 'success');
                loadTransaksiData(tipe); // Reload tabel
              } else {
                Swal.fire({ icon: 'error', title: 'Gagal Menghapus', html: res.message });
              }
            }).hapusTransaksiItem(token, id);
          }
        });
      }

      // --- LOGIC SIMPAN YANG DIPERBARUI (HANDLE EDIT & BARU) ---
      function simpanTransaksi(tipe) {
        // 1. Tentukan ID Elemen berdasarkan Tipe Tab
        let tableId, idHidden, btnId;

        if (tipe === 'toko') {
          tableId = 'tabelItemToko';
          idHidden = 'trTokoId';
          btnId = 'btnSimpanTokoTrans';
        } else if (tipe === 'tukang') {
          tableId = 'tabelItemTukang';
          idHidden = 'trTukangId';
          btnId = 'btnSimpanTukangTrans';
        } else { // guru
          tableId = 'tabelItemGuru';
          idHidden = 'trGuruId';
          btnId = 'btnSimpanGuruTrans';
        }

        // 2. Ambil Baris Data & ID Edit (jika ada)
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const idEdit = document.getElementById(idHidden).value;

        // Validasi: Pastikan ada item barang/jasa/guru yang diinput
        if (rows.length === 0) {
          Swal.fire('Eror', 'Belum ada rincian yang dimasukkan!', 'error');
          return;
        }

        // 3. Ambil Data Header Form (Tanggal, Uraian, dll)
        let tgl, uraian, pihak, pemesan, total;

        if (tipe === 'guru') {
          // Logika Khusus Tab Honor Guru
          tgl = document.getElementById('trGuruTanggal').value;
          uraian = document.getElementById('trGuruUraian').value;
          
          // PERBAIKAN DISINI: Ambil dari input Keterangan
          // Jika kosong, isi tanda strip (-)
          const ketVal = document.getElementById('trGuruKeterangan').value;
          pihak = ketVal ? ketVal : "-"; 
          
          pemesan = "-"; // Pemesan tetap strip karena rincian nama ada di tabel
          total = document.getElementById('trGuruTotalValue').value;
        } else {
          // Logika Umum (Toko & Tukang)
          const prefix = (tipe === 'toko') ? 'trToko' : 'trTukang';
          
          tgl = document.getElementById(prefix + 'Tanggal').value;
          uraian = document.getElementById(prefix + 'Uraian').value;
          pihak = document.getElementById(prefix + 'Nama').value;     // Nama Toko / Tukang
          pemesan = document.getElementById(prefix + 'Pemesan').value; // Nama Guru Pemesan
          total = document.getElementById(prefix + 'TotalValue').value;
        }

        // 4. Validasi Form Header
        if (!tgl || !uraian) {
          Swal.fire('Data Belum Lengkap', 'Harap lengkapi Tanggal dan Uraian!', 'warning');
          return;
        }
        
        // Validasi tambahan khusus Toko & Tukang (Pihak Ketiga & Pemesan wajib diisi)
        if (tipe !== 'guru' && (!pihak || !pemesan)) {
          Swal.fire('Data Belum Lengkap', 'Pihak Ketiga dan Pemesan wajib diisi!', 'warning');
          return;
        }

        // 5. Ambil Rincian Item dari Tabel
        let items = [];
        rows.forEach(row => {
          items.push({
            nama: row.querySelector('.item-nama').value, 
            vol: row.querySelector('.item-vol').value,
            sat: row.querySelector('.item-sat').value,
            
            // --- PERUBAHAN PENTING DISINI ---
            // Bersihkan titik sebelum disimpan ke database
            harga: cleanRibuan(row.querySelector('.item-harga').value),
            
            jumlah: row.querySelector('.item-jumlah-value').value
          });
        });

        // 6. Siapkan Payload Data
        const payload = {
          id: idEdit, // Kosong jika Baru, Terisi jika Edit
          tipe: tipe.toUpperCase(), // 'TOKO', 'TUKANG', atau 'GURU'
          tanggal: tgl,
          uraian: uraian,
          pihakKetiga: pihak,
          pemesan: pemesan,
          items: items,
          total: total
        };

        // 7. Proses Simpan ke Server (Google Apps Script)
        const token = localStorage.getItem('userToken');
        const btnSimpan = document.getElementById(btnId);
        const txtAsli = btnSimpan.innerHTML;
        
        // Ubah tombol jadi loading
        btnSimpan.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...';
        btnSimpan.disabled = true;

        const handleResult = function(res) {
          // Kembalikan tombol
          btnSimpan.innerHTML = txtAsli;
          btnSimpan.disabled = false;
          
          if (res.status === 'success') {
            Swal.fire({
              icon: 'success',
              title: 'Berhasil!',
              text: res.message,
              showConfirmButton: false,
              timer: 1500
            });
            
            // Reset Form & Reload Tabel Riwayat
            batalEditTransaksi(tipe); 
            loadTransaksiData(tipe.toUpperCase());
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Transaksi', html: res.message });
          }
        };

        // Percabangan: Panggil fungsi Edit atau Simpan Baru
        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handleResult).editTransaksiItem(token, payload);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handleResult).simpanTransaksiBaru(token, payload);
        }
      }

      // 2. Load Dropdown Options
      function loadTransaksiOptions() {
        const token = localStorage.getItem('userToken');
        
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            const d = res.data;
            
            // 1. SIMPAN DATA KE CACHE
            cacheDataGuru = d.guru; 
            cacheSatuan = d.satuan;

            // Helper isi select header
            const isiSelect = (id, data) => {
              const el = document.getElementById(id);
              if(!el) return;
              const currentVal = el.value; 
              
              el.innerHTML = '<option value="">-- Pilih --</option>';
              data.forEach(item => {
                const val = String(item.nama).replace(/"/g, '&quot;'); 
                el.innerHTML += `<option value="${val}">${item.nama}</option>`;
              });
              
              if(currentVal) el.value = currentVal;
            };
            
            const uraianOps = d.uraian.map(u => ({nama: u.uraian}));
            
            // Isi Dropdown Header
            isiSelect('trTokoUraian', uraianOps);
            isiSelect('trTokoNama', d.toko);
            isiSelect('trTokoPemesan', d.guru);

            isiSelect('trTukangUraian', uraianOps);
            isiSelect('trTukangNama', d.tukang);
            isiSelect('trTukangPemesan', d.guru);
            
            isiSelect('trGuruUraian', uraianOps); 

            // 2. UPDATE DROPDOWN DI TABEL RINCIAN GURU
            const dropdownsDiTabel = document.querySelectorAll('#tabelItemGuru .item-nama');
            
            dropdownsDiTabel.forEach(select => {
              // Cek apakah elemen ini adalah SELECT (karena bisa jadi sudah berubah jadi INPUT TEXT)
              if (select.tagName === 'SELECT') {
                  const valSebelumnya = select.value;
                  
                  // Susun Opsi: Default -> LAINNYA -> Data Guru
                  let opts = '<option value="">-- Pilih Guru --</option>';
                  opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>'; // MENU BARU
                  
                  cacheDataGuru.forEach(g => {
                    const val = String(g.nama).replace(/"/g, '&quot;');
                    opts += `<option value="${val}">${g.nama}</option>`;
                  });
                  
                  select.innerHTML = opts;
                  if(valSebelumnya) select.value = valSebelumnya;
              }
            });

          }
        }).getAllOptions(token);
      }

      // --- FUNGSI GANTI DROPDOWN JADI INPUT TEXT (DENGAN TOMBOL X) ---
      function cekInputManual(selectElement) {
        if (selectElement.value === 'MANUAL_INPUT') {
          const parentTd = selectElement.parentElement;
          
          // Kita gunakan fitur Input Group Bootstrap
          // Class 'item-nama' tetap wajib ada di input agar terbaca saat simpan
          const htmlInputGroup = `
            <div class="input-group">
              <input type="text" class="form-control item-nama" placeholder="Ketik Nama Guru..." autofocus>
              <button class="btn btn-outline-secondary" type="button" onclick="resetKeDropdown(this)" title="Kembali ke Pilihan">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          
          parentTd.innerHTML = htmlInputGroup;
          
          // Otomatis fokus ke input
          parentTd.querySelector('input').focus();
        }
      }

      // --- FUNGSI KEMBALIKAN KE DROPDOWN ---
      function resetKeDropdown(btnElement) {
        // Cari elemen TD pembungkusnya
        const parentTd = btnElement.closest('td');
        
        // Susun Ulang Option Dropdown dari Cache
        let opts = '<option value="">-- Pilih Guru --</option>';
        opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
        
        if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
          cacheDataGuru.forEach(g => {
            const val = String(g.nama).replace(/"/g, '&quot;');
            opts += `<option value="${val}">${g.nama}</option>`;
          });
        }
        
        // Kembalikan ke bentuk Select
        const selectHtml = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
        parentTd.innerHTML = selectHtml;
      }

      // 3. Tambah Baris Dinamis
      function tambahBaris(tipe) {
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 
                        (tipe === 'tukang') ? 'tabelItemTukang' : 'tabelItemGuru';
        
        const tbody = document.getElementById(tableId).querySelector('tbody');
        const rowId = new Date().getTime() + Math.random();
        
        let colPertamaHtml = '';

        if (tipe === 'guru') {
          // 1. Susun Opsi Default
          let optionsGuru = '<option value="">-- Pilih Guru --</option>';
          // 2. Tambah Opsi Lainnya
          optionsGuru += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
          
          // 3. Isi Data Guru (jika cache sudah ready)
          if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
            cacheDataGuru.forEach(g => {
              const val = String(g.nama).replace(/"/g, '&quot;');
              optionsGuru += `<option value="${val}">${g.nama}</option>`;
            });
          }
          
          // 4. Tambahkan event onchange="cekInputManual(this)"
          colPertamaHtml = `<select class="form-select item-nama" onchange="cekInputManual(this)">${optionsGuru}</select>`;
        } else {
          colPertamaHtml = `<input type="text" class="form-control item-nama" placeholder="Nama Barang/Jasa">`;
        }
        
        // GANTI BAGIAN ROW DI BAWAH INI:
        const row = `
          <tr id="row-${rowId}">
            <td>${colPertamaHtml}</td>
            <td><input type="number" class="form-control item-vol" value="1" min="1" oninput="hitungBaris(this, '${tipe}')"></td>
            
            <td style="position: relative;"> 
              <div class="autocomplete-wrapper">
                <input type="text" class="form-control item-sat" placeholder="Satuan" 
                  oninput="handleInputSatuan(this)" 
                  onfocus="handleInputSatuan(this)" 
                  autocomplete="off">
                <div class="suggestion-list" style="display:none; min-width: 150px;"></div>
              </div>
            </td>
            <td><input type="text" class="form-control item-harga" placeholder="0" oninput="hitungBaris(this, '${tipe}')"></td>
            <td>
              <input type="text" class="form-control item-jumlah-display" readonly value="0">
              <input type="hidden" class="item-jumlah-value" value="0">
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="hapusBaris(this, '${tipe}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
        
        tbody.insertAdjacentHTML('beforeend', row);
      }

      // 4. Hapus Baris
      function hapusBaris(btn, tipe) {
        const row = btn.closest('tr');
        row.remove();
        hitungTotalSemua(tipe); // Recalculate total
      }

      // 5. Kalkulasi Per Baris (Vol * Harga) - DENGAN FORMAT RIBUAN
      function hitungBaris(input, tipe) {
        const row = input.closest('tr');
        
        // A. Jika yang diketik adalah kolom Harga, format tampilannya
        if (input.classList.contains('item-harga')) {
          // Simpan posisi kursor (opsional, agar nyaman saat edit di tengah)
          // Untuk simpelnya, kita langsung format value-nya
          input.value = formatRibuanInput(input.value);
        }

        // B. Ambil Nilai untuk Kalkulasi (Gunakan cleanRibuan)
        const vol = parseFloat(row.querySelector('.item-vol').value) || 0;
        
        // Ambil teks harga (misal: "15.000"), bersihkan jadi 15000
        const hargaStr = row.querySelector('.item-harga').value;
        const harga = cleanRibuan(hargaStr); 
        
        const total = vol * harga;
        
        // Tampilkan format Rupiah di input readonly (Total Jumlah)
        row.querySelector('.item-jumlah-display').value = formatRupiahJS(total);
        // Simpan nilai asli di hidden input
        row.querySelector('.item-jumlah-value').value = total;
        
        hitungTotalSemua(tipe);
      }

      // 6. Hitung Grand Total
      function hitungTotalSemua(tipe) {
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 
                        (tipe === 'tukang') ? 'tabelItemTukang' : 'tabelItemGuru';
                        
        const inputs = document.querySelectorAll(`#${tableId} .item-jumlah-value`);
        
        let grandTotal = 0;
        inputs.forEach(el => { grandTotal += parseFloat(el.value) || 0; });

        // Update Tampilan Total Bawah
        let elDisplay, elValue;
        if(tipe === 'toko') {
          elDisplay = 'trTokoTotalDisplay'; elValue = 'trTokoTotalValue';
        } else if (tipe === 'tukang') {
          elDisplay = 'trTukangTotalDisplay'; elValue = 'trTukangTotalValue';
        } else {
          elDisplay = 'trGuruTotalDisplay'; elValue = 'trGuruTotalValue';
        }
        
        document.getElementById(elDisplay).innerText = formatRupiahJS(grandTotal);
        document.getElementById(elValue).value = grandTotal;
      }

      // Helper Format Rupiah JS
      function formatRupiahJS(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }

      // Helper: Reset Form
      function resetFormTransaksi(tipe) {
        let formId, tableId, dispId, valId;

        // Mapping ID Form & Total
        if (tipe === 'toko') {
          formId='formBelanjaToko'; tableId='tabelItemToko'; dispId='trTokoTotalDisplay'; valId='trTokoTotalValue';
        } else if (tipe === 'tukang') {
          formId='formBelanjaTukang'; tableId='tabelItemTukang'; dispId='trTukangTotalDisplay'; valId='trTukangTotalValue';
        } else { // GURU
          formId='formBelanjaGuru'; tableId='tabelItemGuru'; dispId='trGuruTotalDisplay'; valId='trGuruTotalValue';
        }
        
        // 1. Reset Form Header
        document.getElementById(formId).reset();

        // TAMBAHAN KHUSUS: Pastikan Textarea Keterangan Guru bersih
        if(tipe === 'guru') {
          document.getElementById('trGuruKeterangan').value = '';
        }
        
        // 2. Kosongkan Tabel Rincian
        document.querySelector(`#${tableId} tbody`).innerHTML = '';
        
        // 3. Reset Angka Total
        document.getElementById(dispId).innerText = 'Rp 0';
        document.getElementById(valId).value = 0;
        
        // 4. Tambahkan 1 Baris Kosong Default
        // Ini penting agar dropdown guru / input manual ter-render ulang dengan benar
        tambahBaris(tipe);
      }

      // --- FUNGSI POPUP DETAIL TRANSAKSI ---
      function lihatDetailTransaksi(encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        
        // 1. Buat Header HTML untuk Info Dasar
        let htmlContent = `
          <div class="text-start mb-3" style="font-size: 0.9rem;">
            <table class="table table-borderless table-sm mb-0">
              <tr>
                <td width="30%" class="fw-bold">Tanggal</td>
                <td>: ${data.tanggalDisplay}</td> 
              </tr>
              <tr>
                <td class="fw-bold">Uraian</td>
                <td>: ${data.uraian}</td>
              </tr>
              <tr>
                <td class="fw-bold">Pihak Ketiga</td>
                <td>: ${data.pihakKetiga} (Tipe: ${data.tipe})</td>
              </tr>
              <tr>
                <td class="fw-bold">Pemesan</td>
                <td>: ${data.pemesan}</td>
              </tr>
            </table>
          </div>
        `;

        // 2. Buat Tabel Rincian Barang
        htmlContent += `
          <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle text-nowrap" style="font-size: 0.85rem;">
              <thead class="table-light text-center">
                <tr>
                  <th>Nama Barang / Item</th>
                  <th width="10%">Vol</th>
                  <th width="10%">Sat</th>
                  <th width="20%">Harga</th>
                  <th width="25%">Jumlah</th>
                </tr>
              </thead>
              <tbody>
        `;

        // Loop item barang
        if (data.items && data.items.length > 0) {
          data.items.forEach(item => {
            htmlContent += `
              <tr>
                <td class="text-start">${item.nama}</td>
                <td class="text-center">${item.vol}</td>
                <td class="text-center">${item.sat}</td>
                <td class="text-end">${formatRupiahJS(item.harga)}</td>
                <td class="text-end fw-bold">${formatRupiahJS(item.jumlah)}</td>
              </tr>
            `;
          });
        } else {
          htmlContent += `<tr><td colspan="5" class="text-center text-muted">Tidak ada rincian item.</td></tr>`;
        }

        // Tutup Tabel & Tambah Total
        htmlContent += `
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="4" class="text-end fw-bold">TOTAL KESELURUHAN</td>
                  <td class="text-end fw-bold fs-6 text-primary">${formatRupiahJS(data.total)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;

        // 3. Tampilkan dengan SweetAlert
        Swal.fire({
          title: 'Rincian Transaksi',
          html: htmlContent,
          width: '600px',
          showCloseButton: true,
          showConfirmButton: false, // Hanya tombol close X diatas atau klik luar
          focusConfirm: false
        });
      }

      /* --- LOGIKA MANAJEMEN NOMOR SURAT --- */

      let globalAutoSettings = { toko: {active: false}, tukang: {active: false} };

      function bukaTabSurat(tipe) {
        // 1. Reset Class Active pada tombol Tab
        document.getElementById('tab-surat-toko').classList.remove('active');
        document.getElementById('tab-surat-tukang').classList.remove('active');
        document.getElementById('tab-surat-setting').classList.remove('active');
        
        // 2. Ambil Elemen View (List vs Setting)
        const viewList = document.getElementById('view-surat-list');
        const viewSetting = document.getElementById('view-surat-setting');
        
        if (tipe === 'setting') {
          // --- MODE SETTING ---
          document.getElementById('tab-surat-setting').classList.add('active');
          
          // Sembunyikan List, Tampilkan Setting
          viewList.classList.add('hidden');
          viewSetting.classList.remove('hidden');
          
          // Load data setting dari server
          loadSettingNomor();

        } else {
          // --- MODE LIST (Toko / Tukang) ---
          if (tipe === 'toko') {
              document.getElementById('tab-surat-toko').classList.add('active');
          } else {
              document.getElementById('tab-surat-tukang').classList.add('active');
          }
          
          // Tampilkan List, Sembunyikan Setting
          viewList.classList.remove('hidden');
          viewSetting.classList.add('hidden');

          // Load Data Tabel
          loadDataSurat(tipe);
          
          // Refresh cache setting diam-diam agar saat popup dibuka datanya sudah siap
          refreshAutoSettingsCache(); 
        }
      }

      // 2. Load Data List
      // GANTI FUNGSI INI DI Index.html
      function loadDataSurat(tipe) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelSuratBody');
        
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data transaksi...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if(res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Belum ada data transaksi ' + tipe + '.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              const s = item.dataSurat; 
              let statusBadge = '<span class="badge bg-secondary">Belum Diatur</span>';
              
              if (s) {
                if (s.permintaan && s.baPembayaran) {
                    statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
                } else {
                    statusBadge = '<span class="badge bg-warning text-dark">Sebagian</span>';
                }
              }

              // --- PERBAIKAN UTAMA DISINI ---
              // Tambahkan .replace(/'/g, "%27") agar tanda kutip satu tidak merusak onclick
              const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");
              
              const btnLihat = `
                <button class="btn btn-sm btn-info text-white me-1" 
                  onclick="lihatNomorSurat('${tipe}', '${dataJson}')" title="Lihat Daftar Nomor">
                  <i class="fas fa-eye"></i>
                </button>
              `;

              const btnKelola = `
                <button class="btn btn-sm btn-outline-primary" 
                  onclick="bukaModalSurat('${tipe}', '${dataJson}')">
                  <i class="fas fa-edit me-1"></i> Kelola
                </button>
              `;

              const row = `
                <tr>
                  <td>${item.tanggalDisplay}</td> 
                  <td><div class="text-truncate" style="max-width:250px;">${item.uraian}</div></td>
                  <td>${item.pihakKetiga}</td>
                  <td>${statusBadge}</td>
                  <td style="white-space:nowrap;">${btnLihat} ${btnKelola}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });

          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe.toUpperCase()); 
      }

      // TAMBAHKAN FUNGSI INI (Fungsi Baru untuk Popup Lihat Nomor)
      // GANTI FUNGSI INI DI Index.html
      function lihatNomorSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const s = data.dataSurat || {}; // Data Surat tersimpan

        let htmlContent = '<div class="text-start px-2">';
        
        // Helper styling baris info (Konsisten dengan lihatTanggalSurat)
        const rowInfo = (label, valHtml) => {
            return `
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-caret-right text-primary me-2"></i>
                        <div class="text-secondary small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">${label}</div>
                    </div>
                    <div class="ps-3 border-start border-3 border-light ms-1" style="font-size: 0.95rem;">${valHtml}</div>
                </div>
            `;
        };

        // Helper khusus format text nomor (Monospace font agar rapi seperti kode)
        const fmtNomor = (val) => {
            return val ? `<span class="fw-bold text-dark font-monospace">${val}</span>` : '<span class="text-muted fst-italic small bg-light px-2 rounded">- Belum diatur -</span>';
        };

        // [BAGIAN BARU] Detail Utama (Uraian & Pihak Ketiga)
        htmlContent += rowInfo('Uraian Pekerjaan', `<span class="fw-bold text-dark">${data.uraian}</span>`);
        
        let labelPihak = 'Pihak Ketiga';
        if(tipe === 'guru') labelPihak = 'Keterangan / Honorarium';
        
        htmlContent += rowInfo(labelPihak, `<span class="fw-bold text-dark">${data.pihakKetiga}</span>`);

        // Garis Pembatas
        htmlContent += '<hr class="border-secondary opacity-25 my-3" style="border-style: dashed;">';

        // [BAGIAN NOMOR SURAT]
        htmlContent += rowInfo('Surat Permintaan', fmtNomor(s.permintaan));
        
        // Penawaran hanya untuk Toko
        if (tipe === 'toko') {
            htmlContent += rowInfo('Surat Penawaran', fmtNomor(s.penawaran));
        }
        
        htmlContent += rowInfo('Berita Acara Pemeriksaan', fmtNomor(s.baPemeriksaan));
        htmlContent += rowInfo('Berita Acara Serah Terima', fmtNomor(s.baSerahTerima));
        htmlContent += rowInfo('Berita Acara Pembayaran', fmtNomor(s.baPembayaran));
        
        htmlContent += '</div>';

        // Tampilkan SweetAlert
        Swal.fire({
            title: `<span class="fs-5"><i class="fas fa-list-ol text-primary me-2"></i> Daftar Nomor Surat</span>`,
            html: htmlContent,
            showCloseButton: true,
            showConfirmButton: false,
            width: '500px',
            background: '#fff',
            customClass: {
              popup: 'rounded-4 shadow-lg'
            }
        });
      }

      // 3. Buka Modal & Isi Form
      let modalSuratBS = null; // Instance Bootstrap Modal

      // GANTI FUNGSI INI
      function bukaModalSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const s = data.dataSurat || {}; 
        const rawData = s.raw || {}; 
        
        // [PERBAIKAN 1] Ambil Data Tanggal Spesifik Dokumen
        const tDocs = data.dataTanggal || {};
        
        // Mapping Tanggal Spesifik (Fallback ke Tanggal Transaksi jika kosong)
        const dateMap = {
          permintaan: tDocs.permintaan || data.tanggal,
          penawaran: tDocs.penawaran || data.tanggal,
          baPemeriksaan: tDocs.baPemeriksaan || data.tanggal,
          baSerahTerima: tDocs.baSerahTerima || data.tanggal,
          baPembayaran: tDocs.baPembayaran || data.tanggal
        };

        // Simpan Mapping Tanggal ke Dataset Form agar bisa dibaca oleh simpanSurat()
        const formEl = document.getElementById('formInputSurat');
        formEl.dataset.dateMap = JSON.stringify(dateMap);

        document.getElementById('suratTransId').value = data.id;
        document.getElementById('suratTransTipe').value = tipe;
        document.getElementById('suratTransTanggal').value = data.tanggal; 

        const config = (tipe === 'toko') ? globalAutoSettings.toko : globalAutoSettings.tukang;
        const isAuto = config && config.active;

        const container = document.getElementById('containerInputSurat');
        container.innerHTML = ''; 

        // Toggle Alert
        if(isAuto) {
          document.getElementById('alertManualMode').classList.add('hidden');
          document.getElementById('alertAutoMode').classList.remove('hidden');
        } else {
          document.getElementById('alertManualMode').classList.remove('hidden');
          document.getElementById('alertAutoMode').classList.add('hidden');
        }

        let fields = [
          { key: 'permintaan', label: 'Surat Permintaan', icon: 'fa-envelope-open-text', format: config?.permintaan },
          { key: 'baPemeriksaan', label: 'BA Pemeriksaan', icon: 'fa-clipboard-check', format: config?.pemeriksaan },
          { key: 'baSerahTerima', label: 'BA Serah Terima', icon: 'fa-handshake', format: config?.bast },
          { key: 'baPembayaran', label: 'BA Pembayaran', icon: 'fa-money-check-alt', format: config?.bayar }
        ];

        if(tipe === 'toko') {
          fields.splice(1, 0, { key: 'penawaran', label: 'Surat Penawaran', icon: 'fa-file-invoice-dollar', format: config?.penawaran });
        }

        fields.forEach(f => {
          const currentValue = s[f.key] || '';
          let htmlInput = '';
          
          if (isAuto && f.format && f.format.trim() !== '') {
            // === MODE OTOMATIS ===
            const regex = /\[(.*?)\]/g;
            let matches = [...f.format.matchAll(regex)]; 
            
            let inputGroup = '';
            let placeholdersFound = false;

            const uniqueTags = [];
            matches.forEach(m => {
              const tag = m[1];
              if(!uniqueTags.includes(tag)) uniqueTags.push(tag);
            });

            uniqueTags.forEach(tag => {
              if(tag === 'bulan' || tag === 'tahun') return; // Skip bulan/tahun karena otomatis

              placeholdersFound = true;
              let savedVal = rawData[f.key] && rawData[f.key][tag] ? rawData[f.key][tag] : '';

              // --- DESAIN INPUT TAG ---
              inputGroup += `
                <div class="col-auto">
                  <div class="input-group shadow-sm" style="min-width: 180px;">
                    <span class="input-group-text bg-primary text-white border-primary fw-bold" style="font-size: 0.85rem;">
                      <i class="fas fa-pen fa-xs me-1 opacity-50"></i> ${tag}
                    </span>
                    <input type="text" class="form-control auto-input fw-bold text-dark" 
                          data-key="${f.key}" data-tag="${tag}"
                          value="${savedVal}" placeholder="..." style="font-size: 1rem; border-color: #cfe2ff;">
                  </div>
                </div>
              `;
            });

            const previewId = `preview-${f.key}`;
            
            if(placeholdersFound) {
              htmlInput = `
                <div class="p-3 bg-white rounded border" style="box-shadow: 0 2px 6px rgba(0,0,0,0.02);">
                  <div class="row g-2 align-items-center mb-2">${inputGroup}</div>
                  <div class="mt-2 px-3 py-2 rounded d-flex align-items-center" style="background-color: #f1f8ff; border-left: 4px solid #0d6efd;">
                    <div class="me-3 text-primary opacity-75"><i class="fas fa-eye"></i></div>
                    <div>
                      <div class="text-uppercase fw-bold text-primary opacity-50" style="font-size: 0.65rem; letter-spacing: 1px;">Hasil Preview</div>
                      <div id="${previewId}" class="fw-bold text-dark" style="font-size: 0.9rem; font-family: 'Consolas', monospace;">-</div>
                    </div>
                  </div>
                </div>
              `;
            } else {
              htmlInput = `
                <div class="p-2 bg-white rounded border">
                  <input type="hidden" class="auto-input" data-key="${f.key}" data-tag="DUMMY"> 
                  <div class="px-3 py-2 rounded d-flex align-items-center" style="background-color: #f8f9fa; border-left: 4px solid #6c757d;">
                    <div class="me-3 text-secondary opacity-50"><i class="fas fa-eye"></i></div>
                    <div>
                      <div class="text-uppercase fw-bold text-secondary opacity-50" style="font-size: 0.65rem; letter-spacing: 1px;">Hasil Preview (Otomatis)</div>
                      <div id="${previewId}" class="fw-bold text-dark" style="font-size: 0.9rem; font-family: 'Consolas', monospace;">-</div>
                    </div>
                  </div>
                </div>
              `;
            }

          } else {
            // === MODE MANUAL ===
            htmlInput = `
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light border-end-0"><i class="fas fa-keyboard text-muted"></i></span>
                <input type="text" class="form-control manual-input" id="manual_${f.key}" value="${currentValue}" placeholder="Ketik nomor surat lengkap disini...">
              </div>
            `;
          }

          const rowHtml = `
            <div class="mb-4">
              <label class="form-label fw-bold text-dark mb-2 d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">
                  <i class="fas ${f.icon}"></i>
                </div>
                ${f.label}
              </label>
              <div class="ps-1">${htmlInput}</div>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', rowHtml);
        });

        // [PERBAIKAN 2] Listener Preview - Pass dateMap, bukan tglTransaksi single
        if(isAuto) {
          const inputs = container.querySelectorAll('.auto-input');
          inputs.forEach(inp => {
            inp.addEventListener('input', () => updatePreviews(config, dateMap));
          });
          updatePreviews(config, dateMap);
        }

        const el = document.getElementById('modalSurat');
        modalSuratBS = new bootstrap.Modal(el);
        modalSuratBS.show();
      }

      // GANTI FUNGSI INI
      function updatePreviews(config, dateMap) {
        // Mapping Key HTML ID ke Key Config & Key DateMap
        const keyMap = {
          'permintaan': 'permintaan',
          'penawaran': 'penawaran',
          'baPemeriksaan': 'pemeriksaan', // HTML: baPemeriksaan -> Config: pemeriksaan
          'baSerahTerima': 'bast',        // HTML: baSerahTerima -> Config: bast
          'baPembayaran': 'bayar'         // HTML: baPembayaran -> Config: bayar
        };

        // Mapping Key HTML ke Key DateMap (karena penamaan di DateMap sedikit beda di code bukaModalSurat)
        const dateKeyMap = {
          'permintaan': 'permintaan',
          'penawaran': 'penawaran',
          'baPemeriksaan': 'baPemeriksaan',
          'baSerahTerima': 'baSerahTerima', 
          'baPembayaran': 'baPembayaran'
        };

        // Loop setiap field yang punya preview
        const previewSpans = document.querySelectorAll('[id^="preview-"]');
        previewSpans.forEach(span => {
          const htmlKey = span.id.replace('preview-', ''); // misal: baSerahTerima
          const configKey = keyMap[htmlKey]; // misal: bast
          
          // Ambil format mentah dari config
          let formatStr = config ? config[configKey] : ''; 

          if(!formatStr) {
              span.innerText = "-";
              return;
          }

          // [LOGIKA BARU] Ambil Tanggal SPESIFIK untuk field ini
          const specificDateKey = dateKeyMap[htmlKey];
          const dateString = dateMap[specificDateKey]; // Ambil tanggal dari map
          
          let bulan = '00', tahun = '0000';
          if(dateString) {
            const d = new Date(dateString);
            bulan = String(d.getMonth() + 1).padStart(2, '0');
            tahun = d.getFullYear();
          }

          // Replace Bulan & Tahun sesuai tanggal dokumen tersebut
          formatStr = formatStr.replace(/\[bulan\]/g, bulan).replace(/\[tahun\]/g, tahun);

          // Replace Input Tags (Nomor Urut, Kode, dll)
          const relatedInputs = document.querySelectorAll(`.auto-input[data-key="${htmlKey}"]`);
          relatedInputs.forEach(inp => {
            const tag = inp.getAttribute('data-tag');
            const val = inp.value || `[${tag}]`; 
            
            if(tag !== 'DUMMY') {
              const regex = new RegExp(`\\[${tag}\\]`, 'g');
              formatStr = formatStr.replace(regex, val);
            }
          });

          span.innerText = formatStr;
        });
      }

      // 4. Simpan Data Surat
      // GANTI FUNGSI INI
      function simpanSurat(e) {
        e.preventDefault();
        
        const tipe = document.getElementById('suratTransTipe').value;
        const id = document.getElementById('suratTransId').value;
        
        // Ambil Config Toko/Tukang
        const config = (tipe === 'toko') ? globalAutoSettings.toko : globalAutoSettings.tukang;
        const isAuto = config && config.active;

        let dataSurat = {
          raw: {} 
        };
        
        // [PERBAIKAN] Ambil Map Tanggal dari Dataset Form
        const formEl = document.getElementById('formInputSurat');
        let dateMap = {};
        try {
          dateMap = JSON.parse(formEl.dataset.dateMap);
        } catch(err) {
          // Fallback jika error, pakai tanggal transaksi global
          const tglGlobal = document.getElementById('suratTransTanggal').value;
          dateMap = {
            permintaan: tglGlobal, penawaran: tglGlobal, baPemeriksaan: tglGlobal, 
            baSerahTerima: tglGlobal, baPembayaran: tglGlobal
          };
        }

        // Helper untuk parsing tanggal
        const getBulanTahun = (dateStr) => {
          if(!dateStr) return { b: '00', t: '0000' };
          const d = new Date(dateStr);
          return {
            b: String(d.getMonth() + 1).padStart(2, '0'),
            t: d.getFullYear()
          };
        };

        if (isAuto) {
          // === MODE OTOMATIS (Bisa Campuran Auto & Manual) ===
          
          // Fungsi internal untuk memproses format placeholder
          // Menerima parameter 'keyDate' untuk menentukan tanggal mana yang dipakai
          const processAutoFormat = (key, format, keyDate) => {
              const tglDoc = dateMap[keyDate]; // Ambil tanggal spesifik
              const { b, t } = getBulanTahun(tglDoc);

              let result = format.replace(/\[bulan\]/g, b).replace(/\[tahun\]/g, t);
              
              // Ambil input kecil (auto-input)
              const inputs = document.querySelectorAll(`.auto-input[data-key="${key}"]`);
              
              // Inisialisasi object raw jika belum ada
              if (!dataSurat.raw[key]) dataSurat.raw[key] = {};

              inputs.forEach(inp => {
                  const tag = inp.getAttribute('data-tag');
                  const val = inp.value.trim();
                  
                  // Simpan nilai mentah
                  if(tag !== 'DUMMY') {
                      dataSurat.raw[key][tag] = val; 
                      const regex = new RegExp(`\\[${tag}\\]`, 'g');
                      result = result.replace(regex, val);
                  }
              });
              return result;
          };

          const getFinalValue = (key, formatSetting, keyDateMap) => {
              if (formatSetting && formatSetting.trim() !== '') {
                  return processAutoFormat(key, formatSetting, keyDateMap);
              } else {
                  const elManual = document.getElementById('manual_' + key);
                  return elManual ? elManual.value : '';
              }
          };

          // Eksekusi dengan Mapping Tanggal yang Benar
          // Parameter ke-3 adalah key di dalam dateMap
          dataSurat.permintaan = getFinalValue('permintaan', config.permintaan, 'permintaan');
          dataSurat.baPemeriksaan = getFinalValue('baPemeriksaan', config.pemeriksaan, 'baPemeriksaan');
          dataSurat.baSerahTerima = getFinalValue('baSerahTerima', config.bast, 'baSerahTerima');
          dataSurat.baPembayaran = getFinalValue('baPembayaran', config.bayar, 'baPembayaran');
          
          if(tipe === 'toko') {
              dataSurat.penawaran = getFinalValue('penawaran', config.penawaran, 'penawaran');
          }

        } else {
          // === MODE MANUAL TOTAL ===
          dataSurat.permintaan = document.getElementById('manual_permintaan').value;
          dataSurat.baPemeriksaan = document.getElementById('manual_baPemeriksaan').value;
          dataSurat.baSerahTerima = document.getElementById('manual_baSerahTerima').value;
          dataSurat.baPembayaran = document.getElementById('manual_baPembayaran').value;
          
          if(tipe === 'toko') {
              dataSurat.penawaran = document.getElementById('manual_penawaran').value;
          }
        }

        // --- PROSES KIRIM KE SERVER ---
        const payload = { id: id, dataSurat: dataSurat };
        
        const btn = document.getElementById('btnSimpanSurat');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const token = localStorage.getItem('userToken');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            if(modalSuratBS) modalSuratBS.hide();
            Swal.fire({ 
              icon: 'success', title: 'Tersimpan', 
              text: 'Data nomor surat berhasil diperbarui.', timer: 1500, showConfirmButton: false 
            });
            loadDataSurat(tipe);
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanDataSurat(token, payload);
      }

      /* --- LOGIKA MANAJEMEN TANGGAL SURAT --- */

      // 1. Tab Switching
      function bukaTabTanggal(tipe) {
        document.getElementById('tab-tgl-toko').classList.remove('active');
        document.getElementById('tab-tgl-tukang').classList.remove('active');
        
        if (tipe === 'toko') {
          document.getElementById('tab-tgl-toko').classList.add('active');
        } else {
          document.getElementById('tab-tgl-tukang').classList.add('active');
        }

        loadDataTanggal(tipe);
      }

      // 2. Load Data List untuk Tanggal
      // GANTI FUNGSI INI DI Index.html
      function loadDataTanggal(tipe) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTanggalBody');
        
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if(res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Belum ada data transaksi ' + tipe + '.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              const t = item.dataTanggal; 
              let statusBadge = '<span class="badge bg-secondary">Belum Diatur</span>';
              
              if (t && t.baPembayaran) {
                statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
              } else if (t) {
                statusBadge = '<span class="badge bg-warning text-dark">Sebagian</span>';
              }

              // --- PERBAIKAN UTAMA DISINI ---
              const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");
              
              const btnLihat = `
                <button class="btn btn-sm btn-info text-white me-1" 
                  onclick="lihatTanggalSurat('${tipe}', '${dataJson}')" title="Lihat Daftar Tanggal">
                  <i class="fas fa-eye"></i>
                </button>
              `;

              const btnAtur = `
                <button class="btn btn-sm btn-outline-success" 
                  onclick="bukaModalTanggal('${tipe}', '${dataJson}')">
                  <i class="fas fa-calendar-check me-1"></i> Atur
                </button>
              `;

              const row = `
                <tr>
                  <td>${item.tanggalDisplay}</td> 
                  <td><div class="text-truncate" style="max-width:250px;">${item.uraian}</div></td>
                  <td>${item.pihakKetiga}</td>
                  <td>${statusBadge}</td>
                  <td style="white-space:nowrap;">${btnLihat} ${btnAtur}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });

          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe.toUpperCase());
      }

      // TAMBAHKAN FUNGSI INI (Fungsi Baru untuk Popup Lihat Tanggal)
      // GANTI FUNGSI INI DI Index.html
      function lihatTanggalSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const t = data.dataTanggal || {}; 

        // Helper Format Tanggal Indonesia (dd-mm-yyyy)
        const fmt = (dateStr) => {
            if(!dateStr) return '<span class="text-muted fst-italic small bg-light px-2 rounded">- Belum diatur -</span>';
            
            const d = new Date(dateStr);
            if(isNaN(d.getTime())) return '-';
            
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            
            return `<span class="fw-bold text-dark font-monospace">${dd}-${mm}-${yyyy}</span>`;
        };

        let htmlContent = '<div class="text-start px-2">';
        
        // Reuse styling baris info
        const rowInfo = (label, valHtml) => {
            return `
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-caret-right text-success me-2"></i>
                        <div class="text-secondary small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">${label}</div>
                    </div>
                    <div class="ps-3 border-start border-3 border-light ms-1" style="font-size: 0.95rem;">${valHtml}</div>
                </div>
            `;
        };

        // [BAGIAN BARU] Info Detail Utama (Uraian & Pihak Ketiga)
        htmlContent += rowInfo('Uraian Pekerjaan', `<span class="fw-bold text-dark">${data.uraian}</span>`);
        
        // Label Pihak Ketiga menyesuaikan Tipe
        let labelPihak = 'Pihak Ketiga';
        if(tipe === 'guru') labelPihak = 'Keterangan / Honorarium';
        
        htmlContent += rowInfo(labelPihak, `<span class="fw-bold text-dark">${data.pihakKetiga}</span>`);

        // Garis Pembatas (Divider)
        htmlContent += '<hr class="border-secondary opacity-25 my-3" style="border-style: dashed;">';

        // [BAGIAN TANGGAL]
        // 1. Tanggal Permintaan
        const tglMinta = t.permintaan || data.tanggal;
        htmlContent += rowInfo('Tgl. Surat Permintaan', fmt(tglMinta));
        
        // 2. Tanggal Penawaran (Khusus Toko)
        if (tipe === 'toko') {
            htmlContent += rowInfo('Tgl. Surat Penawaran', fmt(t.penawaran));
        }
        
        // 3. Tanggal Berita Acara
        htmlContent += rowInfo('Tgl. BA Pemeriksaan', fmt(t.baPemeriksaan));
        htmlContent += rowInfo('Tgl. BA Serah Terima', fmt(t.baSerahTerima));
        htmlContent += rowInfo('Tgl. BA Pembayaran', fmt(t.baPembayaran));
        
        htmlContent += '</div>';

        // Tampilkan SweetAlert
        Swal.fire({
            title: `<span class="fs-5"><i class="fas fa-calendar-alt text-success me-2"></i> Rincian Tanggal Dokumen</span>`,
            html: htmlContent,
            showCloseButton: true,
            showConfirmButton: false,
            width: '500px',
            background: '#fff',
            customClass: {
              popup: 'rounded-4 shadow-lg'
            }
        });
      }

      // 3. Buka Modal Tanggal (UPDATE: Dengan Validasi Tanggal Minimum)
      let modalTanggalBS = null;

      function bukaModalTanggal(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const t = data.dataTanggal || {}; 

        // Set ID Hidden
        document.getElementById('tglTransId').value = data.id;
        document.getElementById('tglTransTipe').value = tipe;

        // Reset Form
        document.getElementById('formInputTanggal').reset();

        // --- LOGIKA VALIDASI TANGGAL ---
        // Ambil Tanggal Transaksi (Format YYYY-MM-DD dari backend)
        const minDate = data.tanggal; 
        
        // Daftar ID Input yang ingin dibatasi
        const dateFields = [
          'tglSuratPenawaran', 
          'tglBaPemeriksaan', 
          'tglBaSerahTerima', 
          'tglBaPembayaran'
        ];

        // Loop setiap field untuk set atribut 'min'
        dateFields.forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            // Set batas minimum pemilihan tanggal
            el.setAttribute('min', minDate);
            
            // Opsional: Tambahkan event listener jika user mengetik manual (bukan klik kalender)
            el.onchange = function() {
              if(this.value && this.value < minDate) {
                Swal.fire('Tanggal Tidak Valid', 'Tanggal tidak boleh kurang dari tanggal transaksi (' + minDate + ')', 'warning');
                this.value = minDate; // Reset ke tanggal minimal
              }
            };
          }
        });

        // -------------------------------

        // Field Kondisional (Penawaran)
        const wrapPenawaran = document.getElementById('wrapTglPenawaran');
        if (tipe === 'toko') {
          wrapPenawaran.classList.remove('hidden');
          document.getElementById('tglSuratPenawaran').value = t.penawaran || '';
        } else {
          wrapPenawaran.classList.add('hidden');
          document.getElementById('tglSuratPenawaran').value = '';
        }

        // Isi Tanggal Permintaan (Readonly & Sesuai Transaksi)
        document.getElementById('tglSuratPermintaan').value = data.tanggal;

        // Isi Field Lainnya (jika ada di database)
        document.getElementById('tglBaPemeriksaan').value = t.baPemeriksaan || '';
        document.getElementById('tglBaSerahTerima').value = t.baSerahTerima || '';
        document.getElementById('tglBaPembayaran').value = t.baPembayaran || '';

        // Tampilkan Modal
        const el = document.getElementById('modalTanggal');
        modalTanggalBS = new bootstrap.Modal(el);
        modalTanggalBS.show();
      }

      // 4. Simpan Data Tanggal
      function simpanTanggal(e) {
        e.preventDefault();
        
        const tipe = document.getElementById('tglTransTipe').value;
        const id = document.getElementById('tglTransId').value;

        // Ambil Data Form
        const dataTanggal = {
          permintaan: document.getElementById('tglSuratPermintaan').value, // Ambil dari input readonly
          penawaran: document.getElementById('tglSuratPenawaran').value,
          baPemeriksaan: document.getElementById('tglBaPemeriksaan').value,
          baSerahTerima: document.getElementById('tglBaSerahTerima').value,
          baPembayaran: document.getElementById('tglBaPembayaran').value
        };

        const payload = {
          id: id,
          dataTanggal: dataTanggal
        };

        const btn = document.getElementById('btnSimpanTanggal');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const token = localStorage.getItem('userToken');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            if(modalTanggalBS) modalTanggalBS.hide();
            
            Swal.fire({
              icon: 'success', title: 'Tersimpan', 
              text: 'Data tanggal dokumen berhasil diperbarui.',
              timer: 1500, showConfirmButton: false
            });

            loadDataTanggal(tipe);

          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanTanggalSurat(token, payload);
      }

      /* --- HELPER FORMAT ANGKA INPUT (FIXED COPY-PASTE) --- */

      // Mengubah input "10000" atau "10.000,00" menjadi tampilan "10.000"
      function formatRibuanInput(angka) {
        if (!angka && angka !== 0) return '';
        
        let str = String(angka);

        // 1. [PERBAIKAN UTAMA] Cek Koma (Desimal)
        // Jika ada koma, buang semua angka dibelakangnya.
        // Contoh: "100.000,00" -> diambil "100.000" saja.
        if (str.indexOf(',') > -1) {
          str = str.split(',')[0];
        }
        
        // 2. Hapus karakter selain angka (0-9)
        // Contoh: "Rp 100.000" -> "100000"
        let raw = str.replace(/[^\d]/g, '');
        
        if (!raw) return '';
        
        // 3. Format jadi 1.000.000 (Style Indonesia)
        return new Intl.NumberFormat('id-ID').format(raw);
      }

      // Mengubah tampilan "10.000" menjadi angka murni 10000 (untuk kalkulasi matematika)
      function cleanRibuan(str) {
        if (!str) return 0;
        
        let s = String(str);
        
        // 1. Buang desimal jika ada (Sama seperti di atas)
        if (s.indexOf(',') > -1) {
          s = s.split(',')[0];
        }
        
        // 2. Hapus tanda titik (ribuan) dan simbol mata uang
        // Kita sisakan angka dan tanda minus (jika ada diskon/potongan)
        let bersih = s.replace(/\./g, '').replace(/[^\d-]/g, '');
        
        return parseFloat(bersih) || 0;
      }

      /* --- LOGIKA DASHBOARD (UPDATE LENGKAP) --- */

      function loadDashboardStats() {
        const token = localStorage.getItem('userToken');
        
        document.getElementById('dashAnggaran').innerText = '...';
        
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            const d = res.data;
            const p = d.profile || {}; // Data Profil Sekolah

            // 1. Render Statistik (Sama seperti sebelumnya)
            const anggaran = parseFloat(d.anggaran) || 0;
            const pengeluaran = parseFloat(d.pengeluaran) || 0;
            const jmlTrans = d.jumlahTransaksi || 0;
            const sisa = anggaran - pengeluaran;

            document.getElementById('dashAnggaran').innerText = formatRupiahJS(anggaran);
            document.getElementById('dashPengeluaran').innerText = formatRupiahJS(pengeluaran);
            document.getElementById('dashSisa').innerText = formatRupiahJS(sisa);
            document.getElementById('dashJmlTrans').innerText = jmlTrans + " Item";

            // Pewarnaan Kartu Sisa (Logika Kontras)
            const cardSisa = document.getElementById('cardSisaAnggaran');
            const titleSisa = cardSisa.querySelector('h6');
            const iconSisa = cardSisa.querySelector('i');
            const angkaSisa = cardSisa.querySelector('h3');
            const ketSisa = cardSisa.querySelector('small');
            
            cardSisa.className = 'card p-3 shadow-sm h-100'; 

            if (sisa > 0) {
              cardSisa.style.backgroundColor = '#ffc107'; 
              if(titleSisa) titleSisa.className = 'mb-0 text-dark fw-bold opacity-75';
              if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-dark opacity-50';
              if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-dark';
              if(ketSisa)   ketSisa.className = 'text-dark opacity-75';
            } else if (sisa === 0) {
              cardSisa.style.backgroundColor = '#198754';
              if(titleSisa) titleSisa.className = 'mb-0 text-white-50';
              if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-white opacity-50';
              if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-white';
              if(ketSisa)   ketSisa.className = 'text-white-50';
            } else {
              cardSisa.style.backgroundColor = '#dc3545';
              if(titleSisa) titleSisa.className = 'mb-0 text-white-50';
              if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-white opacity-50';
              if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-white';
              if(ketSisa)   ketSisa.className = 'text-white-50';
            }

            // 2. Render Profil Sekolah (UPDATE LENGKAP & AMAN)
            document.getElementById('dashNamaSekolah').innerText = p.nama || '-';
            document.getElementById('dashNpsn').innerText = p.npsn || '-';
            document.getElementById('dashNsm').innerText = p.nsm || '-';
            document.getElementById('dashAlamat').innerText = p.alamat || '-';
            
            // Update Wilayah (Pakai || '-' agar tidak undefined)
            document.getElementById('dashKelurahan').innerText = p.kelurahan || '-';
            document.getElementById('dashKecamatan').innerText = p.kecamatan || '-';
            
            // Format Kabupaten & Provinsi
            let kabProv = p.kabupaten || '-';
            if(p.provinsi) kabProv += ' - ' + p.provinsi;
            document.getElementById('dashKabupaten').innerText = kabProv;

            // Update Kontak
            document.getElementById('dashTelp').innerText = p.noTelp || '-';
            document.getElementById('dashEmail').innerText = p.email || '-';
            
            // Pejabat Sekolah
            document.getElementById('dashKepala').innerText = p.kepala || '-';
            document.getElementById('dashNipKepala').innerText = p.nipKepala || '-';
            document.getElementById('dashBendahara').innerText = p.bendahara || '-';
            document.getElementById('dashNipBendahara').innerText = p.nipBendahara || '-';

          }
        }).getDashboardStats(token);
      }

      /* --- LOGIKA MENU CETAK PDF --- */

      // 1. Fungsi Ganti Tab Cetak
      /* --- UPDATE FUNGSI INI --- */
      function bukaTabCetak(tipe) {
        // Reset Tab Active Class
        document.getElementById('tab-cetak-toko').classList.remove('active');
        document.getElementById('tab-cetak-guru').classList.remove('active');
        document.getElementById('tab-cetak-tukang').classList.remove('active');
        document.getElementById('tab-cetak-setting').classList.remove('active'); // Baru
        
        // Set Active Tab Button
        document.getElementById('tab-cetak-' + tipe).classList.add('active');

        // Sembunyikan semua tabel view
        document.querySelectorAll('.view-cetak').forEach(el => el.classList.add('hidden'));
        
        // Munculkan tabel/view yang dipilih
        document.getElementById('view-cetak-' + tipe).classList.remove('hidden');

        // Load Data sesuai tipe
        if (tipe === 'setting') {
          loadTemplateSettings(); // Fungsi Baru
        } else {
          loadListCetak(tipe);
        }
      }

      // 2. Load Data ke Tabel Cetak
      function loadListCetak(tipeRaw) {
        const tipe = tipeRaw.toUpperCase(); 
        const targetId = 'tbody-cetak-' + tipeRaw;
        const tbody = document.getElementById(targetId);
        const token = localStorage.getItem('userToken');

        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Sedang memuat data...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if(res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Tidak ada data transaksi.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              // --- PERBAIKAN DISINI ---
              // Tambahkan .replace(/'/g, "%27") agar aman dari tanda kutip satu
              const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");
              
              let displayPihak = item.pihakKetiga;
              if (tipeRaw === 'guru' && (displayPihak === '-' || displayPihak === 'Honorarium Guru')) {
                  displayPihak = "-"; 
              }

              // --- LOGIKA TOMBOL BARU ---
              
              // 1. Tombol Lihat (Selalu Ada)
              const btnLihat = `
                <button class="btn btn-sm btn-outline-info me-1" 
                  onclick="lihatDetailTransaksi('${dataJson}')" title="Lihat Rincian">
                  <i class="fas fa-eye"></i>
                </button>
              `;

              let btnGenerate = '';
              let btnCetak = '';

              // Cek apakah PDF ID sudah ada dari Backend
              if (item.pdfId && item.pdfId !== "") {
                // KONDISI SUDAH GENERATE:
                // 1. Tombol Cetak (Membuka file lama)
                const linkPdf = `https://drive.google.com/file/d/${item.pdfId}/view?usp=sharing`;
                
                btnCetak = `
                   <button class="btn btn-sm btn-dark me-1" 
                     onclick="window.open('${linkPdf}', '_blank')" title="Cetak / Buka PDF">
                     <i class="fas fa-print"></i>
                   </button>
                `;

                // 2. Tombol Generate Ulang (Icon Sync/Refresh)
                // Kita gunakan dataJson yang sudah diperbaiki di sini
                btnGenerate = `
                  <button class="btn btn-sm btn-outline-danger" 
                    onclick="prosesCetakPDF('${item.id}', '${dataJson}', '${tipeRaw}')" title="Generate Ulang (Hapus Lama)">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                `;

              } else {
                // KONDISI BELUM GENERATE:
                // Hanya tombol Generate (Icon Cog/Gear)
                btnGenerate = `
                  <button class="btn btn-sm btn-warning" 
                    onclick="prosesCetakPDF('${item.id}', '${dataJson}', '${tipeRaw}')" title="Generate PDF Baru">
                    <i class="fas fa-cog"></i>
                  </button>
                `;
              }

              const row = `
                <tr>
                  <td>${item.tanggalDisplay}</td>
                  <td><div class="text-truncate" style="max-width: 250px;">${item.uraian}</div></td>
                  <td>${displayPihak}</td>
                  <td class="fw-bold">${formatRupiahJS(item.total)}</td>
                  <td style="white-space: nowrap;">${btnLihat} ${btnCetak} ${btnGenerate}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });

          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe);
      }

      /* --- FUNGSI PROSES CETAK PDF (UPDATE) --- */
      // Tambahkan parameter 'tipeTab' agar kita bisa reload tabel yang benar setelah selesai
      function prosesCetakPDF(id, encodedData, tipeTab) {
        
        const data = JSON.parse(decodeURIComponent(encodedData));
        const token = localStorage.getItem('userToken');

        // Cek teks konfirmasi (Baru vs Ulang)
        let judul = 'Generate PDF?';
        let teks = `Sistem akan membuat laporan PDF untuk: ${data.uraian}`;
        let tombolWarna = '#ffc107'; // Kuning (Warning)
        let tombolTeks = '<i class="fas fa-cog"></i> Generate';

        // Jika sudah ada PDF ID (Generate Ulang)
        if (data.pdfId) {
            judul = 'Generate Ulang?';
            teks = `Peringatan: File PDF lama akan <b>DIHAPUS</b> dan diganti dengan yang baru. Lanjutkan?`;
            tombolWarna = '#dc3545'; // Merah
            tombolTeks = '<i class="fas fa-sync-alt"></i> Ya, Ganti File';
        }

        Swal.fire({
          title: judul,
          html: teks,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: tombolWarna,
          cancelButtonColor: '#6c757d',
          confirmButtonText: tombolTeks,
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            
            Swal.fire({
              title: 'Sedang Memproses...',
              html: 'Mohon tunggu, sedang menyusun dokumen PDF...',
              allowOutsideClick: false,
              didOpen: () => { Swal.showLoading() }
            });

            let tipeTransaksi = data.tipe || 'TOKO';
            const namaMadrasah = document.getElementById('dashNamaSekolah').innerText || 'Madrasah';
            const nomorSurat = (data.dataSurat && data.dataSurat.permintaan) ? data.dataSurat.permintaan : 'DRAFT';

            const formUntukPDF = {
              idTransaksi: id,               // [PENTING] Kirim ID Transaksi untuk update DB
              tipe: tipeTransaksi,       
              nomorSurat: nomorSurat,
              pihakKetiga: data.pihakKetiga, 
              pemesan: data.pemesan,
              uraian: data.uraian,           
              tanggal: data.tanggal,         
              namaMadrasah: namaMadrasah,
              total: data.total,             
              items: data.items              
            };

            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if (res.status === 'success') {
                Swal.fire({
                  icon: 'success',
                  title: 'Selesai!',
                  text: 'Dokumen PDF berhasil dibuat/diperbarui.',
                  footer: `<a href="${res.url}" target="_blank" class="btn btn-primary btn-lg"><i class="fas fa-external-link-alt me-2"></i>Buka PDF Sekarang</a>`,
                  showConfirmButton: true,
                  confirmButtonText: 'Oke'
                }).then(() => {
                    // [PENTING] Reload Tabel agar tombol berubah (Muncul icon print, generate jadi refresh)
                    loadListCetak(tipeTab);
                });
              } else {
                // Gunakan properti 'html' bukan text biasa
                Swal.fire({
                  icon: 'error',
                  title: 'Terjadi Kesalahan',
                  html: res.message, // <--- Ini kuncinya agar HTML di Kode.gs terbaca
                  width: '500px'     // Opsional: Agar popup sedikit lebih lebar
                });
              }
            }).generateLPJ(token, formUntukPDF);
          }
        });
      }

      /* --- FITUR FILTER TABEL --- */

      // 1. Inisialisasi Opsi Tahun (Dipanggil saat window.onload)
      function initFilterTahun() {
        const currentYear = new Date().getFullYear();
        const startYear = currentYear - 2;
        const endYear = currentYear + 1;
        
        // UPDATE ARRAY IDS INI: Tambahkan 3 ID baru di akhir (fltTahun_cetak_...)
        const ids = [
          'fltTahun_toko', 'fltTahun_guru', 'fltTahun_tukang', 
          'fltTahun_surat', 'fltTahun_tgl',
          'fltTahun_cetak_toko', 'fltTahun_cetak_guru', 'fltTahun_cetak_tukang' // <-- Tambahan Baru
        ];
        
        ids.forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            el.innerHTML = '<option value="">Semua Tahun</option>';
            for(let y = startYear; y <= endYear; y++) {
              el.innerHTML += `<option value="${y}">${y}</option>`;
            }
          }
        });
      }

      // 2. Fungsi Utama Filter
      function jalankanFilter(tabelBodyId, tahunSelectId, bulanSelectId) {
        const filterTahun = document.getElementById(tahunSelectId).value;
        const filterBulan = document.getElementById(bulanSelectId).value;
        
        const tbody = document.getElementById(tabelBodyId);
        const rows = tbody.getElementsByTagName('tr');
        
        // Loop semua baris
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          // Kolom tanggal ada di index ke-0 (Kolom Pertama)
          // Format Teks di tabel: dd-MM-yyyy (Contoh: 05-12-2025)
          const tdTanggal = row.cells[0]; 
          
          if (tdTanggal) {
            const textTanggal = tdTanggal.textContent.trim();
            
            // Jika barisnya adalah "Memuat data..." atau kosong, skip
            if(textTanggal.includes('Memuat') || textTanggal.includes('Belum ada')) continue;
            
            // Pecah tanggal (dd-MM-yyyy)
            const parts = textTanggal.split('-');
            if(parts.length === 3) {
              const rowBulan = parts[1]; // MM
              const rowTahun = parts[2]; // yyyy
              
              // Logika Cek Match
              const matchTahun = (filterTahun === '') || (rowTahun === filterTahun);
              const matchBulan = (filterBulan === '') || (rowBulan === filterBulan);
              
              if (matchTahun && matchBulan) {
                row.style.display = ''; // Tampilkan
              } else {
                row.style.display = 'none'; // Sembunyikan
              }
            }
          }
        }
      }

      // 3. Tambahkan pemanggilan initFilterTahun di window.onload
      const oldOnLoad = window.onload;
      window.onload = function() {
        if (oldOnLoad) oldOnLoad(); // Jalankan onload yang lama (login check dll)
        initFilterTahun(); // Jalankan inisialisasi filter
      };

      // Load Setting dari Server ke Form
      function loadSettingNomor() {
        const token = localStorage.getItem('userToken');
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          if(res.status === 'success' && res.data) {
            const s = res.data;
            globalAutoSettings = s; // Update Global Cache

            // Set Toko
            document.getElementById('toggleAutoToko').checked = s.toko.active;
            toggleFormSetting('toko');
            document.getElementById('fmtTokoPermintaan').value = s.toko.permintaan || '';
            document.getElementById('fmtTokoPenawaran').value = s.toko.penawaran || '';
            document.getElementById('fmtTokoPemeriksaan').value = s.toko.pemeriksaan || '';
            document.getElementById('fmtTokoBAST').value = s.toko.bast || '';
            document.getElementById('fmtTokoBayar').value = s.toko.bayar || '';

            // Set Tukang
            document.getElementById('toggleAutoTukang').checked = s.tukang.active;
            toggleFormSetting('tukang');
            document.getElementById('fmtTukangPermintaan').value = s.tukang.permintaan || '';
            document.getElementById('fmtTukangPemeriksaan').value = s.tukang.pemeriksaan || '';
            document.getElementById('fmtTukangBAST').value = s.tukang.bast || '';
            document.getElementById('fmtTukangBayar').value = s.tukang.bayar || '';
          }
        }).getSettingNomor(token);
      }

      // Helper Toggle UI
      function toggleFormSetting(tipe) {
        const isActive = document.getElementById(tipe === 'toko' ? 'toggleAutoToko' : 'toggleAutoTukang').checked;
        const formDiv = document.getElementById(tipe === 'toko' ? 'formAutoToko' : 'formAutoTukang');
        isActive ? formDiv.classList.remove('hidden') : formDiv.classList.add('hidden');
      }

      // Simpan Setting ke Server
      function simpanSettingNomor() {
        const token = localStorage.getItem('userToken');
        
        // Ambil data dari form
        const settings = {
          toko: {
            active: document.getElementById('toggleAutoToko').checked,
            permintaan: document.getElementById('fmtTokoPermintaan').value,
            penawaran: document.getElementById('fmtTokoPenawaran').value,
            pemeriksaan: document.getElementById('fmtTokoPemeriksaan').value,
            bast: document.getElementById('fmtTokoBAST').value,
            bayar: document.getElementById('fmtTokoBayar').value
          },
          tukang: {
            active: document.getElementById('toggleAutoTukang').checked,
            permintaan: document.getElementById('fmtTukangPermintaan').value,
            pemeriksaan: document.getElementById('fmtTukangPemeriksaan').value,
            bast: document.getElementById('fmtTukangBAST').value,
            bayar: document.getElementById('fmtTukangBayar').value
          }
        };

        // --- LOGIKA ANIMASI LOADING ---
        // Kita cari tombol yang memanggil fungsi ini
        // (Pastikan di HTML tombolnya: onclick="simpanSettingNomor()")
        const btn = document.querySelector('button[onclick="simpanSettingNomor()"]');
        const originalText = btn.innerHTML; // Simpan teks/icon asli

        // Ubah tombol jadi mode loading
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          // Kembalikan tombol ke semula
          btn.innerHTML = originalText;
          btn.disabled = false;

          if(res.status === 'success') {
            Swal.fire({
              icon: 'success', 
              title: 'Tersimpan',
              text: 'Pengaturan nomor otomatis berhasil disimpan!',
              timer: 1500,
              showConfirmButton: false
            });
            globalAutoSettings = settings; // Update cache global
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanSettingNomor(token, settings);
      }

      // Helper: Refresh Cache diam-diam saat buka tab list
      function refreshAutoSettingsCache() {
        const token = localStorage.getItem('userToken');
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          if(res.status === 'success' && res.data) globalAutoSettings = res.data;
        }).getSettingNomor(token);
      }

      /* --- FUNGSI NAVIGASI MOBILE --- */
      function toggleSidebar() {
        // Hanya jalankan jika di layar mobile (lebar < 768px)
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById('sidebarMenu');
          const overlay = document.getElementById('sidebarOverlay');
          
          // Toggle class 'show'
          sidebar.classList.toggle('show');
          overlay.classList.toggle('show');
        }
      }

      // Opsional: Perbaiki navigasiKe agar menutup sidebar di mobile
      // Update sedikit fungsi navigasiKe Anda:
      const originalNavigasiKe = navigasiKe; // Simpan fungsi lama
      navigasiKe = function(panelId, linkElement) {
          originalNavigasiKe(panelId, linkElement); // Jalankan logika lama
          
          // Logika tambahan: Tutup sidebar jika di mobile
          if (window.innerWidth < 768) {
              const sidebar = document.getElementById('sidebarMenu');
              const overlay = document.getElementById('sidebarOverlay');
              sidebar.classList.remove('show');
              overlay.classList.remove('show');
          }
      }

      function jalankanMaintenance() {
        const token = localStorage.getItem('userToken');
        
        Swal.fire({
          title: 'Perbaiki Database?',
          text: "Sistem akan mengecek dan menambahkan kolom yang hilang di Spreadsheet.",
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Ya, Jalankan'
        }).then((result) => {
          if (result.isConfirmed) {
            toggleLoading(true);
            
            google.script.run.withFailureHandler(handleServerError)
              .withSuccessHandler(function(res) {
                toggleLoading(false);
                if (res.status === 'success') {
                  // Tampilkan log perubahan agar user tahu apa yang terjadi
                  Swal.fire('Selesai', '<pre class="text-start" style="font-size:0.8rem">' + res.message + '</pre>', 'success');
                } else {
                  Swal.fire({ icon: 'error', title: 'Maintenance Gagal', html: res.message });
                }
              })
              .withFailureHandler(handleServerError) // Pastikan Anda sudah punya handler error ini
              .perbaikiSemuaHeader(token);
          }
        });
      }

      /* --- ERROR HANDLER GLOBAL --- */
      function handleServerError(err) {
        // Pastikan fungsi toggleLoading ada, jika tidak, bisa dihapus baris ini
        if (typeof toggleLoading === 'function') {
            toggleLoading(false);
        } else {
            // Fallback jika toggleLoading belum didefinisikan
            document.getElementById('loading').classList.add('hidden');
        }

        console.error("Server Error:", err);
        
        // Tampilkan pesan error ke user menggunakan SweetAlert
        Swal.fire({
          icon: 'error',
          title: 'Terjadi Kesalahan Server',
          text: err.message || 'Gagal menghubungi server Google Apps Script.',
          footer: '<small>Coba refresh halaman atau periksa koneksi internet.</small>',
          confirmButtonColor: '#d33'
        });

        // Reset tombol yang mungkin sedang disabled (loading state)
        const btns = document.querySelectorAll('button:disabled');
        btns.forEach(btn => {
          btn.disabled = false;
          // Kembalikan teks tombol jika sebelumnya ada spinner
          if(btn.innerHTML.includes('spinner-border')) {
            btn.innerHTML = '<i class="fas fa-redo"></i> Coba Lagi'; 
          }
        });
      }

      /* --- HELPER: SANITASI DATA (FIX TANDA KUTIP) --- */

      // 1. Untuk Tampilan di Tabel (Mencegah HTML Injection)
      function escapeHtml(text) {
        if (!text) return "";
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // 2. Untuk Parameter Tombol Edit (Mencegah JS Error)
      // Mengubah ' menjadi \' agar aman masuk ke fungsi onclick="edit('...')"
      function escapeJsAttribute(text) {
        if (!text) return "";
        return String(text)
          .replace(/\\/g, "\\\\")   // Escape backslash dulu
          .replace(/'/g, "\\'")     // Escape kutip satu untuk JS
          .replace(/"/g, "&quot;"); // Escape kutip dua untuk HTML Attr
      }

      /* --- TAMBAHKAN FUNGSI BARU INI DI BAWAH --- */

      // 1. Load Data ID Template dari Server
      function loadTemplateSettings() {
        const token = localStorage.getItem('userToken');
        const ids = ['tplIdToko', 'tplIdGuru', 'tplIdTukang'];
        
        // Kasih efek loading kecil di placeholder
        ids.forEach(id => document.getElementById(id).placeholder = "Memuat...");

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            const d = res.data;
            document.getElementById('tplIdToko').value = d.toko || '';
            document.getElementById('tplIdGuru').value = d.guru || '';
            document.getElementById('tplIdTukang').value = d.tukang || '';
            
            // Balikin placeholder
            ids.forEach(id => document.getElementById(id).placeholder = "Contoh: 1Fl8Jaf4j6XI...");
          }
        }).getTemplateSettings(token);
      }

      // 2. Simpan Data Template
      function simpanTemplate(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const payload = {
          toko: document.getElementById('tplIdToko').value.trim(),
          guru: document.getElementById('tplIdGuru').value.trim(),
          tukang: document.getElementById('tplIdTukang').value.trim()
        };

        const btn = document.getElementById('btnSimpanTemplate');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          
          if (res.status === 'success') {
            Swal.fire('Sukses', 'Pengaturan template berhasil disimpan!', 'success');
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanTemplateSettings(token, payload);
      }

      function loadMasterReferensi() {
        // Cek jika cache sudah ada isinya, tidak perlu load lagi (hemat kuota)
        if (cacheMasterUraian.length > 0) return;

        const token = localStorage.getItem('userToken');
        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            cacheMasterUraian = res.data;
            console.log("Referensi Uraian Loaded: " + cacheMasterUraian.length + " items");
          }
        }).getReferensiUraianMaster(token);
      }

      function handleInputUraian(el) {
        const keyword = el.value.toLowerCase();
        const listEl = document.getElementById('listSaranUraian');
        
        // 1. Validasi: Minimal 3 huruf
        if (keyword.length < 3) {
          listEl.style.display = 'none';
          return;
        }

        // 2. Filter Data dari Cache
        const matches = cacheMasterUraian.filter(item => 
          String(item).toLowerCase().includes(keyword)
        );

        // 3. Render Hasil
        if (matches.length > 0) {
          let html = '';
          // Batasi tampilan maksimal 10 saran agar tidak kepanjangan
          const limit = matches.length > 10 ? 10 : matches.length;
          
          for(let i=0; i<limit; i++) {
            // Escape petik satu agar tidak error di onclick
            const valSafe = matches[i].replace(/'/g, "\\'"); 
            html += `<div class="suggestion-item" onclick="pilihSaranUraian('${valSafe}')">
                      <i class="fas fa-search text-secondary me-2 small"></i> ${matches[i]}
                    </div>`;
          }
          
          listEl.innerHTML = html;
          listEl.style.display = 'block';
        } else {
          // Opsional: Tampilkan "Tidak ada data" atau sembunyikan
          listEl.innerHTML = '<div class="suggestion-item text-muted fst-italic">Data tidak ditemukan, lanjutkan mengetik...</div>';
          listEl.style.display = 'block';
        }
      }

      function pilihSaranUraian(text) {
        const input = document.getElementById('urNama');
        input.value = text;
        
        // Sembunyikan list setelah memilih
        document.getElementById('listSaranUraian').style.display = 'none';
      }

      // 1. Fungsi Handler saat mengetik atau klik input Satuan
      function handleInputSatuan(el) {
        const keyword = el.value.toLowerCase();
        
        // Cari elemen list saudara (sibling) dari input ini
        const wrapper = el.parentElement;
        const listEl = wrapper.querySelector('.suggestion-list');
        
        // Tentukan data yang mau ditampilkan
        let matches = [];
        
        if (keyword === "") {
          // Jika kosong (baru di klik), tampilkan SEMUA satuan
          matches = cacheSatuan; 
        } else {
          // Jika mengetik, filter berdasarkan kata kunci
          matches = cacheSatuan.filter(item => 
            String(item).toLowerCase().includes(keyword)
          );
        }

        // Render Hasil
        if (matches.length > 0) {
          let html = '';
          // Batasi 10 agar tidak terlalu panjang
          const limit = matches.length > 10 ? 10 : matches.length;
          
          for(let i=0; i<limit; i++) {
            // Escape petik satu
            const valSafe = String(matches[i]).replace(/'/g, "\\'"); 
            // Kirim elemen input (el) agar kita tahu input mana yang harus diisi
            html += `<div class="suggestion-item" onclick="pilihSatuan(this, '${valSafe}')">
                      ${matches[i]}
                    </div>`;
          }
          
          listEl.innerHTML = html;
          listEl.style.display = 'block';
        } else {
          // Jika tidak ada match, sembunyikan (user bisa ketik manual)
          listEl.style.display = 'none';
        }
      }

      // 2. Fungsi saat Saran dipilih
      function pilihSatuan(itemElement, text) {
        // Cari input text di atas elemen saran ini
        const wrapper = itemElement.closest('.autocomplete-wrapper');
        const input = wrapper.querySelector('input.item-sat');
        
        input.value = text;
        
        // Sembunyikan list
        wrapper.querySelector('.suggestion-list').style.display = 'none';
      }

      // 3. Update Global Click Listener (Agar list menutup saat klik di luar)
      // Update listener yang sudah ada di paling bawah script Anda:
      document.addEventListener('click', function(e) {
        // Tutup Uraian (Kode Lama)
        const wrapperUraian = document.querySelector('.autocomplete-wrapper'); 
        // Perhatikan: Class autocomplete-wrapper sekarang dipakai di tabel juga.
        // Kode di bawah ini menangani penutupan list secara generic untuk class tersebut.
        
        const allWrappers = document.querySelectorAll('.autocomplete-wrapper');
        
        allWrappers.forEach(wrapper => {
            const listEl = wrapper.querySelector('.suggestion-list');
            // Jika klik terjadi DI LUAR wrapper ini, sembunyikan list-nya
            if (listEl && listEl.style.display === 'block' && !wrapper.contains(e.target)) {
                listEl.style.display = 'none';
            }
        });
      });

      /* --- LOGIKA PENCARIAN REFERENSI BARANG (BARU) --- */
      
      let timeoutCariBarang = null;

      function handleCariBarang(inputEl, tipe) {
        const keyword = inputEl.value;
        const listId = (tipe === 'toko') ? 'saran-barang-toko' : 'saran-barang-tukang';
        const listEl = document.getElementById(listId);

        // 1. Reset
        listEl.style.display = 'none';
        listEl.innerHTML = '';

        // 2. Validasi Minimal 3 Huruf
        if (keyword.length < 3) return;

        // 3. Debounce (Tunggu user selesai mengetik 300ms)
        clearTimeout(timeoutCariBarang);
        
        timeoutCariBarang = setTimeout(() => {
           // Tampilkan indikator loading sementara
           listEl.innerHTML = '<div class="suggestion-item text-muted"><i class="fas fa-spinner fa-spin me-2"></i> Mencari...</div>';
           listEl.style.display = 'block';

           const token = localStorage.getItem('userToken');
           
           google.script.run.withSuccessHandler(function(res) {
             if (res.status === 'success' && res.data.length > 0) {
                let html = '';
                res.data.forEach(item => {
                  const namaSafe = escapeJsAttribute(item.nama);
                  const satSafe  = escapeJsAttribute(item.satuan);
                  
                  html += `
                    <div class="suggestion-item d-flex justify-content-between align-items-center" 
                         onclick="pilihReferensiBarang('${namaSafe}', '${satSafe}', '${tipe}', this)">
                       <span>${item.nama}</span>
                       <span class="badge bg-light text-secondary border">${item.satuan}</span>
                    </div>
                  `;
                });
                listEl.innerHTML = html;
             } else {
                listEl.innerHTML = '<div class="suggestion-item text-muted fst-italic">Data tidak ditemukan.</div>';
             }
           }).cariBarangReferensi(token, keyword);

        }, 400); // Delay 400ms
      }

      function pilihReferensiBarang(nama, satuan, tipe, itemEl) {
        // 1. Tentukan Tabel Target
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 'tabelItemTukang';
        const tbody = document.getElementById(tableId).querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');

        // 2. Cari baris kosong terakhir
        let targetRow = null;
        
        if (rows.length > 0) {
          const lastRow = rows[rows.length - 1];
          const inputNama = lastRow.querySelector('.item-nama');
          
          // Jika baris terakhir nama barangnya masih kosong, pakai baris itu
          if (inputNama && inputNama.value.trim() === '') {
            targetRow = lastRow;
          }
        }

        // 3. Jika tidak ada baris kosong, buat baris baru
        if (!targetRow) {
          tambahBaris(tipe);
          // Ambil baris yang baru saja dibuat
          const newRows = tbody.querySelectorAll('tr');
          targetRow = newRows[newRows.length - 1];
        }

        // 4. Isi Data ke Input
        if (targetRow) {
          const inputNama = targetRow.querySelector('.item-nama');
          const inputSat = targetRow.querySelector('.item-sat');

          if (inputNama) inputNama.value = unescapeHtml(nama); // Decode entitas HTML jika ada
          if (inputSat) inputSat.value = unescapeHtml(satuan);
          
          // Efek visual (kedip kuning) agar user tahu baris mana yang terisi
          targetRow.classList.add('table-warning');
          setTimeout(() => targetRow.classList.remove('table-warning'), 500);
        }

        // 5. Bersihkan Pencarian
        const wrapper = itemEl.closest('.autocomplete-wrapper');
        const inputCari = wrapper.querySelector('input');
        
        wrapper.querySelector('.suggestion-list').style.display = 'none';
        inputCari.value = ''; // Kosongkan input pencarian agar siap cari lagi
        inputCari.focus();    // Kembalikan fokus ke input cari
      }

      // Helper untuk decode string (jika diperlukan saat insert value)
      function unescapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'")
            .replace(/\\\\/g, "\\"); // Fix escape slash
      }

      /* --- LOGIKA INFO SATUAN (NEW) --- */
      let cacheDataSatuanLengkap = [];

      function bukaModalSatuan() {
        const modal = new bootstrap.Modal(document.getElementById('modalInfoSatuan'));
        modal.show();

        // Reset pencarian
        document.getElementById('cariSatuanInput').value = '';

        // Cek cache, jika kosong load dari server
        if (cacheDataSatuanLengkap.length === 0) {
          loadInfoSatuanFromServer();
        } else {
          renderTabelSatuan(cacheDataSatuanLengkap);
        }
      }

      function loadInfoSatuanFromServer() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('bodyInfoSatuan');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-info" role="status"></div><br>Sedang mengambil data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            cacheDataSatuanLengkap = res.data;
            renderTabelSatuan(cacheDataSatuanLengkap);
          } else {
            tbody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Gagal: ${res.message}</td></tr>`;
          }
        }).getReferensiSatuanLengkap(token);
      }

      function renderTabelSatuan(data) {
        const tbody = document.getElementById('bodyInfoSatuan');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Belum ada data satuan.</td></tr>';
          return;
        }

        data.forEach(item => {
          // Logika warna badge kategori
          let badgeClass = 'bg-secondary';
          const kat = item.kategori.toLowerCase();
          if (kat.includes('berat') || kat.includes('kilo')) badgeClass = 'bg-primary';
          else if (kat.includes('panjang') || kat.includes('meter')) badgeClass = 'bg-success';
          else if (kat.includes('volume') || kat.includes('liter')) badgeClass = 'bg-info text-dark';
          else if (kat.includes('buah') || kat.includes('pcs') || kat.includes('unit')) badgeClass = 'bg-warning text-dark';

          const row = `
            <tr>
              <td class="fw-bold text-dark font-monospace" style="font-size: 1.1em;">${item.nama}</td>
              <td><span class="badge ${badgeClass} fw-normal px-3 py-2 rounded-pill">${item.kategori}</span></td>
              <td class="text-muted small">${item.contoh}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      function filterInfoSatuan() {
        const keyword = document.getElementById('cariSatuanInput').value.toLowerCase();
        const tbody = document.getElementById('bodyInfoSatuan');
        const rows = tbody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
          const nama = rows[i].cells[0]?.textContent.toLowerCase() || '';
          const kategori = rows[i].cells[1]?.textContent.toLowerCase() || '';
          const contoh = rows[i].cells[2]?.textContent.toLowerCase() || '';

          if (nama.includes(keyword) || kategori.includes(keyword) || contoh.includes(keyword)) {
            rows[i].style.display = "";
          } else {
            rows[i].style.display = "none";
          }
        }
      }

    </script>
  </body>
</html>
