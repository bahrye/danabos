<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
      /* --- PERBAIKAN CSS SCROLL MOBILE --- */
      html {
        /* Hapus height: 100% agar browser menghitung tinggi sesuai konten */
        height: auto;
        min-height: 100%;
        width: 100%;
        /* Hapus overscroll-behavior-y: none; agar efek pantul natural tetap ada (mencegah rasa macet) */
      }

      body {
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100vh; /* Gunakan min-height viewport */
        height: auto;      /* Biarkan tinggi tumbuh sesuai konten */
        
        background-color: #f4f6f9; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        
        /* Mencegah scroll horizontal halaman utama, tapi izinkan scroll vertikal native */
        overflow-x: hidden; 
        overflow-y: auto;
        
        /* KUNCI: Mengaktifkan momentum scrolling yang mulus di iOS/Android */
        -webkit-overflow-scrolling: touch;
        
        /* Memberi tahu browser bahwa elemen ini boleh digeser vertikal */
        touch-action: pan-y; 
      }

      /* Tambahan: Pastikan konten utama tidak melebar */
      .panel-content {
        width: 100%;
        overflow: visible; /* Biarkan konten mengalir apa adanya */
        height: auto;
        padding-bottom: 100px; /* Tambah ruang bawah agar tombol paling bawah tidak tertutup browser bar */
        
        /* Pastikan sentuhan terdeteksi */
        touch-action: pan-y;
      }

      /* Perbaikan Input agar tidak zoom in otomatis di HP saat diklik */
      input, select, textarea {
        font-size: 16px !important; /* Mencegah auto-zoom browser HP */
      }
      
      /* Login & Register Styles */
      .card-login { max-width: 400px; margin: 50px auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
      
      /* Layout Styles */
      /* --- CSS UPDATE RESPONSIVE --- */

      /* --- PERBAIKAN SIDEBAR DESKTOP --- */
      .sidebar {
        min-height: 100vh;
        background: #2c3e50;
        color: white;
        transition: all 0.3s;
        
        /* Tambahan: Agar sidebar diam (sticky) saat konten discroll */
        position: sticky;
        top: 0;
        height: 100vh;       /* Tinggi full layar */
        overflow-y: auto;    /* Bisa discroll sendiri jika menu panjang */
        overflow-x: hidden;  /* Hilangkan scroll samping */
      }

      /* 2. CSS Khusus Mobile (Layar < 768px) */
      @media (max-width: 767.98px) {
        .sidebar {
          position: fixed;
          top: 0;
          left: -250px;
          width: 250px;
          height: 100%;
          z-index: 1050;
          overflow-y: auto;
          transition: left 0.3s ease; /* Transisi hanya pada properti left */
          visibility: hidden; /* Sembunyikan agar tidak mengganggu touch event */
          box-shadow: 5px 0 15px rgba(0,0,0,0.2);
        }

        .sidebar.show {
          left: 0;
          visibility: visible; /* Munculkan hanya saat class show aktif */
        }

        /* Konten Utama padding lebih kecil */
        .col-md-9.col-lg-10.p-4 {
          padding: 1rem !important; /* Ganti p-4 jadi p-3/p-2 di mobile */
        }

        /* Font tabel lebih kecil agar muat */
        .table {
          font-size: 0.8rem; 
        }
        
        /* Sembunyikan kolom yang kurang penting di mobile (Opsional) */
        /* .hide-mobile { display: none; } */
      }

      /* 3. Overlay Gelap saat Menu Mobile Aktif */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040; /* Di bawah sidebar, di atas konten */
      }

      .sidebar-overlay.show {
        display: block;
      }

      /* Custom Scrollbar untuk Sidebar agar rapi */
      .sidebar::-webkit-scrollbar { width: 5px; }
      .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

      .nav-link { 
        color: rgba(255,255,255,0.8); 
        margin-bottom: 5px; 
        cursor: pointer; 
        
        /* PERBAIKAN: Izinkan teks turun baris jika layar sempit */
        white-space: normal !important; 
        font-size: 0.95rem; /* Sedikit kecilkan font agar muat */
        line-height: 1.4;   /* Jarak antar baris jika teks turun */
        display: flex;      /* Gunakan flex agar ikon dan teks sejajar */
        align-items: center;
      }

      .nav-link i {
        /* Pastikan ikon tidak mengecil saat teks turun */
        flex: 0 0 25px; 
      }

      .nav-link:hover { background: #34495e; color: white; border-radius: 5px; }
      .nav-link.active { background: #3498db; color: white; border-radius: 5px; font-weight: bold; }
      
      /* Utility Classes */
      .hidden { display: none !important; }
      .cursor-pointer { cursor: pointer; }
      
      /* Loading Overlay */
      /* --- UPDATE CSS (Cari class .loading-overlay) --- */
      .loading-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(255,255,255,0.9); /* Sedikit lebih pekat agar tulisan terbaca */
        z-index: 9999; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        flex-direction: column; /* TAMBAHKAN INI: Agar teks turun ke bawah */
      }

      /* --- STYLE TAB CUSTOM --- */
      /* Keadaan Tidak Aktif (Default) */
      .nav-tabs .nav-link {
        color: black !important;          /* Teks Hitam */
        background-color: #e9ecef;        /* Background abu muda */
        border: 1px solid #dee2e6;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        font-weight: 600;
      }

      /* Keadaan Aktif (Terpilih) */
      .nav-tabs .nav-link.active {
        color: white !important;          /* Teks Putih */
        background-color: #0d6efd !important; /* Background Biru Utama */
        border-color: #0d6efd !important;
      }

      /* Hover Effect */
      .nav-tabs .nav-link:hover {
        background-color: #dfe6ed;
        color: #000;
      }

      /* --- STYLE TAMBAHAN UNTUK NAV PILLS (Tab Setting) --- */
      
      /* 1. Style Dasar Tombol */
      .nav-pills .nav-link {
        background-color: #e9ecef; /* Warna abu-abu terang default */
        color: #495057;            /* Warna teks abu tua */
        margin-right: 5px;
        border: 1px solid #dee2e6; 
        transition: all 0.2s;      /* Animasi halus */
      }

      /* 2. Efek Hover HANYA untuk Tab yang TIDAK AKTIF */
      .nav-pills .nav-link:not(.active):hover {
        background-color: #dfe6ed; /* Berubah jadi abu agak gelap saat hover */
        color: #000;
      }

      /* 3. Style Tab AKTIF (Termasuk saat di-hover) */
      .nav-pills .nav-link.active,
      .nav-pills .nav-link.active:hover { 
        background-color: #0d6efd; /* Tetap Biru */
        color: white;
        border-color: #0d6efd;
        cursor: default; /* Opsional: Ubah kursor agar user tahu ini sedang aktif */
      }

      /* --- STYLE CUSTOM TOGGLE SWITCH --- */
      .toggle-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .toggle-card:hover {
        border-color: #0d6efd; /* Warna biru primary saat dihover */
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
      }

      /* Memperbesar ukuran saklar bawaan Bootstrap */
      .custom-switch-lg .form-check-input {
        width: 3.5em;  /* Lebih lebar */
        height: 1.75em; /* Lebih tinggi */
        cursor: pointer;
      }
      
      .custom-switch-lg .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
      }

      /* --- STYLE UNTUK AUTOCOMPLETE LIST (UPDATED) --- */
      .autocomplete-wrapper {
        position: relative;
        width: 100%;
      }

      .suggestion-list {
        position: absolute;
        top: 100%; /* Tepat di bawah input */
        left: 0;
        right: 0;
        z-index: 1030; /* Pastikan di atas segalanya */
        
        background: white;
        border: 1px solid rgba(0,0,0,0.15); /* Border halus */
        border-top: none; /* Menyatu dengan input */
        border-radius: 0 0 8px 8px; /* Sudut bawah membulat */
        
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); /* Shadow melayang (floating effect) */
        font-size: 0.9rem;
      }

      .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        background-color: #fff;
        transition: background 0.2s;
        color: #333;
      }

      .suggestion-item:hover {
        background-color: #f0f7ff; /* Warna biru sangat muda saat hover */
        color: #0d6efd;
      }

      .suggestion-item:last-child {
        border-bottom: none !important;
        border-radius: 0 0 8px 8px;
      }

      /* Scrollbar halus untuk list */
      .suggestion-list::-webkit-scrollbar {
        width: 6px;
      }
      .suggestion-list::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 3px;
      }

      .letter-spacing-2 { letter-spacing: 5px; }

      /* Pastikan ini ada agar saat ikon mata disorot mouse berubah jadi jari telunjuk */
      .cursor-pointer { cursor: pointer; }

      /* --- STYLE FOOTER --- */
      .main-footer {
        text-align: center;
        padding: 20px 10px;
        margin-top: auto; /* Mendorong footer ke bawah jika menggunakan flex column */
        background-color: #f4f6f9; /* Menyesuaikan background body */
        border-top: 1px solid #e0e0e0;
        width: 100%;
        font-size: 0.9rem;
        color: #6c757d;
      }

      .main-footer a {
        text-decoration: none;
        color: inherit; /* Mengikuti warna teks parent */
        transition: color 0.3s;
      }

      .main-footer a:hover {
        color: #0d6efd; /* Warna biru saat dihover */
      }

      .main-footer p {
        margin-bottom: 0; /* Menghapus margin bawaan paragraf */
      }

      .table-responsive, 
      .nav-tabs-scrollable {
        /* Mengizinkan geser ke segala arah (X untuk tabel, Y untuk halaman) */
        touch-action: pan-x pan-y; 
        
        /* Momentum scroll wajib untuk area scroll kecil */
        -webkit-overflow-scrolling: touch;
        
        /* PERBAIKAN: Ubah menjadi auto agar scroll halaman (naik-turun) tetap jalan */
        overscroll-behavior: auto !important; 
        
        /* Tambahan: Pastikan kursor default agar tidak dianggap text-selection */
        cursor: default;
      }

      /* --- CSS KHUSUS TAB SCROLLABLE (MOBILE) --- */
      .nav-tabs-scrollable {
        display: flex;
        flex-wrap: nowrap !important; /* Mencegah tab turun ke bawah */
        overflow-x: auto;             /* Mengaktifkan scroll samping */
        overflow-y: hidden;
        white-space: nowrap;          /* Teks tidak terpotong */
        -webkit-overflow-scrolling: touch; /* Scroll halus di iOS */
        border-bottom: 1px solid #dee2e6;
        
        /* Hilangkan scrollbar agar bersih */
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
      }

      .nav-tabs-scrollable::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }

      .nav-tabs-scrollable .nav-item {
        flex: 0 0 auto; /* Item tidak menyusut */
      }

      .nav-tabs-scrollable .nav-link {
        border-bottom: none; /* Agar border bawah menyatu */
        font-size: 0.9rem;   /* Sedikit mengecilkan font di mobile agar muat lebih banyak */
        padding: 10px 15px;
      }

      /* --- PERBAIKAN TABEL INPUT TRANSAKSI (MOBILE) --- */

      /* 1. Memaksa tabel input agar melebar (memunculkan scroll horizontal) */
      .table-input-scroll {
        min-width: 800px; /* Tabel dipaksa lebar minimal 800px agar lega */
      }

      /* 2. Mengatur lebar minimal setiap kolom agar input tidak gepeng */
      .col-nama   { width: 30%; min-width: 200px; }
      .col-vol    { width: 10%; min-width: 80px; } /* Diperlebar agar angka terlihat */
      .col-sat    { width: 15%; min-width: 100px; }
      .col-harga  { width: 20%; min-width: 140px; }
      .col-jumlah { width: 20%; min-width: 140px; }
      .col-aksi   { width: 5%;  min-width: 50px; }

      /* 3. Perbaikan Tombol Aksi di Bawah Tabel */
      .action-container {
        display: flex;
        flex-wrap: wrap; /* Agar tombol turun ke bawah jika layar sempit */
        gap: 10px;       /* Jarak antar elemen */
        align-items: center;
        justify-content: space-between;
      }

      /* Di HP, elemen pencarian dan tombol simpan jadi full width agar mudah ditekan */
      @media (max-width: 767.98px) {
        .action-group-left, 
        .action-group-right {
          width: 100%;
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        
        .autocomplete-wrapper {
          width: 100% !important;
          max-width: 100% !important;
        }

        /* Tombol tambah baris & simpan jadi lebar penuh */
        .action-group-left button,
        .action-group-right button {
          width: 100%; 
        }
      }

      /* --- PERBAIKAN BUG SCROLL MODAL (INFO REFERENSI) --- */
      
      /* 1. Paksa scroll vertikal aktif & mulus pada modal body */
      .modal-dialog-scrollable .modal-body {
        -webkit-overflow-scrolling: touch !important; /* Momentum scroll iOS */
        overflow-y: auto !important;
        touch-action: pan-y !important; /* Pastikan gesture vertikal diizinkan */
      }

      /* 2. PENTING: Matikan 'contain' khusus untuk tabel di dalam modal 
         agar saat tabel disentuh, scroll tetap bisa naik-turun (bubbling ke modal) */
      .modal-body .table-responsive {
        overscroll-behavior: auto !important; 
        touch-action: pan-x pan-y !important;
      }
      
      /* 3. Pastikan Sticky Header tetap jalan tapi tidak menghalangi scroll */
      .modal-body .table-responsive thead.sticky-top {
        z-index: 5; /* Sedikit diatas konten tabel */
      }

      /* --- CSS UNTUK KOLOM SCROLLABLE --- */
      .cell-scroll {
        overflow-x: auto;       /* Izinkan scroll horizontal */
        white-space: nowrap;    /* Teks satu baris, tidak turun ke bawah */
        padding-bottom: 2px;    /* Sedikit jarak bawah */
        
        /* Sembunyikan scrollbar agar bersih (opsional) */
        scrollbar-width: none;  /* Firefox */
        -ms-overflow-style: none;  /* IE and Edge */
      }

      /* Sembunyikan scrollbar untuk Chrome/Safari/Opera */
      .cell-scroll::-webkit-scrollbar {
        display: none;
      }

      /* --- [1] SETTINGAN UMUM (TAMPILAN DILAYAR / LIVE PREVIEW) --- */
      /* Ini akan membuat tampilan di layar laptop normal, tidak terlalu melebar */
      
      .sheet-container {
        background-color: #525659;
        padding: 30px;
        overflow-y: auto;
        height: 700px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }

      .sheet {
        background: white;
        width: 210mm;        /* Standar A4 */
        height: 297mm;       
        position: relative;
        box-shadow: 0 .5mm 2mm rgba(0,0,0,.3);
        box-sizing: border-box;
        color: #000;
        font-family: "Times New Roman", Times, serif;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 15mm;
        /* HAPUS min-width DISINI agar preview di layar fleksibel/bisa dizoom */
      }

      /* Ukuran Font Standar untuk PREVIEW (Agar enak dilihat di layar) */
      .txt-instansi { font-size: 14pt; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
      
      .txt-title { 
        font-size: 24pt; /* Ukuran normal untuk preview */
        font-weight: bold; text-transform: uppercase; line-height: 1.3; margin-bottom: 15px; 
      }
      
      .txt-period { font-size: 14pt; margin-bottom: 10px; font-weight: normal; }
      .txt-school { font-size: 18pt; font-weight: bold; text-transform: uppercase; margin-top: 10px; }
      .txt-year { font-size: 14pt; margin-top: 5px; font-weight: bold; }
      .txt-city { font-size: 12pt; font-weight: bold; text-transform: uppercase; margin-top: 15px; }
      
      .img-logo { max-height: 200px; max-width: 200px; object-fit: contain; }

      /* Layout Wrapper Standar */
      .cover-layout-wrapper {
        width: 100%; height: 100%; box-sizing: border-box;
        display: flex; flex-direction: column; justify-content: space-between;
      }
      .section-top { text-align: center; margin-top: 30mm; padding-bottom: 20px; }
      .section-middle { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 10px 0; }
      .section-bottom { text-align: center; margin-bottom: 25mm; }

      /* Desain V1 Default */
      .design-v1 .cover-layout-wrapper {
        border: 5px double #000; outline: 1px solid #000; outline-offset: -10px; padding: 0 10mm;
      }
      /* Desain lain (V2-V5) tetap gunakan CSS lama... */
      .design-v2 .cover-layout-wrapper { padding: 0 10mm; }
      .design-v2 .bar-header, .design-v2 .bar-footer { height: 30px; background-color: #157347; width: 100%; }
      .design-v3 .cover-layout-wrapper { border-left: 15px solid #2c3e50; padding-left: 10mm; align-items: flex-start; }
      .design-v3 .section-top, .design-v3 .section-bottom { text-align: left; margin-top: 20mm; margin-bottom: 20mm; }
      .design-v4 .section-top { border-bottom: 4px double #000; padding-bottom: 20px; width: 100%; margin-top: 10mm; }
      .design-v4 .section-bottom { border-top: 2px solid #000; padding-top: 20px; width: 100%; margin-bottom: 10mm; }
      .design-v5 .cover-layout-wrapper { border: 3px solid #0d6efd; border-radius: 20px; padding: 10mm; }


      /* --- [2] SETTINGAN KHUSUS CETAK (ACTIVE SAAT KLIK PRINT/SIMPAN PDF) --- */
      /* Disini kita 'menyuntikkan' CSS agar hasil cetak jadi BESAR & TEBAL */
      
      @media print {
        @page { 
          size: A4 portrait; margin: 0; 
        }
        
        body * { visibility: hidden; }
        
        #print-area, #print-area * { visibility: visible; }

        #print-area {
          position: fixed; top: 0; left: 0;
          
          /* KUNCI 1: Paksa Lebar 210mm saat Print agar Font Besar muat */
          width: 210mm !important;
          min-width: 210mm !important; 
          height: 297mm !important;
          
          margin: 0; padding: 15mm !important;
          display: flex; justify-content: center; align-items: center;
          background: white !important;
          z-index: 9999;
        }
        
        .design-v1 .cover-layout-wrapper { height: 100%; }

        /* KUNCI 2: PERBESAR FONT SECARA EKSTRIM KHUSUS UNTUK HASIL CETAK */
        /* Gunakan !important agar menimpa settingan layar */
        
        .txt-title { 
            font-size: 32pt !important; /* Besar agar wrap (turun baris) */
            line-height: 1.1 !important;
            padding: 0 10mm !important;
        }
        
        .txt-instansi { font-size: 16pt !important; }
        .txt-school { font-size: 22pt !important; }
        .txt-year { font-size: 16pt !important; }
        .txt-period { font-size: 16pt !important; }
        .txt-city { font-size: 14pt !important; }
        
        .img-logo { max-height: 220px !important; }

        /* Tambahkan ini agar Surat Pengantar juga tercetak full page */
        #print-area-sp {
          position: fixed; top: 0; left: 0;
          width: 210mm !important;
          min-width: 210mm !important; 
          height: 297mm !important;
          margin: 0; padding: 10mm !important;
          background: white !important;
          z-index: 9999;
          visibility: visible !important;
        }
        
        #print-area-sp * {
          visibility: visible !important;
        }

        /* Tambahan khusus Verifikasi */
        #print-area-verif {
          position: fixed; top: 0; left: 0;
          width: 210mm !important;
          height: 297mm !important;
          margin: 0; padding: 0 !important;
          background: white !important;
          z-index: 9999;
          visibility: visible !important;
        }
        
        #print-area-verif * {
          visibility: visible !important;
        }

        /* Hilangkan tombol aksi tabel */
        .btn-aksi-verif, .btn-aksi-verif * {
          display: none !important;
        }
        
        /* Hilangkan border input agar terlihat seperti teks biasa */
        .input-verif-cell {
          border: none !important;
          background: transparent !important;
          padding: 0 !important;
        }
      }

      /* --- CSS TAMBAHAN UNTUK SURAT PENGANTAR --- */
      .surat-body {
        padding: 10mm 15mm;
        font-family: 'Times New Roman', Times, serif;
        font-size: 12pt;
        color: #000;
        line-height: 1.5;
      }

      .tbl-pengantar {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .tbl-pengantar th, .tbl-pengantar td {
        border: 1px solid #000;
        padding: 8px;
        vertical-align: top;
      }

      .tbl-pengantar th {
        text-align: center;
        font-weight: bold;
      }

      .signature-box {
        float: right;
        width: 40%;
        text-align: center;
        margin-top: 30px;
      }

      /* --- CSS FINAL LEMBAR VERIFIKASI (FIXED: 1 HALAMAN, RAPAT ATAS, LEGAL) --- */

      /* 1. Container Utama (Tampilan Layar & Cetak) */
      .verif-sheet {
        font-family: 'Times New Roman', Times, serif;
        color: #000;
        background: white;
        box-sizing: border-box;
        width: 100%;
        /* Padding standar (bisa disesuaikan jika printer memotong) */
        padding: 10mm 15mm; 
      }

      /* 2. Judul Paling Atas */
      .verif-title-top {
        text-align: center;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 14pt;
        margin-top: 0; 
        margin-bottom: 15px; 
        text-decoration: underline;
        line-height: 1.1;
      }

      /* 3. Tabel Info Sekolah */
      .verif-header-table {
        width: 100%;
        margin-bottom: 5px; 
        border-collapse: collapse;
        border: none;
      }
      .verif-header-table td {
        padding: 1px 2px; /* Jarak baris header sangat rapat */
        vertical-align: top;
        border: none;
        font-size: 11pt; 
      }

      /* 4. Sub-Judul (RATA TENGAH) */
      .verif-subtitle {
        font-weight: bold;
        font-size: 11pt;
        text-transform: uppercase;
        text-align: center; /* Permintaan Anda: Rata Tengah */
        text-decoration: underline;
        margin-top: 10px;
        margin-bottom: 5px;
      }

      /* 5. Tabel Utama (Daftar Berkas) */
      .verif-main-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10pt; /* Ukuran font tabel sedikit diperkecil agar muat */
        margin-bottom: 10px;
      }
      
      .verif-main-table th {
        text-align: center;
        font-weight: bold;
        background-color: #f0f0f0;
        border: 1px solid #000;
        padding: 3px; 
      }

      .verif-main-table td {
        border: 1px solid #000;
        /* Padding sel diperkecil */
        padding: 1px 4px; 
        vertical-align: middle;
        height: 18px; /* Paksa tinggi baris minimal */
      }

      /* Lebar Kolom */
      .verif-main-table th:nth-child(2),
      .verif-main-table td:nth-child(2) {
        width: 50%;       
      }

      /* Input */
      .input-verif-cell {
        width: 100%;
        border: 1px dashed #ccc;
        padding: 0;
        font-family: inherit;
        font-size: inherit;
        background-color: transparent;
        color: #000;
        height: 100%;
      }
      .input-verif-cell:focus {
        outline: none;
        border-color: #0d6efd;
      }

      /* 6. Tanda Tangan */
      .verif-signature-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        margin-top: 15px; /* Jarak secukupnya dari tabel */
        page-break-inside: avoid; /* Mencegah TTD terpotong */
      }
      .verif-sig-box {
        width: 40%;
        text-align: center;
        margin-bottom: 5px;
        font-size: 11pt;
      }
      .verif-sig-name {
        font-weight: bold;
        text-decoration: underline;
        margin-top: 60px; /* Ruang Tanda Tangan */
        margin-bottom: 0;
      }
      .verif-sig-box div:last-child {
        margin-top: 2px;
      }

      /* --- [SETTINGAN KHUSUS CETAK - FINAL FIXED LENGKAP] --- */
      @media print {
        @page {
          size: Legal portrait; /* Kertas F4/Legal */
          margin: 0mm; /* Reset margin printer */
        }

        body, html {
          width: 100%;
          height: 100%;
          margin: 0 !important;
          padding: 0 !important;
          background-color: white;
        }

        /* 1. Sembunyikan semua elemen aplikasi selain area cetak */
        body > * { display: none !important; }
        #view-admin { display: block !important; } /* Container utama tetap aktif */
        .sidebar, .main-footer, .modal, .loading-overlay { display: none !important; }

        /* 2. Setting Area Cetak Verifikasi */
        #print-area-verif {
          display: block !important;
          position: fixed; /* Paksa konten naik ke pojok kiri atas kertas */
          top: 0; 
          left: 0;
          width: 100% !important;
          height: 100% !important;
          z-index: 99999;
          background: white !important;
          visibility: visible !important;
          
          /* Margin Kertas (Padding Dalam) */
          padding: 10mm 15mm !important; 
          box-sizing: border-box;
        }

        /* Pastikan konten di dalamnya terlihat */
        #print-area-verif * { visibility: visible !important; }

        /* 3. SEMBUNYIKAN KOLOM AKSI (TOMBOL + / -) */
        th.btn-aksi-verif, 
        td.btn-aksi-verif {
          display: none !important; 
          width: 0 !important;
          padding: 0 !important;
          border: none !important;
        }

        /* 4. PERBAIKAN TABEL AGAR MELEBAR RAPI */
        .verif-main-table {
          width: 100% !important;
          font-size: 10pt !important;
          border-collapse: collapse;
          margin-bottom: 15px !important;
        }
        
        .verif-main-table th, .verif-main-table td {
          border: 1px solid #000 !important;
          padding: 2px 5px !important; /* Padding diperkecil agar muat banyak baris */
        }

        /* Kolom Nama Berkas diperlebar otomatis */
        .verif-main-table th:nth-child(2),
        .verif-main-table td:nth-child(2) {
          width: 70% !important; 
        }

        /* Inputan tampak seperti teks biasa */
        .input-verif-cell {
          border: none !important;
          background: transparent !important;
          width: 100%;
          font-size: 10pt !important;
        }

        /* 5. LAYOUT TANDA TANGAN (POSISI & GARIS) */
        
        /* Container TTD Utama */
        .verif-signature-grid {
          display: block !important;
          margin-top: 20px !important;
          width: 100%;
        }

        /* Baris TTD (Kiri - Kanan) */
        .sig-row {
          display: flex !important;
          justify-content: space-between !important; /* Jarak maksimal kiri-kanan */
          width: 100%;
          margin-bottom: 15px;
        }

        /* Box Jabatan (Agar teks jabatan tetap tengah) */
        .verif-sig-box {
          width: 45% !important;
          text-align: center; 
          font-size: 11pt !important;
        }

        /* Label Tengah (Tulisan 'Verifikator') */
        .sig-label-center {
          text-align: center;
          width: 100%;
          font-weight: bold;
          margin: 10px 0;
          font-size: 11pt;
        }

        /* WRAPPER NAMA & NIP (Agar Rata Kiri Sejajar) */
        .sig-wrap {
          display: inline-block; /* Bungkus konten agar bisa di-center oleh parent */
          text-align: left;      /* Isi dalam (Nama & NIP) rata kiri */
          margin-top: 60px;      /* Jarak Tanda Tangan */
        }

        /* GARIS BAWAH NAMA (Tipis & Panjang) */
        .verif-sig-name {
          display: block;
          border-bottom: 1px solid #000 !important; /* Garis tipis 1px */
          min-width: 220px;              /* Panjang garis minimal */
          padding-bottom: 2px;
          margin-bottom: 2px;
          font-weight: bold;
          text-transform: uppercase;
          text-decoration: none !important; /* Hapus underline font bawaan */
          line-height: 1.2;
        }

        /* NIP (Rata Kiri mengikuti Wrapper) */
        .verif-sig-nip {
          font-size: 10pt;
          font-weight: normal;
        }
      }
    </style>
  </head>
  <body>

    <div id="global-satuan-list" class="suggestion-list" style="display:none; position: absolute; z-index: 1030;"></div>

    <div id="loading" class="loading-overlay hidden">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h5 id="loadingText" class="fw-bold text-secondary">Memuat...</h5>
    </div>

    <div id="view-login" class="container view-section">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-primary"><i class="fas fa-book-open"></i> LPJ BOS</h3>
        <p class="text-center text-muted">Sistem Manajemen LPJ Sekolah</p>
        <form id="formLogin" onsubmit="handleLogin(event)">
          <div class="mb-3">
            <label class="form-label">Email Sekolah</label>
            <input type="email" class="form-control" id="loginEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="loginPass" required>
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('loginPass', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">Masuk</button>
          <div class="text-end mb-3">
            <small><span class="text-muted cursor-pointer" onclick="switchView('view-reset')">Lupa Password?</span></small>
          </div>
        </form>
        <div class="text-center mt-3">
          <small>Belum punya akun? <span class="text-primary cursor-pointer text-decoration-underline" onclick="switchView('view-register')">Daftar disini</span></small>
        </div>
      </div>
    </div>

    <div id="view-register" class="container view-section hidden">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-success"><i class="fas fa-school"></i> Daftar Sekolah</h3>
        <form id="formRegister" onsubmit="handleRegister(event)">
          <div class="mb-3">
            <label class="form-label">Nama Sekolah</label>
            <input type="text" class="form-control" id="regNama" placeholder="Contoh: MTS Negeri 1..." required>
            <div class="form-text text-muted" style="font-size: 0.8rem;">Gunakan nama resmi sekolah.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email Aktif</label>
            <input type="email" class="form-control" id="regEmail" placeholder="email@gmail.com" required>
            
            <div class="mt-1 p-2 bg-warning bg-opacity-10 border border-warning rounded" style="font-size: 0.8rem;">
              <i class="fas fa-exclamation-triangle text-warning me-1"></i>
              <strong class="text-dark">PENTING:</strong> Wajib gunakan <span class="text-decoration-underline">Email Aktif</span>.
              <br>
              <span class="text-muted ms-3">Jika lupa password, Kode OTP hanya akan dikirim ke email ini.</span>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Password</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="regPass" required placeholder="Minimal 6 karakter" minlength="6">
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('regPass', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Konfirmasi Password</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="regPassConfirm" placeholder="Ketik ulang password..." required>
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('regPassConfirm', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>

          <button type="submit" class="btn btn-success w-100">Daftar Sekarang</button>
        </form>
        <div class="text-center mt-3">
          <small>Sudah punya akun? <span class="text-primary cursor-pointer text-decoration-underline" onclick="switchView('view-login')">Login disini</span></small>
        </div>
      </div>
    </div>

    <div id="view-reset" class="container view-section hidden">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-danger"><i class="fas fa-user-lock"></i> Reset Password</h3>
        
        <form id="formStep1" onsubmit="handleSendOtp(event)">
          <div class="mb-3">
            <label class="form-label">Masukkan Email Sekolah</label>
            <input type="email" class="form-control" id="resetEmailInput" placeholder="email@sekolah..." required>
            <div class="form-text">Kode OTP akan dikirim jika email terdaftar.</div>
          </div>
          
          <button type="submit" id="btnSendOtp" class="btn btn-primary w-100">
            <i class="fas fa-paper-plane me-1"></i> Kirim Kode OTP
          </button>
          
          <div class="text-center mt-3 border-top pt-2">
            <small class="text-muted">Sudah punya kode OTP aktif?</small><br>
            <span class="text-primary cursor-pointer fw-bold text-decoration-underline" onclick="manualInputOtp()">
               <i class="fas fa-keyboard me-1"></i> Masukkan Kode Disini
            </span>
          </div>
        </form>

        <form id="formStep2" class="hidden mt-3" onsubmit="handleConfirmReset(event)">
          <div class="alert alert-info py-2 mb-3" style="font-size: 0.9rem;">
            <i class="fas fa-info-circle me-1"></i> Silakan masukkan kode OTP dari email.
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Kode OTP (6 Digit)</label>
            <input type="text" class="form-control text-center font-monospace fs-4 letter-spacing-2" 
                   id="resetOtpInput" maxlength="6" placeholder="000000" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Password Baru</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="resetPassNew" required placeholder="Minimal 6 karakter" minlength="6">
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('resetPassNew', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Konfirmasi Password</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="resetPassConf" placeholder="Ketik ulang password..." required>
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('resetPassConf', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>

          <button type="submit" id="btnConfirmReset" class="btn btn-danger w-100 mb-2">Ubah Password</button>
        </form>

        <button type="button" class="btn btn-outline-secondary w-100 mt-3" onclick="resetViewReset()">
          <i class="fas fa-arrow-left me-1"></i> Batal / Kembali Login
        </button>
      </div>
    </div>

    <div id="view-admin" class="container-fluid view-section hidden p-0"> <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="row g-0"> <div id="sidebarMenu" class="col-md-3 col-lg-3 col-xl-2 sidebar p-3">
          <div class="d-flex justify-content-between align-items-center">
              <h4 class="text-center py-3 border-bottom w-100"><i class="fas fa-user-shield"></i> Versi 1.0</h4>
              <button class="btn btn-sm text-white d-md-none" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
          </div>
          <ul class="nav flex-column mt-4">
            <li class="nav-item">
              <a onclick="navigasiKe('panel-dashboard', this)" class="nav-link active" style="cursor: pointer;">
                <i class="fas fa-home me-2"></i> Dashboard
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Data Master</small></li>
            
            <li class="nav-item">
              <a onclick="navigasiKe('panel-data-sekolah', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-school me-2"></i> Data Sekolah
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-uraian', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-list-ul me-2"></i> Data Uraian Pekerjaan
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-toko', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-store me-2"></i> Data Toko
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-tukang', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-hammer me-2"></i> Data Tukang
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-guru', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-user-tie me-2"></i> Data Pemesan/Guru
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Pengaturan</small></li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-kop', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-image me-2"></i> Kop Surat
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-nomor-surat', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-list-ol me-2"></i> Nomor Surat
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-tanggal-surat', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-calendar-alt me-2"></i> Tanggal Surat
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Transaksi</small></li>
            
            <li class="nav-item">
              <a onclick="navigasiKe('panel-transaksi', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-shopping-cart me-2"></i> Transaksi Belanja
              </a>
            </li>

            <li class="nav-item mt-2">
              <small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Cetak</small>
            </li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-cetak-pdf', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-print me-2"></i> Cetak PDF
              </a>
            </li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-cetak-pendukung', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-file-signature me-2"></i> Cetak Pendukung
              </a>
            </li>
            
            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Akun</small></li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-ubah-password', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-key me-2"></i> Ubah Password
              </a>
            </li>

            <li class="nav-item mt-3 pt-3 border-top">
              <a onclick="logout()" class="nav-link text-danger" style="cursor: pointer;">
                <i class="fas fa-sign-out-alt me-2"></i> Keluar
              </a>
            </li>
          </ul>
        </div>

        <div class="col-md-9 col-lg-9 col-xl-10 p-0 p-md-4"> <div class="w-100 p-3 p-md-2">
          
          <div class="d-md-none mb-3 d-flex align-items-center justify-content-between">
            <button class="btn btn-primary" onclick="toggleSidebar()">
              <i class="fas fa-bars me-1"></i> Menu
            </button>
            <span class="fw-bold text-secondary">Aplikasi LPJ BOS</span>
          </div>

          <div id="panel-dashboard" class="panel-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div class="d-flex align-items-center flex-wrap">
                <h2 class="mb-0 me-2">Dashboard</h2>
                <span id="schoolNameDisplay" class="text-primary fs-5 fw-bold me-3"></span>
              </div>

              <button class="btn btn-primary" onclick="navigasiKe('panel-transaksi')">
                <i class="fas fa-plus me-1"></i> Transaksi Belanja
              </button>
            </div>

            <div class="row g-3 mb-4">
              
              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-primary text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Jumlah Anggaran</h6>
                    <i class="fas fa-wallet fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashAnggaran">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Dana BOS Tahunan</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-danger text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Total Pengeluaran</h6>
                    <i class="fas fa-shopping-cart fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashPengeluaran">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Toko, Tukang & Guru</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card p-3 shadow-sm h-100 text-white" id="cardSisaAnggaran" style="background-color: #ffc107;"> <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Sisa Anggaran</h6>
                    <i class="fas fa-chart-pie fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashSisa">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Saldo Tersedia</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-info text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Jumlah Transaksi</h6>
                    <i class="fas fa-list-ol fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashJmlTrans">0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Total Item Data</small>
                </div>
              </div>

            </div>

            <div class="card shadow-sm border-0 mt-4">
              <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-school text-primary me-2"></i> Identitas Sekolah</h5>
                
                <button class="btn btn-sm btn-outline-primary" 
                  onclick="navigasiKe('panel-data-sekolah', document.querySelector(`a[onclick*='panel-data-sekolah']`))">
                  <i class="fas fa-edit me-1"></i> Ubah Data
                </button>
              </div>
              
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 border-end-md">
                     <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Profil Sekolah</h6>
                     <table class="table table-borderless table-sm mb-0" style="font-size: 0.95rem;">
                      <tr>
                        <td width="35%" class="text-muted">Nama Sekolah</td>
                        <td class="fw-bold" id="dashNamaSekolah">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">NPSN / NSM</td>
                        <td><span id="dashNpsn" class="fw-bold">-</span> / <span id="dashNsm">-</span></td>
                      </tr>
                      <tr>
                        <td class="text-muted">Alamat</td>
                        <td id="dashAlamat">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Desa/Kelurahan</td>
                        <td id="dashKelurahan">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Kecamatan</td>
                        <td id="dashKecamatan">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Kab/Kota</td>
                        <td id="dashKabupaten">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">No. Telp / HP</td>
                        <td class="fw-bold text-success" id="dashTelp">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Email</td>
                        <td id="dashEmail">-</td>
                      </tr>
                     </table>
                  </div>

                  <div class="col-md-6 ps-md-4 mt-4 mt-md-0">
                     <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Pejabat Sekolah</h6>
                     <table class="table table-borderless table-sm mb-0" style="font-size: 0.95rem;">
                       <tr>
                         <td width="35%" class="text-muted">Kepala Sekolah</td>
                         <td class="fw-bold" id="dashKepala">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NIP Kepala</td>
                         <td id="dashNipKepala">-</td>
                       </tr>
                       <tr><td colspan="2" class="py-2"></td></tr>
                       <tr>
                         <td class="text-muted">Bendahara</td>
                         <td class="fw-bold" id="dashBendahara">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NIP Bendahara</td>
                         <td id="dashNipBendahara">-</td>
                       </tr>
                     </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-toko" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-store text-primary"></i> Data Toko / Rekanan</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Toko</div>
                  <div class="card-body">
                    <form id="formToko" onsubmit="submitToko(event)">
                      <input type="hidden" id="tkId">

                      <div class="mb-3">
                        <label class="form-label">Nama Toko</label>
                        <input type="text" class="form-control" id="tkNama" placeholder="Contoh: Toko Amanah" required>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label class="form-label">Jenis Toko</label>
                          <input type="text" class="form-control" id="tkJenis" placeholder="ATK, Elektronik, dll" required>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">No. Telp/HP</label>
                          <input type="text" class="form-control" id="tkTelp" placeholder="0812...">
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Nama Pemilik</label>
                        <input type="text" class="form-control" id="tkPemilik" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Tempat TTD (Alamat/Kota/Kab)</label>
                        <input type="text" class="form-control" id="tkTempat" placeholder="Contoh: Bulukumba">
                        <small class="text-muted">Alamat/Kota tempat penandatanganan nota.</small>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Alamat Lengkap Toko</label>
                        <textarea class="form-control" id="tkAlamat" rows="2" placeholder="Jalan, No, Desa..." required></textarea>
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanToko" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan Toko
                        </button>
                        <button type="button" id="btnBatalToko" class="btn btn-secondary hidden" onclick="batalEditToko()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Toko Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-sm text-nowrap" style="font-size: 0.9rem;">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Toko</th>
                            <th>Pemilik</th>
                            <th>Jenis</th>
                            <th>Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelTokoBody">
                          <tr><td colspan="4" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-tukang" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-hammer text-primary"></i> Data Tukang / Pekerja</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Tukang</div>
                  <div class="card-body">
                    <form id="formTukang" onsubmit="submitTukang(event)">
                      <input type="hidden" id="tkgId">

                      <div class="mb-3">
                        <label class="form-label">Nama Lengkap Tukang</label>
                        <input type="text" class="form-control" id="tkgNama" placeholder="Nama sesuai KTP" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Alamat Lengkap</label>
                        <textarea class="form-control" id="tkgAlamat" rows="3" placeholder="Jalan, RT/RW, Desa..." required></textarea>
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanTukang" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        <button type="button" id="btnBatalTukang" class="btn btn-secondary hidden" onclick="batalEditTukang()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Tukang Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Lengkap</th>
                            <th>Alamat</th>
                            <th style="width: 100px;">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelTukangBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-guru" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-user-tie text-primary"></i> Data Pemesan / Guru</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Guru</div>
                  <div class="card-body">
                    <form id="formGuru" onsubmit="submitGuru(event)">
                      <input type="hidden" id="grId">

                      <div class="mb-3">
                        <label class="form-label">Nama Lengkap Guru</label>
                        <input type="text" class="form-control" id="grNama" placeholder="Nama Lengkap & Gelar" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">NIP <small>(Opsional)</small></label>
                        <input type="text" class="form-control" id="grNip" placeholder="19...">
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanGuru" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        <button type="button" id="btnBatalGuru" class="btn btn-secondary hidden" onclick="batalEditGuru()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Guru Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Lengkap</th>
                            <th>NIP</th>
                            <th style="width: 100px;">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelGuruBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-nomor-surat" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-file-alt text-primary"></i> Pengaturan Nomor Surat</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-surat-toko" onclick="bukaTabSurat('toko')">
                  <i class="fas fa-store me-2"></i> Transaksi Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-surat-tukang" onclick="bukaTabSurat('tukang')">
                  <i class="fas fa-hammer me-2"></i> Transaksi Tukang
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-surat-setting" onclick="bukaTabSurat('setting')">
                  <i class="fas fa-cogs me-2"></i> Setting Nomor Otomatis
                </button>
              </li>
            </ul>

            <div id="view-surat-list"> 
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <div class="row g-2 mb-3 align-items-center">
                      <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                      <div class="col-auto">
                        <select id="fltTahun_surat" class="form-select form-select-sm" onchange="jalankanFilter('tabelSuratBody', 'fltTahun_surat', 'fltBulan_surat')"></select>
                      </div>
                      <div class="col-auto">
                        <select id="fltBulan_surat" class="form-select form-select-sm" onchange="jalankanFilter('tabelSuratBody', 'fltTahun_surat', 'fltBulan_surat')">
                          <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                        </select>
                      </div>
                    </div>

                    <div class="table-responsive">
                      <table class="table table-hover align-middle text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Tanggal</th>
                            <th>Uraian Belanja/Pekerjaan</th>
                            <th>Pihak Ketiga</th>
                            <th>Status Dokumen</th>
                            <th width="15%">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelSuratBody">
                          <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
            </div>

            <div id="view-surat-setting" class="hidden">
              <div class="card shadow-sm border-0">
                <div class="card-body">
                  
                  <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i> <strong>Panduan Format Otomatis:</strong><br>
                    Gunakan placeholder berikut dalam format surat Anda:
                    <ul>
                      <li><code>[nomor]</code> : Untuk input nomor urut surat (Contoh: 001, 002).</li>
                      <li><code>[bulan]</code> : Otomatis mengambil bulan dari tanggal transaksi (Contoh: 08, 12).</li>
                      <li><code>[tahun]</code> : Otomatis mengambil tahun dari tanggal transaksi (Contoh: 2025).</li>
                      <li><code>[apapun]</code> : Kata dalam kurung siku lain akan menjadi kolom input manual (Contoh: [kode], [romawi]).</li>
                    </ul>
                    Contoh Format: <code>B.[nomor]/MTs.21/[bulan]/[tahun]</code>
                  </div>

                  <ul class="nav nav-pills mb-3" id="pills-tab-setting" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="pills-set-toko-tab" data-bs-toggle="pill" data-bs-target="#pills-set-toko" type="button" role="tab">Setting Toko</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-set-tukang-tab" data-bs-toggle="pill" data-bs-target="#pills-set-tukang" type="button" role="tab">Setting Tukang</button>
                    </li>
                  </ul>

                  <div class="tab-content" id="pills-tabContent-setting">
                    
                    <div class="tab-pane fade show active" id="pills-set-toko" role="tabpanel">
                      
                      <div class="toggle-card p-3 rounded-3 d-flex justify-content-between align-items-center mb-4">
                        <div>
                          <label class="fw-bold d-block text-dark mb-1" for="toggleAutoToko" style="cursor: pointer;">
                            <i class="fas fa-robot text-primary me-2"></i> Penomoran Otomatis Toko
                          </label>
                          <small class="text-muted d-block" style="line-height: 1.2;">
                            Sistem akan mengisi nomor surat secara otomatis sesuai format.
                          </small>
                        </div>
                        
                        <div class="form-check form-switch custom-switch-lg mb-0">
                          <input class="form-check-input" type="checkbox" id="toggleAutoToko" onchange="toggleFormSetting('toko')">
                        </div>
                      </div>

                      <div id="formAutoToko" class="border p-4 rounded-3 bg-white shadow-sm hidden">
                          <h6 class="border-bottom pb-2 mb-3 text-primary fw-bold">Konfigurasi Format Surat Toko</h6>
                          
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Permintaan</label>
                            <input type="text" class="form-control" id="fmtTokoPermintaan" placeholder="Contoh: B.[nomor]/MTs.../[bulan]/[tahun]">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Penawaran</label>
                            <input type="text" class="form-control" id="fmtTokoPenawaran">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pemeriksaan</label>
                            <input type="text" class="form-control" id="fmtTokoPemeriksaan">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Serah Terima (BAST)</label>
                            <input type="text" class="form-control" id="fmtTokoBAST">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pembayaran</label>
                            <input type="text" class="form-control" id="fmtTokoBayar">
                          </div>
                      </div>
                    </div>

                    <div class="tab-pane fade" id="pills-set-tukang" role="tabpanel">
                      
                      <div class="toggle-card p-3 rounded-3 d-flex justify-content-between align-items-center mb-4">
                        <div>
                          <label class="fw-bold d-block text-dark mb-1" for="toggleAutoTukang" style="cursor: pointer;">
                            <i class="fas fa-magic text-warning me-2"></i> Penomoran Otomatis Tukang
                          </label>
                          <small class="text-muted d-block" style="line-height: 1.2;">
                            Aktifkan fitur ini untuk generate nomor surat tukang otomatis.
                          </small>
                        </div>
                        
                        <div class="form-check form-switch custom-switch-lg mb-0">
                          <input class="form-check-input" type="checkbox" id="toggleAutoTukang" onchange="toggleFormSetting('tukang')">
                        </div>
                      </div>
                      
                      <div id="formAutoTukang" class="border p-4 rounded-3 bg-white shadow-sm hidden">
                        <h6 class="border-bottom pb-2 mb-3 text-warning fw-bold text-dark">Konfigurasi Format Surat Tukang</h6>

                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Permintaan</label>
                          <input type="text" class="form-control" id="fmtTukangPermintaan">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pemeriksaan</label>
                          <input type="text" class="form-control" id="fmtTukangPemeriksaan">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Serah Terima (BAST)</label>
                          <input type="text" class="form-control" id="fmtTukangBAST">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pembayaran</label>
                          <input type="text" class="form-control" id="fmtTukangBayar">
                        </div>
                      </div>
                    </div>

                  </div>
                  
                  <div class="mt-4 border-top pt-3 text-end">
                    <button class="btn btn-primary" onclick="simpanSettingNomor()"><i class="fas fa-save me-1"></i> Simpan Pengaturan</button>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalSurat" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Kelola Nomor Surat</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="formInputSurat" onsubmit="simpanSurat(event)">
                    <input type="hidden" id="suratTransId">
                    <input type="hidden" id="suratTransTipe">
                    <input type="hidden" id="suratTransTanggal"> 
                    
                    <div id="alertManualMode" class="alert alert-info py-2 mb-3">
                      <small><i class="fas fa-info-circle"></i> Mode Manual: Silakan ketik nomor surat lengkap.</small>
                    </div>
                    
                    <div id="alertAutoMode" class="alert alert-success py-2 mb-3 hidden">
                      <small><i class="fas fa-robot"></i> Mode Otomatis: Masukkan variabel yang diminta.</small>
                    </div>

                    <div id="containerInputSurat">
                        </div>

                    <div class="modal-footer px-0 pb-0 mt-4">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="submit" id="btnSimpanSurat" class="btn btn-primary"><i class="fas fa-save me-1"></i> Simpan Dokumen</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-tanggal-surat" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-calendar-alt text-primary"></i> Pengaturan Tanggal Surat</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-tgl-toko" onclick="bukaTabTanggal('toko')">
                  <i class="fas fa-store me-2"></i> Transaksi Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-tgl-tukang" onclick="bukaTabTanggal('tukang')">
                  <i class="fas fa-hammer me-2"></i> Transaksi Tukang
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                <div class="row g-2 mb-3 align-items-center">
                  <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                  <div class="col-auto">
                    <select id="fltTahun_tgl" class="form-select form-select-sm" onchange="jalankanFilter('tabelTanggalBody', 'fltTahun_tgl', 'fltBulan_tgl')"></select>
                  </div>
                  <div class="col-auto">
                    <select id="fltBulan_tgl" class="form-select form-select-sm" onchange="jalankanFilter('tabelTanggalBody', 'fltTahun_tgl', 'fltBulan_tgl')">
                      <option value="">Semua Bulan</option>
                      <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                      <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                      <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                      <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                    </select>
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table table-hover align-middle text-nowrap">
                    <thead class="table-light">
                      <tr>
                        <th>Tanggal Transaksi</th>
                        <th>Uraian</th>
                        <th>Pihak Ketiga</th>
                        <th>Status Tanggal</th>
                        <th width="15%">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="tabelTanggalBody">
                      <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalReferensiUraian" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable"> 
              <div class="modal-content border-0 shadow-lg">
                
                <div class="modal-header bg-info text-white bg-gradient">
                  <h5 class="modal-title"><i class="fas fa-book-reader me-2"></i> Referensi Standar & Kegiatan</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                  
                  <div class="row g-2 mb-4">
                    <div class="col-md-4">
                      <label class="form-label fw-bold small text-muted">Filter Standar Pendidikan</label>
                      <select class="form-select form-select-sm" id="refFilterStandar" onchange="filterTabelReferensi()">
                        <option value="">-- Semua Standar --</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label fw-bold small text-muted">Pencarian Kata Kunci</label>
                      <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="refSearchInput" placeholder="Cari Uraian, Kode, atau Kegiatan..." onkeyup="filterTabelReferensi()">
                      </div>
                    </div>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle" style="font-size: 0.85rem;">
                      <thead class="table-light text-center sticky-top" style="top: 0; z-index: 2;">
                        <tr>
                          <th width="20%">Standar Pendidikan (SNP)</th>
                          <th width="25%">Nama Kegiatan</th>
                          <th width="10%">Kode</th>
                          <th>Nama Uraian</th>
                          <th width="8%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="bodyTabelReferensi">
                        <tr><td colspan="5" class="text-center text-muted py-4">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <div class="mt-2 text-end text-muted fst-italic" style="font-size: 0.8rem;">
                    <small>Total Data: <span id="refTotalData">0</span> Baris</small>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalTanggal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title"><i class="fas fa-calendar-day me-2"></i> Atur Tanggal Dokumen</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="formInputTanggal" onsubmit="simpanTanggal(event)">
                    <input type="hidden" id="tglTransId">
                    <input type="hidden" id="tglTransTipe">
                    
                    <div class="alert alert-success py-2 mb-3">
                      <small><i class="fas fa-info-circle"></i> Tanggal Surat Permintaan otomatis mengikuti tanggal transaksi.</small>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. Surat Permintaan</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control bg-light" id="tglSuratPermintaan" readonly>
                        <div class="form-text text-success"><i class="fas fa-lock me-1"></i> Terkunci (Sesuai Tgl Transaksi)</div>
                      </div>
                    </div>

                    <div class="mb-3 row" id="wrapTglPenawaran">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. Surat Penawaran</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglSuratPenawaran">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Pemeriksaan</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaPemeriksaan">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Serah Terima</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaSerahTerima">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Pembayaran</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaPembayaran">
                      </div>
                    </div>

                    <div class="modal-footer px-0 pb-0 mt-4">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="submit" id="btnSimpanTanggal" class="btn btn-success"><i class="fas fa-save me-1"></i> Simpan Tanggal</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalInfoBarang" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl"> 
              <div class="modal-content border-0 shadow-lg">
                
                <div class="modal-header bg-warning text-dark bg-gradient">
                  <h5 class="modal-title"><i class="fas fa-boxes me-2"></i> Referensi Barang & Harga</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                
                <div class="input-group mb-3 shadow-sm">
                  <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                  <input type="text" class="form-control border-start-0 ps-0" id="cariBarangInput" placeholder="Cari nama barang..." onkeyup="filterInfoBarang()">
                </div>

                <div class="table-responsive" style="max-height: 55vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
                  
                  <table class="table table-hover align-middle table-bordered mb-0" style="table-layout: fixed; min-width: 1000px;"> 
                    
                    <thead class="text-center sticky-top" style="z-index: 10; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                      <tr>
                        <th style="width: 22%; background-color: #f8f9fa;">Kategori</th> 
                        <th style="width: 15%; background-color: #f8f9fa;">Nama Kategori</th>
                        <th style="width: 32%; background-color: #f8f9fa;">Nama Barang/Jasa</th>
                        <th style="width: 8%;  background-color: #f8f9fa;">Satuan</th>
                        <th style="width: 15%; background-color: #f8f9fa;">Harga Referensi</th>
                        <th style="width: 8%; background-color: #f8f9fa;">Aksi</th>
                      </tr>
                    </thead>
                    
                    <tbody id="bodyInfoBarang">
                      <tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr>
                    </tbody>
                  </table>

                </div>

                <div id="paginationContainer" class="d-flex flex-column flex-sm-row justify-content-between align-items-center mt-3 pt-3 border-top hidden gap-2">
                    
                    <div class="text-center text-sm-start">
                      <small class="text-muted" style="font-size: 0.85rem;">
                        Menampilkan <span id="lblStart">0</span> - <span id="lblEnd">0</span> dari <span id="lblTotal">0</span> data
                      </small>
                    </div>

                    <div class="btn-group btn-group-sm shadow-sm">
                      
                      <button class="btn btn-outline-secondary px-3" id="btnPrevPage" onclick="gantiHalaman(-1)">
                        <i class="fas fa-chevron-left"></i> 
                        <span class="d-none d-sm-inline ms-1">Sebelumnya</span>
                      </button>
                      
                      <button class="btn btn-outline-secondary disabled px-3 fw-bold text-dark" id="lblPageIndicator" style="background-color: #f8f9fa; border-color: #6c757d;">
                        1 / 1
                      </button>
                      
                      <button class="btn btn-outline-secondary px-3" id="btnNextPage" onclick="gantiHalaman(1)">
                        <span class="d-none d-sm-inline me-1">Selanjutnya</span> 
                        <i class="fas fa-chevron-right"></i>
                      </button>

                    </div>

                </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalInfoSatuan" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content border-0 shadow-lg">
                
                <div class="modal-header bg-info text-white bg-gradient">
                  <h5 class="modal-title"><i class="fas fa-ruler-combined me-2"></i> Referensi Satuan</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                  
                  <div class="input-group mb-4 shadow-sm">
                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="cariSatuanInput" placeholder="Cari nama satuan atau kegunaan..." onkeyup="filterInfoSatuan()">
                  </div>

                  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th width="20%">Nama Satuan</th>
                          <th width="25%">Kategori</th>
                          <th>Penggunaan Umum / Contoh</th>
                        </tr>
                      </thead>
                      <tbody id="bodyInfoSatuan">
                        <tr><td colspan="3" class="text-center text-muted">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <div class="mt-3 text-end text-muted fst-italic" style="font-size: 0.8rem;">
                    <small>* Data diambil dari sheet "Satuan" di database.</small>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div id="panel-kop" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-image text-primary"></i> Pengaturan Kop Surat</h2>
            
            <div class="card shadow-sm border-0" style="max-width: 600px;">
              <div class="card-body p-4">
                
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-1"></i> Upload gambar kop surat (Header). Format: JPG/PNG. Ukuran optimal lebar 800px.
                </div>

                <div class="text-center mb-4 p-3 border rounded bg-light" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                  <img id="imgPreview" src="" alt="Preview Kop Surat" style="max-width: 100%; height: auto; display: none;">
                  <span id="txtNoImage" class="text-muted fst-italic">Belum ada kop surat yang diupload.</span>
                </div>

                <form id="formKop" onsubmit="uploadKop(event)">
                  <div class="mb-3">
                    <label class="form-label fw-bold">Pilih Gambar</label>
                    <input class="form-control" type="file" id="fileKop" accept="image/png, image/jpeg" onchange="previewImage(this)" required>
                  </div>

                  <div class="d-flex justify-content-between">
                    <button type="button" id="btnHapusKop" class="btn btn-danger hidden" onclick="aksiHapusKop()">
                      <i class="fas fa-trash-alt me-1"></i> Hapus Kop
                    </button>
                    <button type="submit" id="btnSimpanKop" class="btn btn-primary">
                      <i class="fas fa-cloud-upload-alt me-1"></i> Upload & Simpan
                    </button>
                  </div>
                </form>

              </div>
            </div>
          </div>

          <div id="panel-transaksi" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-shopping-cart text-primary"></i> Transaksi Belanja</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4" id="transaksiTabs">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-btn-toko" onclick="bukaTab('toko')">
                  <i class="fas fa-store me-2"></i> Belanja Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-btn-guru" onclick="bukaTab('guru')">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Honor Guru
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-btn-tukang" onclick="bukaTab('tukang')">
                  <i class="fas fa-hammer me-2"></i> Upah Tukang
                </button>
              </li>
            </ul>

            <div id="tab-content-toko" class="tab-section">
              
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-success py-2 mb-3">
                    <small><i class="fas fa-info-circle"></i> Mode Input: Transaksi Belanja Barang / Jasa Toko</small>
                  </div>
                  <form id="formBelanjaToko">
                    <input type="hidden" id="trTokoId">
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Transaksi</label>
                        <input type="date" class="form-control" id="trTokoTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Belanja (RKAM)</label>
                        <select class="form-select" id="trTokoUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>

                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Pilih Toko / Rekanan</label>
                        <select class="form-select" id="trTokoNama" required>
                          <option value="">-- Pilih Toko --</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Pilih Data Pemesan</label>
                        <select class="form-select" id="trTokoPemesan" required>
                          <option value="">-- Pilih Guru/Pemesan --</option>
                        </select>
                      </div>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Daftar Barang Belanjaan</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap table-input-scroll" id="tabelItemToko">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="31%">Nama Barang</th>
                            <th width="10%">Vol</th>
                            <th width="11%">Satuan</th>
                            <th width="20%">Harga (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="8%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL BELANJA:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trTokoTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trTokoTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="action-container mt-3">
                      
                      <div class="action-group-left d-flex align-items-center gap-2">
                        
                        <button type="button" class="btn btn-outline-primary text-nowrap" onclick="tambahBaris('toko')">
                          <i class="fas fa-plus me-1"></i> Tambah Baris
                        </button>
                        
                        <div class="autocomplete-wrapper">
                          <div class="input-group">
                            <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" placeholder="Cari Referensi..." oninput="handleCariBarang(this, 'toko')" autocomplete="off">
                          </div>
                          <div id="saran-barang-toko" class="suggestion-list"></div>
                        </div>

                      </div>

                      <div class="action-group-right">
                        <button type="button" class="btn btn-warning text-dark me-1" onclick="bukaModalBarang()">
                          <i class="fas fa-boxes me-1"></i> Info Barang
                        </button>

                        <button type="button" class="btn btn-info text-white" onclick="bukaModalSatuan()">
                          <i class="fas fa-eye me-1"></i> Info Satuan
                        </button>

                        <button type="button" id="btnBatalTokoTrans" class="btn btn-secondary hidden" onclick="batalEditTransaksi('toko')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        <button type="button" id="btnSimpanTokoTrans" class="btn btn-success" onclick="simpanTransaksi('toko')">
                          <i class="fas fa-save me-1"></i> Simpan
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold py-3">Riwayat Transaksi Toko</div>
                <div class="card-body">
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_toko" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiToko', 'fltTahun_toko', 'fltBulan_toko')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_toko" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiToko', 'fltTahun_toko', 'fltBulan_toko')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian</th>
                          <th>Toko</th>
                          <th>Total</th>
                          <th>Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="listTransaksiToko">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              </div> 
            <div id="tab-content-guru" class="tab-section hidden">
              
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-info py-2 mb-3"><small><i class="fas fa-info-circle"></i> Mode Input: Pembayaran Honorarium / Transport Guru</small></div>
                  <form id="formBelanjaGuru">
                    <input type="hidden" id="trGuruId">
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Pembayaran</label>
                        <input type="date" class="form-control" id="trGuruTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Pekerjaan / Kegiatan</label>
                        <select class="form-select" id="trGuruUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>
                    <div class="mb-4">
                      <label class="form-label">Keterangan <small class="text-muted">(Opsional)</small></label>
                      <textarea class="form-control" id="trGuruKeterangan" rows="2" placeholder="Contoh: Honorarium bulan Januari 2025..."></textarea>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Rincian Penerima Honor</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap table-input-scroll" id="tabelItemGuru">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="31%">Nama Guru</th>
                            <th width="10%">Vol</th>
                            <th width="11%">Satuan</th>
                            <th width="20%">Honor/Upah (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="8%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL HONOR:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trGuruTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trGuruTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="action-container mt-3">
                      
                      <div class="action-group-left">
                        <button type="button" class="btn btn-outline-primary text-nowrap w-100" onclick="tambahBaris('guru')">
                          <i class="fas fa-plus me-1"></i> Tambah Penerima
                        </button>
                      </div>

                      <div class="action-group-right">
                        <button type="button" class="btn btn-warning text-dark me-1" onclick="bukaModalBarang()">
                          <i class="fas fa-boxes me-1"></i> Info Barang
                        </button>

                        <button type="button" class="btn btn-info text-white" onclick="bukaModalSatuan()">
                          <i class="fas fa-eye me-1"></i> Info Satuan
                        </button>

                        <button type="button" id="btnBatalGuruTrans" class="btn btn-secondary hidden" onclick="batalEditTransaksi('guru')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        
                        <button type="button" id="btnSimpanGuruTrans" class="btn btn-success" onclick="simpanTransaksi('guru')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold py-3">Riwayat Pembayaran Honor</div>
                <div class="card-body">
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_guru" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiGuru', 'fltTahun_guru', 'fltBulan_guru')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_guru" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiGuru', 'fltTahun_guru', 'fltBulan_guru')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Kegiatan</th>
                          <th>Keterangan</th>
                          <th>Total</th>
                          <th>Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="listTransaksiGuru">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              </div>
            <div id="tab-content-tukang" class="tab-section hidden">
              
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-warning py-2 mb-3"><small><i class="fas fa-info-circle"></i> Mode Input: Pembayaran Upah Tukang</small></div>
                  <form id="formBelanjaTukang">
                    <input type="hidden" id="trTukangId">
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Transaksi</label>
                        <input type="date" class="form-control" id="trTukangTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Pekerjaan</label>
                        <select class="form-select" id="trTukangUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>
                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Pilih Tukang / Pekerja</label>
                        <select class="form-select" id="trTukangNama" required>
                          <option value="">-- Pilih Tukang --</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Pilih Data Pemesan</label>
                        <select class="form-select" id="trTukangPemesan" required>
                          <option value="">-- Pilih Guru --</option>
                        </select>
                      </div>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Rincian Upah / Bahan</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap table-input-scroll" id="tabelItemTukang">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="31%">Jenis Pekerjaan/Item</th>
                            <th width="10%">Vol</th>
                            <th width="11%">Satuan</th>
                            <th width="20%">Upah/Harga (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="8%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL UPAH:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trTukangTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trTukangTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="action-container mt-3">
                      
                      <div class="action-group-left d-flex align-items-center gap-2">
                        
                        <button type="button" class="btn btn-outline-primary text-nowrap" onclick="tambahBaris('tukang')">
                          <i class="fas fa-plus me-1"></i> Tambah Baris
                        </button>
                        
                        <div class="autocomplete-wrapper">
                          <div class="input-group">
                            <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" placeholder="Cari Referensi..." oninput="handleCariBarang(this, 'tukang')" autocomplete="off">
                          </div>
                          <div id="saran-barang-tukang" class="suggestion-list"></div>
                        </div>

                      </div>

                      <div class="action-group-right">
                        <button type="button" class="btn btn-warning text-dark me-1" onclick="bukaModalBarang()">
                          <i class="fas fa-boxes me-1"></i> Info Barang
                        </button>

                        <button type="button" class="btn btn-info text-white" onclick="bukaModalSatuan()">
                          <i class="fas fa-eye me-1"></i> Info Satuan
                        </button>

                        <button type="button" id="btnBatalTukangTrans" class="btn btn-secondary hidden" onclick="batalEditTransaksi('tukang')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        
                        <button type="button" id="btnSimpanTukangTrans" class="btn btn-success" onclick="simpanTransaksi('tukang')">
                          <i class="fas fa-save me-1"></i> Simpan
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold py-3">Riwayat Transaksi Tukang</div>
                <div class="card-body">
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_tukang" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiTukang', 'fltTahun_tukang', 'fltBulan_tukang')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_tukang" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiTukang', 'fltTahun_tukang', 'fltBulan_tukang')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian</th>
                          <th>Tukang</th>
                          <th>Total</th>
                          <th>Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="listTransaksiTukang">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-cetak-pdf" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-print text-primary"></i> Cetak Laporan PDF</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-cetak-toko" onclick="bukaTabCetak('toko')">
                  <i class="fas fa-store me-2"></i> LPJ Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-cetak-guru" onclick="bukaTabCetak('guru')">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Honor Guru
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-cetak-tukang" onclick="bukaTabCetak('tukang')">
                  <i class="fas fa-hammer me-2"></i> Upah Tukang
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold text-dark" id="tab-cetak-setting" onclick="bukaTabCetak('setting')">
                  <i class="fas fa-cog me-2"></i> Pengaturan Template
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                
                <div id="view-cetak-toko" class="view-cetak">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Transaksi Belanja Toko Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_toko" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-toko', 'fltTahun_cetak_toko', 'fltBulan_cetak_toko')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_toko" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-toko', 'fltTahun_cetak_toko', 'fltBulan_cetak_toko')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Belanja</th>
                          <th>Nama Toko</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-toko">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-guru" class="view-cetak hidden">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Pembayaran Honor Guru Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_guru" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-guru', 'fltTahun_cetak_guru', 'fltBulan_cetak_guru')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_guru" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-guru', 'fltTahun_cetak_guru', 'fltBulan_cetak_guru')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Kegiatan</th>
                          <th>Keterangan</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-guru">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-tukang" class="view-cetak hidden">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Upah Tukang Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_tukang" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-tukang', 'fltTahun_cetak_tukang', 'fltBulan_cetak_tukang')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_tukang" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-tukang', 'fltTahun_cetak_tukang', 'fltBulan_cetak_tukang')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Pekerjaan</th>
                          <th>Nama Tukang</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-tukang">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-setting" class="view-cetak hidden">
                  <div class="row">
                    <div class="col-lg-5 mb-4">
                      <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold py-3 text-primary">
                          <i class="fas fa-file-word me-2"></i> Input ID Google Doc
                        </div>
                        <div class="card-body">
                          <div class="alert alert-warning py-2" style="font-size: 0.85rem;">
                            <i class="fas fa-exclamation-triangle me-1"></i> <strong>Penting:</strong> Pastikan Google Doc Template Anda aksesnya diatur menjadi <em>"Siapa saja yang memiliki link dapat melihat" (Anyone with the link can view)</em> agar sistem bisa membacanya.
                          </div>

                          <form id="formTemplate" onsubmit="simpanTemplate(event)">
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Laporan Toko</label>
                              <input type="text" class="form-control font-monospace" id="tplIdToko" placeholder="Contoh: 1Fl8Jaf4j6XI...">
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Honor Guru</label>
                              <input type="text" class="form-control font-monospace" id="tplIdGuru" placeholder="Contoh: 1pC4xjpoGps...">
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Upah Tukang</label>
                              <input type="text" class="form-control font-monospace" id="tplIdTukang" placeholder="Contoh: 1vNWFUOKI...">
                            </div>
                            
                            <div class="d-grid">
                              <button type="submit" id="btnSimpanTemplate" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Simpan Pengaturan
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <div class="col-lg-7">
                      <div class="card shadow-sm border-0">
                        <div class="card-body">
                          <h5 class="mb-3"><i class="fas fa-book-reader text-success me-2"></i> Panduan Pembuatan Template</h5>
                          
                          <div class="accordion" id="accordionPanduan">
                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                  1. Cara Mendapatkan ID Google Doc
                                </button>
                              </h2>
                              <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body bg-light">
                                  <ol class="small mb-0 ps-3">
                                    <li>Buka file Google Doc template Anda.</li>
                                    <li>Lihat pada Address Bar browser.</li>
                                    <li>Link biasanya seperti: <code>docs.google.com/document/d/<strong>ID_ADALAH_DISINI</strong>/edit</code></li>
                                    <li>Copy kode acak tersebut dan paste ke form di samping.</li>
                                  </ol>
                                </div>
                              </div>
                            </div>

                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                  2. Daftar Kode Placeholder (Wajib Copy-Paste)
                                </button>
                              </h2>
                              <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body p-0">
                                  <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                    <table class="table table-sm table-striped mb-0 small table-hover">
                                      <thead class="table-dark sticky-top">
                                        <tr>
                                          <th width="45%">Kode (Copy ke Doc)</th>
                                          <th>Keterangan Data</th>
                                        </tr>
                                      </thead>
                                      <tbody style="font-size: 0.85rem;">
                                        
                                        <tr class="table-secondary fw-bold"><td colspan="2">A. Identitas Sekolah & Pejabat</td></tr>
                                        <tr><td class="font-monospace text-danger">&lt;&lt;KOP SURAT&gt;&gt;</td><td>Gambar Kop Surat (Otomatis)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Sekolah&gt;&gt;</td><td>Nama Sekolah</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Madrasah&gt;&gt;</td><td>Alternatif Nama Sekolah</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Alamat Lengkap Sekolah&gt;&gt;</td><td>Jalan, Desa, Kecamatan, Kab.</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Alamat TTD Sekolah&gt;&gt;</td><td>Tempat/Kota Tanda Tangan</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Kecamatan&gt;&gt;</td><td>Kecamatan</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Kabupaten&gt;&gt;</td><td>Kabupaten/Kota</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Provinsi&gt;&gt;</td><td>Provinsi</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NAMA KEPALA SEKOLAH&gt;&gt;</td><td>Nama Kepala (Huruf Besar)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Kepala Sekolah&gt;&gt;</td><td>Nama Kepala (Format Standar)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NIP Kepala Sekolah&gt;&gt;</td><td>NIP Kepala Sekolah</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NAMA BENDAHARA&gt;&gt;</td><td>Nama Bendahara (Huruf Besar)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NIP Bendahara&gt;&gt;</td><td>NIP Bendahara</td></tr>

                                        <tr class="table-secondary fw-bold"><td colspan="2">B. Data Anggaran & Transaksi Umum</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Dana BOS&gt;&gt;</td><td>Jenis Anggaran (Misal: BOS Tahap 1)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Tahun Anggaran&gt;&gt;</td><td>Tahun Anggaran</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Periode&gt;&gt;</td><td>Periode (Misal: Januari - Juni)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nomor Bukti Uraian&gt;&gt;</td><td>Kode/No Bukti (dari Data Uraian)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Total&gt;&gt;</td><td>Total Angka (Rp 100.000)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Total Terbilang&gt;&gt;</td><td>Total Huruf (Seratus Ribu Rupiah)</td></tr>

                                        <tr class="table-info fw-bold"><td colspan="2">C. Khusus Transaksi Toko</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Nama Toko&gt;&gt;</td><td>Nama Toko / Rekanan</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Jenis Toko&gt;&gt;</td><td>Jenis Usaha (ATK/Elektronik)</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Alamat Lengkap Toko&gt;&gt;</td><td>Alamat Toko</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Alamat TTD Toko&gt;&gt;</td><td>Kota/Tempat Toko Menandatangani</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;NAMA PEMILIK TOKO&gt;&gt;</td><td>Nama Pemilik</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Telp Toko&gt;&gt;</td><td>Nomor HP/Telp Toko</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Uraian Pesanan&gt;&gt;</td><td>Judul Belanja/Pekerjaan</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Nama Pemesan&gt;&gt;</td><td>Nama Guru Pemesan</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;NIP PEMESAN&gt;&gt;</td><td>NIP Guru Pemesan</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat Keluar&gt;&gt;</td><td>No. Surat Permintaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.PB&gt;&gt;</td><td>No. BA Pemeriksaan Barang</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.STB&gt;&gt;</td><td>No. BA Serah Terima</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.Bayar&gt;&gt;</td><td>No. BA Pembayaran</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal Pesanan&gt;&gt;</td><td>Tgl Surat Permintaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal Penawaran&gt;&gt;</td><td>Tgl Surat Penawaran</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.PB&gt;&gt;</td><td>Tgl BA Pemeriksaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.STB&gt;&gt;</td><td>Tgl BA Serah Terima</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.Bayar&gt;&gt;</td><td>Tgl BA Pembayaran</td></tr>
                                        
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Hari Huruf BA.PB&gt;&gt;</td><td>Nama Hari (Senin, dst)</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Tanggal Huruf BA.PB&gt;&gt;</td><td>Tanggal Terbilang (Satu, dst)</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Bulan Huruf BA.PB&gt;&gt;</td><td>Nama Bulan (Januari, dst)</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Tahun Huruf BA.PB&gt;&gt;</td><td>Tahun Terbilang (Dua Ribu, dst)</td></tr>
                                        <tr><td colspan="2" class="fst-italic text-muted small ps-4">
                                          *Format Huruf di atas juga tersedia untuk suffix: <b>BA.STB</b> dan <b>BA.Bayar</b>.<br>
                                          Contoh: <code>&lt;&lt;Hari Huruf BA.STB&gt;&gt;</code>
                                        </td></tr>

                                        <tr class="table-warning fw-bold"><td colspan="2">D. Khusus Transaksi Tukang</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;NAMA TUKANG&gt;&gt;</td><td>Nama Tukang (Huruf Besar)</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;Nama Tukang&gt;&gt;</td><td>Nama Tukang (Kapital Awal)</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;Alamat Lengkap Tukang&gt;&gt;</td><td>Alamat Tukang</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;Uraian Pekerjaan&gt;&gt;</td><td>Judul Pekerjaan</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;NAMA PEMESAN TUKANG&gt;&gt;</td><td>Nama Guru Pengawas/Pemesanan</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;NIP PEMESAN TUKANG&gt;&gt;</td><td>NIP Guru Pengawas/Pemesanan</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Surat Permintaan Tukang&gt;&gt;</td><td>No. Surat Permintaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.PP&gt;&gt;</td><td>No. BA Pemeriksaan Pekerjaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.STP&gt;&gt;</td><td>No. BA Serah Terima Pekerjaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.Bayar&gt;&gt;</td><td>No. BA Pembayaran (Sama dgn Toko)</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal Surat Permintaan Tukang&gt;&gt;</td><td>Tgl Surat Permintaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.PP&gt;&gt;</td><td>Tgl BA Pemeriksaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.STP&gt;&gt;</td><td>Tgl BA Serah Terima</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.Bayar Tukang&gt;&gt;</td><td>Tgl BA Pembayaran</td></tr>
                                        
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Hari Huruf Tanggal BA.PP&gt;&gt;</td><td>Nama Hari Pemeriksaan</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Tanggal Huruf BA.PP&gt;&gt;</td><td>Tanggal Terbilang</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Bulan Huruf Tanggal BA.PP&gt;&gt;</td><td>Nama Bulan</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Tahun Huruf Tanggal BA.PP&gt;&gt;</td><td>Tahun Terbilang</td></tr>
                                        <tr><td colspan="2" class="fst-italic text-muted small ps-4">
                                          *Format Huruf di atas juga tersedia untuk suffix: <b>BA.STP</b> dan <b>BA.Bayar Tukang</b>.<br>
                                          Contoh: <code>&lt;&lt;Hari Huruf Tanggal BA.STP&gt;&gt;</code>
                                        </td></tr>

                                        <tr class="table-success fw-bold"><td colspan="2">E. Khusus Honor Guru</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Uraian Kegiatan&gt;&gt;</td><td>Judul Kegiatan</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Keterangan&gt;&gt;</td><td>Keterangan (Honor Bulan...)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Tanggal Transaksi&gt;&gt;</td><td>Tanggal Pembayaran</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Tanggal BA.Bayar&gt;&gt;</td><td>Tgl BA Pembayaran (Bisa diatur)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Guru 1&gt;&gt;</td><td>Nama Guru Pertama (Jika Tunggal)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NIP Guru 1&gt;&gt;</td><td>NIP Guru Pertama (Otomatis)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NAMA PEMESAN/GURU&gt;&gt;</td><td>Nama Pemesan/Penanggung Jawab (Kapital)</td></tr>
                                        
                                        <tr class="table-danger fw-bold"><td colspan="2">F. Khusus Tabel Rincian (Barang/Jasa)</td></tr>
                                        <tr>
                                          <td class="font-monospace">&lt;&lt;TABLE_ROW&gt;&gt;</td>
                                          <td>
                                            <b>WAJIB:</b> Letakkan kode ini di salah satu kolom pada baris tabel di Word/Doc Anda. <br>
                                            Sistem akan menduplikasi baris tersebut sebanyak jumlah barang.
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                  3. Contoh Penggunaan Placeholder Template
                                </button>
                              </h2>
                              <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body">
                                  <p class="small text-muted mb-2">
                                    Berikut adalah contoh dokumen asli yang sudah dipasangi placeholder. Klik ikon mata untuk membuka dan melihat isinya.
                                  </p>
                                  
                                  <ul class="list-group list-group-flush small">
                                    
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-store text-primary me-2"></i>
                                          <span class="fw-bold text-dark">Template Laporan Toko</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1Fl8Jaf4j6XIyF8TghkwUsmrqEKU7obVbuOWDxlIa56o/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Toko">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-chalkboard-teacher text-success me-2"></i>
                                          <span class="fw-bold text-dark">Template Honor Guru</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1pC4xjpoGpsCaidPqoWHjJAAFgwnuDnKPsONUrd3IeFg/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Guru">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-hammer text-warning me-2"></i>
                                          <span class="fw-bold text-dark">Template Upah Tukang</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1vNWFUOKIKob8SI0VX0ROxhZQ02Tl6eboiR2TZ7mzRqE/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Tukang">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                  </ul>
                                </div>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div id="panel-cetak-pendukung" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-file-signature text-primary"></i> Cetak Dokumen Pendukung</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-sub-sampul" onclick="bukaSubTab('sampul')">
                  <i class="fas fa-book me-2"></i> Cover / Sampul
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-sub-pengantar" onclick="bukaSubTab('pengantar')">
                  <i class="fas fa-envelope-open-text me-2"></i> Surat Pengantar
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-sub-verifikasi" onclick="bukaSubTab('verifikasi')">
                  <i class="fas fa-check-double me-2"></i> Lembar Verifikasi
                </button>
              </li>
            </ul>

            <div id="view-sub-sampul" class="sub-view-section">
              <div class="row">
                
                <div class="col-lg-4 mb-4">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-white fw-bold py-3">Pengaturan Sampul</div>
                    <div class="card-body">
                      
                      <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">Pilih Desain:</label>
                        <div class="d-grid gap-2">
                          <input type="radio" class="btn-check" name="desainSampul" id="ds1" value="design-v1" autocomplete="off" checked onchange="updatePreviewSampul()">
                          <label class="btn btn-outline-dark text-start btn-sm" for="ds1">1. Klasik (Border Ganda)</label>

                          <input type="radio" class="btn-check" name="desainSampul" id="ds2" value="design-v2" autocomplete="off" onchange="updatePreviewSampul()">
                          <label class="btn btn-outline-success text-start btn-sm" for="ds2">2. Modern (Blok Hijau)</label>

                          <input type="radio" class="btn-check" name="desainSampul" id="ds3" value="design-v3" autocomplete="off" onchange="updatePreviewSampul()">
                          <label class="btn btn-outline-secondary text-start btn-sm" for="ds3">3. Minimalis (Clean)</label>

                          <input type="radio" class="btn-check" name="desainSampul" id="ds4" value="design-v4" autocomplete="off" onchange="updatePreviewSampul()">
                          <label class="btn btn-outline-dark text-start btn-sm" for="ds4">4. Formal (Garis Tegas)</label>
                          
                          <input type="radio" class="btn-check" name="desainSampul" id="ds5" value="design-v5" autocomplete="off" onchange="updatePreviewSampul()">
                          <label class="btn btn-outline-primary text-start btn-sm" for="ds5">5. Kreatif (Bingkai Biru)</label>
                        </div>
                      </div>

                      <hr>

                      <div class="mb-3">
                        <label class="form-label small fw-bold">Instansi / Kementerian</label>
                        <input type="text" class="form-control form-control-sm" id="inpHeaderCover" value="KEMENTERIAN AGAMA" oninput="updatePreviewSampul()" placeholder="Contoh: YAYASAN PENDIDIKAN...">
                      </div>

                      <div class="mb-3">
                        <label class="form-label small fw-bold">Judul Laporan</label>
                        <input type="text" class="form-control form-control-sm" id="inpJudulCover" value="LAPORAN PENGGUNAAN DANA BOS" oninput="updatePreviewSampul()">
                      </div>
                      
                      <div class="mb-3">
                        <label class="form-label small fw-bold">Periode / Keterangan</label>
                        <input type="text" class="form-control form-control-sm" id="inpPeriodeCover" placeholder="Contoh: (Januari s/d Juni 2025)" oninput="updatePreviewSampul()">
                      </div>
                      
                      <div class="mb-3 p-2 border rounded bg-light">
                        <label class="form-label small fw-bold mb-2">Logo Sampul</label>
                        <div class="d-flex align-items-center mb-2">
                          <img id="logoPreviewForm" src="https://i.imgur.com/WqGSzFl.png" class="me-2 border bg-white rounded" width="50" height="50" style="object-fit: contain;">
                          <div class="w-100">
                              <input class="form-control form-control-sm mb-1" type="file" id="fileLogoSampul" accept="image/*" onchange="previewLogoLocal(this)">
                              <small class="text-muted d-block" style="font-size: 0.7rem;">*Klik tombol Simpan di bawah untuk upload permanen.</small>
                          </div>
                        </div>
                      </div>

                      <div class="d-grid gap-2 mt-4">
                        <button id="btnSimpanCover" class="btn btn-success btn-sm" onclick="simpanKonfigurasiSampul()">
                          <i class="fas fa-save me-1"></i> Simpan Teks & Logo
                        </button>
                        
                        <button class="btn btn-primary" onclick="cetakHalamanIni()">
                          <i class="fas fa-print me-2"></i> Cetak / Simpan PDF
                        </button>
                      </div>

                    </div>
                  </div>
                </div>

                <div class="col-lg-8">
                  <div class="card shadow-sm border-0 bg-light">
                    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                      <span class="fw-bold small"><i class="fas fa-eye me-1"></i> Live Preview</span>
                      <small class="text-muted">Kertas A4</small>
                    </div>
                    <div class="card-body p-0">
                      
                      <div class="sheet-container">
                        <div id="print-area" class="sheet">
                            <div id="cover-content" class="design-v1">
                                </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>

              </div>
            </div>

            <div id="view-sub-pengantar" class="sub-view-section hidden">
              <div class="row">
                
                <div class="col-lg-4 mb-4">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-white fw-bold py-3 text-primary">
                      <i class="fas fa-edit me-2"></i> Data Surat Pengantar
                    </div>
                    <div class="card-body">
                      
                      <div class="alert alert-info py-2 mb-3" style="font-size: 0.8rem;">
                        <i class="fas fa-magic me-1"></i>
                        Isi surat dan tujuan akan dibuat otomatis berdasarkan data sekolah.
                      </div>

                      <div class="mb-3">
                        <label class="form-label small fw-bold">Nomor Surat</label>
                        <input type="text" class="form-control" id="spNomor" placeholder="Contoh: 001/MTs.../..." oninput="updatePreviewPengantar()">
                      </div>

                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label small fw-bold">Tempat TTD</label>
                          <input type="text" class="form-control" id="spTempat" oninput="updatePreviewPengantar()">
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label small fw-bold">Tanggal TTD</label>
                          <input type="date" class="form-control" id="spTanggal" oninput="updatePreviewPengantar()">
                        </div>
                      </div>

                      <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-success" onclick="simpanPengantarDatabase()">
                          <i class="fas fa-cloud-upload-alt me-2"></i> Simpan Data
                        </button>
                        
                        <button class="btn btn-primary" onclick="cetakHalamanIni()">
                          <i class="fas fa-print me-2"></i> Cetak PDF
                        </button>
                      </div>

                    </div>
                  </div>
                </div>

                <div class="col-lg-8">
                  <div class="card shadow-sm border-0 bg-light">
                    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                      <span class="fw-bold small"><i class="fas fa-eye me-1"></i> Preview Surat Pengantar</span>
                      <small class="text-muted">Kertas A4</small>
                    </div>
                    <div class="card-body p-0">
                      
                      <div class="sheet-container">
                        <div id="print-area-sp" class="sheet" style="padding: 0; display: flex; flex-direction: column;">
                          
                          <div id="header-kop-container" style="width: 100%; text-align: center;">
                            <img id="spKopImage" src="" style="width: 100%; height: auto; object-fit: contain; display: none;">
                            <div id="spKopText" class="p-4 text-muted bg-light border-bottom" style="display:none; font-style: italic;">
                              <i class="fas fa-image me-1"></i> [Kop Surat Belum Diupload di Menu Pengaturan]
                            </div>
                          </div>

                          <div class="surat-body" style="padding: 5mm 15mm 15mm 15mm; flex-grow: 1;">
                            
                            <div class="text-center mb-4 mt-2">
                              <span class="fw-bold fs-5" style="text-decoration: underline;">SURAT PENGANTAR</span><br>
                              <span>Nomor Surat : <span id="prevSpNomor">...</span></span>
                            </div>

                            <div class="mb-4">
                              Kepada<br>
                              Yth. Kepala Kantor Kementerian Agama<br>
                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kabupaten <span class="dyn-kabupaten">...</span><br>
                              c.q. Pejabat Pembuat Komitmen BOS<br>
                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kementerian Agama Kabupaten <span class="dyn-kabupaten">...</span><br>
                              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;di <span class="dyn-kabupaten">...</span>
                            </div>

                            <table class="tbl-pengantar">
                              <thead>
                                <tr>
                                  <th width="5%">No.</th>
                                  <th width="45%">Jenis Surat</th>
                                  <th width="20%">Banyaknya</th>
                                  <th width="30%">Keterangan</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td class="text-center">1</td>
                                  
                                  <td style="text-align: justify; vertical-align: top;">
                                    Laporan Pertanggungjawaban (LPJ) penggunaan dana BOS reguler <span id="prevSpNamaSekolah" class="fw-bold">...</span>, <span id="prevSpKelurahan">...</span>, Kecamatan <span id="prevSpKecamatan">...</span>, Kabupaten <span class="dyn-kabupaten">...</span>.
                                  </td>
                                  
                                  <td class="text-center" style="vertical-align: top;">1 (Satu) Bendel</td>
                                  
                                  <td style="vertical-align: top;">Dikirimkan dengan hormat kepada bapak/ibu untuk diketahui sebagaimana mestinya.</td>
                                </tr>
                              </tbody>
                            </table>

                            <div class="signature-box">
                              <div class="mb-1"><span id="prevSpTempat">...</span>, <span id="prevSpTanggal">...</span></div>
                              <div class="fw-bold mb-5">Kepala Madrasah</div>
                              <br><br>
                              <div class="fw-bold text-decoration-underline mt-3 text-uppercase" id="prevSpKepala">...</div>
                              <div>NIP. <span id="prevSpNip">...</span></div>
                            </div>

                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>

              </div>
            </div>

            <div id="view-sub-verifikasi" class="sub-view-section hidden">
              <div class="row">
                <div class="col-lg-4 mb-4">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-white fw-bold py-3 text-primary">
                      <i class="fas fa-user-edit me-2"></i> Data Pejabat Verifikasi
                    </div>
                    <div class="card-body">
                      <div class="alert alert-warning py-2 small">
                        <i class="fas fa-info-circle me-1"></i> Kepala Madrasah diambil dari menu Data Sekolah.
                      </div>

                      <form id="formVerifikasiInput" onsubmit="simpanVerifikasi(event)">
                        
                        <h6 class="fw-bold mt-2 border-bottom pb-1">Verifikator I</h6>
                        <div class="mb-2">
                          <label class="form-label small mb-1">Nama Lengkap</label>
                          <input type="text" class="form-control form-control-sm" id="vfNama1" placeholder="Nama Verifikator 1">
                        </div>
                        <div class="mb-3">
                          <label class="form-label small mb-1">NIP</label>
                          <input type="text" class="form-control form-control-sm" id="vfNip1" placeholder="NIP...">
                        </div>

                        <h6 class="fw-bold mt-2 border-bottom pb-1">Verifikator II</h6>
                        <div class="mb-2">
                          <label class="form-label small mb-1">Nama Lengkap</label>
                          <input type="text" class="form-control form-control-sm" id="vfNama2" placeholder="Nama Verifikator 2">
                        </div>
                        <div class="mb-3">
                          <label class="form-label small mb-1">NIP</label>
                          <input type="text" class="form-control form-control-sm" id="vfNip2" placeholder="NIP...">
                        </div>

                        <h6 class="fw-bold mt-2 border-bottom pb-1">Pengawas Madrasah</h6>
                        <div class="mb-2">
                          <label class="form-label small mb-1">Nama Lengkap</label>
                          <input type="text" class="form-control form-control-sm" id="vfNamaPengawas" placeholder="Nama Pengawas">
                        </div>
                        <div class="mb-3">
                          <label class="form-label small mb-1">NIP</label>
                          <input type="text" class="form-control form-control-sm" id="vfNipPengawas" placeholder="NIP...">
                        </div>

                        <div class="d-grid gap-2 mt-4">
                          <button type="submit" id="btnSimpanVerif" class="btn btn-success">
                            <i class="fas fa-save me-1"></i> Simpan Data
                          </button>
                          <button type="button" class="btn btn-outline-danger btn-sm" onclick="resetTabelVerifikasi()">
                            <i class="fas fa-sync me-1"></i> Reset Tabel ke Default
                          </button>
                          <button type="button" class="btn btn-primary" onclick="window.print()">
                            <i class="fas fa-print me-1"></i> Cetak PDF
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

                <div class="col-lg-8">
                  <div class="card shadow-sm border-0 bg-light">
                    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                      <span class="fw-bold small"><i class="fas fa-eye me-1"></i> Preview Lembar Verifikasi</span>
                      <small class="text-muted">Kertas A4</small>
                    </div>
                    <div class="card-body p-0">
                      
                      <div class="sheet-container">
                        <div id="print-area-verif" class="sheet" style="height: auto; min-height: 297mm;">
                          <div class="verif-sheet">
                            
                            <div class="verif-title-top">
                              LEMBAR VERIFIKASI DAN VALIDASI PENGAJUAN BOS <span id="vfTitleTahun">2025</span>
                            </div>

                            <table class="verif-header-table">
                              <tr>
                                <td width="20%">Nama Madrasah</td>
                                <td width="2%">:</td>
                                <td class="fw-bold" id="vfSchoolName">...</td>
                              </tr>
                              <tr>
                                <td>NSM</td>
                                <td>:</td>
                                <td id="vfNsm">...</td>
                              </tr>
                              <tr>
                                <td>Alamat Madrasah</td>
                                <td>:</td>
                                <td id="vfAddress">...</td>
                              </tr>
                              <tr>
                                <td>Kecamatan</td>
                                <td>:</td>
                                <td id="vfKecamatan">...</td>
                              </tr>
                              <tr>
                                <td>Kabupaten/Kota</td>
                                <td>:</td>
                                <td id="vfKabupaten">...</td>
                              </tr>
                              <tr>
                                <td>Periode</td>
                                <td>:</td>
                                <td><span id="vfPeriode">...</span> Tahun <span id="vfTahun">...</span></td>
                              </tr>
                            </table>

                            <div class="verif-subtitle">
                              BERKAS YANG HARUS DIVERIFIKASI :
                            </div>

                            <table class="verif-main-table" id="tabelVerifikasi">
                              <thead>
                                <tr>
                                  <th width="5%">No.</th>
                                  <th>Nama Berkas</th>
                                  <th width="15%">Status<br><small>(Ada/Tidak)</small></th>
                                  <th width="20%">Keterangan</th>
                                  <th width="5%" class="btn-aksi-verif">Aksi</th>
                                </tr>
                              </thead>
                              <tbody id="bodyTabelVerif">
                                </tbody>
                            </table>

                            <div class="verif-signature-grid">
                              
                              <div class="sig-row">
                                <div class="verif-sig-box">
                                  <div>Kepala Madrasah</div>
                                  <div class="sig-wrap">
                                    <div class="verif-sig-name" id="prevVfKepala">&nbsp;</div>
                                    <div class="verif-sig-nip" id="prevVfNipKepala">NIP.</div>
                                  </div>
                                </div>

                                <div class="verif-sig-box">
                                  <div>Pengawas Madrasah</div>
                                  <div class="sig-wrap">
                                    <div class="verif-sig-name" id="prevVfPengawas">&nbsp;</div>
                                    <div class="verif-sig-nip" id="prevVfNipPengawas">NIP.</div>
                                  </div>
                                </div>
                              </div>

                              <div class="sig-label-center">Verifikator</div>

                              <div class="sig-row">
                                <div class="verif-sig-box">
                                  <div>Verifikator I</div>
                                  <div class="sig-wrap">
                                    <div class="verif-sig-name" id="prevVfNama1">&nbsp;</div>
                                    <div class="verif-sig-nip" id="prevVfNip1">NIP.</div>
                                  </div>
                                </div>

                                <div class="verif-sig-box">
                                  <div>Verifikator II</div>
                                  <div class="sig-wrap">
                                    <div class="verif-sig-name" id="prevVfNama2">&nbsp;</div>
                                    <div class="verif-sig-nip" id="prevVfNip2">NIP.</div>
                                  </div>
                                </div>
                              </div>

                            </div>

                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <div id="panel-uraian" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-list-ul text-primary"></i> Data Uraian Pekerjaan</h2>
            
            <div class="row">
              <div class="col-md-4">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Tambah Uraian Baru</div>
                  <div class="card-body">
                    <form id="formUraian" onsubmit="submitUraian(event)">
                      <input type="hidden" id="urId">
                      
                      <div class="mb-3">
                        <label class="form-label">Nomor Bukti</label>
                        <input type="text" class="form-control" id="urNoBukti" placeholder="Contoh: 01/BOS/..." required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Uraian Pekerjaan / Belanja</label>
                        <div class="autocomplete-wrapper">
                          <textarea class="form-control" id="urNama" rows="3" 
                            placeholder="Ketik minimal 3 huruf atau kode untuk cari referensi..." 
                            required 
                            oninput="handleInputUraian(this)" 
                            autocomplete="off"></textarea>
                          
                          <div id="listSaranUraian" class="suggestion-list"></div>
                        </div>
                        <small class="text-muted" style="font-size: 0.75rem;">*Pilih dari saran yang muncul atau ketik manual jika tidak ada.</small>
                      </div>
                      
                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanUraian" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        
                        <button type="button" id="btnBatalUraian" class="btn btn-secondary hidden" onclick="batalEdit()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-8">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="card-title mb-0">Daftar Uraian Tersimpan</h5>
                      <button class="btn btn-sm btn-info text-white" onclick="bukaModalReferensi()">
                        <i class="fas fa-book-open me-1"></i> Info Referensi
                      </button>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th width="25%">No. Bukti</th>
                            <th>Uraian Pekerjaan</th>
                            <th width="10%">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelUraianBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-pengaturan" class="panel-content hidden">
            <h2 class="mb-4">Pengaturan Sekolah</h2>
            <div class="card shadow-sm border-0">
              <div class="card-body">
                <form>
                  <div class="mb-3">
                    <label class="form-label">Nama Kepala Sekolah</label>
                    <input type="text" class="form-control" placeholder="Nama Lengkap & Gelar">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">NIP Kepala Sekolah</label>
                    <input type="text" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nama Bendahara</label>
                    <input type="text" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Alamat Sekolah</label>
                    <textarea class="form-control" rows="3"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </form>
              </div>
            </div>
          </div>

          <div id="panel-ubah-password" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-user-lock text-primary"></i> Ubah Password</h2>
            
            <div class="card shadow-sm border-0 w-100"> 
              <div class="card-body p-4">
                
                <div class="alert alert-info py-2 mb-4">
                  <i class="fas fa-info-circle me-1"></i> Demi keamanan, Anda wajib memverifikasi password lama sebelum membuat password baru.
                </div>

                <form id="formUbahPass" onsubmit="submitUbahPassword(event)">
                  
                  <div class="mb-4">
                    <label class="form-label fw-bold">Password Lama</label>
                    <div class="input-group">
                      <input type="password" class="form-control border-end-0" id="upOldPass" required placeholder="Masukkan password saat ini">
                      <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('upOldPass', this)">
                        <i class="fas fa-eye text-muted"></i>
                      </span>
                    </div>
                  </div>

                  <hr class="my-4 text-muted opacity-25">

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold text-primary">Password Baru</label>
                      <div class="input-group">
                        <input type="password" class="form-control border-end-0" id="upNewPass" required placeholder="Minimal 6 karakter" minlength="6">
                        <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('upNewPass', this)">
                          <i class="fas fa-eye text-muted"></i>
                        </span>
                      </div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold text-primary">Konfirmasi Password Baru</label>
                      <div class="input-group">
                        <input type="password" class="form-control border-end-0" id="upConfPass" required placeholder="Ketik ulang password baru">
                        <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('upConfPass', this)">
                          <i class="fas fa-eye text-muted"></i>
                        </span>
                      </div>
                    </div>
                  </div>

                  <div class="d-flex justify-content-end mt-4">
                    <button type="submit" id="btnSubmitPass" class="btn btn-primary px-4 py-2">
                      <i class="fas fa-save me-2"></i> Simpan Password Baru
                    </button>
                  </div>

                </form>
              </div>
            </div>
          </div>

          <div id="panel-data-sekolah" class="panel-content hidden">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-school text-primary"></i> Data Sekolah</h2>
            </div>

            <div class="mt-4 pt-3 border-top">
              <h6 class="fw-bold text-danger"><i class="fas fa-tools"></i> Maintenance Database</h6>
              <p class="small text-muted">Klik tombol ini jika Anda mengalami error "Kolom tidak ditemukan" atau setelah update aplikasi.</p>
              <button class="btn btn-outline-danger btn-sm" onclick="jalankanMaintenance()">
                <i class="fas fa-sync"></i> Sinkronisasi Struktur Tabel
              </button>
            </div>

            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <form id="formDataSekolah">
                        
                  <h5 class="text-primary border-bottom pb-2 mb-3">Identitas Sekolah</h5>
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label fw-bold">Nama Sekolah <span class="text-danger">*</span></label>
                      <input type="text" class="form-control bg-light" id="dsNamaSekolah" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-bold">NPSN <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="dsNpsn" required placeholder="Contoh: 40319868">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">NSM <small>(Opsional Bagi Madrasah)</small></label>
                      <input type="text" class="form-control" id="dsNsm" placeholder="Contoh: 1212...">
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">No. Telp Sekolah</label>
                      <input type="text" class="form-control" id="dsTelp" placeholder="Contoh: 0812...">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Email Sekolah</label>
                      <input type="email" class="form-control" id="dsEmail">
                    </div>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Alamat Lengkap</h5>
                  <div class="mb-3">
                    <label class="form-label">Alamat Jalan/Dusun</label>
                    <textarea class="form-control" id="dsAlamat" rows="2" placeholder="Jl. Raya..."></textarea>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Provinsi</label>
                      <input type="text" class="form-control" id="dsProvinsi">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Kabupaten/Kota</label>
                      <input type="text" class="form-control" id="dsKabupaten">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Kecamatan</label>
                      <input type="text" class="form-control" id="dsKecamatan">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Kelurahan/Desa</label>
                      <input type="text" class="form-control" id="dsKelurahan">
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-bold">Tempat TTD (Alamat/Kota/Kab) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="dsTempatTTD" placeholder="Contoh: Bulukumba">
                    <small class="text-muted">Hanya isi nama Alamat/Kota/Kabupaten.</small>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Pejabat Sekolah</h5>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Nama Kepala Sekolah</label>
                      <input type="text" class="form-control" id="dsKepala" placeholder="Nama Lengkap & Gelar">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">NIP Kepala <small>(Opsional)</small></label>
                      <input type="text" class="form-control" id="dsNipKepala">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Nama Bendahara</label>
                      <input type="text" class="form-control" id="dsBendahara">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">NIP Bendahara <small>(Opsional)</small></label>
                      <input type="text" class="form-control" id="dsNipBendahara">
                    </div>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Pengaturan Default BOS</h5>
                  <div class="row mb-3">
                    
                    <div class="col-md-4">
                      <label class="form-label fw-bold">Nama Dana BOS</label>
                      
                      <select class="form-select" id="dsDanaBos" onchange="cekPeriodeBos()">
                        <option value="">-- Pilih Jenis --</option>
                        <option value="Lainnya">Lainnya (Manual)</option>
                        <option value="Dana BOS Tahap 1">Dana BOS Tahap 1</option>
                        <option value="Dana BOS Tahap 2">Dana BOS Tahap 2</option>
                        <option value="Dana BOS Triwulan 1">Dana BOS Triwulan 1</option>
                        <option value="Dana BOS Triwulan 2">Dana BOS Triwulan 2</option>
                        <option value="Dana BOS Triwulan 3">Dana BOS Triwulan 3</option>
                        <option value="Dana BOS Triwulan 4">Dana BOS Triwulan 4</option>
                      </select>

                      <small id="infoPeriode" class="text-muted fst-italic d-block mt-1"></small>

                      <div id="wrapManualBos" class="hidden mt-2">
                        <label class="form-label text-muted" style="font-size: 0.8rem;">Nama Dana BOS:</label>
                        <input type="text" class="form-control mb-2" id="dsDanaBosManual" placeholder="Contoh: BOS Afirmasi">
                        
                        <label class="form-label text-muted" style="font-size: 0.8rem;">Ketik Periode:</label>
                        <input type="text" class="form-control" id="dsPeriodeManual" placeholder="Contoh: Januari - Juni">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-bold">Jumlah Anggaran</label>
                      <div class="input-group">
                        <span class="input-group-text">Rp</span>
                        <input type="text" class="form-control" id="dsJumlahAnggaran" placeholder="0" oninput="this.value = formatRibuanInput(this.value)">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-bold">Tahun Anggaran</label>
                      <input type="number" class="form-control" id="dsTahun" placeholder="2025">
                    </div>
                  </div>

                  <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-primary px-4" onclick="submitDataSekolah()">
                      <i class="fas fa-save me-2"></i> Simpan Data
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="main-footer">
        <a href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer">
          <p>&copy; <span id="currentYear"></span> Created by Syamsul Bahri</p>
        </a>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

      let cacheDataGuru = [];
      let cacheSatuan = [];
      // Ganti baris: let cacheMasterUraian = []; dengan 2 variabel ini:
      let cacheUserUraian = []; // Data dari riwayat inputan user (DataUraian)
      let cacheRefUraian = [];  // Data dari Master Referensi (Sheet Uraian)
      let cacheRefLengkap = []; // Menyimpan data lengkap (A,B,C,D)

      // --- GLOBAL CACHE STORAGE (UPDATED) ---
      let DATA_CACHE = {
        toko: null,
        tukang: null,
        guru: null,
        uraian: null,
        satuan: null,
        // Cache khusus Transaksi (Digunakan bersama oleh menu Transaksi, Surat, & Tanggal)
        transaksi_toko: null,
        transaksi_tukang: null,
        transaksi_guru: null,
        // Tambahan Cache Sekolah
        sekolah: null,
        template_settings: null,
        dashboard: null
      };

      // Variabel untuk menyimpan input mana yang sedang diketik user
      let activeSatuanInput = null;


      /* --- LOGIKA NAVIGASI UTAMA (SPA) --- */
      
      // 1. Pindah Antara Login, Register, dan Admin Panel
      function switchView(viewId) {
        // Sembunyikan semua view utama
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        // Tampilkan view yang dipilih
        document.getElementById(viewId).classList.remove('hidden');
      }


      // 2. Pindah Menu Sidebar (Dashboard <-> Buat LPJ <-> Pengaturan)
      function navigasiKe(panelId, linkElement) {
        // --- TAMBAHAN: CEK SESI SEBELUM PINDAH MENU ---
        // Ini hemat kuota karena hanya jalan saat user klik menu
        const email = localStorage.getItem('userEmail');
        const token = localStorage.getItem('sessionToken');
        
        if(email && token) {
          google.script.run.withSuccessHandler(function(res){
              if(!res.valid) {
                handleSessionInvalid(); // Panggil fungsi logout paksa di atas
              }
          }).updateUserActivity(email, token);
        }
        // ----------------------------------------------
        
        // 1. Mobile Sidebar logic
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById('sidebarMenu');
          const overlay = document.getElementById('sidebarOverlay');
          if(sidebar) sidebar.classList.remove('show'); // Tambahkan if
          if(overlay) overlay.classList.remove('show'); // Tambahkan if
        }

        // 2. Hide semua panel
        document.querySelectorAll('.panel-content').forEach(el => {
            if(el && el.classList) el.classList.add('hidden'); // Tambahkan cek if(el)
        });

        // 3. Show target panel
        const targetPanel = document.getElementById(panelId);
        if(targetPanel) {
            targetPanel.classList.remove('hidden');
            
            // Beri jeda 10ms agar browser selesai merender tampilan baru sebelum scroll ke atas
            setTimeout(function() {
              window.scrollTo({
                top: 0,
                behavior: 'smooth' // Opsional: Animasi scroll halus
              });
            }, 10);
        } else {
            console.warn("Panel tidak ditemukan: " + panelId); // Debugging
        }

        // 4. Update Sidebar Active State
        if (linkElement) {
          document.querySelectorAll('.sidebar .nav-link').forEach(el => el.classList.remove('active'));
          // HANYA jalankan jika linkElement benar-benar elemen HTML
          if (linkElement.classList) { 
              linkElement.classList.add('active');
          }
        }

        // --- Logika Load Data ---
        if(panelId === 'panel-dashboard') loadDashboardStats();
        if(panelId === 'panel-data-sekolah') loadDataSekolah();
        if(panelId === 'panel-uraian') {
            loadUraianData();      // Data tabel CRUD yang sudah ada
            loadMasterReferensi(); // <-- TAMBAHKAN INI
        }
        if(panelId === 'panel-toko') loadTokoData();
        if(panelId === 'panel-tukang') loadTukangData();
        if(panelId === 'panel-guru') loadGuruData();
        if(panelId === 'panel-kop') loadKopSettings();
        
        if(panelId === 'panel-transaksi') {
          loadTransaksiOptions(); 
          if(document.getElementById('tabelItemToko').tBodies[0].rows.length === 0) tambahBaris('toko');
          if(document.getElementById('tabelItemTukang').tBodies[0].rows.length === 0) tambahBaris('tukang');
          if(document.getElementById('tabelItemGuru').tBodies[0].rows.length === 0) tambahBaris('guru');
          bukaTab('toko'); 
        }

        if(panelId === 'panel-nomor-surat') bukaTabSurat('toko');
        if(panelId === 'panel-tanggal-surat') bukaTabTanggal('toko');
        if(panelId === 'panel-cetak-pdf') bukaTabCetak('toko');

        if(panelId === 'panel-cetak-pendukung') {
          bukaSubTab('sampul'); // Default buka tab sampul
        }
      }

      /* --- LOGIKA APLIKASI --- */

      window.onload = function() {
        loadCacheFromLocal();

        const token = localStorage.getItem('userToken');
        if(token) {
          switchView('view-admin');
          document.getElementById('schoolNameDisplay').innerText = "(" + localStorage.getItem('userName') + ")";
          
          // Tambahkan ini agar saat login/refresh, data dashboard langsung muncul
          loadDashboardStats(); 
          
        } else {
          switchView('view-login');
        }
      };

      /**
       * Fungsi Loading dengan Pesan Dinamis
       * @param {boolean} show - Tampilkan (true) atau Sembunyikan (false)
       * @param {string} text - (Opsional) Pesan teks yang ingin ditampilkan
       */
      function toggleLoading(show, text = "Memuat...") {
        const el = document.getElementById('loading');
        const txtEl = document.getElementById('loadingText');
        
        if (show) {
          if(txtEl) txtEl.innerText = text; // Set teks sesuai permintaan
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      }

      /* --- UPDATE PADA INDEX.HTML --- */

      function handleLogin(e) {
        e.preventDefault();
        toggleLoading(true, "Memverifikasi Akun...");
        
        const emailInput = document.getElementById('loginEmail').value; 
        const form = {
          email: emailInput,
          password: document.getElementById('loginPass').value
        };

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res){
            toggleLoading(false);
            
            if(res.status === 'success') {
              // [PERBAIKAN 1] BERSIHKAN TOTAL DATA LAMA SEBELUM MENYIMPAN YANG BARU
              // Ini mencegah data User A 'bocor' ke User B
              localStorage.clear(); 
              
              // Reset Cache Global Variable ke kondisi awal (KOSONG)
              DATA_CACHE = {
                  toko: null, tukang: null, guru: null, uraian: null, satuan: null,
                  transaksi_toko: null, transaksi_tukang: null, transaksi_guru: null,
                  sekolah: null, template_settings: null, dashboard: null
              };
              
              // Reset Variabel Global lain
              cacheDataGuru = [];
              cacheSatuan = [];
              cacheRefUraian = [];
              cacheUserUraian = [];

              // Reset Tampilan UI yang mungkin masih nyangkut
              document.getElementById('schoolNameDisplay').innerText = "";
              document.getElementById('dashNamaSekolah').innerText = "-";
              
              // [PERBAIKAN 2] BARU SIMPAN DATA USER BARU (USER B)
              localStorage.setItem('userToken', res.token);
              localStorage.setItem('userName', res.namaSekolah);
              localStorage.setItem('userEmail', emailInput);
              localStorage.setItem('sessionToken', res.sessionToken);
              
              const elName = document.getElementById('schoolNameDisplay');
              if(elName) elName.innerText = "(" + res.namaSekolah + ")";
              
              // Pindah View
              switchView('view-admin');
              
              // Load Data Baru (Fresh dari Server milik User B)
              loadDashboardStats(true); // Gunakan true untuk force refresh
              
              // Mulai Monitor Sesi
              startSessionMonitor();

            } else {
              Swal.fire({
                icon: 'error',
                title: 'Login Gagal',
                html: res.message
              });
            }
          })
          .loginUser(form);
      }

      function handleRegister(e) {
        e.preventDefault();
        
        // 1. AMBIL INPUT PASSWORD
        const pass1 = document.getElementById('regPass').value;
        const pass2 = document.getElementById('regPassConfirm').value;

        // --- VALIDASI BARU: PANJANG PASSWORD ---
        if (pass1.length < 6) {
          Swal.fire({
            icon: 'warning',
            title: 'Password Terlalu Pendek',
            text: 'Password minimal harus terdiri dari 6 karakter.'
          });
          return;
        }

        // 2. VALIDASI KECOCOKAN
        if (pass1 !== pass2) {
          Swal.fire({
            icon: 'warning',
            title: 'Password Tidak Cocok',
            text: 'Konfirmasi password harus sama dengan password utama.'
          });
          return;
        }

        toggleLoading(true);
        
        // Data Form
        const form = {
          namaSekolah: document.getElementById('regNama').value,
          email: document.getElementById('regEmail').value,
          password: document.getElementById('regPass').value
        };

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res){
            toggleLoading(false);
            if(res.status === 'success') {
              document.getElementById('formRegister').reset();
              
              // Pesan Sukses
              Swal.fire({
                title: 'Registrasi Berhasil!',
                text: 'Akun sekolah Anda telah aktif. Silakan login untuk memulai.',
                icon: 'success',
                confirmButtonText: 'Login Sekarang'
              }).then(() => {
                switchView('view-login');
              });
              
            } else {
              Swal.fire({ icon: 'error', title: 'Registrasi Gagal', html: res.message });
            }
          })
          .registerSchool(form);
      }

      /* --- LOGIKA SESI HEMAT KUOTA (BURST MODE - OPTIMIZED FOR 100 USERS) --- */
      let sessionInterval = null;
      let sessionCheckCount = 0;
      
      // [UBAH 1] Naikkan batas limit agar durasi monitoring total lebih panjang
      // Lama: 6 kali (total 30 detik). 
      // Baru: 30 kali (total 10 menit). Setelah 10 menit idle, script berhenti ping server.
      const SESSION_CHECK_LIMIT = 30; 

      function startSessionMonitor() {
        // Hapus interval lama jika ada
        if(sessionInterval) clearInterval(sessionInterval);
        
        // Reset penghitung
        sessionCheckCount = 0;

        console.log("Mulai monitoring sesi (Mode: Optimasi 100 User)...");

        // [UBAH 2] Ganti Interval dari 5000 (5 detik) menjadi 20000 (20 Detik)
        // Matematika: 100 user / 20 detik = 5 request/detik (Sangat Aman untuk Google)
        sessionInterval = setInterval(() => {
          const email = localStorage.getItem('userEmail');
          const token = localStorage.getItem('sessionToken');
          
          // Tambah counter
          sessionCheckCount++;

          // HENTIKAN OTOMATIS JIKA SUDAH MENCAPAI LIMIT
          if (sessionCheckCount > SESSION_CHECK_LIMIT) {
            clearInterval(sessionInterval);
            console.log("Monitoring sesi latar belakang dihentikan untuk hemat kuota.");
            return;
          }
          
          if(email && token) {
              google.script.run
                .withSuccessHandler(function(res){
                  // Jika Token di server berbeda dengan yang dipegang browser ini
                  if(!res.valid) {
                    handleSessionInvalid();
                  }
                })
                // Menggunakan fungsi heartbeat yang ringan
                .updateUserActivity(email, token);
          }
        }, 20000); // <--- GANTI DISINI JADI 20000 (20 Detik)
      }

      // Fungsi terpisah untuk menangani sesi tidak valid (biar rapi)
      function handleSessionInvalid() {
        clearInterval(sessionInterval); // Stop interval segera
        
        Swal.fire({
          icon: 'warning',
          title: 'Sesi Berakhir',
          text: 'Akun ini telah login di perangkat/browser lain. Anda akan dikeluarkan.',
          allowOutsideClick: false,
          confirmButtonText: 'OK'
        }).then(() => {
          // Bersihkan lokal & reset
          localStorage.clear();
          document.getElementById('formLogin').reset();
          switchView('view-login');
        });
      }

      // Fungsi Logout Paksa (Tanpa konfirmasi user)
      function forceLogout() {
        clearInterval(sessionInterval);
        localStorage.clear(); // Hapus semua data
        
        // Reset UI
        document.getElementById('formLogin').reset();
        switchView('view-login');
        
        Swal.fire({
          icon: 'warning',
          title: 'Sesi Berakhir',
          text: 'Akun Anda telah login di perangkat lain atau sesi telah kadaluarsa. Silakan login kembali.',
          allowOutsideClick: false,
          confirmButtonText: 'OK'
        });
      }

      function logout() {
        Swal.fire({
          title: 'Yakin ingin keluar?',
          text: "Sesi Anda akan diakhiri.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Keluar'
        }).then((result) => {
          if (result.isConfirmed) {
            const email = localStorage.getItem('userEmail');
            const token = localStorage.getItem('sessionToken');
            
            // Request Logout ke Server
            if(email && token) google.script.run.logoutUserServer(email, token);

            // --- PEMBERSIHAN TOTAL CLIENT SIDE ---
            localStorage.clear(); // Hapus Storage

            clearLocalCache();
            
            // Reset Cache Variable
            DATA_CACHE = {
                toko: null, tukang: null, guru: null, uraian: null, satuan: null,
                transaksi_toko: null, transaksi_tukang: null, transaksi_guru: null,
                sekolah: null, template_settings: null, dashboard: null
            };
            cacheDataGuru = [];
            cacheSatuan = [];
            
            // Hentikan interval cek sesi
            if(sessionInterval) clearInterval(sessionInterval);
            
            // Reset Form UI
            document.getElementById('formLogin').reset();
            document.getElementById('schoolNameDisplay').innerText = "";
            
            // Pindah ke Login
            switchView('view-login');
            
            Swal.fire({
              icon: 'success',
              title: 'Berhasil Keluar',
              timer: 1500,
              showConfirmButton: false
            });
          }
        });
      }

      /* --- LOGIC DATA SEKOLAH --- */

      // --- LOAD DATA SEKOLAH (WITH CACHE) ---
      function loadDataSekolah(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const schoolName = localStorage.getItem('userName');
        
        // Set Nama Sekolah dari LocalStorage sebagai tampilan awal (fallback)
        document.getElementById('dsNamaSekolah').value = schoolName;

        // 1. CEK CACHE
        // Jika data ada di memori dan tidak dipaksa refresh, isi form langsung!
        if (!forceRefresh && DATA_CACHE.sekolah) {
          console.log("Data sekolah loaded from Cache.");
          renderDataSekolah(DATA_CACHE.sekolah);
          return;
        }

        // 2. FETCH SERVER
        toggleLoading(true);
        
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          toggleLoading(false);
          if (res.status === 'success') {
            // SIMPAN KE CACHE
            DATA_CACHE.sekolah = res.data;
            renderDataSekolah(res.data);
          } 
        }).getDataSekolah(token);
      }

      // --- RENDER FORM DATA SEKOLAH (DIPISAH) ---
      function renderDataSekolah(d) {
        // Isi Nama Sekolah dari Database (Source of Truth)
        if(d.namaSekolah) document.getElementById('dsNamaSekolah').value = d.namaSekolah;

        // BERSIHKAN TANDA KUTIP (') SAAT MENAMPILKAN DATA
        document.getElementById('dsNpsn').value = String(d.npsn).replace(/'/g, '');
        document.getElementById('dsNsm').value = String(d.nsm).replace(/'/g, ''); 
        
        document.getElementById('dsAlamat').value = d.alamat;
        document.getElementById('dsProvinsi').value = d.provinsi;
        document.getElementById('dsKabupaten').value = d.kabupaten;
        document.getElementById('dsKecamatan').value = d.kecamatan;
        document.getElementById('dsKelurahan').value = d.kelurahan;
        document.getElementById('dsTempatTTD').value = d.tempatTTD;
        document.getElementById('dsKepala').value = d.namaKepala;
        document.getElementById('dsNipKepala').value = String(d.nipKepala).replace(/'/g, '');
        document.getElementById('dsBendahara').value = d.namaBendahara;
        document.getElementById('dsNipBendahara').value = String(d.nipBendahara).replace(/'/g, '');
        document.getElementById('dsTelp').value = String(d.noTelp).replace(/'/g, '');
        document.getElementById('dsEmail').value = d.email;

        /* --- LOGIKA LOAD DANA BOS & PERIODE --- */
        const savedBos = d.danaBOS; 
        const savedPeriode = d.periodeAnggaran; 
        
        const selectBos = document.getElementById('dsDanaBos');
        const inputBosManual = document.getElementById('dsDanaBosManual');
        const inputPeriodeManual = document.getElementById('dsPeriodeManual');

        // Cek apakah Nama BOS ada di pilihan dropdown standar?
        let isMatch = false;
        for (let i = 0; i < selectBos.options.length; i++) {
          if (selectBos.options[i].value === savedBos) {
            isMatch = true;
            break;
          }
        }

        if (isMatch) {
          // KASUS 1: Pilihan Standar
          selectBos.value = savedBos;
          inputBosManual.value = "";       
          inputPeriodeManual.value = "";   
        } else if (savedBos) {
          // KASUS 2: Pilihan Manual
          selectBos.value = "Lainnya";     
          inputBosManual.value = savedBos; 
          inputPeriodeManual.value = savedPeriode; 
        } else {
          // KASUS 3: Belum ada data
          selectBos.value = "";
        }

        // Update UI (Keterangan text & visibilitas input manual)
        cekPeriodeBos();
        
        document.getElementById('dsJumlahAnggaran').value = formatRibuanInput(d.jumlahAnggaran);
        // --- MODIFIKASI: Default Tahun Berjalan ---
        // Jika d.tahunAnggaran ada isinya (user lama), gunakan itu.
        // Jika kosong (user baru), gunakan tahun dari sistem komputer (Date).
        const tahunSekarang = new Date().getFullYear();
        document.getElementById('dsTahun').value = d.tahunAnggaran || tahunSekarang;
      }

      // --- SIMPAN DATA SEKOLAH (INVALIDATE CACHE) ---
      function submitDataSekolah() {
        const token = localStorage.getItem('userToken');
        
        // Validasi
        if(!document.getElementById('dsNpsn').value) {
          Swal.fire('Peringatan', 'NPSN Wajib diisi!', 'warning'); return;
        }
        if(!document.getElementById('dsTempatTTD').value) {
          Swal.fire('Peringatan', 'Tempat TTD Wajib diisi!', 'warning'); return;
        }

        // Logika Data BOS Terpisah
        let finalNamaBos = "";
        let finalPeriode = "";
        const dropdownVal = document.getElementById('dsDanaBos').value;

        if (dropdownVal === 'Lainnya') {
            finalNamaBos = document.getElementById('dsDanaBosManual').value.trim();
            finalPeriode = document.getElementById('dsPeriodeManual').value.trim();
            
            if (!finalNamaBos || !finalPeriode) {
                Swal.fire('Peringatan', 'Nama Dana BOS dan Periode manual wajib diisi!', 'warning');
                return;
            }
        } else {
            finalNamaBos = dropdownVal;
            // Mapping Periode Otomatis
            if (dropdownVal === 'Dana BOS Tahap 1') finalPeriode = "Januari - Juni";
            else if (dropdownVal === 'Dana BOS Tahap 2') finalPeriode = "Juli - Desember";
            else if (dropdownVal === 'Dana BOS Triwulan 1') finalPeriode = "Januari - Maret";
            else if (dropdownVal === 'Dana BOS Triwulan 2') finalPeriode = "April - Juni";
            else if (dropdownVal === 'Dana BOS Triwulan 3') finalPeriode = "Juli - September";
            else if (dropdownVal === 'Dana BOS Triwulan 4') finalPeriode = "Oktober - Desember";
        }

        const formData = {
          namaSekolah: document.getElementById('dsNamaSekolah').value,
          npsn: document.getElementById('dsNpsn').value, 
          nsm: document.getElementById('dsNsm').value,
          alamat: document.getElementById('dsAlamat').value,
          provinsi: document.getElementById('dsProvinsi').value,
          kabupaten: document.getElementById('dsKabupaten').value,
          kecamatan: document.getElementById('dsKecamatan').value,
          kelurahan: document.getElementById('dsKelurahan').value,
          tempatTTD: document.getElementById('dsTempatTTD').value,
          namaKepala: document.getElementById('dsKepala').value,
          nipKepala: document.getElementById('dsNipKepala').value,
          namaBendahara: document.getElementById('dsBendahara').value,
          nipBendahara: document.getElementById('dsNipBendahara').value,
          noTelp: document.getElementById('dsTelp').value,
          email: document.getElementById('dsEmail').value,
          danaBOS: finalNamaBos,          
          periodeAnggaran: finalPeriode,  
          jumlahAnggaran: cleanRibuan(document.getElementById('dsJumlahAnggaran').value),
          tahunAnggaran: document.getElementById('dsTahun').value
        };

        toggleLoading(true);
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          toggleLoading(false); // 1. Loading dimatikan disini
          
          if (res.status === 'success') {
            // --- UPDATE CACHE ---
            DATA_CACHE.sekolah = null;
            DATA_CACHE.dashboard = null;
            
            // --- PERBAIKAN DISINI ---
            // HAPUS atau KOMENTARI baris: loadDataSekolah(true);
            // Alasannya: Baris ini memancing spinner loading muncul lagi. 
            // Karena form sudah berisi data terbaru yang baru saja diketik user, kita tidak perlu reload.
            
            // loadDataSekolah(true);  <-- HAPUS INI
            
            Swal.fire('Sukses', 'Data Sekolah berhasil disimpan!', 'success');
            
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanDataSekolah(token, formData);
      }

      /* --- FUNGSI LOGIKA PERIODE BOS (DIPERBARUI PISAH KOLOM) --- */
      function cekPeriodeBos() {
        const select = document.getElementById('dsDanaBos');
        const info = document.getElementById('infoPeriode');
        const wrapManual = document.getElementById('wrapManualBos');
        
        const inputNama = document.getElementById('dsDanaBosManual');
        const inputPeriode = document.getElementById('dsPeriodeManual');
        
        const val = select.value;
        let teksInfo = "";
        let isManual = false;

        // Set teks info periode untuk pilihan standar
        if (val === 'Dana BOS Tahap 1') teksInfo = "Periode Januari - Juni";
        else if (val === 'Dana BOS Tahap 2') teksInfo = "Periode Juli - Desember";
        else if (val === 'Dana BOS Triwulan 1') teksInfo = "Periode Januari - Maret";
        else if (val === 'Dana BOS Triwulan 2') teksInfo = "Periode April - Juni";
        else if (val === 'Dana BOS Triwulan 3') teksInfo = "Periode Juli - September";
        else if (val === 'Dana BOS Triwulan 4') teksInfo = "Periode Oktober - Desember";
        else if (val === 'Lainnya') {
          teksInfo = ""; // Info kosong jika manual, user ketik sendiri
          isManual = true;
        }

        // Tampilkan teks info kecil di bawah dropdown
        info.innerText = teksInfo;

        // Atur Visibilitas Input Manual
        if (isManual) {
          wrapManual.classList.remove('hidden');
          inputNama.required = true;
          inputPeriode.required = true;
        } else {
          wrapManual.classList.add('hidden');
          inputNama.required = false;
          inputPeriode.required = false;
        }
      }

      /* --- LOGIC URAIAN PEKERJAAN (UPDATE) --- */

      // 1. Update Tabel dengan Tombol Edit
      function loadUraianData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelUraianBody');
        
        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE.uraian) {
          renderTabelUraian(DATA_CACHE.uraian);
          return;
        }

        // 2. FETCH SERVER
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              // SIMPAN KE CACHE
              DATA_CACHE.uraian = res.data;
              
              // --- PERBAIKAN DISINI: Simpan ke cacheUserUraian ---
              if(res.data && res.data.length > 0) {
                  // Ambil text uraiannya saja
                  cacheUserUraian = res.data.map(item => item.uraian);
              }
              
              renderTabelUraian(res.data);
            } else {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getUraianList(token);
      }

      // --- RENDER TABEL URAIAN ---
      function renderTabelUraian(data) {
        const tbody = document.getElementById('tabelUraianBody');
        tbody.innerHTML = ''; 
        
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data uraian.</td></tr>';
          return;
        }

        data.forEach(item => {
          const cleanNo = String(item.noBukti).replace(/'/g, ''); 
          
          // Escape untuk keamanan onclick
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning me-1" 
              onclick="modeEdit('${item.id}', '${escapeJsAttribute(cleanNo)}', '${escapeJsAttribute(item.uraian)}')" 
              title="Edit Data">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;

          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" 
              onclick="hapusUraian('${item.id}')" 
              title="Hapus Data">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          const row = `
            <tr>
              <td class="fw-bold text-primary">${escapeHtml(cleanNo)}</td>
              <td>${escapeHtml(item.uraian)}</td>
              <td style="white-space:nowrap;">
                ${btnEdit} ${btnHapus}
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 2. Fungsi Mengaktifkan Mode Edit (Data Uraian)
      function modeEdit(id, noBukti, uraian) {
        // Isi form dengan data yang dipilih
        document.getElementById('urId').value = id;
        document.getElementById('urNoBukti').value = noBukti;
        document.getElementById('urNama').value = uraian;

        // Ubah Tampilan Tombol (Jadi Mode Edit - Kuning)
        const btnSimpan = document.getElementById('btnSimpanUraian');
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btnSimpan.classList.remove('btn-primary');
        btnSimpan.classList.add('btn-warning');

        // Munculkan Tombol Batal
        document.getElementById('btnBatalUraian').classList.remove('hidden');

        // PERBAIKAN SCROLL: Gunakan setTimeout agar tidak loncat di mobile
        // block: 'center' akan menempatkan form di tengah layar agar mudah dilihat
        setTimeout(() => {
          const form = document.getElementById('formUraian');
          form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 3. Fungsi Batal Edit (Reset Form)
      function batalEdit() {
        document.getElementById('formUraian').reset();
        document.getElementById('urId').value = ''; // Kosongkan ID

        // Kembalikan Tombol ke Mode Tambah
        const btnSimpan = document.getElementById('btnSimpanUraian');
        btnSimpan.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btnSimpan.classList.add('btn-primary');
        btnSimpan.classList.remove('btn-warning');

        // Sembunyikan Tombol Batal
        document.getElementById('btnBatalUraian').classList.add('hidden');
      }

      // 4. Update Logic Submit (Bisa Tambah Baru atau Edit)
      /* --- UPDATE: submitUraian (Agar Riwayat Transaksi Ikut Refresh) --- */
      function submitUraian(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('urId').value; 
        
        const formData = {
          id: idEdit, 
          noBukti: document.getElementById('urNoBukti').value,
          uraian: document.getElementById('urNama').value
        };

        const btn = document.getElementById('btnSimpanUraian');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Proses...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (res.status === 'success') {
            batalEdit(); 
            
            // RESET CACHE URAIAN
            DATA_CACHE.uraian = null; 
            loadUraianData(true); 
            
            // [TAMBAHAN BARU] HAPUS SEMUA CACHE TRANSAKSI
            // Karena uraian dipakai di Toko, Tukang, dan Guru
            DATA_CACHE.transaksi_toko = null;
            DATA_CACHE.transaksi_tukang = null;
            DATA_CACHE.transaksi_guru = null;
            
            const Toast = Swal.mixin({
              toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
            });
            Toast.fire({ icon: 'success', title: res.message });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editUraianItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanUraianBaru(token, formData);
        }
      }

      // --- HAPUS URAIAN (INVALIDATE CACHE) ---
      // (Pastikan fungsi ini ada, karena sebelumnya mungkin belum didefinisikan secara eksplisit)
      function hapusUraian(id) {
        Swal.fire({
          title: 'Hapus Uraian?', 
          text: "Data uraian ini akan dihapus permanen.",
          icon: 'warning', 
          showCancelButton: true, 
          confirmButtonColor: '#d33', 
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                // RESET CACHE & RELOAD
                DATA_CACHE.uraian = null;
                loadUraianData(true);
                
                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              } else {
                Swal.fire({ icon: 'error', title: 'Gagal', html: res.message });
              }
            }).hapusUraianItem(token, id);
          }
        });
      }

      // Helper untuk membersihkan submit handler
      function finishSubmit(res, btn, originalText) {
        btn.innerHTML = originalText;
        btn.disabled = false;

        if (res.status === 'success') {
          batalEdit(); // Reset form & tombol
          loadUraianData(); // Reload tabel
          
          const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
          });
          Toast.fire({ icon: 'success', title: res.message });
        } else {
          Swal.fire({ icon: 'error', title: 'Gagal', html: res.message });
        }
      }

      /* --- LOGIC DATA TOKO --- */

      // 1. Load Data
      // --- LOAD DATA TOKO DENGAN CACHE ---
      function loadTokoData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTokoBody');
        
        // 1. CEK CACHE: Jika data ada & tidak dipaksa refresh, pakai data lokal
        if (!forceRefresh && DATA_CACHE.toko) {
          renderTabelToko(DATA_CACHE.toko);
          return;
        }

        // 2. JIKA CACHE KOSONG / FORCE REFRESH: Ambil dari Server
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              // Simpan ke Cache
              DATA_CACHE.toko = res.data;
              renderTabelToko(res.data);
            } else {
              tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getTokoList(token);
      }

      // --- FUNGSI RENDER TABEL TOKO (DIPISAH) ---
      function renderTabelToko(data) {
        const tbody = document.getElementById('tabelTokoBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Belum ada data toko.</td></tr>';
          return;
        }

        data.forEach(item => {
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning" 
              onclick="modeEditToko('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.jenis)}', '${escapeJsAttribute(item.alamat)}', '${escapeJsAttribute(item.telp)}', '${escapeJsAttribute(item.pemilik)}', '${escapeJsAttribute(item.tempat)}')" 
              title="Edit">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;
          
          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" onclick="hapusToko('${item.id}')">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          const row = `
            <tr>
              <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
              <td>${escapeHtml(item.pemilik)}<br><small class="text-muted">${escapeHtml(item.telp)}</small></td>
              <td><span class="badge bg-light text-dark border">${escapeHtml(item.jenis)}</span></td>
              <td>${btnEdit} ${btnHapus}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 2. Submit (Tambah & Edit)
      /* --- UPDATE: submitToko (Agar Riwayat Transaksi Ikut Refresh) --- */
      function submitToko(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('tkId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('tkNama').value,
          jenis: document.getElementById('tkJenis').value,
          alamat: document.getElementById('tkAlamat').value,
          telp: document.getElementById('tkTelp').value,
          pemilik: document.getElementById('tkPemilik').value,
          tempat: document.getElementById('tkTempat').value
        };

        const btn = document.getElementById('btnSimpanToko');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditToko(); 
            
            // RESET CACHE DATA TOKO
            DATA_CACHE.toko = null; 
            loadTokoData(true);
            
            // [TAMBAHAN BARU] HAPUS CACHE TRANSAKSI TOKO
            // Agar saat buka menu transaksi, nama toko yang baru muncul
            DATA_CACHE.transaksi_toko = null; 
            
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editTokoItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanTokoBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditToko(id, nama, jenis, alamat, telp, pemilik, tempat) {
        // [FIX] Data diterima sudah bersih (karena sudah di-escape di onclick), langsung pakai.
        document.getElementById('tkId').value = id;
        document.getElementById('tkNama').value = nama;
        document.getElementById('tkJenis').value = jenis;
        document.getElementById('tkAlamat').value = alamat;
        document.getElementById('tkTelp').value = telp;
        document.getElementById('tkPemilik').value = pemilik;
        document.getElementById('tkTempat').value = tempat;

        // Ubah tombol menjadi mode Edit
        const btn = document.getElementById('btnSimpanToko');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalToko').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formToko').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditToko() {
        document.getElementById('formToko').reset();
        document.getElementById('tkId').value = '';
        
        const btn = document.getElementById('btnSimpanToko');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan Toko';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalToko').classList.add('hidden');
      }

      // 5. Hapus Toko
      // --- HAPUS TOKO (INVALIDATE CACHE) ---
      function hapusToko(id) {
        Swal.fire({
          title: 'Hapus Toko?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                // RESET CACHE & RELOAD
                DATA_CACHE.toko = null;
                loadTokoData(true);
                
                Swal.fire('Terhapus!', 'Data toko dihapus.', 'success');
              }
            }).hapusTokoItem(token, id);
          }
        });
      }

      // --- HELPER UNTUK MENCEGAH ERROR TANDA KUTIP DI HTML ---
      function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
      }

      function unescapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'");
      }

      /* --- LOGIC DATA TUKANG --- */

      // 1. Load Data
      // --- LOAD DATA TUKANG DENGAN CACHE ---
      function loadTukangData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTukangBody');
        
        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE.tukang) {
          renderTabelTukang(DATA_CACHE.tukang);
          return;
        }

        // 2. FETCH SERVER JIKA CACHE KOSONG
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              // SIMPAN KE CACHE
              DATA_CACHE.tukang = res.data;
              renderTabelTukang(res.data);
            } else {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getTukangList(token);
      }

      // --- RENDER TABEL TUKANG ---
      function renderTabelTukang(data) {
        const tbody = document.getElementById('tabelTukangBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data tukang.</td></tr>';
          return;
        }

        data.forEach(item => {
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning" 
              onclick="modeEditTukang('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.alamat)}')" 
              title="Edit">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;
          
          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" onclick="hapusTukang('${item.id}')">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          const row = `
            <tr>
              <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
              <td>${escapeHtml(item.alamat)}</td>
              <td>${btnEdit} ${btnHapus}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 2. Submit (Tambah & Edit)
      /* --- UPDATE: submitTukang (Agar Riwayat Transaksi Ikut Refresh) --- */
      function submitTukang(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('tkgId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('tkgNama').value,
          alamat: document.getElementById('tkgAlamat').value
        };

        const btn = document.getElementById('btnSimpanTukang');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditTukang(); 
            
            // RESET CACHE DATA TUKANG
            DATA_CACHE.tukang = null;
            loadTukangData(true);
            
            // [TAMBAHAN BARU] HAPUS CACHE TRANSAKSI TUKANG
            DATA_CACHE.transaksi_tukang = null;

            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editTukangItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanTukangBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditTukang(id, nama, alamat) {
        document.getElementById('tkgId').value = id;
        document.getElementById('tkgNama').value = nama;
        document.getElementById('tkgAlamat').value = alamat;

        const btn = document.getElementById('btnSimpanTukang');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalTukang').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formTukang').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditTukang() {
        document.getElementById('formTukang').reset();
        document.getElementById('tkgId').value = '';
        
        const btn = document.getElementById('btnSimpanTukang');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalTukang').classList.add('hidden');
      }

      // 5. Hapus Tukang
      // --- HAPUS TUKANG (INVALIDATE CACHE) ---
      function hapusTukang(id) {
        Swal.fire({
          title: 'Hapus Data Tukang?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                // RESET CACHE & RELOAD
                DATA_CACHE.tukang = null;
                loadTukangData(true);

                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              }
            }).hapusTukangItem(token, id);
          }
        });
      }

      /* --- LOGIC DATA GURU --- */

      // 1. Load Data
      // --- LOAD DATA GURU DENGAN CACHE ---
      function loadGuruData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelGuruBody');
        
        if (!forceRefresh && DATA_CACHE.guru) {
          renderTabelGuru(DATA_CACHE.guru);
          return;
        }

        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              DATA_CACHE.guru = res.data;
              // Update juga variabel global lama untuk kompatibilitas input transaksi
              cacheDataGuru = res.data; 
              renderTabelGuru(res.data);
            } else {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getGuruList(token);
      }

      // --- RENDER TABEL GURU ---
      function renderTabelGuru(data) {
        const tbody = document.getElementById('tabelGuruBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data guru.</td></tr>';
          return;
        }

        data.forEach(item => {
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning" 
              onclick="modeEditGuru('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.nip)}')" 
              title="Edit">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;
          
          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" onclick="hapusGuru('${item.id}')">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          const row = `
            <tr>
              <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
              <td>${escapeHtml(item.nip)}</td>
              <td>${btnEdit} ${btnHapus}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 2. Submit (Tambah & Edit)
      /* --- UPDATE: submitGuru (Agar Riwayat Transaksi Ikut Refresh) --- */
      function submitGuru(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('grId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('grNama').value,
          nip: document.getElementById('grNip').value
        };

        const btn = document.getElementById('btnSimpanGuru');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditGuru(); 
            
            // RESET CACHE DATA GURU
            DATA_CACHE.guru = null;
            loadGuruData(true);
            
            // [TAMBAHAN BARU] HAPUS SEMUA CACHE TRANSAKSI
            // Karena Nama Guru bisa muncul di Transaksi Guru, Toko (Pemesan), dan Tukang (Pemesan)
            DATA_CACHE.transaksi_guru = null;
            DATA_CACHE.transaksi_toko = null;
            DATA_CACHE.transaksi_tukang = null;
            
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editGuruItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanGuruBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditGuru(id, nama, nip) {
        document.getElementById('grId').value = id;
        document.getElementById('grNama').value = nama;
        // Handle jika NIP kosong/dash
        document.getElementById('grNip').value = (nip === '-' || !nip) ? '' : nip;

        const btn = document.getElementById('btnSimpanGuru');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalGuru').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formGuru').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditGuru() {
        document.getElementById('formGuru').reset();
        document.getElementById('grId').value = '';
        
        const btn = document.getElementById('btnSimpanGuru');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalGuru').classList.add('hidden');
      }

      // 5. Hapus Guru
      // --- HAPUS GURU (INVALIDATE CACHE) ---
      function hapusGuru(id) {
        Swal.fire({
          title: 'Hapus Data Guru?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                // RESET CACHE
                DATA_CACHE.guru = null;
                loadGuruData(true);
                
                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              }
            }).hapusGuruItem(token, id);
          }
        });
      }

      /* --- LOGIC PENGATURAN KOP SURAT --- */

      // 1. Load Gambar yang tersimpan (dari Server)
      function loadKopSettings() {
        const token = localStorage.getItem('userToken');
        const imgEl = document.getElementById('imgPreview');
        const txtEl = document.getElementById('txtNoImage');
        const btnHapus = document.getElementById('btnHapusKop');

        // Reset tampilan dulu
        imgEl.style.display = 'none';
        txtEl.style.display = 'block';
        btnHapus.classList.add('hidden');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success' && res.fileId) {
            // Trik menampilkan gambar dari Drive: gunakan endpoint thumbnail
            // atau export=view. Thumbnail lebih aman dari CORS biasanya.
            const imageUrl = "https://drive.google.com/thumbnail?id=" + res.fileId + "&sz=w1000"; 
            
            imgEl.src = imageUrl;
            imgEl.style.display = 'block';
            txtEl.style.display = 'none';
            btnHapus.classList.remove('hidden'); // Munculkan tombol hapus
          }
        }).getKopSurat(token);
      }

      // 2. Preview Gambar Lokal (Sebelum Upload)
      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const imgEl = document.getElementById('imgPreview');
            const txtEl = document.getElementById('txtNoImage');
            
            imgEl.src = e.target.result;
            imgEl.style.display = 'block';
            txtEl.style.display = 'none';
          }
          
          reader.readAsDataURL(input.files[0]);
        }
      }

      // 3. Upload Gambar ke Server
      function uploadKop(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileKop');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        
        // Validasi Ukuran (Misal Max 2MB agar script tidak timeout)
        if (file.size > 2 * 1024 * 1024) {
          Swal.fire('File Terlalu Besar', 'Maksimal ukuran file adalah 2MB', 'warning');
          return;
        }

        const btn = document.getElementById('btnSimpanKop');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengupload...';
        btn.disabled = true;

        // Baca File sebagai Base64
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function() {
          // Ambil string base64 murni (hapus 'data:image/jpeg;base64,')
          const rawBase64 = reader.result.split(',')[1]; 
          const payload = {
            base64: rawBase64,
            mimeType: file.type
          };

          const token = localStorage.getItem('userToken');

          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (res.status === 'success') {
              Swal.fire('Sukses', 'Kop Surat berhasil disimpan!', 'success');
              document.getElementById('formKop').reset();
              loadKopSettings(); // Reload gambar dari server
            } else {
              Swal.fire({ icon: 'error', title: 'Gagal Upload', html: res.message });
            }
          }).simpanKopSurat(token, payload);
        };
      }

      // 4. Hapus Kop Surat
      function aksiHapusKop() {
        Swal.fire({
          title: 'Hapus Kop Surat?',
          text: "Kop surat akan dihapus dari sistem.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if (res.status === 'success') {
                Swal.fire('Terhapus', 'Kop surat telah dihapus', 'success');
                loadKopSettings(); // Refresh tampilan
              } else {
                Swal.fire({ icon: 'error', title: 'Gagal Menghapus', html: res.message });
              }
            }).hapusKopSurat(token);
          }
        });
      }

      /* --- LOGIC TRANSAKSI BELANJA (DIPERBARUI) --- */

      // 1. Tab Switching (Diperbarui untuk load data list)
      function bukaTab(tabName) {
        // Hide semua content tab
        document.getElementById('tab-content-toko').classList.add('hidden');
        document.getElementById('tab-content-tukang').classList.add('hidden');
        document.getElementById('tab-content-guru').classList.add('hidden');
        
        // Reset active buttons
        document.getElementById('tab-btn-toko').classList.remove('active');
        document.getElementById('tab-btn-tukang').classList.remove('active');
        document.getElementById('tab-btn-guru').classList.remove('active');

        // Show selected tab
        document.getElementById('tab-content-' + tabName).classList.remove('hidden');
        document.getElementById('tab-btn-' + tabName).classList.add('active');

        // LOAD DATA LIST TRANSAKSI (Pakai Cache otomatis)
        if(tabName === 'toko') loadTransaksiData('TOKO');
        if(tabName === 'tukang') loadTransaksiData('TUKANG');
        if(tabName === 'guru') loadTransaksiData('GURU');
      }

      // 2. Load Data List Transaksi (PERBAIKAN: HANDLING TANDA KUTIP)
      // --- LOAD DATA TRANSAKSI UTAMA (WITH CACHE) ---
      function loadTransaksiData(tipeRaw, forceRefresh = false) {
        const tipe = tipeRaw.toUpperCase(); // Pastikan format TOKO/TUKANG/GURU
        const tipeKey = tipe.toLowerCase(); // Format key cache: toko/tukang/guru
        const cacheKey = 'transaksi_' + tipeKey;
        
        // Tentukan Target Tabel
        let targetId;
        if (tipe === 'TOKO') targetId = 'listTransaksiToko';
        else if (tipe === 'TUKANG') targetId = 'listTransaksiTukang';
        else targetId = 'listTransaksiGuru';

        const tbody = document.getElementById(targetId);

        // 1. CEK CACHE
        // Jika data sudah ada di memori (dari menu Surat/Tanggal atau tab sebelah), pakai langsung!
        if (!forceRefresh && DATA_CACHE[cacheKey]) {
          renderRiwayatTransaksi(DATA_CACHE[cacheKey], tipe, tbody);
          return;
        }

        // 2. FETCH SERVER JIKA CACHE KOSONG
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        const token = localStorage.getItem('userToken');

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              // SIMPAN KE CACHE GLOBAL
              DATA_CACHE[cacheKey] = res.data;
              
              renderRiwayatTransaksi(res.data, tipe, tbody);
            } else {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getTransaksiList(token, tipe);
      }

      // --- FUNGSI RENDER TABEL TRANSAKSI (DIPISAH) ---
      function renderRiwayatTransaksi(data, tipe, tbody) {
        tbody.innerHTML = '';
        
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Belum ada riwayat transaksi.</td></tr>';
          return;
        }

        data.forEach(item => {
          // Encode data agar aman untuk fungsi onclick
          const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");
          const tipeKecil = tipe.toLowerCase();

          // Tombol Aksi
          const btnDetail = `
            <button class="btn btn-sm btn-outline-info me-1" 
              onclick="lihatDetailTransaksi('${dataJson}')" title="Lihat Rincian">
              <i class="fas fa-eye"></i>
            </button>
          `;

          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning me-1" 
              onclick="modeEditTransaksi('${tipeKecil}', '${dataJson}')" title="Edit">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;
          
          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" 
              onclick="hapusTransaksi('${item.id}', '${tipeKecil}')" title="Hapus">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          // Kolom Pihak Ketiga (Khusus Guru ditampilkan Keterangan/Kosong jika default)
          let displayPihak = item.pihakKetiga;
          if (tipe === 'GURU' && (displayPihak === '-' || displayPihak === 'Honorarium Guru')) {
              // Jika ingin menampilkan keterangan sebagai pengganti pihak ketiga untuk guru
              // Pastikan logic ini sesuai dengan keinginan Anda (misal menampilkan Keterangan)
              displayPihak = "-"; 
          }

          const row = `
            <tr>
              <td>${item.tanggalDisplay}</td> 
              <td><div class="text-truncate" style="max-width: 200px;" title="${escapeHtml(item.uraian)}">${escapeHtml(item.uraian)}</div></td>
              <td>${escapeHtml(displayPihak)}</td> 
              <td class="fw-bold text-success">${formatRupiahJS(item.total)}</td>
              <td style="white-space: nowrap;">${btnDetail} ${btnEdit} ${btnHapus}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 3. Mode Edit Transaksi (FUNGSI BARU & KOMPLEKS)
      function modeEditTransaksi(tipe, encodedData) {
        // 1. Decode Data JSON
        const data = JSON.parse(decodeURIComponent(encodedData));
        
        // 2. Mapping ID Form Header & Button berdasarkan Tipe
        let formId, tableId, btnSimpanId, btnBatalId;
        
        if (tipe === 'toko') {
          formId = 'formBelanjaToko';
          tableId = 'tabelItemToko';
          btnSimpanId = 'btnSimpanTokoTrans';
          btnBatalId = 'btnBatalTokoTrans';
          
          // Isi Header Toko
          document.getElementById('trTokoId').value = data.id;
          document.getElementById('trTokoTanggal').value = data.tanggal;
          setSelectValue('trTokoUraian', data.uraian);
          setSelectValue('trTokoNama', data.pihakKetiga);
          setSelectValue('trTokoPemesan', data.pemesan);
          
        } else if (tipe === 'tukang') {
          formId = 'formBelanjaTukang';
          tableId = 'tabelItemTukang';
          btnSimpanId = 'btnSimpanTukangTrans';
          btnBatalId = 'btnBatalTukangTrans';
          
          // Isi Header Tukang
          document.getElementById('trTukangId').value = data.id;
          document.getElementById('trTukangTanggal').value = data.tanggal;
          setSelectValue('trTukangUraian', data.uraian);
          setSelectValue('trTukangNama', data.pihakKetiga);
          setSelectValue('trTukangPemesan', data.pemesan);
                
        } else if (tipe === 'guru') {
          formId = 'formBelanjaGuru';
          tableId = 'tabelItemGuru';
          btnSimpanId = 'btnSimpanGuruTrans';
          btnBatalId = 'btnBatalGuruTrans';
          
          // Isi Header Guru
          document.getElementById('trGuruId').value = data.id;
          document.getElementById('trGuruTanggal').value = data.tanggal;
          setSelectValue('trGuruUraian', data.uraian);
          
          if(data.pihakKetiga === '-' || data.pihakKetiga === 'Honorarium Guru') {
              document.getElementById('trGuruKeterangan').value = '';
          } else {
              document.getElementById('trGuruKeterangan').value = data.pihakKetiga;
          }
        }

        // 3. Reset & Gambar Ulang Tabel Rincian (PENTING: Logika Render)
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = ''; // Kosongkan tabel dulu

        if (data.items && data.items.length > 0) {
          data.items.forEach(item => {
            const rowId = new Date().getTime() + Math.random();
            let colNamaInput = '';

            // --- LOGIKA KOLOM NAMA (Dropdown Guru vs Input Biasa) ---
            if (tipe === 'guru') {
              let isManual = true; 
              // Cek apakah nama guru ada di cache data sekolah
              if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
                  cacheDataGuru.forEach(g => {
                      if (g.nama.trim() === item.nama.trim()) isManual = false;
                  });
              }

              if (isManual) {
                  // Jika nama manual (tidak ada di master data guru)
                  const val = String(item.nama).replace(/"/g, '&quot;');
                  colNamaInput = `
                    <div class="input-group">
                      <input type="text" class="form-control item-nama" value="${val}" placeholder="Nama Guru (Manual)">
                      <button class="btn btn-outline-secondary" type="button" onclick="resetKeDropdown(this)" title="Kembali ke Pilihan">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  `;
              } else {
                  // Jika nama ada di master data, tampilkan sebagai dropdown
                  let opts = '<option value="">-- Pilih Guru --</option>';
                  opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
                  
                  if (typeof cacheDataGuru !== 'undefined') {
                    cacheDataGuru.forEach(g => {
                        const isSelected = (g.nama.trim() === item.nama.trim()) ? 'selected' : '';
                        const val = String(g.nama).replace(/"/g, '&quot;');
                        opts += `<option value="${val}" ${isSelected}>${g.nama}</option>`;
                    });
                  }
                  colNamaInput = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
              }
            } else {
              // Input Biasa (Untuk Toko & Tukang)
              const val = String(item.nama).replace(/"/g, '&quot;');
              colNamaInput = `<input type="text" class="form-control item-nama" value="${val}" placeholder="Nama Barang">`;
            }

            // --- LOGIKA FORMAT HARGA (Titik Ribuan) ---
            const hargaTampil = formatRibuanInput(item.harga);

            // --- TEMPLATE BARIS TABEL (UPDATE PERBAIKAN) ---
            const row = `
              <tr id="row-${rowId}">
                <td>${colNamaInput}</td>
                
                <td>
                  <input type="number" class="form-control item-vol" value="${item.vol}" min="1" oninput="hitungBaris(this, '${tipe}')">
                </td>
                
                <td style="position: relative;"> <div class="autocomplete-wrapper">
                      <input type="text" class="form-control item-sat" value="${item.sat || ''}" placeholder="Satuan"
                        oninput="handleInputSatuan(this)" 
                        onfocus="handleInputSatuan(this)" 
                        autocomplete="off">
                      <div class="suggestion-list" style="display:none; min-width: 150px;"></div>
                    </div>
                </td>
                <td>
                  <input type="text" class="form-control item-harga" value="${hargaTampil}" oninput="hitungBaris(this, '${tipe}')">
                </td>
                
                <td>
                  <input type="text" class="form-control item-jumlah-display" readonly value="${formatRupiahJS(item.jumlah)}">
                  <input type="hidden" class="item-jumlah-value" value="${item.jumlah}">
                </td>
                
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="hapusBaris(this, '${tipe}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
            
            tbody.insertAdjacentHTML('beforeend', row);
          });
        } else {
          // Jika data item kosong (error case), buat 1 baris baru
          tambahBaris(tipe);
        }

        // 4. Hitung Ulang & Update UI Tombol
        hitungTotalSemua(tipe);

        const btnSimpan = document.getElementById(btnSimpanId);
        const btnBatal = document.getElementById(btnBatalId);
        
        // Ubah tombol jadi warna kuning (Mode Edit)
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btnSimpan.classList.remove('btn-success');
        btnSimpan.classList.add('btn-warning');
        
        btnBatal.classList.remove('hidden');

        // --- 5. PERBAIKAN SCROLL UNTUK MOBILE ---
        // Gunakan setTimeout agar rendering tabel selesai dulu sebelum scroll
        // Gunakan 'block: start' agar form mulai dari bagian atas layar
        setTimeout(() => {
          document.getElementById(formId).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 400); 
      }

      // Helper untuk set value select yang mungkin mengandung karakter spesial
      function setSelectValue(id, value) {
          const select = document.getElementById(id);
          // Cari option yang text/valuenya cocok
          for (let i = 0; i < select.options.length; i++) {
              // Decode HTML entities jika perlu, atau bandingkan langsung
              if (select.options[i].value === value || select.options[i].text === value) {
                  select.selectedIndex = i;
                  break;
              }
          }
      }

      // 4. Batal Edit (Reset Form & Mode)
      function batalEditTransaksi(tipe) {
        // 1. Reset Isi Form & Tabel
        resetFormTransaksi(tipe);

        // 2. Mapping ID Elemen berdasarkan Tipe
        let idHidden, btnSimpanId, btnBatalId;

        if (tipe === 'toko') {
          idHidden = 'trTokoId';
          btnSimpanId = 'btnSimpanTokoTrans';
          btnBatalId = 'btnBatalTokoTrans';
        } else if (tipe === 'tukang') {
          idHidden = 'trTukangId';
          btnSimpanId = 'btnSimpanTukangTrans';
          btnBatalId = 'btnBatalTukangTrans';
        } else { // guru
          idHidden = 'trGuruId';
          btnSimpanId = 'btnSimpanGuruTrans';
          btnBatalId = 'btnBatalGuruTrans';
        }

        // 3. Kosongkan ID Hidden (Indikator Mode Edit)
        document.getElementById(idHidden).value = '';

        // 4. Kembalikan Tombol Simpan ke Awal (Hijau)
        const btnSimpan = document.getElementById(btnSimpanId);
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Transaksi';
        btnSimpan.classList.remove('btn-warning');
        btnSimpan.classList.add('btn-success');
        btnSimpan.disabled = false;

        // 5. Sembunyikan Tombol Batal
        const btnBatal = document.getElementById(btnBatalId);
        btnBatal.classList.add('hidden');
      }

      // 5. Hapus Transaksi
      // --- HAPUS TRANSAKSI (INVALIDATE CACHE) ---
      function hapusTransaksi(id, tipe) {
        Swal.fire({
          title: 'Hapus Transaksi?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                Swal.fire('Terhapus!', 'Transaksi dihapus.', 'success');
                
                // --- UPDATE PENTING: INVALIDATE CACHE ---
                DATA_CACHE['transaksi_' + tipe] = null;
                DATA_CACHE.dashboard = null;
                // ---------------------------------------

                loadTransaksiData(tipe.toUpperCase());
              } else {
                Swal.fire({ icon: 'error', title: 'Gagal Menghapus', html: res.message });
              }
            }).hapusTransaksiItem(token, id);
          }
        });
      }

      // --- LOGIC SIMPAN YANG DIPERBARUI (HANDLE EDIT & BARU) ---
      // --- SIMPAN TRANSAKSI (INVALIDATE CACHE) ---
      function simpanTransaksi(tipe) {
        // 1. Tentukan ID Elemen
        let tableId, idHidden, btnId;
        if (tipe === 'toko') { tableId='tabelItemToko'; idHidden='trTokoId'; btnId='btnSimpanTokoTrans'; }
        else if (tipe === 'tukang') { tableId='tabelItemTukang'; idHidden='trTukangId'; btnId='btnSimpanTukangTrans'; }
        else { tableId='tabelItemGuru'; idHidden='trGuruId'; btnId='btnSimpanGuruTrans'; }

        // 2. Validasi & Ambil Data Header
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const idEdit = document.getElementById(idHidden).value;

        if (rows.length === 0) {
          Swal.fire('Eror', 'Belum ada rincian yang dimasukkan!', 'error'); return;
        }

        let tgl, uraian, pihak, pemesan, total;
        if (tipe === 'guru') {
          tgl = document.getElementById('trGuruTanggal').value;
          uraian = document.getElementById('trGuruUraian').value;
          const ketVal = document.getElementById('trGuruKeterangan').value;
          pihak = ketVal ? ketVal : "-"; 
          pemesan = "-";
          total = document.getElementById('trGuruTotalValue').value;
        } else {
          const prefix = (tipe === 'toko') ? 'trToko' : 'trTukang';
          tgl = document.getElementById(prefix + 'Tanggal').value;
          uraian = document.getElementById(prefix + 'Uraian').value;
          pihak = document.getElementById(prefix + 'Nama').value;
          pemesan = document.getElementById(prefix + 'Pemesan').value;
          total = document.getElementById(prefix + 'TotalValue').value;
        }

        if (!tgl || !uraian) { Swal.fire('Data Belum Lengkap', 'Harap lengkapi Tanggal dan Uraian!', 'warning'); return; }
        if (tipe !== 'guru' && (!pihak || !pemesan)) { Swal.fire('Data Belum Lengkap', 'Pihak Ketiga dan Pemesan wajib diisi!', 'warning'); return; }

        // 3. Ambil Rincian Item
        let items = [];
        rows.forEach(row => {
          items.push({
            nama: row.querySelector('.item-nama').value, 
            vol: row.querySelector('.item-vol').value,
            sat: row.querySelector('.item-sat').value,
            harga: cleanRibuan(row.querySelector('.item-harga').value),
            jumlah: row.querySelector('.item-jumlah-value').value
          });
        });

        const payload = {
          id: idEdit, tipe: tipe.toUpperCase(), tanggal: tgl,
          uraian: uraian, pihakKetiga: pihak, pemesan: pemesan,
          items: items, total: total
        };

        const token = localStorage.getItem('userToken');
        const btnSimpan = document.getElementById(btnId);
        const txtAsli = btnSimpan.innerHTML;
        
        btnSimpan.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...';
        btnSimpan.disabled = true;

        const handleResult = function(res) {
          btnSimpan.innerHTML = txtAsli;
          btnSimpan.disabled = false;
          
          if (res.status === 'success') {
            Swal.fire({
              icon: 'success', title: 'Berhasil!', text: res.message,
              showConfirmButton: false, timer: 1500
            });
            
            // --- UPDATE PENTING: INVALIDATE CACHE TRANSAKSI ---
            DATA_CACHE['transaksi_' + tipe] = null; 
            DATA_CACHE.dashboard = null;
            // -------------------------------------------------

            batalEditTransaksi(tipe); 
            loadTransaksiData(tipe.toUpperCase()); // Ini akan otomatis fetch baru karena cache null
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Transaksi', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handleResult).editTransaksiItem(token, payload);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handleResult).simpanTransaksiBaru(token, payload);
        }
      }

      // 2. Load Dropdown Options
      // --- LOAD OPSI TRANSAKSI (MULTI CACHE) ---
      function loadTransaksiOptions() {
        const token = localStorage.getItem('userToken');

        // CEK APAKAH SEMUA CACHE SUDAH TERISI?
        // Jika Toko, Guru, Tukang, Uraian, Satuan sudah ada di memori, TIDAK PERLU Fetch ulang.
        if (DATA_CACHE.toko && DATA_CACHE.guru && DATA_CACHE.tukang && DATA_CACHE.uraian && DATA_CACHE.satuan) {
          console.log("Semua opsi transaksi loaded from Cache.");
          isiDropdownTransaksi(); // Render UI dari Cache
          return;
        }

        // Jika ada yang kosong, baru panggil server
        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              const d = res.data;
              
              // ISI SEMUA CACHE SEKALIGUS
              DATA_CACHE.guru = d.guru;
              DATA_CACHE.toko = d.toko;
              DATA_CACHE.tukang = d.tukang;
              DATA_CACHE.uraian = d.uraian;
              DATA_CACHE.satuan = d.satuan;
              
              // Kompatibilitas Variabel Lama
              cacheDataGuru = d.guru; 
              cacheSatuan = d.satuan;
              cacheMasterUraian = d.uraian.map(u => u.uraian); // Extract uraian string array

              isiDropdownTransaksi();
            }
          }).getAllOptions(token);
      }

      // --- HELPER: ISI DROPDOWN TRANSAKSI ---
      function isiDropdownTransaksi() {
          const d = DATA_CACHE; // Pakai data dari cache
          
          // Helper isi select
          const isiSelect = (id, dataList, valueKey='nama') => {
            const el = document.getElementById(id);
            if(!el) return;
            const currentVal = el.value; 
            
            el.innerHTML = '<option value="">-- Pilih --</option>';
            if(dataList && dataList.length > 0) {
              dataList.forEach(item => {
                // Handle struktur uraian yang menggunakan key 'uraian', lainnya 'nama'
                const text = item[valueKey] || item.uraian || item.nama; 
                const val = String(text).replace(/"/g, '&quot;'); 
                el.innerHTML += `<option value="${val}">${text}</option>`;
              });
            }
            
            if(currentVal) el.value = currentVal;
          };
          
          // Uraian ops biasanya list object {id, uraian...}
          const uraianOps = d.uraian; 

          // Isi Dropdown Header
          isiSelect('trTokoUraian', uraianOps, 'uraian');
          isiSelect('trTokoNama', d.toko);
          isiSelect('trTokoPemesan', d.guru);

          isiSelect('trTukangUraian', uraianOps, 'uraian');
          isiSelect('trTukangNama', d.tukang);
          isiSelect('trTukangPemesan', d.guru);
          
          isiSelect('trGuruUraian', uraianOps, 'uraian'); 

          // Update Dropdown di Tabel Rincian Guru (Jika ada baris)
          updateDropdownTabelGuru();
      }

      // --- HELPER: UPDATE DROPDOWN DI TABEL GURU ---
      function updateDropdownTabelGuru() {
          const dropdownsDiTabel = document.querySelectorAll('#tabelItemGuru .item-nama');
          
          dropdownsDiTabel.forEach(select => {
            // Pastikan elemennya SELECT (bukan input manual)
            if (select.tagName === 'SELECT') {
                const valSebelumnya = select.value;
                
                let opts = '<option value="">-- Pilih Guru --</option>';
                opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
                
                if (DATA_CACHE.guru) {
                  DATA_CACHE.guru.forEach(g => {
                    const val = String(g.nama).replace(/"/g, '&quot;');
                    opts += `<option value="${val}">${g.nama}</option>`;
                  });
                }
                
                select.innerHTML = opts;
                if(valSebelumnya) select.value = valSebelumnya;
            }
          });
      }

      // --- FUNGSI GANTI DROPDOWN JADI INPUT TEXT (DENGAN TOMBOL X) ---
      function cekInputManual(selectElement) {
        if (selectElement.value === 'MANUAL_INPUT') {
          const parentTd = selectElement.parentElement;
          
          // Kita gunakan fitur Input Group Bootstrap
          // Class 'item-nama' tetap wajib ada di input agar terbaca saat simpan
          const htmlInputGroup = `
            <div class="input-group">
              <input type="text" class="form-control item-nama" placeholder="Ketik Nama Guru..." autofocus>
              <button class="btn btn-outline-secondary" type="button" onclick="resetKeDropdown(this)" title="Kembali ke Pilihan">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          
          parentTd.innerHTML = htmlInputGroup;
          
          // Otomatis fokus ke input
          parentTd.querySelector('input').focus();
        }
      }

      // --- FUNGSI KEMBALIKAN KE DROPDOWN ---
      function resetKeDropdown(btnElement) {
        // Cari elemen TD pembungkusnya
        const parentTd = btnElement.closest('td');
        
        // Susun Ulang Option Dropdown dari Cache
        let opts = '<option value="">-- Pilih Guru --</option>';
        opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
        
        if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
          cacheDataGuru.forEach(g => {
            const val = String(g.nama).replace(/"/g, '&quot;');
            opts += `<option value="${val}">${g.nama}</option>`;
          });
        }
        
        // Kembalikan ke bentuk Select
        const selectHtml = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
        parentTd.innerHTML = selectHtml;
      }

      // 3. Tambah Baris Dinamis
      function tambahBaris(tipe) {
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 
                        (tipe === 'tukang') ? 'tabelItemTukang' : 'tabelItemGuru';
        
        const tbody = document.getElementById(tableId).querySelector('tbody');
        const rowId = new Date().getTime() + Math.random();
        
        let colPertamaHtml = '';

        if (tipe === 'guru') {
          // 1. Susun Opsi Default
          let optionsGuru = '<option value="">-- Pilih Guru --</option>';
          // 2. Tambah Opsi Lainnya
          optionsGuru += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
          
          // 3. Isi Data Guru (jika cache sudah ready)
          if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
            cacheDataGuru.forEach(g => {
              const val = String(g.nama).replace(/"/g, '&quot;');
              optionsGuru += `<option value="${val}">${g.nama}</option>`;
            });
          }
          
          // 4. Tambahkan event onchange="cekInputManual(this)"
          colPertamaHtml = `<select class="form-select item-nama" onchange="cekInputManual(this)">${optionsGuru}</select>`;
        } else {
          colPertamaHtml = `<input type="text" class="form-control item-nama" placeholder="Nama Barang/Jasa">`;
        }
        
        // GANTI BAGIAN ROW DI BAWAH INI:
        const row = `
          <tr id="row-${rowId}">
            <td>${colPertamaHtml}</td>
            <td><input type="number" class="form-control item-vol" value="1" min="1" oninput="hitungBaris(this, '${tipe}')"></td>
            
            <td> 
              <div class="autocomplete-wrapper">
                <input type="text" class="form-control item-sat" placeholder="Satuan" 
                  oninput="handleInputSatuan(this)" 
                  onfocus="handleInputSatuan(this)" 
                  autocomplete="off">

              </div>
            </td>
            <td><input type="text" class="form-control item-harga" placeholder="0" oninput="hitungBaris(this, '${tipe}')"></td>
            <td>
              <input type="text" class="form-control item-jumlah-display" readonly value="0">
              <input type="hidden" class="item-jumlah-value" value="0">
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="hapusBaris(this, '${tipe}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
        
        tbody.insertAdjacentHTML('beforeend', row);
      }

      // 4. Hapus Baris
      function hapusBaris(btn, tipe) {
        const row = btn.closest('tr');
        row.remove();
        hitungTotalSemua(tipe); // Recalculate total
      }

      // 5. Kalkulasi Per Baris (Vol * Harga) - DENGAN FORMAT RIBUAN
      function hitungBaris(input, tipe) {
        const row = input.closest('tr');
        
        // A. Jika yang diketik adalah kolom Harga, format tampilannya
        if (input.classList.contains('item-harga')) {
          // Simpan posisi kursor (opsional, agar nyaman saat edit di tengah)
          // Untuk simpelnya, kita langsung format value-nya
          input.value = formatRibuanInput(input.value);
        }

        // B. Ambil Nilai untuk Kalkulasi (Gunakan cleanRibuan)
        const vol = parseFloat(row.querySelector('.item-vol').value) || 0;
        
        // Ambil teks harga (misal: "15.000"), bersihkan jadi 15000
        const hargaStr = row.querySelector('.item-harga').value;
        const harga = cleanRibuan(hargaStr); 
        
        const total = vol * harga;
        
        // Tampilkan format Rupiah di input readonly (Total Jumlah)
        row.querySelector('.item-jumlah-display').value = formatRupiahJS(total);
        // Simpan nilai asli di hidden input
        row.querySelector('.item-jumlah-value').value = total;
        
        hitungTotalSemua(tipe);
      }

      // 6. Hitung Grand Total
      function hitungTotalSemua(tipe) {
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 
                        (tipe === 'tukang') ? 'tabelItemTukang' : 'tabelItemGuru';
                        
        const inputs = document.querySelectorAll(`#${tableId} .item-jumlah-value`);
        
        let grandTotal = 0;
        inputs.forEach(el => { grandTotal += parseFloat(el.value) || 0; });

        // Update Tampilan Total Bawah
        let elDisplay, elValue;
        if(tipe === 'toko') {
          elDisplay = 'trTokoTotalDisplay'; elValue = 'trTokoTotalValue';
        } else if (tipe === 'tukang') {
          elDisplay = 'trTukangTotalDisplay'; elValue = 'trTukangTotalValue';
        } else {
          elDisplay = 'trGuruTotalDisplay'; elValue = 'trGuruTotalValue';
        }
        
        document.getElementById(elDisplay).innerText = formatRupiahJS(grandTotal);
        document.getElementById(elValue).value = grandTotal;
      }

      // Helper Format Rupiah JS
      function formatRupiahJS(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }

      // Helper: Reset Form
      function resetFormTransaksi(tipe) {
        let formId, tableId, dispId, valId;

        // Mapping ID Form & Total
        if (tipe === 'toko') {
          formId='formBelanjaToko'; tableId='tabelItemToko'; dispId='trTokoTotalDisplay'; valId='trTokoTotalValue';
        } else if (tipe === 'tukang') {
          formId='formBelanjaTukang'; tableId='tabelItemTukang'; dispId='trTukangTotalDisplay'; valId='trTukangTotalValue';
        } else { // GURU
          formId='formBelanjaGuru'; tableId='tabelItemGuru'; dispId='trGuruTotalDisplay'; valId='trGuruTotalValue';
        }
        
        // 1. Reset Form Header
        document.getElementById(formId).reset();

        // TAMBAHAN KHUSUS: Pastikan Textarea Keterangan Guru bersih
        if(tipe === 'guru') {
          document.getElementById('trGuruKeterangan').value = '';
        }
        
        // 2. Kosongkan Tabel Rincian
        document.querySelector(`#${tableId} tbody`).innerHTML = '';
        
        // 3. Reset Angka Total
        document.getElementById(dispId).innerText = 'Rp 0';
        document.getElementById(valId).value = 0;
        
        // 4. Tambahkan 1 Baris Kosong Default
        // Ini penting agar dropdown guru / input manual ter-render ulang dengan benar
        tambahBaris(tipe);
      }

      // --- FUNGSI POPUP DETAIL TRANSAKSI (FINAL REVISI: LAYOUT TABEL PRESISI) ---
      function lihatDetailTransaksi(encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        
        // Ambil Data Surat & Tanggal
        const s = data.dataSurat || {};
        const t = data.dataTanggal || {};

        // Helper Format Tanggal
        const fmtDate = (dStr) => {
            if(!dStr) return '<span class="text-muted fst-italic small bg-light px-2 rounded">- Kosong -</span>';
            const d = new Date(dStr);
            if(isNaN(d.getTime())) return '<span class="text-muted fst-italic small bg-light px-2 rounded">- Error -</span>';
            
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `<span class="fw-bold text-dark font-monospace">${dd}-${mm}-${yyyy}</span>`;
        };

        // Helper Format Nomor
        const fmtNo = (val) => {
            return val ? val : '<span class="text-muted fst-italic small fw-normal">- Belum diatur -</span>';
        };

        // --- LOGIKA TAMPILAN KHUSUS (GURU vs TOKO/TUKANG) ---
        let labelPihak = "Pihak Ketiga";
        let valPihak   = data.pihakKetiga;
        let labelBawah = "Pemesan";
        let valBawah   = data.pemesan;

        // JIKA TIPE ADALAH GURU
        if (data.tipe === 'GURU') {
            if (data.items && data.items.length > 0) {
               valPihak = data.items[0].nama;
            } else {
               valPihak = "-";
            }
            labelBawah = "Keterangan";
            valBawah = data.pihakKetiga; 
        }

        // 1. Header Info Dasar (UPDATE: Rata Kiri, Vertikal, Satu Baris, Scrollable)
        let htmlContent = `
          <div class="mb-3">
             <div class="table-responsive border rounded">
                <table class="table table-bordered table-sm mb-0 align-middle text-nowrap" style="font-size: 0.9rem;">
                  <tbody>
                    
                    <tr>
                      <td class="bg-light fw-bold text-secondary text-start" style="width: 30%; min-width: 140px;">
                        <i class="fas fa-clipboard-list text-primary me-2"></i>Uraian
                      </td>
                      <td class="fw-bold text-dark text-start">
                        ${data.uraian}
                      </td>
                    </tr>

                    <tr>
                      <td class="bg-light fw-bold text-secondary text-start">
                        <i class="fas fa-store text-success me-2"></i>${labelPihak}
                      </td>
                      <td class="text-start">
                        ${valPihak} 
                        <span class="badge bg-light text-secondary border ms-1" style="font-size: 0.7rem;">${data.tipe}</span>
                      </td>
                    </tr>

                    <tr>
                      <td class="bg-light fw-bold text-secondary text-start">
                        <i class="fas fa-user-tie text-info me-2"></i>${labelBawah}
                      </td>
                      <td class="text-start">
                        ${valBawah}
                      </td>
                    </tr>

                  </tbody>
                </table>
             </div>
             
             <div class="text-center text-muted fst-italic mt-1" style="font-size: 0.75rem;">
               <small><i class="fas fa-arrows-alt-h me-1"></i> Geser tabel ke samping jika teks terpotong</small>
             </div>
          </div>
        `;

        // 2. Tabel Rincian Barang
        htmlContent += `
          <h6 class="fw-bold mb-2 text-secondary" style="font-size: 0.85rem;"><i class="fas fa-box me-1"></i> Rincian Item</h6>
          <div class="table-responsive mb-4">
            <table class="table table-bordered table-sm align-middle text-nowrap mb-0" style="font-size: 0.85rem;">
              <thead class="table-light text-center">
                <tr>
                  <th>Nama Barang / Item</th>
                  <th width="10%">Vol</th>
                  <th width="10%">Sat</th>
                  <th width="25%">Jumlah</th>
                </tr>
              </thead>
              <tbody>
        `;

        if (data.items && data.items.length > 0) {
          data.items.forEach(item => {
            htmlContent += `
              <tr>
                <td class="text-start">${item.nama}</td>
                <td class="text-center">${item.vol}</td>
                <td class="text-center">${item.sat}</td>
                <td class="text-end fw-bold">${formatRupiahJS(item.jumlah)}</td>
              </tr>
            `;
          });
        } else {
          htmlContent += `<tr><td colspan="4" class="text-center text-muted">Tidak ada rincian item.</td></tr>`;
        }

        htmlContent += `
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                  <td class="text-end fw-bold fs-6 text-success">${formatRupiahJS(data.total)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;

        // 3. Status Dokumen Surat & Tanggal (PERBAIKAN: DIGESER SAMPING / SCROLLABLE)
        htmlContent += `
          <h6 class="fw-bold mb-2 text-primary" style="font-size: 0.85rem;">
            <i class="fas fa-file-signature me-1"></i> Status Dokumen & Tanggal
          </h6>
          
          <div class="table-responsive">
            
            <table class="table table-bordered table-sm align-middle text-nowrap mb-0" style="font-size: 0.85rem;">
              <thead class="bg-primary text-white bg-opacity-10">
                <tr>
                  <th class="text-start ps-3">Jenis Dokumen</th>
                  <th class="text-center px-3">Tanggal</th>
                  <th class="text-start ps-3">Nomor Surat</th>
                </tr>
              </thead>
              <tbody>
        `;

        const docs = [
            { label: 'Surat Permintaan', tgl: t.permintaan, no: s.permintaan },
            ...(data.tipe === 'TOKO' ? [{ label: 'Surat Penawaran', tgl: t.penawaran, no: s.penawaran }] : []),
            { label: 'BA Pemeriksaan', tgl: t.baPemeriksaan, no: s.baPemeriksaan },
            { label: 'BA Serah Terima', tgl: t.baSerahTerima, no: s.baSerahTerima },
            { label: 'BA Pembayaran', tgl: t.baPembayaran, no: s.baPembayaran }
        ];

        docs.forEach(doc => {
            htmlContent += `
                <tr>
                    <td class="fw-bold text-secondary text-start ps-3">${doc.label}</td>
                    <td class="text-center bg-light px-3">${fmtDate(doc.tgl)}</td>
                    <td class="text-start ps-3 font-monospace text-dark fw-bold">${fmtNo(doc.no)}</td>
                </tr>
            `;
        });

        htmlContent += `
              </tbody>
            </table>
          </div>
        `;

        // 4. Tampilkan Popup
        Swal.fire({
          title: 'Rincian & Dokumen',
          html: htmlContent,
          width: '750px', 
          showCloseButton: true,
          showConfirmButton: false,
          focusConfirm: false,
          customClass: {
            popup: 'rounded-4 shadow-lg'
          }
        });
      }

      /* --- LOGIKA MANAJEMEN NOMOR SURAT --- */

      let globalAutoSettings = { toko: {active: false}, tukang: {active: false} };

      function bukaTabSurat(tipe) {
        // 1. Reset Class Active pada tombol Tab
        document.getElementById('tab-surat-toko').classList.remove('active');
        document.getElementById('tab-surat-tukang').classList.remove('active');
        document.getElementById('tab-surat-setting').classList.remove('active');
        
        // 2. Ambil Elemen View (List vs Setting)
        const viewList = document.getElementById('view-surat-list');
        const viewSetting = document.getElementById('view-surat-setting');
        
        if (tipe === 'setting') {
          // --- MODE SETTING ---
          document.getElementById('tab-surat-setting').classList.add('active');
          
          // Sembunyikan List, Tampilkan Setting
          viewList.classList.add('hidden');
          viewSetting.classList.remove('hidden');
          
          // Load data setting dari server
          loadSettingNomor();

        } else {
          // --- MODE LIST (Toko / Tukang) ---
          if (tipe === 'toko') {
              document.getElementById('tab-surat-toko').classList.add('active');
          } else {
              document.getElementById('tab-surat-tukang').classList.add('active');
          }
          
          // Tampilkan List, Sembunyikan Setting
          viewList.classList.remove('hidden');
          viewSetting.classList.add('hidden');

          // Load Data Tabel
          loadDataSurat(tipe);
          
          // Refresh cache setting diam-diam agar saat popup dibuka datanya sudah siap
          refreshAutoSettingsCache(); 
        }
      }

      // 2. Load Data List
      // --- LOAD DATA SURAT (WITH CACHE) ---
      function loadDataSurat(tipe, forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelSuratBody');
        const cacheKey = 'transaksi_' + tipe; // misal: transaksi_toko

        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE[cacheKey]) {
          renderTabelSurat(DATA_CACHE[cacheKey], tipe);
          return;
        }

        // 2. FETCH SERVER
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data transaksi...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // SIMPAN KE CACHE
            DATA_CACHE[cacheKey] = res.data;
            renderTabelSurat(res.data, tipe);
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe.toUpperCase());
      }

      // --- RENDER TABEL SURAT ---
      function renderTabelSurat(data, tipe) {
        const tbody = document.getElementById('tabelSuratBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Belum ada data transaksi ' + tipe + '.</td></tr>';
          return;
        }

        data.forEach(item => {
          const s = item.dataSurat;
          let statusBadge = '<span class="badge bg-secondary">Belum Diatur</span>';

          if (s) {
            if (s.permintaan && s.baPembayaran) {
              statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
            } else {
              statusBadge = '<span class="badge bg-warning text-dark">Sebagian</span>';
            }
          }

          // Encode data agar aman masuk ke fungsi onclick
          const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");

          const btnLihat = `
            <button class="btn btn-sm btn-info text-white me-1" 
              onclick="lihatNomorSurat('${tipe}', '${dataJson}')" title="Lihat Daftar Nomor">
              <i class="fas fa-eye"></i>
            </button>
          `;

          const btnKelola = `
            <button class="btn btn-sm btn-outline-primary" 
              onclick="bukaModalSurat('${tipe}', '${dataJson}')">
              <i class="fas fa-edit me-1"></i> Kelola
            </button>
          `;

          const row = `
            <tr>
              <td>${item.tanggalDisplay}</td> 
              <td><div class="text-truncate" style="max-width:250px;">${item.uraian}</div></td>
              <td>${item.pihakKetiga}</td>
              <td>${statusBadge}</td>
              <td style="white-space:nowrap;">${btnLihat} ${btnKelola}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // TAMBAHKAN FUNGSI INI (Fungsi Baru untuk Popup Lihat Nomor)
      // GANTI FUNGSI INI DI Index.html
      function lihatNomorSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const s = data.dataSurat || {}; // Data Surat tersimpan

        let htmlContent = '<div class="text-start px-2">';
        
        // Helper styling baris info (Konsisten dengan lihatTanggalSurat)
        const rowInfo = (label, valHtml) => {
            return `
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-caret-right text-primary me-2"></i>
                        <div class="text-secondary small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">${label}</div>
                    </div>
                    <div class="ps-3 border-start border-3 border-light ms-1" style="font-size: 0.95rem;">${valHtml}</div>
                </div>
            `;
        };

        // Helper khusus format text nomor (Monospace font agar rapi seperti kode)
        const fmtNomor = (val) => {
            return val ? `<span class="fw-bold text-dark font-monospace">${val}</span>` : '<span class="text-muted fst-italic small bg-light px-2 rounded">- Belum diatur -</span>';
        };

        // [BAGIAN BARU] Detail Utama (Uraian & Pihak Ketiga)
        htmlContent += rowInfo('Uraian Pekerjaan', `<span class="fw-bold text-dark">${data.uraian}</span>`);
        
        let labelPihak = 'Pihak Ketiga';
        if(tipe === 'guru') labelPihak = 'Keterangan / Honorarium';
        
        htmlContent += rowInfo(labelPihak, `<span class="fw-bold text-dark">${data.pihakKetiga}</span>`);

        // Garis Pembatas
        htmlContent += '<hr class="border-secondary opacity-25 my-3" style="border-style: dashed;">';

        // [BAGIAN NOMOR SURAT]
        htmlContent += rowInfo('Surat Permintaan', fmtNomor(s.permintaan));
        
        // Penawaran hanya untuk Toko
        if (tipe === 'toko') {
            htmlContent += rowInfo('Surat Penawaran', fmtNomor(s.penawaran));
        }
        
        htmlContent += rowInfo('Berita Acara Pemeriksaan', fmtNomor(s.baPemeriksaan));
        htmlContent += rowInfo('Berita Acara Serah Terima', fmtNomor(s.baSerahTerima));
        htmlContent += rowInfo('Berita Acara Pembayaran', fmtNomor(s.baPembayaran));
        
        htmlContent += '</div>';

        // Tampilkan SweetAlert
        Swal.fire({
            title: `<span class="fs-5"><i class="fas fa-list-ol text-primary me-2"></i> Daftar Nomor Surat</span>`,
            html: htmlContent,
            showCloseButton: true,
            showConfirmButton: false,
            width: '500px',
            background: '#fff',
            customClass: {
              popup: 'rounded-4 shadow-lg'
            }
        });
      }

      // 3. Buka Modal & Isi Form
      let modalSuratBS = null; // Instance Bootstrap Modal

      // GANTI FUNGSI INI
      function bukaModalSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const s = data.dataSurat || {}; 
        const rawData = s.raw || {}; 
        
        // [PERBAIKAN 1] Ambil Data Tanggal Spesifik Dokumen
        const tDocs = data.dataTanggal || {};
        
        // Mapping Tanggal Spesifik (Fallback ke Tanggal Transaksi jika kosong)
        const dateMap = {
          permintaan: tDocs.permintaan || data.tanggal,
          penawaran: tDocs.penawaran || data.tanggal,
          baPemeriksaan: tDocs.baPemeriksaan || data.tanggal,
          baSerahTerima: tDocs.baSerahTerima || data.tanggal,
          baPembayaran: tDocs.baPembayaran || data.tanggal
        };

        // Simpan Mapping Tanggal ke Dataset Form agar bisa dibaca oleh simpanSurat()
        const formEl = document.getElementById('formInputSurat');
        formEl.dataset.dateMap = JSON.stringify(dateMap);

        document.getElementById('suratTransId').value = data.id;
        document.getElementById('suratTransTipe').value = tipe;
        document.getElementById('suratTransTanggal').value = data.tanggal; 

        const config = (tipe === 'toko') ? globalAutoSettings.toko : globalAutoSettings.tukang;
        const isAuto = config && config.active;

        const container = document.getElementById('containerInputSurat');
        container.innerHTML = ''; 

        // Toggle Alert
        if(isAuto) {
          document.getElementById('alertManualMode').classList.add('hidden');
          document.getElementById('alertAutoMode').classList.remove('hidden');
        } else {
          document.getElementById('alertManualMode').classList.remove('hidden');
          document.getElementById('alertAutoMode').classList.add('hidden');
        }

        let fields = [
          { key: 'permintaan', label: 'Surat Permintaan', icon: 'fa-envelope-open-text', format: config?.permintaan },
          { key: 'baPemeriksaan', label: 'BA Pemeriksaan', icon: 'fa-clipboard-check', format: config?.pemeriksaan },
          { key: 'baSerahTerima', label: 'BA Serah Terima', icon: 'fa-handshake', format: config?.bast },
          { key: 'baPembayaran', label: 'BA Pembayaran', icon: 'fa-money-check-alt', format: config?.bayar }
        ];

        if(tipe === 'toko') {
          fields.splice(1, 0, { key: 'penawaran', label: 'Surat Penawaran', icon: 'fa-file-invoice-dollar', format: config?.penawaran });
        }

        fields.forEach(f => {
          const currentValue = s[f.key] || '';
          let htmlInput = '';
          
          if (isAuto && f.format && f.format.trim() !== '') {
            // === MODE OTOMATIS ===
            const regex = /\[(.*?)\]/g;
            let matches = [...f.format.matchAll(regex)]; 
            
            let inputGroup = '';
            let placeholdersFound = false;

            const uniqueTags = [];
            matches.forEach(m => {
              const tag = m[1];
              if(!uniqueTags.includes(tag)) uniqueTags.push(tag);
            });

            uniqueTags.forEach(tag => {
              if(tag === 'bulan' || tag === 'tahun') return; // Skip bulan/tahun karena otomatis

              placeholdersFound = true;
              let savedVal = rawData[f.key] && rawData[f.key][tag] ? rawData[f.key][tag] : '';

              // --- DESAIN INPUT TAG ---
              inputGroup += `
                <div class="col-auto">
                  <div class="input-group shadow-sm" style="min-width: 180px;">
                    <span class="input-group-text bg-primary text-white border-primary fw-bold" style="font-size: 0.85rem;">
                      <i class="fas fa-pen fa-xs me-1 opacity-50"></i> ${tag}
                    </span>
                    <input type="text" class="form-control auto-input fw-bold text-dark" 
                          data-key="${f.key}" data-tag="${tag}"
                          value="${savedVal}" placeholder="..." style="font-size: 1rem; border-color: #cfe2ff;">
                  </div>
                </div>
              `;
            });

            const previewId = `preview-${f.key}`;
            
            if(placeholdersFound) {
              htmlInput = `
                <div class="p-3 bg-white rounded border" style="box-shadow: 0 2px 6px rgba(0,0,0,0.02);">
                  <div class="row g-2 align-items-center mb-2">${inputGroup}</div>
                  <div class="mt-2 px-3 py-2 rounded d-flex align-items-center" style="background-color: #f1f8ff; border-left: 4px solid #0d6efd;">
                    <div class="me-3 text-primary opacity-75"><i class="fas fa-eye"></i></div>
                    <div>
                      <div class="text-uppercase fw-bold text-primary opacity-50" style="font-size: 0.65rem; letter-spacing: 1px;">Hasil Preview</div>
                      <div id="${previewId}" class="fw-bold text-dark" style="font-size: 0.9rem; font-family: 'Consolas', monospace;">-</div>
                    </div>
                  </div>
                </div>
              `;
            } else {
              htmlInput = `
                <div class="p-2 bg-white rounded border">
                  <input type="hidden" class="auto-input" data-key="${f.key}" data-tag="DUMMY"> 
                  <div class="px-3 py-2 rounded d-flex align-items-center" style="background-color: #f8f9fa; border-left: 4px solid #6c757d;">
                    <div class="me-3 text-secondary opacity-50"><i class="fas fa-eye"></i></div>
                    <div>
                      <div class="text-uppercase fw-bold text-secondary opacity-50" style="font-size: 0.65rem; letter-spacing: 1px;">Hasil Preview (Otomatis)</div>
                      <div id="${previewId}" class="fw-bold text-dark" style="font-size: 0.9rem; font-family: 'Consolas', monospace;">-</div>
                    </div>
                  </div>
                </div>
              `;
            }

          } else {
            // === MODE MANUAL ===
            htmlInput = `
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light border-end-0"><i class="fas fa-keyboard text-muted"></i></span>
                <input type="text" class="form-control manual-input" id="manual_${f.key}" value="${currentValue}" placeholder="Ketik nomor surat lengkap disini...">
              </div>
            `;
          }

          const rowHtml = `
            <div class="mb-4">
              <label class="form-label fw-bold text-dark mb-2 d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">
                  <i class="fas ${f.icon}"></i>
                </div>
                ${f.label}
              </label>
              <div class="ps-1">${htmlInput}</div>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', rowHtml);
        });

        // [PERBAIKAN 2] Listener Preview - Pass dateMap, bukan tglTransaksi single
        if(isAuto) {
          const inputs = container.querySelectorAll('.auto-input');
          inputs.forEach(inp => {
            inp.addEventListener('input', () => updatePreviews(config, dateMap));
          });
          updatePreviews(config, dateMap);
        }

        const el = document.getElementById('modalSurat');
        modalSuratBS = new bootstrap.Modal(el);
        modalSuratBS.show();
      }

      // GANTI FUNGSI INI
      function updatePreviews(config, dateMap) {
        // Mapping Key HTML ID ke Key Config & Key DateMap
        const keyMap = {
          'permintaan': 'permintaan',
          'penawaran': 'penawaran',
          'baPemeriksaan': 'pemeriksaan', // HTML: baPemeriksaan -> Config: pemeriksaan
          'baSerahTerima': 'bast',        // HTML: baSerahTerima -> Config: bast
          'baPembayaran': 'bayar'         // HTML: baPembayaran -> Config: bayar
        };

        // Mapping Key HTML ke Key DateMap (karena penamaan di DateMap sedikit beda di code bukaModalSurat)
        const dateKeyMap = {
          'permintaan': 'permintaan',
          'penawaran': 'penawaran',
          'baPemeriksaan': 'baPemeriksaan',
          'baSerahTerima': 'baSerahTerima', 
          'baPembayaran': 'baPembayaran'
        };

        // Loop setiap field yang punya preview
        const previewSpans = document.querySelectorAll('[id^="preview-"]');
        previewSpans.forEach(span => {
          const htmlKey = span.id.replace('preview-', ''); // misal: baSerahTerima
          const configKey = keyMap[htmlKey]; // misal: bast
          
          // Ambil format mentah dari config
          let formatStr = config ? config[configKey] : ''; 

          if(!formatStr) {
              span.innerText = "-";
              return;
          }

          // [LOGIKA BARU] Ambil Tanggal SPESIFIK untuk field ini
          const specificDateKey = dateKeyMap[htmlKey];
          const dateString = dateMap[specificDateKey]; // Ambil tanggal dari map
          
          let bulan = '00', tahun = '0000';
          if(dateString) {
            const d = new Date(dateString);
            bulan = String(d.getMonth() + 1).padStart(2, '0');
            tahun = d.getFullYear();
          }

          // Replace Bulan & Tahun sesuai tanggal dokumen tersebut
          formatStr = formatStr.replace(/\[bulan\]/g, bulan).replace(/\[tahun\]/g, tahun);

          // Replace Input Tags (Nomor Urut, Kode, dll)
          const relatedInputs = document.querySelectorAll(`.auto-input[data-key="${htmlKey}"]`);
          relatedInputs.forEach(inp => {
            const tag = inp.getAttribute('data-tag');
            const val = inp.value || `[${tag}]`; 
            
            if(tag !== 'DUMMY') {
              const regex = new RegExp(`\\[${tag}\\]`, 'g');
              formatStr = formatStr.replace(regex, val);
            }
          });

          span.innerText = formatStr;
        });
      }

      // 4. Simpan Data Surat
      // --- SIMPAN SURAT (INVALIDATE CACHE) ---
      function simpanSurat(e) {
        e.preventDefault();
        
        const tipe = document.getElementById('suratTransTipe').value;
        const id = document.getElementById('suratTransId').value;
        
        // Ambil Config Toko/Tukang
        const config = (tipe === 'toko') ? globalAutoSettings.toko : globalAutoSettings.tukang;
        const isAuto = config && config.active;

        let dataSurat = {
          raw: {} 
        };
        
        // Ambil Map Tanggal dari Dataset Form (Logic dari update sebelumnya)
        const formEl = document.getElementById('formInputSurat');
        let dateMap = {};
        try {
          dateMap = JSON.parse(formEl.dataset.dateMap);
        } catch(err) {
          const tglGlobal = document.getElementById('suratTransTanggal').value;
          dateMap = {
            permintaan: tglGlobal, penawaran: tglGlobal, baPemeriksaan: tglGlobal, 
            baSerahTerima: tglGlobal, baPembayaran: tglGlobal
          };
        }

        const getBulanTahun = (dateStr) => {
          if(!dateStr) return { b: '00', t: '0000' };
          const d = new Date(dateStr);
          return {
            b: String(d.getMonth() + 1).padStart(2, '0'),
            t: d.getFullYear()
          };
        };

        if (isAuto) {
          // === MODE OTOMATIS ===
          
          // Fungsi internal pemroses format
          const processAutoFormat = (key, format, keyDate) => {
              const tglDoc = dateMap[keyDate]; 
              const { b, t } = getBulanTahun(tglDoc);

              let result = format.replace(/\[bulan\]/g, b).replace(/\[tahun\]/g, t);
              
              const inputs = document.querySelectorAll(`.auto-input[data-key="${key}"]`);
              
              if (!dataSurat.raw[key]) dataSurat.raw[key] = {};

              inputs.forEach(inp => {
                  const tag = inp.getAttribute('data-tag');
                  const val = inp.value.trim();
                  
                  if(tag !== 'DUMMY') {
                      dataSurat.raw[key][tag] = val; 
                      const regex = new RegExp(`\\[${tag}\\]`, 'g');
                      result = result.replace(regex, val);
                  }
              });
              return result;
          };

          const getFinalValue = (key, formatSetting, keyDateMap) => {
              if (formatSetting && formatSetting.trim() !== '') {
                  return processAutoFormat(key, formatSetting, keyDateMap);
              } else {
                  const elManual = document.getElementById('manual_' + key);
                  return elManual ? elManual.value : '';
              }
          };

          dataSurat.permintaan = getFinalValue('permintaan', config.permintaan, 'permintaan');
          dataSurat.baPemeriksaan = getFinalValue('baPemeriksaan', config.pemeriksaan, 'baPemeriksaan');
          dataSurat.baSerahTerima = getFinalValue('baSerahTerima', config.bast, 'baSerahTerima');
          dataSurat.baPembayaran = getFinalValue('baPembayaran', config.bayar, 'baPembayaran');
          
          if(tipe === 'toko') {
              dataSurat.penawaran = getFinalValue('penawaran', config.penawaran, 'penawaran');
          }

        } else {
          // === MODE MANUAL TOTAL ===
          dataSurat.permintaan = document.getElementById('manual_permintaan').value;
          dataSurat.baPemeriksaan = document.getElementById('manual_baPemeriksaan').value;
          dataSurat.baSerahTerima = document.getElementById('manual_baSerahTerima').value;
          dataSurat.baPembayaran = document.getElementById('manual_baPembayaran').value;
          
          if(tipe === 'toko') {
              dataSurat.penawaran = document.getElementById('manual_penawaran').value;
          }
        }

        const payload = { id: id, dataSurat: dataSurat };
        
        const btn = document.getElementById('btnSimpanSurat');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const token = localStorage.getItem('userToken');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            if(typeof modalSuratBS !== 'undefined') modalSuratBS.hide();
            
            // --- UPDATE PENTING: RESET CACHE ---
            DATA_CACHE['transaksi_' + tipe] = null; // Hapus cache lama
            loadDataSurat(tipe, true);              // Reload data baru
            // -----------------------------------

            Swal.fire({ 
              icon: 'success', title: 'Tersimpan', 
              text: 'Data nomor surat berhasil diperbarui.', timer: 1500, showConfirmButton: false 
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanDataSurat(token, payload);
      }

      /* --- LOGIKA MANAJEMEN TANGGAL SURAT --- */

      // 1. Tab Switching
      function bukaTabTanggal(tipe) {
        document.getElementById('tab-tgl-toko').classList.remove('active');
        document.getElementById('tab-tgl-tukang').classList.remove('active');
        
        if (tipe === 'toko') {
          document.getElementById('tab-tgl-toko').classList.add('active');
        } else {
          document.getElementById('tab-tgl-tukang').classList.add('active');
        }

        loadDataTanggal(tipe);
      }

      // 2. Load Data List untuk Tanggal
      // --- LOAD DATA TANGGAL (WITH CACHE) ---
      function loadDataTanggal(tipe, forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTanggalBody');
        const cacheKey = 'transaksi_' + tipe; // Gunakan key yg sama dgn Surat!

        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE[cacheKey]) {
          renderTabelTanggal(DATA_CACHE[cacheKey], tipe);
          return;
        }

        // 2. FETCH SERVER
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // Simpan ke Cache
            DATA_CACHE[cacheKey] = res.data;
            renderTabelTanggal(res.data, tipe);
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe.toUpperCase());
      }

      // --- RENDER TABEL TANGGAL ---
      function renderTabelTanggal(data, tipe) {
        const tbody = document.getElementById('tabelTanggalBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Belum ada data transaksi ' + tipe + '.</td></tr>';
          return;
        }

        data.forEach(item => {
          const t = item.dataTanggal;
          let statusBadge = '<span class="badge bg-secondary">Belum Diatur</span>';

          if (t && t.baPembayaran) {
            statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
          } else if (t) {
            statusBadge = '<span class="badge bg-warning text-dark">Sebagian</span>';
          }

          const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");

          const btnLihat = `
            <button class="btn btn-sm btn-info text-white me-1" 
              onclick="lihatTanggalSurat('${tipe}', '${dataJson}')" title="Lihat Daftar Tanggal">
              <i class="fas fa-eye"></i>
            </button>
          `;

          const btnAtur = `
            <button class="btn btn-sm btn-outline-success" 
              onclick="bukaModalTanggal('${tipe}', '${dataJson}')">
              <i class="fas fa-calendar-check me-1"></i> Atur
            </button>
          `;

          const row = `
            <tr>
              <td>${item.tanggalDisplay}</td> 
              <td><div class="text-truncate" style="max-width:250px;">${item.uraian}</div></td>
              <td>${item.pihakKetiga}</td>
              <td>${statusBadge}</td>
              <td style="white-space:nowrap;">${btnLihat} ${btnAtur}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // TAMBAHKAN FUNGSI INI (Fungsi Baru untuk Popup Lihat Tanggal)
      // GANTI FUNGSI INI DI Index.html
      function lihatTanggalSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const t = data.dataTanggal || {}; 

        // Helper Format Tanggal Indonesia (dd-mm-yyyy)
        const fmt = (dateStr) => {
            if(!dateStr) return '<span class="text-muted fst-italic small bg-light px-2 rounded">- Belum diatur -</span>';
            
            const d = new Date(dateStr);
            if(isNaN(d.getTime())) return '-';
            
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            
            return `<span class="fw-bold text-dark font-monospace">${dd}-${mm}-${yyyy}</span>`;
        };

        let htmlContent = '<div class="text-start px-2">';
        
        // Reuse styling baris info
        const rowInfo = (label, valHtml) => {
            return `
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-caret-right text-success me-2"></i>
                        <div class="text-secondary small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">${label}</div>
                    </div>
                    <div class="ps-3 border-start border-3 border-light ms-1" style="font-size: 0.95rem;">${valHtml}</div>
                </div>
            `;
        };

        // [BAGIAN BARU] Info Detail Utama (Uraian & Pihak Ketiga)
        htmlContent += rowInfo('Uraian Pekerjaan', `<span class="fw-bold text-dark">${data.uraian}</span>`);
        
        // Label Pihak Ketiga menyesuaikan Tipe
        let labelPihak = 'Pihak Ketiga';
        if(tipe === 'guru') labelPihak = 'Keterangan / Honorarium';
        
        htmlContent += rowInfo(labelPihak, `<span class="fw-bold text-dark">${data.pihakKetiga}</span>`);

        // Garis Pembatas (Divider)
        htmlContent += '<hr class="border-secondary opacity-25 my-3" style="border-style: dashed;">';

        // [BAGIAN TANGGAL]
        // 1. Tanggal Permintaan
        const tglMinta = t.permintaan || data.tanggal;
        htmlContent += rowInfo('Tgl. Surat Permintaan', fmt(tglMinta));
        
        // 2. Tanggal Penawaran (Khusus Toko)
        if (tipe === 'toko') {
            htmlContent += rowInfo('Tgl. Surat Penawaran', fmt(t.penawaran));
        }
        
        // 3. Tanggal Berita Acara
        htmlContent += rowInfo('Tgl. BA Pemeriksaan', fmt(t.baPemeriksaan));
        htmlContent += rowInfo('Tgl. BA Serah Terima', fmt(t.baSerahTerima));
        htmlContent += rowInfo('Tgl. BA Pembayaran', fmt(t.baPembayaran));
        
        htmlContent += '</div>';

        // Tampilkan SweetAlert
        Swal.fire({
            title: `<span class="fs-5"><i class="fas fa-calendar-alt text-success me-2"></i> Rincian Tanggal Dokumen</span>`,
            html: htmlContent,
            showCloseButton: true,
            showConfirmButton: false,
            width: '500px',
            background: '#fff',
            customClass: {
              popup: 'rounded-4 shadow-lg'
            }
        });
      }

      // 3. Buka Modal Tanggal (UPDATE: Dengan Validasi Tanggal Minimum)
      let modalTanggalBS = null;

      function bukaModalTanggal(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const t = data.dataTanggal || {}; 

        // Set ID Hidden
        document.getElementById('tglTransId').value = data.id;
        document.getElementById('tglTransTipe').value = tipe;

        // Reset Form
        document.getElementById('formInputTanggal').reset();

        // --- LOGIKA VALIDASI TANGGAL ---
        // Ambil Tanggal Transaksi (Format YYYY-MM-DD dari backend)
        const minDate = data.tanggal; 
        
        // Daftar ID Input yang ingin dibatasi
        const dateFields = [
          'tglSuratPenawaran', 
          'tglBaPemeriksaan', 
          'tglBaSerahTerima', 
          'tglBaPembayaran'
        ];

        // Loop setiap field untuk set atribut 'min'
        dateFields.forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            // Set batas minimum pemilihan tanggal
            el.setAttribute('min', minDate);
            
            // Opsional: Tambahkan event listener jika user mengetik manual (bukan klik kalender)
            el.onchange = function() {
              if(this.value && this.value < minDate) {
                Swal.fire('Tanggal Tidak Valid', 'Tanggal tidak boleh kurang dari tanggal transaksi (' + minDate + ')', 'warning');
                this.value = minDate; // Reset ke tanggal minimal
              }
            };
          }
        });

        // -------------------------------

        // Field Kondisional (Penawaran)
        const wrapPenawaran = document.getElementById('wrapTglPenawaran');
        if (tipe === 'toko') {
          wrapPenawaran.classList.remove('hidden');
          document.getElementById('tglSuratPenawaran').value = t.penawaran || '';
        } else {
          wrapPenawaran.classList.add('hidden');
          document.getElementById('tglSuratPenawaran').value = '';
        }

        // Isi Tanggal Permintaan (Readonly & Sesuai Transaksi)
        document.getElementById('tglSuratPermintaan').value = data.tanggal;

        // Isi Field Lainnya (jika ada di database)
        document.getElementById('tglBaPemeriksaan').value = t.baPemeriksaan || '';
        document.getElementById('tglBaSerahTerima').value = t.baSerahTerima || '';
        document.getElementById('tglBaPembayaran').value = t.baPembayaran || '';

        // Tampilkan Modal
        const el = document.getElementById('modalTanggal');
        modalTanggalBS = new bootstrap.Modal(el);
        modalTanggalBS.show();
      }

      // 4. Simpan Data Tanggal
      // --- SIMPAN TANGGAL (INVALIDATE CACHE) ---
      function simpanTanggal(e) {
        e.preventDefault();
        
        const tipe = document.getElementById('tglTransTipe').value;
        const id = document.getElementById('tglTransId').value;

        const dataTanggal = {
          permintaan: document.getElementById('tglSuratPermintaan').value,
          penawaran: document.getElementById('tglSuratPenawaran').value,
          baPemeriksaan: document.getElementById('tglBaPemeriksaan').value,
          baSerahTerima: document.getElementById('tglBaSerahTerima').value,
          baPembayaran: document.getElementById('tglBaPembayaran').value
        };

        const payload = { id: id, dataTanggal: dataTanggal };

        const btn = document.getElementById('btnSimpanTanggal');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const token = localStorage.getItem('userToken');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            if(typeof modalTanggalBS !== 'undefined') modalTanggalBS.hide();
            
            // --- UPDATE PENTING: RESET CACHE ---
            DATA_CACHE['transaksi_' + tipe] = null; 
            loadDataTanggal(tipe, true); 
            // -----------------------------------

            Swal.fire({
              icon: 'success', title: 'Tersimpan', 
              text: 'Data tanggal dokumen berhasil diperbarui.',
              timer: 1500, showConfirmButton: false
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanTanggalSurat(token, payload);
      }

      /* --- HELPER FORMAT ANGKA INPUT (FIXED COPY-PASTE) --- */

      // Mengubah input "10000" atau "10.000,00" menjadi tampilan "10.000"
      function formatRibuanInput(angka) {
        if (!angka && angka !== 0) return '';
        
        let str = String(angka);

        // 1. [PERBAIKAN UTAMA] Cek Koma (Desimal)
        // Jika ada koma, buang semua angka dibelakangnya.
        // Contoh: "100.000,00" -> diambil "100.000" saja.
        if (str.indexOf(',') > -1) {
          str = str.split(',')[0];
        }
        
        // 2. Hapus karakter selain angka (0-9)
        // Contoh: "Rp 100.000" -> "100000"
        let raw = str.replace(/[^\d]/g, '');
        
        if (!raw) return '';
        
        // 3. Format jadi 1.000.000 (Style Indonesia)
        return new Intl.NumberFormat('id-ID').format(raw);
      }

      // Mengubah tampilan "10.000" menjadi angka murni 10000 (untuk kalkulasi matematika)
      function cleanRibuan(str) {
        if (!str) return 0;
        
        let s = String(str);
        
        // 1. Buang desimal jika ada (Sama seperti di atas)
        if (s.indexOf(',') > -1) {
          s = s.split(',')[0];
        }
        
        // 2. Hapus tanda titik (ribuan) dan simbol mata uang
        // Kita sisakan angka dan tanda minus (jika ada diskon/potongan)
        let bersih = s.replace(/\./g, '').replace(/[^\d-]/g, '');
        
        return parseFloat(bersih) || 0;
      }

      /* --- FUNGSI DASHBOARD (UPDATE CACHE) --- */

      // 1. Fungsi Utama Load Dashboard
      function loadDashboardStats(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        
        // A. CEK CACHE: Jika data ada & tidak dipaksa refresh
        if (!forceRefresh && DATA_CACHE.dashboard) {
          console.log("Dashboard data loaded from Cache.");
          renderDashboardStats(DATA_CACHE.dashboard);
          return;
        }

        // B. TAMPILKAN LOADING (Hanya jika mengambil data baru dari server)
        document.getElementById('dashAnggaran').innerText = '...';
        document.getElementById('dashPengeluaran').innerText = '...';
        document.getElementById('dashSisa').innerText = '...';
        document.getElementById('dashJmlTrans').innerText = '...';
        
        // C. AMBIL DARI SERVER
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // Simpan ke Cache
            DATA_CACHE.dashboard = res.data;
            
            // Tampilkan Data
            renderDashboardStats(res.data);
          }
        }).getDashboardStats(token);
      }

      // 2. Fungsi Helper Render (Memisahkan tampilan dari logika load)
      function renderDashboardStats(d) {
        const p = d.profile || {}; // Data Profil Sekolah

        // Render Statistik
        const anggaran = parseFloat(d.anggaran) || 0;
        const pengeluaran = parseFloat(d.pengeluaran) || 0;
        const jmlTrans = d.jumlahTransaksi || 0;
        const sisa = anggaran - pengeluaran;

        document.getElementById('dashAnggaran').innerText = formatRupiahJS(anggaran);
        document.getElementById('dashPengeluaran').innerText = formatRupiahJS(pengeluaran);
        document.getElementById('dashSisa').innerText = formatRupiahJS(sisa);
        document.getElementById('dashJmlTrans').innerText = jmlTrans + " Item";

        // Pewarnaan Kartu Sisa
        const cardSisa = document.getElementById('cardSisaAnggaran');
        const titleSisa = cardSisa.querySelector('h6');
        const iconSisa = cardSisa.querySelector('i');
        const angkaSisa = cardSisa.querySelector('h3');
        const ketSisa = cardSisa.querySelector('small');
        
        // Reset class dasar
        cardSisa.className = 'card p-3 shadow-sm h-100'; 

        if (sisa > 0) {
          cardSisa.style.backgroundColor = '#ffc107'; 
          if(titleSisa) titleSisa.className = 'mb-0 text-dark fw-bold opacity-75';
          if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-dark opacity-50';
          if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-dark';
          if(ketSisa)   ketSisa.className = 'text-dark opacity-75';
        } else if (sisa === 0) {
          cardSisa.style.backgroundColor = '#198754';
          if(titleSisa) titleSisa.className = 'mb-0 text-white-50';
          if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-white opacity-50';
          if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-white';
          if(ketSisa)   ketSisa.className = 'text-white-50';
        } else {
          cardSisa.style.backgroundColor = '#dc3545';
          if(titleSisa) titleSisa.className = 'mb-0 text-white-50';
          if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-white opacity-50';
          if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-white';
          if(ketSisa)   ketSisa.className = 'text-white-50';
        }

        // Render Profil Sekolah
        document.getElementById('dashNamaSekolah').innerText = p.nama || '-';
        document.getElementById('dashNpsn').innerText = p.npsn || '-';
        document.getElementById('dashNsm').innerText = p.nsm || '-';
        document.getElementById('dashAlamat').innerText = p.alamat || '-';
        
        document.getElementById('dashKelurahan').innerText = p.kelurahan || '-';
        document.getElementById('dashKecamatan').innerText = p.kecamatan || '-';
        
        let kabProv = p.kabupaten || '-';
        if(p.provinsi) kabProv += ' - ' + p.provinsi;
        document.getElementById('dashKabupaten').innerText = kabProv;

        document.getElementById('dashTelp').innerText = p.noTelp || '-';
        document.getElementById('dashEmail').innerText = p.email || '-';
        
        document.getElementById('dashKepala').innerText = p.kepala || '-';
        document.getElementById('dashNipKepala').innerText = p.nipKepala || '-';
        document.getElementById('dashBendahara').innerText = p.bendahara || '-';
        document.getElementById('dashNipBendahara').innerText = p.nipBendahara || '-';
      }

      /* --- LOGIKA MENU CETAK PDF --- */

      // 1. Fungsi Ganti Tab Cetak
      /* --- UPDATE FUNGSI INI --- */
      function bukaTabCetak(tipe) {
        // Reset Tab Active Class
        document.getElementById('tab-cetak-toko').classList.remove('active');
        document.getElementById('tab-cetak-guru').classList.remove('active');
        document.getElementById('tab-cetak-tukang').classList.remove('active');
        document.getElementById('tab-cetak-setting').classList.remove('active'); // Baru
        
        // Set Active Tab Button
        document.getElementById('tab-cetak-' + tipe).classList.add('active');

        // Sembunyikan semua tabel view
        document.querySelectorAll('.view-cetak').forEach(el => el.classList.add('hidden'));
        
        // Munculkan tabel/view yang dipilih
        document.getElementById('view-cetak-' + tipe).classList.remove('hidden');

        // Load Data sesuai tipe
        if (tipe === 'setting') {
          loadTemplateSettings(); // Fungsi Baru
        } else {
          loadListCetak(tipe);
        }
      }

      // 2. Load Data ke Tabel Cetak
      // --- LOAD LIST CETAK PDF (WITH CACHE) ---
      function loadListCetak(tipeRaw, forceRefresh = false) {
        const tipe = tipeRaw.toUpperCase(); 
        const cacheKey = 'transaksi_' + tipeRaw; // Sharing cache dengan menu Transaksi!
        const tbody = document.getElementById('tbody-cetak-' + tipeRaw);

        // 1. CEK CACHE
        // Jika data sudah diload di menu Transaksi, kita pakai saja data itu!
        if (!forceRefresh && DATA_CACHE[cacheKey]) {
          renderTabelCetak(DATA_CACHE[cacheKey], tipeRaw);
          return;
        }

        // 2. FETCH SERVER
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Sedang memuat data...</td></tr>';
        const token = localStorage.getItem('userToken');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // Update Cache Global
            DATA_CACHE[cacheKey] = res.data;
            renderTabelCetak(res.data, tipeRaw);
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe);
      }

      // --- RENDER TABEL CETAK (DIPISAH) ---
      function renderTabelCetak(data, tipeRaw) {
        const tbody = document.getElementById('tbody-cetak-' + tipeRaw);
        tbody.innerHTML = '';

        if(data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Tidak ada data transaksi.</td></tr>';
          return;
        }

        data.forEach(item => {
          // Encode data
          const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");
          
          let displayPihak = item.pihakKetiga;
          if (tipeRaw === 'guru' && (displayPihak === '-' || displayPihak === 'Honorarium Guru')) {
              displayPihak = "-"; 
          }

          // --- LOGIKA TOMBOL ---
          const btnLihat = `
            <button class="btn btn-sm btn-outline-info me-1" 
              onclick="lihatDetailTransaksi('${dataJson}')" title="Lihat Rincian">
              <i class="fas fa-eye"></i>
            </button>
          `;

          let btnGenerate = '';
          let btnCetak = '';

          // Cek apakah PDF ID sudah ada
          if (item.pdfId && item.pdfId !== "") {
            const linkPdf = `https://drive.google.com/file/d/${item.pdfId}/view?usp=sharing`;
            
            btnCetak = `
                <button class="btn btn-sm btn-dark me-1" 
                  onclick="window.open('${linkPdf}', '_blank')" title="Cetak / Buka PDF">
                  <i class="fas fa-print"></i>
                </button>
            `;

            btnGenerate = `
              <button class="btn btn-sm btn-outline-danger" 
                onclick="prosesCetakPDF('${item.id}', '${dataJson}', '${tipeRaw}')" title="Generate Ulang">
                <i class="fas fa-sync-alt"></i>
              </button>
            `;

          } else {
            btnGenerate = `
              <button class="btn btn-sm btn-warning" 
                onclick="prosesCetakPDF('${item.id}', '${dataJson}', '${tipeRaw}')" title="Generate PDF Baru">
                <i class="fas fa-cog"></i>
              </button>
            `;
          }

          const row = `
            <tr>
              <td>${item.tanggalDisplay}</td>
              <td><div class="text-truncate" style="max-width: 250px;">${item.uraian}</div></td>
              <td>${displayPihak}</td>
              <td class="fw-bold">${formatRupiahJS(item.total)}</td>
              <td style="white-space: nowrap;">${btnLihat} ${btnCetak} ${btnGenerate}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      /* --- FUNGSI PROSES CETAK PDF (UPDATE) --- */
      // --- PROSES CETAK PDF (INVALIDATE CACHE) ---
      function prosesCetakPDF(id, encodedData, tipeTab) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const token = localStorage.getItem('userToken');

        // Cek teks konfirmasi
        let judul = 'Generate PDF?';
        let teks = `Sistem akan membuat laporan PDF untuk: ${data.uraian}`;
        let tombolWarna = '#ffc107'; 
        let tombolTeks = '<i class="fas fa-cog"></i> Generate';

        if (data.pdfId) {
            judul = 'Generate Ulang?';
            teks = `Peringatan: File PDF lama akan <b>DIHAPUS</b> dan diganti baru. Lanjutkan?`;
            tombolWarna = '#dc3545';
            tombolTeks = '<i class="fas fa-sync-alt"></i> Ya, Ganti File';
        }

        Swal.fire({
          title: judul, html: teks, icon: 'warning',
          showCancelButton: true, confirmButtonColor: tombolWarna,
          cancelButtonColor: '#6c757d', confirmButtonText: tombolTeks, cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            
            Swal.fire({
              title: 'Sedang Memproses...', html: 'Mohon tunggu, menyusun dokumen PDF...',
              allowOutsideClick: false, didOpen: () => { Swal.showLoading() }
            });

            // Persiapan Data
            let tipeTransaksi = data.tipe || 'TOKO';
            const namaMadrasah = document.getElementById('dashNamaSekolah').innerText || 'Madrasah';
            const nomorSurat = (data.dataSurat && data.dataSurat.permintaan) ? data.dataSurat.permintaan : 'DRAFT';

            const formUntukPDF = {
              idTransaksi: id, tipe: tipeTransaksi, nomorSurat: nomorSurat,
              pihakKetiga: data.pihakKetiga, pemesan: data.pemesan,
              uraian: data.uraian, tanggal: data.tanggal,         
              namaMadrasah: namaMadrasah, total: data.total, items: data.items              
            };

            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if (res.status === 'success') {
                
                // --- UPDATE PENTING: HAPUS CACHE ---
                // Kita pakai 'tipeTab' (misal: 'toko') untuk menyusun key cache
                DATA_CACHE['transaksi_' + tipeTab] = null;
                // ----------------------------------

                Swal.fire({
                  icon: 'success', title: 'Selesai!', text: 'Dokumen PDF berhasil dibuat.',
                  footer: `<a href="${res.url}" target="_blank" class="btn btn-primary btn-lg"><i class="fas fa-external-link-alt me-2"></i>Buka PDF Sekarang</a>`,
                  showConfirmButton: true, confirmButtonText: 'Oke'
                }).then(() => {
                    // Reload Tabel (akan fetch baru karena cache sudah null)
                    loadListCetak(tipeTab);
                });
              } else {
                Swal.fire({ icon: 'error', title: 'Terjadi Kesalahan', html: res.message, width: '500px' });
              }
            }).generateLPJ(token, formUntukPDF);
          }
        });
      }

      /* --- FITUR FILTER TABEL --- */

      // 1. Inisialisasi Opsi Tahun (Dipanggil saat window.onload)
      function initFilterTahun() {
        const currentYear = new Date().getFullYear();
        const startYear = currentYear - 2;
        const endYear = currentYear + 1;
        
        // UPDATE ARRAY IDS INI: Tambahkan 3 ID baru di akhir (fltTahun_cetak_...)
        const ids = [
          'fltTahun_toko', 'fltTahun_guru', 'fltTahun_tukang', 
          'fltTahun_surat', 'fltTahun_tgl',
          'fltTahun_cetak_toko', 'fltTahun_cetak_guru', 'fltTahun_cetak_tukang' // <-- Tambahan Baru
        ];
        
        ids.forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            el.innerHTML = '<option value="">Semua Tahun</option>';
            for(let y = startYear; y <= endYear; y++) {
              el.innerHTML += `<option value="${y}">${y}</option>`;
            }
          }
        });
      }

      // 2. Fungsi Utama Filter
      function jalankanFilter(tabelBodyId, tahunSelectId, bulanSelectId) {
        const filterTahun = document.getElementById(tahunSelectId).value;
        const filterBulan = document.getElementById(bulanSelectId).value;
        
        const tbody = document.getElementById(tabelBodyId);
        const rows = tbody.getElementsByTagName('tr');
        
        // Loop semua baris
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          // Kolom tanggal ada di index ke-0 (Kolom Pertama)
          // Format Teks di tabel: dd-MM-yyyy (Contoh: 05-12-2025)
          const tdTanggal = row.cells[0]; 
          
          if (tdTanggal) {
            const textTanggal = tdTanggal.textContent.trim();
            
            // Jika barisnya adalah "Memuat data..." atau kosong, skip
            if(textTanggal.includes('Memuat') || textTanggal.includes('Belum ada')) continue;
            
            // Pecah tanggal (dd-MM-yyyy)
            const parts = textTanggal.split('-');
            if(parts.length === 3) {
              const rowBulan = parts[1]; // MM
              const rowTahun = parts[2]; // yyyy
              
              // Logika Cek Match
              const matchTahun = (filterTahun === '') || (rowTahun === filterTahun);
              const matchBulan = (filterBulan === '') || (rowBulan === filterBulan);
              
              if (matchTahun && matchBulan) {
                row.style.display = ''; // Tampilkan
              } else {
                row.style.display = 'none'; // Sembunyikan
              }
            }
          }
        }
      }

      /* --- UPDATE di window.onload --- */
      window.onload = function() {
        initFilterTahun(); 

        const token = localStorage.getItem('userToken');
        const sessionToken = localStorage.getItem('sessionToken');
        const email = localStorage.getItem('userEmail');

        if(token && sessionToken && email) {
          
          // GUNAKAN TEKS KHUSUS DISINI
          toggleLoading(true, "Memeriksa Sesi..."); 

          google.script.run
            .withSuccessHandler(function(res) {
              toggleLoading(false); // Matikan loading
              
              if (res.valid) {
                  switchView('view-admin');
                  const savedName = localStorage.getItem('userName');
                  if(savedName) document.getElementById('schoolNameDisplay').innerText = "(" + savedName + ")";
                  loadDashboardStats(); 
                  startSessionMonitor();
              } else {
                  localStorage.clear();
                  document.getElementById('formLogin').reset();
                  switchView('view-login');
              }
            })
            .withFailureHandler(function() {
              toggleLoading(false);
              localStorage.clear();
              switchView('view-login');
            })
            .checkSessionStatus(email, sessionToken);
            
        } else {
          localStorage.clear();
          switchView('view-login');
        }
      };

      // Load Setting dari Server ke Form
      function loadSettingNomor() {
        const token = localStorage.getItem('userToken');
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          if(res.status === 'success' && res.data) {
            const s = res.data;
            globalAutoSettings = s; // Update Global Cache

            // Set Toko
            document.getElementById('toggleAutoToko').checked = s.toko.active;
            toggleFormSetting('toko');
            document.getElementById('fmtTokoPermintaan').value = s.toko.permintaan || '';
            document.getElementById('fmtTokoPenawaran').value = s.toko.penawaran || '';
            document.getElementById('fmtTokoPemeriksaan').value = s.toko.pemeriksaan || '';
            document.getElementById('fmtTokoBAST').value = s.toko.bast || '';
            document.getElementById('fmtTokoBayar').value = s.toko.bayar || '';

            // Set Tukang
            document.getElementById('toggleAutoTukang').checked = s.tukang.active;
            toggleFormSetting('tukang');
            document.getElementById('fmtTukangPermintaan').value = s.tukang.permintaan || '';
            document.getElementById('fmtTukangPemeriksaan').value = s.tukang.pemeriksaan || '';
            document.getElementById('fmtTukangBAST').value = s.tukang.bast || '';
            document.getElementById('fmtTukangBayar').value = s.tukang.bayar || '';
          }
        }).getSettingNomor(token);
      }

      // Helper Toggle UI
      function toggleFormSetting(tipe) {
        const isActive = document.getElementById(tipe === 'toko' ? 'toggleAutoToko' : 'toggleAutoTukang').checked;
        const formDiv = document.getElementById(tipe === 'toko' ? 'formAutoToko' : 'formAutoTukang');
        isActive ? formDiv.classList.remove('hidden') : formDiv.classList.add('hidden');
      }

      // Simpan Setting ke Server
      function simpanSettingNomor() {
        const token = localStorage.getItem('userToken');
        
        // Ambil data dari form
        const settings = {
          toko: {
            active: document.getElementById('toggleAutoToko').checked,
            permintaan: document.getElementById('fmtTokoPermintaan').value,
            penawaran: document.getElementById('fmtTokoPenawaran').value,
            pemeriksaan: document.getElementById('fmtTokoPemeriksaan').value,
            bast: document.getElementById('fmtTokoBAST').value,
            bayar: document.getElementById('fmtTokoBayar').value
          },
          tukang: {
            active: document.getElementById('toggleAutoTukang').checked,
            permintaan: document.getElementById('fmtTukangPermintaan').value,
            pemeriksaan: document.getElementById('fmtTukangPemeriksaan').value,
            bast: document.getElementById('fmtTukangBAST').value,
            bayar: document.getElementById('fmtTukangBayar').value
          }
        };

        // --- LOGIKA ANIMASI LOADING ---
        // Kita cari tombol yang memanggil fungsi ini
        // (Pastikan di HTML tombolnya: onclick="simpanSettingNomor()")
        const btn = document.querySelector('button[onclick="simpanSettingNomor()"]');
        const originalText = btn.innerHTML; // Simpan teks/icon asli

        // Ubah tombol jadi mode loading
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          // Kembalikan tombol ke semula
          btn.innerHTML = originalText;
          btn.disabled = false;

          if(res.status === 'success') {
            Swal.fire({
              icon: 'success', 
              title: 'Tersimpan',
              text: 'Pengaturan nomor otomatis berhasil disimpan!',
              timer: 1500,
              showConfirmButton: false
            });
            globalAutoSettings = settings; // Update cache global
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanSettingNomor(token, settings);
      }

      // Helper: Refresh Cache diam-diam saat buka tab list
      function refreshAutoSettingsCache() {
        const token = localStorage.getItem('userToken');
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          if(res.status === 'success' && res.data) globalAutoSettings = res.data;
        }).getSettingNomor(token);
      }

      /* --- FUNGSI NAVIGASI MOBILE --- */
      function toggleSidebar() {
        // Hanya jalankan jika di layar mobile (lebar < 768px)
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById('sidebarMenu');
          const overlay = document.getElementById('sidebarOverlay');
          
          // Toggle class 'show'
          sidebar.classList.toggle('show');
          overlay.classList.toggle('show');
        }
      }

      // Opsional: Perbaiki navigasiKe agar menutup sidebar di mobile
      // Update sedikit fungsi navigasiKe Anda:
      const originalNavigasiKe = navigasiKe; // Simpan fungsi lama
      navigasiKe = function(panelId, linkElement) {
          originalNavigasiKe(panelId, linkElement); // Jalankan logika lama
          
          // Logika tambahan: Tutup sidebar jika di mobile
          if (window.innerWidth < 768) {
              const sidebar = document.getElementById('sidebarMenu');
              const overlay = document.getElementById('sidebarOverlay');
              sidebar.classList.remove('show');
              overlay.classList.remove('show');
          }
      }

      function jalankanMaintenance() {
        const token = localStorage.getItem('userToken');
        
        Swal.fire({
          title: 'Perbaiki Database?',
          text: "Sistem akan mengecek dan menambahkan kolom yang hilang di Spreadsheet.",
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Ya, Jalankan'
        }).then((result) => {
          if (result.isConfirmed) {
            toggleLoading(true);
            
            google.script.run.withFailureHandler(handleServerError)
              .withSuccessHandler(function(res) {
                toggleLoading(false);
                if (res.status === 'success') {
                  // Tampilkan log perubahan agar user tahu apa yang terjadi
                  Swal.fire('Selesai', '<pre class="text-start" style="font-size:0.8rem">' + res.message + '</pre>', 'success');
                } else {
                  Swal.fire({ icon: 'error', title: 'Maintenance Gagal', html: res.message });
                }
              })
              .withFailureHandler(handleServerError) // Pastikan Anda sudah punya handler error ini
              .perbaikiSemuaHeader(token);
          }
        });
      }

      /* --- ERROR HANDLER GLOBAL --- */
      function handleServerError(err) {
        // Pastikan fungsi toggleLoading ada, jika tidak, bisa dihapus baris ini
        if (typeof toggleLoading === 'function') {
            toggleLoading(false);
        } else {
            // Fallback jika toggleLoading belum didefinisikan
            document.getElementById('loading').classList.add('hidden');
        }

        console.error("Server Error:", err);
        
        // Tampilkan pesan error ke user menggunakan SweetAlert
        Swal.fire({
          icon: 'error',
          title: 'Terjadi Kesalahan Server',
          text: err.message || 'Gagal menghubungi server Google Apps Script.',
          footer: '<small>Coba refresh halaman atau periksa koneksi internet.</small>',
          confirmButtonColor: '#d33'
        });

        // Reset tombol yang mungkin sedang disabled (loading state)
        const btns = document.querySelectorAll('button:disabled');
        btns.forEach(btn => {
          btn.disabled = false;
          // Kembalikan teks tombol jika sebelumnya ada spinner
          if(btn.innerHTML.includes('spinner-border')) {
            btn.innerHTML = '<i class="fas fa-redo"></i> Coba Lagi'; 
          }
        });
      }

      /* --- HELPER: SANITASI DATA (FIX TANDA KUTIP) --- */

      // 1. Untuk Tampilan di Tabel (Mencegah HTML Injection)
      function escapeHtml(text) {
        if (!text) return "";
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // 2. Untuk Parameter Tombol Edit (Mencegah JS Error)
      // Mengubah ' menjadi \' agar aman masuk ke fungsi onclick="edit('...')"
      // --- KODE BARU (PERBAIKAN) ---
      function escapeJsAttribute(text) {
        if (!text) return "";
        return String(text)
          .replace(/\\/g, "\\\\")       // 1. Escape backslash
          .replace(/\r?\n/g, "\\n")     // 2. Escape Enter/Newline (INI PERBAIKANNYA)
          .replace(/'/g, "\\'")         // 3. Escape kutip satu
          .replace(/"/g, "&quot;");     // 4. Escape kutip dua
      }

      /* --- TAMBAHKAN FUNGSI BARU INI DI BAWAH --- */

      // 1. Load Data ID Template dari Server
      // --- LOAD TEMPLATE SETTINGS (WITH CACHE) ---
      function loadTemplateSettings(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const ids = ['tplIdToko', 'tplIdGuru', 'tplIdTukang'];
        
        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE.template_settings) {
          const d = DATA_CACHE.template_settings;
          document.getElementById('tplIdToko').value = d.toko || '';
          document.getElementById('tplIdGuru').value = d.guru || '';
          document.getElementById('tplIdTukang').value = d.tukang || '';
          return;
        }

        // 2. FETCH SERVER
        ids.forEach(id => document.getElementById(id).placeholder = "Memuat...");

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            const d = res.data;
            
            // Simpan ke Cache
            DATA_CACHE.template_settings = d;

            document.getElementById('tplIdToko').value = d.toko || '';
            document.getElementById('tplIdGuru').value = d.guru || '';
            document.getElementById('tplIdTukang').value = d.tukang || '';
            
            ids.forEach(id => document.getElementById(id).placeholder = "Contoh: 1Fl8Jaf4j6XI...");
          }
        }).getTemplateSettings(token);
      }

      // 2. Simpan Data Template
      // --- SIMPAN TEMPLATE (INVALIDATE CACHE) ---
      function simpanTemplate(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const payload = {
          toko: document.getElementById('tplIdToko').value.trim(),
          guru: document.getElementById('tplIdGuru').value.trim(),
          tukang: document.getElementById('tplIdTukang').value.trim()
        };

        const btn = document.getElementById('btnSimpanTemplate');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          
          if (res.status === 'success') {
            // --- UPDATE: INVALIDATE CACHE ---
            DATA_CACHE.template_settings = null;
            loadTemplateSettings(true); // Reload untuk memastikan data tersimpan
            // --------------------------------

            Swal.fire('Sukses', 'Pengaturan template berhasil disimpan!', 'success');
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanTemplateSettings(token, payload);
      }

      function loadMasterReferensi() {
        // Cek jika cache sudah ada isinya
        if (cacheRefUraian.length > 0) return;

        const token = localStorage.getItem('userToken');
        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // --- PERBAIKAN DISINI: Simpan ke cacheRefUraian ---
            cacheRefUraian = res.data;
            console.log("Referensi Master Loaded: " + cacheRefUraian.length + " items");
          }
        }).getReferensiUraianMaster(token);
      }

      /* --- UPDATE: LOGIKA PENCARIAN URAIAN BERDASARKAN KODE (SORTED) --- */
      function handleInputUraian(el) {
        const keyword = el.value.toLowerCase();
        const listEl = document.getElementById('listSaranUraian');
        
        // 1. Validasi: Minimal 2 karakter (termasuk titik) baru mencari
        if (keyword.length < 2) {
          listEl.style.display = 'none';
          return;
        }

        // 2. PERSIAPAN DATA
        // Data Riwayat Inputan User (biasanya belum punya kode, kita kasih string kosong)
        const userHistoryObjs = cacheUserUraian.map(u => ({ uraian: u, kode: '' }));
        
        // Gabungkan Data Master (ada kode) + Riwayat (tanpa kode)
        const rawCombined = [...cacheRefUraian, ...userHistoryObjs];

        // Hapus Duplikat
        const uniqueMap = new Map();
        rawCombined.forEach(item => {
          // Gunakan kombinasi uraian+kode sebagai key unik agar lebih presisi
          const key = item.uraian + "_" + item.kode;
          if(!uniqueMap.has(key)){
            uniqueMap.set(key, item);
          }
        });
        const uniqueSource = Array.from(uniqueMap.values());

        // Deteksi apakah user sedang mengetik pola Kode (diawali angka)
        const isCodeSearch = /^[0-9]/.test(keyword);

        // 3. FILTER
        let matches = uniqueSource.filter(item => {
          const u = String(item.uraian).toLowerCase();
          const k = String(item.kode).toLowerCase();

          if (isCodeSearch) {
            // JIKA KODE: Prioritaskan yang kodenya DIAWALI keyword user
            // Contoh: ketik "2." -> ambil "2.1", "2.2", tapi abaikan "1.2.1"
            if (k.startsWith(keyword)) return true;
            
            // Tetap ambil jika uraian mengandung angka tersebut (opsional)
            return u.includes(keyword) || k.includes(keyword);
          } else {
            // JIKA TEKS BIASA: Cari di uraian atau kode
            return u.includes(keyword) || k.includes(keyword);
          }
        });

        // 4. SORTING CERDAS (LOGIKA UTAMA DISINI)
        matches.sort((a, b) => {
          const codeA = String(a.kode).toLowerCase();
          const codeB = String(b.kode).toLowerCase();
          
          // Prioritas A: Persis Sama
          if (codeA === keyword && codeB !== keyword) return -1;
          if (codeB === keyword && codeA !== keyword) return 1;

          // Prioritas B: Diawali dengan Kode (Hierarchy)
          const startA = codeA.startsWith(keyword);
          const startB = codeB.startsWith(keyword);

          // Jika A diawali keyword (misal 2.1) dan B tidak (misal uraiannya ada angka 2.1 tapi kodenya beda)
          if (startA && !startB) return -1;
          if (!startA && startB) return 1;

          // Prioritas C: Jika keduanya kode, Urutkan Secara Natural (Numeric Sort)
          // Ini agar urutannya: 2.1, 2.2 ... 2.9, 2.10 (bukan 2.1, 2.10, 2.2)
          if (startA && startB) {
            return codeA.localeCompare(codeB, undefined, { numeric: true, sensitivity: 'base' });
          }

          // Fallback: Urutkan berdasarkan panjang teks uraian (yang pendek lebih relevan)
          return a.uraian.length - b.uraian.length;
        });

        // 5. RENDER TAMPILAN
        if (matches.length > 0) {
          let html = '';
          // Limit hasil agar tidak terlalu panjang
          const limit = matches.length > 30 ? 30 : matches.length;
          
          for(let i=0; i<limit; i++) {
            const item = matches[i];
            const valSafe = escapeJsAttribute(item.uraian); 
            
            let badgeHtml = '';
            if(item.kode && item.kode !== "") {
              // Tampilkan Kode dengan font monospace agar rapi
              badgeHtml = `<span class="badge bg-primary me-2 font-monospace" style="min-width:60px;">${item.kode}</span>`;
            } else {
              badgeHtml = `<i class="fas fa-history text-secondary me-3 opacity-50"></i>`;
            }
            
            html += `
              <div class="suggestion-item border-bottom py-2 px-2" style="cursor:pointer;" onclick="pilihSaranUraian('${valSafe}')">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    ${badgeHtml}
                  </div>
                  <div class="flex-grow-1 text-wrap" style="line-height: 1.3; font-size:0.9rem;">
                    ${item.uraian}
                  </div>
                </div>
              </div>`;
          }
          
          listEl.innerHTML = html;
          listEl.style.display = 'block';
          
        } else {
          listEl.innerHTML = '<div class="p-2 text-muted fst-italic small">Data tidak ditemukan.</div>';
          listEl.style.display = 'block';
        }
      }

      function pilihSaranUraian(text) {
        const input = document.getElementById('urNama');
        input.value = text;
        
        // Sembunyikan list setelah memilih
        document.getElementById('listSaranUraian').style.display = 'none';
      }

      // 1. Fungsi Handler saat mengetik atau klik input Satuan
      function handleInputSatuan(el) {
        const keyword = el.value.toLowerCase();
        
        // 1. Simpan referensi input ini ke variabel global agar nanti bisa diisi
        activeSatuanInput = el;

        // 2. Ambil elemen Global List
        const listEl = document.getElementById('global-satuan-list');

        // 3. Ambil data referensi
        let sourceData = cacheSatuan; 
        if (sourceData.length === 0 && cacheDataSatuanLengkap.length > 0) {
            sourceData = cacheDataSatuanLengkap.map(i => i.nama);
        }
        
        // 4. Filter data
        let matches = [];
        if (keyword === "") {
          matches = sourceData; 
        } else {
          matches = sourceData.filter(item => 
            String(item).toLowerCase().includes(keyword)
          );
        }

        // 5. Render Hasil & Posisikan
        if (matches.length > 0) {
          let html = '';
          const limit = matches.length > 50 ? 50 : matches.length;
          
          for(let i=0; i<limit; i++) {
            const valSafe = String(matches[i]).replace(/'/g, "\\'"); 
            // Perhatikan: onclick sekarang memanggil fungsi pilihSatuanGlobal
            html += `<div class="suggestion-item" onclick="pilihSatuanGlobal('${valSafe}')">
                      ${matches[i]}
                    </div>`;
          }
          
          listEl.innerHTML = html;
          
          // --- TEKNIK POSISI MANUAL (PORTAL) ---
          // Hitung posisi input saat ini di layar
          const rect = el.getBoundingClientRect();
          
          // Posisikan list global tepat di bawah input
          // Ditambah window.scrollY agar posisi tetap benar meski halaman discroll ke bawah
          listEl.style.top = (rect.bottom + window.scrollY) + 'px'; 
          listEl.style.left = (rect.left + window.scrollX) + 'px';
          listEl.style.width = rect.width + 'px'; // Samakan lebarnya dengan input
          listEl.style.display = 'block';

        } else {
          listEl.style.display = 'none';
        }
      }

      // Fungsi untuk memosisikan ulang list agar selalu menempel pada input
      function updateGlobalListPosition() {
        const listEl = document.getElementById('global-satuan-list');
        
        // Hanya jalankan jika list sedang tampil dan ada input yang aktif
        if (listEl && listEl.style.display === 'block' && activeSatuanInput) {
          const rect = activeSatuanInput.getBoundingClientRect();
          
          // Update posisi berdasarkan koordinat input saat ini
          listEl.style.top = (rect.bottom + window.scrollY) + 'px'; 
          listEl.style.left = (rect.left + window.scrollX) + 'px';
          listEl.style.width = rect.width + 'px';
        }
      }

      // Listener Scroll: Update posisi list (JANGAN DITUTUP)
      document.addEventListener('scroll', function(e) {
        // 1. Jika yang discroll adalah list saran itu sendiri, biarkan saja
        const listEl = document.getElementById('global-satuan-list');
        if (e.target === listEl) return;
        
        // 2. Jika yang discroll adalah halaman/tabel, IKUTI pergerakan inputnya
        updateGlobalListPosition();
      }, true); // Capture phase

      // Listener Resize: Update posisi jika layar diubah ukurannya
      window.addEventListener('resize', function() {
        updateGlobalListPosition();
      });

      // Tutup list jika klik di luar
      // Listener Global untuk Klik (Menutup Dropdown saat klik di luar)
      document.addEventListener('click', function(e) {
        
        // --- BAGIAN 1: MENANGANI LIST LOKAL (URAIAN & BARANG) ---
        // (Kode lama Anda: Menangani list yang ada di dalam .autocomplete-wrapper)
        const allWrappers = document.querySelectorAll('.autocomplete-wrapper');
        
        allWrappers.forEach(wrapper => {
            const listEl = wrapper.querySelector('.suggestion-list');
            
            // Cek jika list sedang tampil DAN klik terjadi di luar wrapper pembungkusnya
            if (listEl && listEl.style.display === 'block' && !wrapper.contains(e.target)) {
                listEl.style.display = 'none';
            }
        });

        // --- BAGIAN 2: MENANGANI LIST GLOBAL (SATUAN) ---
        // (Kode baru: Menangani list yang menempel di Body)
        const globalList = document.getElementById('global-satuan-list');
          if (globalList && globalList.style.display === 'block') {
              // Tutup HANYA jika klik terjadi di luar List DAN di luar Input
              if (!globalList.contains(e.target) && e.target !== activeSatuanInput) {
                  globalList.style.display = 'none';
              }
          }
      });

      function pilihSatuanGlobal(text) {
        if (activeSatuanInput) {
          activeSatuanInput.value = text;
          // Trigger event input (penting untuk perhitungan otomatis jika ada)
          activeSatuanInput.dispatchEvent(new Event('input'));
        }
        
        // Sembunyikan list global
        document.getElementById('global-satuan-list').style.display = 'none';
      }
      
      /* --- LOGIKA PENCARIAN REFERENSI BARANG (UPDATED: RICH UI & SMART SORTING) --- */
      
      let timeoutCariBarang = null;

      function handleCariBarang(inputEl, tipe) {
        const keyword = inputEl.value.toLowerCase();
        const listId = (tipe === 'toko') ? 'saran-barang-toko' : 'saran-barang-tukang';
        const listEl = document.getElementById(listId);

        // 1. Reset Tampilan
        listEl.style.display = 'none';
        listEl.innerHTML = '';

        // 2. Validasi Minimal Karakter
        if (keyword.length < 3) return;

        clearTimeout(timeoutCariBarang);

        // --- SKENARIO A: DATA SUDAH ADA DI CACHE (INSTANT SEARCH) ---
        if (cacheDataBarangLengkap && cacheDataBarangLengkap.length > 0) {
            
            timeoutCariBarang = setTimeout(() => {
                // A. Filter Data
                let matches = cacheDataBarangLengkap.filter(item => {
                    const nama = item.nama ? item.nama.toLowerCase() : '';
                    const kat = item.katNama ? item.katNama.toLowerCase() : '';
                    const kode = item.katKode ? item.katKode.toLowerCase() : '';
                    
                    return nama.includes(keyword) || kat.includes(keyword) || kode.includes(keyword);
                });

                // B. Sorting Cerdas (Agar urutan sama dengan Server/Logic Manusia)
                matches.sort((a, b) => {
                    const nameA = String(a.nama).toLowerCase();
                    const nameB = String(b.nama).toLowerCase();
                    
                    // Prioritas 1: Persis Sama
                    if (nameA === keyword && nameB !== keyword) return -1;
                    if (nameB === keyword && nameA !== keyword) return 1;
                    
                    // Prioritas 2: Diawali dengan Keyword (Starts With)
                    const startA = nameA.startsWith(keyword);
                    const startB = nameB.startsWith(keyword);
                    if (startA && !startB) return -1;
                    if (!startA && startB) return 1;
                    
                    // Prioritas 3: Abjad
                    return nameA.length - nameB.length; 
                });

                // Tampilkan Hasil (Limit 30 item)
                renderHasilPencarianBarang(matches.slice(0, 30), tipe, listEl);
            }, 200);

            return; 
        }

        // --- SKENARIO B: CACHE KOSONG -> CARI KE SERVER (FALLBACK) ---
        timeoutCariBarang = setTimeout(() => {
           const wrapper = inputEl.closest('.input-group');
           const icon = wrapper ? wrapper.querySelector('i') : null;
           const originalIconClass = 'fas fa-search'; 

           if(icon) icon.className = 'fas fa-spinner fa-spin text-primary';

           const token = localStorage.getItem('userToken');
           
           google.script.run.withSuccessHandler(function(res) {
             if(icon) icon.className = originalIconClass;

             if (res.status === 'success') {
                renderHasilPencarianBarang(res.data, tipe, listEl);
             } else {
                renderHasilPencarianBarang([], tipe, listEl);
             }
           }).cariBarangReferensi(token, keyword);

        }, 400); 
      }

      // --- HELPER BARU: RENDER HASIL PENCARIAN (TAMPILAN INFORMATIF / RICH UI) ---
      function renderHasilPencarianBarang(data, tipe, listEl) {
         if (data && data.length > 0) {
            let html = '';
            
            data.forEach(item => {
              const namaSafe = escapeJsAttribute(item.nama);
              const satSafe  = escapeJsAttribute(item.satuan);
              const harga    = item.harga || 0;
              
              // --- LOGIKA UI BADGE & KATEGORI ---
              // Menyiapkan tampilan Kategori (ikon tag) dan Satuan (badge)
              const katHtml = item.katNama 
                ? `<div class="text-muted small mt-1" style="font-size: 0.75rem;"><i class="fas fa-tag me-1 text-secondary opacity-50"></i>${item.katNama}</div>` 
                : '';
                
              html += `
                <div class="suggestion-item border-bottom py-2 px-3" 
                    style="cursor:pointer; transition: all 0.2s;"
                    onclick="pilihReferensiBarang('${namaSafe}', '${satSafe}', ${harga}, '${tipe}', this)">
                  
                  <div class="d-flex justify-content-between align-items-start">
                    
                    <div style="overflow:hidden; padding-right: 10px;">
                        <div class="fw-normal text-dark text-wrap" style="line-height: 1.2;">
                          ${item.nama}
                        </div>
                        ${katHtml}
                    </div>

                    <div class="text-end flex-shrink-0">
                        <div class="fw-bold text-success" style="font-size: 0.9rem;">
                          ${formatRupiahJS(harga)}
                        </div>
                        <div class="mt-1">
                          <span class="badge bg-light text-secondary border rounded-pill fw-normal" style="font-size: 0.7rem;">
                            ${item.satuan || '-'}
                          </span>
                        </div>
                    </div>

                  </div>
                </div>
              `;
            });
            
            listEl.innerHTML = html;
            listEl.style.display = 'block';
         } else {
            listEl.innerHTML = '<div class="p-3 text-muted fst-italic text-center small"><i class="fas fa-search me-1"></i> Data tidak ditemukan.</div>';
            listEl.style.display = 'block';
         }
      }

      // --- UPDATE FUNGSI PILIH DARI PENCARIAN REFERENSI (AUTOCOMPLETE) ---
      function pilihReferensiBarang(nama, satuan, harga, tipe, itemEl) {
        
        // 1. Tentukan Tabel Target
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 'tabelItemTukang';
        const tbody = document.getElementById(tableId).querySelector('tbody');
        
        // Ambil daftar baris saat ini
        let rows = tbody.querySelectorAll('tr');
        let targetRow = null;

        // 2. LOGIKA CEK BARIS (Mencegah Overwrite Data)
        if (rows.length > 0) {
          const lastRow = rows[rows.length - 1];
          const inputNama = lastRow.querySelector('.item-nama');
          
          // Cek apakah baris terakhir namanya MASIH KOSONG?
          // Jika kosong, kita pakai baris ini.
          if (inputNama && inputNama.value.trim() === '') {
            targetRow = lastRow;
          }
        }

        // 3. Jika tidak ada baris yang bisa dipakai (Tabel kosong ATAU Baris terakhir sudah penuh)
        // Maka Buat Baris Baru
        if (!targetRow) {
          tambahBaris(tipe); 
          // Update daftar rows dan ambil yang baru saja dibuat
          rows = tbody.querySelectorAll('tr');
          targetRow = rows[rows.length - 1];
        }

        // 4. Isi Data ke Input
        if (targetRow) {
          const inputNama = targetRow.querySelector('.item-nama');
          const inputSat = targetRow.querySelector('.item-sat');
          const inputHarga = targetRow.querySelector('.item-harga');

          if (inputNama) inputNama.value = unescapeHtml(nama);
          if (inputSat) inputSat.value = unescapeHtml(satuan);
          
          // Isi Harga & Hitung Otomatis
          if (inputHarga) {
            inputHarga.value = formatRibuanInput(harga); 
            hitungBaris(inputHarga, tipe); 
          }
          
          // Efek visual (Highlight Kuning sesaat)
          targetRow.classList.add('table-warning');
          setTimeout(() => targetRow.classList.remove('table-warning'), 500);
        }

        // 5. Bersihkan Tampilan Pencarian & Reset Fokus
        const wrapper = itemEl.closest('.autocomplete-wrapper');
        if (wrapper) {
          const list = wrapper.querySelector('.suggestion-list');
          const inputCari = wrapper.querySelector('input');
          
          if(list) list.style.display = 'none'; // Tutup saran
          
          if(inputCari) {
              inputCari.value = ''; // Kosongkan kotak pencarian
              inputCari.focus();    // Kembalikan kursor ke kotak pencarian agar bisa cari lagi
          }
        }
      }

      // Helper untuk decode string (jika diperlukan saat insert value)
      function unescapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'")
            .replace(/\\\\/g, "\\"); // Fix escape slash
      }

      /* --- LOGIKA INFO SATUAN (NEW) --- */
      let cacheDataSatuanLengkap = [];

      function bukaModalSatuan() {
        const modal = new bootstrap.Modal(document.getElementById('modalInfoSatuan'));
        modal.show();

        // Reset pencarian
        document.getElementById('cariSatuanInput').value = '';

        // Cek cache, jika kosong load dari server
        if (cacheDataSatuanLengkap.length === 0) {
          loadInfoSatuanFromServer();
        } else {
          renderTabelSatuan(cacheDataSatuanLengkap);
        }
      }

      function loadInfoSatuanFromServer() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('bodyInfoSatuan');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-info" role="status"></div><br>Sedang mengambil data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            cacheDataSatuanLengkap = res.data;

            // --- PASTIKAN BARIS INI ADA ---
            saveCacheToLocal(); 
            // ------------------------------

            renderTabelSatuan(cacheDataSatuanLengkap);
          } else {
            tbody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Gagal: ${res.message}</td></tr>`;
          }
        }).getReferensiSatuanLengkap(token);
      }

      function renderTabelSatuan(data) {
        const tbody = document.getElementById('bodyInfoSatuan');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Belum ada data satuan.</td></tr>';
          return;
        }

        data.forEach(item => {
          // Logika warna badge kategori
          let badgeClass = 'bg-secondary';
          const kat = item.kategori.toLowerCase();
          if (kat.includes('berat') || kat.includes('kilo')) badgeClass = 'bg-primary';
          else if (kat.includes('panjang') || kat.includes('meter')) badgeClass = 'bg-success';
          else if (kat.includes('volume') || kat.includes('liter')) badgeClass = 'bg-info text-dark';
          else if (kat.includes('buah') || kat.includes('pcs') || kat.includes('unit')) badgeClass = 'bg-warning text-dark';

          const row = `
            <tr>
              <td class="fw-bold text-dark font-monospace" style="font-size: 1.1em;">${item.nama}</td>
              <td><span class="badge ${badgeClass} fw-normal px-3 py-2 rounded-pill">${item.kategori}</span></td>
              <td class="text-muted small">${item.contoh}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      function filterInfoSatuan() {
        const keyword = document.getElementById('cariSatuanInput').value.toLowerCase();
        const tbody = document.getElementById('bodyInfoSatuan');
        const rows = tbody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
          const nama = rows[i].cells[0]?.textContent.toLowerCase() || '';
          const kategori = rows[i].cells[1]?.textContent.toLowerCase() || '';
          const contoh = rows[i].cells[2]?.textContent.toLowerCase() || '';

          if (nama.includes(keyword) || kategori.includes(keyword) || contoh.includes(keyword)) {
            rows[i].style.display = "";
          } else {
            rows[i].style.display = "none";
          }
        }
      }

      // 1. Toggle Tampilan Input
      function toggleResetMethod(method) {
        const grpCode = document.getElementById('input-group-code');
        const grpQna = document.getElementById('input-group-qna');
        const inputCode = document.getElementById('resetCode');
        const inputAnswer = document.getElementById('resetAnswer');

        if (method === 'code') {
          grpCode.classList.remove('hidden');
          grpQna.classList.add('hidden');
          inputCode.required = true;
          inputAnswer.required = false;
        } else {
          grpCode.classList.add('hidden');
          grpQna.classList.remove('hidden');
          inputCode.required = false;
          inputAnswer.required = true;
        }
      }

      // 2. Handle Submit Reset (Modifikasi)
      function handleResetPassword(e) {
        e.preventDefault();
        
        // 1. Ambil Input Password & Email
        const p1 = document.getElementById('resetPassNew').value;
        const p2 = document.getElementById('resetPassConf').value;
        const email = document.getElementById('resetEmail').value;

        // 2. Validasi: Password Baru harus sama
        if(p1 !== p2) {
          Swal.fire('Password Tidak Cocok', 'Konfirmasi password baru tidak sama.', 'warning');
          return;
        }

        // 3. Tampilkan Loading
        toggleLoading(true);

        // 4. Cek Metode Mana yang Sedang Aktif (Radio Button)
        const isMethodCode = document.getElementById('methodCode').checked;

        if (isMethodCode) {
          // ============================================
          // OPSI A: Reset Menggunakan KODE PEMULIHAN
          // ============================================
          const form = {
            email: email,
            code: document.getElementById('resetCode').value, // Ambil Kode
            newPassword: p1
          };

          // Panggil fungsi server lama
          google.script.run
            .withFailureHandler(handleServerError)
            .withSuccessHandler(resetCallback) // Gunakan callback helper
            .resetPasswordWithCode(form);

        } else {
          // ============================================
          // OPSI B: Reset Menggunakan PERTANYAAN KEAMANAN (UPDATE)
          // ============================================
          
          // Ambil Value dari Dropdown Pertanyaan & Input Jawaban
          const questionVal = document.getElementById('resetQuestion').value;
          const answerVal = document.getElementById('resetAnswer').value;

          // Validasi: User wajib memilih pertanyaan dari dropdown
          if (!questionVal || questionVal === "") {
            toggleLoading(false);
            Swal.fire('Peringatan', 'Harap pilih Pertanyaan Keamanan terlebih dahulu.', 'warning');
            return;
          }

          const form = {
            email: email,
            question: questionVal, // Kirim ID Pertanyaan (misal: 'ibu', 'hewan')
            answer: answerVal,     // Kirim Jawaban User
            newPassword: p1
          };

          // Panggil fungsi server baru
          google.script.run
            .withFailureHandler(handleServerError)
            .withSuccessHandler(resetCallback) // Gunakan callback helper
            .resetPasswordByQuestion(form);
        }
      }

      // --- FUNGSI HELPER CALLBACK (Agar kode lebih rapi) ---
      function resetCallback(res) {
        toggleLoading(false); // Matikan loading
        
        if(res.status === 'success') {
          // Jika Berhasil: Reset Form & Kembali ke Login
          document.getElementById('formReset').reset();
          
          // Kembalikan tampilan ke default (Mode Kode)
          if(typeof toggleResetMethod === 'function') {
              toggleResetMethod('code'); 
              document.getElementById('methodCode').checked = true;
          }
          
          Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: res.message,
            confirmButtonText: 'Login Sekarang'
          }).then(() => {
            switchView('view-login');
          });

        } else {
          // Jika Gagal: Tampilkan Pesan Error
          Swal.fire({
            icon: 'error',
            title: 'Gagal',
            text: res.message
          });
        }
      }

      /* --- LOGIKA RESET PASSWORD BARU (OTP) --- */

      // 1. Handle Kirim OTP (Step 1)
      function handleSendOtp(e) {
        e.preventDefault();
        
        const email = document.getElementById('resetEmailInput').value;
        const btn = document.getElementById('btnSendOtp');
        
        // Loading State
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengecek...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (res.status === 'success') {
            // Jika Sukses: Sembunyikan Step 1, Tampilkan Step 2
            document.getElementById('formStep1').classList.add('hidden');
            document.getElementById('formStep2').classList.remove('hidden');
            
            // Kunci input email agar tidak diubah user saat input OTP
            document.getElementById('resetEmailInput').disabled = true; 
            
            Swal.fire({
              icon: 'success',
              title: 'Kode Terkirim',
              text: 'Silakan cek email Anda (Inbox/Spam) untuk mendapatkan kode OTP.',
              timer: 3000
            });

          } else {
            // Error (Email tidak ada atau Limit harian habis)
            Swal.fire({
              icon: 'error',
              title: 'Gagal',
              html: res.message // Menggunakan HTML agar bold/br terbaca
            });
          }
        }).requestResetOtp(email);
      }

      // 2. Handle Konfirmasi Ganti Password (Step 2)
      function handleConfirmReset(e) {
        e.preventDefault();

        const p1 = document.getElementById('resetPassNew').value;
        const p2 = document.getElementById('resetPassConf').value;

        // --- VALIDASI BARU: PANJANG PASSWORD ---
        if (p1.length < 6) {
          Swal.fire('Password Terlalu Pendek', 'Password baru minimal harus 6 karakter.', 'warning');
          return;
        }

        // Validasi Kecocokan
        if (p1 !== p2) {
          Swal.fire('Password Tidak Cocok', 'Konfirmasi password baru tidak sama.', 'warning');
          return;
        }

        const formData = {
          email: document.getElementById('resetEmailInput').value,
          otp: document.getElementById('resetOtpInput').value,
          newPassword: p1
        };

        const btn = document.getElementById('btnConfirmReset');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memverifikasi...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (res.status === 'success') {
            Swal.fire({
              icon: 'success',
              title: 'Password Berhasil Diubah!',
              text: 'Silakan login menggunakan password baru Anda.',
              confirmButtonText: 'Login Sekarang'
            }).then(() => {
              resetViewReset(); 
              switchView('view-login');
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Gagal',
              text: res.message
            });
          }
        }).confirmResetOtp(formData);
      }

      // 3. Helper Reset Tampilan View Reset
      function resetViewReset() {
        document.getElementById('formStep1').reset();
        document.getElementById('formStep2').reset();
        
        document.getElementById('formStep1').classList.remove('hidden');
        document.getElementById('formStep2').classList.add('hidden');
        
        document.getElementById('resetEmailInput').disabled = false;
        switchView('view-login');
      }

      // --- [BARU] Fungsi Loncat ke Input OTP Manual ---
      function manualInputOtp() {
        const emailInput = document.getElementById('resetEmailInput');
        const emailVal = emailInput.value.trim();

        // 1. Validasi: User harus mengetik email dulu di Step 1
        // Karena saat verifikasi nanti, sistem butuh pasangan (Email + OTP)
        if (!emailVal) {
          Swal.fire({
            icon: 'warning',
            title: 'Email Diperlukan',
            text: 'Mohon ketik alamat Email Sekolah terlebih dahulu di kolom atas, lalu klik tombol ini lagi.',
            timer: 4000
          });
          emailInput.focus();
          return;
        }

        // 2. Jika email sudah diisi, kunci email dan pindah ke Step 2
        emailInput.disabled = true;
        
        document.getElementById('formStep1').classList.add('hidden');
        document.getElementById('formStep2').classList.remove('hidden');
        
        // Fokus ke input OTP
        document.getElementById('resetOtpInput').focus();
      }

      /* --- FUNGSI TOGGLE PASSWORD (MATA) --- */
      function togglePassword(inputId, iconSpan) {
        const input = document.getElementById(inputId);
        const icon = iconSpan.querySelector('i');
        
        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash'); // Ganti ikon jadi mata dicoret
        } else {
          input.type = "password";
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye'); // Kembali ke mata biasa
        }
      }

      // --- LOGIKA UBAH PASSWORD ---
      function submitUbahPassword(e) {
        e.preventDefault();

        const oldPass = document.getElementById('upOldPass').value;
        const newPass = document.getElementById('upNewPass').value;
        const confPass = document.getElementById('upConfPass').value;
        const email = localStorage.getItem('userEmail'); // Ambil email dari sesi login

        // 1. Validasi Kecocokan Password Baru
        if (newPass !== confPass) {
          Swal.fire('Password Tidak Cocok', 'Password baru dan konfirmasi harus sama.', 'warning');
          return;
        }

        // 2. Validasi Password Baru tidak boleh sama dengan Password Lama (Opsional tapi baik)
        if (oldPass === newPass) {
          Swal.fire('Password Sama', 'Password baru tidak boleh sama dengan password lama.', 'warning');
          return;
        }

        // 3. Proses Kirim ke Server
        const btn = document.getElementById('btnSubmitPass');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...';
        btn.disabled = true;

        const formData = {
          email: email,
          oldPass: oldPass,
          newPass: newPass
        };

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (res.status === 'success') {
              // Reset Form
              document.getElementById('formUbahPass').reset();
              
              Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: 'Password Anda telah diperbarui.',
                showConfirmButton: true
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Gagal',
                text: res.message
              });
            }
          })
          .changeUserPassword(formData);
      }

      document.getElementById('currentYear').innerText = new Date().getFullYear();

      // FIX: Mencegah loncat otomatis saat input di-tap di mobile
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', function(e) {
          // Mencegah browser melakukan scroll drastis
          // Biarkan keyboard muncul natural
          setTimeout(() => {
            // Opsional: Cek jika elemen tertutup keyboard baru scroll sedikit
          }, 300);
        }, { passive: true });
      });

      // FIX: Reset posisi scroll saat modal ditutup agar tidak loncat ke atas/bawah
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function () {
          // Kunci posisi body agar tidak loncat
          document.body.style.overflow = ''; 
        });
      });

      /* --- LOGIKA INFO REFERENSI URAIAN LENGKAP --- */

      function bukaModalReferensi() {
        const modal = new bootstrap.Modal(document.getElementById('modalReferensiUraian'));
        modal.show();

        // Reset Filter
        document.getElementById('refSearchInput').value = '';
        
        // Cek apakah data sudah ada di cacheRefUraian?
        // Karena cacheRefUraian di update sebelumnya sudah kita ubah strukturnya di Kode.gs,
        // kita perlu memuat ulang jika formatnya belum sesuai atau kosong.
        if (cacheRefLengkap.length === 0) {
          loadReferensiLengkapServer();
        } else {
          populasiFilterStandar(cacheRefLengkap);
          renderTabelRef(cacheRefLengkap);
        }
      }

      function loadReferensiLengkapServer() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('bodyTabelReferensi');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-info"></div><br>Mengambil Data Referensi...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            cacheRefLengkap = res.data;
            
            // Update juga cacheRefUraian global agar autocomplete di form input tetap jalan
            cacheRefUraian = res.data; 

            // --- TAMBAHAN PENTING: SIMPAN KE STORAGE ---
            saveCacheToLocal(); 
            // -------------------------------------------

            populasiFilterStandar(cacheRefLengkap);
            renderTabelRef(cacheRefLengkap);
          } else {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Gagal: ${res.message}</td></tr>`;
          }
        }).getReferensiUraianMaster(token);
      }

      function populasiFilterStandar(data) {
        const select = document.getElementById('refFilterStandar');
        const currentVal = select.value;
        
        // Ambil Data Unik Standar (Kolom C)
        // Gunakan Set untuk unique value
        const uniqueStandar = [...new Set(data.map(item => item.standar))].filter(s => s !== "").sort();

        let html = '<option value="">-- Semua Standar --</option>';
        uniqueStandar.forEach(s => {
          html += `<option value="${s}">${s}</option>`;
        });
        
        select.innerHTML = html;
        select.value = currentVal; // Restore value jika ada
      }

      function renderTabelRef(data) {
        const tbody = document.getElementById('bodyTabelReferensi');
        document.getElementById('refTotalData').innerText = data.length;
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Data tidak ditemukan.</td></tr>';
          return;
        }

        // Batasi render maksimal 100 baris awal agar browser tidak berat (karena data referensi bisa ribuan)
        // Data tetap bisa dicari via search box
        const limit = data.length > 200 ? 200 : data.length;
        let html = '';

        for(let i=0; i<limit; i++) {
          const item = data[i];
          
          // Escape quote untuk fungsi onclick
          const uraianSafe = String(item.uraian).replace(/"/g, '&quot;').replace(/'/g, "\\'");
          const kodeSafe = String(item.kode).replace(/"/g, '&quot;').replace(/'/g, "\\'");

          html += `
            <tr>
              <td>${item.standar}</td>
              <td>${item.kegiatan}</td>
              <td class="text-center"><span class="badge bg-light text-dark border font-monospace">${item.kode}</span></td>
              <td class="fw-bold text-primary">${item.uraian}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-success" onclick="pilihDariReferensi('${uraianSafe}', '${kodeSafe}')" title="Gunakan Data Ini">
                  <i class="fas fa-plus"></i> Tambah
                </button>
              </td>
            </tr>
          `;
        }

        if (data.length > 200) {
          html += `<tr><td colspan="5" class="text-center text-muted fst-italic bg-light">... Menampilkan 200 data pertama. Gunakan pencarian untuk hasil spesifik ...</td></tr>`;
        }
        
        tbody.innerHTML = html;
      }

      function filterTabelReferensi() {
        const filterStd = document.getElementById('refFilterStandar').value.toLowerCase();
        const keyword = document.getElementById('refSearchInput').value.toLowerCase();
        
        const filtered = cacheRefLengkap.filter(item => {
          const matchStd = (filterStd === "") || item.standar.toLowerCase() === filterStd;
          
          // Cari di semua kolom
          const matchKey = (keyword === "") || 
                          item.uraian.toLowerCase().includes(keyword) || 
                          item.kode.toLowerCase().includes(keyword) || 
                          item.kegiatan.toLowerCase().includes(keyword);

          return matchStd && matchKey;
        });

        renderTabelRef(filtered);
      }

      function pilihDariReferensi(uraian, kode) {
        // 1. Tutup Modal
        const modalEl = document.getElementById('modalReferensiUraian');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if(modalInstance) modalInstance.hide();

        // 2. Isi Form Tambah Uraian
        document.getElementById('urNama').value = uraian;
        // Jika Anda ingin mengisi No Bukti dengan Kode Kegiatan, uncomment baris ini:
        // document.getElementById('urNoBukti').value = kode;

        // 3. Scroll ke Form agar user sadar data sudah masuk
        setTimeout(() => {
          document.getElementById('formUraian').scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Beri efek highlight/fokus
          document.getElementById('urNama').focus();
          Swal.fire({
            toast: true, position: 'top-end', icon: 'success', 
            title: 'Data disalin ke form', showConfirmButton: false, timer: 1500
          });
        }, 300);
      }

      /* --- LOGIKA INFO BARANG DENGAN PAGINASI --- */

      // Variabel Global untuk Paginasi Barang
      let cacheDataBarangLengkap = []; // Menyimpan SEMUA data dari server
      let filteredBarangList = [];     // Menyimpan data hasil pencarian
      let currentPageBarang = 1;       // Halaman saat ini
      const ITEMS_PER_PAGE = 30;       // Batas baris per halaman

      // Cari fungsi ini di Index.html
      function bukaModalBarang() {
        const modal = new bootstrap.Modal(document.getElementById('modalInfoBarang'));
        modal.show();

        document.getElementById('cariBarangInput').value = '';
        
        // Reset Paginasi
        currentPageBarang = 1;
        
        // --- PERBAIKAN DISINI ---
        // Cek apakah cacheDataBarangLengkap sudah terisi (dari LocalStorage saat login)?
        if (cacheDataBarangLengkap.length === 0) {
          // Jika kosong, baru ambil dari server
          loadInfoBarangFromServer();
        } else {
          // Jika sudah ada, gunakan data cache tanpa loading
          console.log("Menggunakan data Barang dari Cache.");
          
          // Penting: Reset filtered list ke data penuh sebelum render
          filteredBarangList = [...cacheDataBarangLengkap];
          
          renderTabelBarang();
        }
      }

      function loadInfoBarangFromServer() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('bodyInfoBarang');
        const paginasiEl = document.getElementById('paginationContainer');
        
        // Sembunyikan navigasi saat loading
        paginasiEl.classList.add('hidden');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-warning" role="status"></div><br>Mengambil data barang...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // 1. Simpan Data Mentah ke Cache
            cacheDataBarangLengkap = res.data;
            
            // 2. Set Data Filtered
            filteredBarangList = [...cacheDataBarangLengkap];

            // --- PASTIKAN BARIS INI ADA ---
            saveCacheToLocal(); 
            // ------------------------------
            
            renderTabelBarang();
            
          } else {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Gagal: ${res.message}</td></tr>`;
          }
        }).getReferensiBarangLengkap(token);
      }

      // --- UPDATE FUNGSI RENDER TABEL BARANG ---
      function renderTabelBarang() {
        const tbody = document.getElementById('bodyInfoBarang');
        const paginasiEl = document.getElementById('paginationContainer');
        
        tbody.innerHTML = '';

        if (filteredBarangList.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Data tidak ditemukan.</td></tr>';
          paginasiEl.classList.add('hidden');
          return;
        }

        // Logika Paginasi
        const totalItems = filteredBarangList.length;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        
        if (currentPageBarang > totalPages) currentPageBarang = 1;
        if (currentPageBarang < 1) currentPageBarang = 1;

        const startIndex = (currentPageBarang - 1) * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);
        const pageData = filteredBarangList.slice(startIndex, endIndex);

        // Render Baris
        pageData.forEach((item, index) => {
          // Generate ID Unik untuk DOM
          // Kita gunakan kombinasi timestamp + index loop agar benar-benar unik
          const uniqueKey = Date.now() + "_" + index; 
          const domId = `row-brg-${uniqueKey}`;

          const safeNama = escapeJsAttribute(item.nama);
          const safeSat = escapeJsAttribute(item.satuan);
          const hargaTampil = formatRupiahJS(item.harga);
          
          // 1. HARGA VIEW (Tampilan Biasa)
          const viewHarga = `
            <div id="view-harga-${domId}" class="d-flex justify-content-between align-items-center">
              <span class="fw-bold text-success text-truncate">${hargaTampil}</span>
              <i class="fas fa-pencil-alt text-muted cursor-pointer ms-2" onclick="enableEditHarga('${domId}', '${safeNama}', ${item.harga})" title="Edit Harga"></i>
            </div>
          `;

          // 2. HARGA EDIT (Input Form)
          // Input dibuat width 100% agar memenuhi kolom yang sudah diperlebar
          const editHarga = `
            <div id="edit-harga-${domId}" class="input-group input-group-sm hidden" style="width: 100%;">
              <input type="text" class="form-control form-control-sm px-1" value="${formatRibuanInput(item.harga)}" id="input-harga-${domId}" style="min-width: 80px;">
              <button class="btn btn-success px-2" onclick="saveEditHarga('${domId}', '${safeNama}')"><i class="fas fa-check"></i></button>
              <button class="btn btn-secondary px-2" onclick="cancelEditHarga('${domId}')"><i class="fas fa-times"></i></button>
            </div>
          `;

          const btnTambah = `
            <button class="btn btn-sm btn-primary w-100" onclick="pilihDariInfoBarang('${safeNama}', '${safeSat}', ${item.harga})">
              <i class="fas fa-plus"></i>
            </button>
          `;

          // --- STRUKTUR KOLOM DENGAN SCROLL ---
          const row = `
            <tr>
              <td class="text-start">
                <div class="cell-scroll" style="width: 100%;">
                  <span class="badge bg-light text-dark border">${item.katKode}</span>
                </div>
              </td>

              <td class="small">${item.katNama}</td>

              <td>
                <div class="cell-scroll fw-bold" style="width: 100%;">
                  ${item.nama}
                </div>
              </td>

              <td class="text-center small">${item.satuan}</td>

              <td>${viewHarga} ${editHarga}</td>

              <td class="text-center">${btnTambah}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });

        // Update Info Paginasi
        paginasiEl.classList.remove('hidden');
        document.getElementById('lblStart').innerText = startIndex + 1;
        document.getElementById('lblEnd').innerText = endIndex;
        document.getElementById('lblTotal').innerText = totalItems;
        document.getElementById('lblPageIndicator').innerText = `Hal ${currentPageBarang} / ${totalPages}`;

        document.getElementById('btnPrevPage').disabled = (currentPageBarang === 1);
        document.getElementById('btnNextPage').disabled = (currentPageBarang === totalPages);
      }

      // Fungsi Ganti Halaman
      function gantiHalaman(direction) {
        currentPageBarang += direction;
        renderTabelBarang(); // Render ulang dengan page baru
        
        // Scroll tabel ke atas sedikit agar nyaman
        document.querySelector('.table-responsive').scrollTop = 0;
      }

      // Fungsi Pencarian (Reset ke Halaman 1)
      function filterInfoBarang() {
        const keyword = document.getElementById('cariBarangInput').value.toLowerCase();
        
        // Filter dari Cache Master
        filteredBarangList = cacheDataBarangLengkap.filter(item => {
            return String(item.nama).toLowerCase().includes(keyword) ||
                  String(item.katNama).toLowerCase().includes(keyword) ||
                  String(item.katKode).toLowerCase().includes(keyword) ||
                  String(item.harga).includes(keyword);
        });

        // Reset ke halaman 1 setiap kali mencari
        currentPageBarang = 1;
        
        renderTabelBarang();
      }

      // --- LOGIKA EDIT HARGA (Disesuaikan dengan DOM ID baru) ---
      function enableEditHarga(domId, nama, hargaAsli) {
        document.getElementById(`view-harga-${domId}`).classList.add('hidden');
        document.getElementById(`edit-harga-${domId}`).classList.remove('hidden');
        
        const input = document.getElementById(`input-harga-${domId}`);
        input.focus();
        input.oninput = function() { this.value = formatRibuanInput(this.value); };
      }

      function cancelEditHarga(domId) {
        document.getElementById(`view-harga-${domId}`).classList.remove('hidden');
        document.getElementById(`edit-harga-${domId}`).classList.add('hidden');
      }

      function saveEditHarga(domId, namaBarang) {
        const token = localStorage.getItem('userToken');
        const inputVal = document.getElementById(`input-harga-${domId}`).value;
        const hargaBaru = cleanRibuan(inputVal);

        // Loading button
        const btn = document.querySelector(`#edit-harga-${domId} .btn-success`);
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // 1. Update di Cache Master (Memory)
            const itemMaster = cacheDataBarangLengkap.find(x => x.nama === namaBarang);
            if(itemMaster) itemMaster.harga = hargaBaru;

            // 2. Update di Filtered List
            const itemFiltered = filteredBarangList.find(x => x.nama === namaBarang);
            if(itemFiltered) itemFiltered.harga = hargaBaru;

            // --- TAMBAHAN BARU: Update Cache LocalStorage ---
            // Karena cacheDataBarangLengkap di memory sudah diupdate di langkah 1,
            // kita tinggal panggil saveCacheToLocal() untuk menimpa data lama di storage.
            saveCacheToLocal();
            // ------------------------------------------------

            renderTabelBarang();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Harga disimpan', showConfirmButton: false, timer: 1500 });
          } else {
            Swal.fire('Gagal', res.message, 'error');
            // Kembalikan tombol jika gagal
            btn.innerHTML = originalHtml;
            btn.disabled = false;
          }
        }).updateHargaReferensi(token, namaBarang, hargaBaru);
      }

      // --- FUNGSI KLIK TOMBOL 'TAMBAH' DARI POPUP INFO BARANG ---
      function pilihDariInfoBarang(nama, satuan, harga) {
        // 1. Deteksi Tab mana yang sedang aktif (Toko atau Tukang)
        // Default ke toko
        let activeTab = 'toko'; 
        
        // Cek jika tombol tab tukang punya class 'active'
        const tabTukang = document.getElementById('tab-btn-tukang');
        if (tabTukang && tabTukang.classList.contains('active')) {
          activeTab = 'tukang';
        }

        // 2. Panggil fungsi helper untuk memasukkan data
        insertBarangToForm(activeTab, nama, satuan, harga);

        // 3. Tutup Modal
        const modalEl = document.getElementById('modalInfoBarang');
        if (modalEl) {
          const modalInstance = bootstrap.Modal.getInstance(modalEl);
          if(modalInstance) modalInstance.hide();
        }
        
        // 4. Notifikasi
        Swal.fire({ 
          toast: true, 
          position: 'top-end', 
          icon: 'success', 
          title: 'Item ditambahkan', 
          showConfirmButton: false, 
          timer: 1500 
        });
      }

      // --- FUNGSI HELPER: MASUKKAN DATA KE BARIS KOSONG ---
      function insertBarangToForm(tipe, nama, satuan, harga) {
        // Tentukan tabel target
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 'tabelItemTukang';
        const tbody = document.getElementById(tableId).querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');

        let targetRow = null;
        
        // 1. Cari baris paling bawah. Jika Nama Barangnya kosong, pakai baris itu.
        if (rows.length > 0) {
          const lastRow = rows[rows.length - 1];
          const inputNama = lastRow.querySelector('.item-nama');
          if (inputNama && inputNama.value.trim() === '') {
            targetRow = lastRow;
          }
        }

        // 2. Jika tidak ada baris kosong, buat baris baru
        if (!targetRow) {
          tambahBaris(tipe); // Memanggil fungsi tambahBaris bawaan yang sudah ada
          const newRows = tbody.querySelectorAll('tr');
          targetRow = newRows[newRows.length - 1];
        }

        // 3. Isi Data ke Input
        if (targetRow) {
          const inputNama = targetRow.querySelector('.item-nama');
          const inputSat = targetRow.querySelector('.item-sat');
          const inputHarga = targetRow.querySelector('.item-harga');

          // Decode karakter aneh jika ada (unescape)
          if (inputNama) inputNama.value = unescapeHtml(nama);
          if (inputSat) inputSat.value = unescapeHtml(satuan);
          
          // PENTING: Isi Harga dan Hitung
          if (inputHarga) {
            inputHarga.value = formatRibuanInput(harga); // Format jadi 10.000
            hitungBaris(inputHarga, tipe); // Trigger hitung total otomatis
          }

          // Efek kedip kuning
          targetRow.classList.add('table-warning');
          setTimeout(() => targetRow.classList.remove('table-warning'), 500);
        }
      }

      /* --- MANAJEMEN CACHE LOKAL (PERSISTENT) --- */
      const CACHE_STORAGE_KEY = 'APP_LPJ_CACHE_V1';

      // 1. Simpan Memory ke LocalStorage
      function saveCacheToLocal() {
        // Sinkronkan variabel terpisah ke dalam objek DATA_CACHE utama agar tersimpan semua
        DATA_CACHE.ref_barang = cacheDataBarangLengkap;
        DATA_CACHE.ref_satuan = cacheDataSatuanLengkap;
        DATA_CACHE.ref_uraian = cacheRefLengkap; // Referensi Master Uraian
        DATA_CACHE.ref_guru   = cacheDataGuru;
        
        // Simpan ke penyimpanan browser
        localStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify(DATA_CACHE));
      }

      // 2. Ambil dari LocalStorage ke Memory (Saat Refresh)
      function loadCacheFromLocal() {
        const saved = localStorage.getItem(CACHE_STORAGE_KEY);
        
        if (saved) {
          try {
            // 1. Restore objek utama DATA_CACHE
            DATA_CACHE = JSON.parse(saved);

            // 2. Restore variabel global terpisah agar fitur pencarian/modal berfungsi normal
            
            // Restore Info Barang (Modal Barang)
            if (DATA_CACHE.ref_barang && Array.isArray(DATA_CACHE.ref_barang)) {
                cacheDataBarangLengkap = DATA_CACHE.ref_barang;
            }

            // Restore Info Satuan (Modal Satuan)
            if (DATA_CACHE.ref_satuan && Array.isArray(DATA_CACHE.ref_satuan)) {
                cacheDataSatuanLengkap = DATA_CACHE.ref_satuan;
            }

            // Restore Info Referensi Uraian (Modal Referensi)
            if (DATA_CACHE.ref_uraian && Array.isArray(DATA_CACHE.ref_uraian)) {
                cacheRefLengkap = DATA_CACHE.ref_uraian;
                cacheRefUraian = DATA_CACHE.ref_uraian; // Sinkronkan kedua variabel ini
            }

            // Restore Data Guru (Untuk Dropdown Input Transaksi)
            if (DATA_CACHE.ref_guru && Array.isArray(DATA_CACHE.ref_guru)) {
                cacheDataGuru = DATA_CACHE.ref_guru;
            }
            
            console.log("Cache Lokal berhasil dimuat dari LocalStorage.");
            
          } catch (e) {
            console.error("Gagal memuat cache lokal:", e);
            localStorage.removeItem(CACHE_STORAGE_KEY); // Hapus cache jika korup/error
          }
        }
      }

      // 3. Hapus Cache (Saat Logout)
      function clearLocalCache() {
        localStorage.removeItem(CACHE_STORAGE_KEY);
        // Reset variabel global
        DATA_CACHE = {
              toko: null, tukang: null, guru: null, uraian: null, satuan: null,
              transaksi_toko: null, transaksi_tukang: null, transaksi_guru: null,
              sekolah: null, template_settings: null, dashboard: null
        };
        cacheDataBarangLengkap = [];
        cacheDataSatuanLengkap = [];
        cacheRefLengkap = [];
        cacheDataGuru = [];
      }

      /* --- LOGIC CETAK PENDUKUNG --- */

      let currentCoverLogo = "https://i.imgur.com/WqGSzFl.png"; 

      // 1. Tab Switching
      function bukaSubTab(tabName) {
        document.getElementById('tab-sub-sampul').classList.remove('active');
        document.getElementById('tab-sub-pengantar').classList.remove('active');
        document.getElementById('tab-sub-verifikasi').classList.remove('active');
        
        document.getElementById('view-sub-sampul').classList.add('hidden');
        document.getElementById('view-sub-pengantar').classList.add('hidden');
        document.getElementById('view-sub-verifikasi').classList.add('hidden');
        
        document.getElementById('tab-sub-' + tabName).classList.add('active');
        document.getElementById('view-sub-' + tabName).classList.remove('hidden');
        
        if(tabName === 'sampul') initCoverData();
        if(tabName === 'pengantar') initPengantarData();
        if(tabName === 'verifikasi') initVerifikasiData();
      }

      // 2. Inisialisasi Data (Load dari Server) - VERSI PERBAIKAN
      function initCoverData() {
        const token = localStorage.getItem('userToken');
        
        // Fungsi internal: Ambil settingan Header/Judul/Logo Cover setelah data sekolah siap
        const fetchCoverSettings = () => {
            const d = DATA_CACHE.sekolah || {}; // Data sekolah pasti sudah ada sekarang
            
            document.getElementById('inpHeaderCover').placeholder = "Memuat...";
            
            google.script.run.withSuccessHandler(function(res) {
              if(res.status === 'success') {
                const s = res.data;
                
                // Load Teks Tersimpan
                if(s.headerText) document.getElementById('inpHeaderCover').value = s.headerText;
                if(s.titleText)  document.getElementById('inpJudulCover').value = s.titleText;
                
                // Load Periode (Logika Prioritas: DB > Rumus Default)
                if(s.periodText && s.periodText !== "") {
                  document.getElementById('inpPeriodeCover').value = s.periodText;
                } else {
                  // Fallback ke default jika belum pernah diset manual
                  const defaultPeriod = d.periodeAnggaran ? `(${d.periodeAnggaran} ${d.tahunAnggaran || ''})` : "(Tahun Anggaran " + new Date().getFullYear() + ")";
                  document.getElementById('inpPeriodeCover').value = defaultPeriod;
                }
                
                // Load Logo
                if(s.logoId) {
                  currentCoverLogo = "https://drive.google.com/thumbnail?id=" + s.logoId + "&sz=w600"; 
                }
                
                document.getElementById('logoPreviewForm').src = currentCoverLogo;
                updatePreviewSampul(); // Render ulang tampilan akhir
              }
            }).getCoverSettings(token);
        };

        // --- LOGIKA UTAMA PERBAIKAN ---
        // Cek apakah Data Sekolah sudah ada di Cache?
        if (!DATA_CACHE.sekolah) {
            // Jika KOSONG (User langsung masuk menu ini setelah login), ambil dulu dari server!
            toggleLoading(true, "Menyiapkan Data...");
            
            google.script.run.withSuccessHandler(function(res) {
                toggleLoading(false);
                if (res.status === 'success') {
                    DATA_CACHE.sekolah = res.data; // Simpan ke Global Cache
                    
                    // Render awal segera setelah data sekolah didapat
                    updatePreviewSampul(); 
                    
                    // Lanjut ambil detail setting cover
                    fetchCoverSettings();
                }
            }).getDataSekolah(token);
        } else {
            // Jika SUDAH ADA (User dari menu lain), langsung render & ambil setting
            updatePreviewSampul(); 
            fetchCoverSettings();
        }
      }

      // Preview Logo Lokal
      function previewLogoLocal(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            currentCoverLogo = e.target.result;
            document.getElementById('logoPreviewForm').src = currentCoverLogo;
            updatePreviewSampul();
          }
          reader.readAsDataURL(input.files[0]);
        }
      }

      // 3. RENDER HTML (UPDATED STRUCTURE)
      function updatePreviewSampul() {
        const sheet = document.getElementById('print-area');
        // Ambil dari cache, atau objek kosong jika belum siap
        const d = DATA_CACHE.sekolah || {}; 
        
        // Ambil Value Input
        const headerText = document.getElementById('inpHeaderCover').value || "KEMENTERIAN AGAMA";
        const judul = document.getElementById('inpJudulCover').value || "LAPORAN PENGGUNAAN DANA BOS";
        const periode = document.getElementById('inpPeriodeCover').value; // Value ini akan diisi otomatis oleh initCoverData
        
        // Ambil elemen radio button yang terpilih
        const selectedDesign = document.querySelector('input[name="desainSampul"]:checked');
        const design = selectedDesign ? selectedDesign.value : 'design-v1';
        
        // Identitas Sekolah (Fallback ke teks default jika data belum loading)
        const namaSekolah = d.namaSekolah || "NAMA SEKOLAH";
        const tahun = d.tahunAnggaran || new Date().getFullYear();
        let kota = "KOTA/KABUPATEN";
        
        if (d.kabupaten) {
            kota = d.kabupaten.toUpperCase().replace("KAB. ", "").replace("KOTA ", "");
        }
        
        // Set Class Desain pada Parent
        sheet.className = "sheet " + design;
        sheet.innerHTML = "";

        // --- STRUKTUR KONTEN BERDASARKAN DESAIN ---

        if (design === 'design-v2') {
          // V2: Bar Hijau Atas Bawah
          sheet.innerHTML = `
              <div class="design-v2" style="height:100%; width:100%; display:flex; flex-direction:column;">
                  <div class="bar-header"></div>
                  <div class="cover-layout-wrapper">
                      <div class="section-top">
                          <div class="txt-instansi text-muted">${headerText}</div>
                          <div class="txt-title">${judul}</div>
                          <div class="txt-period text-muted">${periode}</div>
                      </div>
                      <div class="section-middle">
                          <img src="${currentCoverLogo}" class="img-logo">
                      </div>
                      <div class="section-bottom">
                          <div class="txt-school text-success">${namaSekolah}</div>
                          <div class="txt-year text-muted">TAHUN ${tahun}</div>
                          <div class="txt-city text-muted">${kota}</div>
                      </div>
                  </div>
                  <div class="bar-footer"></div>
              </div>
          `;
        } 
        else if (design === 'design-v4') {
          // V4: Formal (Garis Kop)
          sheet.innerHTML = `
              <div class="cover-layout-wrapper">
                  <div class="section-top">
                      <div class="txt-instansi text-dark" style="margin-bottom:5px;">${headerText}</div>
                      <div class="txt-title">${judul}</div>
                      <div class="txt-period" style="font-style:italic;">${periode}</div>
                  </div>
                  <div class="section-middle">
                      <img src="${currentCoverLogo}" class="img-logo">
                  </div>
                  <div class="section-bottom">
                      <div class="txt-school">${namaSekolah}</div>
                      <div class="txt-year">TAHUN ${tahun}</div>
                      <div class="txt-city">${kota}</div>
                  </div>
              </div>
          `;
        }
        else {
          // V1 (Klasik), V3 (Minimalis), V5 (Kreatif)
          let htmlInstansi = `<div class="txt-instansi">${headerText}</div>`;
          let headerInstansi = "";
          
          if (design === 'design-v3') {
              htmlInstansi = ""; 
              headerInstansi = `<div class="txt-instansi" style="color:#777; margin-bottom:15px;">${headerText}</div>`; 
          }

          sheet.innerHTML = `
              <div class="cover-layout-wrapper">
                  <div class="section-top">
                      ${headerInstansi}
                      <div class="txt-title">${judul}</div>
                      <div class="txt-period">${periode}</div>
                  </div>
                  <div class="section-middle">
                      <img src="${currentCoverLogo}" class="img-logo">
                  </div>
                  <div class="section-bottom">
                      ${htmlInstansi}
                      <div class="txt-school">${namaSekolah}</div>
                      <div class="txt-year">TAHUN ${tahun}</div>
                      <div class="txt-city">${kota}</div>
                  </div>
              </div>
          `;
        }
      }

      // 4. Simpan Konfigurasi ke Server (Header, Title, Period, Logo)
      function simpanKonfigurasiSampul() {
        const token = localStorage.getItem('userToken');
        const btn = document.getElementById('btnSimpanCover');
        const fileInput = document.getElementById('fileLogoSampul');
        
        // Ambil Data Teks
        const configData = {
          header: document.getElementById('inpHeaderCover').value,
          title: document.getElementById('inpJudulCover').value,
          period: document.getElementById('inpPeriodeCover').value
        };

        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        // Helper Simpan Teks
        const saveDetails = () => {
          google.script.run.withSuccessHandler(function() {
            btn.innerHTML = originalText;
            btn.disabled = false;
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: 'Pengaturan Sampul Tersimpan', showConfirmButton: false, timer: 1500
            });
          }).simpanDetailSampul(token, configData);
        };

        // Cek Upload File
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = function() {
            const rawBase64 = reader.result.split(',')[1]; 
            const payload = { base64: rawBase64, mimeType: file.type };
            
            google.script.run.withSuccessHandler(function(res) {
              if(res.status === 'success') {
                  currentCoverLogo = "https://drive.google.com/thumbnail?id=" + res.fileId + "&sz=w600";
                  saveDetails(); // Lanjut simpan teks
              } else {
                  btn.innerHTML = originalText;
                  btn.disabled = false;
                  Swal.fire('Gagal Upload', res.message, 'error');
              }
            }).simpanLogoSampul(token, payload);
          };
        } else {
          saveDetails(); // Hanya simpan teks
        }
      }

      function cetakHalamanIni() {
        window.print();
      }

      /* --- LOGIKA SURAT PENGANTAR (DATABASE VERSION) --- */

      function initPengantarData() {
        const d = DATA_CACHE.sekolah || {};
        const token = localStorage.getItem('userToken');
        
        // 1. Ambil Kop Surat (Tampilan)
        const imgKop = document.getElementById('spKopImage');
        const txtKop = document.getElementById('spKopText');
        imgKop.style.display = 'none';
        txtKop.style.display = 'block';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success' && res.fileId) {
            const imageUrl = "https://drive.google.com/thumbnail?id=" + res.fileId + "&sz=w1000";
            imgKop.src = imageUrl;
            imgKop.style.display = 'block';
            txtKop.style.display = 'none';
          }
        }).getKopSurat(token);

        // 2. LOAD DATA DARI DATABASE (SERVER)
        // Kita beri placeholder loading dulu
        document.getElementById('spNomor').placeholder = "Memuat dari database...";
        
        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            const db = res.data;
            
            // --- LOGIKA PRIORITAS: DATABASE > DEFAULT ---
            
            // A. NOMOR SURAT
            if (db.nomor && db.nomor !== "") {
               document.getElementById('spNomor').value = db.nomor;
            } else {
               document.getElementById('spNomor').value = ""; // Biarkan placeholder muncul
               document.getElementById('spNomor').placeholder = "Contoh: 001/MTs.../...";
            }

            // B. TEMPAT TTD
            if (db.tempat && db.tempat !== "") {
               document.getElementById('spTempat').value = db.tempat;
            } else {
               // Default: Ambil dari Data Sekolah
               let kota = (d.kabupaten || "Bulukumba").replace(/KAB\.\s*|KOTA\s*/gi, ""); 
               kota = kota.toLowerCase().replace(/\b\w/g, s => s.toUpperCase());
               document.getElementById('spTempat').value = kota;
            }

            // C. TANGGAL TTD
            if (db.tanggal && db.tanggal !== "") {
               document.getElementById('spTanggal').value = db.tanggal;
            } else {
               // Default: Hari ini
               document.getElementById('spTanggal').valueAsDate = new Date();
            }

            // Render Preview setelah data terisi
            updatePreviewPengantar();
          }
        }).getDataSuratPengantar(token);
      }

      // Fungsi Baru: Simpan ke Database saat tombol diklik
      function simpanPengantarDatabase() {
        const token = localStorage.getItem('userToken');
        
        const form = {
          nomor: document.getElementById('spNomor').value,
          tempat: document.getElementById('spTempat').value,
          tanggal: document.getElementById('spTanggal').value
        };

        // Ubah tombol jadi loading
        const btn = document.querySelector('button[onclick="simpanPengantarDatabase()"]');
        const textAsli = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Menyimpan...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = textAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: 'Tersimpan di Database', showConfirmButton: false, timer: 2000
            });
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).simpanDataSuratPengantar(token, form);
      }

      function updatePreviewPengantar() {
        const d = DATA_CACHE.sekolah || {};

        // --- BAGIAN DINAMIS (Data Sekolah) ---
        let kabBersih = (d.kabupaten || "...").replace(/KAB\.\s*|KOTA\s*/gi, "");
        kabBersih = kabBersih.toLowerCase().replace(/\b\w/g, s => s.toUpperCase());

        document.querySelectorAll('.dyn-kabupaten').forEach(el => {
            el.innerText = kabBersih;
        });

        document.getElementById('prevSpNamaSekolah').innerText = d.namaSekolah || "...";
        document.getElementById('prevSpKelurahan').innerText = d.kelurahan || "..."; 
        document.getElementById('prevSpKecamatan').innerText = d.kecamatan || "...";
        document.getElementById('prevSpKepala').innerText = d.namaKepala || "KEPALA MADRASAH";
        document.getElementById('prevSpNip').innerText = d.nipKepala || "-";

        // --- BAGIAN MANUAL (Input User) ---
        const valNomor = document.getElementById('spNomor').value;
        const valTempat = document.getElementById('spTempat').value;
        const valTanggal = document.getElementById('spTanggal').value;

        // 1. Update Preview
        document.getElementById('prevSpNomor').innerText = valNomor || "xxxx.xxxx.xxx";
        document.getElementById('prevSpTempat').innerText = valTempat;

        let tglIndo = valTanggal;
        if(valTanggal) {
           const dateObj = new Date(valTanggal);
           const bln = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
           tglIndo = dateObj.getDate() + " " + bln[dateObj.getMonth()] + " " + dateObj.getFullYear();
        }
        document.getElementById('prevSpTanggal').innerText = tglIndo;
      }

      // Variabel Global untuk menyimpan state tabel
      let currentVerifRows = []; 

      // Data Default (Hanya dipakai jika Database Kosong)
      const DEFAULT_VERIF_ROWS = [
        "Kover", "Check List", "Surat Pengantar", "Surat Pernyataan Pertanggungjawaban",
        "Formulir BOS - 02", "Formulir BOS-02 (Lampiran)", "Formulir BOS - 03",
        "Formulir BOS - 04", "Formulir BOS - 06", "Formulir BOS - 07",
        "Formulir BOS - 08", "Formulir BOS - 09", "Formulir BOS - 10",
        "Formulir BOS - 11", "Formulir BOS K - 02", "Formulir BOS K - 03",
        "Formulir BOS K - 04", "Formulir BOS K - 05",
        "Rincian Kegiatan Anggaran Madrasah", "Nota/Kuitansi/Data Pendukung"
      ];

      // 1. Inisialisasi Data (Dipanggil saat tab diklik)
      function initVerifikasiData() {
        // A. Isi Header Sekolah (Dari Cache Global)
        const d = DATA_CACHE.sekolah || {};
        document.getElementById('vfSchoolName').innerText = d.namaSekolah || "...";
        document.getElementById('vfNsm').innerText = d.nsm || "...";
        
        let alamatLengkap = d.alamat || "";
        if(d.kelurahan) alamatLengkap += ", " + d.kelurahan;
        document.getElementById('vfAddress').innerText = alamatLengkap;
        
        document.getElementById('vfKecamatan').innerText = d.kecamatan || "...";
        document.getElementById('vfKabupaten').innerText = d.kabupaten || "...";
        document.getElementById('vfPeriode').innerText = d.periodeAnggaran || "...";
        document.getElementById('vfTahun').innerText = d.tahunAnggaran || new Date().getFullYear();
        document.getElementById('vfTitleTahun').innerText = d.tahunAnggaran || new Date().getFullYear();

        // Preview TTD Kepala Sekolah
        document.getElementById('prevVfKepala').innerText = d.namaKepala || "...";
        const nipK = d.nipKepala ? "NIP. " + d.nipKepala : "";
        document.getElementById('prevVfNipKepala').innerText = nipK;

        // B. Ambil Data Verifikasi Tersimpan (Pejabat & Tabel Custom)
        const token = localStorage.getItem('userToken');
        google.script.run.withSuccessHandler(function(res) {
          if(res.status === 'success' && res.data) {
            const db = res.data;
            
            // Isi Input Form
            document.getElementById('vfNama1').value = db.verifikator1?.nama || '';
            document.getElementById('vfNip1').value = db.verifikator1?.nip || '';
            
            document.getElementById('vfNama2').value = db.verifikator2?.nama || '';
            document.getElementById('vfNip2').value = db.verifikator2?.nip || '';
            
            document.getElementById('vfNamaPengawas').value = db.pengawas?.nama || '';
            document.getElementById('vfNipPengawas').value = db.pengawas?.nip || '';

            // Isi Tabel Custom (Jika ada)
            if(db.rows && Array.isArray(db.rows) && db.rows.length > 0) {
              currentVerifRows = db.rows;
            } else {
              currentVerifRows = [...DEFAULT_VERIF_ROWS];
            }
          } else {
            // Jika belum ada data, reset ke default
            currentVerifRows = [...DEFAULT_VERIF_ROWS];
          }
          
          // Render
          updateVerifPreview();
          renderTabelVerifikasi();

        }).getDataVerifikasi(token);

        // Tambahkan listener untuk update preview TTD saat mengetik
        const inputs = document.querySelectorAll('#formVerifikasiInput input');
        inputs.forEach(el => {
          el.addEventListener('input', updateVerifPreview);
        });
      }

      // 2. Update Teks Tanda Tangan (Realtime) - FINAL
      function updateVerifPreview() {
        // Helper Nama: Jika kosong, isi spasi (&nbsp;) agar garis border tetap muncul
        const fmtNama = (val) => (val && val.trim() !== "") ? val : "&nbsp;";
        
        // Helper NIP: Jika kosong, tampilkan "NIP." saja
        const fmtNip = (val) => (val && val.trim() !== "") ? "NIP. " + val : "NIP.";

        // --- UPDATE ELEMEN HTML ---

        // 1. Verifikator I
        const n1 = document.getElementById('vfNama1').value;
        const nip1 = document.getElementById('vfNip1').value;
        document.getElementById('prevVfNama1').innerHTML = fmtNama(n1); // Pakai innerHTML untuk &nbsp;
        document.getElementById('prevVfNip1').innerText = fmtNip(nip1);

        // 2. Verifikator II
        const n2 = document.getElementById('vfNama2').value;
        const nip2 = document.getElementById('vfNip2').value;
        document.getElementById('prevVfNama2').innerHTML = fmtNama(n2);
        document.getElementById('prevVfNip2').innerText = fmtNip(nip2);

        // 3. Pengawas Madrasah
        const np = document.getElementById('vfNamaPengawas').value;
        const nipp = document.getElementById('vfNipPengawas').value;
        document.getElementById('prevVfPengawas').innerHTML = fmtNama(np);
        document.getElementById('prevVfNipPengawas').innerText = fmtNip(nipp);
        
        // 4. Kepala Madrasah (Data dari Cache Data Sekolah)
        // Ambil data sekolah dari cache global (jika ada)
        const d = (typeof DATA_CACHE !== 'undefined' && DATA_CACHE.sekolah) ? DATA_CACHE.sekolah : {};
        document.getElementById('prevVfKepala').innerHTML = fmtNama(d.namaKepala);
        document.getElementById('prevVfNipKepala').innerText = fmtNip(d.nipKepala);
      }

      // 3. Render Tabel dengan Logika Tombol Aksi Spesifik
      // Fungsi Render Tabel (Update UI)
      function renderTabelVerifikasi() {
        const tbody = document.getElementById('bodyTabelVerif');
        tbody.innerHTML = '';

        currentVerifRows.forEach((itemText, index) => {
          const isLastRow = (index === currentVerifRows.length - 1);
          
          // Logika Tombol Sesuai Request:
          // Baris Akhir = Tombol Tambah (+)
          // Baris Lain = Tombol Hapus (-)
          
          let btnHtml = '';
          if (isLastRow) {
            btnHtml = `<button type="button" class="btn btn-sm btn-success px-2 py-0" onclick="tambahBarisVerif()" title="Tambah Baris"><i class="fas fa-plus"></i></button>`;
          } else {
            btnHtml = `<button type="button" class="btn btn-sm btn-danger px-2 py-0" onclick="hapusBarisVerif(${index})" title="Hapus Baris"><i class="fas fa-minus"></i></button>`;
          }

          // Gunakan 'oninput' atau 'onchange' untuk menangkap editan teks
          const row = `
            <tr>
              <td class="text-center">${index + 1}</td>
              <td>
                <input type="text" class="input-verif-cell" value="${itemText}" 
                      oninput="updateRowText(${index}, this.value)" 
                      placeholder="Ketik nama berkas...">
              </td>
              <td></td>
              <td></td>
              <td class="text-center btn-aksi-verif">${btnHtml}</td>
            </tr>
          `;
          tbody.insertAdjacentHTML('beforeend', row);
        });
      }

      // 4. CRUD Tabel Lokal
      // Fungsi Tambah Baris
      function tambahBarisVerif() {
        currentVerifRows.push(""); // Tambah string kosong
        renderTabelVerifikasi();
        
        // Fokus otomatis ke baris baru
        setTimeout(() => {
          const inputs = document.querySelectorAll('#bodyTabelVerif .input-verif-cell');
          if(inputs.length > 0) inputs[inputs.length - 1].focus();
        }, 100);
      }

      // Fungsi Hapus Baris
      function hapusBarisVerif(index) {
        // Hapus dari array memori
        currentVerifRows.splice(index, 1);
        // Render ulang tampilan
        renderTabelVerifikasi();
        // Opsional: Tampilkan notif kecil bahwa baris terhapus (belum tersimpan ke server)
      }

      // Fungsi saat user mengetik di kolom Nama Berkas
      // PENTING: Ini mengupdate array di memori agar siap disimpan
      function updateRowText(index, val) {
        currentVerifRows[index] = val;
      }

      function resetTabelVerifikasi() {
        if(confirm("Kembalikan tabel ke format standar awal?")) {
          currentVerifRows = [...DEFAULT_VERIF_ROWS];
          renderTabelVerifikasi();
        }
      }

      // 5. Simpan ke Server
      function simpanVerifikasi(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const btn = document.getElementById('btnSimpanVerif');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const payload = {
          verifikator1: {
            nama: document.getElementById('vfNama1').value,
            nip: document.getElementById('vfNip1').value
          },
          verifikator2: {
            nama: document.getElementById('vfNama2').value,
            nip: document.getElementById('vfNip2').value
          },
          pengawas: {
            nama: document.getElementById('vfNamaPengawas').value,
            nip: document.getElementById('vfNipPengawas').value
          },
          rows: currentVerifRows
        };

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          
          if(res.status === 'success') {
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: 'Data Verifikasi Tersimpan', showConfirmButton: false, timer: 1500
            });
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).simpanDataVerifikasi(token, payload);
      }

    </script>
  </body>
</html>
