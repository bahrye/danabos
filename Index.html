<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
      body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
      
      /* Login & Register Styles */
      .card-login { max-width: 400px; margin: 50px auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
      
      /* Layout Styles */
      .sidebar { min-height: 100vh; background: #2c3e50; color: white; transition: all 0.3s; }
      .nav-link { color: rgba(255,255,255,0.8); margin-bottom: 5px; cursor: pointer; }
      .nav-link:hover { background: #34495e; color: white; border-radius: 5px; }
      .nav-link.active { background: #3498db; color: white; border-radius: 5px; font-weight: bold; }
      
      /* Utility Classes */
      .hidden { display: none !important; }
      .cursor-pointer { cursor: pointer; }
      
      /* Loading Overlay */
      .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }

      /* --- STYLE TAB CUSTOM --- */
      /* Keadaan Tidak Aktif (Default) */
      .nav-tabs .nav-link {
        color: black !important;          /* Teks Hitam */
        background-color: #e9ecef;        /* Background abu muda */
        border: 1px solid #dee2e6;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        font-weight: 600;
      }

      /* Keadaan Aktif (Terpilih) */
      .nav-tabs .nav-link.active {
        color: white !important;          /* Teks Putih */
        background-color: #0d6efd !important; /* Background Biru Utama */
        border-color: #0d6efd !important;
      }

      /* Hover Effect */
      .nav-tabs .nav-link:hover {
        background-color: #dfe6ed;
        color: #000;
      }
    </style>
  </head>
  <body>

    <div id="loading" class="loading-overlay hidden">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div id="view-login" class="container view-section">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-primary"><i class="fas fa-book-open"></i> LPJ BOS</h3>
        <p class="text-center text-muted">Sistem Manajemen LPJ Sekolah</p>
        <form id="formLogin" onsubmit="handleLogin(event)">
          <div class="mb-3">
            <label class="form-label">Email Sekolah</label>
            <input type="email" class="form-control" id="loginEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="loginPass" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Masuk</button>
        </form>
        <div class="text-center mt-3">
          <small>Belum punya akun? <span class="text-primary cursor-pointer text-decoration-underline" onclick="switchView('view-register')">Daftar disini</span></small>
        </div>
      </div>
    </div>

    <div id="view-register" class="container view-section hidden">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-success"><i class="fas fa-school"></i> Daftar Sekolah</h3>
        <form id="formRegister" onsubmit="handleRegister(event)">
          <div class="mb-3">
            <label class="form-label">Nama Sekolah</label>
            <input type="text" class="form-control" id="regNama" placeholder="Contoh: MTS Negeri 1..." required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="regEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="regPass" required>
          </div>
          <button type="submit" class="btn btn-success w-100">Daftar Sekarang</button>
        </form>
        <div class="text-center mt-3">
          <small>Sudah punya akun? <span class="text-primary cursor-pointer text-decoration-underline" onclick="switchView('view-login')">Login disini</span></small>
        </div>
      </div>
    </div>

    <div id="view-admin" class="container-fluid view-section hidden">
      <div class="row">
        
        <div class="col-md-3 col-lg-2 sidebar p-3 d-none d-md-block">
          <h4 class="text-center py-3 border-bottom"><i class="fas fa-user-shield"></i> Admin LPJ</h4>
          <ul class="nav flex-column mt-4">
            <li class="nav-item">
              <a onclick="navigasiKe('panel-dashboard', this)" class="nav-link active" style="cursor: pointer;">
                <i class="fas fa-home me-2"></i> Dashboard
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Data Master</small></li>
            
            <li class="nav-item">
              <a onclick="navigasiKe('panel-data-sekolah', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-school me-2"></i> Data Sekolah
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-uraian', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-list-ul me-2"></i> Data Uraian Pekerjaan
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-toko', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-store me-2"></i> Data Toko
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-tukang', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-hammer me-2"></i> Data Tukang
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-guru', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-user-tie me-2"></i> Data Pemesan/Guru
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Pengaturan</small></li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-kop', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-image me-2"></i> Kop Surat
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-nomor-surat', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-list-ol me-2"></i> Nomor Surat
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-tanggal-surat', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-calendar-alt me-2"></i> Tanggal Surat
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Transaksi</small></li>
            
            <li class="nav-item">
              <a onclick="navigasiKe('panel-transaksi', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-shopping-cart me-2"></i> Transaksi Belanja
              </a>
            </li>

            <li class="nav-item mt-2">
              <small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Cetak</small>
            </li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-cetak-pdf', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-print me-2"></i> Cetak PDF
              </a>
            </li>
            
            <li class="nav-item mt-5 pt-5 border-top">
              <a onclick="logout()" class="nav-link text-danger" style="cursor: pointer;">
                <i class="fas fa-sign-out-alt me-2"></i> Keluar
              </a>
            </li>
          </ul>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
          
          <div class="d-md-none mb-3">
            <button class="btn btn-dark" onclick="alert('Menu Mobile belum aktif')"><i class="fas fa-bars"></i> Menu</button>
          </div>

          <div id="panel-dashboard" class="panel-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Dashboard <span id="schoolNameDisplay" class="text-primary fs-5"></span></h2>
              <button class="btn btn-primary" onclick="navigasiKe('panel-transaksi')">
                <i class="fas fa-plus me-1"></i> Transaksi Belanja
              </button>
            </div>

            <div class="row g-3 mb-4">
              
              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-primary text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Jumlah Anggaran</h6>
                    <i class="fas fa-wallet fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashAnggaran">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Dana BOS Tahunan</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-danger text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Total Pengeluaran</h6>
                    <i class="fas fa-shopping-cart fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashPengeluaran">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Toko, Tukang & Guru</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card p-3 shadow-sm h-100 text-white" id="cardSisaAnggaran" style="background-color: #ffc107;"> <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Sisa Anggaran</h6>
                    <i class="fas fa-chart-pie fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashSisa">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Saldo Tersedia</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-info text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Jumlah Transaksi</h6>
                    <i class="fas fa-list-ol fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashJmlTrans">0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Total Item Data</small>
                </div>
              </div>

            </div>

            <div class="card shadow-sm border-0 mt-4">
              <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-school text-primary me-2"></i> Identitas Sekolah</h5>
                
                <button class="btn btn-sm btn-outline-primary" 
                  onclick="navigasiKe('panel-data-sekolah', document.querySelector(`a[onclick*='panel-data-sekolah']`))">
                  <i class="fas fa-edit me-1"></i> Ubah Data
                </button>
              </div>
              
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 border-end-md">
                     <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Profil Sekolah</h6>
                     <table class="table table-borderless table-sm mb-0" style="font-size: 0.95rem;">
                       <tr>
                         <td width="35%" class="text-muted">Nama Sekolah</td>
                         <td class="fw-bold" id="dashNamaSekolah">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NPSN</td>
                         <td class="fw-bold" id="dashNpsn">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NSM</td>
                         <td id="dashNsm">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">Alamat</td>
                         <td id="dashAlamat">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">Wilayah</td>
                         <td id="dashLokasi">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">Email</td>
                         <td id="dashEmail">-</td>
                       </tr>
                     </table>
                  </div>

                  <div class="col-md-6 ps-md-4 mt-4 mt-md-0">
                     <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Pejabat Sekolah</h6>
                     <table class="table table-borderless table-sm mb-0" style="font-size: 0.95rem;">
                       <tr>
                         <td width="35%" class="text-muted">Kepala Sekolah</td>
                         <td class="fw-bold" id="dashKepala">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NIP Kepala</td>
                         <td id="dashNipKepala">-</td>
                       </tr>
                       <tr><td colspan="2" class="py-2"></td></tr>
                       <tr>
                         <td class="text-muted">Bendahara</td>
                         <td class="fw-bold" id="dashBendahara">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NIP Bendahara</td>
                         <td id="dashNipBendahara">-</td>
                       </tr>
                     </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-toko" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-store text-primary"></i> Data Toko / Rekanan</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Toko</div>
                  <div class="card-body">
                    <form id="formToko" onsubmit="submitToko(event)">
                      <input type="hidden" id="tkId">

                      <div class="mb-3">
                        <label class="form-label">Nama Toko</label>
                        <input type="text" class="form-control" id="tkNama" placeholder="Contoh: Toko Amanah" required>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label class="form-label">Jenis Toko</label>
                          <input type="text" class="form-control" id="tkJenis" placeholder="ATK, Elektronik, dll" required>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">No. Telp/HP</label>
                          <input type="text" class="form-control" id="tkTelp" placeholder="0812...">
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Nama Pemilik</label>
                        <input type="text" class="form-control" id="tkPemilik" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Tempat TTD (Alamat/Kota/Kab)</label>
                        <input type="text" class="form-control" id="tkTempat" placeholder="Contoh: Bulukumba">
                        <small class="text-muted">Alamat/Kota tempat penandatanganan nota.</small>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Alamat Lengkap Toko</label>
                        <textarea class="form-control" id="tkAlamat" rows="2" placeholder="Jalan, No, Desa..." required></textarea>
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanToko" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan Toko
                        </button>
                        <button type="button" id="btnBatalToko" class="btn btn-secondary hidden" onclick="batalEditToko()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Toko Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-sm" style="font-size: 0.9rem;">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Toko</th>
                            <th>Pemilik</th>
                            <th>Jenis</th>
                            <th>Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelTokoBody">
                          <tr><td colspan="4" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-tukang" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-hammer text-primary"></i> Data Tukang / Pekerja</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Tukang</div>
                  <div class="card-body">
                    <form id="formTukang" onsubmit="submitTukang(event)">
                      <input type="hidden" id="tkgId">

                      <div class="mb-3">
                        <label class="form-label">Nama Lengkap Tukang</label>
                        <input type="text" class="form-control" id="tkgNama" placeholder="Nama sesuai KTP" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Alamat Lengkap</label>
                        <textarea class="form-control" id="tkgAlamat" rows="3" placeholder="Jalan, RT/RW, Desa..." required></textarea>
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanTukang" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        <button type="button" id="btnBatalTukang" class="btn btn-secondary hidden" onclick="batalEditTukang()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Tukang Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Lengkap</th>
                            <th>Alamat</th>
                            <th style="width: 100px;">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelTukangBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-guru" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-user-tie text-primary"></i> Data Pemesan / Guru</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Guru</div>
                  <div class="card-body">
                    <form id="formGuru" onsubmit="submitGuru(event)">
                      <input type="hidden" id="grId">

                      <div class="mb-3">
                        <label class="form-label">Nama Lengkap Guru</label>
                        <input type="text" class="form-control" id="grNama" placeholder="Nama Lengkap & Gelar" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">NIP <small>(Opsional)</small></label>
                        <input type="text" class="form-control" id="grNip" placeholder="19...">
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanGuru" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        <button type="button" id="btnBatalGuru" class="btn btn-secondary hidden" onclick="batalEditGuru()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Guru Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Lengkap</th>
                            <th>NIP</th>
                            <th style="width: 100px;">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelGuruBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-nomor-surat" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-file-alt text-primary"></i> Pengaturan Nomor Surat</h2>

            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-surat-toko" onclick="bukaTabSurat('toko')">
                  <i class="fas fa-store me-2"></i> Transaksi Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-surat-tukang" onclick="bukaTabSurat('tukang')">
                  <i class="fas fa-hammer me-2"></i> Transaksi Tukang
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                <div class="row g-2 mb-3 align-items-center">
                  <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                  <div class="col-auto">
                    <select id="fltTahun_surat" class="form-select form-select-sm" onchange="jalankanFilter('tabelSuratBody', 'fltTahun_surat', 'fltBulan_surat')"></select>
                  </div>
                  <div class="col-auto">
                    <select id="fltBulan_surat" class="form-select form-select-sm" onchange="jalankanFilter('tabelSuratBody', 'fltTahun_surat', 'fltBulan_surat')">
                      <option value="">Semua Bulan</option>
                      <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                      <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                      <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                      <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                    </select>
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Tanggal</th>
                        <th>Uraian Belanja/Pekerjaan</th>
                        <th>Pihak Ketiga</th>
                        <th>Status Dokumen</th>
                        <th width="15%">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="tabelSuratBody">
                      <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalSurat" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Kelola Nomor Surat</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="formInputSurat" onsubmit="simpanSurat(event)">
                    <input type="hidden" id="suratTransId">
                    <input type="hidden" id="suratTransTipe">
                    
                    <div class="alert alert-info py-2 mb-3">
                      <small><i class="fas fa-info-circle"></i> Silakan isi nomor surat yang sesuai. Kosongkan jika belum ada.</small>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Surat Permintaan</label>
                      <div class="col-sm-8">
                        <input type="text" class="form-control" id="noSuratPermintaan" placeholder="Nomor dari Sekolah...">
                        <div class="form-text">Surat Permintaan Barang/Jasa dari Sekolah.</div>
                      </div>
                    </div>

                    <div class="mb-3 row" id="wrapSuratPenawaran">
                      <label class="col-sm-4 col-form-label fw-bold">Surat Penawaran <span class="badge bg-secondary">Opsional</span></label>
                      <div class="col-sm-8">
                        <input type="text" class="form-control" id="noSuratPenawaran" placeholder="Nomor dari Toko...">
                        <div class="form-text">Surat Penawaran Harga dari Toko/Rekanan.</div>
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">BA Pemeriksaan</label>
                      <div class="col-sm-8">
                        <input type="text" class="form-control" id="noBaPemeriksaan" placeholder="Nomor BA Pemeriksaan...">
                        <div class="form-text">Berita Acara Pemeriksaan Barang/Pekerjaan.</div>
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">BA Serah Terima (BAST)</label>
                      <div class="col-sm-8">
                        <input type="text" class="form-control" id="noBaSerahTerima" placeholder="Nomor BAST...">
                        <div class="form-text">Berita Acara Serah Terima Barang/Pekerjaan.</div>
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">BA Pembayaran</label>
                      <div class="col-sm-8">
                        <input type="text" class="form-control" id="noBaPembayaran" placeholder="Nomor BA Pembayaran...">
                        <div class="form-text">Berita Acara Pembayaran Lunas.</div>
                      </div>
                    </div>

                    <div class="modal-footer px-0 pb-0 mt-4">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="submit" id="btnSimpanSurat" class="btn btn-primary"><i class="fas fa-save me-1"></i> Simpan Dokumen</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-tanggal-surat" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-calendar-alt text-primary"></i> Pengaturan Tanggal Surat</h2>

            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-tgl-toko" onclick="bukaTabTanggal('toko')">
                  <i class="fas fa-store me-2"></i> Transaksi Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-tgl-tukang" onclick="bukaTabTanggal('tukang')">
                  <i class="fas fa-hammer me-2"></i> Transaksi Tukang
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                <div class="row g-2 mb-3 align-items-center">
                  <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                  <div class="col-auto">
                    <select id="fltTahun_tgl" class="form-select form-select-sm" onchange="jalankanFilter('tabelTanggalBody', 'fltTahun_tgl', 'fltBulan_tgl')"></select>
                  </div>
                  <div class="col-auto">
                    <select id="fltBulan_tgl" class="form-select form-select-sm" onchange="jalankanFilter('tabelTanggalBody', 'fltTahun_tgl', 'fltBulan_tgl')">
                      <option value="">Semua Bulan</option>
                      <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                      <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                      <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                      <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                    </select>
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Tanggal Transaksi</th>
                        <th>Uraian</th>
                        <th>Pihak Ketiga</th>
                        <th>Status Tanggal</th>
                        <th width="15%">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="tabelTanggalBody">
                      <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalTanggal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title"><i class="fas fa-calendar-day me-2"></i> Atur Tanggal Dokumen</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="formInputTanggal" onsubmit="simpanTanggal(event)">
                    <input type="hidden" id="tglTransId">
                    <input type="hidden" id="tglTransTipe">
                    
                    <div class="alert alert-success py-2 mb-3">
                      <small><i class="fas fa-info-circle"></i> Tanggal Surat Permintaan otomatis mengikuti tanggal transaksi.</small>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. Surat Permintaan</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control bg-light" id="tglSuratPermintaan" readonly>
                        <div class="form-text text-success"><i class="fas fa-lock me-1"></i> Terkunci (Sesuai Tgl Transaksi)</div>
                      </div>
                    </div>

                    <div class="mb-3 row" id="wrapTglPenawaran">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. Surat Penawaran</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglSuratPenawaran">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Pemeriksaan</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaPemeriksaan">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Serah Terima</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaSerahTerima">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Pembayaran</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaPembayaran">
                      </div>
                    </div>

                    <div class="modal-footer px-0 pb-0 mt-4">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="submit" id="btnSimpanTanggal" class="btn btn-success"><i class="fas fa-save me-1"></i> Simpan Tanggal</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-kop" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-image text-primary"></i> Pengaturan Kop Surat</h2>
            
            <div class="card shadow-sm border-0" style="max-width: 600px;">
              <div class="card-body p-4">
                
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-1"></i> Upload gambar kop surat (Header). Format: JPG/PNG. Ukuran optimal lebar 800px.
                </div>

                <div class="text-center mb-4 p-3 border rounded bg-light" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                  <img id="imgPreview" src="" alt="Preview Kop Surat" style="max-width: 100%; height: auto; display: none;">
                  <span id="txtNoImage" class="text-muted fst-italic">Belum ada kop surat yang diupload.</span>
                </div>

                <form id="formKop" onsubmit="uploadKop(event)">
                  <div class="mb-3">
                    <label class="form-label fw-bold">Pilih Gambar</label>
                    <input class="form-control" type="file" id="fileKop" accept="image/png, image/jpeg" onchange="previewImage(this)" required>
                  </div>

                  <div class="d-flex justify-content-between">
                    <button type="button" id="btnHapusKop" class="btn btn-danger hidden" onclick="aksiHapusKop()">
                      <i class="fas fa-trash-alt me-1"></i> Hapus Kop
                    </button>
                    <button type="submit" id="btnSimpanKop" class="btn btn-primary">
                      <i class="fas fa-cloud-upload-alt me-1"></i> Upload & Simpan
                    </button>
                  </div>
                </form>

              </div>
            </div>
          </div>

          <div id="panel-transaksi" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-shopping-cart text-primary"></i> Transaksi Belanja</h2>

            <ul class="nav nav-tabs mb-4" id="transaksiTabs">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-btn-toko" onclick="bukaTab('toko')">
                  <i class="fas fa-store me-2"></i> Belanja Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-btn-guru" onclick="bukaTab('guru')">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Honor Guru
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-btn-tukang" onclick="bukaTab('tukang')">
                  <i class="fas fa-hammer me-2"></i> Upah Tukang
                </button>
              </li>
            </ul>

            <div id="tab-content-toko" class="tab-section">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <form id="formBelanjaToko">
                    <input type="hidden" id="trTokoId"> <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Transaksi</label>
                        <input type="date" class="form-control" id="trTokoTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Belanja (RKAM)</label>
                        <select class="form-select" id="trTokoUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>

                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Pilih Toko / Rekanan</label>
                        <select class="form-select" id="trTokoNama" required>
                          <option value="">-- Pilih Toko --</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Pilih Data Pemesan</label>
                        <select class="form-select" id="trTokoPemesan" required>
                          <option value="">-- Pilih Guru/Pemesan --</option>
                        </select>
                      </div>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Daftar Barang Belanjaan</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle" id="tabelItemToko">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="30%">Nama Barang</th>
                            <th width="10%">Vol</th>
                            <th width="10%">Satuan</th>
                            <th width="20%">Harga (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="10%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL BELANJA:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trTokoTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trTokoTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                      <button type="button" class="btn btn-outline-primary" onclick="tambahBaris('toko')">
                        <i class="fas fa-plus me-1"></i> Tambah Baris Barang
                      </button>
                      
                      <div>
                        <button type="button" id="btnBatalTokoTrans" class="btn btn-secondary me-2 hidden" onclick="batalEditTransaksi('toko')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        <button type="button" id="btnSimpanTokoTrans" class="btn btn-success" onclick="simpanTransaksi('toko')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>

                  </form>
                </div>
              </div>

              <div class="card shadow-sm border-0">
                  <div class="card-header bg-white fw-bold py-3">Riwayat Transaksi Toko</div>
                  <div class="card-body">

                      <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                        <div class="col-auto">
                          <select id="fltTahun_toko" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiToko', 'fltTahun_toko', 'fltBulan_toko')"></select>
                        </div>
                        <div class="col-auto">
                          <select id="fltBulan_toko" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiToko', 'fltTahun_toko', 'fltBulan_toko')">
                            <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                          </select>
                        </div>
                      </div>

                      <div class="table-responsive">
                          <table class="table table-hover align-middle table-striped text-sm">
                              <thead class="table-light">
                                  <tr>
                                      <th>Tanggal</th>
                                      <th>Uraian</th>
                                      <th>Toko</th>
                                      <th>Total</th>
                                      <th>Aksi</th>
                                  </tr>
                              </thead>
                              <tbody id="listTransaksiToko">
                                  <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
            </div>

            <div id="tab-content-guru" class="tab-section hidden">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-info py-2 mb-3"><small><i class="fas fa-info-circle"></i> Mode Input: Pembayaran Honorarium / Transport Guru</small></div>
                  
                  <form id="formBelanjaGuru">
                    <input type="hidden" id="trGuruId"> 
                    
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Pembayaran</label>
                        <input type="date" class="form-control" id="trGuruTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Pekerjaan / Kegiatan</label>
                        <select class="form-select" id="trGuruUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="form-label">Keterangan <small class="text-muted">(Opsional)</small></label>
                      <textarea class="form-control" id="trGuruKeterangan" rows="2" placeholder="Contoh: Honorarium bulan Januari 2025..."></textarea>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Rincian Penerima Honor</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle" id="tabelItemGuru">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="30%">Nama Guru</th>
                            <th width="10%">Vol</th>
                            <th width="10%">Satuan</th>
                            <th width="20%">Honor/Upah (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="10%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL HONOR:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trGuruTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trGuruTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                      <button type="button" class="btn btn-outline-primary" onclick="tambahBaris('guru')">
                        <i class="fas fa-plus me-1"></i> Tambah Penerima
                      </button>

                      <div>
                        <button type="button" id="btnBatalGuruTrans" class="btn btn-secondary me-2 hidden" onclick="batalEditTransaksi('guru')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        <button type="button" id="btnSimpanGuruTrans" class="btn btn-success" onclick="simpanTransaksi('guru')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>

                  </form>
                </div>
              </div>

              <div class="card shadow-sm border-0">
                  <div class="card-header bg-white fw-bold py-3">Riwayat Pembayaran Honor</div>
                  <div class="card-body">
                      <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                        <div class="col-auto">
                          <select id="fltTahun_guru" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiGuru', 'fltTahun_guru', 'fltBulan_guru')"></select>
                        </div>
                        <div class="col-auto">
                          <select id="fltBulan_guru" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiGuru', 'fltTahun_guru', 'fltBulan_guru')">
                            <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                          </select>
                        </div>
                      </div>

                      <div class="table-responsive">
                          <table class="table table-hover align-middle table-striped text-sm">
                              <thead class="table-light">
                                  <tr>
                                      <th>Tanggal</th>
                                      <th>Uraian Kegiatan</th>
                                      <th>Keterangan</th> <th>Total</th>
                                      <th>Aksi</th>
                                  </tr>
                              </thead>
                              <tbody id="listTransaksiGuru">
                                  <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
            </div>

            <div id="tab-content-tukang" class="tab-section hidden">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-warning py-2 mb-3"><small><i class="fas fa-info-circle"></i> Mode Input: Pembayaran Upah Tukang</small></div>
                  <form id="formBelanjaTukang">
                    <input type="hidden" id="trTukangId"> <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Transaksi</label>
                        <input type="date" class="form-control" id="trTukangTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Pekerjaan</label>
                        <select class="form-select" id="trTukangUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>

                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Pilih Tukang / Pekerja</label>
                        <select class="form-select" id="trTukangNama" required>
                          <option value="">-- Pilih Tukang --</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Pilih Data Pemesan</label>
                        <select class="form-select" id="trTukangPemesan" required>
                          <option value="">-- Pilih Guru --</option>
                        </select>
                      </div>
                    </div>

                    <h5 class="border-bottom pb-2 mb-3">Rincian Upah / Bahan</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle" id="tabelItemTukang">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="30%">Jenis Pekerjaan/Item</th>
                            <th width="10%">Vol</th>
                            <th width="10%">Satuan</th>
                            <th width="20%">Upah/Harga (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="10%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL UPAH:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trTukangTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trTukangTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                      <button type="button" class="btn btn-outline-primary" onclick="tambahBaris('tukang')">
                        <i class="fas fa-plus me-1"></i> Tambah Baris
                      </button>

                      <div>
                        <button type="button" id="btnBatalTukangTrans" class="btn btn-secondary me-2 hidden" onclick="batalEditTransaksi('tukang')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        <button type="button" id="btnSimpanTukangTrans" class="btn btn-success" onclick="simpanTransaksi('tukang')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>

                  </form>
                </div>
              </div>

              <div class="card shadow-sm border-0">
                  <div class="card-header bg-white fw-bold py-3">Riwayat Transaksi Tukang</div>
                  <div class="card-body">
                      <div class="row g-2 mb-3 align-items-center">
                        <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                        <div class="col-auto">
                          <select id="fltTahun_tukang" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiTukang', 'fltTahun_tukang', 'fltBulan_tukang')"></select>
                        </div>
                        <div class="col-auto">
                          <select id="fltBulan_tukang" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiTukang', 'fltTahun_tukang', 'fltBulan_tukang')">
                            <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                          </select>
                        </div>
                      </div>
                      <div class="table-responsive">
                          <table class="table table-hover align-middle table-striped text-sm">
                              <thead class="table-light">
                                  <tr>
                                      <th>Tanggal</th>
                                      <th>Uraian</th>
                                      <th>Tukang</th>
                                      <th>Total</th>
                                      <th>Aksi</th>
                                  </tr>
                              </thead>
                              <tbody id="listTransaksiTukang">
                                  <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
            </div>
          </div>

          <div id="panel-cetak-pdf" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-print text-primary"></i> Cetak Laporan PDF</h2>

            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-cetak-toko" onclick="bukaTabCetak('toko')">
                  <i class="fas fa-store me-2"></i> LPJ Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-cetak-guru" onclick="bukaTabCetak('guru')">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Honor Guru
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-cetak-tukang" onclick="bukaTabCetak('tukang')">
                  <i class="fas fa-hammer me-2"></i> Upah Tukang
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                
                <div id="view-cetak-toko" class="view-cetak">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Transaksi Belanja Toko Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_toko" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-toko', 'fltTahun_cetak_toko', 'fltBulan_cetak_toko')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_toko" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-toko', 'fltTahun_cetak_toko', 'fltBulan_cetak_toko')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Belanja</th>
                          <th>Nama Toko</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-toko">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-guru" class="view-cetak hidden">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Pembayaran Honor Guru Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_guru" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-guru', 'fltTahun_cetak_guru', 'fltBulan_cetak_guru')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_guru" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-guru', 'fltTahun_cetak_guru', 'fltBulan_cetak_guru')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Kegiatan</th>
                          <th>Keterangan</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-guru">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-tukang" class="view-cetak hidden">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Upah Tukang Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_tukang" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-tukang', 'fltTahun_cetak_tukang', 'fltBulan_cetak_tukang')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_tukang" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-tukang', 'fltTahun_cetak_tukang', 'fltBulan_cetak_tukang')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Pekerjaan</th>
                          <th>Nama Tukang</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-tukang">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div id="panel-uraian" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-list-ul text-primary"></i> Data Uraian Pekerjaan</h2>
            
            <div class="row">
              <div class="col-md-4">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Tambah Uraian Baru</div>
                  <div class="card-body">
                    <form id="formUraian" onsubmit="submitUraian(event)">
                      <input type="hidden" id="urId">
                      
                      <div class="mb-3">
                        <label class="form-label">Nomor Bukti</label>
                        <input type="text" class="form-control" id="urNoBukti" placeholder="Contoh: 01/BOS/..." required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Uraian Pekerjaan / Belanja</label>
                        <textarea class="form-control" id="urNama" rows="3" placeholder="Contoh: Belanja ATK Habis Pakai" required></textarea>
                      </div>
                      
                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanUraian" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        
                        <button type="button" id="btnBatalUraian" class="btn btn-secondary hidden" onclick="batalEdit()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-8">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Uraian Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped">
                        <thead class="table-light">
                          <tr>
                            <th width="25%">No. Bukti</th>
                            <th>Uraian Pekerjaan</th>
                            <th width="10%">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelUraianBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="panel-pengaturan" class="panel-content hidden">
            <h2 class="mb-4">Pengaturan Sekolah</h2>
            <div class="card shadow-sm border-0">
              <div class="card-body">
                <form>
                  <div class="mb-3">
                    <label class="form-label">Nama Kepala Sekolah</label>
                    <input type="text" class="form-control" placeholder="Nama Lengkap & Gelar">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">NIP Kepala Sekolah</label>
                    <input type="text" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nama Bendahara</label>
                    <input type="text" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Alamat Sekolah</label>
                    <textarea class="form-control" rows="3"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </form>
              </div>
            </div>
          </div>

          <div id="panel-data-sekolah" class="panel-content hidden">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-school text-primary"></i> Data Sekolah</h2>
              <button class="btn btn-primary" onclick="submitDataSekolah()"><i class="fas fa-save"></i> Simpan Data</button>
            </div>

            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <form id="formDataSekolah">
                        
                  <h5 class="text-primary border-bottom pb-2 mb-3">Identitas Sekolah</h5>
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label fw-bold">Nama Sekolah <span class="text-danger">*</span></label>
                      <input type="text" class="form-control bg-light" id="dsNamaSekolah" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-bold">NPSN <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="dsNpsn" required placeholder="Contoh: 40319868">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">NSM <small>(Opsional Bagi Madrasah)</small></label>
                      <input type="text" class="form-control" id="dsNsm" placeholder="Contoh: 1212...">
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">No. Telp Sekolah</label>
                      <input type="text" class="form-control" id="dsTelp" placeholder="Contoh: 0812...">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Email Sekolah</label>
                      <input type="email" class="form-control" id="dsEmail">
                    </div>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Alamat Lengkap</h5>
                  <div class="mb-3">
                    <label class="form-label">Alamat Jalan/Dusun</label>
                    <textarea class="form-control" id="dsAlamat" rows="2" placeholder="Jl. Raya..."></textarea>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Provinsi</label>
                      <input type="text" class="form-control" id="dsProvinsi">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Kabupaten/Kota</label>
                      <input type="text" class="form-control" id="dsKabupaten">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Kecamatan</label>
                      <input type="text" class="form-control" id="dsKecamatan">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Kelurahan/Desa</label>
                      <input type="text" class="form-control" id="dsKelurahan">
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-bold">Tempat TTD (Alamat/Kota/Kab) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="dsTempatTTD" placeholder="Contoh: Bulukumba">
                    <small class="text-muted">Hanya isi nama Alamat/Kota/Kabupaten.</small>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Pejabat Sekolah</h5>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Nama Kepala Sekolah</label>
                      <input type="text" class="form-control" id="dsKepala" placeholder="Nama Lengkap & Gelar">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">NIP Kepala <small>(Opsional)</small></label>
                      <input type="text" class="form-control" id="dsNipKepala">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Nama Bendahara</label>
                      <input type="text" class="form-control" id="dsBendahara">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">NIP Bendahara <small>(Opsional)</small></label>
                      <input type="text" class="form-control" id="dsNipBendahara">
                    </div>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Pengaturan Default BOS</h5>
                  <div class="row mb-3">
                    
                    <div class="col-md-4">
                      <label class="form-label fw-bold">Nama Dana BOS</label>
                      
                      <select class="form-select" id="dsDanaBos" onchange="cekPeriodeBos()">
                        <option value="">-- Pilih Jenis --</option>
                        <option value="Lainnya">Lainnya (Manual)</option>
                        <option value="Dana BOS Tahap 1">Dana BOS Tahap 1</option>
                        <option value="Dana BOS Tahap 2">Dana BOS Tahap 2</option>
                        <option value="Dana BOS Triwulan 1">Dana BOS Triwulan 1</option>
                        <option value="Dana BOS Triwulan 2">Dana BOS Triwulan 2</option>
                        <option value="Dana BOS Triwulan 3">Dana BOS Triwulan 3</option>
                        <option value="Dana BOS Triwulan 4">Dana BOS Triwulan 4</option>
                      </select>

                      <small id="infoPeriode" class="text-muted fst-italic d-block mt-1"></small>

                      <div id="wrapManualBos" class="hidden mt-2">
                        <label class="form-label text-muted" style="font-size: 0.8rem;">Nama Dana BOS:</label>
                        <input type="text" class="form-control mb-2" id="dsDanaBosManual" placeholder="Contoh: BOS Afirmasi">
                        
                        <label class="form-label text-muted" style="font-size: 0.8rem;">Ketik Periode:</label>
                        <input type="text" class="form-control" id="dsPeriodeManual" placeholder="Contoh: Januari - Juni">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-bold">Jumlah Anggaran</label>
                      <div class="input-group">
                        <span class="input-group-text">Rp</span>
                        <input type="text" class="form-control" id="dsJumlahAnggaran" placeholder="0" oninput="this.value = formatRibuanInput(this.value)">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-bold">Tahun Anggaran</label>
                      <input type="number" class="form-control" id="dsTahun" placeholder="2025">
                    </div>
                  </div>

                  <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-primary px-4" onclick="submitDataSekolah()">
                      <i class="fas fa-save me-2"></i> Simpan Data
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

      let cacheDataGuru = []; // Menyimpan data guru agar bisa dipanggil berulang kali


      /* --- LOGIKA NAVIGASI UTAMA (SPA) --- */
      
      // 1. Pindah Antara Login, Register, dan Admin Panel
      function switchView(viewId) {
        // Sembunyikan semua view utama
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        // Tampilkan view yang dipilih
        document.getElementById(viewId).classList.remove('hidden');
      }


      // 2. Pindah Menu Sidebar (Dashboard <-> Buat LPJ <-> Pengaturan)
      function navigasiKe(panelId, linkElement) {
        // 1. Scroll ke Paling Atas Halaman (FITUR BARU)
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // 2. Sembunyikan semua panel
        document.querySelectorAll('.panel-content').forEach(el => el.classList.add('hidden'));
        
        // 3. Tampilkan panel target
        const targetPanel = document.getElementById(panelId);
        if(targetPanel) targetPanel.classList.remove('hidden');

        // 4. Update status Active di Sidebar
        if (linkElement) {
          document.querySelectorAll('.sidebar .nav-link').forEach(el => el.classList.remove('active'));
          linkElement.classList.add('active');
        }

        // --- TAMBAHAN PEMANGGILAN DASHBOARD ---
        if(panelId === 'panel-dashboard') {
          loadDashboardStats();
        }
        
        // 5. Load Data sesuai Panel
        if(panelId === 'panel-data-sekolah') loadDataSekolah();
        if(panelId === 'panel-uraian') loadUraianData();
        if(panelId === 'panel-toko') loadTokoData();
        if(panelId === 'panel-tukang') loadTukangData();
        if(panelId === 'panel-guru') loadGuruData();
        if(panelId === 'panel-kop') loadKopSettings();
        
        // LOGIKA TRANSAKSI
        if(panelId === 'panel-transaksi') {
          loadTransaksiOptions(); 
          // Siapkan baris kosong jika tabel masih kosong
          if(document.getElementById('tabelItemToko').tBodies[0].rows.length === 0) tambahBaris('toko');
          if(document.getElementById('tabelItemTukang').tBodies[0].rows.length === 0) tambahBaris('tukang');
          if(document.getElementById('tabelItemGuru').tBodies[0].rows.length === 0) tambahBaris('guru');

          bukaTab('toko'); 
        }

        // LOGIKA NOMOR SURAT
        if(panelId === 'panel-nomor-surat') {
          bukaTabSurat('toko');
        }

        // LOGIKA TANGGAL SURAT
        if(panelId === 'panel-tanggal-surat') {
          bukaTabTanggal('toko');
        }

        if(panelId === 'panel-cetak-pdf') {
          bukaTabCetak('toko'); // Default buka tab toko
        }
      }

      // Helper khusus untuk tombol "Transaksi Baru" di dashboard
      function triggerMenuBuatLPJ() {
        // Cari elemen link sidebar yang mengarah ke 'panel-buat-lpj'
        const linkLpj = document.querySelector("a[onclick*='panel-buat-lpj']");
        navigasiKe('panel-buat-lpj', linkLpj);
      }

      /* --- LOGIKA APLIKASI --- */

      window.onload = function() {
        const token = localStorage.getItem('userToken');
        if(token) {
          switchView('view-admin');
          document.getElementById('schoolNameDisplay').innerText = "(" + localStorage.getItem('userName') + ")";
          
          // Tambahkan ini agar saat login/refresh, data dashboard langsung muncul
          loadDashboardStats(); 
          
        } else {
          switchView('view-login');
        }
      };

      function toggleLoading(show) {
        const el = document.getElementById('loading');
        show ? el.classList.remove('hidden') : el.classList.add('hidden');
      }

      function handleLogin(e) {
        e.preventDefault();
        toggleLoading(true);
        const form = {
          email: document.getElementById('loginEmail').value,
          password: document.getElementById('loginPass').value
        };
        google.script.run.withSuccessHandler(function(res){
          toggleLoading(false);
          if(res.status === 'success') {
            localStorage.setItem('userToken', res.token);
            localStorage.setItem('userName', res.namaSekolah);
            document.getElementById('schoolNameDisplay').innerText = "(" + res.namaSekolah + ")";
            switchView('view-admin');
          } else {
            Swal.fire('Login Gagal', res.message, 'error');
          }
        }).loginUser(form);
      }

      function handleRegister(e) {
        e.preventDefault();
        toggleLoading(true);
        const form = {
          namaSekolah: document.getElementById('regNama').value,
          email: document.getElementById('regEmail').value,
          password: document.getElementById('regPass').value
        };
        google.script.run.withSuccessHandler(function(res){
          toggleLoading(false);
          if(res.status === 'success') {
            Swal.fire('Berhasil', res.message, 'success');
            switchView('view-login');
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).registerSchool(form);
      }

      function logout() {
        Swal.fire({
          title: 'Yakin ingin keluar?',
          text: "Sesi Anda akan diakhiri.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Ya, Keluar',
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            // 1. Hapus Data Login dari LocalStorage
            localStorage.removeItem('userToken');
            localStorage.removeItem('userName');
            
            // 2. Reset Variabel Global (Penting agar data user sebelumnya tidak nyangkut)
            if (typeof cacheDataGuru !== 'undefined') {
                cacheDataGuru = [];
            }
            
            // 3. Reset Form Login (Agar bersih saat mau login lagi)
            const formLogin = document.getElementById('formLogin');
            if(formLogin) formLogin.reset();
            
            // 4. Bersihkan Tampilan Nama Sekolah di Dashboard (Opsional)
            const schoolNameDisplay = document.getElementById('schoolNameDisplay');
            if(schoolNameDisplay) schoolNameDisplay.innerText = "";

            // 5. Pindah ke Tampilan Login (Tanpa Reload Halaman agar tidak White Screen)
            switchView('view-login');
            
            // 6. Tampilkan Pesan Sukses
            Swal.fire({
              icon: 'success',
              title: 'Berhasil Keluar',
              text: 'Anda telah keluar dari aplikasi.',
              timer: 1500,
              showConfirmButton: false
            });
          }
        });
      }

      /* --- LOGIC DATA SEKOLAH --- */

      function loadDataSekolah() {
        const token = localStorage.getItem('userToken');
        const schoolName = localStorage.getItem('userName');
        
        document.getElementById('dsNamaSekolah').value = schoolName;

        toggleLoading(true);
        
        google.script.run.withSuccessHandler(function(res) {
          toggleLoading(false);
          if (res.status === 'success') {
            const d = res.data;
            
            // BERSIHKAN TANDA KUTIP (') SAAT MENAMPILKAN DATA
            document.getElementById('dsNpsn').value = String(d.npsn).replace(/'/g, '');
            
            // Update untuk NSM
            document.getElementById('dsNsm').value = String(d.nsm).replace(/'/g, ''); 
            
            document.getElementById('dsAlamat').value = d.alamat;
            document.getElementById('dsProvinsi').value = d.provinsi;
            document.getElementById('dsKabupaten').value = d.kabupaten;
            document.getElementById('dsKecamatan').value = d.kecamatan;
            document.getElementById('dsKelurahan').value = d.kelurahan;
            document.getElementById('dsTempatTTD').value = d.tempatTTD;
            document.getElementById('dsKepala').value = d.namaKepala;
            document.getElementById('dsNipKepala').value = String(d.nipKepala).replace(/'/g, '');
            document.getElementById('dsBendahara').value = d.namaBendahara;
            document.getElementById('dsNipBendahara').value = String(d.nipBendahara).replace(/'/g, '');
            document.getElementById('dsTelp').value = String(d.noTelp).replace(/'/g, '');
            document.getElementById('dsEmail').value = d.email;

            /* --- LOGIKA LOAD DANA BOS & PERIODE (TERPISAH) --- */
            const savedBos = d.danaBOS; 
            const savedPeriode = d.periodeAnggaran; // Ambil data periode dari kolom baru
            
            const selectBos = document.getElementById('dsDanaBos');
            const inputBosManual = document.getElementById('dsDanaBosManual');
            const inputPeriodeManual = document.getElementById('dsPeriodeManual');

            // 1. Cek apakah Nama BOS ada di pilihan dropdown standar?
            let isMatch = false;
            for (let i = 0; i < selectBos.options.length; i++) {
              if (selectBos.options[i].value === savedBos) {
                isMatch = true;
                break;
              }
            }

            if (isMatch) {
              // KASUS 1: Pilihan Standar (misal: Dana BOS Tahap 1)
              selectBos.value = savedBos;
              inputBosManual.value = "";       // Kosongkan manual
              inputPeriodeManual.value = "";   // Kosongkan manual
            } else if (savedBos) {
              // KASUS 2: Pilihan Manual (misal: BOS Tulang)
              selectBos.value = "Lainnya";     // Set dropdown ke Lainnya
              inputBosManual.value = savedBos; // Isi kotak nama manual
              inputPeriodeManual.value = savedPeriode; // Isi kotak periode manual
            } else {
              // KASUS 3: Belum ada data
              selectBos.value = "";
            }

            // Update UI (Keterangan text dll)
            cekPeriodeBos();
            /* --- AKHIR LOGIKA LOAD --- */

            document.getElementById('dsJumlahAnggaran').value = formatRibuanInput(d.jumlahAnggaran);
            document.getElementById('dsTahun').value = d.tahunAnggaran;
          } 
        }).getDataSekolah(token);
      }

      function submitDataSekolah() {
        const token = localStorage.getItem('userToken');
        
        // Validasi
        if(!document.getElementById('dsNpsn').value) {
          Swal.fire('Peringatan', 'NPSN Wajib diisi!', 'warning'); return;
        }
        if(!document.getElementById('dsTempatTTD').value) {
          Swal.fire('Peringatan', 'Tempat TTD Wajib diisi!', 'warning'); return;
        }

        /* --- LOGIKA BARU: DATA TERPISAH --- */
        let finalNamaBos = "";
        let finalPeriode = "";

        const dropdownVal = document.getElementById('dsDanaBos').value;

        if (dropdownVal === 'Lainnya') {
            // Jika Manual: Ambil dari Input Ketikan User
            finalNamaBos = document.getElementById('dsDanaBosManual').value.trim();
            finalPeriode = document.getElementById('dsPeriodeManual').value.trim();
            
            if (!finalNamaBos || !finalPeriode) {
                Swal.fire('Peringatan', 'Nama Dana BOS dan Periode manual wajib diisi!', 'warning');
                return;
            }
        } else {
            // Jika Standar: Ambil Nama dari Dropdown, Tentukan Periode Otomatis
            finalNamaBos = dropdownVal;
            
            // Mapping Periode Otomatis (Sesuai fungsi cekPeriodeBos)
            if (dropdownVal === 'Dana BOS Tahap 1') finalPeriode = "Januari - Juni";
            else if (dropdownVal === 'Dana BOS Tahap 2') finalPeriode = "Juli - Desember";
            else if (dropdownVal === 'Dana BOS Triwulan 1') finalPeriode = "Januari - Maret";
            else if (dropdownVal === 'Dana BOS Triwulan 2') finalPeriode = "April - Juni";
            else if (dropdownVal === 'Dana BOS Triwulan 3') finalPeriode = "Juli - September";
            else if (dropdownVal === 'Dana BOS Triwulan 4') finalPeriode = "Oktober - Desember";
        }

        // Susun Form Data
        const formData = {
          namaSekolah: document.getElementById('dsNamaSekolah').value,
          npsn: document.getElementById('dsNpsn').value, 
          nsm: document.getElementById('dsNsm').value,
          alamat: document.getElementById('dsAlamat').value,
          provinsi: document.getElementById('dsProvinsi').value,
          kabupaten: document.getElementById('dsKabupaten').value,
          kecamatan: document.getElementById('dsKecamatan').value,
          kelurahan: document.getElementById('dsKelurahan').value,
          tempatTTD: document.getElementById('dsTempatTTD').value,
          namaKepala: document.getElementById('dsKepala').value,
          nipKepala: document.getElementById('dsNipKepala').value,
          namaBendahara: document.getElementById('dsBendahara').value,
          nipBendahara: document.getElementById('dsNipBendahara').value,
          noTelp: document.getElementById('dsTelp').value,
          email: document.getElementById('dsEmail').value,
          
          // KIRIM TERPISAH
          danaBOS: finalNamaBos,          
          periodeAnggaran: finalPeriode,  
          
          jumlahAnggaran: cleanRibuan(document.getElementById('dsJumlahAnggaran').value),
          tahunAnggaran: document.getElementById('dsTahun').value
        };

        // Kirim
        toggleLoading(true);
        google.script.run.withSuccessHandler(function(res) {
          toggleLoading(false);
          if (res.status === 'success') {
            Swal.fire('Sukses', 'Data Sekolah berhasil disimpan!', 'success');
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).simpanDataSekolah(token, formData);
      }

      /* --- FUNGSI LOGIKA PERIODE BOS (DIPERBARUI PISAH KOLOM) --- */
      function cekPeriodeBos() {
        const select = document.getElementById('dsDanaBos');
        const info = document.getElementById('infoPeriode');
        const wrapManual = document.getElementById('wrapManualBos');
        
        const inputNama = document.getElementById('dsDanaBosManual');
        const inputPeriode = document.getElementById('dsPeriodeManual');
        
        const val = select.value;
        let teksInfo = "";
        let isManual = false;

        // Set teks info periode untuk pilihan standar
        if (val === 'Dana BOS Tahap 1') teksInfo = "Periode Januari - Juni";
        else if (val === 'Dana BOS Tahap 2') teksInfo = "Periode Juli - Desember";
        else if (val === 'Dana BOS Triwulan 1') teksInfo = "Periode Januari - Maret";
        else if (val === 'Dana BOS Triwulan 2') teksInfo = "Periode April - Juni";
        else if (val === 'Dana BOS Triwulan 3') teksInfo = "Periode Juli - September";
        else if (val === 'Dana BOS Triwulan 4') teksInfo = "Periode Oktober - Desember";
        else if (val === 'Lainnya') {
          teksInfo = ""; // Info kosong jika manual, user ketik sendiri
          isManual = true;
        }

        // Tampilkan teks info kecil di bawah dropdown
        info.innerText = teksInfo;

        // Atur Visibilitas Input Manual
        if (isManual) {
          wrapManual.classList.remove('hidden');
          inputNama.required = true;
          inputPeriode.required = true;
        } else {
          wrapManual.classList.add('hidden');
          inputNama.required = false;
          inputPeriode.required = false;
        }
      }

      /* --- LOGIC URAIAN PEKERJAAN (UPDATE) --- */

      // 1. Update Tabel dengan Tombol Edit
      function loadUraianData() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelUraianBody');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = ''; 
            
            if (res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data uraian.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              const cleanNo = String(item.noBukti).replace(/'/g, ''); 
              
              // PENTING: Kita kirim data ke fungsi editUraian saat tombol diklik
              // Kita gunakan escape character untuk string agar aman
              const btnEdit = `
                <button class="btn btn-sm btn-outline-warning me-1" 
                  onclick="modeEdit('${item.id}', '${cleanNo}', '${item.uraian}')" 
                  title="Edit Data">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              `;

              const btnHapus = `
                <button class="btn btn-sm btn-outline-danger" 
                  onclick="hapusUraian('${item.id}')" 
                  title="Hapus Data">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;

              const row = `
                <tr>
                  <td class="fw-bold text-primary">${cleanNo}</td>
                  <td>${item.uraian}</td>
                  <td style="white-space:nowrap;">
                    ${btnEdit} ${btnHapus}
                  </td>
                </tr>
              `;
              tbody.innerHTML += row;
            });

          } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getUraianList(token);
      }

      // 2. Fungsi Mengaktifkan Mode Edit
      function modeEdit(id, noBukti, uraian) {
        // Isi form dengan data yang dipilih
        document.getElementById('urId').value = id;
        document.getElementById('urNoBukti').value = noBukti;
        document.getElementById('urNama').value = uraian;

        // Ubah Tampilan Tombol
        const btnSimpan = document.getElementById('btnSimpanUraian');
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btnSimpan.classList.remove('btn-primary');
        btnSimpan.classList.add('btn-warning');

        // Munculkan Tombol Batal
        document.getElementById('btnBatalUraian').classList.remove('hidden');

        // Scroll ke atas (ke form) agar user sadar form sudah terisi
        document.getElementById('formUraian').scrollIntoView({ behavior: 'smooth' });
      }

      // 3. Fungsi Batal Edit (Reset Form)
      function batalEdit() {
        document.getElementById('formUraian').reset();
        document.getElementById('urId').value = ''; // Kosongkan ID

        // Kembalikan Tombol ke Mode Tambah
        const btnSimpan = document.getElementById('btnSimpanUraian');
        btnSimpan.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btnSimpan.classList.add('btn-primary');
        btnSimpan.classList.remove('btn-warning');

        // Sembunyikan Tombol Batal
        document.getElementById('btnBatalUraian').classList.add('hidden');
      }

      // 4. Update Logic Submit (Bisa Tambah Baru atau Edit)
      function submitUraian(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('urId').value; // Cek apakah ada ID?
        
        const formData = {
          id: idEdit, // Kirim ID (kosong jika baru, terisi jika edit)
          noBukti: document.getElementById('urNoBukti').value,
          uraian: document.getElementById('urNama').value
        };

        const btn = document.getElementById('btnSimpanUraian');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Proses...';
        btn.disabled = true;

        // LOGIC CABANG: Jika ada ID -> Edit, Jika tidak -> Baru
        if (idEdit) {
          // --- MODE EDIT ---
          google.script.run.withSuccessHandler(function(res) {
            finishSubmit(res, btn, originalText);
          }).editUraianItem(token, formData);
        } else {
          // --- MODE BARU ---
          google.script.run.withSuccessHandler(function(res) {
            finishSubmit(res, btn, originalText);
          }).simpanUraianBaru(token, formData);
        }
      }

      // Helper untuk membersihkan submit handler
      function finishSubmit(res, btn, originalText) {
        btn.innerHTML = originalText;
        btn.disabled = false;

        if (res.status === 'success') {
          batalEdit(); // Reset form & tombol
          loadUraianData(); // Reload tabel
          
          const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
          });
          Toast.fire({ icon: 'success', title: res.message });
        } else {
          Swal.fire('Gagal', res.message, 'error');
        }
      }

      /* --- LOGIC DATA TOKO --- */

      // 1. Load Data
      function loadTokoData() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTokoBody');
        
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if (res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Belum ada data toko.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              const cleanTelp = String(item.telp).replace(/'/g, '');
              
              // Escape string untuk tombol edit agar tidak error jika ada tanda kutip di nama
              const btnEdit = `
                <button class="btn btn-sm btn-outline-warning" 
                  onclick="modeEditToko('${item.id}', '${escapeHtml(item.nama)}', '${escapeHtml(item.jenis)}', '${escapeHtml(item.alamat)}', '${cleanTelp}', '${escapeHtml(item.pemilik)}', '${escapeHtml(item.tempat)}')" 
                  title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              `;
              
              const btnHapus = `
                <button class="btn btn-sm btn-outline-danger" onclick="hapusToko('${item.id}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;

              const row = `
                <tr>
                  <td class="fw-bold text-primary">${item.nama}</td>
                  <td>${item.pemilik}<br><small class="text-muted">${cleanTelp}</small></td>
                  <td><span class="badge bg-light text-dark border">${item.jenis}</span></td>
                  <td>${btnEdit} ${btnHapus}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });
          }
        }).getTokoList(token);
      }

      // 2. Submit (Tambah & Edit)
      function submitToko(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('tkId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('tkNama').value,
          jenis: document.getElementById('tkJenis').value,
          alamat: document.getElementById('tkAlamat').value,
          telp: document.getElementById('tkTelp').value,
          pemilik: document.getElementById('tkPemilik').value,
          tempat: document.getElementById('tkTempat').value
        };

        const btn = document.getElementById('btnSimpanToko');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditToko(); 
            loadTokoData();
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        };

        if (idEdit) {
          google.script.run.withSuccessHandler(handler).editTokoItem(token, formData);
        } else {
          google.script.run.withSuccessHandler(handler).simpanTokoBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditToko(id, nama, jenis, alamat, telp, pemilik, tempat) {
        // Decode kembali karakter html (jika perlu) atau pakai raw value
        // Disini kita isi form
        document.getElementById('tkId').value = id;
        document.getElementById('tkNama').value = unescapeHtml(nama);
        document.getElementById('tkJenis').value = unescapeHtml(jenis);
        document.getElementById('tkAlamat').value = unescapeHtml(alamat);
        document.getElementById('tkTelp').value = telp;
        document.getElementById('tkPemilik').value = unescapeHtml(pemilik);
        document.getElementById('tkTempat').value = unescapeHtml(tempat);

        const btn = document.getElementById('btnSimpanToko');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalToko').classList.remove('hidden');
        
        document.getElementById('formToko').scrollIntoView({ behavior: 'smooth' });
      }

      // 4. Batal Edit
      function batalEditToko() {
        document.getElementById('formToko').reset();
        document.getElementById('tkId').value = '';
        
        const btn = document.getElementById('btnSimpanToko');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan Toko';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalToko').classList.add('hidden');
      }

      // 5. Hapus Toko
      function hapusToko(id) {
        Swal.fire({
          title: 'Hapus Toko?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withSuccessHandler(function(res) {
              if(res.status === 'success') {
                loadTokoData();
                Swal.fire('Terhapus!', 'Data toko dihapus.', 'success');
              }
            }).hapusTokoItem(token, id);
          }
        });
      }

      // --- HELPER UNTUK MENCEGAH ERROR TANDA KUTIP DI HTML ---
      function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
      }

      function unescapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'");
      }

      /* --- LOGIC DATA TUKANG --- */

      // 1. Load Data
      function loadTukangData() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTukangBody');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if (res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data tukang.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              // Escape string agar aman di fungsi onclick
              const btnEdit = `
                <button class="btn btn-sm btn-outline-warning" 
                  onclick="modeEditTukang('${item.id}', '${escapeHtml(item.nama)}', '${escapeHtml(item.alamat)}')" 
                  title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              `;
              
              const btnHapus = `
                <button class="btn btn-sm btn-outline-danger" onclick="hapusTukang('${item.id}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;

              const row = `
                <tr>
                  <td class="fw-bold text-primary">${item.nama}</td>
                  <td>${item.alamat}</td>
                  <td>${btnEdit} ${btnHapus}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });
          }
        }).getTukangList(token);
      }

      // 2. Submit (Tambah & Edit)
      function submitTukang(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('tkgId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('tkgNama').value,
          alamat: document.getElementById('tkgAlamat').value
        };

        const btn = document.getElementById('btnSimpanTukang');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditTukang(); 
            loadTukangData();
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        };

        if (idEdit) {
          google.script.run.withSuccessHandler(handler).editTukangItem(token, formData);
        } else {
          google.script.run.withSuccessHandler(handler).simpanTukangBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditTukang(id, nama, alamat) {
        document.getElementById('tkgId').value = id;
        document.getElementById('tkgNama').value = unescapeHtml(nama);
        document.getElementById('tkgAlamat').value = unescapeHtml(alamat);

        const btn = document.getElementById('btnSimpanTukang');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalTukang').classList.remove('hidden');
        
        document.getElementById('formTukang').scrollIntoView({ behavior: 'smooth' });
      }

      // 4. Batal Edit
      function batalEditTukang() {
        document.getElementById('formTukang').reset();
        document.getElementById('tkgId').value = '';
        
        const btn = document.getElementById('btnSimpanTukang');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalTukang').classList.add('hidden');
      }

      // 5. Hapus Tukang
      function hapusTukang(id) {
        Swal.fire({
          title: 'Hapus Data Tukang?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withSuccessHandler(function(res) {
              if(res.status === 'success') {
                loadTukangData();
                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              }
            }).hapusTukangItem(token, id);
          }
        });
      }

      /* --- LOGIC DATA GURU --- */

      // 1. Load Data
      function loadGuruData() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelGuruBody');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if (res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data guru.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              // Bersihkan tanda kutip dari NIP
              const cleanNip = item.nip ? String(item.nip).replace(/'/g, '') : '-';

              const btnEdit = `
                <button class="btn btn-sm btn-outline-warning" 
                  onclick="modeEditGuru('${item.id}', '${escapeHtml(item.nama)}', '${cleanNip}')" 
                  title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              `;
              
              const btnHapus = `
                <button class="btn btn-sm btn-outline-danger" onclick="hapusGuru('${item.id}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;

              const row = `
                <tr>
                  <td class="fw-bold text-primary">${item.nama}</td>
                  <td>${cleanNip}</td>
                  <td>${btnEdit} ${btnHapus}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });
          }
        }).getGuruList(token);
      }

      // 2. Submit (Tambah & Edit)
      function submitGuru(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('grId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('grNama').value,
          nip: document.getElementById('grNip').value
        };

        const btn = document.getElementById('btnSimpanGuru');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditGuru(); 
            loadGuruData();
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        };

        if (idEdit) {
          google.script.run.withSuccessHandler(handler).editGuruItem(token, formData);
        } else {
          google.script.run.withSuccessHandler(handler).simpanGuruBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditGuru(id, nama, nip) {
        document.getElementById('grId').value = id;
        document.getElementById('grNama').value = unescapeHtml(nama);
        
        // Jika NIP adalah '-', kosongkan form, jika tidak isi dengan nilai
        document.getElementById('grNip').value = (nip === '-') ? '' : nip;

        const btn = document.getElementById('btnSimpanGuru');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalGuru').classList.remove('hidden');
        
        document.getElementById('formGuru').scrollIntoView({ behavior: 'smooth' });
      }

      // 4. Batal Edit
      function batalEditGuru() {
        document.getElementById('formGuru').reset();
        document.getElementById('grId').value = '';
        
        const btn = document.getElementById('btnSimpanGuru');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalGuru').classList.add('hidden');
      }

      // 5. Hapus Guru
      function hapusGuru(id) {
        Swal.fire({
          title: 'Hapus Data Guru?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withSuccessHandler(function(res) {
              if(res.status === 'success') {
                loadGuruData();
                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              }
            }).hapusGuruItem(token, id);
          }
        });
      }

      /* --- LOGIC PENGATURAN KOP SURAT --- */

      // 1. Load Gambar yang tersimpan (dari Server)
      function loadKopSettings() {
        const token = localStorage.getItem('userToken');
        const imgEl = document.getElementById('imgPreview');
        const txtEl = document.getElementById('txtNoImage');
        const btnHapus = document.getElementById('btnHapusKop');

        // Reset tampilan dulu
        imgEl.style.display = 'none';
        txtEl.style.display = 'block';
        btnHapus.classList.add('hidden');

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success' && res.fileId) {
            // Trik menampilkan gambar dari Drive: gunakan endpoint thumbnail
            // atau export=view. Thumbnail lebih aman dari CORS biasanya.
            const imageUrl = "https://drive.google.com/thumbnail?id=" + res.fileId + "&sz=w1000"; 
            
            imgEl.src = imageUrl;
            imgEl.style.display = 'block';
            txtEl.style.display = 'none';
            btnHapus.classList.remove('hidden'); // Munculkan tombol hapus
          }
        }).getKopSurat(token);
      }

      // 2. Preview Gambar Lokal (Sebelum Upload)
      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const imgEl = document.getElementById('imgPreview');
            const txtEl = document.getElementById('txtNoImage');
            
            imgEl.src = e.target.result;
            imgEl.style.display = 'block';
            txtEl.style.display = 'none';
          }
          
          reader.readAsDataURL(input.files[0]);
        }
      }

      // 3. Upload Gambar ke Server
      function uploadKop(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileKop');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        
        // Validasi Ukuran (Misal Max 2MB agar script tidak timeout)
        if (file.size > 2 * 1024 * 1024) {
          Swal.fire('File Terlalu Besar', 'Maksimal ukuran file adalah 2MB', 'warning');
          return;
        }

        const btn = document.getElementById('btnSimpanKop');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengupload...';
        btn.disabled = true;

        // Baca File sebagai Base64
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function() {
          // Ambil string base64 murni (hapus 'data:image/jpeg;base64,')
          const rawBase64 = reader.result.split(',')[1]; 
          const payload = {
            base64: rawBase64,
            mimeType: file.type
          };

          const token = localStorage.getItem('userToken');

          google.script.run.withSuccessHandler(function(res) {
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (res.status === 'success') {
              Swal.fire('Sukses', 'Kop Surat berhasil disimpan!', 'success');
              document.getElementById('formKop').reset();
              loadKopSettings(); // Reload gambar dari server
            } else {
              Swal.fire('Gagal', res.message, 'error');
            }
          }).simpanKopSurat(token, payload);
        };
      }

      // 4. Hapus Kop Surat
      function aksiHapusKop() {
        Swal.fire({
          title: 'Hapus Kop Surat?',
          text: "Kop surat akan dihapus dari sistem.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            
            google.script.run.withSuccessHandler(function(res) {
              if (res.status === 'success') {
                Swal.fire('Terhapus', 'Kop surat telah dihapus', 'success');
                loadKopSettings(); // Refresh tampilan
              } else {
                Swal.fire('Gagal', res.message, 'error');
              }
            }).hapusKopSurat(token);
          }
        });
      }

      /* --- LOGIC TRANSAKSI BELANJA (DIPERBARUI) --- */

      // 1. Tab Switching (Diperbarui untuk load data list)
      function bukaTab(tabName) {
        // Hide semua content
        document.getElementById('tab-content-toko').classList.add('hidden');
        document.getElementById('tab-content-tukang').classList.add('hidden');
        document.getElementById('tab-content-guru').classList.add('hidden'); // Baru
        
        // Reset active buttons
        document.getElementById('tab-btn-toko').classList.remove('active');
        document.getElementById('tab-btn-tukang').classList.remove('active');
        document.getElementById('tab-btn-guru').classList.remove('active'); // Baru

        // Show selected
        document.getElementById('tab-content-' + tabName).classList.remove('hidden');
        document.getElementById('tab-btn-' + tabName).classList.add('active');

        // LOAD DATA LIST TRANSAKSI
        if(tabName === 'toko') loadTransaksiData('TOKO');
        if(tabName === 'tukang') loadTransaksiData('TUKANG');
        if(tabName === 'guru') loadTransaksiData('GURU'); // Baru
      }

      // 2. Load Data List Transaksi (FUNGSI BARU)
      // UPDATE FUNGSI INI
      function loadTransaksiData(tipe) {
        const token = localStorage.getItem('userToken');
        
        // 1. TENTUKAN TARGET TABLE BODY (PERBAIKAN DISINI)
        let targetId;
        if (tipe === 'TOKO') targetId = 'listTransaksiToko';
        else if (tipe === 'TUKANG') targetId = 'listTransaksiTukang';
        else targetId = 'listTransaksiGuru'; // Target untuk Guru

        const tbody = document.getElementById(targetId);

        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
            if (res.status === 'success') {
                tbody.innerHTML = '';
                if(res.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada riwayat transaksi.</td></tr>';
                    return;
                }

                res.data.forEach(item => {
                    const dataJson = encodeURIComponent(JSON.stringify(item));
                    
                    // Tentukan parameter tipe untuk fungsi edit
                    let tipeKecil;
                    if (tipe === 'TOKO') tipeKecil = 'toko';
                    else if (tipe === 'TUKANG') tipeKecil = 'tukang';
                    else tipeKecil = 'guru';

                    const btnDetail = `
                        <button class="btn btn-sm btn-outline-info me-1" 
                            onclick="lihatDetailTransaksi('${dataJson}')" title="Lihat Rincian">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;

                    const btnEdit = `
                        <button class="btn btn-sm btn-outline-warning me-1" 
                            onclick="modeEditTransaksi('${tipeKecil}', '${dataJson}')" title="Edit">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    `;
                    const btnHapus = `
                        <button class="btn btn-sm btn-outline-danger" 
                            onclick="hapusTransaksi('${item.id}', '${tipeKecil}')" title="Hapus">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;

                    // Kolom Ke-3 berbeda untuk Guru (Bukan Pihak Ketiga, tapi Keterangan/Kosong)
                    // Untuk Guru, Pihak Ketiga di DB diisi "Honorarium Guru", jadi kita tampilkan item.pihakKetiga saja atau "-"
                    const displayPihak = item.pihakKetiga; 

                    const row = `
                        <tr>
                            <td>${item.tanggalDisplay}</td> 
                            <td><div class="text-truncate" style="max-width: 200px;" title="${item.uraian}">${item.uraian}</div></td>
                            <td>${displayPihak}</td> 
                            <td class="fw-bold text-success">${formatRupiahJS(item.total)}</td>
                            <td style="white-space: nowrap;">${btnDetail} ${btnEdit} ${btnHapus}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
        }).getTransaksiList(token, tipe);
      }

      // 3. Mode Edit Transaksi (FUNGSI BARU & KOMPLEKS)
      function modeEditTransaksi(tipe, encodedData) {
        // 1. Decode Data JSON
        const data = JSON.parse(decodeURIComponent(encodedData));
        
        // 2. Mapping ID Form Header & Button
        let formId, tableId, btnSimpanId, btnBatalId;
        
        if (tipe === 'toko') {
          formId = 'formBelanjaToko';
          tableId = 'tabelItemToko';
          btnSimpanId = 'btnSimpanTokoTrans';
          btnBatalId = 'btnBatalTokoTrans';
          
          // Isi Header Toko
          document.getElementById('trTokoId').value = data.id;
          document.getElementById('trTokoTanggal').value = data.tanggal;
          setSelectValue('trTokoUraian', data.uraian);
          setSelectValue('trTokoNama', data.pihakKetiga);
          setSelectValue('trTokoPemesan', data.pemesan);
          
        } else if (tipe === 'tukang') {
          formId = 'formBelanjaTukang';
          tableId = 'tabelItemTukang';
          btnSimpanId = 'btnSimpanTukangTrans';
          btnBatalId = 'btnBatalTukangTrans';
          
          // Isi Header Tukang
          document.getElementById('trTukangId').value = data.id;
          document.getElementById('trTukangTanggal').value = data.tanggal;
          setSelectValue('trTukangUraian', data.uraian);
          setSelectValue('trTukangNama', data.pihakKetiga);
          setSelectValue('trTukangPemesan', data.pemesan);
                
        } else if (tipe === 'guru') {
          formId = 'formBelanjaGuru';
          tableId = 'tabelItemGuru';
          btnSimpanId = 'btnSimpanGuruTrans';
          btnBatalId = 'btnBatalGuruTrans';
          
          // Isi Header Guru
          document.getElementById('trGuruId').value = data.id;
          document.getElementById('trGuruTanggal').value = data.tanggal;
          setSelectValue('trGuruUraian', data.uraian);
          
          if(data.pihakKetiga === '-' || data.pihakKetiga === 'Honorarium Guru') {
              document.getElementById('trGuruKeterangan').value = '';
          } else {
              document.getElementById('trGuruKeterangan').value = data.pihakKetiga;
          }
        }

        // 3. Reset & Gambar Ulang Tabel Rincian
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = ''; // Kosongkan tabel dulu

        if (data.items && data.items.length > 0) {
          data.items.forEach(item => {
            const rowId = new Date().getTime() + Math.random();
            let colNamaInput = '';

            // --- LOGIKA KOLOM NAMA (Dropdown Guru vs Input Biasa) ---
            if (tipe === 'guru') {
              let isManual = true; 
              if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
                  cacheDataGuru.forEach(g => {
                      if (g.nama.trim() === item.nama.trim()) isManual = false;
                  });
              }

              if (isManual) {
                  const val = String(item.nama).replace(/"/g, '&quot;');
                  colNamaInput = `
                    <div class="input-group">
                      <input type="text" class="form-control item-nama" value="${val}" placeholder="Nama Guru (Manual)">
                      <button class="btn btn-outline-secondary" type="button" onclick="resetKeDropdown(this)" title="Kembali ke Pilihan">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  `;
              } else {
                  let opts = '<option value="">-- Pilih Guru --</option>';
                  opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
                  cacheDataGuru.forEach(g => {
                      const isSelected = (g.nama.trim() === item.nama.trim()) ? 'selected' : '';
                      const val = String(g.nama).replace(/"/g, '&quot;');
                      opts += `<option value="${val}" ${isSelected}>${g.nama}</option>`;
                  });
                  colNamaInput = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
              }
            } else {
              // Input Biasa (Toko/Tukang)
              const val = String(item.nama).replace(/"/g, '&quot;');
              colNamaInput = `<input type="text" class="form-control item-nama" value="${val}" placeholder="Nama Barang">`;
            }

            // --- LOGIKA FORMAT HARGA (Titik Ribuan) ---
            // Pastikan harga diformat dengan titik saat ditampilkan kembali
            const hargaTampil = formatRibuanInput(item.harga);

            // --- TEMPLATE BARIS (HARUS 6 KOLOM TD) ---
            const row = `
              <tr id="row-${rowId}">
                <td>${colNamaInput}</td>
                
                <td>
                  <input type="number" class="form-control item-vol" value="${item.vol}" min="1" oninput="hitungBaris(this, '${tipe}')">
                </td>
                
                <td>
                  <input type="text" class="form-control item-sat" value="${item.sat || ''}" placeholder="Satuan">
                </td>
                
                <td>
                  <input type="text" class="form-control item-harga" value="${hargaTampil}" oninput="hitungBaris(this, '${tipe}')">
                </td>
                
                <td>
                  <input type="text" class="form-control item-jumlah-display" readonly value="${formatRupiahJS(item.jumlah)}">
                  <input type="hidden" class="item-jumlah-value" value="${item.jumlah}">
                </td>
                
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="hapusBaris(this, '${tipe}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
            
            tbody.insertAdjacentHTML('beforeend', row);
          });
        } else {
          tambahBaris(tipe);
        }

        // 4. Hitung Ulang & Update UI
        hitungTotalSemua(tipe);

        const btnSimpan = document.getElementById(btnSimpanId);
        const btnBatal = document.getElementById(btnBatalId);
        
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btnSimpan.classList.remove('btn-success');
        btnSimpan.classList.add('btn-warning');
        
        btnBatal.classList.remove('hidden');

        document.getElementById(formId).scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Helper untuk set value select yang mungkin mengandung karakter spesial
      function setSelectValue(id, value) {
          const select = document.getElementById(id);
          // Cari option yang text/valuenya cocok
          for (let i = 0; i < select.options.length; i++) {
              // Decode HTML entities jika perlu, atau bandingkan langsung
              if (select.options[i].value === value || select.options[i].text === value) {
                  select.selectedIndex = i;
                  break;
              }
          }
      }

      // 4. Batal Edit (Reset Form & Mode)
      function batalEditTransaksi(tipe) {
        // 1. Reset Isi Form & Tabel
        resetFormTransaksi(tipe);

        // 2. Mapping ID Elemen berdasarkan Tipe
        let idHidden, btnSimpanId, btnBatalId;

        if (tipe === 'toko') {
          idHidden = 'trTokoId';
          btnSimpanId = 'btnSimpanTokoTrans';
          btnBatalId = 'btnBatalTokoTrans';
        } else if (tipe === 'tukang') {
          idHidden = 'trTukangId';
          btnSimpanId = 'btnSimpanTukangTrans';
          btnBatalId = 'btnBatalTukangTrans';
        } else { // guru
          idHidden = 'trGuruId';
          btnSimpanId = 'btnSimpanGuruTrans';
          btnBatalId = 'btnBatalGuruTrans';
        }

        // 3. Kosongkan ID Hidden (Indikator Mode Edit)
        document.getElementById(idHidden).value = '';

        // 4. Kembalikan Tombol Simpan ke Awal (Hijau)
        const btnSimpan = document.getElementById(btnSimpanId);
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Transaksi';
        btnSimpan.classList.remove('btn-warning');
        btnSimpan.classList.add('btn-success');
        btnSimpan.disabled = false;

        // 5. Sembunyikan Tombol Batal
        const btnBatal = document.getElementById(btnBatalId);
        btnBatal.classList.add('hidden');
      }

      // 5. Hapus Transaksi
      function hapusTransaksi(id, tipe) {
        Swal.fire({
          title: 'Hapus Transaksi?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withSuccessHandler(function(res) {
              if(res.status === 'success') {
                Swal.fire('Terhapus!', 'Transaksi dihapus.', 'success');
                loadTransaksiData(tipe); // Reload tabel
              } else {
                Swal.fire('Gagal', res.message, 'error');
              }
            }).hapusTransaksiItem(token, id);
          }
        });
      }

      // --- LOGIC SIMPAN YANG DIPERBARUI (HANDLE EDIT & BARU) ---
      function simpanTransaksi(tipe) {
        // 1. Tentukan ID Elemen berdasarkan Tipe Tab
        let tableId, idHidden, btnId;

        if (tipe === 'toko') {
          tableId = 'tabelItemToko';
          idHidden = 'trTokoId';
          btnId = 'btnSimpanTokoTrans';
        } else if (tipe === 'tukang') {
          tableId = 'tabelItemTukang';
          idHidden = 'trTukangId';
          btnId = 'btnSimpanTukangTrans';
        } else { // guru
          tableId = 'tabelItemGuru';
          idHidden = 'trGuruId';
          btnId = 'btnSimpanGuruTrans';
        }

        // 2. Ambil Baris Data & ID Edit (jika ada)
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const idEdit = document.getElementById(idHidden).value;

        // Validasi: Pastikan ada item barang/jasa/guru yang diinput
        if (rows.length === 0) {
          Swal.fire('Eror', 'Belum ada rincian yang dimasukkan!', 'error');
          return;
        }

        // 3. Ambil Data Header Form (Tanggal, Uraian, dll)
        let tgl, uraian, pihak, pemesan, total;

        if (tipe === 'guru') {
          // Logika Khusus Tab Honor Guru
          tgl = document.getElementById('trGuruTanggal').value;
          uraian = document.getElementById('trGuruUraian').value;
          
          // PERBAIKAN DISINI: Ambil dari input Keterangan
          // Jika kosong, isi tanda strip (-)
          const ketVal = document.getElementById('trGuruKeterangan').value;
          pihak = ketVal ? ketVal : "-"; 
          
          pemesan = "-"; // Pemesan tetap strip karena rincian nama ada di tabel
          total = document.getElementById('trGuruTotalValue').value;
        } else {
          // Logika Umum (Toko & Tukang)
          const prefix = (tipe === 'toko') ? 'trToko' : 'trTukang';
          
          tgl = document.getElementById(prefix + 'Tanggal').value;
          uraian = document.getElementById(prefix + 'Uraian').value;
          pihak = document.getElementById(prefix + 'Nama').value;     // Nama Toko / Tukang
          pemesan = document.getElementById(prefix + 'Pemesan').value; // Nama Guru Pemesan
          total = document.getElementById(prefix + 'TotalValue').value;
        }

        // 4. Validasi Form Header
        if (!tgl || !uraian) {
          Swal.fire('Data Belum Lengkap', 'Harap lengkapi Tanggal dan Uraian!', 'warning');
          return;
        }
        
        // Validasi tambahan khusus Toko & Tukang (Pihak Ketiga & Pemesan wajib diisi)
        if (tipe !== 'guru' && (!pihak || !pemesan)) {
          Swal.fire('Data Belum Lengkap', 'Pihak Ketiga dan Pemesan wajib diisi!', 'warning');
          return;
        }

        // 5. Ambil Rincian Item dari Tabel
        let items = [];
        rows.forEach(row => {
          items.push({
            nama: row.querySelector('.item-nama').value, 
            vol: row.querySelector('.item-vol').value,
            sat: row.querySelector('.item-sat').value,
            
            // --- PERUBAHAN PENTING DISINI ---
            // Bersihkan titik sebelum disimpan ke database
            harga: cleanRibuan(row.querySelector('.item-harga').value),
            
            jumlah: row.querySelector('.item-jumlah-value').value
          });
        });

        // 6. Siapkan Payload Data
        const payload = {
          id: idEdit, // Kosong jika Baru, Terisi jika Edit
          tipe: tipe.toUpperCase(), // 'TOKO', 'TUKANG', atau 'GURU'
          tanggal: tgl,
          uraian: uraian,
          pihakKetiga: pihak,
          pemesan: pemesan,
          items: items,
          total: total
        };

        // 7. Proses Simpan ke Server (Google Apps Script)
        const token = localStorage.getItem('userToken');
        const btnSimpan = document.getElementById(btnId);
        const txtAsli = btnSimpan.innerHTML;
        
        // Ubah tombol jadi loading
        btnSimpan.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...';
        btnSimpan.disabled = true;

        const handleResult = function(res) {
          // Kembalikan tombol
          btnSimpan.innerHTML = txtAsli;
          btnSimpan.disabled = false;
          
          if (res.status === 'success') {
            Swal.fire({
              icon: 'success',
              title: 'Berhasil!',
              text: res.message,
              showConfirmButton: false,
              timer: 1500
            });
            
            // Reset Form & Reload Tabel Riwayat
            batalEditTransaksi(tipe); 
            loadTransaksiData(tipe.toUpperCase());
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        };

        // Percabangan: Panggil fungsi Edit atau Simpan Baru
        if (idEdit) {
          google.script.run.withSuccessHandler(handleResult).editTransaksiItem(token, payload);
        } else {
          google.script.run.withSuccessHandler(handleResult).simpanTransaksiBaru(token, payload);
        }
      }

      // 2. Load Dropdown Options
      function loadTransaksiOptions() {
        const token = localStorage.getItem('userToken');
        
        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            const d = res.data;
            
            // 1. SIMPAN DATA KE CACHE
            cacheDataGuru = d.guru; 

            // Helper isi select header
            const isiSelect = (id, data) => {
              const el = document.getElementById(id);
              if(!el) return;
              const currentVal = el.value; 
              
              el.innerHTML = '<option value="">-- Pilih --</option>';
              data.forEach(item => {
                const val = String(item.nama).replace(/"/g, '&quot;'); 
                el.innerHTML += `<option value="${val}">${item.nama}</option>`;
              });
              
              if(currentVal) el.value = currentVal;
            };
            
            const uraianOps = d.uraian.map(u => ({nama: u.uraian}));
            
            // Isi Dropdown Header
            isiSelect('trTokoUraian', uraianOps);
            isiSelect('trTokoNama', d.toko);
            isiSelect('trTokoPemesan', d.guru);

            isiSelect('trTukangUraian', uraianOps);
            isiSelect('trTukangNama', d.tukang);
            isiSelect('trTukangPemesan', d.guru);
            
            isiSelect('trGuruUraian', uraianOps); 

            // 2. UPDATE DROPDOWN DI TABEL RINCIAN GURU
            const dropdownsDiTabel = document.querySelectorAll('#tabelItemGuru .item-nama');
            
            dropdownsDiTabel.forEach(select => {
              // Cek apakah elemen ini adalah SELECT (karena bisa jadi sudah berubah jadi INPUT TEXT)
              if (select.tagName === 'SELECT') {
                  const valSebelumnya = select.value;
                  
                  // Susun Opsi: Default -> LAINNYA -> Data Guru
                  let opts = '<option value="">-- Pilih Guru --</option>';
                  opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>'; // MENU BARU
                  
                  cacheDataGuru.forEach(g => {
                    const val = String(g.nama).replace(/"/g, '&quot;');
                    opts += `<option value="${val}">${g.nama}</option>`;
                  });
                  
                  select.innerHTML = opts;
                  if(valSebelumnya) select.value = valSebelumnya;
              }
            });

          }
        }).getAllOptions(token);
      }

      // --- FUNGSI GANTI DROPDOWN JADI INPUT TEXT (DENGAN TOMBOL X) ---
      function cekInputManual(selectElement) {
        if (selectElement.value === 'MANUAL_INPUT') {
          const parentTd = selectElement.parentElement;
          
          // Kita gunakan fitur Input Group Bootstrap
          // Class 'item-nama' tetap wajib ada di input agar terbaca saat simpan
          const htmlInputGroup = `
            <div class="input-group">
              <input type="text" class="form-control item-nama" placeholder="Ketik Nama Guru..." autofocus>
              <button class="btn btn-outline-secondary" type="button" onclick="resetKeDropdown(this)" title="Kembali ke Pilihan">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          
          parentTd.innerHTML = htmlInputGroup;
          
          // Otomatis fokus ke input
          parentTd.querySelector('input').focus();
        }
      }

      // --- FUNGSI KEMBALIKAN KE DROPDOWN ---
      function resetKeDropdown(btnElement) {
        // Cari elemen TD pembungkusnya
        const parentTd = btnElement.closest('td');
        
        // Susun Ulang Option Dropdown dari Cache
        let opts = '<option value="">-- Pilih Guru --</option>';
        opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
        
        if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
          cacheDataGuru.forEach(g => {
            const val = String(g.nama).replace(/"/g, '&quot;');
            opts += `<option value="${val}">${g.nama}</option>`;
          });
        }
        
        // Kembalikan ke bentuk Select
        const selectHtml = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
        parentTd.innerHTML = selectHtml;
      }

      // 3. Tambah Baris Dinamis
      function tambahBaris(tipe) {
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 
                        (tipe === 'tukang') ? 'tabelItemTukang' : 'tabelItemGuru';
        
        const tbody = document.getElementById(tableId).querySelector('tbody');
        const rowId = new Date().getTime() + Math.random();
        
        let colPertamaHtml = '';

        if (tipe === 'guru') {
          // 1. Susun Opsi Default
          let optionsGuru = '<option value="">-- Pilih Guru --</option>';
          // 2. Tambah Opsi Lainnya
          optionsGuru += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
          
          // 3. Isi Data Guru (jika cache sudah ready)
          if (typeof cacheDataGuru !== 'undefined' && cacheDataGuru.length > 0) {
            cacheDataGuru.forEach(g => {
              const val = String(g.nama).replace(/"/g, '&quot;');
              optionsGuru += `<option value="${val}">${g.nama}</option>`;
            });
          }
          
          // 4. Tambahkan event onchange="cekInputManual(this)"
          colPertamaHtml = `<select class="form-select item-nama" onchange="cekInputManual(this)">${optionsGuru}</select>`;
        } else {
          colPertamaHtml = `<input type="text" class="form-control item-nama" placeholder="Nama Barang/Jasa">`;
        }
        
        const row = `
          <tr id="row-${rowId}">
            <td>${colPertamaHtml}</td>
            <td><input type="number" class="form-control item-vol" value="1" min="1" oninput="hitungBaris(this, '${tipe}')"></td>
            <td><input type="text" class="form-control item-sat" placeholder="Bln/Keg"></td>
            <td><input type="text" class="form-control item-harga" placeholder="0" oninput="hitungBaris(this, '${tipe}')"></td>
            <td>
              <input type="text" class="form-control item-jumlah-display" readonly value="0">
              <input type="hidden" class="item-jumlah-value" value="0">
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="hapusBaris(this, '${tipe}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
        
        tbody.insertAdjacentHTML('beforeend', row);
      }

      // 4. Hapus Baris
      function hapusBaris(btn, tipe) {
        const row = btn.closest('tr');
        row.remove();
        hitungTotalSemua(tipe); // Recalculate total
      }

      // 5. Kalkulasi Per Baris (Vol * Harga) - DENGAN FORMAT RIBUAN
      function hitungBaris(input, tipe) {
        const row = input.closest('tr');
        
        // A. Jika yang diketik adalah kolom Harga, format tampilannya
        if (input.classList.contains('item-harga')) {
          // Simpan posisi kursor (opsional, agar nyaman saat edit di tengah)
          // Untuk simpelnya, kita langsung format value-nya
          input.value = formatRibuanInput(input.value);
        }

        // B. Ambil Nilai untuk Kalkulasi (Gunakan cleanRibuan)
        const vol = parseFloat(row.querySelector('.item-vol').value) || 0;
        
        // Ambil teks harga (misal: "15.000"), bersihkan jadi 15000
        const hargaStr = row.querySelector('.item-harga').value;
        const harga = cleanRibuan(hargaStr); 
        
        const total = vol * harga;
        
        // Tampilkan format Rupiah di input readonly (Total Jumlah)
        row.querySelector('.item-jumlah-display').value = formatRupiahJS(total);
        // Simpan nilai asli di hidden input
        row.querySelector('.item-jumlah-value').value = total;
        
        hitungTotalSemua(tipe);
      }

      // 6. Hitung Grand Total
      function hitungTotalSemua(tipe) {
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 
                        (tipe === 'tukang') ? 'tabelItemTukang' : 'tabelItemGuru';
                        
        const inputs = document.querySelectorAll(`#${tableId} .item-jumlah-value`);
        
        let grandTotal = 0;
        inputs.forEach(el => { grandTotal += parseFloat(el.value) || 0; });

        // Update Tampilan Total Bawah
        let elDisplay, elValue;
        if(tipe === 'toko') {
          elDisplay = 'trTokoTotalDisplay'; elValue = 'trTokoTotalValue';
        } else if (tipe === 'tukang') {
          elDisplay = 'trTukangTotalDisplay'; elValue = 'trTukangTotalValue';
        } else {
          elDisplay = 'trGuruTotalDisplay'; elValue = 'trGuruTotalValue';
        }
        
        document.getElementById(elDisplay).innerText = formatRupiahJS(grandTotal);
        document.getElementById(elValue).value = grandTotal;
      }

      // Helper Format Rupiah JS
      function formatRupiahJS(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }

      // Helper: Reset Form
      function resetFormTransaksi(tipe) {
        let formId, tableId, dispId, valId;

        // Mapping ID Form & Total
        if (tipe === 'toko') {
          formId='formBelanjaToko'; tableId='tabelItemToko'; dispId='trTokoTotalDisplay'; valId='trTokoTotalValue';
        } else if (tipe === 'tukang') {
          formId='formBelanjaTukang'; tableId='tabelItemTukang'; dispId='trTukangTotalDisplay'; valId='trTukangTotalValue';
        } else { // GURU
          formId='formBelanjaGuru'; tableId='tabelItemGuru'; dispId='trGuruTotalDisplay'; valId='trGuruTotalValue';
        }
        
        // 1. Reset Form Header
        document.getElementById(formId).reset();

        // TAMBAHAN KHUSUS: Pastikan Textarea Keterangan Guru bersih
        if(tipe === 'guru') {
          document.getElementById('trGuruKeterangan').value = '';
        }
        
        // 2. Kosongkan Tabel Rincian
        document.querySelector(`#${tableId} tbody`).innerHTML = '';
        
        // 3. Reset Angka Total
        document.getElementById(dispId).innerText = 'Rp 0';
        document.getElementById(valId).value = 0;
        
        // 4. Tambahkan 1 Baris Kosong Default
        // Ini penting agar dropdown guru / input manual ter-render ulang dengan benar
        tambahBaris(tipe);
      }

      // --- FUNGSI POPUP DETAIL TRANSAKSI ---
      function lihatDetailTransaksi(encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        
        // 1. Buat Header HTML untuk Info Dasar
        let htmlContent = `
          <div class="text-start mb-3" style="font-size: 0.9rem;">
            <table class="table table-borderless table-sm mb-0">
              <tr>
                <td width="30%" class="fw-bold">Tanggal</td>
                <td>: ${data.tanggalDisplay}</td> 
              </tr>
              <tr>
                <td class="fw-bold">Uraian</td>
                <td>: ${data.uraian}</td>
              </tr>
              <tr>
                <td class="fw-bold">Pihak Ketiga</td>
                <td>: ${data.pihakKetiga} (Tipe: ${data.tipe})</td>
              </tr>
              <tr>
                <td class="fw-bold">Pemesan</td>
                <td>: ${data.pemesan}</td>
              </tr>
            </table>
          </div>
        `;

        // 2. Buat Tabel Rincian Barang
        htmlContent += `
          <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle" style="font-size: 0.85rem;">
              <thead class="table-light text-center">
                <tr>
                  <th>Nama Barang / Item</th>
                  <th width="10%">Vol</th>
                  <th width="10%">Sat</th>
                  <th width="20%">Harga</th>
                  <th width="25%">Jumlah</th>
                </tr>
              </thead>
              <tbody>
        `;

        // Loop item barang
        if (data.items && data.items.length > 0) {
          data.items.forEach(item => {
            htmlContent += `
              <tr>
                <td class="text-start">${item.nama}</td>
                <td class="text-center">${item.vol}</td>
                <td class="text-center">${item.sat}</td>
                <td class="text-end">${formatRupiahJS(item.harga)}</td>
                <td class="text-end fw-bold">${formatRupiahJS(item.jumlah)}</td>
              </tr>
            `;
          });
        } else {
          htmlContent += `<tr><td colspan="5" class="text-center text-muted">Tidak ada rincian item.</td></tr>`;
        }

        // Tutup Tabel & Tambah Total
        htmlContent += `
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="4" class="text-end fw-bold">TOTAL KESELURUHAN</td>
                  <td class="text-end fw-bold fs-6 text-primary">${formatRupiahJS(data.total)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;

        // 3. Tampilkan dengan SweetAlert
        Swal.fire({
          title: 'Rincian Transaksi',
          html: htmlContent,
          width: '600px',
          showCloseButton: true,
          showConfirmButton: false, // Hanya tombol close X diatas atau klik luar
          focusConfirm: false
        });
      }

      /* --- LOGIKA MANAJEMEN NOMOR SURAT --- */

      // 1. Tab Switching & Load Data
      function bukaTabSurat(tipe) {
        // Atur Class Active pada Tab
        document.getElementById('tab-surat-toko').classList.remove('active');
        document.getElementById('tab-surat-tukang').classList.remove('active');
        
        if (tipe === 'toko') {
          document.getElementById('tab-surat-toko').classList.add('active');
        } else {
          document.getElementById('tab-surat-tukang').classList.add('active');
        }

        loadDataSurat(tipe);
      }

      // 2. Load Data List
      function loadDataSurat(tipe) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelSuratBody');
        
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data transaksi...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if(res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Belum ada data transaksi ' + tipe + '.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              // Cek Kelengkapan Surat
              const s = item.dataSurat; // Object surat dari backend
              let statusBadge = '<span class="badge bg-secondary">Belum Diatur</span>';
              
              // Logika sederhana: Jika ada surat permintaan & pembayaran terisi, dianggap "Diproses"
              // Jika null, berarti belum pernah disimpan
              if (s) {
                if (s.permintaan && s.baPembayaran) {
                    statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
                } else {
                    statusBadge = '<span class="badge bg-warning text-dark">Sebagian</span>';
                }
              }

              const dataJson = encodeURIComponent(JSON.stringify(item));
              const tipeUpper = tipe.toUpperCase(); // 'TOKO' atau 'TUKANG'

              const btnAksi = `
                <button class="btn btn-sm btn-outline-primary" 
                  onclick="bukaModalSurat('${tipe}', '${dataJson}')">
                  <i class="fas fa-edit me-1"></i> Kelola Dokumen
                </button>
              `;

              const row = `
                <tr>
                  <td>${item.tanggalDisplay}</td> <td><div class="text-truncate" style="max-width:250px;">${item.uraian}</div></td>
                  <td>${item.pihakKetiga}</td>
                  <td>${statusBadge}</td>
                  <td>${btnAksi}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });

          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe.toUpperCase()); 
        // Kita reuse fungsi getTransaksiList yang sudah diupdate
      }

      // 3. Buka Modal & Isi Form
      let modalSuratBS = null; // Instance Bootstrap Modal

      function bukaModalSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const s = data.dataSurat || {}; // Ambil data surat jika ada, atau object kosong

        // Set Hidden ID
        document.getElementById('suratTransId').value = data.id;
        document.getElementById('suratTransTipe').value = tipe;

        // Reset Form
        document.getElementById('formInputSurat').reset();

        // Kondisional Field (Penawaran hanya untuk Toko)
        const wrapPenawaran = document.getElementById('wrapSuratPenawaran');
        if (tipe === 'toko') {
          wrapPenawaran.classList.remove('hidden');
          // Set Value Penawaran
          document.getElementById('noSuratPenawaran').value = s.penawaran || '';
        } else {
          wrapPenawaran.classList.add('hidden');
          document.getElementById('noSuratPenawaran').value = ''; 
        }

        // Isi Value Field Lainnya
        document.getElementById('noSuratPermintaan').value = s.permintaan || '';
        document.getElementById('noBaPemeriksaan').value = s.baPemeriksaan || '';
        document.getElementById('noBaSerahTerima').value = s.baSerahTerima || '';
        document.getElementById('noBaPembayaran').value = s.baPembayaran || '';

        // Tampilkan Modal
        const el = document.getElementById('modalSurat');
        modalSuratBS = new bootstrap.Modal(el);
        modalSuratBS.show();
      }

      // 4. Simpan Data Surat
      function simpanSurat(e) {
        e.preventDefault();
        
        const tipe = document.getElementById('suratTransTipe').value;
        const id = document.getElementById('suratTransId').value;

        // Ambil Data Form
        const dataSurat = {
          permintaan: document.getElementById('noSuratPermintaan').value,
          penawaran: document.getElementById('noSuratPenawaran').value, // Jika tukang, ini akan kosong/diabaikan
          baPemeriksaan: document.getElementById('noBaPemeriksaan').value,
          baSerahTerima: document.getElementById('noBaSerahTerima').value,
          baPembayaran: document.getElementById('noBaPembayaran').value
        };

        const payload = {
          id: id,
          dataSurat: dataSurat
        };

        // Loading Button
        const btn = document.getElementById('btnSimpanSurat');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const token = localStorage.getItem('userToken');

        google.script.run.withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            // Tutup Modal
            if(modalSuratBS) modalSuratBS.hide();
            
            Swal.fire({
              icon: 'success', title: 'Tersimpan', 
              text: 'Data nomor surat berhasil diperbarui.',
              timer: 1500, showConfirmButton: false
            });

            // Reload Tabel
            loadDataSurat(tipe);

          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).simpanDataSurat(token, payload);
      }

      /* --- LOGIKA MANAJEMEN TANGGAL SURAT --- */

      // 1. Tab Switching
      function bukaTabTanggal(tipe) {
        document.getElementById('tab-tgl-toko').classList.remove('active');
        document.getElementById('tab-tgl-tukang').classList.remove('active');
        
        if (tipe === 'toko') {
          document.getElementById('tab-tgl-toko').classList.add('active');
        } else {
          document.getElementById('tab-tgl-tukang').classList.add('active');
        }

        loadDataTanggal(tipe);
      }

      // 2. Load Data List untuk Tanggal
      function loadDataTanggal(tipe) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTanggalBody');
        
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if(res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Belum ada data transaksi ' + tipe + '.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              const t = item.dataTanggal; // Object tanggal dari backend
              let statusBadge = '<span class="badge bg-secondary">Belum Diatur</span>';
              
              // Logika Status: Jika BA Pembayaran ada isinya -> Selesai
              if (t && t.baPembayaran) {
                statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
              } else if (t) {
                statusBadge = '<span class="badge bg-warning text-dark">Sebagian</span>';
              }

              const dataJson = encodeURIComponent(JSON.stringify(item));
              
              const btnAksi = `
                <button class="btn btn-sm btn-outline-success" 
                  onclick="bukaModalTanggal('${tipe}', '${dataJson}')">
                  <i class="fas fa-calendar-check me-1"></i> Atur Tanggal
                </button>
              `;

              const row = `
                <tr>
                  <td>${item.tanggalDisplay}</td> <td><div class="text-truncate" style="max-width:250px;">${item.uraian}</div></td>
                  <td>${item.pihakKetiga}</td>
                  <td>${statusBadge}</td>
                  <td>${btnAksi}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });

          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe.toUpperCase());
      }

      // 3. Buka Modal Tanggal (UPDATE: Dengan Validasi Tanggal Minimum)
      let modalTanggalBS = null;

      function bukaModalTanggal(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const t = data.dataTanggal || {}; 

        // Set ID Hidden
        document.getElementById('tglTransId').value = data.id;
        document.getElementById('tglTransTipe').value = tipe;

        // Reset Form
        document.getElementById('formInputTanggal').reset();

        // --- LOGIKA VALIDASI TANGGAL ---
        // Ambil Tanggal Transaksi (Format YYYY-MM-DD dari backend)
        const minDate = data.tanggal; 
        
        // Daftar ID Input yang ingin dibatasi
        const dateFields = [
          'tglSuratPenawaran', 
          'tglBaPemeriksaan', 
          'tglBaSerahTerima', 
          'tglBaPembayaran'
        ];

        // Loop setiap field untuk set atribut 'min'
        dateFields.forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            // Set batas minimum pemilihan tanggal
            el.setAttribute('min', minDate);
            
            // Opsional: Tambahkan event listener jika user mengetik manual (bukan klik kalender)
            el.onchange = function() {
              if(this.value && this.value < minDate) {
                Swal.fire('Tanggal Tidak Valid', 'Tanggal tidak boleh kurang dari tanggal transaksi (' + minDate + ')', 'warning');
                this.value = minDate; // Reset ke tanggal minimal
              }
            };
          }
        });

        // -------------------------------

        // Field Kondisional (Penawaran)
        const wrapPenawaran = document.getElementById('wrapTglPenawaran');
        if (tipe === 'toko') {
          wrapPenawaran.classList.remove('hidden');
          document.getElementById('tglSuratPenawaran').value = t.penawaran || '';
        } else {
          wrapPenawaran.classList.add('hidden');
          document.getElementById('tglSuratPenawaran').value = '';
        }

        // Isi Tanggal Permintaan (Readonly & Sesuai Transaksi)
        document.getElementById('tglSuratPermintaan').value = data.tanggal;

        // Isi Field Lainnya (jika ada di database)
        document.getElementById('tglBaPemeriksaan').value = t.baPemeriksaan || '';
        document.getElementById('tglBaSerahTerima').value = t.baSerahTerima || '';
        document.getElementById('tglBaPembayaran').value = t.baPembayaran || '';

        // Tampilkan Modal
        const el = document.getElementById('modalTanggal');
        modalTanggalBS = new bootstrap.Modal(el);
        modalTanggalBS.show();
      }

      // 4. Simpan Data Tanggal
      function simpanTanggal(e) {
        e.preventDefault();
        
        const tipe = document.getElementById('tglTransTipe').value;
        const id = document.getElementById('tglTransId').value;

        // Ambil Data Form
        const dataTanggal = {
          permintaan: document.getElementById('tglSuratPermintaan').value, // Ambil dari input readonly
          penawaran: document.getElementById('tglSuratPenawaran').value,
          baPemeriksaan: document.getElementById('tglBaPemeriksaan').value,
          baSerahTerima: document.getElementById('tglBaSerahTerima').value,
          baPembayaran: document.getElementById('tglBaPembayaran').value
        };

        const payload = {
          id: id,
          dataTanggal: dataTanggal
        };

        const btn = document.getElementById('btnSimpanTanggal');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const token = localStorage.getItem('userToken');

        google.script.run.withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            if(modalTanggalBS) modalTanggalBS.hide();
            
            Swal.fire({
              icon: 'success', title: 'Tersimpan', 
              text: 'Data tanggal dokumen berhasil diperbarui.',
              timer: 1500, showConfirmButton: false
            });

            loadDataTanggal(tipe);

          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).simpanTanggalSurat(token, payload);
      }

      /* --- HELPER FORMAT ANGKA INPUT --- */

      // Mengubah "10000" menjadi "10.000"
      function formatRibuanInput(angka) {
        if (!angka && angka !== 0) return '';
        // Hapus karakter selain angka
        let raw = String(angka).replace(/[^\d]/g, '');
        if(!raw) return '';
        // Format jadi 1.000.000
        return new Intl.NumberFormat('id-ID').format(raw);
      }

      // Mengubah "10.000" menjadi angka murni 10000 (untuk kalkulasi)
      function cleanRibuan(str) {
        if (!str) return 0;
        // Hapus tanda titik, lalu jadikan Float/Int
        return parseFloat(String(str).replace(/\./g, '')) || 0;
      }

      /* --- LOGIKA DASHBOARD (UPDATE LENGKAP) --- */

      function loadDashboardStats() {
        const token = localStorage.getItem('userToken');
        
        document.getElementById('dashAnggaran').innerText = '...';
        
        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            const d = res.data;
            const p = d.profile || {}; // Data Profil Sekolah

            // 1. Render Statistik (Sama seperti sebelumnya)
            const anggaran = parseFloat(d.anggaran) || 0;
            const pengeluaran = parseFloat(d.pengeluaran) || 0;
            const jmlTrans = d.jumlahTransaksi || 0;
            const sisa = anggaran - pengeluaran;

            document.getElementById('dashAnggaran').innerText = formatRupiahJS(anggaran);
            document.getElementById('dashPengeluaran').innerText = formatRupiahJS(pengeluaran);
            document.getElementById('dashSisa').innerText = formatRupiahJS(sisa);
            document.getElementById('dashJmlTrans').innerText = jmlTrans + " Item";

            // Pewarnaan Kartu Sisa (Logika Kontras)
            const cardSisa = document.getElementById('cardSisaAnggaran');
            const titleSisa = cardSisa.querySelector('h6');
            const iconSisa = cardSisa.querySelector('i');
            const angkaSisa = cardSisa.querySelector('h3');
            const ketSisa = cardSisa.querySelector('small');
            
            cardSisa.className = 'card p-3 shadow-sm h-100'; 

            if (sisa > 0) {
              cardSisa.style.backgroundColor = '#ffc107'; 
              if(titleSisa) titleSisa.className = 'mb-0 text-dark fw-bold opacity-75';
              if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-dark opacity-50';
              if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-dark';
              if(ketSisa)   ketSisa.className = 'text-dark opacity-75';
            } else if (sisa === 0) {
              cardSisa.style.backgroundColor = '#198754';
              if(titleSisa) titleSisa.className = 'mb-0 text-white-50';
              if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-white opacity-50';
              if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-white';
              if(ketSisa)   ketSisa.className = 'text-white-50';
            } else {
              cardSisa.style.backgroundColor = '#dc3545';
              if(titleSisa) titleSisa.className = 'mb-0 text-white-50';
              if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-white opacity-50';
              if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-white';
              if(ketSisa)   ketSisa.className = 'text-white-50';
            }

            // 2. Render Profil Sekolah (BARU)
            document.getElementById('dashNamaSekolah').innerText = p.nama;
            document.getElementById('dashNpsn').innerText = p.npsn;
            document.getElementById('dashNsm').innerText = p.nsm;
            document.getElementById('dashAlamat').innerText = p.alamat;
            document.getElementById('dashLokasi').innerText = p.lokasi; // Kec, Kab, Prov
            document.getElementById('dashEmail').innerText = p.email;
            
            document.getElementById('dashKepala').innerText = p.kepala;
            document.getElementById('dashNipKepala').innerText = p.nipKepala;
            document.getElementById('dashBendahara').innerText = p.bendahara;
            document.getElementById('dashNipBendahara').innerText = p.nipBendahara;

          }
        }).getDashboardStats(token);
      }

      /* --- LOGIKA MENU CETAK PDF --- */

      // 1. Fungsi Ganti Tab Cetak
      function bukaTabCetak(tipe) {
        // Reset Tab Active Class
        document.getElementById('tab-cetak-toko').classList.remove('active');
        document.getElementById('tab-cetak-guru').classList.remove('active');
        document.getElementById('tab-cetak-tukang').classList.remove('active');
        
        // Set Active Tab Button
        document.getElementById('tab-cetak-' + tipe).classList.add('active');

        // Sembunyikan semua tabel view
        document.querySelectorAll('.view-cetak').forEach(el => el.classList.add('hidden'));
        
        // Munculkan tabel yang dipilih
        document.getElementById('view-cetak-' + tipe).classList.remove('hidden');

        // Load Data
        loadListCetak(tipe);
      }

      // 2. Load Data ke Tabel Cetak
      function loadListCetak(tipeRaw) {
        const tipe = tipeRaw.toUpperCase(); 
        const targetId = 'tbody-cetak-' + tipeRaw;
        const tbody = document.getElementById(targetId);
        const token = localStorage.getItem('userToken');

        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Sedang memuat data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            tbody.innerHTML = '';
            if(res.data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Tidak ada data transaksi.</td></tr>';
              return;
            }

            res.data.forEach(item => {
              const dataJson = encodeURIComponent(JSON.stringify(item));
              
              let displayPihak = item.pihakKetiga;
              if (tipeRaw === 'guru' && (displayPihak === '-' || displayPihak === 'Honorarium Guru')) {
                  displayPihak = "-"; 
              }

              // --- LOGIKA TOMBOL BARU ---
              
              // 1. Tombol Lihat (Selalu Ada)
              const btnLihat = `
                <button class="btn btn-sm btn-outline-info me-1" 
                  onclick="lihatDetailTransaksi('${dataJson}')" title="Lihat Rincian">
                  <i class="fas fa-eye"></i>
                </button>
              `;

              let btnGenerate = '';
              let btnCetak = '';

              // Cek apakah PDF ID sudah ada dari Backend
              if (item.pdfId && item.pdfId !== "") {
                // KONDISI SUDAH GENERATE:
                // 1. Tombol Cetak (Membuka file lama)
                // Link Viewer Google Drive
                const linkPdf = `https://drive.google.com/file/d/${item.pdfId}/view?usp=sharing`;
                
                btnCetak = `
                   <button class="btn btn-sm btn-dark me-1" 
                     onclick="window.open('${linkPdf}', '_blank')" title="Cetak / Buka PDF">
                     <i class="fas fa-print"></i>
                   </button>
                `;

                // 2. Tombol Generate Ulang (Icon Sync/Refresh)
                btnGenerate = `
                  <button class="btn btn-sm btn-outline-danger" 
                    onclick="prosesCetakPDF('${item.id}', '${dataJson}', '${tipeRaw}')" title="Generate Ulang (Hapus Lama)">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                `;

              } else {
                // KONDISI BELUM GENERATE:
                // Hanya tombol Generate (Icon Cog/Gear)
                btnGenerate = `
                  <button class="btn btn-sm btn-warning" 
                    onclick="prosesCetakPDF('${item.id}', '${dataJson}', '${tipeRaw}')" title="Generate PDF Baru">
                    <i class="fas fa-cog"></i>
                  </button>
                `;
              }

              const row = `
                <tr>
                  <td>${item.tanggalDisplay}</td>
                  <td><div class="text-truncate" style="max-width: 250px;">${item.uraian}</div></td>
                  <td>${displayPihak}</td>
                  <td class="fw-bold">${formatRupiahJS(item.total)}</td>
                  <td style="white-space: nowrap;">${btnLihat} ${btnCetak} ${btnGenerate}</td>
                </tr>
              `;
              tbody.innerHTML += row;
            });

          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe);
      }

      /* --- FUNGSI PROSES CETAK PDF (UPDATE) --- */
      // Tambahkan parameter 'tipeTab' agar kita bisa reload tabel yang benar setelah selesai
      function prosesCetakPDF(id, encodedData, tipeTab) {
        
        const data = JSON.parse(decodeURIComponent(encodedData));
        const token = localStorage.getItem('userToken');

        // Cek teks konfirmasi (Baru vs Ulang)
        let judul = 'Generate PDF?';
        let teks = `Sistem akan membuat laporan PDF untuk: ${data.uraian}`;
        let tombolWarna = '#ffc107'; // Kuning (Warning)
        let tombolTeks = '<i class="fas fa-cog"></i> Generate';

        // Jika sudah ada PDF ID (Generate Ulang)
        if (data.pdfId) {
            judul = 'Generate Ulang?';
            teks = `Peringatan: File PDF lama akan <b>DIHAPUS</b> dan diganti dengan yang baru. Lanjutkan?`;
            tombolWarna = '#dc3545'; // Merah
            tombolTeks = '<i class="fas fa-sync-alt"></i> Ya, Ganti File';
        }

        Swal.fire({
          title: judul,
          html: teks,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: tombolWarna,
          cancelButtonColor: '#6c757d',
          confirmButtonText: tombolTeks,
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            
            Swal.fire({
              title: 'Sedang Memproses...',
              html: 'Mohon tunggu, sedang menyusun dokumen PDF...',
              allowOutsideClick: false,
              didOpen: () => { Swal.showLoading() }
            });

            let tipeTransaksi = data.tipe || 'TOKO';
            const namaMadrasah = document.getElementById('dashNamaSekolah').innerText || 'Madrasah';
            const nomorSurat = (data.dataSurat && data.dataSurat.permintaan) ? data.dataSurat.permintaan : 'DRAFT';

            const formUntukPDF = {
              idTransaksi: id,               // [PENTING] Kirim ID Transaksi untuk update DB
              tipe: tipeTransaksi,       
              nomorSurat: nomorSurat,
              pihakKetiga: data.pihakKetiga, 
              pemesan: data.pemesan,
              uraian: data.uraian,           
              tanggal: data.tanggal,         
              namaMadrasah: namaMadrasah,
              total: data.total,             
              items: data.items              
            };

            google.script.run.withSuccessHandler(function(res) {
              if (res.status === 'success') {
                Swal.fire({
                  icon: 'success',
                  title: 'Selesai!',
                  text: 'Dokumen PDF berhasil dibuat/diperbarui.',
                  footer: `<a href="${res.url}" target="_blank" class="btn btn-primary btn-lg"><i class="fas fa-external-link-alt me-2"></i>Buka PDF Sekarang</a>`,
                  showConfirmButton: true,
                  confirmButtonText: 'Oke'
                }).then(() => {
                    // [PENTING] Reload Tabel agar tombol berubah (Muncul icon print, generate jadi refresh)
                    loadListCetak(tipeTab);
                });
              } else {
                Swal.fire('Gagal', 'Terjadi kesalahan: ' + res.message, 'error');
              }
            }).generateLPJ(token, formUntukPDF);
          }
        });
      }

      /* --- FITUR FILTER TABEL --- */

      // 1. Inisialisasi Opsi Tahun (Dipanggil saat window.onload)
      function initFilterTahun() {
        const currentYear = new Date().getFullYear();
        const startYear = currentYear - 2;
        const endYear = currentYear + 1;
        
        // UPDATE ARRAY IDS INI: Tambahkan 3 ID baru di akhir (fltTahun_cetak_...)
        const ids = [
          'fltTahun_toko', 'fltTahun_guru', 'fltTahun_tukang', 
          'fltTahun_surat', 'fltTahun_tgl',
          'fltTahun_cetak_toko', 'fltTahun_cetak_guru', 'fltTahun_cetak_tukang' // <-- Tambahan Baru
        ];
        
        ids.forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            el.innerHTML = '<option value="">Semua Tahun</option>';
            for(let y = startYear; y <= endYear; y++) {
              el.innerHTML += `<option value="${y}">${y}</option>`;
            }
          }
        });
      }

      // 2. Fungsi Utama Filter
      function jalankanFilter(tabelBodyId, tahunSelectId, bulanSelectId) {
        const filterTahun = document.getElementById(tahunSelectId).value;
        const filterBulan = document.getElementById(bulanSelectId).value;
        
        const tbody = document.getElementById(tabelBodyId);
        const rows = tbody.getElementsByTagName('tr');
        
        // Loop semua baris
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          // Kolom tanggal ada di index ke-0 (Kolom Pertama)
          // Format Teks di tabel: dd-MM-yyyy (Contoh: 05-12-2025)
          const tdTanggal = row.cells[0]; 
          
          if (tdTanggal) {
            const textTanggal = tdTanggal.textContent.trim();
            
            // Jika barisnya adalah "Memuat data..." atau kosong, skip
            if(textTanggal.includes('Memuat') || textTanggal.includes('Belum ada')) continue;
            
            // Pecah tanggal (dd-MM-yyyy)
            const parts = textTanggal.split('-');
            if(parts.length === 3) {
              const rowBulan = parts[1]; // MM
              const rowTahun = parts[2]; // yyyy
              
              // Logika Cek Match
              const matchTahun = (filterTahun === '') || (rowTahun === filterTahun);
              const matchBulan = (filterBulan === '') || (rowBulan === filterBulan);
              
              if (matchTahun && matchBulan) {
                row.style.display = ''; // Tampilkan
              } else {
                row.style.display = 'none'; // Sembunyikan
              }
            }
          }
        }
      }

      // 3. Tambahkan pemanggilan initFilterTahun di window.onload
      const oldOnLoad = window.onload;
      window.onload = function() {
        if (oldOnLoad) oldOnLoad(); // Jalankan onload yang lama (login check dll)
        initFilterTahun(); // Jalankan inisialisasi filter
      };

    </script>
  </body>
</html>
