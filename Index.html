<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f4f6f9">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    
    <style>
      /* --- PERBAIKAN CSS SCROLL MOBILE --- */
      /* --- PERBAIKAN CSS SCROLL & BACKGROUND --- */
      html {
        width: 100%;
        /* FIX: Gunakan min-height agar background selalu penuh */
        height: auto;
        min-height: 100%; 
        
        /* FIX: Kembalikan scroll ke elemen html (root) */
        overflow-y: scroll; 
        overflow-x: hidden;
        
        /* Pastikan warna ini sama dengan body */
        background-color: #f4f6f9; 
      }

      body {
        margin: 0;
        padding: 0;
        width: 100%;
        
        /* FIX: Pastikan body minimal setinggi layar, tapi bisa tumbuh */
        min-height: 100vh; 
        height: auto; 
        
        background-color: #f4f6f9; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        
        /* FIX: Matikan scroll internal di body, biarkan html yang handle */
        overflow: visible; 
        
        /* Support touch */
        touch-action: auto !important; 
        -webkit-overflow-scrolling: touch;
      }

      /* Pastikan container login pas di tengah layar HP */
      .login-container {
        width: 100%;
        max-width: 400px; /* Batas lebar di layar besar */
        padding: 15px;
        margin: auto;
      }

      .panel-content {
        width: 100%;
        max-width: 100vw; /* Batasi lebar maksimal selebar layar HP */
        
        /* Pastikan konten yang melebar dipotong/disembunyikan */
        overflow-x: hidden; 
        
        /* Biarkan tinggi menyesuaikan konten */
        height: auto; 
        padding-bottom: 0px; 
        
        /* PERBAIKAN PENTING: Hapus pan-y, ganti auto */
        touch-action: auto !important; 
      }

      /* Perbaikan Input agar tidak zoom in otomatis di HP saat diklik */
      input, select, textarea {
        font-size: 16px !important; /* Mencegah auto-zoom browser HP */
      }
      
      /* Login & Register Styles */
      .card-login { max-width: 400px; margin: 50px auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
      
      /* Layout Styles */
      /* --- CSS UPDATE RESPONSIVE --- */

      /* --- PERBAIKAN SIDEBAR DESKTOP --- */
      .sidebar {
        min-height: 100vh;
        background: #2c3e50;
        color: white;
        transition: all 0.3s;
        
        /* Tambahan: Agar sidebar diam (sticky) saat konten discroll */
        position: sticky;
        top: 0;
        height: 100vh;       /* Tinggi full layar */
        overflow-y: auto;    /* Bisa discroll sendiri jika menu panjang */
        overflow-x: hidden;  /* Hilangkan scroll samping */
      }

      /* 2. CSS Khusus Mobile (Layar < 768px) */
      @media (max-width: 767.98px) {
        .sidebar {
          position: fixed;
          top: 0;
          left: -250px;
          width: 250px;
          height: 100%;
          z-index: 1050;
          overflow-y: auto;
          transition: left 0.3s ease; /* Transisi hanya pada properti left */
          visibility: hidden; /* Sembunyikan agar tidak mengganggu touch event */
          box-shadow: 5px 0 15px rgba(0,0,0,0.2);
        }

        .sidebar.show {
          left: 0;
          visibility: visible; /* Munculkan hanya saat class show aktif */
        }

        /* Konten Utama padding lebih kecil */
        .col-md-9.col-lg-10.p-4 {
          padding: 1rem !important; /* Ganti p-4 jadi p-3/p-2 di mobile */
        }

        /* Font tabel lebih kecil agar muat */
        .table {
          font-size: 0.8rem; 
        }
        
        /* Sembunyikan kolom yang kurang penting di mobile (Opsional) */
        /* .hide-mobile { display: none; } */
      }

      /* 3. Overlay Gelap saat Menu Mobile Aktif */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040; /* Di bawah sidebar, di atas konten */
      }

      .sidebar-overlay.show {
        display: block;
      }

      /* Custom Scrollbar untuk Sidebar agar rapi */
      .sidebar::-webkit-scrollbar { width: 5px; }
      .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

      .nav-link { 
        color: rgba(255,255,255,0.8); 
        margin-bottom: 5px; 
        cursor: pointer; 
        
        /* PERBAIKAN: Izinkan teks turun baris jika layar sempit */
        white-space: normal !important; 
        font-size: 0.95rem; /* Sedikit kecilkan font agar muat */
        line-height: 1.4;   /* Jarak antar baris jika teks turun */
        display: flex;      /* Gunakan flex agar ikon dan teks sejajar */
        align-items: center;
      }

      .nav-link i {
        /* Pastikan ikon tidak mengecil saat teks turun */
        flex: 0 0 25px; 
      }

      .nav-link:hover { background: #34495e; color: white; border-radius: 5px; }
      .nav-link.active { background: #3498db; color: white; border-radius: 5px; font-weight: bold; }
      
      /* Utility Classes */
      .hidden { display: none !important; }
      .cursor-pointer { cursor: pointer; }
      
      /* Loading Overlay */
      /* --- UPDATE CSS (Cari class .loading-overlay) --- */
      .loading-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(255,255,255,0.9); /* Sedikit lebih pekat agar tulisan terbaca */
        z-index: 9999; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        flex-direction: column; /* TAMBAHKAN INI: Agar teks turun ke bawah */
      }

      /* --- STYLE TAB CUSTOM --- */
      /* Keadaan Tidak Aktif (Default) */
      .nav-tabs .nav-link {
        color: black !important;          /* Teks Hitam */
        background-color: #e9ecef;        /* Background abu muda */
        border: 1px solid #dee2e6;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        font-weight: 600;
      }

      /* Keadaan Aktif (Terpilih) */
      .nav-tabs .nav-link.active {
        color: white !important;          /* Teks Putih */
        background-color: #0d6efd !important; /* Background Biru Utama */
        border-color: #0d6efd !important;
      }

      /* Hover Effect */
      .nav-tabs .nav-link:hover {
        background-color: #dfe6ed;
        color: #000;
      }

      /* --- STYLE TAMBAHAN UNTUK NAV PILLS (Tab Setting) --- */
      
      /* 1. Style Dasar Tombol */
      .nav-pills .nav-link {
        background-color: #e9ecef; /* Warna abu-abu terang default */
        color: #495057;            /* Warna teks abu tua */
        margin-right: 5px;
        border: 1px solid #dee2e6; 
        transition: all 0.2s;      /* Animasi halus */
      }

      /* 2. Efek Hover HANYA untuk Tab yang TIDAK AKTIF */
      .nav-pills .nav-link:not(.active):hover {
        background-color: #dfe6ed; /* Berubah jadi abu agak gelap saat hover */
        color: #000;
      }

      /* 3. Style Tab AKTIF (Termasuk saat di-hover) */
      .nav-pills .nav-link.active,
      .nav-pills .nav-link.active:hover { 
        background-color: #0d6efd; /* Tetap Biru */
        color: white;
        border-color: #0d6efd;
        cursor: default; /* Opsional: Ubah kursor agar user tahu ini sedang aktif */
      }

      /* --- STYLE CUSTOM TOGGLE SWITCH --- */
      .toggle-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .toggle-card:hover {
        border-color: #0d6efd; /* Warna biru primary saat dihover */
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
      }

      /* Memperbesar ukuran saklar bawaan Bootstrap */
      .custom-switch-lg .form-check-input {
        width: 3.5em;  /* Lebih lebar */
        height: 1.75em; /* Lebih tinggi */
        cursor: pointer;
      }
      
      .custom-switch-lg .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
      }

      /* --- STYLE UNTUK AUTOCOMPLETE LIST (UPDATED) --- */
      .autocomplete-wrapper {
        position: relative;
        width: 100%;
      }

      .suggestion-list {
        position: absolute;
        top: 100%; /* Tepat di bawah input */
        left: 0;
        right: 0;
        z-index: 1030; /* Pastikan di atas segalanya */
        
        background: white;
        border: 1px solid rgba(0,0,0,0.15); /* Border halus */
        border-top: none; /* Menyatu dengan input */
        border-radius: 0 0 8px 8px; /* Sudut bawah membulat */
        
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); /* Shadow melayang (floating effect) */
        font-size: 0.9rem;
      }

      .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        background-color: #fff;
        transition: background 0.2s;
        color: #333;
      }

      .suggestion-item:hover {
        background-color: #f0f7ff; /* Warna biru sangat muda saat hover */
        color: #0d6efd;
      }

      .suggestion-item:last-child {
        border-bottom: none !important;
        border-radius: 0 0 8px 8px;
      }

      /* Scrollbar halus untuk list */
      .suggestion-list::-webkit-scrollbar {
        width: 6px;
      }
      .suggestion-list::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 3px;
      }

      .letter-spacing-2 { letter-spacing: 5px; }

      /* Pastikan ini ada agar saat ikon mata disorot mouse berubah jadi jari telunjuk */
      .cursor-pointer { cursor: pointer; }

      /* --- STYLE FOOTER --- */
      .main-footer {
        text-align: center;
        padding: 20px 10px;
        
        /* Perbaikan Margin */
        margin-top: auto; 
        margin-bottom: 0 !important; /* Pastikan tidak ada jarak di bawah */
        
        background-color: #f4f6f9; 
        border-top: 1px solid #e0e0e0;
        width: 100%;
        font-size: 0.9rem;
        color: #6c757d;
        
        /* Perbaikan Khusus HP Poni/Full Screen agar tidak tertutup tombol navigasi */
        padding-bottom: calc(20px + env(safe-area-inset-bottom)); 
      }

      .main-footer a {
        text-decoration: none;
        color: inherit; /* Mengikuti warna teks parent */
        transition: color 0.3s;
      }

      .main-footer a:hover {
        color: #0d6efd; /* Warna biru saat dihover */
      }

      .main-footer p {
        margin-bottom: 0; /* Menghapus margin bawaan paragraf */
      }

      .table-responsive, 
      .nav-tabs-scrollable {
        /* Mengizinkan geser ke segala arah (X untuk tabel, Y untuk halaman) */
        touch-action: pan-x pan-y; 
        
        /* Momentum scroll wajib untuk area scroll kecil */
        -webkit-overflow-scrolling: touch;
        
        /* PERBAIKAN: Ubah menjadi auto agar scroll halaman (naik-turun) tetap jalan */
        overscroll-behavior: auto !important; 
        
        /* Tambahan: Pastikan kursor default agar tidak dianggap text-selection */
        cursor: default;
      }

      /* --- CSS KHUSUS TAB SCROLLABLE (MOBILE) --- */
      .nav-tabs-scrollable {
        display: flex;
        flex-wrap: nowrap !important; /* Mencegah tab turun ke bawah */
        overflow-x: auto;             /* Mengaktifkan scroll samping */
        overflow-y: hidden;
        white-space: nowrap;          /* Teks tidak terpotong */
        -webkit-overflow-scrolling: touch; /* Scroll halus di iOS */
        border-bottom: 1px solid #dee2e6;
        
        /* Hilangkan scrollbar agar bersih */
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
      }

      .nav-tabs-scrollable::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }

      .nav-tabs-scrollable .nav-item {
        flex: 0 0 auto; /* Item tidak menyusut */
      }

      .nav-tabs-scrollable .nav-link {
        border-bottom: none; /* Agar border bawah menyatu */
        font-size: 0.9rem;   /* Sedikit mengecilkan font di mobile agar muat lebih banyak */
        padding: 10px 15px;
      }

      /* --- PERBAIKAN TABEL INPUT TRANSAKSI (MOBILE) --- */

      /* 1. Memaksa tabel input agar melebar (memunculkan scroll horizontal) */
      .table-input-scroll {
        min-width: 800px; /* Tabel dipaksa lebar minimal 800px agar lega */
      }

      /* 2. Mengatur lebar minimal setiap kolom agar input tidak gepeng */
      .col-nama   { width: 30%; min-width: 200px; }
      .col-vol    { width: 10%; min-width: 80px; } /* Diperlebar agar angka terlihat */
      .col-sat    { width: 15%; min-width: 100px; }
      .col-harga  { width: 20%; min-width: 140px; }
      .col-jumlah { width: 20%; min-width: 140px; }
      .col-aksi   { width: 5%;  min-width: 50px; }

      /* 3. Perbaikan Tombol Aksi di Bawah Tabel */
      .action-container {
        display: flex;
        flex-wrap: wrap; /* Agar tombol turun ke bawah jika layar sempit */
        gap: 10px;       /* Jarak antar elemen */
        align-items: center;
        justify-content: space-between;
      }

      /* Di HP, elemen pencarian dan tombol simpan jadi full width agar mudah ditekan */
      @media (max-width: 767.98px) {
        .action-group-left, 
        .action-group-right {
          width: 100%;
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        
        .autocomplete-wrapper {
          width: 100% !important;
          max-width: 100% !important;
        }

        /* Tombol tambah baris & simpan jadi lebar penuh */
        .action-group-left button,
        .action-group-right button {
          width: 100%; 
        }
      }

      /* --- PERBAIKAN BUG SCROLL MODAL (INFO REFERENSI) --- */
      
      /* 1. Paksa scroll vertikal aktif & mulus pada modal body */
      .modal-dialog-scrollable .modal-body {
        -webkit-overflow-scrolling: touch !important; /* Momentum scroll iOS */
        overflow-y: auto !important;
        touch-action: pan-y !important; /* Pastikan gesture vertikal diizinkan */
      }

      /* 2. PENTING: Matikan 'contain' khusus untuk tabel di dalam modal 
         agar saat tabel disentuh, scroll tetap bisa naik-turun (bubbling ke modal) */
      .modal-body .table-responsive {
        overscroll-behavior: auto !important; 
        touch-action: pan-x pan-y !important;
      }

      .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto; /* Tabel boleh digeser horizontal */
        -webkit-overflow-scrolling: touch;
        touch-action: auto; /* Izinkan sentuhan geser */
      }
      
      /* 3. Pastikan Sticky Header tetap jalan tapi tidak menghalangi scroll */
      .modal-body .table-responsive thead.sticky-top {
        z-index: 5; /* Sedikit diatas konten tabel */
      }

      /* --- CSS UNTUK KOLOM SCROLLABLE --- */
      .cell-scroll {
        overflow-x: auto;       /* Izinkan scroll horizontal */
        white-space: nowrap;    /* Teks satu baris, tidak turun ke bawah */
        padding-bottom: 2px;    /* Sedikit jarak bawah */
        
        /* Sembunyikan scrollbar agar bersih (opsional) */
        scrollbar-width: none;  /* Firefox */
        -ms-overflow-style: none;  /* IE and Edge */
      }

      /* Sembunyikan scrollbar untuk Chrome/Safari/Opera */
      .cell-scroll::-webkit-scrollbar {
        display: none;
      }

      /* --- [1] SETTINGAN UMUM (TAMPILAN DILAYAR / LIVE PREVIEW) --- */
      /* Ini akan membuat tampilan di layar laptop normal, tidak terlalu melebar */

      .sheet {
        background: white;
        width: 210mm;        /* Standar A4 */
        height: 297mm;       
        position: relative;
        box-shadow: 0 .5mm 2mm rgba(0,0,0,.3);
        box-sizing: border-box;
        color: #000;
        font-family: "Times New Roman", Times, serif;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 15mm;
        /* HAPUS min-width DISINI agar preview di layar fleksibel/bisa dizoom */
      }

      /* Ukuran Font Standar untuk PREVIEW (Agar enak dilihat di layar) */
      .txt-instansi { font-size: 14pt; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
      
      .txt-title { 
        font-size: 24pt; /* Ukuran normal untuk preview */
        font-weight: bold; text-transform: uppercase; line-height: 1.3; margin-bottom: 15px; 
      }
      
      .txt-period { font-size: 14pt; margin-bottom: 10px; font-weight: normal; }
      .txt-school { font-size: 18pt; font-weight: bold; text-transform: uppercase; margin-top: 10px; }
      .txt-year { font-size: 14pt; margin-top: 5px; font-weight: bold; }
      .txt-city { font-size: 12pt; font-weight: bold; text-transform: uppercase; margin-top: 15px; }
      
      .img-logo { max-height: 200px; max-width: 200px; object-fit: contain; }

      /* Layout Wrapper Standar */
      .cover-layout-wrapper {
        width: 100%; height: 100%; box-sizing: border-box;
        display: flex; flex-direction: column; justify-content: space-between;
      }
      .section-top { text-align: center; margin-top: 30mm; padding-bottom: 20px; }
      .section-middle { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 10px 0; }
      .section-bottom { text-align: center; margin-bottom: 25mm; }

      /* Desain V1 Default */
      .design-v1 .cover-layout-wrapper {
        border: 5px double #000; outline: 1px solid #000; outline-offset: -10px; padding: 0 10mm;
      }
      /* Desain lain (V2-V5) tetap gunakan CSS lama... */
      .design-v2 .cover-layout-wrapper { padding: 0 10mm; }
      .design-v2 .bar-header, .design-v2 .bar-footer { height: 30px; background-color: #157347; width: 100%; }
      .design-v3 .cover-layout-wrapper { border-left: 15px solid #2c3e50; padding-left: 10mm; align-items: flex-start; }
      .design-v3 .section-top, .design-v3 .section-bottom { text-align: left; margin-top: 20mm; margin-bottom: 20mm; }
      .design-v4 .section-top { border-bottom: 4px double #000; padding-bottom: 20px; width: 100%; margin-top: 10mm; }
      .design-v4 .section-bottom { border-top: 2px solid #000; padding-top: 20px; width: 100%; margin-bottom: 10mm; }
      .design-v5 .cover-layout-wrapper { border: 3px solid #0d6efd; border-radius: 20px; padding: 10mm; }


      /* --- [2] SETTINGAN KHUSUS CETAK (ACTIVE SAAT KLIK PRINT/SIMPAN PDF) --- */
      /* Disini kita 'menyuntikkan' CSS agar hasil cetak jadi BESAR & TEBAL */
      
      @media print {
        @page { 
          size: A4 portrait; margin: 0; 
        }
        
        body * { visibility: hidden; }
        
        #print-area, #print-area * { visibility: visible; }

        #print-area {
          position: fixed; top: 0; left: 0;
          
          /* KUNCI 1: Paksa Lebar 210mm saat Print agar Font Besar muat */
          width: 210mm !important;
          min-width: 210mm !important; 
          height: 297mm !important;
          
          margin: 0; padding: 15mm !important;
          display: flex; justify-content: center; align-items: center;
          background: white !important;
          z-index: 9999;
        }
        
        .design-v1 .cover-layout-wrapper { height: 100%; }

        /* KUNCI 2: PERBESAR FONT SECARA EKSTRIM KHUSUS UNTUK HASIL CETAK */
        /* Gunakan !important agar menimpa settingan layar */
        
        .txt-title { 
            font-size: 32pt !important; /* Besar agar wrap (turun baris) */
            line-height: 1.1 !important;
            padding: 0 10mm !important;
        }
        
        .txt-instansi { font-size: 16pt !important; }
        .txt-school { font-size: 22pt !important; }
        .txt-year { font-size: 16pt !important; }
        .txt-period { font-size: 16pt !important; }
        .txt-city { font-size: 14pt !important; }
        
        .img-logo { max-height: 220px !important; }

        /* Tambahkan ini agar Surat Pengantar juga tercetak full page */
        #print-area-sp {
          position: fixed; top: 0; left: 0;
          width: 210mm !important;
          min-width: 210mm !important; 
          height: 297mm !important;
          margin: 0; padding: 10mm !important;
          background: white !important;
          z-index: 9999;
          visibility: visible !important;
        }
        
        #print-area-sp * {
          visibility: visible !important;
        }

        /* Tambahan khusus Verifikasi */
        #print-area-verif {
          position: fixed; top: 0; left: 0;
          width: 210mm !important;
          height: 297mm !important;
          margin: 0; padding: 0 !important;
          background: white !important;
          z-index: 9999;
          visibility: visible !important;
        }
        
        #print-area-verif * {
          visibility: visible !important;
        }

        /* Hilangkan tombol aksi tabel */
        .btn-aksi-verif, .btn-aksi-verif * {
          display: none !important;
        }
        
        /* Hilangkan border input agar terlihat seperti teks biasa */
        .input-verif-cell {
          border: none !important;
          background: transparent !important;
          padding: 0 !important;
        }
      }

      /* --- CSS TAMBAHAN UNTUK SURAT PENGANTAR --- */
      .surat-body {
        padding: 10mm 15mm;
        font-family: 'Times New Roman', Times, serif;
        font-size: 12pt;
        color: #000;
        line-height: 1.5;
      }

      .tbl-pengantar {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .tbl-pengantar th, .tbl-pengantar td {
        border: 1px solid #000;
        padding: 8px;
        vertical-align: top;
      }

      .tbl-pengantar th {
        text-align: center;
        font-weight: bold;
      }

      .signature-box {
        float: right;
        width: 40%;
        text-align: center;
        margin-top: 30px;
      }

      /* --- [CSS LEMBAR VERIFIKASI - LIVE PREVIEW (DI LAYAR)] --- */
      
      /* Container Kertas Preview */
      #print-area-verif.sheet {
        width: 215.9mm;        /* Lebar F4/Legal */
        min-width: 215.9mm;    /* Cegah menyusut */
        min-height: 330mm;     /* Tinggi minimal F4 */
        height: auto !important; /* Biarkan tinggi tumbuh sesuai isi tabel */
        
        padding: 15mm 20mm;    /* Margin dalam kertas (Atas Kanan Bawah Kiri) */
        box-sizing: border-box;
        background: white;
        box-shadow: 0 .5mm 2mm rgba(0,0,0,.3); /* Efek bayangan kertas di layar */
        
        /* Flex column agar rapi */
        display: flex;
        flex-direction: column;
        justify-content: flex-start; /* PENTING: Paksa konten mulai dari ATAS */
        
        /* PENTING: Izinkan konten meluap di preview agar bisa discroll */
        overflow: visible !important; 
        margin-bottom: 50px; /* Jarak bawah agar tidak mepet footer */
        
        /* KUNCI PERBAIKAN TEXT TERPOTONG: Reset posisi */
        position: relative; 
        left: auto;
        top: auto;
        margin-left: auto;
        margin-right: auto;
      }

      /* Pastikan container pembungkusnya (sheet-container) bisa discroll */
      .sheet-container {
        background-color: #525659;
        padding: 30px;
        overflow: auto; /* Scrollbar otomatis muncul jika konten panjang */
        height: 75vh;   /* Tinggi area preview di layar */
        display: block; /* UBAH KE BLOCK agar scrollbar bekerja normal */
        text-align: center; /* Agar kertas ada di tengah horizontal */
      }

      /* 2. Container Utama Verifikasi */
      .verif-sheet {
        font-family: 'Times New Roman', Times, serif;
        color: #000;
        background: white;
        width: 100%;
        height: 100%;
        /* Padding 0 karena sudah diatur di parent .sheet */
        padding: 0; 
      }

      /* 3. Judul Paling Atas */
      .verif-title-top {
        text-align: center;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 14pt;
        margin-top: 0; 
        margin-bottom: 15px; 
        text-decoration: underline;
        line-height: 1.1;
      }

      /* --- PERBAIKAN TABEL HEADER (DETAIL SEKOLAH) --- */
      .verif-header-table {
        width: 100% !important;
        border-collapse: collapse !important;
        border: none !important;
        margin-bottom: 20px !important;
      }

      .verif-header-table td {
        border: none !important;
        vertical-align: top !important; /* Agar jika teks panjang, titik dua tetap di atas */
        text-align: left !important;    /* KUNCI: Paksa Rata Kiri */
        padding: 2px 0 !important;      /* Jarak antar baris sedikit renggang biar rapi */
        font-size: 11pt !important;
      }

      /* 5. Sub-Judul (RATA TENGAH) */
      .verif-subtitle {
        font-weight: bold;
        font-size: 11pt;
        text-transform: uppercase;
        text-align: center;
        text-decoration: underline;
        margin-top: 10px;
        margin-bottom: 5px;
      }

      /* --- GANTI BAGIAN CSS INI DI DALAM <style> --- */

      /* 2. Tabel Utama (Daftar Berkas) - UPDATED WIDTHS */
      .verif-main-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10pt;
        margin-bottom: 20px;
        table-layout: fixed; /* Wajib fixed agar pengaturan lebar kolom (width) dipatuhi */
      }

      .verif-main-table th {
        text-align: center;
        font-weight: bold;
        background-color: #f8f9fa; /* Warna header agak abu terang */
        border: 1px solid #000;
        padding: 8px 4px; /* Padding atas bawah agak lega */
        vertical-align: middle !important; /* Pastikan teks di tengah secara vertikal */
        line-height: 1.2;
      }

      .verif-main-table td {
        border: 1px solid #000;
        padding: 4px 5px; 
        vertical-align: middle;
        word-wrap: break-word; /* Agar teks panjang turun ke bawah */
      }

      /* --- PENGATURAN LEBAR KOLOM (TOTAL +/- 100%) --- */
      
      /* Kolom 1: No */
      .verif-main-table col:nth-child(1) { width: 5%; }
      
      /* Kolom 2: Nama Berkas (DIPERLEBAR) */
      .verif-main-table col:nth-child(2) { width: 62%; } 
      
      /* Kolom 3: Ada (DIPERKECIL) */
      .verif-main-table col:nth-child(3) { width: 6%; }
      
      /* Kolom 4: Tidak (DIPERKECIL) */
      .verif-main-table col:nth-child(4) { width: 6%; }
      
      /* Kolom 5: Keterangan (DIPERKECIL karena tulis tangan) */
      .verif-main-table col:nth-child(5) { width: 16%; }
      
      /* Kolom 6: Aksi (Hanya tampil di layar) */
      .verif-main-table col:nth-child(6) { width: 5%; }

      /* Input dalam tabel (Agar terlihat rapi di preview) */
      .input-verif-cell {
        width: 100%;
        border: none;
        border-bottom: 1px dashed #ccc; /* Garis bawah putus-putus tipis */
        padding: 4px 0;
        font-family: inherit;
        font-size: 10pt;
        background-color: transparent;
        color: #000;
      }
      .input-verif-cell:focus {
        outline: none;
        border-bottom: 1px solid #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
      }

      /* Container Tanda Tangan agar selalu di bawah tapi tidak maksa */
      .verif-signature-grid {
        margin-top: auto; /* Push ke bawah jika halaman masih sisa banyak */
        padding-top: 30px;
      }

      /* Baris Tanda Tangan (Kiri & Kanan) */
      .sig-row {
        display: flex;
        justify-content: space-between; /* Pisahkan ke ujung kiri & kanan */
        align-items: flex-start;
        width: 100%;
        margin-bottom: 20px;
      }

      /* Box Tanda Tangan */
      .verif-sig-box {
        width: 45%;
        text-align: center;
        font-size: 11pt;
      }

      /* Label Tengah (Tulisan Verifikator) */
      .sig-label-center {
        text-align: center;
        width: 100%;
        font-weight: bold;
        text-decoration: underline;
        margin: 15px 0;
        font-size: 11pt;
      }

      /* Wrapper Nama & NIP (Agar rata kiri sejajar di dalam box tengah) */
      .sig-wrap {
        display: inline-block; /* Bungkus konten */
        text-align: left;      /* Isi dalam rata kiri */
        margin-top: 60px;      /* Jarak untuk tanda tangan */
        min-width: 200px;
      }

      /* Nama Pejabat (Garis Bawah) */
      .verif-sig-name {
        font-weight: bold;
        text-decoration: none;
        border-bottom: 1px solid #000; /* Garis bawah manual CSS */
        padding-bottom: 2px;
        margin-bottom: 2px;
        display: block;
        line-height: 1.2;
      }

      /* NIP Pejabat */
      .verif-sig-nip {
        font-size: 10pt;
        font-weight: normal;
      }

      /* --- [SETTINGAN KHUSUS CETAK - FINAL CLEAN & 1 HALAMAN] --- */
      @media print {
        /* 1. Reset Ukuran Kertas & Margin Browser */
        @page {
          size: Legal portrait; /* Bisa diganti A4 jika perlu */
          margin: 0mm; /* Nol-kan margin bawaan browser */
        }

        /* 2. Kunci Body agar tidak ada scroll/halaman lebih */
        body, html {
          width: 100%;
          height: 100%;
          margin: 0 !important;
          padding: 0 !important;
          background-color: white !important; /* Paksa Putih */
          overflow: hidden !important; /* KUNCI: Memotong halaman ke-2 */
        }

        /* 3. Sembunyikan SEMUA elemen website */
        body * {
          visibility: hidden;
        }

        /* 4. Tampilkan HANYA area verifikasi & isinya */
        #print-area-verif, 
        #print-area-verif * {
          visibility: visible !important;
        }

        /* 5. Setting Container Utama (Paksa Satu Halaman) */
        #print-area-verif {
          /* POSISI FIXED: Mencabut elemen dari layout web & tempel di kertas */
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          
          /* UKURAN: Paksa pas 1 layar cetak */
          width: 100% !important;
          height: 100% !important; 
          max-height: 100vh !important; /* Batas keras tinggi halaman */
          
          /* MARGIN & PADDING (Atur jarak isi dari tepi kertas disini) */
          padding: 10mm 20mm 0mm 20mm !important; /* Atas Kanan Bawah Kiri */
          margin: 0 !important;
          
          /* TAMPILAN: Paksa Background Putih & Hapus Garis */
          background: white !important; 
          box-shadow: none !important;
          border: none !important;
          
          /* PEMOTONGAN: Potong apapun yang lewat dari 1 halaman */
          overflow: hidden !important; 
          
          z-index: 999999;
        }

        /* --- PERBAIKAN ELEMENT DALAM --- */

        /* Sembunyikan Tombol Aksi */
        .btn-aksi-verif, 
        th.btn-aksi-verif, 
        td.btn-aksi-verif,
        button {
          display: none !important; 
        }

        /* Reset Tabel agar rapi */
        .verif-main-table {
          width: 100% !important;
          font-size: 10pt !important;
          border-collapse: collapse;
          margin-bottom: 5px !important;
        }
        
        .verif-main-table th, 
        .verif-main-table td {
          border: 1px solid #000 !important;
          padding: 3px 5px !important;
          vertical-align: middle !important;
        }

        /* Lebar Kolom Nama Berkas */
        .verif-main-table th:nth-child(2),
        .verif-main-table td:nth-child(2) {
          width: 60% !important; 
        }

        /* Input Teks Polos */
        .input-verif-cell {
          border: none !important;
          background: transparent !important;
          width: 100%;
          font-size: 10pt !important;
          padding: 0 !important;
        }

        /* Layout Tanda Tangan */
        .verif-signature-grid {
          display: block !important;
          width: 100%;
          margin-top: 15px !important; 
        }

        .sig-row {
          display: flex !important;
          justify-content: space-between !important;
          width: 100%;
          margin-bottom: 25px !important;
        }

        .verif-sig-box {
          width: 40% !important;
          text-align: center; 
          font-size: 11pt !important;
        }

        .sig-label-center {
          text-align: center;
          width: 100%;
          font-weight: bold;
          margin: 10px 0 !important;
          font-size: 11pt;
          text-decoration: underline;
        }

        .sig-wrap {
          margin-top: 60px !important; 
          display: inline-block;
          text-align: left;
          min-width: 200px;
        }

        .verif-sig-name {
          display: block;
          border-bottom: 1px solid #000 !important;
          padding-bottom: 2px;
          margin-bottom: 2px;
          font-weight: bold;
          text-transform: none;
          text-decoration: none !important;
        }

        .verif-sig-nip {
          font-size: 10pt;
        }
      }

      /* FIX: Paksa tombol turun ke bawah jika layar sempit */
      .action-container, 
      .d-flex {
        flex-wrap: wrap !important; 
      }
      
      /* FIX: Pastikan tombol tidak terpotong di layar kecil */
      .action-group-right {
        margin-top: 10px; /* Beri jarak jika tombol turun */
        width: 100%;
        display: flex;
        justify-content: flex-end; /* Rata kanan */
        gap: 5px;
      }
    </style>
  </head>
  <body>

    <div id="global-satuan-list" class="suggestion-list" style="display:none; position: absolute; z-index: 1030;"></div>

    <div id="loading" class="loading-overlay hidden">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h5 id="loadingText" class="fw-bold text-secondary">Memuat...</h5>
    </div>

    <div id="view-login" class="container view-section">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-primary"><i class="fas fa-book-open"></i> LPJ BOS</h3>
        <p class="text-center text-muted">Sistem Manajemen LPJ Sekolah</p>
        <form id="formLogin" onsubmit="handleLogin(event)">
          <div class="mb-3">
            <label class="form-label">Email Sekolah</label>
            <input type="email" class="form-control" id="loginEmail" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="loginPass" required>
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('loginPass', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Tahun Anggaran</label>
            <select class="form-select" id="loginTahun" required>
              </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Masuk</button>
          <div class="text-end mb-3">
            <small><span class="text-muted cursor-pointer" onclick="switchView('view-reset')">Lupa Password?</span></small>
          </div>
        </form>
        <div class="text-center mt-3">
          <small>Belum punya akun? <span class="text-primary cursor-pointer text-decoration-underline" onclick="switchView('view-register')">Daftar disini</span></small>
        </div>
      </div>
    </div>

    <div id="view-register" class="container view-section hidden">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-success"><i class="fas fa-school"></i> Daftar Sekolah</h3>
        <form id="formRegister" onsubmit="handleRegister(event)">
          <div class="mb-3">
            <label class="form-label">Nama Sekolah</label>
            
            <input type="text" class="form-control" id="regNama" placeholder="Contoh: MTS NEGERI 1..." required 
              style="text-transform: uppercase;"
              oninput="this.value = this.value.toUpperCase()">
              
            <div class="form-text text-muted" style="font-size: 0.8rem;">Gunakan nama resmi sekolah.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email Aktif</label>
            <input type="email" class="form-control" id="regEmail" placeholder="email@gmail.com" required>
            
            <div class="mt-1 p-2 bg-warning bg-opacity-10 border border-warning rounded" style="font-size: 0.8rem;">
              <i class="fas fa-exclamation-triangle text-warning me-1"></i>
              <strong class="text-dark">PENTING:</strong> Wajib gunakan <span class="text-decoration-underline">Email Aktif</span>.
              <br>
              <span class="text-muted ms-3">Jika lupa password, Kode OTP hanya akan dikirim ke email ini.</span>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Password</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="regPass" required placeholder="Minimal 6 karakter" minlength="6">
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('regPass', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Konfirmasi Password</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="regPassConfirm" placeholder="Ketik ulang password..." required>
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('regPassConfirm', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>

          <button type="submit" class="btn btn-success w-100">Daftar Sekarang</button>
        </form>
        <div class="text-center mt-3">
          <small>Sudah punya akun? <span class="text-primary cursor-pointer text-decoration-underline" onclick="switchView('view-login')">Login disini</span></small>
        </div>
      </div>
    </div>

    <div id="view-reset" class="container view-section hidden">
      <div class="card card-login p-4">
        <h3 class="text-center mb-4 text-danger"><i class="fas fa-user-lock"></i> Reset Password</h3>
        
        <form id="formStep1" onsubmit="handleSendOtp(event)">
          <div class="mb-3">
            <label class="form-label">Masukkan Email Sekolah</label>
            <input type="email" class="form-control" id="resetEmailInput" placeholder="email@sekolah..." required>
            <div class="form-text">Kode OTP akan dikirim jika email terdaftar.</div>
          </div>
          
          <button type="submit" id="btnSendOtp" class="btn btn-primary w-100">
            <i class="fas fa-paper-plane me-1"></i> Kirim Kode OTP
          </button>
          
          <div class="text-center mt-3 border-top pt-2">
            <small class="text-muted">Sudah punya kode OTP aktif?</small><br>
            <span class="text-primary cursor-pointer fw-bold text-decoration-underline" onclick="manualInputOtp()">
               <i class="fas fa-keyboard me-1"></i> Masukkan Kode Disini
            </span>
          </div>
        </form>

        <form id="formStep2" class="hidden mt-3" onsubmit="handleConfirmReset(event)">
          <div class="alert alert-info py-2 mb-3" style="font-size: 0.9rem;">
            <i class="fas fa-info-circle me-1"></i> Silakan masukkan kode OTP dari email.
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Kode OTP (6 Digit)</label>
            <input type="text" class="form-control text-center font-monospace fs-4 letter-spacing-2" 
                   id="resetOtpInput" maxlength="6" placeholder="000000" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Password Baru</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="resetPassNew" required placeholder="Minimal 6 karakter" minlength="6">
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('resetPassNew', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Konfirmasi Password</label>
            <div class="input-group">
              <input type="password" class="form-control border-end-0" id="resetPassConf" placeholder="Ketik ulang password..." required>
              <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('resetPassConf', this)">
                <i class="fas fa-eye text-muted"></i>
              </span>
            </div>
          </div>

          <button type="submit" id="btnConfirmReset" class="btn btn-danger w-100 mb-2">Ubah Password</button>
        </form>

        <button type="button" class="btn btn-outline-secondary w-100 mt-3" onclick="resetViewReset()">
          <i class="fas fa-arrow-left me-1"></i> Batal / Kembali Login
        </button>
      </div>
    </div>

    <div id="view-admin" class="container-fluid view-section hidden p-0"> <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="row g-0"> <div id="sidebarMenu" class="col-md-3 col-lg-3 col-xl-2 sidebar p-3">
          <div class="d-flex justify-content-between align-items-center">
              <h4 class="text-center py-3 border-bottom w-100">
                <i class="fas fa-calendar-check me-2"></i> 
                <span id="sidebarLabelTahun">Tahun -</span>
              </h4>
              <button class="btn btn-sm text-white d-md-none" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
          </div>
          <ul class="nav flex-column mt-4">
            <li class="nav-item">
              <a onclick="navigasiKe('panel-dashboard', this)" class="nav-link active" style="cursor: pointer;">
                <i class="fas fa-home me-2"></i> Dashboard
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Data Master</small></li>
            
            <li class="nav-item">
              <a onclick="navigasiKe('panel-data-sekolah', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-school me-2"></i> Data Sekolah
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-uraian', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-list-ul me-2"></i> Data Uraian Pekerjaan
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-toko', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-store me-2"></i> Data Toko
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-tukang', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-hammer me-2"></i> Data Tukang
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-guru', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-user-tie me-2"></i> Data Pemesan/Guru
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-import', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-file-import me-2"></i> Import Data
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Pengaturan</small></li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-kop', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-image me-2"></i> Kop Surat
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-nomor-surat', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-list-ol me-2"></i> Nomor Surat
              </a>
            </li>
            <li class="nav-item">
              <a onclick="navigasiKe('panel-tanggal-surat', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-calendar-alt me-2"></i> Tanggal Surat
              </a>
            </li>

            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Transaksi</small></li>
            
            <li class="nav-item">
              <a onclick="navigasiKe('panel-transaksi', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-shopping-cart me-2"></i> Transaksi Belanja
              </a>
            </li>

            <li class="nav-item mt-2">
              <small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Cetak</small>
            </li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-cetak-pdf', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-print me-2"></i> Cetak PDF
              </a>
            </li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-cetak-pendukung', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-file-signature me-2"></i> Cetak Pendukung
              </a>
            </li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-berkas-pencairan', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-file-invoice-dollar me-2"></i> Berkas Pencairan
              </a>
            </li>
            
            <li class="nav-item mt-2"><small class="text-secondary ms-3 text-uppercase" style="font-size:0.7rem; letter-spacing:1px;">Akun</small></li>

            <li class="nav-item">
              <a onclick="navigasiKe('panel-ubah-password', this)" class="nav-link" style="cursor: pointer;">
                <i class="fas fa-key me-2"></i> Ubah Password
              </a>
            </li>

            <li class="nav-item mt-3 pt-3 border-top">
              <a onclick="logout()" class="nav-link text-danger" style="cursor: pointer;">
                <i class="fas fa-sign-out-alt me-2"></i> Keluar
              </a>
            </li>
          </ul>
        </div>

        <div class="col-md-9 col-lg-9 col-xl-10 p-0 p-md-4"> <div class="w-100 p-3 p-md-2">
          
          <div class="d-md-none mb-3 d-flex align-items-center justify-content-between">
            <button class="btn btn-primary" onclick="toggleSidebar()">
              <i class="fas fa-bars me-1"></i> Menu
            </button>
            <span class="fw-bold text-secondary">Aplikasi LPJ BOS</span>
          </div>

          <div id="panel-dashboard" class="panel-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div class="d-flex align-items-center flex-wrap">
                <h2 class="mb-0 me-2">Dashboard</h2>
                <span id="schoolNameDisplay" class="text-primary fs-5 fw-bold me-3"></span>
              </div>

              <button class="btn btn-primary" onclick="navigasiKe('panel-transaksi')">
                <i class="fas fa-plus me-1"></i> Transaksi Belanja
              </button>
            </div>

            <div class="row g-3 mb-4">
              
              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-primary text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Jumlah Anggaran</h6>
                    <i class="fas fa-wallet fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashAnggaran">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Dana BOS Tahunan</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-danger text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Total Pengeluaran</h6>
                    <i class="fas fa-shopping-cart fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashPengeluaran">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Toko, Tukang & Guru</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card p-3 shadow-sm h-100 text-white" id="cardSisaAnggaran" style="background-color: #ffc107;"> <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Sisa Anggaran</h6>
                    <i class="fas fa-chart-pie fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashSisa">Rp 0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Saldo Tersedia</small>
                </div>
              </div>

              <div class="col-12 col-md-6 col-xl-3">
                <div class="card bg-info text-white p-3 shadow-sm h-100">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-white-50">Jumlah Transaksi</h6>
                    <i class="fas fa-list-ol fa-lg opacity-50"></i>
                  </div>
                  <h3 class="fw-bold mb-0" id="dashJmlTrans">0</h3>
                  <small class="text-white-50" style="font-size: 0.75rem;">Total Item Data</small>
                </div>
              </div>

            </div>

            <div class="card shadow-sm border-0 mt-4">
              <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-school text-primary me-2"></i> Identitas Sekolah</h5>
                
                <button class="btn btn-sm btn-outline-primary" 
                  onclick="navigasiKe('panel-data-sekolah', document.querySelector(`a[onclick*='panel-data-sekolah']`))">
                  <i class="fas fa-edit me-1"></i> Ubah Data
                </button>
              </div>
              
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 border-end-md">
                     <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Profil Sekolah</h6>
                     <table class="table table-borderless table-sm mb-0" style="font-size: 0.95rem;">
                      <tr>
                        <td width="35%" class="text-muted">Nama Sekolah</td>
                        <td class="fw-bold" id="dashNamaSekolah">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">NPSN / NSM</td>
                        <td><span id="dashNpsn" class="fw-bold">-</span> / <span id="dashNsm">-</span></td>
                      </tr>
                      <tr>
                        <td class="text-muted">Alamat</td>
                        <td id="dashAlamat">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Desa/Kelurahan</td>
                        <td id="dashKelurahan">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Kecamatan</td>
                        <td id="dashKecamatan">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Kab/Kota</td>
                        <td id="dashKabupaten">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">No. Telp / HP</td>
                        <td class="fw-bold text-success" id="dashTelp">-</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Email</td>
                        <td id="dashEmail">-</td>
                      </tr>
                     </table>
                  </div>

                  <div class="col-md-6 ps-md-4 mt-4 mt-md-0">
                     <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Pejabat Sekolah</h6>
                     <table class="table table-borderless table-sm mb-0" style="font-size: 0.95rem;">
                       <tr>
                         <td width="35%" class="text-muted">Kepala Sekolah</td>
                         <td class="fw-bold" id="dashKepala">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NIP Kepala</td>
                         <td id="dashNipKepala">-</td>
                       </tr>
                       <tr><td colspan="2" class="py-2"></td></tr>
                       <tr>
                         <td class="text-muted">Bendahara</td>
                         <td class="fw-bold" id="dashBendahara">-</td>
                       </tr>
                       <tr>
                         <td class="text-muted">NIP Bendahara</td>
                         <td id="dashNipBendahara">-</td>
                       </tr>
                     </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-toko" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-store text-primary"></i> Data Toko / Rekanan</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Toko</div>
                  <div class="card-body">
                    <form id="formToko" onsubmit="submitToko(event)">
                      <input type="hidden" id="tkId">

                      <div class="mb-3">
                        <label class="form-label">Nama Toko</label>
                        <input type="text" class="form-control" id="tkNama" placeholder="Contoh: Toko Amanah" required>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label class="form-label">Jenis Toko</label>
                          <input type="text" class="form-control" id="tkJenis" placeholder="ATK, Elektronik, dll" required>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">No. Telp/HP</label>
                          <input type="text" class="form-control" id="tkTelp" placeholder="0812...">
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Nama Pemilik</label>
                        <input type="text" class="form-control" id="tkPemilik" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Tempat TTD (Alamat/Kota/Kab)</label>
                        <input type="text" class="form-control" id="tkTempat" placeholder="Contoh: Bulukumba">
                        <small class="text-muted">Alamat/Kota tempat penandatanganan nota.</small>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Alamat Lengkap Toko</label>
                        <textarea class="form-control" id="tkAlamat" rows="2" placeholder="Jalan, No, Desa..." required></textarea>
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanToko" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan Toko
                        </button>
                        <button type="button" id="btnBatalToko" class="btn btn-secondary hidden" onclick="batalEditToko()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Toko Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-sm text-nowrap" style="font-size: 0.9rem;">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Toko</th>
                            <th>Pemilik</th>
                            <th>Jenis</th>
                            <th>Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelTokoBody">
                          <tr><td colspan="4" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-tukang" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-hammer text-primary"></i> Data Tukang / Pekerja</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Tukang</div>
                  <div class="card-body">
                    <form id="formTukang" onsubmit="submitTukang(event)">
                      <input type="hidden" id="tkgId">

                      <div class="mb-3">
                        <label class="form-label">Nama Lengkap Tukang</label>
                        <input type="text" class="form-control" id="tkgNama" placeholder="Nama sesuai KTP" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Alamat Lengkap</label>
                        <textarea class="form-control" id="tkgAlamat" rows="3" placeholder="Jalan, RT/RW, Desa..." required></textarea>
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanTukang" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        <button type="button" id="btnBatalTukang" class="btn btn-secondary hidden" onclick="batalEditTukang()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Tukang Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Lengkap</th>
                            <th>Alamat</th>
                            <th style="width: 100px;">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelTukangBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-guru" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-user-tie text-primary"></i> Data Pemesan / Guru</h2>
            
            <div class="row">
              <div class="col-md-5">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Input Data Guru</div>
                  <div class="card-body">
                    <form id="formGuru" onsubmit="submitGuru(event)">
                      <input type="hidden" id="grId">

                      <div class="mb-3">
                        <label class="form-label">Nama Lengkap Guru</label>
                        <input type="text" class="form-control" id="grNama" placeholder="Nama Lengkap & Gelar" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">NIP <small>(Opsional)</small></label>
                        <input type="text" class="form-control" id="grNip" placeholder="19...">
                      </div>

                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanGuru" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        <button type="button" id="btnBatalGuru" class="btn btn-secondary hidden" onclick="batalEditGuru()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h5 class="card-title mb-3">Daftar Guru Tersimpan</h5>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Nama Lengkap</th>
                            <th>NIP</th>
                            <th style="width: 100px;">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelGuruBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-nomor-surat" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-file-alt text-primary"></i> Pengaturan Nomor Surat</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-surat-toko" onclick="bukaTabSurat('toko')">
                  <i class="fas fa-store me-2"></i> Transaksi Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-surat-tukang" onclick="bukaTabSurat('tukang')">
                  <i class="fas fa-hammer me-2"></i> Transaksi Tukang
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-surat-setting" onclick="bukaTabSurat('setting')">
                  <i class="fas fa-cogs me-2"></i> Setting Nomor Otomatis
                </button>
              </li>
            </ul>

            <div id="view-surat-list"> 
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <div class="row g-2 mb-3 align-items-center">
                      <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                      <div class="col-auto">
                        <select id="fltTahun_surat" class="form-select form-select-sm" onchange="jalankanFilter('tabelSuratBody', 'fltTahun_surat', 'fltBulan_surat')"></select>
                      </div>
                      <div class="col-auto">
                        <select id="fltBulan_surat" class="form-select form-select-sm" onchange="jalankanFilter('tabelSuratBody', 'fltTahun_surat', 'fltBulan_surat')">
                          <option value="">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                            <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                        </select>
                      </div>
                    </div>

                    <div class="table-responsive">
                      <table class="table table-hover align-middle text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th>Tanggal</th>
                            <th>Uraian Belanja/Pekerjaan</th>
                            <th>Pihak Ketiga</th>
                            <th>Status Dokumen</th>
                            <th width="15%">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelSuratBody">
                          <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
            </div>

            <div id="view-surat-setting" class="hidden">
              <div class="card shadow-sm border-0">
                <div class="card-body">
                  
                  <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i> <strong>Panduan Format Otomatis:</strong><br>
                    Gunakan placeholder berikut dalam format surat Anda:
                    <ul>
                      <li><code>[nomor]</code> : Untuk input nomor urut surat (Contoh: 001, 002).</li>
                      <li><code>[bulan]</code> : Otomatis mengambil bulan dari tanggal transaksi (Contoh: 08, 12).</li>
                      <li><code>[tahun]</code> : Otomatis mengambil tahun dari tanggal transaksi (Contoh: 2025).</li>
                      <li><code>[apapun]</code> : Kata dalam kurung siku lain akan menjadi kolom input manual (Contoh: [kode], [romawi]).</li>
                    </ul>
                    Contoh Format: <code>B.[nomor]/MTs.21/[bulan]/[tahun]</code>
                  </div>

                  <ul class="nav nav-pills mb-3" id="pills-tab-setting" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="pills-set-toko-tab" data-bs-toggle="pill" data-bs-target="#pills-set-toko" type="button" role="tab">Setting Toko</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-set-tukang-tab" data-bs-toggle="pill" data-bs-target="#pills-set-tukang" type="button" role="tab">Setting Tukang</button>
                    </li>
                  </ul>

                  <div class="tab-content" id="pills-tabContent-setting">
                    
                    <div class="tab-pane fade show active" id="pills-set-toko" role="tabpanel">
                      
                      <div class="toggle-card p-3 rounded-3 d-flex justify-content-between align-items-center mb-4">
                        <div>
                          <label class="fw-bold d-block text-dark mb-1" for="toggleAutoToko" style="cursor: pointer;">
                            <i class="fas fa-robot text-primary me-2"></i> Penomoran Otomatis Toko
                          </label>
                          <small class="text-muted d-block" style="line-height: 1.2;">
                            Sistem akan mengisi nomor surat secara otomatis sesuai format.
                          </small>
                        </div>
                        
                        <div class="form-check form-switch custom-switch-lg mb-0">
                          <input class="form-check-input" type="checkbox" id="toggleAutoToko" onchange="toggleFormSetting('toko')">
                        </div>
                      </div>

                      <div id="formAutoToko" class="border p-4 rounded-3 bg-white shadow-sm hidden">
                          <h6 class="border-bottom pb-2 mb-3 text-primary fw-bold">Konfigurasi Format Surat Toko</h6>
                          
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Permintaan</label>
                            <input type="text" class="form-control" id="fmtTokoPermintaan" placeholder="Contoh: B.[nomor]/MTs.../[bulan]/[tahun]">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Penawaran</label>
                            <input type="text" class="form-control" id="fmtTokoPenawaran">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pemeriksaan</label>
                            <input type="text" class="form-control" id="fmtTokoPemeriksaan">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Serah Terima (BAST)</label>
                            <input type="text" class="form-control" id="fmtTokoBAST">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pembayaran</label>
                            <input type="text" class="form-control" id="fmtTokoBayar">
                          </div>
                      </div>
                    </div>

                    <div class="tab-pane fade" id="pills-set-tukang" role="tabpanel">
                      
                      <div class="toggle-card p-3 rounded-3 d-flex justify-content-between align-items-center mb-4">
                        <div>
                          <label class="fw-bold d-block text-dark mb-1" for="toggleAutoTukang" style="cursor: pointer;">
                            <i class="fas fa-magic text-warning me-2"></i> Penomoran Otomatis Tukang
                          </label>
                          <small class="text-muted d-block" style="line-height: 1.2;">
                            Aktifkan fitur ini untuk generate nomor surat tukang otomatis.
                          </small>
                        </div>
                        
                        <div class="form-check form-switch custom-switch-lg mb-0">
                          <input class="form-check-input" type="checkbox" id="toggleAutoTukang" onchange="toggleFormSetting('tukang')">
                        </div>
                      </div>
                      
                      <div id="formAutoTukang" class="border p-4 rounded-3 bg-white shadow-sm hidden">
                        <h6 class="border-bottom pb-2 mb-3 text-warning fw-bold text-dark">Konfigurasi Format Surat Tukang</h6>

                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format Surat Permintaan</label>
                          <input type="text" class="form-control" id="fmtTukangPermintaan">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pemeriksaan</label>
                          <input type="text" class="form-control" id="fmtTukangPemeriksaan">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Serah Terima (BAST)</label>
                          <input type="text" class="form-control" id="fmtTukangBAST">
                        </div>
                        <div class="mb-3">
                          <label class="form-label fw-bold small text-uppercase text-secondary">Format BA Pembayaran</label>
                          <input type="text" class="form-control" id="fmtTukangBayar">
                        </div>
                      </div>
                    </div>

                  </div>
                  
                  <div class="mt-4 border-top pt-3 text-end">
                    <button class="btn btn-primary" onclick="simpanSettingNomor()"><i class="fas fa-save me-1"></i> Simpan Pengaturan</button>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalInputAnggaran" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-warning text-dark bg-gradient">
                  <h5 class="modal-title fw-bold"><i class="fas fa-coins me-2"></i> Setup Anggaran Awal</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                  <div class="alert alert-light border-warning border-start border-4 text-dark mb-3" style="font-size: 0.95rem;">
                    <i class="fas fa-info-circle text-warning me-2"></i>
                    Sistem mendeteksi <strong>Jumlah Anggaran</strong> untuk tahun ini belum diisi atau bernilai <strong>0</strong>. 
                    <br><br>Mohon masukkan nominal Pagu Anggaran BOS Anda agar sisa saldo dapat terhitung otomatis.
                  </div>
                  
                  <div class="mb-4">
                    <label class="form-label fw-bold text-secondary">Total Anggaran (1 Tahun)</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text bg-light fw-bold">Rp</span>
                      <input type="text" class="form-control fs-4 fw-bold text-end text-primary" id="inputAnggaranPopup" 
                            placeholder="0" oninput="this.value = formatRibuanInput(this.value)">
                    </div>
                  </div>

                  <div class="d-grid">
                    <button type="button" id="btnSimpanAnggaranPopup" class="btn btn-primary btn-lg" onclick="submitAnggaranPopup()">
                      <i class="fas fa-save me-2"></i> Simpan Anggaran
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalSurat" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Kelola Nomor Surat</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="formInputSurat" onsubmit="simpanSurat(event)">
                    <input type="hidden" id="suratTransId">
                    <input type="hidden" id="suratTransTipe">
                    <input type="hidden" id="suratTransTanggal"> 
                    
                    <div id="alertManualMode" class="alert alert-info py-2 mb-3">
                      <small><i class="fas fa-info-circle"></i> Mode Manual: Silakan ketik nomor surat lengkap.</small>
                    </div>
                    
                    <div id="alertAutoMode" class="alert alert-success py-2 mb-3 hidden">
                      <small><i class="fas fa-robot"></i> Mode Otomatis: Masukkan variabel yang diminta.</small>
                    </div>

                    <div id="containerInputSurat">
                        </div>

                    <div class="modal-footer px-0 pb-0 mt-4">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="submit" id="btnSimpanSurat" class="btn btn-primary"><i class="fas fa-save me-1"></i> Simpan Dokumen</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-tanggal-surat" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-calendar-alt text-primary"></i> Pengaturan Tanggal Surat</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-tgl-toko" onclick="bukaTabTanggal('toko')">
                  <i class="fas fa-store me-2"></i> Transaksi Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-tgl-tukang" onclick="bukaTabTanggal('tukang')">
                  <i class="fas fa-hammer me-2"></i> Transaksi Tukang
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                <div class="row g-2 mb-3 align-items-center">
                  <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                  <div class="col-auto">
                    <select id="fltTahun_tgl" class="form-select form-select-sm" onchange="jalankanFilter('tabelTanggalBody', 'fltTahun_tgl', 'fltBulan_tgl')"></select>
                  </div>
                  <div class="col-auto">
                    <select id="fltBulan_tgl" class="form-select form-select-sm" onchange="jalankanFilter('tabelTanggalBody', 'fltTahun_tgl', 'fltBulan_tgl')">
                      <option value="">Semua Bulan</option>
                      <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                      <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                      <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                      <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                    </select>
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table table-hover align-middle text-nowrap">
                    <thead class="table-light">
                      <tr>
                        <th>Tanggal Transaksi</th>
                        <th>Uraian</th>
                        <th>Pihak Ketiga</th>
                        <th>Status Tanggal</th>
                        <th width="15%">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="tabelTanggalBody">
                      <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalReferensiUraian" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable"> 
              <div class="modal-content border-0 shadow-lg">
                
                <div class="modal-header bg-info text-white bg-gradient">
                  <h5 class="modal-title"><i class="fas fa-book-reader me-2"></i> Referensi Standar & Kegiatan</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                  
                  <div class="row g-2 mb-4">
                    <div class="col-md-4">
                      <label class="form-label fw-bold small text-muted">Filter Standar Pendidikan</label>
                      <select class="form-select form-select-sm" id="refFilterStandar" onchange="filterTabelReferensi()">
                        <option value="">-- Semua Standar --</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label fw-bold small text-muted">Pencarian Kata Kunci</label>
                      <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="refSearchInput" placeholder="Cari Uraian, Kode, atau Kegiatan..." onkeyup="filterTabelReferensi()">
                      </div>
                    </div>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle" style="font-size: 0.85rem;">
                      <thead class="table-light text-center sticky-top" style="top: 0; z-index: 2;">
                        <tr>
                          <th width="20%">Standar Pendidikan (SNP)</th>
                          <th width="25%">Nama Kegiatan</th>
                          <th width="10%">Kode</th>
                          <th>Nama Uraian</th>
                          <th width="8%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="bodyTabelReferensi">
                        <tr><td colspan="5" class="text-center text-muted py-4">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <div class="mt-2 text-end text-muted fst-italic" style="font-size: 0.8rem;">
                    <small>Total Data: <span id="refTotalData">0</span> Baris</small>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalTanggal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title"><i class="fas fa-calendar-day me-2"></i> Atur Tanggal Dokumen</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="formInputTanggal" onsubmit="simpanTanggal(event)">
                    <input type="hidden" id="tglTransId">
                    <input type="hidden" id="tglTransTipe">
                    
                    <div class="alert alert-success py-2 mb-3">
                      <small><i class="fas fa-info-circle"></i> Tanggal Surat Permintaan otomatis mengikuti tanggal transaksi.</small>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. Surat Permintaan</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control bg-light" id="tglSuratPermintaan" readonly>
                        <div class="form-text text-success"><i class="fas fa-lock me-1"></i> Terkunci (Sesuai Tgl Transaksi)</div>
                      </div>
                    </div>

                    <div class="mb-3 row" id="wrapTglPenawaran">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. Surat Penawaran</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglSuratPenawaran">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Pemeriksaan</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaPemeriksaan">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Serah Terima</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaSerahTerima">
                      </div>
                    </div>

                    <div class="mb-3 row">
                      <label class="col-sm-4 col-form-label fw-bold">Tgl. BA Pembayaran</label>
                      <div class="col-sm-8">
                        <input type="date" class="form-control" id="tglBaPembayaran">
                      </div>
                    </div>

                    <div class="modal-footer px-0 pb-0 mt-4">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="submit" id="btnSimpanTanggal" class="btn btn-success"><i class="fas fa-save me-1"></i> Simpan Tanggal</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalInfoBarang" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl"> 
              <div class="modal-content border-0 shadow-lg">
                
                <div class="modal-header bg-warning text-dark bg-gradient">
                  <h5 class="modal-title"><i class="fas fa-boxes me-2"></i> Referensi Barang & Harga</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                
                <div class="input-group mb-3 shadow-sm">
                  <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                  <input type="text" class="form-control border-start-0 ps-0" id="cariBarangInput" placeholder="Cari nama barang..." onkeyup="filterInfoBarang()">
                </div>

                <div class="table-responsive" style="max-height: 55vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
                  
                  <table class="table table-hover align-middle table-bordered mb-0" style="table-layout: fixed; min-width: 1000px;"> 
                    
                    <thead class="text-center sticky-top" style="z-index: 10; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                      <tr>
                        <th style="width: 22%; background-color: #f8f9fa;">Kategori</th> 
                        <th style="width: 15%; background-color: #f8f9fa;">Nama Kategori</th>
                        <th style="width: 32%; background-color: #f8f9fa;">Nama Barang/Jasa</th>
                        <th style="width: 8%;  background-color: #f8f9fa;">Satuan</th>
                        <th style="width: 15%; background-color: #f8f9fa;">Harga Referensi</th>
                        <th style="width: 8%; background-color: #f8f9fa;">Aksi</th>
                      </tr>
                    </thead>
                    
                    <tbody id="bodyInfoBarang">
                      <tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr>
                    </tbody>
                  </table>

                </div>

                <div id="paginationContainer" class="d-flex flex-column flex-sm-row justify-content-between align-items-center mt-3 pt-3 border-top hidden gap-2">
                    
                    <div class="text-center text-sm-start">
                      <small class="text-muted" style="font-size: 0.85rem;">
                        Menampilkan <span id="lblStart">0</span> - <span id="lblEnd">0</span> dari <span id="lblTotal">0</span> data
                      </small>
                    </div>

                    <div class="btn-group btn-group-sm shadow-sm">
                      
                      <button class="btn btn-outline-secondary px-3" id="btnPrevPage" onclick="gantiHalaman(-1)">
                        <i class="fas fa-chevron-left"></i> 
                        <span class="d-none d-sm-inline ms-1">Sebelumnya</span>
                      </button>
                      
                      <button class="btn btn-outline-secondary disabled px-3 fw-bold text-dark" id="lblPageIndicator" style="background-color: #f8f9fa; border-color: #6c757d;">
                        1 / 1
                      </button>
                      
                      <button class="btn btn-outline-secondary px-3" id="btnNextPage" onclick="gantiHalaman(1)">
                        <span class="d-none d-sm-inline me-1">Selanjutnya</span> 
                        <i class="fas fa-chevron-right"></i>
                      </button>

                    </div>

                </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalInfoSatuan" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content border-0 shadow-lg">
                
                <div class="modal-header bg-info text-white bg-gradient">
                  <h5 class="modal-title"><i class="fas fa-ruler-combined me-2"></i> Referensi Satuan</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                  
                  <div class="input-group mb-4 shadow-sm">
                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="cariSatuanInput" placeholder="Cari nama satuan atau kegunaan..." onkeyup="filterInfoSatuan()">
                  </div>

                  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th width="20%">Nama Satuan</th>
                          <th width="25%">Kategori</th>
                          <th>Penggunaan Umum / Contoh</th>
                        </tr>
                      </thead>
                      <tbody id="bodyInfoSatuan">
                        <tr><td colspan="3" class="text-center text-muted">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <div class="mt-3 text-end text-muted fst-italic" style="font-size: 0.8rem;">
                    <small>* Data diambil dari sheet "Satuan" di database.</small>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div id="panel-kop" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-image text-primary"></i> Pengaturan Kop Surat</h2>
            
            <div class="card shadow-sm border-0" style="max-width: 600px;">
              <div class="card-body p-4">
                
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-1"></i> Upload gambar kop surat (Header). Format: JPG/PNG. Ukuran optimal lebar 800px.
                </div>

                <div class="text-center mb-4 p-3 border rounded bg-light" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                  <img id="imgPreview" src="" alt="Preview Kop Surat" style="max-width: 100%; height: auto; display: none;">
                  <span id="txtNoImage" class="text-muted fst-italic">Belum ada kop surat yang diupload.</span>
                </div>

                <form id="formKop" onsubmit="uploadKop(event)">
                  <div class="mb-3">
                    <label class="form-label fw-bold">Pilih Gambar</label>
                    <input class="form-control" type="file" id="fileKop" accept="image/png, image/jpeg" onchange="previewImage(this)" required>
                  </div>

                  <div class="d-flex justify-content-between">
                    <button type="button" id="btnHapusKop" class="btn btn-danger hidden" onclick="aksiHapusKop()">
                      <i class="fas fa-trash-alt me-1"></i> Hapus Kop
                    </button>
                    <button type="submit" id="btnSimpanKop" class="btn btn-primary">
                      <i class="fas fa-cloud-upload-alt me-1"></i> Upload & Simpan
                    </button>
                  </div>
                </form>

              </div>
            </div>
          </div>

          <div id="panel-transaksi" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-shopping-cart text-primary"></i> Transaksi Belanja</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4" id="transaksiTabs">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-btn-toko" onclick="bukaTab('toko')">
                  <i class="fas fa-store me-2"></i> Belanja Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-btn-guru" onclick="bukaTab('guru')">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Honor Guru
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-btn-tukang" onclick="bukaTab('tukang')">
                  <i class="fas fa-hammer me-2"></i> Upah Tukang
                </button>
              </li>
            </ul>

            <div id="tab-content-toko" class="tab-section">
              
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-success py-2 mb-3">
                    <small><i class="fas fa-info-circle"></i> Mode Input: Transaksi Belanja Barang / Jasa Toko</small>
                  </div>
                  <form id="formBelanjaToko">
                    <input type="hidden" id="trTokoId">
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Transaksi</label>
                        <input type="date" class="form-control" id="trTokoTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Belanja (RKAM)</label>
                        <select class="form-select" id="trTokoUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>

                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Pilih Toko / Rekanan</label>
                        <select class="form-select" id="trTokoNama" required>
                          <option value="">-- Pilih Toko --</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Pilih Data Pemesan</label>
                        <select class="form-select" id="trTokoPemesan" required>
                          <option value="">-- Pilih Guru/Pemesan --</option>
                        </select>
                      </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="text-secondary fw-bold mb-0">
                        <i class="fas fa-boxes me-2"></i>Daftar Barang Belanjaan
                      </h6>
                      <div>
                        <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="bukaModalBarang()" title="Cek Database Barang">
                          <i class="fas fa-search me-1"></i>Info Barang
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="bukaModalSatuan()" title="Cek Referensi Satuan">
                          <i class="fas fa-ruler-combined me-1"></i>Info Satuan
                        </button>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap table-input-scroll" id="tabelItemToko">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="31%">Nama Barang</th>
                            <th width="10%">Vol</th>
                            <th width="11%">Satuan</th>
                            <th width="20%">Harga (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="8%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL BELANJA:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trTokoTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trTokoTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="action-container mt-3">
                      
                      <div class="action-group-left d-flex align-items-center gap-2">
                        
                        <button type="button" class="btn btn-outline-primary text-nowrap" onclick="tambahBaris('toko')">
                          <i class="fas fa-plus me-1"></i> Tambah Baris
                        </button>
                        
                        <div class="autocomplete-wrapper">
                          <div class="input-group">
                            <span class="input-group-text bg-white border-end-0 text-muted"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" placeholder="Cari Referensi..." oninput="handleCariBarang(this, 'toko')" autocomplete="off">
                          </div>
                          <div id="saran-barang-toko" class="suggestion-list"></div>
                        </div>

                      </div>

                      <div class="action-group-right">
                        <button type="button" id="btnBatalTokoTrans" class="btn btn-secondary hidden" onclick="batalEditTransaksi('toko')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        <button type="button" id="btnSimpanTokoTrans" class="btn btn-success" onclick="simpanTransaksi('toko')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                  <span class="fw-bold">Riwayat Transaksi Toko</span>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-danger hidden" id="btnAksiHapus_toko" onclick="eksekusiHapusBanyak('toko')">
                      <i class="fas fa-trash-alt me-1"></i> Hapus (<span id="count_toko">0</span>)
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleModeHapus('toko')">
                      <i class="fas fa-check-square me-1"></i> Pilih / Hapus
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_toko" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiToko', 'fltTahun_toko', 'fltBulan_toko')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_toko" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiToko', 'fltTahun_toko', 'fltBulan_toko')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian</th>
                          <th>Toko</th>
                          <th>Total</th>
                          <th width="10%" class="text-center">Status</th>
                          <th>Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="listTransaksiToko">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              </div> 
            <div id="tab-content-guru" class="tab-section hidden">
              
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-info py-2 mb-3"><small><i class="fas fa-info-circle"></i> Mode Input: Pembayaran Honorarium / Transport Guru</small></div>
                  <form id="formBelanjaGuru">
                    <input type="hidden" id="trGuruId">
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Pembayaran</label>
                        <input type="date" class="form-control" id="trGuruTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Pekerjaan / Kegiatan</label>
                        <select class="form-select" id="trGuruUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>
                    <div class="mb-4">
                      <label class="form-label">Keterangan <small class="text-muted">(Opsional)</small></label>
                      <textarea class="form-control" id="trGuruKeterangan" rows="2" placeholder="Contoh: Honorarium bulan Januari 2025..."></textarea>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="text-secondary fw-bold mb-0">
                        <i class="fas fa-chalkboard-teacher me-2"></i>Rincian Penerima Honor
                      </h6>
                      <div>
                        <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="bukaModalBarang()" title="Cek Database Barang">
                          <i class="fas fa-search me-1"></i>Info Barang
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="bukaModalSatuan()" title="Cek Referensi Satuan">
                          <i class="fas fa-ruler-combined me-1"></i>Info Satuan
                        </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap table-input-scroll" id="tabelItemGuru">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="31%">Nama Guru/Penerima</th>
                            <th width="10%">Vol</th>
                            <th width="11%">Satuan</th>
                            <th width="20%">Honor/Upah (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="8%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL HONOR:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trGuruTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trGuruTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="action-container mt-3">
                      
                      <div class="action-group-left">
                        <button type="button" class="btn btn-outline-primary text-nowrap w-100" onclick="tambahBaris('guru')">
                          <i class="fas fa-plus me-1"></i> Tambah Penerima
                        </button>
                      </div>

                      <div class="action-group-right">
                        <button type="button" id="btnBatalGuruTrans" class="btn btn-secondary hidden" onclick="batalEditTransaksi('guru')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        
                        <button type="button" id="btnSimpanGuruTrans" class="btn btn-success" onclick="simpanTransaksi('guru')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                  <span class="fw-bold">Riwayat Pembayaran Honor</span>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-danger hidden" id="btnAksiHapus_guru" onclick="eksekusiHapusBanyak('guru')">
                      <i class="fas fa-trash-alt me-1"></i> Hapus (<span id="count_guru">0</span>)
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleModeHapus('guru')">
                      <i class="fas fa-check-square me-1"></i> Pilih / Hapus
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_guru" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiGuru', 'fltTahun_guru', 'fltBulan_guru')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_guru" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiGuru', 'fltTahun_guru', 'fltBulan_guru')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Kegiatan</th>
                          <th>Keterangan</th>
                          <th>Total</th>
                          <th>Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="listTransaksiGuru">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              </div>
            <div id="tab-content-tukang" class="tab-section hidden">
              
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                  <div class="alert alert-warning py-2 mb-3"><small><i class="fas fa-info-circle"></i> Mode Input: Pembayaran Upah Tukang</small></div>
                  <form id="formBelanjaTukang">
                    <input type="hidden" id="trTukangId">
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <label class="form-label">Tanggal Transaksi</label>
                        <input type="date" class="form-control" id="trTukangTanggal" required>
                      </div>
                      <div class="col-md-9">
                        <label class="form-label">Uraian Pekerjaan</label>
                        <select class="form-select" id="trTukangUraian" required>
                          <option value="">-- Pilih Uraian --</option>
                        </select>
                      </div>
                    </div>
                    <div class="row mb-4">
                      <div class="col-md-6">
                        <label class="form-label">Pilih Tukang / Pekerja</label>
                        <select class="form-select" id="trTukangNama" required>
                          <option value="">-- Pilih Tukang --</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Pilih Data Pemesan</label>
                        <select class="form-select" id="trTukangPemesan" required>
                          <option value="">-- Pilih Guru --</option>
                        </select>
                      </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="text-secondary fw-bold mb-0">
                        <i class="fas fa-tools me-2"></i>Rincian Upah / Bahan
                      </h6>
                      <div>
                        <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="bukaModalBarang()" title="Cek Database Barang">
                          <i class="fas fa-search me-1"></i>Info Barang
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="bukaModalSatuan()" title="Cek Referensi Satuan">
                          <i class="fas fa-ruler-combined me-1"></i>Info Satuan
                        </button>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-bordered align-middle text-nowrap table-input-scroll" id="tabelItemTukang">
                        <thead class="table-light text-center">
                          <tr>
                            <th width="31%">Nama Tukang/Penerima</th>
                            <th width="10%">Vol</th>
                            <th width="11%">Satuan</th>
                            <th width="20%">Upah/Harga (Rp)</th>
                            <th width="20%">Jumlah (Rp)</th>
                            <th width="8%"><i class="fas fa-trash"></i></th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                          <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL UPAH:</td>
                            <td colspan="2" class="fw-bold bg-light">
                              <span id="trTukangTotalDisplay">Rp 0</span>
                              <input type="hidden" id="trTukangTotalValue" value="0">
                            </td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>

                    <div class="action-container mt-3">
                      
                      <div class="action-group-left">
                        <button type="button" class="btn btn-outline-primary text-nowrap" onclick="tambahBaris('tukang')">
                          <i class="fas fa-plus me-1"></i> Tambah Baris
                        </button>
                      </div>

                      <div class="action-group-right">
                        <button type="button" id="btnBatalTukangTrans" class="btn btn-secondary hidden" onclick="batalEditTransaksi('tukang')">
                          <i class="fas fa-times me-1"></i> Batal
                        </button>
                        
                        <button type="button" id="btnSimpanTukangTrans" class="btn btn-success" onclick="simpanTransaksi('tukang')">
                          <i class="fas fa-save me-1"></i> Simpan Transaksi
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                  <span class="fw-bold">Riwayat Transaksi Tukang</span>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-danger hidden" id="btnAksiHapus_tukang" onclick="eksekusiHapusBanyak('tukang')">
                      <i class="fas fa-trash-alt me-1"></i> Hapus (<span id="count_tukang">0</span>)
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleModeHapus('tukang')">
                      <i class="fas fa-check-square me-1"></i> Pilih / Hapus
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_tukang" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiTukang', 'fltTahun_tukang', 'fltBulan_tukang')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_tukang" class="form-select form-select-sm" onchange="jalankanFilter('listTransaksiTukang', 'fltTahun_tukang', 'fltBulan_tukang')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-sm text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian</th>
                          <th>Tukang</th>
                          <th>Total</th>
                          <th width="10%" class="text-center">Status</th>
                          <th>Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="listTransaksiTukang">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-cetak-pdf" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-print text-primary"></i> Cetak Laporan PDF</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-cetak-toko" onclick="bukaTabCetak('toko')">
                  <i class="fas fa-store me-2"></i> LPJ Toko
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-cetak-guru" onclick="bukaTabCetak('guru')">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Honor Guru
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-cetak-tukang" onclick="bukaTabCetak('tukang')">
                  <i class="fas fa-hammer me-2"></i> Upah Tukang
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold text-dark" id="tab-cetak-setting" onclick="bukaTabCetak('setting')">
                  <i class="fas fa-cog me-2"></i> Pengaturan Template
                </button>
              </li>
            </ul>

            <div class="card shadow-sm border-0">
              <div class="card-body">
                
                <div id="view-cetak-toko" class="view-cetak">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Transaksi Belanja Toko Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_toko" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-toko', 'fltTahun_cetak_toko', 'fltBulan_cetak_toko')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_toko" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-toko', 'fltTahun_cetak_toko', 'fltBulan_cetak_toko')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Belanja</th>
                          <th>Nama Toko</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-toko">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-guru" class="view-cetak hidden">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Pembayaran Honor Guru Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_guru" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-guru', 'fltTahun_cetak_guru', 'fltBulan_cetak_guru')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_guru" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-guru', 'fltTahun_cetak_guru', 'fltBulan_cetak_guru')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Kegiatan</th>
                          <th>Keterangan</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-guru">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-tukang" class="view-cetak hidden">
                  <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle"></i> Daftar Upah Tukang Siap Cetak</div>
                  <div class="row g-2 mb-3 align-items-center">
                    <div class="col-auto"><small class="fw-bold text-muted"><i class="fas fa-filter"></i> Filter:</small></div>
                    <div class="col-auto">
                      <select id="fltTahun_cetak_tukang" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-tukang', 'fltTahun_cetak_tukang', 'fltBulan_cetak_tukang')"></select>
                    </div>
                    <div class="col-auto">
                      <select id="fltBulan_cetak_tukang" class="form-select form-select-sm" onchange="jalankanFilter('tbody-cetak-tukang', 'fltTahun_cetak_tukang', 'fltBulan_cetak_tukang')">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                      </select>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle table-striped text-nowrap">
                      <thead class="table-light">
                        <tr>
                          <th>Tanggal</th>
                          <th>Uraian Pekerjaan</th>
                          <th>Nama Tukang</th>
                          <th>Total</th>
                          <th width="15%">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tbody-cetak-tukang">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div id="view-cetak-setting" class="view-cetak hidden">
                  <div class="row">
                    <div class="col-lg-5 mb-4">
                      <div class="card shadow-sm border-0">
                        <div class="card-header bg-white fw-bold py-3 text-primary">
                          <i class="fas fa-file-word me-2"></i> Input ID Google Doc
                        </div>
                        <div class="card-body">
                          <div class="alert alert-warning py-2" style="font-size: 0.85rem;">
                            <i class="fas fa-exclamation-triangle me-1"></i> <strong>Penting:</strong> Pastikan Google Doc Template Anda aksesnya diatur menjadi <em>"Siapa saja yang memiliki link dapat melihat" (Anyone with the link can view)</em> agar sistem bisa membacanya.
                          </div>

                          <form id="formTemplate" onsubmit="simpanTemplate(event)">
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Laporan Toko</label>
                              <input type="text" class="form-control font-monospace" id="tplIdToko" placeholder="Contoh: 1Fl8Jaf4j6XI...">
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Honor Guru</label>
                              <input type="text" class="form-control font-monospace" id="tplIdGuru" placeholder="Contoh: 1pC4xjpoGps...">
                            </div>
                            <div class="mb-3">
                              <label class="form-label fw-bold small">ID Template Upah Tukang</label>
                              <input type="text" class="form-control font-monospace" id="tplIdTukang" placeholder="Contoh: 1vNWFUOKI...">
                            </div>
                            
                            <div class="d-grid">
                              <button type="submit" id="btnSimpanTemplate" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Simpan Pengaturan
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <div class="col-lg-7">
                      <div class="card shadow-sm border-0">
                        <div class="card-body">
                          <h5 class="mb-3"><i class="fas fa-book-reader text-success me-2"></i> Panduan Pembuatan Template</h5>
                          
                          <div class="accordion" id="accordionPanduan">
                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                  1. Cara Mendapatkan ID Google Doc
                                </button>
                              </h2>
                              <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body bg-light">
                                  <ol class="small mb-0 ps-3">
                                    <li>Buka file Google Doc template Anda.</li>
                                    <li>Lihat pada Address Bar browser.</li>
                                    <li>Link biasanya seperti: <code>docs.google.com/document/d/<strong>ID_ADALAH_DISINI</strong>/edit</code></li>
                                    <li>Copy kode acak tersebut dan paste ke form di samping.</li>
                                  </ol>
                                </div>
                              </div>
                            </div>

                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                  2. Daftar Kode Placeholder (Wajib Copy-Paste)
                                </button>
                              </h2>
                              <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body p-0">
                                  <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                    <table class="table table-sm table-striped mb-0 small table-hover">
                                      <thead class="table-dark sticky-top">
                                        <tr>
                                          <th width="45%">Kode (Copy ke Doc)</th>
                                          <th>Keterangan Data</th>
                                        </tr>
                                      </thead>
                                      <tbody style="font-size: 0.85rem;">
                                        
                                        <tr class="table-secondary fw-bold"><td colspan="2">A. Identitas Sekolah & Pejabat</td></tr>
                                        <tr><td class="font-monospace text-danger">&lt;&lt;KOP SURAT&gt;&gt;</td><td>Gambar Kop Surat (Otomatis)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Sekolah&gt;&gt;</td><td>Nama Sekolah</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Madrasah&gt;&gt;</td><td>Alternatif Nama Sekolah</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Alamat Lengkap Sekolah&gt;&gt;</td><td>Jalan, Desa, Kecamatan, Kab.</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Alamat TTD Sekolah&gt;&gt;</td><td>Tempat/Kota Tanda Tangan</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Kecamatan&gt;&gt;</td><td>Kecamatan</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Kabupaten&gt;&gt;</td><td>Kabupaten/Kota</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Provinsi&gt;&gt;</td><td>Provinsi</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NAMA KEPALA SEKOLAH&gt;&gt;</td><td>Nama Kepala (Huruf Besar)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Kepala Sekolah&gt;&gt;</td><td>Nama Kepala (Format Standar)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NIP Kepala Sekolah&gt;&gt;</td><td>NIP Kepala Sekolah</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NAMA BENDAHARA&gt;&gt;</td><td>Nama Bendahara (Huruf Besar)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NIP Bendahara&gt;&gt;</td><td>NIP Bendahara</td></tr>

                                        <tr class="table-secondary fw-bold"><td colspan="2">B. Data Anggaran & Transaksi Umum</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Dana BOS&gt;&gt;</td><td>Jenis Anggaran (Misal: BOS Tahap 1)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Tahun Anggaran&gt;&gt;</td><td>Tahun Anggaran</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Periode&gt;&gt;</td><td>Periode (Misal: Januari - Juni)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nomor Bukti Uraian&gt;&gt;</td><td>Kode/No Bukti (dari Data Uraian)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Total&gt;&gt;</td><td>Total Angka (Rp 100.000)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Total Terbilang&gt;&gt;</td><td>Total Huruf (Seratus Ribu Rupiah)</td></tr>

                                        <tr class="table-info fw-bold"><td colspan="2">C. Khusus Transaksi Toko</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Nama Toko&gt;&gt;</td><td>Nama Toko / Rekanan</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Jenis Toko&gt;&gt;</td><td>Jenis Usaha (ATK/Elektronik)</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Alamat Lengkap Toko&gt;&gt;</td><td>Alamat Toko</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Alamat TTD Toko&gt;&gt;</td><td>Kota/Tempat Toko Menandatangani</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;NAMA PEMILIK TOKO&gt;&gt;</td><td>Nama Pemilik</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Telp Toko&gt;&gt;</td><td>Nomor HP/Telp Toko</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Uraian Pesanan&gt;&gt;</td><td>Judul Belanja/Pekerjaan</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;Nama Pemesan&gt;&gt;</td><td>Nama Guru Pemesan</td></tr>
                                        <tr><td class="font-monospace text-primary">&lt;&lt;NIP PEMESAN&gt;&gt;</td><td>NIP Guru Pemesan</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat Keluar&gt;&gt;</td><td>No. Surat Permintaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.PB&gt;&gt;</td><td>No. BA Pemeriksaan Barang</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.STB&gt;&gt;</td><td>No. BA Serah Terima</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.Bayar&gt;&gt;</td><td>No. BA Pembayaran</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal Pesanan&gt;&gt;</td><td>Tgl Surat Permintaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal Penawaran&gt;&gt;</td><td>Tgl Surat Penawaran</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.PB&gt;&gt;</td><td>Tgl BA Pemeriksaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.STB&gt;&gt;</td><td>Tgl BA Serah Terima</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.Bayar&gt;&gt;</td><td>Tgl BA Pembayaran</td></tr>
                                        
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Hari Huruf BA.PB&gt;&gt;</td><td>Nama Hari (Senin, dst)</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Tanggal Huruf BA.PB&gt;&gt;</td><td>Tanggal Terbilang (Satu, dst)</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Bulan Huruf BA.PB&gt;&gt;</td><td>Nama Bulan (Januari, dst)</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Tahun Huruf BA.PB&gt;&gt;</td><td>Tahun Terbilang (Dua Ribu, dst)</td></tr>
                                        <tr><td colspan="2" class="fst-italic text-muted small ps-4">
                                          *Format Huruf di atas juga tersedia untuk suffix: <b>BA.STB</b> dan <b>BA.Bayar</b>.<br>
                                          Contoh: <code>&lt;&lt;Hari Huruf BA.STB&gt;&gt;</code>
                                        </td></tr>

                                        <tr class="table-warning fw-bold"><td colspan="2">D. Khusus Transaksi Tukang</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;NAMA TUKANG&gt;&gt;</td><td>Nama Tukang (Huruf Besar)</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;Nama Tukang&gt;&gt;</td><td>Nama Tukang (Kapital Awal)</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;Alamat Lengkap Tukang&gt;&gt;</td><td>Alamat Tukang</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;Uraian Pekerjaan&gt;&gt;</td><td>Judul Pekerjaan</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;NAMA PEMESAN TUKANG&gt;&gt;</td><td>Nama Guru Pengawas/Pemesanan</td></tr>
                                        <tr><td class="font-monospace text-dark">&lt;&lt;NIP PEMESAN TUKANG&gt;&gt;</td><td>NIP Guru Pengawas/Pemesanan</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Surat Permintaan Tukang&gt;&gt;</td><td>No. Surat Permintaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.PP&gt;&gt;</td><td>No. BA Pemeriksaan Pekerjaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.STP&gt;&gt;</td><td>No. BA Serah Terima Pekerjaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Nomor Surat BA.Bayar&gt;&gt;</td><td>No. BA Pembayaran (Sama dgn Toko)</td></tr>
                                        
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal Surat Permintaan Tukang&gt;&gt;</td><td>Tgl Surat Permintaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.PP&gt;&gt;</td><td>Tgl BA Pemeriksaan</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.STP&gt;&gt;</td><td>Tgl BA Serah Terima</td></tr>
                                        <tr><td class="font-monospace text-muted ps-4">&lt;&lt;Tanggal BA.Bayar Tukang&gt;&gt;</td><td>Tgl BA Pembayaran</td></tr>
                                        
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Hari Huruf Tanggal BA.PP&gt;&gt;</td><td>Nama Hari Pemeriksaan</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Tanggal Huruf BA.PP&gt;&gt;</td><td>Tanggal Terbilang</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Bulan Huruf Tanggal BA.PP&gt;&gt;</td><td>Nama Bulan</td></tr>
                                        <tr><td class="font-monospace text-success ps-4">&lt;&lt;Tahun Huruf Tanggal BA.PP&gt;&gt;</td><td>Tahun Terbilang</td></tr>
                                        <tr><td colspan="2" class="fst-italic text-muted small ps-4">
                                          *Format Huruf di atas juga tersedia untuk suffix: <b>BA.STP</b> dan <b>BA.Bayar Tukang</b>.<br>
                                          Contoh: <code>&lt;&lt;Hari Huruf Tanggal BA.STP&gt;&gt;</code>
                                        </td></tr>

                                        <tr class="table-success fw-bold"><td colspan="2">E. Khusus Honor Guru</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Uraian Kegiatan&gt;&gt;</td><td>Judul Kegiatan</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Keterangan&gt;&gt;</td><td>Keterangan (Honor Bulan...)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Tanggal Transaksi&gt;&gt;</td><td>Tanggal Pembayaran</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Tanggal BA.Bayar&gt;&gt;</td><td>Tgl BA Pembayaran (Bisa diatur)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;Nama Guru 1&gt;&gt;</td><td>Nama Guru Pertama (Jika Tunggal)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NIP Guru 1&gt;&gt;</td><td>NIP Guru Pertama (Otomatis)</td></tr>
                                        <tr><td class="font-monospace">&lt;&lt;NAMA PEMESAN/GURU&gt;&gt;</td><td>Nama Pemesan/Penanggung Jawab (Kapital)</td></tr>
                                        
                                        <tr class="table-danger fw-bold"><td colspan="2">F. Khusus Tabel Rincian (Barang/Jasa)</td></tr>
                                        <tr>
                                          <td class="font-monospace">&lt;&lt;TABLE_ROW&gt;&gt;</td>
                                          <td>
                                            <b>WAJIB:</b> Letakkan kode ini di salah satu kolom pada baris tabel di Word/Doc Anda. <br>
                                            Sistem akan menduplikasi baris tersebut sebanyak jumlah barang.
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="accordion-item">
                              <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                  3. Contoh Penggunaan Placeholder Template
                                </button>
                              </h2>
                              <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionPanduan">
                                <div class="accordion-body">
                                  <p class="small text-muted mb-2">
                                    Berikut adalah contoh dokumen asli yang sudah dipasangi placeholder. Klik ikon mata untuk membuka dan melihat isinya.
                                  </p>
                                  
                                  <ul class="list-group list-group-flush small">
                                    
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-store text-primary me-2"></i>
                                          <span class="fw-bold text-dark">Template Laporan Toko</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1Fl8Jaf4j6XIyF8TghkwUsmrqEKU7obVbuOWDxlIa56o/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Toko">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-chalkboard-teacher text-success me-2"></i>
                                          <span class="fw-bold text-dark">Template Honor Guru</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1pC4xjpoGpsCaidPqoWHjJAAFgwnuDnKPsONUrd3IeFg/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Guru">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                        <div class="d-flex align-items-center">
                                          <i class="fas fa-hammer text-warning me-2"></i>
                                          <span class="fw-bold text-dark">Template Upah Tukang</span>
                                        </div>
                                        <a href="https://docs.google.com/document/d/1vNWFUOKIKob8SI0VX0ROxhZQ02Tl6eboiR2TZ7mzRqE/edit?usp=sharing" 
                                          target="_blank" class="btn btn-sm btn-outline-info rounded-circle" title="Lihat Template Tukang">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                    </li>

                                  </ul>
                                </div>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div id="panel-cetak-pendukung" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-file-signature text-primary"></i> Cetak Dokumen Pendukung</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-sub-sampul" onclick="bukaSubTab('sampul')">
                  <i class="fas fa-book me-2"></i> Cover / Sampul
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-sub-pengantar" onclick="bukaSubTab('pengantar')">
                  <i class="fas fa-envelope-open-text me-2"></i> Surat Pengantar
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-sub-verifikasi" onclick="bukaSubTab('verifikasi')">
                  <i class="fas fa-check-double me-2"></i> Lembar Verifikasi
                </button>
              </li>
            </ul>

            <div id="view-sub-sampul" class="sub-view-section">
              <div class="row">
                <div class="col-md-6 mx-auto">
                  <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                      <h5 class="card-title text-primary fw-bold mb-4">Cetak Cover Laporan</h5>
                      
                      <div class="mb-4 p-3 border rounded bg-light text-center">
                        <label class="form-label small fw-bold mb-2">Logo Cover</label>
                        
                        <div class="mb-2 position-relative d-flex justify-content-center align-items-center bg-white" 
                            style="height: 120px; border: 1px dashed #ccc; overflow: hidden;">
                          
                          <img id="logoPreviewCover" src="https://i.imgur.com/WqGSzFl.png" 
                                style="max-height: 100px; max-width: 100%; object-fit: contain;">
                          
                          <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 shadow-sm rounded-circle d-flex align-items-center justify-content-center" 
                                  style="width: 28px; height: 28px; z-index: 10;"
                                  onclick="hapusLogoCover()" title="Hapus Logo">
                            <i class="fas fa-trash-alt" style="font-size: 0.75rem;"></i>
                          </button>

                        </div>
                        <div class="input-group input-group-sm">
                          <input type="file" class="form-control" id="fileLogoCover" accept="image/*" onchange="previewLogoLocal(this, 'logoPreviewCover')">
                          <button class="btn btn-primary" type="button" onclick="uploadLogoCover()">
                            <i class="fas fa-cloud-upload-alt"></i> Upload
                          </button>
                        </div>
                        <small class="text-muted" style="font-size: 0.7rem;">*Klik Upload agar logo tersimpan di server.</small>
                      </div>

                      <div class="mb-4">
                        <label class="form-label fw-bold">Pilih Desain Template</label>
                        <select class="form-select" id="coverDesignSelect">
                          <option value="" disabled selected>Memuat daftar desain...</option>
                        </select>
                      </div>

                      <div class="mb-3">
                        <label class="form-label small text-muted">Header / Instansi</label>
                        <input type="text" class="form-control" id="inpHeaderCover" value="KEMENTERIAN AGAMA" placeholder="Contoh: YAYASAN...">
                      </div>
                      <div class="mb-3">
                        <label class="form-label small text-muted">Judul Laporan</label>
                        <input type="text" class="form-control" id="inpJudulCover" value="LAPORAN PENGGUNAAN DANA BOS">
                      </div>
                      <div class="mb-3">
                        <label class="form-label small text-muted">Periode / Keterangan</label>
                        <input type="text" class="form-control" id="inpPeriodeCover" placeholder="(Januari - Juni 2025)">
                      </div>

                      <div class="d-flex gap-2 mt-4">
                        <button id="btnSimpanCover" class="btn btn-primary flex-grow-1" onclick="simpanDataCover()">
                          <i class="fas fa-save me-2"></i> Simpan Data
                        </button>
                        <button id="btnGenCover" class="btn btn-warning flex-grow-1" onclick="generatePdfPendukung('COVER')">
                          <i class="fas fa-cog me-2"></i> Generate Cover
                        </button>
                        <button id="btnViewCover" class="btn btn-dark flex-grow-1 hidden" onclick="bukaPdfHasil('COVER')">
                          <i class="fas fa-file-pdf me-2"></i> Lihat PDF
                        </button>
                        <input type="hidden" id="urlPdfCover">
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="view-sub-pengantar" class="sub-view-section hidden">
              <div class="row">
                <div class="col-md-6 mx-auto">
                  <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                      <h5 class="card-title text-primary fw-bold mb-4">Cetak Surat Pengantar</h5>
                      
                      <div class="mb-3">
                        <label class="form-label fw-bold">Nomor Surat</label>
                        <input type="text" class="form-control" id="spNomor" placeholder="Contoh: 001/MTs.../...">
                      </div>

                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label class="form-label fw-bold">Tempat TTD</label>
                          <input type="text" class="form-control" id="spTempat">
                        </div>
                        <div class="col-md-6 mb-3">
                          <label class="form-label fw-bold">Tanggal TTD</label>
                          <input type="date" class="form-control" id="spTanggal">
                        </div>
                      </div>

                      <div class="d-flex gap-2 mt-4">
                        <button id="btnSimpanSP" class="btn btn-primary flex-grow-1" onclick="simpanDataSP()">
                          <i class="fas fa-save me-2"></i> Simpan Data
                        </button>
                        <button id="btnGenSP" class="btn btn-warning flex-grow-1" onclick="generatePdfPendukung('SP')">
                          <i class="fas fa-cog me-2"></i> Generate Surat
                        </button>
                        <button id="btnViewSp" class="btn btn-dark flex-grow-1 hidden" onclick="bukaPdfHasil('SP')">
                          <i class="fas fa-file-pdf me-2"></i> Lihat PDF
                        </button>
                        <input type="hidden" id="urlPdfSp">
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="view-sub-verifikasi" class="sub-view-section hidden">
              <div class="row">
                <div class="col-lg-10 mx-auto">
                  <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                      <h5 class="card-title text-primary fw-bold mb-4">Cetak Lembar Verifikasi</h5>

                      <div class="row g-3 mb-4 p-3 bg-light rounded border">
                        <div class="col-md-4">
                          <label class="form-label small fw-bold">Verifikator 1</label>
                          <input type="text" class="form-control form-control-sm mb-1" id="vfNama1" placeholder="Nama">
                          <input type="text" class="form-control form-control-sm" id="vfNip1" placeholder="NIP">
                        </div>
                        <div class="col-md-4">
                          <label class="form-label small fw-bold">Verifikator 2</label>
                          <input type="text" class="form-control form-control-sm mb-1" id="vfNama2" placeholder="Nama">
                          <input type="text" class="form-control form-control-sm" id="vfNip2" placeholder="NIP">
                        </div>
                        <div class="col-md-4">
                          <label class="form-label small fw-bold">Pengawas</label>
                          <input type="text" class="form-control form-control-sm mb-1" id="vfNamaPengawas" placeholder="Nama">
                          <input type="text" class="form-control form-control-sm" id="vfNipPengawas" placeholder="NIP">
                        </div>
                      </div>

                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">Daftar Item Verifikasi</h6>
                        <button class="btn btn-sm btn-outline-danger me-1" onclick="resetVerifList()">
                          <i class="fas fa-sync me-1"></i> Reset Default
                        </button>
                      </div>

                      <div class="table-responsive border rounded mb-2" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-striped align-middle mb-0">
                          <thead class="table-light sticky-top">
                            <tr>
                              <th width="5%" class="text-center">No</th>
                              <th>Nama Berkas / Dokumen</th>
                              <th width="10%" class="text-center">Aksi</th>
                            </tr>
                          </thead>
                          <tbody id="verifListBody">
                            </tbody>
                        </table>
                      </div>

                      <div class="d-flex justify-content-end mb-4">
                        <button class="btn btn-sm btn-primary" onclick="addVerifItem()">
                          <i class="fas fa-plus me-1"></i> Tambah Item
                        </button>
                      </div>

                      <div class="d-grid mt-4 gap-2 d-md-flex">
                        <button id="btnSimpanVerif" class="btn btn-primary flex-grow-1" onclick="simpanDataVerif()">
                          <i class="fas fa-save me-2"></i> Simpan Data
                        </button>
                        <button id="btnGenVerif" class="btn btn-warning flex-grow-1" onclick="generatePdfPendukung('VERIFIKASI')">
                          <i class="fas fa-cog me-2"></i> Generate Verifikasi
                        </button>
                        <button id="btnViewVerif" class="btn btn-dark flex-grow-1 hidden" onclick="bukaPdfHasil('VERIFIKASI')">
                          <i class="fas fa-file-pdf me-2"></i> Lihat PDF
                        </button>
                        <input type="hidden" id="urlPdfVerif">
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <div id="panel-berkas-pencairan" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-file-invoice-dollar text-primary"></i> Berkas Pencairan Dana</h2>

            <ul class="nav nav-tabs nav-tabs-scrollable mb-4">
              <li class="nav-item">
                <button class="nav-link active fw-bold" id="tab-pencairan-pks" onclick="bukaTabPencairan('pks')">
                  <i class="fas fa-handshake me-2"></i> PKS
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-pencairan-permohonan" onclick="bukaTabPencairan('permohonan')">
                  <i class="fas fa-envelope me-2"></i> Permohonan
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-pencairan-kuitansi" onclick="bukaTabPencairan('kuitansi')">
                  <i class="fas fa-receipt me-2"></i> Kuitansi
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold text-muted" disabled>
                  <i class="fas fa-file-contract me-2"></i> SPTJB
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link fw-bold" id="tab-pencairan-sptjm" onclick="bukaTabPencairan('sptjm')">
                  <i class="fas fa-file-signature me-2"></i> SPTJM
                </button>
              </li>
            </ul>

            <div id="view-pencairan-pks" class="view-pencairan">
              <div class="row">
                <div class="col-lg-8 mx-auto">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white py-3">
                      <h5 class="mb-0 fw-bold"><i class="fas fa-handshake me-2"></i> Perjanjian Kerja Sama (PKS)</h5>
                    </div>
                    <div class="card-body p-4">
                      
                      <div class="alert alert-warning d-flex align-items-start shadow-sm mb-4 border-0" role="alert" style="background-color: #fff3cd; border-left: 5px solid #ffc107 !important;">
                        <i class="fas fa-exclamation-triangle text-warning me-3 mt-1 fs-4"></i>
                        <div>
                          <h6 class="fw-bold text-dark mb-1">Perhatian: Format PKS Tahun 2025</h6>
                          <p class="mb-0 small text-muted" style="line-height: 1.4;">
                            Format dokumen ini mengacu pada standar PKS Tahun 2025 dan mungkin berbeda dengan format tahun berjalan. 
                            Disarankan untuk memverifikasi atau mengunduh PKS terbaru langsung melalui aplikasi <strong>ERKAM</strong>.
                          </p>
                        </div>
                      </div>

                      <form id="formPks" onsubmit="generatePks(event)">
                        
                        <h6 class="text-secondary fw-bold border-bottom pb-2 mb-3">Data Sekolah (Dapat Diedit)</h6>
                        
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label small text-muted">Nama Sekolah Lengkap</label>
                            <input type="text" class="form-control" id="pksNamaLengkap" placeholder="Contoh : Madrasah Ibtidaiyah ...." required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label small text-muted">Nama Kamad</label>
                            <input type="text" class="form-control bg-light" id="pksKamad" readonly>
                          </div>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label small text-muted">Nama Dana BOS</label>
                            <input type="text" class="form-control" id="pksDanaBos" placeholder="Contoh : Tahap 1">
                          </div>
                          
                          <div class="col-md-3">
                            <label class="form-label small text-muted">Tahun Anggaran</label>
                            <input type="text" class="form-control" id="pksTahun" placeholder="2025" 
                                  oninput="syncPksToOthers()"> 
                          </div>

                          <div class="col-md-3">
                            <label class="form-label small text-muted">Jumlah Dana</label>
                            <input type="text" class="form-control fw-bold text-success" id="pksJumlah" placeholder="Rp 0" 
                                  onkeyup="this.value = formatRibuanInput(this.value); syncPksToOthers()">
                          </div>
                        </div>

                        <div class="mb-4">
                          <label class="form-label small text-muted">Alamat Lengkap Madrasah</label>
                          <textarea class="form-control" id="pksAlamat" rows="2" placeholder="Alamat Lengkap, Kel/Desa, Kec, Kab/Kota, Provinsi"></textarea>
                        </div>

                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">Input Data PKS</h6>

                        <div class="mb-3">
                          <label class="form-label fw-bold">Nama Sekolah Singkat</label>
                          <input type="text" class="form-control" id="pksNamaSingkat" 
                                placeholder="Contoh : MTS .... / MIS ...." 
                                style="text-transform: uppercase;"
                                oninput="this.value = this.value.toUpperCase()" 
                                required>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-4">
                            <label class="form-label fw-bold">Nomor PKS</label>
                            <input type="text" class="form-control" id="pksNomorPks" placeholder="Nomor Perjanjian..." required>
                          </div>
                          <div class="col-md-4">
                            <label class="form-label fw-bold">Nomor Surat Madrasah</label>
                            <input type="text" class="form-control" id="pksNomorSurat" placeholder="Nomor Surat Keluar..." required>
                          </div>
                          <div class="col-md-4">
                            <label class="form-label fw-bold">Tanggal PKS</label>
                            <input type="date" class="form-control" id="pksTanggal" required>
                          </div>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Nomor Rekening</label>
                            <input type="text" class="form-control font-monospace" id="pksNoRek" placeholder="1234567890..." required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Atas Nama Rekening</label>
                            <input type="text" class="form-control" id="pksNamaRek" placeholder="Sesuai Buku Tabungan" required>
                          </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2 mt-4 pt-3 border-top">
                          
                          <button type="button" class="btn btn-primary" id="btnSimpanPks" onclick="simpanPks()">
                            <i class="fas fa-save me-2"></i> Simpan Data
                          </button>

                          <button type="submit" class="btn btn-success flex-grow-1" id="btnGenPks">
                            <i class="fas fa-cog me-2"></i> Generate PKS
                          </button>

                          <button type="button" id="btnLihatPksPdf" class="btn btn-dark flex-grow-1 hidden" onclick="bukaFilePks('PDF')">
                            <i class="fas fa-file-pdf me-2"></i> Lihat PDF
                          </button>
                          
                          <button type="button" id="btnUnduhPksWord" class="btn btn-info text-white flex-grow-1 hidden" onclick="bukaFilePks('WORD')">
                            <i class="fas fa-file-word me-2"></i> Unduh Dokumen (Word)
                          </button>

                          <input type="hidden" id="valPksPdfId">
                          <input type="hidden" id="valPksDocId">
                        </div>

                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="view-pencairan-permohonan" class="view-pencairan hidden">
              <div class="row">
                <div class="col-lg-8 mx-auto">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white py-3">
                      <h5 class="mb-0 fw-bold"><i class="fas fa-envelope-open-text me-2"></i> Surat Permohonan Pencairan</h5>
                    </div>
                    <div class="card-body p-4">
                      
                      <form id="formPermohonan" onsubmit="generatePermohonan(event)">
                        
                        <div class="alert alert-light border mb-4">
                          <h6 class="text-secondary fw-bold border-bottom pb-2 mb-3" style="font-size: 0.85rem;">
                            <i class="fas fa-link me-1"></i> Data Referensi (Otomatis dari PKS)
                          </h6>
                          
                          <div class="row g-2 mb-2">
                            <div class="col-md-6">
                              <label class="form-label small text-muted mb-0">Nomor PKS</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-dark border-0 ps-0" id="pmNomorPks" readonly>
                            </div>
                            <div class="col-md-6">
                              <label class="form-label small text-muted mb-0">Nama Sekolah</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-dark border-0 ps-0" id="pmNamaSekolah" readonly>
                            </div>
                          </div>
                          <div class="row g-2">
                            <div class="col-md-4">
                              <label class="form-label small text-muted mb-0">Dana BOS</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-dark border-0 ps-0" id="pmDanaBos" readonly>
                            </div>
                            <div class="col-md-4">
                              <label class="form-label small text-muted mb-0">Tahun Anggaran</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-dark border-0 ps-0" id="pmTahun" readonly>
                            </div>
                            <div class="col-md-4">
                              <label class="form-label small text-muted mb-0">Jumlah Dana</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-success border-0 ps-0" id="pmJumlah" readonly>
                              <input type="hidden" id="pmJumlahVal"> 
                            </div>
                          </div>
                        </div>

                        <h6 class="text-success fw-bold border-bottom pb-2 mb-3">Input Surat Permohonan</h6>

                        <div class="mb-3">
                          <label class="form-label fw-bold">Nomor Surat Permohonan</label>
                          <input type="text" class="form-control" id="pmNomorSurat" placeholder="Nomor surat keluar sekolah..." required>
                        </div>

                        <div class="row mb-4">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Tempat TTD</label>
                            <input type="text" class="form-control" id="pmTempat" placeholder="Contoh: Bulukumba" required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Tanggal Surat</label>
                            <input type="date" class="form-control" id="pmTanggal" required>
                          </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2 mt-4 pt-3 border-top">
                          
                          <button type="button" class="btn btn-primary" id="btnSimpanPermohonan" onclick="simpanPermohonan()">
                            <i class="fas fa-save me-2"></i> Simpan Data
                          </button>

                          <button type="submit" class="btn btn-success flex-grow-1" id="btnGenPermohonan">
                            <i class="fas fa-cog me-2"></i> Generate PDF
                          </button>

                          <button type="button" id="btnLihatPmPdf" class="btn btn-dark flex-grow-1 hidden" onclick="bukaFilePermohonan('PDF')">
                            <i class="fas fa-file-pdf me-2"></i> Lihat PDF
                          </button>
                          
                          <button type="button" id="btnUnduhPmWord" class="btn btn-info text-white flex-grow-1 hidden" onclick="bukaFilePermohonan('WORD')">
                            <i class="fas fa-file-word me-2"></i> Unduh Dokumen (Word)
                          </button>

                          <input type="hidden" id="valPmPdfId">
                          <input type="hidden" id="valPmDocId">
                        </div>

                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="view-pencairan-kuitansi" class="view-pencairan hidden">
              <div class="row">
                <div class="col-lg-8 mx-auto">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white py-3">
                      <h5 class="mb-0 fw-bold"><i class="fas fa-receipt me-2"></i> Kuitansi Penerimaan</h5>
                    </div>
                    <div class="card-body p-4">
                      
                      <form id="formKuitansi" onsubmit="generateKuitansi(event)">
                        
                        <div class="alert alert-light border mb-4">
                          <h6 class="text-secondary fw-bold border-bottom pb-2 mb-3" style="font-size: 0.85rem;">
                            <i class="fas fa-link me-1"></i> Data Referensi PKS
                          </h6>
                          
                          <div class="row g-2 mb-2">
                            <div class="col-md-6">
                              <label class="form-label small text-muted mb-0">Nomor PKS</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-dark border-0 ps-0" id="kwNomorPks" readonly>
                            </div>
                            <div class="col-md-6">
                              <label class="form-label small text-muted mb-0">Tanggal PKS</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-dark border-0 ps-0" id="kwTanggalPks" readonly>
                              <input type="hidden" id="kwTanggalPksVal">
                            </div>
                          </div>
                          <div class="row g-2">
                            <div class="col-md-6">
                              <label class="form-label small text-muted mb-0">Tahun Anggaran</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-dark border-0 ps-0" id="kwTahun" readonly>
                            </div>
                            <div class="col-md-6">
                              <label class="form-label small text-muted mb-0">Jumlah Dana</label>
                              <input type="text" class="form-control form-control-sm bg-white fw-bold text-success border-0 ps-0" id="kwJumlah" readonly>
                              <input type="hidden" id="kwJumlahVal"> 
                            </div>
                          </div>
                        </div>

                        <h6 class="text-success fw-bold border-bottom pb-2 mb-3">Input Kuitansi</h6>

                        <div class="mb-3">
                          <label class="form-label fw-bold">Nomor Surat Kuitansi</label>
                          <input type="text" class="form-control" id="kwNomorSurat" placeholder="Nomor kuitansi..." required>
                        </div>

                        <div class="row mb-4">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Tempat TTD</label>
                            <input type="text" class="form-control" id="kwTempat" placeholder="Contoh: Bulukumba" required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Tanggal TTD</label>
                            <input type="date" class="form-control" id="kwTanggal" required>
                          </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2 mt-4 pt-3 border-top">
                          
                          <button type="button" class="btn btn-primary" id="btnSimpanKuitansi" onclick="simpanKuitansi()">
                            <i class="fas fa-save me-2"></i> Simpan Data
                          </button>

                          <button type="submit" class="btn btn-success flex-grow-1" id="btnGenKuitansi">
                            <i class="fas fa-cog me-2"></i> Generate PDF
                          </button>

                          <button type="button" id="btnLihatKwPdf" class="btn btn-dark flex-grow-1 hidden" onclick="bukaFileKuitansi('PDF')">
                            <i class="fas fa-file-pdf me-2"></i> Lihat PDF
                          </button>
                          
                          <button type="button" id="btnUnduhKwWord" class="btn btn-info text-white flex-grow-1 hidden" onclick="bukaFileKuitansi('WORD')">
                            <i class="fas fa-file-word me-2"></i> Unduh Dokumen (Word)
                          </button>

                          <input type="hidden" id="valKwPdfId">
                          <input type="hidden" id="valKwDocId">
                        </div>

                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="view-pencairan-sptjm" class="view-pencairan hidden">
              <div class="row">
                <div class="col-lg-8 mx-auto">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-warning text-dark bg-opacity-25 py-3">
                      <h5 class="mb-0 fw-bold"><i class="fas fa-file-signature me-2"></i> SPTJM BOS</h5>
                    </div>
                    <div class="card-body p-4">
                      
                      <form id="formSptjm" onsubmit="generateSptjm(event)">
                        
                        <div class="alert alert-light border mb-4">
                          <h6 class="text-secondary fw-bold border-bottom pb-2 mb-3" style="font-size: 0.85rem;">
                            <i class="fas fa-sync me-1"></i> Data Otomatis (Sinkronisasi Sekolah)
                          </h6>
                          
                          <div class="mb-2">
                            <label class="form-label small text-muted mb-0">Nama Kepala (Kamad)</label>
                            <input type="text" class="form-control form-control-sm bg-light fw-bold border-0 ps-0" id="sptjmNamaKepala" readonly>
                          </div>
                          
                          <div class="mb-2">
                            <label class="form-label small text-muted mb-0">Nama Sekolah</label>
                            <input type="text" class="form-control form-control-sm bg-light fw-bold border-0 ps-0" id="sptjmNamaSekolah" readonly>
                          </div>
                          <div class="mb-2">
                            <label class="form-label small text-muted mb-0">Alamat Lengkap</label>
                            <textarea class="form-control form-control-sm bg-light fw-bold border-0 ps-0" id="sptjmAlamat" rows="2" readonly></textarea>
                          </div>
                          <div class="mb-2">
                            <label class="form-label small text-muted mb-0">Tahun Anggaran</label>
                            <input type="text" class="form-control form-control-sm bg-light fw-bold border-0 ps-0" id="sptjmTahun" readonly>
                          </div>
                        </div>

                        <h6 class="text-warning text-dark fw-bold border-bottom pb-2 mb-3">Input Kelengkapan Surat</h6>

                        <div class="mb-3">
                          <label class="form-label fw-bold">NIK Kepala Madrasah</label>
                          <input type="number" class="form-control" id="sptjmNik" placeholder="Masukkan NIK (Wajib Diisi)" required>
                          <div class="form-text">NIK diperlukan karena tidak tersedia di data sinkronisasi.</div>
                        </div>

                        <div class="row mb-4">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Tempat TTD</label>
                            <input type="text" class="form-control" id="sptjmTempat" placeholder="Contoh: Bulukumba" required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label fw-bold">Tanggal TTD</label>
                            <input type="date" class="form-control" id="sptjmTanggal" required>
                          </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2 mt-4 pt-3 border-top">
                          <button type="button" class="btn btn-primary" id="btnSimpanSptjm" onclick="simpanSptjm()">
                            <i class="fas fa-save me-2"></i> Simpan Data
                          </button>
                          <button type="submit" class="btn btn-success flex-grow-1" id="btnGenSptjm">
                            <i class="fas fa-cog me-2"></i> Generate SPTJM
                          </button>
                          <button type="button" id="btnLihatSptjmPdf" class="btn btn-dark flex-grow-1 hidden" onclick="bukaFileSptjm('PDF')">
                            <i class="fas fa-file-pdf me-2"></i> Lihat PDF
                          </button>
                          <button type="button" id="btnUnduhSptjmWord" class="btn btn-info text-white flex-grow-1 hidden" onclick="bukaFileSptjm('WORD')">
                            <i class="fas fa-file-word me-2"></i> Unduh Dokumen (Word)
                          </button>
                          <input type="hidden" id="valSptjmPdfId">
                          <input type="hidden" id="valSptjmDocId">
                        </div>

                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-uraian" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-list-ul text-primary"></i> Data Uraian Pekerjaan</h2>
            
            <div class="row">
              <div class="col-md-4">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-white fw-bold py-3">Tambah Uraian Baru</div>
                  <div class="card-body">
                    <form id="formUraian" onsubmit="submitUraian(event)">
                      <input type="hidden" id="urId">
                      
                      <div class="mb-3">
                        <label class="form-label">Nomor Bukti</label>
                        <input type="text" class="form-control" id="urNoBukti" placeholder="Contoh: 01/BOS/..." required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Uraian Pekerjaan / Belanja</label>
                        <div class="autocomplete-wrapper">
                          <textarea class="form-control" id="urNama" rows="3" 
                            placeholder="Ketik minimal 3 huruf atau kode untuk cari referensi..." 
                            required 
                            oninput="handleInputUraian(this)" 
                            autocomplete="off"></textarea>
                          
                          <div id="listSaranUraian" class="suggestion-list"></div>
                        </div>
                        <small class="text-muted" style="font-size: 0.75rem;">*Pilih dari saran yang muncul atau ketik manual jika tidak ada.</small>
                      </div>
                      
                      <div class="d-grid gap-2">
                        <button type="submit" id="btnSimpanUraian" class="btn btn-primary">
                          <i class="fas fa-plus-circle me-1"></i> Tambahkan
                        </button>
                        
                        <button type="button" id="btnBatalUraian" class="btn btn-secondary hidden" onclick="batalEdit()">
                          <i class="fas fa-times me-1"></i> Batal Edit
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-md-8">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h5 class="card-title mb-0">Daftar Uraian Tersimpan</h5>
                      <button class="btn btn-sm btn-info text-white" onclick="bukaModalReferensi()">
                        <i class="fas fa-book-open me-1"></i> Info Referensi
                      </button>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle table-striped text-nowrap">
                        <thead class="table-light">
                          <tr>
                            <th width="25%">No. Bukti</th>
                            <th>Uraian Pekerjaan</th>
                            <th width="10%">Aksi</th>
                          </tr>
                        </thead>
                        <tbody id="tabelUraianBody">
                          <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="panel-pengaturan" class="panel-content hidden">
            <h2 class="mb-4">Pengaturan Sekolah</h2>
            <div class="card shadow-sm border-0">
              <div class="card-body">
                <form>
                  <div class="mb-3">
                    <label class="form-label">Nama Kepala Sekolah</label>
                    <input type="text" class="form-control" placeholder="Nama Lengkap & Gelar">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">NIP Kepala Sekolah</label>
                    <input type="text" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nama Bendahara</label>
                    <input type="text" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Alamat Sekolah</label>
                    <textarea class="form-control" rows="3"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </form>
              </div>
            </div>
          </div>

          <div id="panel-ubah-password" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-user-lock text-primary"></i> Ubah Password</h2>
            
            <div class="card shadow-sm border-0 w-100"> 
              <div class="card-body p-4">
                
                <div class="alert alert-info py-2 mb-4">
                  <i class="fas fa-info-circle me-1"></i> Demi keamanan, Anda wajib memverifikasi password lama sebelum membuat password baru.
                </div>

                <form id="formUbahPass" onsubmit="submitUbahPassword(event)">
                  
                  <div class="mb-4">
                    <label class="form-label fw-bold">Password Lama</label>
                    <div class="input-group">
                      <input type="password" class="form-control border-end-0" id="upOldPass" required placeholder="Masukkan password saat ini">
                      <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('upOldPass', this)">
                        <i class="fas fa-eye text-muted"></i>
                      </span>
                    </div>
                  </div>

                  <hr class="my-4 text-muted opacity-25">

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold text-primary">Password Baru</label>
                      <div class="input-group">
                        <input type="password" class="form-control border-end-0" id="upNewPass" required placeholder="Minimal 6 karakter" minlength="6">
                        <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('upNewPass', this)">
                          <i class="fas fa-eye text-muted"></i>
                        </span>
                      </div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold text-primary">Konfirmasi Password Baru</label>
                      <div class="input-group">
                        <input type="password" class="form-control border-end-0" id="upConfPass" required placeholder="Ketik ulang password baru">
                        <span class="input-group-text bg-white border-start-0 cursor-pointer" onclick="togglePassword('upConfPass', this)">
                          <i class="fas fa-eye text-muted"></i>
                        </span>
                      </div>
                    </div>
                  </div>

                  <div class="d-flex justify-content-end mt-4">
                    <button type="submit" id="btnSubmitPass" class="btn btn-primary px-4 py-2">
                      <i class="fas fa-save me-2"></i> Simpan Password Baru
                    </button>
                  </div>

                </form>
              </div>
            </div>
          </div>

          <div id="panel-data-sekolah" class="panel-content hidden">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-school text-primary"></i> Data Sekolah</h2>
            </div>

            <div class="mt-4 pt-3 border-top">
              <h6 class="fw-bold text-danger"><i class="fas fa-tools"></i> Maintenance Database</h6>
              <p class="small text-muted">Klik tombol ini jika Anda mengalami error "Kolom tidak ditemukan" atau setelah update aplikasi.</p>
              <button class="btn btn-outline-danger btn-sm" onclick="jalankanMaintenance()">
                <i class="fas fa-sync"></i> Sinkronisasi Struktur Tabel
              </button>
            </div>

            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <form id="formDataSekolah">
                        
                  <h5 class="text-primary border-bottom pb-2 mb-3">Identitas Sekolah</h5>
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label fw-bold">Nama Sekolah <span class="text-danger">*</span></label>
                      <input type="text" class="form-control bg-light" id="dsNamaSekolah" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-bold">NPSN <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="dsNpsn" required placeholder="Contoh: 40319868">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">NSM <small>(Opsional Bagi Madrasah)</small></label>
                      <input type="text" class="form-control" id="dsNsm" placeholder="Contoh: 1212...">
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">No. Telp Sekolah</label>
                      <input type="text" class="form-control" id="dsTelp" placeholder="Contoh: 0812...">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Email Sekolah</label>
                      <input type="email" class="form-control" id="dsEmail">
                    </div>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Alamat Lengkap</h5>
                  <div class="mb-3">
                    <label class="form-label">Alamat Jalan/Dusun</label>
                    <textarea class="form-control" id="dsAlamat" rows="2" placeholder="Jl. Raya..."></textarea>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Provinsi</label>
                      <input type="text" class="form-control" id="dsProvinsi">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Kabupaten/Kota</label>
                      <input type="text" class="form-control" id="dsKabupaten">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Kecamatan</label>
                      <input type="text" class="form-control" id="dsKecamatan">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Kelurahan/Desa</label>
                      <input type="text" class="form-control" id="dsKelurahan">
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-bold">Tempat TTD (Alamat/Kota/Kab) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="dsTempatTTD" placeholder="Contoh: Bulukumba">
                    <small class="text-muted">Hanya isi nama Alamat/Kota/Kabupaten.</small>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Pejabat Sekolah</h5>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Nama Kepala Sekolah</label>
                      <input type="text" class="form-control" id="dsKepala" placeholder="Nama Lengkap & Gelar">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">NIP Kepala <small>(Opsional)</small></label>
                      <input type="text" class="form-control" id="dsNipKepala">
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label fw-bold">Nama Bendahara</label>
                      <input type="text" class="form-control" id="dsBendahara">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">NIP Bendahara <small>(Opsional)</small></label>
                      <input type="text" class="form-control" id="dsNipBendahara">
                    </div>
                  </div>

                  <h5 class="text-primary border-bottom pb-2 mb-3 mt-4">Pengaturan Default BOS</h5>
                  <div class="row mb-3">
                    
                    <div class="col-md-4">
                      <label class="form-label fw-bold">Nama Dana BOS</label>
                      
                      <select class="form-select" id="dsDanaBos" onchange="cekPeriodeBos()">
                        <option value="">-- Pilih Jenis --</option>
                        <option value="Lainnya">Lainnya (Manual)</option>
                        <option value="Dana BOS Tahap 1">Dana BOS Tahap 1</option>
                        <option value="Dana BOS Tahap 2">Dana BOS Tahap 2</option>
                        <option value="Dana BOS Triwulan 1">Dana BOS Triwulan 1</option>
                        <option value="Dana BOS Triwulan 2">Dana BOS Triwulan 2</option>
                        <option value="Dana BOS Triwulan 3">Dana BOS Triwulan 3</option>
                        <option value="Dana BOS Triwulan 4">Dana BOS Triwulan 4</option>
                      </select>

                      <small id="infoPeriode" class="text-muted fst-italic d-block mt-1"></small>

                      <div id="wrapManualBos" class="hidden mt-2">
                        <label class="form-label text-muted" style="font-size: 0.8rem;">Nama Dana BOS:</label>
                        <input type="text" class="form-control mb-2" id="dsDanaBosManual" placeholder="Contoh: BOS Afirmasi">
                        
                        <label class="form-label text-muted" style="font-size: 0.8rem;">Ketik Periode:</label>
                        <input type="text" class="form-control" id="dsPeriodeManual" placeholder="Contoh: Januari - Juni">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-bold">Jumlah Anggaran</label>
                      <div class="input-group">
                        <span class="input-group-text">Rp</span>
                        <input type="text" class="form-control" id="dsJumlahAnggaran" placeholder="0" oninput="this.value = formatRibuanInput(this.value)">
                      </div>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-bold">Tahun Anggaran</label>
                      <input type="number" class="form-control bg-light" id="dsTahun" readonly>
                    </div>
                  </div>

                  <div class="d-flex justify-content-end mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-primary px-4" onclick="submitDataSekolah()">
                      <i class="fas fa-save me-2"></i> Simpan Data
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div id="panel-import" class="panel-content hidden">
            <h2 class="mb-4"><i class="fas fa-file-import text-primary"></i> Import Data Excel</h2>
            
            <div class="alert alert-light border shadow-sm mb-4">
              <i class="fas fa-info-circle text-info me-2"></i>
              <strong>Panduan:</strong> Gunakan fitur ini untuk memasukkan banyak data sekaligus dari file Excel (.xlsx).
              Pastikan Anda <b>Mendownload Template</b> terlebih dahulu agar format kolom sesuai.
            </div>

            <div class="row g-3">
              <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 text-center p-3 btn-card" onclick="bukaModalImport('URAIAN')" style="cursor:pointer; transition:0.3s;">
                  <div class="card-body">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                      <i class="fas fa-list-ul fa-lg"></i>
                    </div>
                    <h5 class="card-title fw-bold">Uraian Pekerjaan</h5>
                    <p class="text-muted small">Import data RKAM / Uraian Belanja</p>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 text-center p-3 btn-card" onclick="bukaModalImport('TOKO')" style="cursor:pointer; transition:0.3s;">
                  <div class="card-body">
                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                      <i class="fas fa-store fa-lg"></i>
                    </div>
                    <h5 class="card-title fw-bold">Data Toko</h5>
                    <p class="text-muted small">Import daftar Toko / Rekanan</p>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 text-center p-3 btn-card" onclick="bukaModalImport('TUKANG')" style="cursor:pointer; transition:0.3s;">
                  <div class="card-body">
                    <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                      <i class="fas fa-hammer fa-lg"></i>
                    </div>
                    <h5 class="card-title fw-bold">Data Tukang</h5>
                    <p class="text-muted small">Import daftar Pekerja / Tukang</p>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 text-center p-3 btn-card" onclick="bukaModalImport('GURU')" style="cursor:pointer; transition:0.3s;">
                  <div class="card-body">
                    <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                      <i class="fas fa-user-tie fa-lg"></i>
                    </div>
                    <h5 class="card-title fw-bold">Pemesan / Guru</h5>
                    <p class="text-muted small">Import data Guru / Penerima Honor</p>
                  </div>
                </div>
              </div>

              <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 text-center p-3 btn-card" onclick="bukaModalImport('TRANSAKSI')" style="cursor:pointer; transition:0.3s;">
                  <div class="card-body">
                    <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                      <i class="fas fa-shopping-cart fa-lg"></i>
                    </div>
                    <h5 class="card-title fw-bold">Transaksi Belanja</h5>
                    <p class="text-muted small">Import rekapitulasi transaksi</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="modalImport" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fas fa-upload me-2"></i> Import <span id="lblImportTitle">Data</span></h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                  <input type="hidden" id="importTypeTarget">
                  
                  <div class="mb-4">
                    <label class="form-label fw-bold small text-muted text-uppercase border-bottom w-100 pb-1">Langkah 1: Siapkan Data</label>
                    <div class="p-3 bg-light rounded border text-center mt-2">
                      
                      <div id="areaGenerateBtn">
                        <button class="btn btn-outline-success fw-bold w-100 mb-2 py-2" onclick="handleGenerateTemplate()">
                          <i class="fas fa-magic me-2"></i> Generate Template
                        </button>
                        <small class="text-muted d-block" style="font-size: 0.8rem;">
                          Klik untuk membuat file Spreadsheet baru di Google Drive Anda.
                        </small>
                      </div>

                      <div id="areaViewBtn" class="hidden">
                        <div class="d-grid gap-2">
                          <div id="blockSyncRef" class="alert alert-warning py-2 mb-3 shadow-sm border-start border-5 border-warning">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <h6 class="fw-bold mb-1"><i class="fas fa-sync text-warning me-2"></i>Sinkronisasi Referensi</h6>
                                <small class="text-muted" style="font-size: 0.8rem; line-height: 1.2;">
                                  Klik ini sebelum download template agar Dropdown (Guru, Toko, Uraian, Tukang) terupdate dengan data terbaru.
                                </small>
                              </div>
                              <button onclick="jalankanSyncRef()" id="btnSyncRef" class="btn btn-warning text-dark fw-bold btn-sm px-3">
                                <i class="fas fa-sync me-1"></i> Update Data
                              </button>
                            </div>
                          </div>
                          <button class="btn btn-success fw-bold py-2" onclick="handleLihatTemplate()">
                            <i class="fas fa-external-link-alt me-2"></i> Lihat / Edit Template
                          </button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="handleDownloadTemplate()">
                            <i class="fas fa-download me-1"></i> Download File Excel (.xlsx)
                          </button>
                        </div>
                        <div class="mt-2 text-success" style="font-size: 0.8rem;">
                          <i class="fas fa-check-circle me-1"></i> File Template Tersedia
                        </div>
                      </div>

                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-bold small text-muted text-uppercase border-bottom w-100 pb-1">Langkah 2: Proses Import</label>
                    
                    <div class="mt-2 mb-3">
                      <button id="btnImportOnline" class="btn btn-primary w-100 py-2 disabled" onclick="handleImportOnline()">
                        <i class="fas fa-cloud-download-alt me-2"></i> Ambil Data dari Spreadsheet Online
                      </button>
                      <div class="form-text mt-1 text-center" style="font-size: 0.8rem;">
                        Mengambil data langsung dari template yang Anda isi di Langkah 1.
                      </div>
                    </div>

                    <div class="position-relative my-3 text-center">
                      <hr class="border-secondary opacity-25">
                      <span class="position-absolute top-50 start-50 translate-middle bg-white px-2 text-muted small">ATAU UPLOAD MANUAL</span>
                    </div>
                    
                    <div class="input-group">
                      <input type="file" class="form-control" id="fileImportInput" accept=".xlsx, .xls">
                      <button class="btn btn-secondary" onclick="handleImportFile()" title="Upload File Excel">
                        <i class="fas fa-upload"></i>
                      </button>
                    </div>
                    <div class="form-text mt-1"><i class="fas fa-info-circle me-1"></i> Upload file .xlsx manual dari komputer.</div>

                  </div>
                  
                  <div id="importProgress" class="hidden mt-3">
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 100%">Sedang Memproses Data...</div>
                    </div>
                  </div>

                </div>
                <div class="modal-footer bg-light">
                  <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Tutup</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="main-footer">
        <a href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer">
          <p>&copy; <span id="currentYear"></span> Created by Syamsul Bahri</p>
        </a>
    </footer>

    <script>

      let cacheDataGuru = [];
      let cacheSatuan = [];
      // Ganti baris: let cacheMasterUraian = []; dengan 2 variabel ini:
      let cacheUserUraian = []; // Data dari riwayat inputan user (DataUraian)
      let cacheRefUraian = [];  // Data dari Master Referensi (Sheet Uraian)
      let cacheRefLengkap = []; // Menyimpan data lengkap (A,B,C,D)

      let currentImportType = "";
      var currentTemplateId = ""; 

      // Flag untuk menandai apakah user baru saja login
      let isLoginFlow = false;

      // --- GLOBAL CACHE STORAGE (UPDATED) ---
      let DATA_CACHE = {
        toko: null,
        tukang: null,
        guru: null,
        uraian: null,
        satuan: null,
        // Cache khusus Transaksi (Digunakan bersama oleh menu Transaksi, Surat, & Tanggal)
        transaksi_toko: null,
        transaksi_tukang: null,
        transaksi_guru: null,
        // Tambahan Cache Sekolah
        sekolah: null,
        template_settings: null,
        dashboard: null,
        pendukung: null,
        pks: null
      };

      // --- STATE GLOBAL MODE HAPUS ---
      let STATE_HAPUS = { toko: false, guru: false, tukang: false };
      let SELECTED_IDS = { toko: new Set(), guru: new Set(), tukang: new Set() };

      // Variabel untuk menyimpan input mana yang sedang diketik user
      let activeSatuanInput = null;

      let dirtyPendukung = {
        COVER: false,
        SP: false,
        VERIFIKASI: false
      };

      // Helper: Menandai data berubah (Dirty)
      function setDirtyPendukung(tipe, isDirty) {
        dirtyPendukung[tipe] = isDirty;
        
        // Opsional: Ubah warna tombol simpan jadi kuning jika ada perubahan
        let btnId = '';
        if (tipe === 'COVER') btnId = 'btnSimpanCover'; // Pastikan ID button di HTML sesuai (lihat langkah 4)
        else if (tipe === 'SP') btnId = 'btnSimpanSP';
        else if (tipe === 'VERIFIKASI') btnId = 'btnSimpanVerif';

        const btn = document.getElementById(btnId);
        if (btn) {
          if (isDirty) {
            if (!btn.innerHTML.includes('*')) btn.innerHTML += '*'; // Tambah tanda bintang
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-warning');
          } else {
            btn.innerHTML = btn.innerHTML.replace('*', ''); // Hapus bintang
            btn.classList.add('btn-primary');
            btn.classList.remove('btn-warning');
          }
        }
      }

      // Helper: Pasang Listener ke Input (Dijalankan setelah data diload)
      function monitorInputPendukung(tipe) {
        let containerId = '';
        if (tipe === 'COVER') containerId = 'view-sub-sampul';
        else if (tipe === 'SP') containerId = 'view-sub-pengantar';
        else if (tipe === 'VERIFIKASI') containerId = 'view-sub-verifikasi';

        const container = document.getElementById(containerId);
        if (!container) return;

        const inputs = container.querySelectorAll('input, select, textarea');
        inputs.forEach(el => {
          // Hindari duplikasi listener dengan menimpa oninput
          el.oninput = function() {
            setDirtyPendukung(tipe, true);
          };
          el.onchange = function() { // Untuk select/date
            setDirtyPendukung(tipe, true);
          };
        });
      }

      /* --- LOGIKA NAVIGASI UTAMA (SPA) --- */
      
      // 1. Pindah Antara Login, Register, dan Admin Panel
      function switchView(viewId) {
        // Sembunyikan semua view utama
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        // Tampilkan view yang dipilih
        document.getElementById(viewId).classList.remove('hidden');
      }


      // 2. Pindah Menu Sidebar (Dashboard <-> Buat LPJ <-> Pengaturan)
      function navigasiKe(panelId, linkElement) {
        // --- TAMBAHAN: CEK SESI SEBELUM PINDAH MENU ---
        // Ini hemat kuota karena hanya jalan saat user klik menu
        const email = localStorage.getItem('userEmail');
        const token = localStorage.getItem('sessionToken');
        
        if(email && token) {
          google.script.run.withSuccessHandler(function(res){
              if(!res.valid) {
                handleSessionInvalid(); // Panggil fungsi logout paksa di atas
              }
          }).updateUserActivity(email, token);
        }
        // ----------------------------------------------
        
        // 1. Mobile Sidebar logic
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById('sidebarMenu');
          const overlay = document.getElementById('sidebarOverlay');
          if(sidebar) sidebar.classList.remove('show'); // Tambahkan if
          if(overlay) overlay.classList.remove('show'); // Tambahkan if
        }

        // 2. Hide semua panel
        document.querySelectorAll('.panel-content').forEach(el => {
            if(el && el.classList) el.classList.add('hidden'); // Tambahkan cek if(el)
        });

        // 3. Show target panel
        const targetPanel = document.getElementById(panelId);
        if(targetPanel) {
            targetPanel.classList.remove('hidden');
            
            // Beri jeda 10ms agar browser selesai merender tampilan baru sebelum scroll ke atas
            setTimeout(function() {
              window.scrollTo({
                top: 0,
                behavior: 'smooth' // Opsional: Animasi scroll halus
              });
            }, 10);
        } else {
            console.warn("Panel tidak ditemukan: " + panelId); // Debugging
        }

        // 4. Update Sidebar Active State
        if (linkElement) {
          document.querySelectorAll('.sidebar .nav-link').forEach(el => el.classList.remove('active'));
          // HANYA jalankan jika linkElement benar-benar elemen HTML
          if (linkElement.classList) { 
              linkElement.classList.add('active');
          }
        }

        // --- Logika Load Data ---
        if(panelId === 'panel-dashboard') loadDashboardStats();
        if(panelId === 'panel-data-sekolah') loadDataSekolah();
        if(panelId === 'panel-uraian') {
            loadUraianData();      // Data tabel CRUD yang sudah ada
            loadMasterReferensi(); // <-- TAMBAHKAN INI
        }
        if(panelId === 'panel-toko') loadTokoData();
        if(panelId === 'panel-tukang') loadTukangData();
        if(panelId === 'panel-guru') loadGuruData();
        if(panelId === 'panel-kop') loadKopSettings();
        
        if(panelId === 'panel-transaksi') {
          loadTransaksiOptions(); 
          if(document.getElementById('tabelItemToko').tBodies[0].rows.length === 0) tambahBaris('toko');
          if(document.getElementById('tabelItemTukang').tBodies[0].rows.length === 0) tambahBaris('tukang');
          if(document.getElementById('tabelItemGuru').tBodies[0].rows.length === 0) tambahBaris('guru');
          bukaTab('toko'); 
        }

        if(panelId === 'panel-nomor-surat') bukaTabSurat('toko');
        if(panelId === 'panel-tanggal-surat') bukaTabTanggal('toko');
        if(panelId === 'panel-cetak-pdf') bukaTabCetak('toko');

        if(panelId === 'panel-cetak-pendukung') {
          // Panggil fungsi loader utama (Batch Load)
          loadAllPendukungData(); 
        }
        if(panelId === 'panel-berkas-pencairan') bukaTabPencairan('pks');
      }

      /* --- LOGIKA APLIKASI --- */

      /**
       * Fungsi Loading dengan Pesan Dinamis
       * @param {boolean} show - Tampilkan (true) atau Sembunyikan (false)
       * @param {string} text - (Opsional) Pesan teks yang ingin ditampilkan
       */
      function toggleLoading(show, text = "Memuat...") {
        const el = document.getElementById('loading');
        const txtEl = document.getElementById('loadingText');
        
        if (show) {
          if(txtEl) txtEl.innerText = text; // Set teks sesuai permintaan
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      }

      /**
       * Mengunci/Membuka semua input & tombol dalam container tertentu
       * @param {string} containerId - ID div pembungkus (misal: 'panel-berkas-pencairan')
       * @param {boolean} isLocked - True untuk mengunci, False untuk membuka
       */
      function toggleContainerInputs(containerId, isLocked) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Ambil semua elemen interaktif
        const elements = container.querySelectorAll('input, select, textarea, button');
        
        elements.forEach(el => {
          el.disabled = isLocked;
        });

        // Efek visual (opsional: sedikit transparan saat dikunci)
        if (isLocked) {
          container.style.opacity = '0.6';
          container.style.pointerEvents = 'none'; // Mencegah klik
        } else {
          container.style.opacity = '1';
          container.style.pointerEvents = 'auto';
        }
      }

      /* --- UPDATE PADA INDEX.HTML --- */

      /* --- UPDATE HANDLER LOGIN (DENGAN TAHUN ANGGARAN) --- */
      function handleLogin(e) {
        e.preventDefault();
        
        // Update pesan loading agar user tahu sistem sedang menyiapkan database tahunan
        toggleLoading(true, "Memverifikasi & Menyiapkan Database...");
        
        const emailInput = document.getElementById('loginEmail').value;
        
        // [BARU] Ambil Tahun Anggaran yang dipilih user
        const tahunInput = document.getElementById('loginTahun').value; 
        
        const form = {
          email: emailInput,
          password: document.getElementById('loginPass').value,
          tahun: tahunInput // [BARU] Kirim parameter tahun ke server (Kode.gs)
        };

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res){
            toggleLoading(false);
            if(res.status === 'success') {
              
              // 1. BERSIHKAN DATA LAMA (Kode ini sudah benar di file Anda)
              localStorage.clear();
              DATA_CACHE = { 
                  toko: null, tukang: null, guru: null, uraian: null, satuan: null, 
                  transaksi_toko: null, transaksi_tukang: null, transaksi_guru: null, 
                  sekolah: null, template_settings: null, dashboard: null 
              };
              cacheDataGuru = [];
              cacheSatuan = [];
              
              document.getElementById('schoolNameDisplay').innerText = "";
              document.getElementById('dashNamaSekolah').innerText = "-";

              // 2. SIMPAN SESI BARU (Kode ini sudah benar)
              localStorage.setItem('userToken', res.token);
              localStorage.setItem('userName', res.namaSekolah);
              localStorage.setItem('userEmail', emailInput);
              localStorage.setItem('sessionToken', res.sessionToken);
              localStorage.setItem('userYear', tahunInput);
              
              updateTampilanTahun();
              const elName = document.getElementById('schoolNameDisplay');
              if(elName) elName.innerText = "(" + res.namaSekolah + ")";

              isLoginFlow = true;

              // 3. PINDAH KE TAMPILAN ADMIN
              switchView('view-admin');

              // Navigasi ke Dashboard (ini akan memicu loadDashboardStats)
              const linkDashboard = document.querySelector("a[onclick*='panel-dashboard']");
              navigasiKe('panel-dashboard', linkDashboard);

              // Mulai Monitor Sesi
              startSessionMonitor();

            } else {
              Swal.fire({ icon: 'error', title: 'Login Gagal', html: res.message });
            }
          })
          .loginUser(form);
      }

      function handleRegister(e) {
        e.preventDefault();
        
        // 1. AMBIL INPUT PASSWORD
        const pass1 = document.getElementById('regPass').value;
        const pass2 = document.getElementById('regPassConfirm').value;

        // --- VALIDASI BARU: PANJANG PASSWORD ---
        if (pass1.length < 6) {
          Swal.fire({
            icon: 'warning',
            title: 'Password Terlalu Pendek',
            text: 'Password minimal harus terdiri dari 6 karakter.'
          });
          return;
        }

        // 2. VALIDASI KECOCOKAN
        if (pass1 !== pass2) {
          Swal.fire({
            icon: 'warning',
            title: 'Password Tidak Cocok',
            text: 'Konfirmasi password harus sama dengan password utama.'
          });
          return;
        }

        toggleLoading(true);
        
        // Data Form
        const form = {
          namaSekolah: document.getElementById('regNama').value,
          email: document.getElementById('regEmail').value,
          password: document.getElementById('regPass').value
        };

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res){
            toggleLoading(false);
            if(res.status === 'success') {
              document.getElementById('formRegister').reset();
              
              // Pesan Sukses
              Swal.fire({
                title: 'Registrasi Berhasil!',
                text: 'Akun sekolah Anda telah aktif. Silakan login untuk memulai.',
                icon: 'success',
                confirmButtonText: 'Login Sekarang'
              }).then(() => {
                switchView('view-login');
              });
              
            } else {
              Swal.fire({ icon: 'error', title: 'Registrasi Gagal', html: res.message });
            }
          })
          .registerSchool(form);
      }

      /* --- LOGIKA SESI OTOMATIS (DIPERBAIKI) --- */
      let sessionInterval = null;

      function startSessionMonitor() {
        // Hapus interval lama jika ada
        if(sessionInterval) clearInterval(sessionInterval);
        
        console.log("Monitoring sesi aktif...");

        // Jalankan pengecekan setiap 60 detik (1 Menit)
        // Interval ini cukup untuk mendeteksi timeout 30 menit tanpa membebani server
        sessionInterval = setInterval(() => {
          const email = localStorage.getItem('userEmail');
          const token = localStorage.getItem('sessionToken');
          
          if(email && token) {
              google.script.run
                .withSuccessHandler(function(res){
                  // Jika Server merespon bahwa sesi TIDAK VALID (karena timeout 30 menit)
                  if(!res.valid) {
                    handleSessionInvalid(); // Logout otomatis
                  }
                })
                .withFailureHandler(function(err){
                   console.log("Gagal cek sesi (koneksi buruk):", err);
                   // Jangan logout dulu jika hanya error koneksi sesaat
                })
                .updateUserActivity(email, token);
          } else {
            // Jika tidak ada token di localstorage, hentikan monitor
            clearInterval(sessionInterval);
          }
        }, 60000); // Cek setiap 60.000 ms (1 Menit)
      }

      // Fungsi Logout Paksa karena Sesi Habis
      function handleSessionInvalid() {
        clearInterval(sessionInterval); // Stop interval segera
        
        // Hapus Data Lokal
        localStorage.clear();
        clearLocalCache();
        
        // Reset Cache Variable Global
        DATA_CACHE = {
            toko: null, tukang: null, guru: null, uraian: null, satuan: null,
            transaksi_toko: null, transaksi_tukang: null, transaksi_guru: null,
            sekolah: null, template_settings: null, dashboard: null
        };

        // Reset UI
        document.getElementById('formLogin').reset();
        document.getElementById('schoolNameDisplay').innerText = "";
        
        // Pindah ke Login
        switchView('view-login');

        // Tampilkan Pesan
        Swal.fire({
          icon: 'warning',
          title: 'Sesi Berakhir',
          text: 'Anda telah tidak aktif selama lebih dari 30 menit. Silakan login kembali.',
          allowOutsideClick: false,
          confirmButtonText: 'OK'
        });
      }

      // Fungsi Logout Paksa (Tanpa konfirmasi user)
      function forceLogout() {
        clearInterval(sessionInterval);
        localStorage.clear(); // Hapus semua data
        
        // Reset UI
        document.getElementById('formLogin').reset();
        switchView('view-login');
        
        Swal.fire({
          icon: 'warning',
          title: 'Sesi Berakhir',
          text: 'Akun Anda telah login di perangkat lain atau sesi telah kadaluarsa. Silakan login kembali.',
          allowOutsideClick: false,
          confirmButtonText: 'OK'
        });
      }

      function logout() {
        Swal.fire({
          title: 'Yakin ingin keluar?',
          text: "Sesi Anda akan diakhiri.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Keluar'
        }).then((result) => {
          if (result.isConfirmed) {
            const email = localStorage.getItem('userEmail');
            const token = localStorage.getItem('sessionToken');
            
            // Request Logout ke Server
            if(email && token) google.script.run.logoutUserServer(email, token);

            // --- PEMBERSIHAN TOTAL CLIENT SIDE ---
            localStorage.clear(); // Hapus Storage

            clearLocalCache();
            
            // Reset Cache Variable
            DATA_CACHE = {
                toko: null, tukang: null, guru: null, uraian: null, satuan: null,
                transaksi_toko: null, transaksi_tukang: null, transaksi_guru: null,
                sekolah: null, template_settings: null, dashboard: null
            };
            cacheDataGuru = [];
            cacheSatuan = [];

            // --- TAMBAHAN: Bersihkan Tampilan Tabel Transaksi ---
            // Agar saat login lagi tabel benar-benar bersih sebelum data baru dimuat
            document.querySelector('#listTransaksiToko').innerHTML = '<tr><td colspan="5" class="text-center">Memuat data...</td></tr>';
            document.querySelector('#listTransaksiGuru').innerHTML = '<tr><td colspan="5" class="text-center">Memuat data...</td></tr>';
            document.querySelector('#listTransaksiTukang').innerHTML = '<tr><td colspan="5" class="text-center">Memuat data...</td></tr>';
            // ----------------------------------------------------
            
            // Hentikan interval cek sesi
            if(sessionInterval) clearInterval(sessionInterval);
            
            // Reset Form UI
            document.getElementById('formLogin').reset();
            document.getElementById('schoolNameDisplay').innerText = "";
            
            // Pindah ke Login
            switchView('view-login');
            
            Swal.fire({
              icon: 'success',
              title: 'Berhasil Keluar',
              timer: 1500,
              showConfirmButton: false
            });
          }
        });
      }

      /* --- LOGIC DATA SEKOLAH --- */

      // --- LOAD DATA SEKOLAH (WITH CACHE & NULL CHECK) ---
      function loadDataSekolah(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const schoolName = localStorage.getItem('userName');
        
        document.getElementById('dsNamaSekolah').value = schoolName || '';

        if (!forceRefresh && DATA_CACHE.sekolah) {
          renderDataSekolah(DATA_CACHE.sekolah);
          return;
        }

        toggleLoading(true);
        
        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            toggleLoading(false);
            // [FIX] Cek apakah res ada isinya sebelum baca .status
            if (res && res.status === 'success') {
              DATA_CACHE.sekolah = res.data;
              renderDataSekolah(res.data);
            } else {
              // Jika null atau error
              console.warn("Gagal load data sekolah:", res);
            }
          }).getDataSekolah(token);
      }

      // --- RENDER FORM DATA SEKOLAH (DIPISAH) ---
      function renderDataSekolah(d) {
        // Isi Nama Sekolah dari Database (Source of Truth)
        if(d.namaSekolah) document.getElementById('dsNamaSekolah').value = d.namaSekolah;

        // BERSIHKAN TANDA KUTIP (') SAAT MENAMPILKAN DATA
        document.getElementById('dsNpsn').value = String(d.npsn).replace(/'/g, '');
        document.getElementById('dsNsm').value = String(d.nsm).replace(/'/g, ''); 
        
        document.getElementById('dsAlamat').value = d.alamat;
        document.getElementById('dsProvinsi').value = d.provinsi;
        document.getElementById('dsKabupaten').value = d.kabupaten;
        document.getElementById('dsKecamatan').value = d.kecamatan;
        document.getElementById('dsKelurahan').value = d.kelurahan;
        document.getElementById('dsTempatTTD').value = d.tempatTTD;
        document.getElementById('dsKepala').value = d.namaKepala;
        document.getElementById('dsNipKepala').value = String(d.nipKepala).replace(/'/g, '');
        document.getElementById('dsBendahara').value = d.namaBendahara;
        document.getElementById('dsNipBendahara').value = String(d.nipBendahara).replace(/'/g, '');
        document.getElementById('dsTelp').value = String(d.noTelp).replace(/'/g, '');
        document.getElementById('dsEmail').value = d.email;

        /* --- LOGIKA LOAD DANA BOS & PERIODE --- */
        const savedBos = d.danaBOS; 
        const savedPeriode = d.periodeAnggaran; 
        
        const selectBos = document.getElementById('dsDanaBos');
        const inputBosManual = document.getElementById('dsDanaBosManual');
        const inputPeriodeManual = document.getElementById('dsPeriodeManual');

        // Cek apakah Nama BOS ada di pilihan dropdown standar?
        let isMatch = false;
        for (let i = 0; i < selectBos.options.length; i++) {
          if (selectBos.options[i].value === savedBos) {
            isMatch = true;
            break;
          }
        }

        if (isMatch) {
          // KASUS 1: Pilihan Standar
          selectBos.value = savedBos;
          inputBosManual.value = "";       
          inputPeriodeManual.value = "";   
        } else if (savedBos) {
          // KASUS 2: Pilihan Manual
          selectBos.value = "Lainnya";     
          inputBosManual.value = savedBos; 
          inputPeriodeManual.value = savedPeriode; 
        } else {
          // KASUS 3: Belum ada data
          selectBos.value = "";
        }

        // Update UI (Keterangan text & visibilitas input manual)
        cekPeriodeBos();
        
        document.getElementById('dsJumlahAnggaran').value = formatRibuanInput(d.jumlahAnggaran);

        // --- MODIFIKASI: Kunci Tahun Anggaran Sesuai Login Sesi ---
        // Ambil tahun yang dipilih user saat login (tersimpan di LocalStorage)
        const sessionYear = localStorage.getItem('userYear');

        // Prioritas: Tahun Sesi Login > Data Database > Tahun Komputer
        document.getElementById('dsTahun').value = sessionYear || d.tahunAnggaran || new Date().getFullYear();
      }

      // --- SIMPAN DATA SEKOLAH (INVALIDATE CACHE) ---
      function submitDataSekolah() {
        const token = localStorage.getItem('userToken');
        
        // Validasi
        if(!document.getElementById('dsNpsn').value) {
          Swal.fire('Peringatan', 'NPSN Wajib diisi!', 'warning'); return;
        }
        if(!document.getElementById('dsTempatTTD').value) {
          Swal.fire('Peringatan', 'Tempat TTD Wajib diisi!', 'warning'); return;
        }

        // Logika Data BOS Terpisah
        let finalNamaBos = "";
        let finalPeriode = "";
        const dropdownVal = document.getElementById('dsDanaBos').value;

        if (dropdownVal === 'Lainnya') {
            finalNamaBos = document.getElementById('dsDanaBosManual').value.trim();
            finalPeriode = document.getElementById('dsPeriodeManual').value.trim();
            
            if (!finalNamaBos || !finalPeriode) {
                Swal.fire('Peringatan', 'Nama Dana BOS dan Periode manual wajib diisi!', 'warning');
                return;
            }
        } else {
            finalNamaBos = dropdownVal;
            // Mapping Periode Otomatis
            if (dropdownVal === 'Dana BOS Tahap 1') finalPeriode = "Januari - Juni";
            else if (dropdownVal === 'Dana BOS Tahap 2') finalPeriode = "Juli - Desember";
            else if (dropdownVal === 'Dana BOS Triwulan 1') finalPeriode = "Januari - Maret";
            else if (dropdownVal === 'Dana BOS Triwulan 2') finalPeriode = "April - Juni";
            else if (dropdownVal === 'Dana BOS Triwulan 3') finalPeriode = "Juli - September";
            else if (dropdownVal === 'Dana BOS Triwulan 4') finalPeriode = "Oktober - Desember";
        }

        const formData = {
          namaSekolah: document.getElementById('dsNamaSekolah').value,
          npsn: document.getElementById('dsNpsn').value, 
          nsm: document.getElementById('dsNsm').value,
          alamat: document.getElementById('dsAlamat').value,
          provinsi: document.getElementById('dsProvinsi').value,
          kabupaten: document.getElementById('dsKabupaten').value,
          kecamatan: document.getElementById('dsKecamatan').value,
          kelurahan: document.getElementById('dsKelurahan').value,
          tempatTTD: document.getElementById('dsTempatTTD').value,
          namaKepala: document.getElementById('dsKepala').value,
          nipKepala: document.getElementById('dsNipKepala').value,
          namaBendahara: document.getElementById('dsBendahara').value,
          nipBendahara: document.getElementById('dsNipBendahara').value,
          noTelp: document.getElementById('dsTelp').value,
          email: document.getElementById('dsEmail').value,
          danaBOS: finalNamaBos,          
          periodeAnggaran: finalPeriode,  
          jumlahAnggaran: cleanRibuan(document.getElementById('dsJumlahAnggaran').value),
          tahunAnggaran: document.getElementById('dsTahun').value
        };

        toggleLoading(true);
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          toggleLoading(false); // 1. Loading dimatikan disini
          
          if (res.status === 'success') {
            // --- UPDATE CACHE ---
            DATA_CACHE.sekolah = null;
            DATA_CACHE.dashboard = null;
            
            // --- PERBAIKAN DISINI ---
            // HAPUS atau KOMENTARI baris: loadDataSekolah(true);
            // Alasannya: Baris ini memancing spinner loading muncul lagi. 
            // Karena form sudah berisi data terbaru yang baru saja diketik user, kita tidak perlu reload.
            
            // loadDataSekolah(true);  <-- HAPUS INI

            // [TAMBAHAN BARU] Hapus cache pencairan agar dipaksa download ulang nanti
            DATA_CACHE.pencairan_lengkap = null; 
            DATA_CACHE.pks = null;
            
            Swal.fire('Sukses', 'Data Sekolah berhasil disimpan!', 'success');
            
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanDataSekolah(token, formData);
      }

      /* --- FUNGSI LOGIKA PERIODE BOS (DIPERBARUI PISAH KOLOM) --- */
      function cekPeriodeBos() {
        const select = document.getElementById('dsDanaBos');
        const info = document.getElementById('infoPeriode');
        const wrapManual = document.getElementById('wrapManualBos');
        
        const inputNama = document.getElementById('dsDanaBosManual');
        const inputPeriode = document.getElementById('dsPeriodeManual');
        
        const val = select.value;
        let teksInfo = "";
        let isManual = false;

        // Set teks info periode untuk pilihan standar
        if (val === 'Dana BOS Tahap 1') teksInfo = "Periode Januari - Juni";
        else if (val === 'Dana BOS Tahap 2') teksInfo = "Periode Juli - Desember";
        else if (val === 'Dana BOS Triwulan 1') teksInfo = "Periode Januari - Maret";
        else if (val === 'Dana BOS Triwulan 2') teksInfo = "Periode April - Juni";
        else if (val === 'Dana BOS Triwulan 3') teksInfo = "Periode Juli - September";
        else if (val === 'Dana BOS Triwulan 4') teksInfo = "Periode Oktober - Desember";
        else if (val === 'Lainnya') {
          teksInfo = ""; // Info kosong jika manual, user ketik sendiri
          isManual = true;
        }

        // Tampilkan teks info kecil di bawah dropdown
        info.innerText = teksInfo;

        // Atur Visibilitas Input Manual
        if (isManual) {
          wrapManual.classList.remove('hidden');
          inputNama.required = true;
          inputPeriode.required = true;
        } else {
          wrapManual.classList.add('hidden');
          inputNama.required = false;
          inputPeriode.required = false;
        }
      }

      /* --- LOGIC URAIAN PEKERJAAN (UPDATE) --- */

      // 1. Update Tabel dengan Tombol Edit
      function loadUraianData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelUraianBody');
        
        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE.uraian) {
          renderTabelUraian(DATA_CACHE.uraian);
          return;
        }

        // 2. FETCH SERVER
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              // SIMPAN KE CACHE
              DATA_CACHE.uraian = res.data;
              
              // --- PERBAIKAN DISINI: Simpan ke cacheUserUraian ---
              if(res.data && res.data.length > 0) {
                  // Ambil text uraiannya saja
                  cacheUserUraian = res.data.map(item => item.uraian);
              }
              
              renderTabelUraian(res.data);
            } else {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getUraianList(token);
      }

      // --- RENDER TABEL URAIAN ---
      function renderTabelUraian(data) {
        const tbody = document.getElementById('tabelUraianBody');
        tbody.innerHTML = ''; 
        
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data uraian.</td></tr>';
          return;
        }

        data.forEach(item => {
          const cleanNo = String(item.noBukti).replace(/'/g, ''); 
          
          // Escape untuk keamanan onclick
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning me-1" 
              onclick="modeEdit('${item.id}', '${escapeJsAttribute(cleanNo)}', '${escapeJsAttribute(item.uraian)}')" 
              title="Edit Data">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;

          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" 
              onclick="hapusUraian('${item.id}')" 
              title="Hapus Data">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          const row = `
            <tr>
              <td class="fw-bold text-primary">${escapeHtml(cleanNo)}</td>
              <td>${escapeHtml(item.uraian)}</td>
              <td style="white-space:nowrap;">
                ${btnEdit} ${btnHapus}
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 2. Fungsi Mengaktifkan Mode Edit (Data Uraian)
      function modeEdit(id, noBukti, uraian) {
        // Isi form dengan data yang dipilih
        document.getElementById('urId').value = id;
        document.getElementById('urNoBukti').value = noBukti;
        document.getElementById('urNama').value = uraian;

        // Ubah Tampilan Tombol (Jadi Mode Edit - Kuning)
        const btnSimpan = document.getElementById('btnSimpanUraian');
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btnSimpan.classList.remove('btn-primary');
        btnSimpan.classList.add('btn-warning');

        // Munculkan Tombol Batal
        document.getElementById('btnBatalUraian').classList.remove('hidden');

        // PERBAIKAN SCROLL: Gunakan setTimeout agar tidak loncat di mobile
        // block: 'center' akan menempatkan form di tengah layar agar mudah dilihat
        setTimeout(() => {
          const form = document.getElementById('formUraian');
          form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 3. Fungsi Batal Edit (Reset Form)
      function batalEdit() {
        document.getElementById('formUraian').reset();
        document.getElementById('urId').value = ''; // Kosongkan ID

        // Kembalikan Tombol ke Mode Tambah
        const btnSimpan = document.getElementById('btnSimpanUraian');
        btnSimpan.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btnSimpan.classList.add('btn-primary');
        btnSimpan.classList.remove('btn-warning');

        // Sembunyikan Tombol Batal
        document.getElementById('btnBatalUraian').classList.add('hidden');
      }

      // 4. Update Logic Submit (Bisa Tambah Baru atau Edit)
      /* --- UPDATE: submitUraian (Agar Riwayat Transaksi Ikut Refresh) --- */
      function submitUraian(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('urId').value; 
        
        const formData = {
          id: idEdit, 
          noBukti: document.getElementById('urNoBukti').value,
          uraian: document.getElementById('urNama').value
        };

        const btn = document.getElementById('btnSimpanUraian');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Proses...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (res.status === 'success') {
            batalEdit(); 
            
            // RESET CACHE URAIAN
            DATA_CACHE.uraian = null; 
            loadUraianData(true); 
            
            // [TAMBAHAN BARU] HAPUS SEMUA CACHE TRANSAKSI
            // Karena uraian dipakai di Toko, Tukang, dan Guru
            DATA_CACHE.transaksi_toko = null;
            DATA_CACHE.transaksi_tukang = null;
            DATA_CACHE.transaksi_guru = null;
            
            const Toast = Swal.mixin({
              toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
            });
            Toast.fire({ icon: 'success', title: res.message });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editUraianItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanUraianBaru(token, formData);
        }
      }

      // --- HAPUS URAIAN (INVALIDATE CACHE) ---
      // (Pastikan fungsi ini ada, karena sebelumnya mungkin belum didefinisikan secara eksplisit)
      function hapusUraian(id) {
        Swal.fire({
          title: 'Hapus Uraian?', 
          text: "Data uraian ini akan dihapus permanen.",
          icon: 'warning', 
          showCancelButton: true, 
          confirmButtonColor: '#d33', 
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                // RESET CACHE & RELOAD
                DATA_CACHE.uraian = null;
                loadUraianData(true);
                
                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              } else {
                Swal.fire({ icon: 'error', title: 'Gagal', html: res.message });
              }
            }).hapusUraianItem(token, id);
          }
        });
      }

      // Helper untuk membersihkan submit handler
      function finishSubmit(res, btn, originalText) {
        btn.innerHTML = originalText;
        btn.disabled = false;

        if (res.status === 'success') {
          batalEdit(); // Reset form & tombol
          loadUraianData(); // Reload tabel
          
          const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
          });
          Toast.fire({ icon: 'success', title: res.message });
        } else {
          Swal.fire({ icon: 'error', title: 'Gagal', html: res.message });
        }
      }

      /* --- LOGIC DATA TOKO --- */

      // 1. Load Data
      // --- LOAD DATA TOKO DENGAN CACHE ---
      function loadTokoData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTokoBody');
        
        // 1. CEK CACHE: Jika data ada & tidak dipaksa refresh, pakai data lokal
        if (!forceRefresh && DATA_CACHE.toko) {
          renderTabelToko(DATA_CACHE.toko);
          return;
        }

        // 2. JIKA CACHE KOSONG / FORCE REFRESH: Ambil dari Server
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              // Simpan ke Cache
              DATA_CACHE.toko = res.data;
              renderTabelToko(res.data);
            } else {
              tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getTokoList(token);
      }

      // --- FUNGSI RENDER TABEL TOKO (DIPISAH) ---
      function renderTabelToko(data) {
        const tbody = document.getElementById('tabelTokoBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Belum ada data toko.</td></tr>';
          return;
        }

        data.forEach(item => {
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning" 
              onclick="modeEditToko('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.jenis)}', '${escapeJsAttribute(item.alamat)}', '${escapeJsAttribute(item.telp)}', '${escapeJsAttribute(item.pemilik)}', '${escapeJsAttribute(item.tempat)}')" 
              title="Edit">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;
          
          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" onclick="hapusToko('${item.id}')">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          const row = `
            <tr>
              <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
              <td>${escapeHtml(item.pemilik)}<br><small class="text-muted">${escapeHtml(item.telp)}</small></td>
              <td><span class="badge bg-light text-dark border">${escapeHtml(item.jenis)}</span></td>
              <td>${btnEdit} ${btnHapus}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 2. Submit (Tambah & Edit)
      /* --- UPDATE: submitToko (Agar Riwayat Transaksi Ikut Refresh) --- */
      function submitToko(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('tkId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('tkNama').value,
          jenis: document.getElementById('tkJenis').value,
          alamat: document.getElementById('tkAlamat').value,
          telp: document.getElementById('tkTelp').value,
          pemilik: document.getElementById('tkPemilik').value,
          tempat: document.getElementById('tkTempat').value
        };

        const btn = document.getElementById('btnSimpanToko');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditToko(); 
            
            // RESET CACHE DATA TOKO
            DATA_CACHE.toko = null; 
            loadTokoData(true);
            
            // [TAMBAHAN BARU] HAPUS CACHE TRANSAKSI TOKO
            // Agar saat buka menu transaksi, nama toko yang baru muncul
            DATA_CACHE.transaksi_toko = null; 
            
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editTokoItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanTokoBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditToko(id, nama, jenis, alamat, telp, pemilik, tempat) {
        // [FIX] Data diterima sudah bersih (karena sudah di-escape di onclick), langsung pakai.
        document.getElementById('tkId').value = id;
        document.getElementById('tkNama').value = nama;
        document.getElementById('tkJenis').value = jenis;
        document.getElementById('tkAlamat').value = alamat;
        document.getElementById('tkTelp').value = telp;
        document.getElementById('tkPemilik').value = pemilik;
        document.getElementById('tkTempat').value = tempat;

        // Ubah tombol menjadi mode Edit
        const btn = document.getElementById('btnSimpanToko');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalToko').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formToko').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditToko() {
        document.getElementById('formToko').reset();
        document.getElementById('tkId').value = '';
        
        const btn = document.getElementById('btnSimpanToko');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan Toko';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalToko').classList.add('hidden');
      }

      // 5. Hapus Toko
      // --- HAPUS TOKO (INVALIDATE CACHE) ---
      function hapusToko(id) {
        Swal.fire({
          title: 'Hapus Toko?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                // RESET CACHE & RELOAD
                DATA_CACHE.toko = null;
                loadTokoData(true);
                
                Swal.fire('Terhapus!', 'Data toko dihapus.', 'success');
              }
            }).hapusTokoItem(token, id);
          }
        });
      }

      // --- HELPER UNTUK MENCEGAH ERROR TANDA KUTIP DI HTML ---
      function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
      }

      function unescapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'");
      }

      /* --- LOGIC DATA TUKANG --- */

      // 1. Load Data
      // --- LOAD DATA TUKANG DENGAN CACHE ---
      function loadTukangData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTukangBody');
        
        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE.tukang) {
          renderTabelTukang(DATA_CACHE.tukang);
          return;
        }

        // 2. FETCH SERVER JIKA CACHE KOSONG
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              // SIMPAN KE CACHE
              DATA_CACHE.tukang = res.data;
              renderTabelTukang(res.data);
            } else {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getTukangList(token);
      }

      // --- RENDER TABEL TUKANG ---
      function renderTabelTukang(data) {
        const tbody = document.getElementById('tabelTukangBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data tukang.</td></tr>';
          return;
        }

        data.forEach(item => {
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning" 
              onclick="modeEditTukang('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.alamat)}')" 
              title="Edit">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;
          
          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" onclick="hapusTukang('${item.id}')">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          const row = `
            <tr>
              <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
              <td>${escapeHtml(item.alamat)}</td>
              <td>${btnEdit} ${btnHapus}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 2. Submit (Tambah & Edit)
      /* --- UPDATE: submitTukang (Agar Riwayat Transaksi Ikut Refresh) --- */
      function submitTukang(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('tkgId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('tkgNama').value,
          alamat: document.getElementById('tkgAlamat').value
        };

        const btn = document.getElementById('btnSimpanTukang');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditTukang(); 
            
            // RESET CACHE DATA TUKANG
            DATA_CACHE.tukang = null;
            loadTukangData(true);
            
            // [TAMBAHAN BARU] HAPUS CACHE TRANSAKSI TUKANG
            DATA_CACHE.transaksi_tukang = null;

            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editTukangItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanTukangBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditTukang(id, nama, alamat) {
        document.getElementById('tkgId').value = id;
        document.getElementById('tkgNama').value = nama;
        document.getElementById('tkgAlamat').value = alamat;

        const btn = document.getElementById('btnSimpanTukang');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalTukang').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formTukang').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditTukang() {
        document.getElementById('formTukang').reset();
        document.getElementById('tkgId').value = '';
        
        const btn = document.getElementById('btnSimpanTukang');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalTukang').classList.add('hidden');
      }

      // 5. Hapus Tukang
      // --- HAPUS TUKANG (INVALIDATE CACHE) ---
      function hapusTukang(id) {
        Swal.fire({
          title: 'Hapus Data Tukang?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                // RESET CACHE & RELOAD
                DATA_CACHE.tukang = null;
                loadTukangData(true);

                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              }
            }).hapusTukangItem(token, id);
          }
        });
      }

      /* --- LOGIC DATA GURU --- */

      // 1. Load Data
      // --- LOAD DATA GURU DENGAN CACHE ---
      function loadGuruData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelGuruBody');
        
        if (!forceRefresh && DATA_CACHE.guru) {
          renderTabelGuru(DATA_CACHE.guru);
          return;
        }

        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              DATA_CACHE.guru = res.data;
              // Update juga variabel global lama untuk kompatibilitas input transaksi
              cacheDataGuru = res.data; 
              renderTabelGuru(res.data);
            } else {
              tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getGuruList(token);
      }

      // --- RENDER TABEL GURU ---
      function renderTabelGuru(data) {
        const tbody = document.getElementById('tabelGuruBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Belum ada data guru.</td></tr>';
          return;
        }

        data.forEach(item => {
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning" 
              onclick="modeEditGuru('${item.id}', '${escapeJsAttribute(item.nama)}', '${escapeJsAttribute(item.nip)}')" 
              title="Edit">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;
          
          const btnHapus = `
            <button class="btn btn-sm btn-outline-danger" onclick="hapusGuru('${item.id}')">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          const row = `
            <tr>
              <td class="fw-bold text-primary">${escapeHtml(item.nama)}</td>
              <td>${escapeHtml(item.nip)}</td>
              <td>${btnEdit} ${btnHapus}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // 2. Submit (Tambah & Edit)
      /* --- UPDATE: submitGuru (Agar Riwayat Transaksi Ikut Refresh) --- */
      function submitGuru(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const idEdit = document.getElementById('grId').value;
        
        const formData = {
          id: idEdit,
          nama: document.getElementById('grNama').value,
          nip: document.getElementById('grNip').value
        };

        const btn = document.getElementById('btnSimpanGuru');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const handler = function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          if (res.status === 'success') {
            batalEditGuru(); 
            
            // RESET CACHE DATA GURU
            DATA_CACHE.guru = null;
            loadGuruData(true);
            
            // [TAMBAHAN BARU] HAPUS SEMUA CACHE TRANSAKSI
            // Karena Nama Guru bisa muncul di Transaksi Guru, Toko (Pemesan), dan Tukang (Pemesan)
            DATA_CACHE.transaksi_guru = null;
            DATA_CACHE.transaksi_toko = null;
            DATA_CACHE.transaksi_tukang = null;
            
            Swal.fire({
              toast: true, position: 'top-end', icon: 'success', 
              title: res.message, showConfirmButton: false, timer: 3000
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).editGuruItem(token, formData);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handler).simpanGuruBaru(token, formData);
        }
      }

      // 3. Mode Edit
      function modeEditGuru(id, nama, nip) {
        document.getElementById('grId').value = id;
        document.getElementById('grNama').value = nama;
        // Handle jika NIP kosong/dash
        document.getElementById('grNip').value = (nip === '-' || !nip) ? '' : nip;

        const btn = document.getElementById('btnSimpanGuru');
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btn.classList.replace('btn-primary', 'btn-warning');
        document.getElementById('btnBatalGuru').classList.remove('hidden');
        
        setTimeout(() => {
          document.getElementById('formGuru').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }

      // 4. Batal Edit
      function batalEditGuru() {
        document.getElementById('formGuru').reset();
        document.getElementById('grId').value = '';
        
        const btn = document.getElementById('btnSimpanGuru');
        btn.innerHTML = '<i class="fas fa-plus-circle me-1"></i> Tambahkan';
        btn.classList.replace('btn-warning', 'btn-primary');
        document.getElementById('btnBatalGuru').classList.add('hidden');
      }

      // 5. Hapus Guru
      // --- HAPUS GURU (INVALIDATE CACHE) ---
      function hapusGuru(id) {
        Swal.fire({
          title: 'Hapus Data Guru?', text: "Data tidak bisa dikembalikan.",
          icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if(res.status === 'success') {
                // RESET CACHE
                DATA_CACHE.guru = null;
                loadGuruData(true);
                
                Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
              }
            }).hapusGuruItem(token, id);
          }
        });
      }

      /* --- LOGIC PENGATURAN KOP SURAT --- */

      // 1. Load Gambar yang tersimpan (dari Server)
      function loadKopSettings() {
        const token = localStorage.getItem('userToken');
        const imgEl = document.getElementById('imgPreview');
        const txtEl = document.getElementById('txtNoImage');
        const btnHapus = document.getElementById('btnHapusKop');

        // Reset tampilan dulu
        imgEl.style.display = 'none';
        txtEl.style.display = 'block';
        btnHapus.classList.add('hidden');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success' && res.fileId) {
            // Trik menampilkan gambar dari Drive: gunakan endpoint thumbnail
            // atau export=view. Thumbnail lebih aman dari CORS biasanya.
            const imageUrl = "https://drive.google.com/thumbnail?id=" + res.fileId + "&sz=w1000"; 
            
            imgEl.src = imageUrl;
            imgEl.style.display = 'block';
            txtEl.style.display = 'none';
            btnHapus.classList.remove('hidden'); // Munculkan tombol hapus
          }
        }).getKopSurat(token);
      }

      // 2. Preview Gambar Lokal (Sebelum Upload)
      function previewImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const imgEl = document.getElementById('imgPreview');
            const txtEl = document.getElementById('txtNoImage');
            
            imgEl.src = e.target.result;
            imgEl.style.display = 'block';
            txtEl.style.display = 'none';
          }
          
          reader.readAsDataURL(input.files[0]);
        }
      }

      // 3. Upload Gambar ke Server
      function uploadKop(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileKop');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        
        // Validasi Ukuran (Misal Max 2MB agar script tidak timeout)
        if (file.size > 2 * 1024 * 1024) {
          Swal.fire('File Terlalu Besar', 'Maksimal ukuran file adalah 2MB', 'warning');
          return;
        }

        const btn = document.getElementById('btnSimpanKop');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengupload...';
        btn.disabled = true;

        // Baca File sebagai Base64
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function() {
          // Ambil string base64 murni (hapus 'data:image/jpeg;base64,')
          const rawBase64 = reader.result.split(',')[1]; 
          const payload = {
            base64: rawBase64,
            mimeType: file.type
          };

          const token = localStorage.getItem('userToken');

          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (res.status === 'success') {
              Swal.fire('Sukses', 'Kop Surat berhasil disimpan!', 'success');
              document.getElementById('formKop').reset();
              loadKopSettings(); // Reload gambar dari server
            } else {
              Swal.fire({ icon: 'error', title: 'Gagal Upload', html: res.message });
            }
          }).simpanKopSurat(token, payload);
        };
      }

      // 4. Hapus Kop Surat
      function aksiHapusKop() {
        Swal.fire({
          title: 'Hapus Kop Surat?',
          text: "Kop surat akan dihapus dari sistem.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            
            google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
              if (res.status === 'success') {
                Swal.fire('Terhapus', 'Kop surat telah dihapus', 'success');
                loadKopSettings(); // Refresh tampilan
              } else {
                Swal.fire({ icon: 'error', title: 'Gagal Menghapus', html: res.message });
              }
            }).hapusKopSurat(token);
          }
        });
      }

      /* --- LOGIC TRANSAKSI BELANJA (DIPERBARUI) --- */

      // 1. Tab Switching (Diperbarui untuk load data list)
      function bukaTab(tabName) {
        // Hide semua content tab
        document.getElementById('tab-content-toko').classList.add('hidden');
        document.getElementById('tab-content-tukang').classList.add('hidden');
        document.getElementById('tab-content-guru').classList.add('hidden');
        
        // Reset active buttons
        document.getElementById('tab-btn-toko').classList.remove('active');
        document.getElementById('tab-btn-tukang').classList.remove('active');
        document.getElementById('tab-btn-guru').classList.remove('active');

        // Show selected tab
        document.getElementById('tab-content-' + tabName).classList.remove('hidden');
        document.getElementById('tab-btn-' + tabName).classList.add('active');

        // LOAD DATA LIST TRANSAKSI (Pakai Cache otomatis)
        if(tabName === 'toko') loadTransaksiData('TOKO');
        if(tabName === 'tukang') loadTransaksiData('TUKANG');
        if(tabName === 'guru') loadTransaksiData('GURU');
      }

      // 2. Load Data List Transaksi (PERBAIKAN: HANDLING TANDA KUTIP)
      // --- LOAD DATA TRANSAKSI UTAMA (WITH CACHE) ---
      function loadTransaksiData(tipeRaw, forceRefresh = false) {
        const tipe = tipeRaw.toUpperCase(); // Pastikan format TOKO/TUKANG/GURU
        const tipeKey = tipe.toLowerCase(); // Format key cache: toko/tukang/guru
        const cacheKey = 'transaksi_' + tipeKey;
        
        // Tentukan Target Tabel
        let targetId;
        if (tipe === 'TOKO') targetId = 'listTransaksiToko';
        else if (tipe === 'TUKANG') targetId = 'listTransaksiTukang';
        else targetId = 'listTransaksiGuru';

        const tbody = document.getElementById(targetId);

        // 1. CEK CACHE
        // Jika data sudah ada di memori (dari menu Surat/Tanggal atau tab sebelah), pakai langsung!
        if (!forceRefresh && DATA_CACHE[cacheKey]) {
          renderRiwayatTransaksi(DATA_CACHE[cacheKey], tipe, tbody);
          return;
        }

        // 2. FETCH SERVER JIKA CACHE KOSONG
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        const token = localStorage.getItem('userToken');

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              // SIMPAN KE CACHE GLOBAL
              DATA_CACHE[cacheKey] = res.data;
              
              renderRiwayatTransaksi(res.data, tipe, tbody);
            } else {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
            }
          }).getTransaksiList(token, tipe);
      }

      // 1. Fungsi Unified Render (Gunakan ini untuk menggantikan renderRiwayatTransaksi & renderTabelRiwayat)
      // GANTI SELURUH FUNGSI renderRiwayatTransaksi DI FILE Index.html DENGAN INI
      function renderRiwayatTransaksi(data, tipeRaw, tbodyOrId) {
        // 1. Normalisasi Input
        const tipe = tipeRaw.toLowerCase(); // toko/guru/tukang
        const tbody = (typeof tbodyOrId === 'string') ? document.getElementById(tbodyOrId) : tbodyOrId;
        
        if (!tbody) return;

        // 2. Ambil State Mode Hapus (Untuk Checkbox)
        const isModeHapus = (typeof STATE_HAPUS !== 'undefined' && STATE_HAPUS[tipe] === true);
        const selectedSet = (typeof SELECTED_IDS !== 'undefined') ? SELECTED_IDS[tipe] : new Set();

        // --- A. UPDATE HEADER (THEAD) SECARA DINAMIS ---
        const table = tbody.parentElement;
        let thead = table.querySelector('thead');
        
        if (!thead) {
          thead = document.createElement('thead');
          thead.className = "table-light";
          table.insertBefore(thead, tbody);
        }

        // Definisi Kolom Header
        let cols = [];
        
        // [Kolom 1] Checkbox
        if (isModeHapus) {
          cols.push({ title: `<input type="checkbox" class="form-check-input border-secondary" onclick="toggleSelectAll('${tipe}', this)" title="Pilih Semua">`, width: '5%', align: 'center' });
        }
        
        // [Kolom Standar]
        cols.push({ title: 'Tanggal', width: '' });
        
        if (tipe === 'guru') {
          cols.push({ title: 'Uraian Kegiatan', width: '' });
          cols.push({ title: 'Keterangan', width: '' });
        } else {
          cols.push({ title: 'Uraian', width: '' });
          const labelPihak = (tipe === 'toko') ? 'Toko' : 'Tukang';
          cols.push({ title: labelPihak, width: '' });
        }
        
        cols.push({ title: 'Total', width: '' });

        // [Kolom Status] (Kecuali Guru)
        if (tipe !== 'guru') {
          cols.push({ title: 'Status', width: '10%', align: 'center' });
        }

        cols.push({ title: 'Aksi', width: '15%' });

        // Render HTML Header
        let headHtml = '<tr>';
        cols.forEach(c => {
          const style = c.width ? `width:${c.width};` : '';
          const cls = c.align ? `text-${c.align}` : '';
          headHtml += `<th class="${cls}" style="${style}">${c.title}</th>`;
        });
        headHtml += '</tr>';
        thead.innerHTML = headHtml;

        // --- B. RENDER BODY (TBODY) ---
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="${cols.length}" class="text-center text-muted py-3">Belum ada riwayat transaksi.</td></tr>`;
          return;
        }

        data.forEach(item => {
          // Encode data untuk parameter onclick
          const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");
          
          let rowHtml = '<tr>';

          // 1. Sel Checkbox
          if (isModeHapus) {
            const isChecked = selectedSet.has(item.id) ? 'checked' : '';
            rowHtml += `
              <td class="text-center">
                <input type="checkbox" class="form-check-input" style="cursor:pointer;" onchange="handleCheck('${tipe}', '${item.id}')" ${isChecked}>
              </td>`;
          }

          // 2. Sel Tanggal
          rowHtml += `<td>${item.tanggalDisplay || '-'}</td>`;

          // 3. Sel Uraian & Pihak
          if (tipe === 'guru') {
              rowHtml += `<td><div class="text-truncate" style="max-width: 200px;" title="${escapeHtml(item.uraian)}">${escapeHtml(item.uraian)}</div></td>`;
              rowHtml += `<td>${escapeHtml(item.pihakKetiga || '-')}</td>`;
          } else {
              rowHtml += `<td><div class="text-truncate" style="max-width: 200px;" title="${escapeHtml(item.uraian)}">${escapeHtml(item.uraian)}</div></td>`;
              rowHtml += `<td>${escapeHtml(item.pihakKetiga || '-')}</td>`;
          }

          // 4. Sel Total
          rowHtml += `<td class="fw-bold">${formatRupiahJS(item.total)}</td>`;

          // 5. SEL STATUS (ICON KOTAK)
          if (tipe !== 'guru') {
            const s = item.dataSurat || {};
            const t = item.dataTanggal || {};
            
            let keys = ['permintaan', 'baPemeriksaan', 'baSerahTerima', 'baPembayaran'];
            if (tipe === 'toko') keys.push('penawaran'); 
            
            let filled = 0;
            let totalTarget = keys.length * 2; 
            
            keys.forEach(k => { 
              if (s[k] && String(s[k]).trim() !== '') filled++; 
              if (t[k] && String(t[k]).trim() !== '') filled++; 
            });

            let btnClass = 'btn-outline-warning'; 
            let iconClass = 'fa-exclamation-circle';
            let tooltip = `Status: Sebagian (${filled}/${totalTarget})`;

            if (filled === 0) {
                btnClass = 'btn-outline-secondary'; 
                iconClass = 'fa-file-contract';
                tooltip = 'Status: Belum Dilengkapi';
            } else if (filled === totalTarget) {
                btnClass = 'btn-outline-success'; 
                iconClass = 'fa-check-circle';
                tooltip = 'Status: Lengkap';
            }

            rowHtml += `
              <td class="text-center">
                <button class="btn btn-sm ${btnClass}" onclick="lihatStatusDokumen('${dataJson}')" title="${tooltip}">
                  <i class="fas ${iconClass}"></i>
                </button>
              </td>
            `;
          }

          // 6. SEL AKSI (Detail, Edit, Hapus)
          
          // Tombol Lihat Detail
          const btnDetail = `
            <button class="btn btn-sm btn-outline-info me-1" onclick="lihatDetailTransaksi('${dataJson}')" title="Lihat Rincian">
              <i class="fas fa-eye"></i>
            </button>
          `;

          // Tombol Edit (SUDAH DITAMBAHKAN KEMBALI)
          const btnEdit = `
            <button class="btn btn-sm btn-outline-warning me-1" onclick="modeEditTransaksi('${tipe}', '${dataJson}')" title="Edit Transaksi">
              <i class="fas fa-pencil-alt"></i>
            </button>
          `;
          
          // Tombol Hapus (Hanya muncul jika TIDAK mode hapus massal)
          let btnHapus = '';
          if (!isModeHapus) {
              btnHapus = `
                <button class="btn btn-sm btn-outline-danger" onclick="hapusTransaksi('${item.id}', '${tipe}')" title="Hapus Item Ini">
                  <i class="fas fa-trash-alt"></i>
                </button>
              `;
          }

          rowHtml += `
            <td style="white-space: nowrap;">
              <div class="d-flex align-items-center gap-1" style="flex-wrap: nowrap !important;">
                  ${btnDetail} ${btnEdit} ${btnHapus}
              </div>
            </td>
          `;

          rowHtml += '</tr>';
          tbody.innerHTML += rowHtml;
        });
      }

      // 3. Mode Edit Transaksi (FUNGSI BARU & KOMPLEKS)
      function modeEditTransaksi(tipe, encodedData) {
        // 1. Decode Data JSON
        const data = JSON.parse(decodeURIComponent(encodedData));
        
        // 2. Mapping ID Form Header & Button berdasarkan Tipe
        let formId, tableId, btnSimpanId, btnBatalId;
        
        if (tipe === 'toko') {
          formId = 'formBelanjaToko';
          tableId = 'tabelItemToko';
          btnSimpanId = 'btnSimpanTokoTrans';
          btnBatalId = 'btnBatalTokoTrans';
          
          // Isi Header Toko
          document.getElementById('trTokoId').value = data.id;
          document.getElementById('trTokoTanggal').value = data.tanggal;
          setSelectValue('trTokoUraian', data.uraian);
          setSelectValue('trTokoNama', data.pihakKetiga);
          setSelectValue('trTokoPemesan', data.pemesan);
          
        } else if (tipe === 'tukang') {
          formId = 'formBelanjaTukang';
          tableId = 'tabelItemTukang';
          btnSimpanId = 'btnSimpanTukangTrans';
          btnBatalId = 'btnBatalTukangTrans';
          
          // Isi Header Tukang
          document.getElementById('trTukangId').value = data.id;
          document.getElementById('trTukangTanggal').value = data.tanggal;
          setSelectValue('trTukangUraian', data.uraian);
          setSelectValue('trTukangNama', data.pihakKetiga);
          setSelectValue('trTukangPemesan', data.pemesan);
                
        } else if (tipe === 'guru') {
          formId = 'formBelanjaGuru';
          tableId = 'tabelItemGuru';
          btnSimpanId = 'btnSimpanGuruTrans';
          btnBatalId = 'btnBatalGuruTrans';
          
          // Isi Header Guru
          document.getElementById('trGuruId').value = data.id;
          document.getElementById('trGuruTanggal').value = data.tanggal;
          setSelectValue('trGuruUraian', data.uraian);
          
          if(data.pihakKetiga === '-' || data.pihakKetiga === 'Honorarium Guru') {
              document.getElementById('trGuruKeterangan').value = '';
          } else {
              document.getElementById('trGuruKeterangan').value = data.pihakKetiga;
          }
        }

        // 3. Reset & Gambar Ulang Tabel Rincian (PENTING: Logika Render)
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = ''; // Kosongkan tabel dulu

        if (data.items && data.items.length > 0) {
          // GANTI BAGIAN LOOPING ITEMS (data.items.forEach) DENGAN INI:
          data.items.forEach(item => {
            const rowId = new Date().getTime() + Math.random();
            let colNamaInput = '';

            // --- LOGIKA KOLOM NAMA (Dropdown Guru & Tukang) ---
            if (tipe === 'guru' || tipe === 'tukang') {
              let isManual = true;
              let dataList = (tipe === 'guru') ? (DATA_CACHE.guru || []) : (DATA_CACHE.tukang || []);
              let placeholder = (tipe === 'guru') ? "Pilih Guru" : "Pilih Tukang";

              // Cek apakah nama item ada di database master?
              if (dataList.some(d => d.nama.trim() === item.nama.trim())) {
                isManual = false;
              }

              if (isManual) {
                // Jika tidak ada di master, tampilkan mode Input Manual
                const val = String(item.nama).replace(/"/g, '&quot;');
                colNamaInput = `
                  <div class="input-group">
                    <input type="text" class="form-control item-nama" value="${val}" placeholder="Nama ${tipe === 'guru' ? 'Guru' : 'Tukang'} (Manual)">
                    <button class="btn btn-outline-secondary" type="button" onclick="resetKeDropdown(this)" title="Kembali ke Pilihan">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                `;
              } else {
                // Jika ada di master, tampilkan Dropdown
                let opts = `<option value="">-- ${placeholder} --</option>`;
                opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
                
                dataList.forEach(d => {
                  const isSelected = (d.nama.trim() === item.nama.trim()) ? 'selected' : '';
                  const val = String(d.nama).replace(/"/g, '&quot;');
                  opts += `<option value="${val}" ${isSelected}>${d.nama}</option>`;
                });
                
                colNamaInput = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
              }
            } else {
              // Input Biasa (Untuk Toko)
              const val = String(item.nama).replace(/"/g, '&quot;');
              colNamaInput = `<input type="text" class="form-control item-nama" value="${val}" placeholder="Nama Barang">`;
            }

            // --- LOGIKA FORMAT HARGA ---
            const hargaTampil = formatRibuanInput(item.harga);

            // --- TEMPLATE BARIS TABEL ---
            const row = `
              <tr id="row-${rowId}">
                <td>${colNamaInput}</td>
                <td>
                  <input type="number" class="form-control item-vol" value="${item.vol}" min="1" oninput="hitungBaris(this, '${tipe}')">
                </td>
                <td style="position: relative;">
                  <div class="autocomplete-wrapper">
                    <input type="text" class="form-control item-sat" value="${item.sat || ''}" placeholder="Satuan" oninput="handleInputSatuan(this)" onfocus="handleInputSatuan(this)" autocomplete="off">
                    <div class="suggestion-list" style="display:none; min-width: 150px;"></div>
                  </div>
                </td>
                <td>
                  <input type="text" class="form-control item-harga" value="${hargaTampil}" oninput="hitungBaris(this, '${tipe}')">
                </td>
                <td>
                  <input type="text" class="form-control item-jumlah-display" readonly value="${formatRupiahJS(item.jumlah)}">
                  <input type="hidden" class="item-jumlah-value" value="${item.jumlah}">
                </td>
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="hapusBaris(this, '${tipe}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
          });
        } else {
          // Jika data item kosong (error case), buat 1 baris baru
          tambahBaris(tipe);
        }

        // 4. Hitung Ulang & Update UI Tombol
        hitungTotalSemua(tipe);

        const btnSimpan = document.getElementById(btnSimpanId);
        const btnBatal = document.getElementById(btnBatalId);
        
        // Ubah tombol jadi warna kuning (Mode Edit)
        btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Perubahan';
        btnSimpan.classList.remove('btn-success');
        btnSimpan.classList.add('btn-warning');
        
        btnBatal.classList.remove('hidden');

        // --- 5. PERBAIKAN SCROLL UNTUK MOBILE ---
        // Gunakan setTimeout agar rendering tabel selesai dulu sebelum scroll
        // Gunakan 'block: start' agar form mulai dari bagian atas layar
        setTimeout(() => {
          document.getElementById(formId).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 400); 
      }

      // Helper untuk set value select yang mungkin mengandung karakter spesial
      function setSelectValue(id, value) {
          const select = document.getElementById(id);
          // Cari option yang text/valuenya cocok
          for (let i = 0; i < select.options.length; i++) {
              // Decode HTML entities jika perlu, atau bandingkan langsung
              if (select.options[i].value === value || select.options[i].text === value) {
                  select.selectedIndex = i;
                  break;
              }
          }
      }

      // --- UPDATE: FUNGSI BATAL EDIT TRANSAKSI (UNIFIED) ---
      function batalEditTransaksi(tipe) {
        // Helper Capitalize (Huruf pertama besar)
        const capTipe = tipe.charAt(0).toUpperCase() + tipe.slice(1);
        
        // 1. Reset Form & ID Hidden
        document.getElementById('formBelanja' + capTipe).reset();
        document.getElementById('tr' + capTipe + 'Id').value = '';
        
        // 2. Reset Tabel Item (Kosongkan lalu tambah 1 baris baru)
        const tbody = document.querySelector('#tabelItem' + capTipe + ' tbody');
        if (tbody) {
            tbody.innerHTML = '';
            tambahBaris(tipe); 
        }
        
        // 3. Reset Tampilan Total
        const dispTotal = document.getElementById('tr' + capTipe + 'TotalDisplay');
        const valTotal = document.getElementById('tr' + capTipe + 'TotalValue');
        if (dispTotal) dispTotal.innerText = 'Rp 0';
        if (valTotal) valTotal.value = '0';
        
        // 4. Reset Tombol Simpan & Sembunyikan Tombol Batal
        const btnSimpan = document.getElementById('btnSimpan' + capTipe + 'Trans');
        const btnBatal = document.getElementById('btnBatal' + capTipe + 'Trans');
        
        // Sembunyikan tombol batal
        if (btnBatal) btnBatal.classList.add('hidden');
        
        // Kembalikan warna & Teks tombol Simpan
        if (btnSimpan) {
            btnSimpan.classList.remove('btn-warning');
            btnSimpan.classList.add('btn-success');
            // UPDATE: Semua tab menggunakan teks yang sama
            btnSimpan.innerHTML = '<i class="fas fa-save me-1"></i> Simpan Transaksi';
        }
      }

      // 5. Hapus Transaksi
      // --- HAPUS TRANSAKSI (INVALIDATE CACHE) ---
      function hapusTransaksi(id, tipe) {
        Swal.fire({
          title: 'Hapus Transaksi?',
          text: "Data tidak bisa dikembalikan.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            
            // --- PERBAIKAN: TAMPILKAN LOADING POP-UP ---
            Swal.fire({
              title: 'Menghapus...',
              text: 'Sedang memproses penghapusan data.',
              allowOutsideClick: false, // Mencegah user menutup paksa
              didOpen: () => {
                Swal.showLoading(); // Menampilkan animasi loading
              }
            });
            // -------------------------------------------

            const token = localStorage.getItem('userToken');
            google.script.run
              .withFailureHandler(function(error) {
                  // Jika gagal, loading akan tertimpa oleh alert error ini
                  handleServerError(error); 
              })
              .withSuccessHandler(function(res) {
                if(res.status === 'success') {
                  // Jika sukses, loading akan tertimpa oleh alert sukses ini
                  Swal.fire('Terhapus!', 'Transaksi dihapus.', 'success');
                  
                  // --- UPDATE PENTING: INVALIDATE CACHE ---
                  DATA_CACHE['transaksi_' + tipe] = null;
                  DATA_CACHE.dashboard = null;
                  // ---------------------------------------
                  loadTransaksiData(tipe.toUpperCase());
                } else {
                  Swal.fire({ icon: 'error', title: 'Gagal Menghapus', html: res.message });
                }
              }).hapusTransaksiItem(token, id);
          }
        });
      }

      // --- LOGIC SIMPAN YANG DIPERBARUI (HANDLE EDIT & BARU) ---
      // --- SIMPAN TRANSAKSI (INVALIDATE CACHE) ---
      function simpanTransaksi(tipe) {
        // 1. Tentukan ID Elemen
        let tableId, idHidden, btnId;
        if (tipe === 'toko') { tableId='tabelItemToko'; idHidden='trTokoId'; btnId='btnSimpanTokoTrans'; }
        else if (tipe === 'tukang') { tableId='tabelItemTukang'; idHidden='trTukangId'; btnId='btnSimpanTukangTrans'; }
        else { tableId='tabelItemGuru'; idHidden='trGuruId'; btnId='btnSimpanGuruTrans'; }

        // 2. Validasi & Ambil Data Header
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const idEdit = document.getElementById(idHidden).value;

        if (rows.length === 0) {
          Swal.fire('Eror', 'Belum ada rincian yang dimasukkan!', 'error'); return;
        }

        let tgl, uraian, pihak, pemesan, total;
        if (tipe === 'guru') {
          tgl = document.getElementById('trGuruTanggal').value;
          uraian = document.getElementById('trGuruUraian').value;
          const ketVal = document.getElementById('trGuruKeterangan').value;
          pihak = ketVal ? ketVal : "-"; 
          pemesan = "-";
          total = document.getElementById('trGuruTotalValue').value;
        } else {
          const prefix = (tipe === 'toko') ? 'trToko' : 'trTukang';
          tgl = document.getElementById(prefix + 'Tanggal').value;
          uraian = document.getElementById(prefix + 'Uraian').value;
          pihak = document.getElementById(prefix + 'Nama').value;
          pemesan = document.getElementById(prefix + 'Pemesan').value;
          total = document.getElementById(prefix + 'TotalValue').value;
        }

        if (!tgl || !uraian) { Swal.fire('Data Belum Lengkap', 'Harap lengkapi Tanggal dan Uraian!', 'warning'); return; }
        if (tipe !== 'guru' && (!pihak || !pemesan)) { Swal.fire('Data Belum Lengkap', 'Pihak Ketiga dan Pemesan wajib diisi!', 'warning'); return; }

        // 3. Ambil Rincian Item
        let items = [];
        rows.forEach(row => {
          items.push({
            nama: row.querySelector('.item-nama').value, 
            vol: row.querySelector('.item-vol').value,
            sat: row.querySelector('.item-sat').value,
            harga: cleanRibuan(row.querySelector('.item-harga').value),
            jumlah: row.querySelector('.item-jumlah-value').value
          });
        });

        const payload = {
          id: idEdit, tipe: tipe.toUpperCase(), tanggal: tgl,
          uraian: uraian, pihakKetiga: pihak, pemesan: pemesan,
          items: items, total: total
        };

        const token = localStorage.getItem('userToken');
        const btnSimpan = document.getElementById(btnId);
        const txtAsli = btnSimpan.innerHTML;
        
        btnSimpan.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...';
        btnSimpan.disabled = true;

        const handleResult = function(res) {
          btnSimpan.innerHTML = txtAsli;
          btnSimpan.disabled = false;
          
          if (res.status === 'success') {
            Swal.fire({
              icon: 'success', title: 'Berhasil!', text: res.message,
              showConfirmButton: false, timer: 1500
            });
            
            // --- UPDATE PENTING: INVALIDATE CACHE TRANSAKSI ---
            DATA_CACHE['transaksi_' + tipe] = null; 
            DATA_CACHE.dashboard = null;
            // -------------------------------------------------

            batalEditTransaksi(tipe); 
            loadTransaksiData(tipe.toUpperCase()); // Ini akan otomatis fetch baru karena cache null
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Transaksi', html: res.message });
          }
        };

        if (idEdit) {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handleResult).editTransaksiItem(token, payload);
        } else {
          google.script.run.withFailureHandler(handleServerError).withSuccessHandler(handleResult).simpanTransaksiBaru(token, payload);
        }
      }

      // 2. Load Dropdown Options
      // --- LOAD OPSI TRANSAKSI (MULTI CACHE) ---
      function loadTransaksiOptions() {
        const token = localStorage.getItem('userToken');

        // CEK APAKAH SEMUA CACHE SUDAH TERISI?
        // Jika Toko, Guru, Tukang, Uraian, Satuan sudah ada di memori, TIDAK PERLU Fetch ulang.
        if (DATA_CACHE.toko && DATA_CACHE.guru && DATA_CACHE.tukang && DATA_CACHE.uraian && DATA_CACHE.satuan) {
          console.log("Semua opsi transaksi loaded from Cache.");
          isiDropdownTransaksi(); // Render UI dari Cache
          return;
        }

        // Jika ada yang kosong, baru panggil server
        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              const d = res.data;
              
              // ISI SEMUA CACHE SEKALIGUS
              DATA_CACHE.guru = d.guru;
              DATA_CACHE.toko = d.toko;
              DATA_CACHE.tukang = d.tukang;
              DATA_CACHE.uraian = d.uraian;
              DATA_CACHE.satuan = d.satuan;
              
              // Kompatibilitas Variabel Lama
              cacheDataGuru = d.guru; 
              cacheSatuan = d.satuan;
              cacheMasterUraian = d.uraian.map(u => u.uraian); // Extract uraian string array

              isiDropdownTransaksi();
            }
          }).getAllOptions(token);
      }

      // --- HELPER: ISI DROPDOWN TRANSAKSI ---
      function isiDropdownTransaksi() {
        const d = DATA_CACHE; 
        
        // Helper isi select (Kode lama Anda)
        const isiSelect = (id, dataList, valueKey='nama') => {
          const el = document.getElementById(id);
          if(!el) return;
          const currentVal = el.value;
          el.innerHTML = '<option value="">-- Pilih --</option>';
          if(dataList && dataList.length > 0) {
            dataList.forEach(item => {
              const text = item[valueKey] || item.uraian || item.nama;
              const val = String(text).replace(/"/g, '&quot;');
              el.innerHTML += `<option value="${val}">${text}</option>`;
            });
          }
          if(currentVal) el.value = currentVal;
        };

        // Isi Dropdown Header
        isiSelect('trTokoUraian', d.uraian, 'uraian');
        isiSelect('trTokoNama', d.toko);
        isiSelect('trTokoPemesan', d.guru);
        
        isiSelect('trTukangUraian', d.uraian, 'uraian');
        isiSelect('trTukangNama', d.tukang);
        isiSelect('trTukangPemesan', d.guru);
        
        isiSelect('trGuruUraian', d.uraian, 'uraian');

        // Update Dropdown di Tabel Rincian
        updateDropdownTabelGuru();
        updateDropdownTabelTukang(); // <--- TAMBAHKAN BARIS INI
      }

      // --- HELPER: UPDATE DROPDOWN DI TABEL GURU ---
      function updateDropdownTabelGuru() {
          const dropdownsDiTabel = document.querySelectorAll('#tabelItemGuru .item-nama');
          
          dropdownsDiTabel.forEach(select => {
            // Pastikan elemennya SELECT (bukan input manual)
            if (select.tagName === 'SELECT') {
                const valSebelumnya = select.value;
                
                let opts = '<option value="">-- Pilih Guru --</option>';
                opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
                
                if (DATA_CACHE.guru) {
                  DATA_CACHE.guru.forEach(g => {
                    const val = String(g.nama).replace(/"/g, '&quot;');
                    opts += `<option value="${val}">${g.nama}</option>`;
                  });
                }
                
                select.innerHTML = opts;
                if(valSebelumnya) select.value = valSebelumnya;
            }
          });
      }

      // --- HELPER: UPDATE DROPDOWN DI TABEL TUKANG ---
      function updateDropdownTabelTukang() {
        const dropdownsDiTabel = document.querySelectorAll('#tabelItemTukang .item-nama');
        dropdownsDiTabel.forEach(select => {
          // Pastikan elemennya SELECT (bukan input manual)
          if (select.tagName === 'SELECT') {
            const valSebelumnya = select.value;
            let opts = '<option value="">-- Pilih Tukang --</option>';
            opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';
            
            if (DATA_CACHE.tukang) {
              DATA_CACHE.tukang.forEach(t => {
                const val = String(t.nama).replace(/"/g, '&quot;');
                opts += `<option value="${val}">${t.nama}</option>`;
              });
            }
            select.innerHTML = opts;
            // Kembalikan nilai yang terpilih sebelumnya (jika masih valid)
            if(valSebelumnya) select.value = valSebelumnya;
          }
        });
      }

      // --- FUNGSI GANTI DROPDOWN JADI INPUT TEXT (DENGAN TOMBOL X) ---
      function cekInputManual(selectElement) {
        if (selectElement.value === 'MANUAL_INPUT') {
          const parentTd = selectElement.parentElement;
          
          // Kita gunakan fitur Input Group Bootstrap
          // Class 'item-nama' tetap wajib ada di input agar terbaca saat simpan
          const htmlInputGroup = `
            <div class="input-group">
              <input type="text" class="form-control item-nama" placeholder="Ketik Nama Guru..." autofocus>
              <button class="btn btn-outline-secondary" type="button" onclick="resetKeDropdown(this)" title="Kembali ke Pilihan">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          
          parentTd.innerHTML = htmlInputGroup;
          
          // Otomatis fokus ke input
          parentTd.querySelector('input').focus();
        }
      }

      // --- FUNGSI KEMBALIKAN KE DROPDOWN (UPDATED) ---
      function resetKeDropdown(btnElement) {
        // Cari elemen TD pembungkusnya
        const parentTd = btnElement.closest('td');
        // Cari tabel pembungkus untuk tahu ini Guru atau Tukang
        const tableId = btnElement.closest('table').id;
        
        let dataList = [];
        let placeholder = "Pilih";

        if (tableId === 'tabelItemGuru') {
          dataList = DATA_CACHE.guru || [];
          placeholder = "Pilih Guru";
        } else if (tableId === 'tabelItemTukang') {
          dataList = DATA_CACHE.tukang || [];
          placeholder = "Pilih Tukang";
        }

        let opts = `<option value="">-- ${placeholder} --</option>`;
        opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';

        if (dataList.length > 0) {
          dataList.forEach(item => {
            const val = String(item.nama).replace(/"/g, '&quot;');
            opts += `<option value="${val}">${item.nama}</option>`;
          });
        }

        // Kembalikan ke bentuk Select
        const selectHtml = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
        parentTd.innerHTML = selectHtml;
      }

      // 3. Tambah Baris Dinamis (UPDATED untuk Tukang Dropdown)
      function tambahBaris(tipe) {
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : (tipe === 'tukang') ? 'tabelItemTukang' : 'tabelItemGuru';
        const tbody = document.getElementById(tableId).querySelector('tbody');
        const rowId = new Date().getTime() + Math.random();
        
        let colPertamaHtml = '';

        // LOGIKA BARU: Terapkan Dropdown untuk GURU dan TUKANG
        if (tipe === 'guru' || tipe === 'tukang') {
          let placeholder = (tipe === 'guru') ? "Pilih Guru" : "Pilih Tukang";
          // Ambil data dari Cache
          let dataList = (tipe === 'guru') ? (DATA_CACHE.guru || []) : (DATA_CACHE.tukang || []);

          let opts = `<option value="">-- ${placeholder} --</option>`;
          opts += '<option value="MANUAL_INPUT" class="fw-bold text-primary">-- Lainnya (Input Manual) --</option>';

          if (dataList.length > 0) {
            dataList.forEach(item => {
              const val = String(item.nama).replace(/"/g, '&quot;');
              opts += `<option value="${val}">${item.nama}</option>`;
            });
          }
          
          // Select dengan event onchange untuk deteksi input manual
          colPertamaHtml = `<select class="form-select item-nama" onchange="cekInputManual(this)">${opts}</select>`;
        } else {
          // Untuk Toko, tetap Input Text biasa
          colPertamaHtml = `<input type="text" class="form-control item-nama" placeholder="Nama Barang/Jasa">`;
        }

        const row = `
          <tr id="row-${rowId}">
            <td>${colPertamaHtml}</td>
            <td><input type="number" class="form-control item-vol" value="1" min="1" oninput="hitungBaris(this, '${tipe}')"></td>
            <td>
              <div class="autocomplete-wrapper">
                <input type="text" class="form-control item-sat" placeholder="Satuan" oninput="handleInputSatuan(this)" onfocus="handleInputSatuan(this)" autocomplete="off">
              </div>
            </td>
            <td><input type="text" class="form-control item-harga" placeholder="0" oninput="hitungBaris(this, '${tipe}')"></td>
            <td>
              <input type="text" class="form-control item-jumlah-display" readonly value="0">
              <input type="hidden" class="item-jumlah-value" value="0">
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="hapusBaris(this, '${tipe}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      }

      // 4. Hapus Baris
      function hapusBaris(btn, tipe) {
        const row = btn.closest('tr');
        row.remove();
        hitungTotalSemua(tipe); // Recalculate total
      }

      // 5. Kalkulasi Per Baris (Vol * Harga) - DENGAN FORMAT RIBUAN
      function hitungBaris(input, tipe) {
        const row = input.closest('tr');
        
        // A. Jika yang diketik adalah kolom Harga, format tampilannya
        if (input.classList.contains('item-harga')) {
          // Simpan posisi kursor (opsional, agar nyaman saat edit di tengah)
          // Untuk simpelnya, kita langsung format value-nya
          input.value = formatRibuanInput(input.value);
        }

        // B. Ambil Nilai untuk Kalkulasi (Gunakan cleanRibuan)
        const vol = parseFloat(row.querySelector('.item-vol').value) || 0;
        
        // Ambil teks harga (misal: "15.000"), bersihkan jadi 15000
        const hargaStr = row.querySelector('.item-harga').value;
        const harga = cleanRibuan(hargaStr); 
        
        const total = vol * harga;
        
        // Tampilkan format Rupiah di input readonly (Total Jumlah)
        row.querySelector('.item-jumlah-display').value = formatRupiahJS(total);
        // Simpan nilai asli di hidden input
        row.querySelector('.item-jumlah-value').value = total;
        
        hitungTotalSemua(tipe);
      }

      // 6. Hitung Grand Total
      function hitungTotalSemua(tipe) {
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 
                        (tipe === 'tukang') ? 'tabelItemTukang' : 'tabelItemGuru';
                        
        const inputs = document.querySelectorAll(`#${tableId} .item-jumlah-value`);
        
        let grandTotal = 0;
        inputs.forEach(el => { grandTotal += parseFloat(el.value) || 0; });

        // Update Tampilan Total Bawah
        let elDisplay, elValue;
        if(tipe === 'toko') {
          elDisplay = 'trTokoTotalDisplay'; elValue = 'trTokoTotalValue';
        } else if (tipe === 'tukang') {
          elDisplay = 'trTukangTotalDisplay'; elValue = 'trTukangTotalValue';
        } else {
          elDisplay = 'trGuruTotalDisplay'; elValue = 'trGuruTotalValue';
        }
        
        document.getElementById(elDisplay).innerText = formatRupiahJS(grandTotal);
        document.getElementById(elValue).value = grandTotal;
      }

      // Helper Format Rupiah JS
      function formatRupiahJS(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }

      // Helper: Reset Form
      function resetFormTransaksi(tipe) {
        let formId, tableId, dispId, valId;

        // Mapping ID Form & Total
        if (tipe === 'toko') {
          formId='formBelanjaToko'; tableId='tabelItemToko'; dispId='trTokoTotalDisplay'; valId='trTokoTotalValue';
        } else if (tipe === 'tukang') {
          formId='formBelanjaTukang'; tableId='tabelItemTukang'; dispId='trTukangTotalDisplay'; valId='trTukangTotalValue';
        } else { // GURU
          formId='formBelanjaGuru'; tableId='tabelItemGuru'; dispId='trGuruTotalDisplay'; valId='trGuruTotalValue';
        }
        
        // 1. Reset Form Header
        document.getElementById(formId).reset();

        // TAMBAHAN KHUSUS: Pastikan Textarea Keterangan Guru bersih
        if(tipe === 'guru') {
          document.getElementById('trGuruKeterangan').value = '';
        }
        
        // 2. Kosongkan Tabel Rincian
        document.querySelector(`#${tableId} tbody`).innerHTML = '';
        
        // 3. Reset Angka Total
        document.getElementById(dispId).innerText = 'Rp 0';
        document.getElementById(valId).value = 0;
        
        // 4. Tambahkan 1 Baris Kosong Default
        // Ini penting agar dropdown guru / input manual ter-render ulang dengan benar
        tambahBaris(tipe);
      }

      // --- FUNGSI POPUP DETAIL TRANSAKSI (PERBAIKAN TAMPILAN) ---
      function lihatDetailTransaksi(encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const tipe = (data.tipe || '').toUpperCase();

        // --- LOGIKA TAMPILAN KHUSUS ---
        let labelPihak = "Pihak Ketiga";
        let valPihak = escapeHtml(data.pihakKetiga || '-');
        
        let labelBawah = "Pemesan";
        let valBawah = escapeHtml(data.pemesan || '-');

        // 1. KONDISI KHUSUS GURU
        if (tipe === 'GURU') {
          if (data.items && data.items.length > 0) {
            valPihak = escapeHtml(data.items[0].nama);
          }
          labelPihak = "Penerima / Guru";
          labelBawah = "Keterangan";
          valBawah = escapeHtml(data.pihakKetiga);
        } 
        // 2. KONDISI KHUSUS TOKO
        else if (tipe === 'TOKO') {
          labelPihak = "Toko / Rekanan";
          if (typeof DATA_CACHE !== 'undefined' && DATA_CACHE.toko) {
            const tokoInfo = DATA_CACHE.toko.find(t => t.nama === data.pihakKetiga);
            if (tokoInfo && tokoInfo.pemilik) {
              valPihak = `
                <div class="fw-bold">${escapeHtml(data.pihakKetiga)}</div>
                <div class="text-muted small fst-italic mt-1">
                  <i class="fas fa-user-tie me-1"></i>${escapeHtml(tokoInfo.pemilik)}
                </div>
              `;
            }
          }
        }

        // --- RENDER HTML POPUP ---
        let htmlContent = `
          <div class="mb-3 text-start">
            <div class="table-responsive border rounded">
              <table class="table table-bordered table-sm mb-0 align-middle text-nowrap" style="font-size: 0.9rem;">
                <tbody>
                  <tr>
                    <td class="bg-light fw-bold text-secondary" style="width: 30%;">
                      <i class="fas fa-calendar-alt text-primary me-2"></i>Tanggal
                    </td>
                    <td class="fw-bold text-dark">
                      ${data.tanggalDisplay || data.tanggal}
                    </td>
                  </tr>
                  <tr>
                    <td class="bg-light fw-bold text-secondary">
                      <i class="fas fa-clipboard-list text-primary me-2"></i>Uraian
                    </td>
                    <td class="fw-bold text-dark">
                      ${escapeHtml(data.uraian)}
                    </td>
                  </tr>
                  <tr>
                    <td class="bg-light fw-bold text-secondary">
                      <i class="fas fa-store text-primary me-2"></i>${labelPihak}
                    </td>
                    <td class="text-dark align-middle">
                      ${valPihak}
                    </td>
                  </tr>
                  <tr>
                    <td class="bg-light fw-bold text-secondary">
                      <i class="fas fa-user-check text-primary me-2"></i>${labelBawah}
                    </td>
                    <td class="text-dark">
                      ${valBawah}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="table-responsive border rounded" style="max-height: 300px; overflow-y: auto;">
            
            <table class="table table-sm table-striped table-bordered text-nowrap mb-0" style="font-size: 0.85rem;">
              
              <thead class="sticky-top text-white" style="background-color: #0dcaf0;"> 
                <tr>
                  <th class="text-center p-2">Item / Uraian</th>
                  <th class="text-center p-2">Vol</th>
                  <th class="text-center p-2">Sat</th>
                  <th class="text-end p-2">Harga</th>
                  <th class="text-end p-2">Jumlah</th>
                </tr>
              </thead>
              <tbody>
        `;

        // Render Baris Item
        if (data.items && data.items.length > 0) {
          data.items.forEach(item => {
            const vol = parseFloat(item.vol) || 0;
            const harga = parseFloat(item.harga) || 0;
            const jumlah = parseFloat(item.jumlah) || 0;

            htmlContent += `
              <tr>
                <td class="text-start px-2">${escapeHtml(item.nama)}</td>
                <td class="text-center px-2">${vol}</td>
                <td class="text-center px-2">${escapeHtml(item.sat)}</td>
                <td class="text-end text-muted px-2">${formatRupiahJS(harga)}</td>
                <td class="text-end fw-bold px-2">${formatRupiahJS(jumlah)}</td>
              </tr>
            `;
          });
        } else {
          htmlContent += `<tr><td colspan="5" class="text-center text-muted fst-italic p-3">Tidak ada rincian item.</td></tr>`;
        }

        htmlContent += `
              </tbody>
              <tfoot class="table-light sticky-bottom">
                <tr>
                  <td colspan="4" class="text-end fw-bold p-2">TOTAL TRANSAKSI:</td>
                  <td class="text-end fw-bold fs-6 text-success p-2">${formatRupiahJS(data.total)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;

        // Tampilkan Popup (SweetAlert)
        Swal.fire({
          title: 'Rincian Transaksi',
          html: htmlContent,
          width: '650px',
          showCloseButton: true,
          showConfirmButton: false,
          focusConfirm: false,
          customClass: {
            popup: 'rounded-4 shadow-lg'
          }
        });
      }

      /* --- LOGIKA MANAJEMEN NOMOR SURAT --- */

      let globalAutoSettings = { toko: {active: false}, tukang: {active: false} };

      function bukaTabSurat(tipe) {
        // 1. Reset Class Active pada tombol Tab
        document.getElementById('tab-surat-toko').classList.remove('active');
        document.getElementById('tab-surat-tukang').classList.remove('active');
        document.getElementById('tab-surat-setting').classList.remove('active');
        
        // 2. Ambil Elemen View (List vs Setting)
        const viewList = document.getElementById('view-surat-list');
        const viewSetting = document.getElementById('view-surat-setting');
        
        if (tipe === 'setting') {
          // --- MODE SETTING ---
          document.getElementById('tab-surat-setting').classList.add('active');
          
          // Sembunyikan List, Tampilkan Setting
          viewList.classList.add('hidden');
          viewSetting.classList.remove('hidden');
          
          // Load data setting dari server
          loadSettingNomor();

        } else {
          // --- MODE LIST (Toko / Tukang) ---
          if (tipe === 'toko') {
              document.getElementById('tab-surat-toko').classList.add('active');
          } else {
              document.getElementById('tab-surat-tukang').classList.add('active');
          }
          
          // Tampilkan List, Sembunyikan Setting
          viewList.classList.remove('hidden');
          viewSetting.classList.add('hidden');

          // Load Data Tabel
          loadDataSurat(tipe);
          
          // Refresh cache setting diam-diam agar saat popup dibuka datanya sudah siap
          refreshAutoSettingsCache(); 
        }
      }

      // 2. Load Data List
      // --- LOAD DATA SURAT (WITH CACHE) ---
      function loadDataSurat(tipe, forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelSuratBody');
        const cacheKey = 'transaksi_' + tipe; // misal: transaksi_toko

        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE[cacheKey]) {
          renderTabelSurat(DATA_CACHE[cacheKey], tipe);
          return;
        }

        // 2. FETCH SERVER
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data transaksi...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // SIMPAN KE CACHE
            DATA_CACHE[cacheKey] = res.data;
            renderTabelSurat(res.data, tipe);
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe.toUpperCase());
      }

      // --- RENDER TABEL SURAT ---
      function renderTabelSurat(data, tipe) {
        const tbody = document.getElementById('tabelSuratBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Belum ada data transaksi ' + tipe + '.</td></tr>';
          return;
        }

        data.forEach(item => {
          const s = item.dataSurat;
          let statusBadge = '<span class="badge bg-secondary">Belum Diatur</span>';

          if (s) {
            if (s.permintaan && s.baPembayaran) {
              statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
            } else {
              statusBadge = '<span class="badge bg-warning text-dark">Sebagian</span>';
            }
          }

          // Encode data agar aman masuk ke fungsi onclick
          const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");

          const btnLihat = `
            <button class="btn btn-sm btn-info text-white me-1" 
              onclick="lihatNomorSurat('${tipe}', '${dataJson}')" title="Lihat Daftar Nomor">
              <i class="fas fa-eye"></i>
            </button>
          `;

          const btnKelola = `
            <button class="btn btn-sm btn-outline-primary" 
              onclick="bukaModalSurat('${tipe}', '${dataJson}')">
              <i class="fas fa-edit me-1"></i> Kelola
            </button>
          `;

          const row = `
            <tr>
              <td>${item.tanggalDisplay}</td> 
              <td><div class="text-truncate" style="max-width:250px;">${item.uraian}</div></td>
              <td>${item.pihakKetiga}</td>
              <td>${statusBadge}</td>
              <td style="white-space:nowrap;">${btnLihat} ${btnKelola}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // TAMBAHKAN FUNGSI INI (Fungsi Baru untuk Popup Lihat Nomor)
      // GANTI FUNGSI INI DI Index.html
      function lihatNomorSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const s = data.dataSurat || {}; // Data Surat tersimpan

        let htmlContent = '<div class="text-start px-2">';
        
        // Helper styling baris info (Konsisten dengan lihatTanggalSurat)
        const rowInfo = (label, valHtml) => {
            return `
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-caret-right text-primary me-2"></i>
                        <div class="text-secondary small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">${label}</div>
                    </div>
                    <div class="ps-3 border-start border-3 border-light ms-1" style="font-size: 0.95rem;">${valHtml}</div>
                </div>
            `;
        };

        // Helper khusus format text nomor (Monospace font agar rapi seperti kode)
        const fmtNomor = (val) => {
            return val ? `<span class="fw-bold text-dark font-monospace">${val}</span>` : '<span class="text-muted fst-italic small bg-light px-2 rounded">- Belum diatur -</span>';
        };

        // [BAGIAN BARU] Detail Utama (Uraian & Pihak Ketiga)
        htmlContent += rowInfo('Uraian Pekerjaan', `<span class="fw-bold text-dark">${data.uraian}</span>`);
        
        let labelPihak = 'Pihak Ketiga';
        if(tipe === 'guru') labelPihak = 'Keterangan / Honorarium';
        
        htmlContent += rowInfo(labelPihak, `<span class="fw-bold text-dark">${data.pihakKetiga}</span>`);

        // Garis Pembatas
        htmlContent += '<hr class="border-secondary opacity-25 my-3" style="border-style: dashed;">';

        // [BAGIAN NOMOR SURAT]
        htmlContent += rowInfo('Surat Permintaan', fmtNomor(s.permintaan));
        
        // Penawaran hanya untuk Toko
        if (tipe === 'toko') {
            htmlContent += rowInfo('Surat Penawaran', fmtNomor(s.penawaran));
        }
        
        htmlContent += rowInfo('Berita Acara Pemeriksaan', fmtNomor(s.baPemeriksaan));
        htmlContent += rowInfo('Berita Acara Serah Terima', fmtNomor(s.baSerahTerima));
        htmlContent += rowInfo('Berita Acara Pembayaran', fmtNomor(s.baPembayaran));
        
        htmlContent += '</div>';

        // Tampilkan SweetAlert
        Swal.fire({
            title: `<span class="fs-5"><i class="fas fa-list-ol text-primary me-2"></i> Daftar Nomor Surat</span>`,
            html: htmlContent,
            showCloseButton: true,
            showConfirmButton: false,
            width: '500px',
            background: '#fff',
            customClass: {
              popup: 'rounded-4 shadow-lg'
            }
        });
      }

      // 3. Buka Modal & Isi Form
      let modalSuratBS = null; // Instance Bootstrap Modal

      // GANTI FUNGSI INI
      function bukaModalSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const s = data.dataSurat || {}; 
        const rawData = s.raw || {}; 
        
        // [PERBAIKAN 1] Ambil Data Tanggal Spesifik Dokumen
        const tDocs = data.dataTanggal || {};
        
        // Mapping Tanggal Spesifik (Fallback ke Tanggal Transaksi jika kosong)
        const dateMap = {
          permintaan: tDocs.permintaan || data.tanggal,
          penawaran: tDocs.penawaran || data.tanggal,
          baPemeriksaan: tDocs.baPemeriksaan || data.tanggal,
          baSerahTerima: tDocs.baSerahTerima || data.tanggal,
          baPembayaran: tDocs.baPembayaran || data.tanggal
        };

        // Simpan Mapping Tanggal ke Dataset Form agar bisa dibaca oleh simpanSurat()
        const formEl = document.getElementById('formInputSurat');
        formEl.dataset.dateMap = JSON.stringify(dateMap);

        document.getElementById('suratTransId').value = data.id;
        document.getElementById('suratTransTipe').value = tipe;
        document.getElementById('suratTransTanggal').value = data.tanggal; 

        const config = (tipe === 'toko') ? globalAutoSettings.toko : globalAutoSettings.tukang;
        const isAuto = config && config.active;

        const container = document.getElementById('containerInputSurat');
        container.innerHTML = ''; 

        // Toggle Alert
        if(isAuto) {
          document.getElementById('alertManualMode').classList.add('hidden');
          document.getElementById('alertAutoMode').classList.remove('hidden');
        } else {
          document.getElementById('alertManualMode').classList.remove('hidden');
          document.getElementById('alertAutoMode').classList.add('hidden');
        }

        let fields = [
          { key: 'permintaan', label: 'Surat Permintaan', icon: 'fa-envelope-open-text', format: config?.permintaan },
          { key: 'baPemeriksaan', label: 'BA Pemeriksaan', icon: 'fa-clipboard-check', format: config?.pemeriksaan },
          { key: 'baSerahTerima', label: 'BA Serah Terima', icon: 'fa-handshake', format: config?.bast },
          { key: 'baPembayaran', label: 'BA Pembayaran', icon: 'fa-money-check-alt', format: config?.bayar }
        ];

        if(tipe === 'toko') {
          fields.splice(1, 0, { key: 'penawaran', label: 'Surat Penawaran', icon: 'fa-file-invoice-dollar', format: config?.penawaran });
        }

        fields.forEach(f => {
          const currentValue = s[f.key] || '';
          let htmlInput = '';
          
          if (isAuto && f.format && f.format.trim() !== '') {
            // === MODE OTOMATIS ===
            const regex = /\[(.*?)\]/g;
            let matches = [...f.format.matchAll(regex)]; 
            
            let inputGroup = '';
            let placeholdersFound = false;

            const uniqueTags = [];
            matches.forEach(m => {
              const tag = m[1];
              if(!uniqueTags.includes(tag)) uniqueTags.push(tag);
            });

            uniqueTags.forEach(tag => {
              if(tag === 'bulan' || tag === 'tahun') return; // Skip bulan/tahun karena otomatis

              placeholdersFound = true;
              let savedVal = rawData[f.key] && rawData[f.key][tag] ? rawData[f.key][tag] : '';

              // --- DESAIN INPUT TAG ---
              inputGroup += `
                <div class="col-auto">
                  <div class="input-group shadow-sm" style="min-width: 180px;">
                    <span class="input-group-text bg-primary text-white border-primary fw-bold" style="font-size: 0.85rem;">
                      <i class="fas fa-pen fa-xs me-1 opacity-50"></i> ${tag}
                    </span>
                    <input type="text" class="form-control auto-input fw-bold text-dark" 
                          data-key="${f.key}" data-tag="${tag}"
                          value="${savedVal}" placeholder="..." style="font-size: 1rem; border-color: #cfe2ff;">
                  </div>
                </div>
              `;
            });

            const previewId = `preview-${f.key}`;
            
            if(placeholdersFound) {
              htmlInput = `
                <div class="p-3 bg-white rounded border" style="box-shadow: 0 2px 6px rgba(0,0,0,0.02);">
                  <div class="row g-2 align-items-center mb-2">${inputGroup}</div>
                  <div class="mt-2 px-3 py-2 rounded d-flex align-items-center" style="background-color: #f1f8ff; border-left: 4px solid #0d6efd;">
                    <div class="me-3 text-primary opacity-75"><i class="fas fa-eye"></i></div>
                    <div>
                      <div class="text-uppercase fw-bold text-primary opacity-50" style="font-size: 0.65rem; letter-spacing: 1px;">Hasil Preview</div>
                      <div id="${previewId}" class="fw-bold text-dark" style="font-size: 0.9rem; font-family: 'Consolas', monospace;">-</div>
                    </div>
                  </div>
                </div>
              `;
            } else {
              htmlInput = `
                <div class="p-2 bg-white rounded border">
                  <input type="hidden" class="auto-input" data-key="${f.key}" data-tag="DUMMY"> 
                  <div class="px-3 py-2 rounded d-flex align-items-center" style="background-color: #f8f9fa; border-left: 4px solid #6c757d;">
                    <div class="me-3 text-secondary opacity-50"><i class="fas fa-eye"></i></div>
                    <div>
                      <div class="text-uppercase fw-bold text-secondary opacity-50" style="font-size: 0.65rem; letter-spacing: 1px;">Hasil Preview (Otomatis)</div>
                      <div id="${previewId}" class="fw-bold text-dark" style="font-size: 0.9rem; font-family: 'Consolas', monospace;">-</div>
                    </div>
                  </div>
                </div>
              `;
            }

          } else {
            // === MODE MANUAL ===
            htmlInput = `
              <div class="input-group shadow-sm">
                <span class="input-group-text bg-light border-end-0"><i class="fas fa-keyboard text-muted"></i></span>
                <input type="text" class="form-control manual-input" id="manual_${f.key}" value="${currentValue}" placeholder="Ketik nomor surat lengkap disini...">
              </div>
            `;
          }

          const rowHtml = `
            <div class="mb-4">
              <label class="form-label fw-bold text-dark mb-2 d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">
                  <i class="fas ${f.icon}"></i>
                </div>
                ${f.label}
              </label>
              <div class="ps-1">${htmlInput}</div>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', rowHtml);
        });

        // [PERBAIKAN 2] Listener Preview - Pass dateMap, bukan tglTransaksi single
        if(isAuto) {
          const inputs = container.querySelectorAll('.auto-input');
          inputs.forEach(inp => {
            inp.addEventListener('input', () => updatePreviews(config, dateMap));
          });
          updatePreviews(config, dateMap);
        }

        const el = document.getElementById('modalSurat');
        modalSuratBS = new bootstrap.Modal(el);
        modalSuratBS.show();
      }

      // GANTI FUNGSI INI
      function updatePreviews(config, dateMap) {
        // Mapping Key HTML ID ke Key Config & Key DateMap
        const keyMap = {
          'permintaan': 'permintaan',
          'penawaran': 'penawaran',
          'baPemeriksaan': 'pemeriksaan', // HTML: baPemeriksaan -> Config: pemeriksaan
          'baSerahTerima': 'bast',        // HTML: baSerahTerima -> Config: bast
          'baPembayaran': 'bayar'         // HTML: baPembayaran -> Config: bayar
        };

        // Mapping Key HTML ke Key DateMap (karena penamaan di DateMap sedikit beda di code bukaModalSurat)
        const dateKeyMap = {
          'permintaan': 'permintaan',
          'penawaran': 'penawaran',
          'baPemeriksaan': 'baPemeriksaan',
          'baSerahTerima': 'baSerahTerima', 
          'baPembayaran': 'baPembayaran'
        };

        // Loop setiap field yang punya preview
        const previewSpans = document.querySelectorAll('[id^="preview-"]');
        previewSpans.forEach(span => {
          const htmlKey = span.id.replace('preview-', ''); // misal: baSerahTerima
          const configKey = keyMap[htmlKey]; // misal: bast
          
          // Ambil format mentah dari config
          let formatStr = config ? config[configKey] : ''; 

          if(!formatStr) {
              span.innerText = "-";
              return;
          }

          // [LOGIKA BARU] Ambil Tanggal SPESIFIK untuk field ini
          const specificDateKey = dateKeyMap[htmlKey];
          const dateString = dateMap[specificDateKey]; // Ambil tanggal dari map
          
          let bulan = '00', tahun = '0000';
          if(dateString) {
            const d = new Date(dateString);
            bulan = String(d.getMonth() + 1).padStart(2, '0');
            tahun = d.getFullYear();
          }

          // Replace Bulan & Tahun sesuai tanggal dokumen tersebut
          formatStr = formatStr.replace(/\[bulan\]/g, bulan).replace(/\[tahun\]/g, tahun);

          // Replace Input Tags (Nomor Urut, Kode, dll)
          const relatedInputs = document.querySelectorAll(`.auto-input[data-key="${htmlKey}"]`);
          relatedInputs.forEach(inp => {
            const tag = inp.getAttribute('data-tag');
            const val = inp.value || `[${tag}]`; 
            
            if(tag !== 'DUMMY') {
              const regex = new RegExp(`\\[${tag}\\]`, 'g');
              formatStr = formatStr.replace(regex, val);
            }
          });

          span.innerText = formatStr;
        });
      }

      // 4. Simpan Data Surat
      // --- SIMPAN SURAT (INVALIDATE CACHE) ---
      function simpanSurat(e) {
        e.preventDefault();
        
        const tipe = document.getElementById('suratTransTipe').value;
        const id = document.getElementById('suratTransId').value;
        
        // Ambil Config Toko/Tukang
        const config = (tipe === 'toko') ? globalAutoSettings.toko : globalAutoSettings.tukang;
        const isAuto = config && config.active;

        let dataSurat = {
          raw: {} 
        };
        
        // Ambil Map Tanggal dari Dataset Form (Logic dari update sebelumnya)
        const formEl = document.getElementById('formInputSurat');
        let dateMap = {};
        try {
          dateMap = JSON.parse(formEl.dataset.dateMap);
        } catch(err) {
          const tglGlobal = document.getElementById('suratTransTanggal').value;
          dateMap = {
            permintaan: tglGlobal, penawaran: tglGlobal, baPemeriksaan: tglGlobal, 
            baSerahTerima: tglGlobal, baPembayaran: tglGlobal
          };
        }

        const getBulanTahun = (dateStr) => {
          if(!dateStr) return { b: '00', t: '0000' };
          const d = new Date(dateStr);
          return {
            b: String(d.getMonth() + 1).padStart(2, '0'),
            t: d.getFullYear()
          };
        };

        if (isAuto) {
          // === MODE OTOMATIS ===
          
          // Fungsi internal pemroses format
          const processAutoFormat = (key, format, keyDate) => {
              const tglDoc = dateMap[keyDate]; 
              const { b, t } = getBulanTahun(tglDoc);

              let result = format.replace(/\[bulan\]/g, b).replace(/\[tahun\]/g, t);
              
              const inputs = document.querySelectorAll(`.auto-input[data-key="${key}"]`);
              
              if (!dataSurat.raw[key]) dataSurat.raw[key] = {};

              inputs.forEach(inp => {
                  const tag = inp.getAttribute('data-tag');
                  const val = inp.value.trim();
                  
                  if(tag !== 'DUMMY') {
                      dataSurat.raw[key][tag] = val; 
                      const regex = new RegExp(`\\[${tag}\\]`, 'g');
                      result = result.replace(regex, val);
                  }
              });
              return result;
          };

          const getFinalValue = (key, formatSetting, keyDateMap) => {
              if (formatSetting && formatSetting.trim() !== '') {
                  return processAutoFormat(key, formatSetting, keyDateMap);
              } else {
                  const elManual = document.getElementById('manual_' + key);
                  return elManual ? elManual.value : '';
              }
          };

          dataSurat.permintaan = getFinalValue('permintaan', config.permintaan, 'permintaan');
          dataSurat.baPemeriksaan = getFinalValue('baPemeriksaan', config.pemeriksaan, 'baPemeriksaan');
          dataSurat.baSerahTerima = getFinalValue('baSerahTerima', config.bast, 'baSerahTerima');
          dataSurat.baPembayaran = getFinalValue('baPembayaran', config.bayar, 'baPembayaran');
          
          if(tipe === 'toko') {
              dataSurat.penawaran = getFinalValue('penawaran', config.penawaran, 'penawaran');
          }

        } else {
          // === MODE MANUAL TOTAL ===
          dataSurat.permintaan = document.getElementById('manual_permintaan').value;
          dataSurat.baPemeriksaan = document.getElementById('manual_baPemeriksaan').value;
          dataSurat.baSerahTerima = document.getElementById('manual_baSerahTerima').value;
          dataSurat.baPembayaran = document.getElementById('manual_baPembayaran').value;
          
          if(tipe === 'toko') {
              dataSurat.penawaran = document.getElementById('manual_penawaran').value;
          }
        }

        const payload = { id: id, dataSurat: dataSurat };
        
        const btn = document.getElementById('btnSimpanSurat');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const token = localStorage.getItem('userToken');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            if(typeof modalSuratBS !== 'undefined') modalSuratBS.hide();
            
            // --- UPDATE PENTING: RESET CACHE ---
            DATA_CACHE['transaksi_' + tipe] = null; // Hapus cache lama
            loadDataSurat(tipe, true);              // Reload data baru
            // -----------------------------------

            Swal.fire({ 
              icon: 'success', title: 'Tersimpan', 
              text: 'Data nomor surat berhasil diperbarui.', timer: 1500, showConfirmButton: false 
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanDataSurat(token, payload);
      }

      /* --- LOGIKA MANAJEMEN TANGGAL SURAT --- */

      // 1. Tab Switching
      function bukaTabTanggal(tipe) {
        document.getElementById('tab-tgl-toko').classList.remove('active');
        document.getElementById('tab-tgl-tukang').classList.remove('active');
        
        if (tipe === 'toko') {
          document.getElementById('tab-tgl-toko').classList.add('active');
        } else {
          document.getElementById('tab-tgl-tukang').classList.add('active');
        }

        loadDataTanggal(tipe);
      }

      // 2. Load Data List untuk Tanggal
      // --- LOAD DATA TANGGAL (WITH CACHE) ---
      function loadDataTanggal(tipe, forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('tabelTanggalBody');
        const cacheKey = 'transaksi_' + tipe; // Gunakan key yg sama dgn Surat!

        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE[cacheKey]) {
          renderTabelTanggal(DATA_CACHE[cacheKey], tipe);
          return;
        }

        // 2. FETCH SERVER
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Memuat data...</td></tr>';

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // Simpan ke Cache
            DATA_CACHE[cacheKey] = res.data;
            renderTabelTanggal(res.data, tipe);
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe.toUpperCase());
      }

      // --- RENDER TABEL TANGGAL ---
      function renderTabelTanggal(data, tipe) {
        const tbody = document.getElementById('tabelTanggalBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Belum ada data transaksi ' + tipe + '.</td></tr>';
          return;
        }

        data.forEach(item => {
          const t = item.dataTanggal;
          let statusBadge = '<span class="badge bg-secondary">Belum Diatur</span>';

          if (t && t.baPembayaran) {
            statusBadge = '<span class="badge bg-success">Sudah Diisi</span>';
          } else if (t) {
            statusBadge = '<span class="badge bg-warning text-dark">Sebagian</span>';
          }

          const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");

          const btnLihat = `
            <button class="btn btn-sm btn-info text-white me-1" 
              onclick="lihatTanggalSurat('${tipe}', '${dataJson}')" title="Lihat Daftar Tanggal">
              <i class="fas fa-eye"></i>
            </button>
          `;

          const btnAtur = `
            <button class="btn btn-sm btn-outline-success" 
              onclick="bukaModalTanggal('${tipe}', '${dataJson}')">
              <i class="fas fa-calendar-check me-1"></i> Atur
            </button>
          `;

          const row = `
            <tr>
              <td>${item.tanggalDisplay}</td> 
              <td><div class="text-truncate" style="max-width:250px;">${item.uraian}</div></td>
              <td>${item.pihakKetiga}</td>
              <td>${statusBadge}</td>
              <td style="white-space:nowrap;">${btnLihat} ${btnAtur}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      // TAMBAHKAN FUNGSI INI (Fungsi Baru untuk Popup Lihat Tanggal)
      // GANTI FUNGSI INI DI Index.html
      function lihatTanggalSurat(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const t = data.dataTanggal || {}; 

        // Helper Format Tanggal Indonesia (dd-mm-yyyy)
        const fmt = (dateStr) => {
            if(!dateStr) return '<span class="text-muted fst-italic small bg-light px-2 rounded">- Belum diatur -</span>';
            
            const d = new Date(dateStr);
            if(isNaN(d.getTime())) return '-';
            
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            
            return `<span class="fw-bold text-dark font-monospace">${dd}-${mm}-${yyyy}</span>`;
        };

        let htmlContent = '<div class="text-start px-2">';
        
        // Reuse styling baris info
        const rowInfo = (label, valHtml) => {
            return `
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-caret-right text-success me-2"></i>
                        <div class="text-secondary small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">${label}</div>
                    </div>
                    <div class="ps-3 border-start border-3 border-light ms-1" style="font-size: 0.95rem;">${valHtml}</div>
                </div>
            `;
        };

        // [BAGIAN BARU] Info Detail Utama (Uraian & Pihak Ketiga)
        htmlContent += rowInfo('Uraian Pekerjaan', `<span class="fw-bold text-dark">${data.uraian}</span>`);
        
        // Label Pihak Ketiga menyesuaikan Tipe
        let labelPihak = 'Pihak Ketiga';
        if(tipe === 'guru') labelPihak = 'Keterangan / Honorarium';
        
        htmlContent += rowInfo(labelPihak, `<span class="fw-bold text-dark">${data.pihakKetiga}</span>`);

        // Garis Pembatas (Divider)
        htmlContent += '<hr class="border-secondary opacity-25 my-3" style="border-style: dashed;">';

        // [BAGIAN TANGGAL]
        // 1. Tanggal Permintaan
        const tglMinta = t.permintaan || data.tanggal;
        htmlContent += rowInfo('Tgl. Surat Permintaan', fmt(tglMinta));
        
        // 2. Tanggal Penawaran (Khusus Toko)
        if (tipe === 'toko') {
            htmlContent += rowInfo('Tgl. Surat Penawaran', fmt(t.penawaran));
        }
        
        // 3. Tanggal Berita Acara
        htmlContent += rowInfo('Tgl. BA Pemeriksaan', fmt(t.baPemeriksaan));
        htmlContent += rowInfo('Tgl. BA Serah Terima', fmt(t.baSerahTerima));
        htmlContent += rowInfo('Tgl. BA Pembayaran', fmt(t.baPembayaran));
        
        htmlContent += '</div>';

        // Tampilkan SweetAlert
        Swal.fire({
            title: `<span class="fs-5"><i class="fas fa-calendar-alt text-success me-2"></i> Rincian Tanggal Dokumen</span>`,
            html: htmlContent,
            showCloseButton: true,
            showConfirmButton: false,
            width: '500px',
            background: '#fff',
            customClass: {
              popup: 'rounded-4 shadow-lg'
            }
        });
      }

      // 3. Buka Modal Tanggal (UPDATE: Dengan Validasi Tanggal Minimum)
      let modalTanggalBS = null;

      function bukaModalTanggal(tipe, encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const t = data.dataTanggal || {}; 

        // Set ID Hidden
        document.getElementById('tglTransId').value = data.id;
        document.getElementById('tglTransTipe').value = tipe;

        // Reset Form
        document.getElementById('formInputTanggal').reset();

        // --- LOGIKA VALIDASI TANGGAL ---
        // Ambil Tanggal Transaksi (Format YYYY-MM-DD dari backend)
        const minDate = data.tanggal; 
        
        // Daftar ID Input yang ingin dibatasi
        const dateFields = [
          'tglSuratPenawaran', 
          'tglBaPemeriksaan', 
          'tglBaSerahTerima', 
          'tglBaPembayaran'
        ];

        // Loop setiap field untuk set atribut 'min'
        dateFields.forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            // Set batas minimum pemilihan tanggal
            el.setAttribute('min', minDate);
            
            // Opsional: Tambahkan event listener jika user mengetik manual (bukan klik kalender)
            el.onchange = function() {
              if(this.value && this.value < minDate) {
                Swal.fire('Tanggal Tidak Valid', 'Tanggal tidak boleh kurang dari tanggal transaksi (' + minDate + ')', 'warning');
                this.value = minDate; // Reset ke tanggal minimal
              }
            };
          }
        });

        // -------------------------------

        // Field Kondisional (Penawaran)
        const wrapPenawaran = document.getElementById('wrapTglPenawaran');
        if (tipe === 'toko') {
          wrapPenawaran.classList.remove('hidden');
          document.getElementById('tglSuratPenawaran').value = t.penawaran || '';
        } else {
          wrapPenawaran.classList.add('hidden');
          document.getElementById('tglSuratPenawaran').value = '';
        }

        // Isi Tanggal Permintaan (Readonly & Sesuai Transaksi)
        document.getElementById('tglSuratPermintaan').value = data.tanggal;

        // Isi Field Lainnya (jika ada di database)
        document.getElementById('tglBaPemeriksaan').value = t.baPemeriksaan || '';
        document.getElementById('tglBaSerahTerima').value = t.baSerahTerima || '';
        document.getElementById('tglBaPembayaran').value = t.baPembayaran || '';

        // Tampilkan Modal
        const el = document.getElementById('modalTanggal');
        modalTanggalBS = new bootstrap.Modal(el);
        modalTanggalBS.show();
      }

      // 4. Simpan Data Tanggal
      // --- SIMPAN TANGGAL (INVALIDATE CACHE) ---
      function simpanTanggal(e) {
        e.preventDefault();
        
        const tipe = document.getElementById('tglTransTipe').value;
        const id = document.getElementById('tglTransId').value;

        const dataTanggal = {
          permintaan: document.getElementById('tglSuratPermintaan').value,
          penawaran: document.getElementById('tglSuratPenawaran').value,
          baPemeriksaan: document.getElementById('tglBaPemeriksaan').value,
          baSerahTerima: document.getElementById('tglBaSerahTerima').value,
          baPembayaran: document.getElementById('tglBaPembayaran').value
        };

        const payload = { id: id, dataTanggal: dataTanggal };

        const btn = document.getElementById('btnSimpanTanggal');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const token = localStorage.getItem('userToken');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;

          if (res.status === 'success') {
            if(typeof modalTanggalBS !== 'undefined') modalTanggalBS.hide();
            
            // --- UPDATE PENTING: RESET CACHE ---
            DATA_CACHE['transaksi_' + tipe] = null; 
            loadDataTanggal(tipe, true); 
            // -----------------------------------

            Swal.fire({
              icon: 'success', title: 'Tersimpan', 
              text: 'Data tanggal dokumen berhasil diperbarui.',
              timer: 1500, showConfirmButton: false
            });
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanTanggalSurat(token, payload);
      }

      /* --- HELPER FORMAT ANGKA INPUT (FIXED COPY-PASTE) --- */

      // Mengubah input "10000" atau "10.000,00" menjadi tampilan "10.000"
      function formatRibuanInput(angka) {
        if (!angka && angka !== 0) return '';
        
        let str = String(angka);

        // 1. [PERBAIKAN UTAMA] Cek Koma (Desimal)
        // Jika ada koma, buang semua angka dibelakangnya.
        // Contoh: "100.000,00" -> diambil "100.000" saja.
        if (str.indexOf(',') > -1) {
          str = str.split(',')[0];
        }
        
        // 2. Hapus karakter selain angka (0-9)
        // Contoh: "Rp 100.000" -> "100000"
        let raw = str.replace(/[^\d]/g, '');
        
        if (!raw) return '';
        
        // 3. Format jadi 1.000.000 (Style Indonesia)
        return new Intl.NumberFormat('id-ID').format(raw);
      }

      // Mengubah tampilan "10.000" menjadi angka murni 10000 (untuk kalkulasi matematika)
      function cleanRibuan(str) {
        if (!str) return 0;
        
        let s = String(str);
        
        // 1. Buang desimal jika ada (Sama seperti di atas)
        if (s.indexOf(',') > -1) {
          s = s.split(',')[0];
        }
        
        // 2. Hapus tanda titik (ribuan) dan simbol mata uang
        // Kita sisakan angka dan tanda minus (jika ada diskon/potongan)
        let bersih = s.replace(/\./g, '').replace(/[^\d-]/g, '');
        
        return parseFloat(bersih) || 0;
      }

      /* --- FUNGSI DASHBOARD (UPDATE CACHE) --- */

      // 1. Fungsi Utama Load Dashboard
      function loadDashboardStats(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        
        // A. CEK CACHE: Jika data ada & tidak dipaksa refresh
        if (!forceRefresh && DATA_CACHE.dashboard) {
          console.log("Dashboard data loaded from Cache.");
          renderDashboardStats(DATA_CACHE.dashboard);
          return;
        }

        // B. TAMPILKAN LOADING (Hanya jika mengambil data baru dari server)
        document.getElementById('dashAnggaran').innerText = '...';
        document.getElementById('dashPengeluaran').innerText = '...';
        document.getElementById('dashSisa').innerText = '...';
        document.getElementById('dashJmlTrans').innerText = '...';
        
        // C. AMBIL DARI SERVER
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // Simpan ke Cache
            DATA_CACHE.dashboard = res.data;
            
            // Tampilkan Data
            renderDashboardStats(res.data);
            cekPopUpAnggaran(res.data.anggaran);
          }
        }).getDashboardStats(token);
      }

      // 2. Fungsi Helper Render (Memisahkan tampilan dari logika load)
      function renderDashboardStats(d) {
        const p = d.profile || {}; // Data Profil Sekolah

        // Render Statistik
        const anggaran = parseFloat(d.anggaran) || 0;
        const pengeluaran = parseFloat(d.pengeluaran) || 0;
        const jmlTrans = d.jumlahTransaksi || 0;
        const sisa = anggaran - pengeluaran;

        document.getElementById('dashAnggaran').innerText = formatRupiahJS(anggaran);
        document.getElementById('dashPengeluaran').innerText = formatRupiahJS(pengeluaran);
        document.getElementById('dashSisa').innerText = formatRupiahJS(sisa);
        document.getElementById('dashJmlTrans').innerText = jmlTrans + " Item";

        // Pewarnaan Kartu Sisa
        const cardSisa = document.getElementById('cardSisaAnggaran');
        const titleSisa = cardSisa.querySelector('h6');
        const iconSisa = cardSisa.querySelector('i');
        const angkaSisa = cardSisa.querySelector('h3');
        const ketSisa = cardSisa.querySelector('small');
        
        // Reset class dasar
        cardSisa.className = 'card p-3 shadow-sm h-100'; 

        if (sisa > 0) {
          cardSisa.style.backgroundColor = '#ffc107'; 
          if(titleSisa) titleSisa.className = 'mb-0 text-dark fw-bold opacity-75';
          if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-dark opacity-50';
          if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-dark';
          if(ketSisa)   ketSisa.className = 'text-dark opacity-75';
        } else if (sisa === 0) {
          cardSisa.style.backgroundColor = '#198754';
          if(titleSisa) titleSisa.className = 'mb-0 text-white-50';
          if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-white opacity-50';
          if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-white';
          if(ketSisa)   ketSisa.className = 'text-white-50';
        } else {
          cardSisa.style.backgroundColor = '#dc3545';
          if(titleSisa) titleSisa.className = 'mb-0 text-white-50';
          if(iconSisa)  iconSisa.className = 'fas fa-chart-pie fa-lg text-white opacity-50';
          if(angkaSisa) angkaSisa.className = 'fw-bold mb-0 text-white';
          if(ketSisa)   ketSisa.className = 'text-white-50';
        }

        // Render Profil Sekolah
        document.getElementById('dashNamaSekolah').innerText = p.nama || '-';
        document.getElementById('dashNpsn').innerText = p.npsn || '-';
        document.getElementById('dashNsm').innerText = p.nsm || '-';
        document.getElementById('dashAlamat').innerText = p.alamat || '-';
        
        document.getElementById('dashKelurahan').innerText = p.kelurahan || '-';
        document.getElementById('dashKecamatan').innerText = p.kecamatan || '-';
        
        let kabProv = p.kabupaten || '-';
        if(p.provinsi) kabProv += ' - ' + p.provinsi;
        document.getElementById('dashKabupaten').innerText = kabProv;

        document.getElementById('dashTelp').innerText = p.noTelp || '-';
        document.getElementById('dashEmail').innerText = p.email || '-';
        
        document.getElementById('dashKepala').innerText = p.kepala || '-';
        document.getElementById('dashNipKepala').innerText = p.nipKepala || '-';
        document.getElementById('dashBendahara').innerText = p.bendahara || '-';
        document.getElementById('dashNipBendahara').innerText = p.nipBendahara || '-';
      }

      /* --- LOGIKA MENU CETAK PDF --- */

      // 1. Fungsi Ganti Tab Cetak
      /* --- UPDATE FUNGSI INI --- */
      function bukaTabCetak(tipe) {
        // Reset Tab Active Class
        document.getElementById('tab-cetak-toko').classList.remove('active');
        document.getElementById('tab-cetak-guru').classList.remove('active');
        document.getElementById('tab-cetak-tukang').classList.remove('active');
        document.getElementById('tab-cetak-setting').classList.remove('active'); // Baru
        
        // Set Active Tab Button
        document.getElementById('tab-cetak-' + tipe).classList.add('active');

        // Sembunyikan semua tabel view
        document.querySelectorAll('.view-cetak').forEach(el => el.classList.add('hidden'));
        
        // Munculkan tabel/view yang dipilih
        document.getElementById('view-cetak-' + tipe).classList.remove('hidden');

        // Load Data sesuai tipe
        if (tipe === 'setting') {
          loadTemplateSettings(); // Fungsi Baru
        } else {
          loadListCetak(tipe);
        }
      }

      // 2. Load Data ke Tabel Cetak
      // --- LOAD LIST CETAK PDF (WITH CACHE) ---
      function loadListCetak(tipeRaw, forceRefresh = false) {
        const tipe = tipeRaw.toUpperCase(); 
        const cacheKey = 'transaksi_' + tipeRaw; // Sharing cache dengan menu Transaksi!
        const tbody = document.getElementById('tbody-cetak-' + tipeRaw);

        // 1. CEK CACHE
        // Jika data sudah diload di menu Transaksi, kita pakai saja data itu!
        if (!forceRefresh && DATA_CACHE[cacheKey]) {
          renderTabelCetak(DATA_CACHE[cacheKey], tipeRaw);
          return;
        }

        // 2. FETCH SERVER
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary text-sm"></div><br>Sedang memuat data...</td></tr>';
        const token = localStorage.getItem('userToken');

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // Update Cache Global
            DATA_CACHE[cacheKey] = res.data;
            renderTabelCetak(res.data, tipeRaw);
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
          }
        }).getTransaksiList(token, tipe);
      }

      // --- RENDER TABEL CETAK (DIPISAH) ---
      function renderTabelCetak(data, tipeRaw) {
        const tbody = document.getElementById('tbody-cetak-' + tipeRaw);
        tbody.innerHTML = '';
        
        if(data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Tidak ada data transaksi.</td></tr>';
          return;
        }

        data.forEach(item => {
          // Encode data untuk parameter onclick
          const dataJson = encodeURIComponent(JSON.stringify(item)).replace(/'/g, "%27");
          
          let displayPihak = item.pihakKetiga;
          if (tipeRaw === 'guru' && (displayPihak === '-' || displayPihak === 'Honorarium Guru')) {
            displayPihak = "-";
          }

          // --- 1. LOGIKA STATUS DOKUMEN (ICON DINAMIS) ---
          // Menghitung kelengkapan dokumen (Surat & Tanggal)
          const s = item.dataSurat || {};
          const t = item.dataTanggal || {};
          
          let keys = ['permintaan', 'baPemeriksaan', 'baSerahTerima', 'baPembayaran'];
          if (tipeRaw === 'toko') keys.push('penawaran'); // Toko ada Penawaran
          
          let filled = 0;
          let totalTarget = keys.length * 2; // Dikali 2 karena ada Nomor & Tanggal
          
          // Hitung yang terisi
          keys.forEach(k => { 
            if (s[k] && String(s[k]).trim() !== '') filled++; 
            if (t[k] && String(t[k]).trim() !== '') filled++; 
          });

          // Tentukan Warna & Icon Tombol Status
          let btnStatusClass = 'btn-outline-warning'; // Default Sebagian (Kuning)
          let iconStatusClass = 'fa-exclamation-circle';
          let tooltipStatus = `Status: Sebagian (${filled}/${totalTarget})`;

          if (filled === 0) {
            // Kosong
            btnStatusClass = 'btn-outline-secondary';
            iconStatusClass = 'fa-file-contract'; // Icon dokumen netral
            tooltipStatus = 'Status: Belum Dilengkapi';
          } else if (filled === totalTarget) {
            // Lengkap
            btnStatusClass = 'btn-outline-success';
            iconStatusClass = 'fa-check-circle';
            tooltipStatus = 'Status: Lengkap';
          }

          // Khusus Guru: Gunakan style standar (karena item dokumennya mungkin berbeda/sedikit)
          if (tipeRaw === 'guru') {
            btnStatusClass = 'btn-outline-secondary';
            iconStatusClass = 'fa-file-contract';
            tooltipStatus = 'Cek Status Dokumen';
          }

          // Buat HTML Tombol Status
          const btnStatus = `
            <button class="btn btn-sm ${btnStatusClass} me-1" onclick="lihatStatusDokumen('${dataJson}')" title="${tooltipStatus}">
              <i class="fas ${iconStatusClass}"></i>
            </button>
          `;

          // --- 2. TOMBOL LIHAT DETAIL (MATA) ---
          const btnLihat = `
            <button class="btn btn-sm btn-outline-info me-1" onclick="lihatDetailTransaksi('${dataJson}')" title="Lihat Rincian">
              <i class="fas fa-eye"></i>
            </button>
          `;
          
          // --- 3. TOMBOL GENERATE/CETAK PDF ---
          let btnGenerate = '';
          let btnCetak = '';

          // Cek apakah PDF ID sudah ada di database
          if (item.pdfId && item.pdfId !== "") {
            const linkPdf = `https://drive.google.com/file/d/${item.pdfId}/view?usp=sharing`;
            
            btnCetak = `
              <button class="btn btn-sm btn-dark me-1" onclick="window.open('${linkPdf}', '_blank')" title="Cetak / Buka PDF">
                <i class="fas fa-print"></i>
              </button>
            `;
            
            btnGenerate = `
              <button class="btn btn-sm btn-outline-danger" onclick="prosesCetakPDF('${item.id}', '${dataJson}', '${tipeRaw}')" title="Generate Ulang">
                <i class="fas fa-sync-alt"></i>
              </button>
            `;
          } else {
            btnGenerate = `
              <button class="btn btn-sm btn-warning" onclick="prosesCetakPDF('${item.id}', '${dataJson}', '${tipeRaw}')" title="Generate PDF Baru">
                <i class="fas fa-cog"></i>
              </button>
            `;
          }

          // --- RENDER BARIS TABEL ---
          const row = `
            <tr>
              <td>${item.tanggalDisplay}</td>
              <td><div class="text-truncate" style="max-width: 250px;">${item.uraian}</div></td>
              <td>${displayPihak}</td>
              <td class="fw-bold">${formatRupiahJS(item.total)}</td>
              <td style="white-space: nowrap;">
                  ${btnStatus} ${btnLihat} ${btnCetak} ${btnGenerate}
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      /* --- FUNGSI PROSES CETAK PDF (DENGAN KONFIRMASI TIMPA FILE) --- */
      function prosesCetakPDF(id, encodedData, tipeTab) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const token = localStorage.getItem('userToken');

        // 1. Tentukan Nama Dokumen Berdasarkan Tab/Tipe
        let namaDokumen = "Laporan";
        const tipeUpper = tipeTab.toUpperCase();

        if (tipeUpper === 'TOKO') namaDokumen = "Laporan Belanja Toko";
        else if (tipeUpper === 'GURU') namaDokumen = "Laporan Honor Guru";
        else if (tipeUpper === 'TUKANG') namaDokumen = "Laporan Upah Tukang";

        // 2. Cek Apakah File Lama Sudah Ada? (Berdasarkan pdfId di data baris)
        const fileAda = (data.pdfId && data.pdfId !== "");

        // 3. Konfigurasi SweetAlert Default (File Baru)
        let judulSwal = 'Generate PDF?';
        let htmlPesan = `Sistem akan membuat <b>${namaDokumen}</b> untuk:<br/>"${data.uraian}".<br/><br/>Lanjutkan?`;
        let warnaTombol = '#0d6efd'; // Biru (Standar)
        let teksTombol = 'Generate';

        // 4. Konfigurasi Jika File Sudah Ada (Mode Timpa)
        if (fileAda) {
          judulSwal = 'Ganti File Lama?';
          htmlPesan = `File <b>${namaDokumen}</b> lama akan <b>DIHAPUS</b> dan diganti dengan yang baru.<br/><br/>Uraian: "${data.uraian}".<br/>Lanjutkan?`;
          warnaTombol = '#dc3545'; // Merah (Warning)
          teksTombol = 'Ya, Ganti File';
        }

        // 5. Tampilkan Popup Konfirmasi
        Swal.fire({
          title: judulSwal,
          html: htmlPesan,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: warnaTombol,
          cancelButtonColor: '#6c757d',
          confirmButtonText: teksTombol,
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {

            // Tampilkan Loading
            Swal.fire({
              title: 'Memproses...',
              html: `Sedang menyusun ${namaDokumen}...`,
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading()
            });

            // Persiapan Data Kirim
            let tipeTransaksi = data.tipe || 'TOKO';
            const namaMadrasah = document.getElementById('dashNamaSekolah').innerText || 'Madrasah';
            // Pastikan nomor surat ada fallback jika belum disetting
            const nomorSurat = (data.dataSurat && data.dataSurat.permintaan) ? data.dataSurat.permintaan : 'DRAFT';

            const formUntukPDF = {
              idTransaksi: id,
              tipe: tipeTransaksi,
              nomorSurat: nomorSurat,
              pihakKetiga: data.pihakKetiga,
              pemesan: data.pemesan,
              uraian: data.uraian,
              tanggal: data.tanggal,
              namaMadrasah: namaMadrasah,
              total: data.total,
              items: data.items
            };

            // Kirim ke Server
            google.script.run
              .withFailureHandler((err) => { Swal.fire('Gagal', err.message, 'error'); })
              .withSuccessHandler(function(res) {
                if (res.status === 'success') {

                  // Hapus Cache Lokal (Agar status tombol cetak terupdate saat reload tabel)
                  // Ini penting agar tombol berubah dari "Generate" menjadi "Lihat PDF"
                  DATA_CACHE['transaksi_' + tipeTab] = null;

                  Swal.fire({
                    icon: 'success',
                    title: 'Berhasil',
                    text: `Dokumen ${namaDokumen} berhasil dibuat!`,
                    confirmButtonText: 'Buka PDF',
                    showCancelButton: true,
                    cancelButtonText: 'Tutup'
                  }).then((r) => {
                    if (r.isConfirmed) window.open(res.url, '_blank');
                    
                    // Reload Tabel otomatis untuk memperbarui tombol di list
                    loadListCetak(tipeTab);
                  });

                } else {
                  Swal.fire({ icon: 'error', title: 'Terjadi Kesalahan', html: res.message, width: '500px' });
                }
              })
              .generateLPJ(token, formUntukPDF);
          }
        });
      }

      /* --- PERBAIKAN FITUR FILTER TAHUN (FINAL) --- */

      // Mapping ID Filter ke ID Tabel
      const FILTER_MAP = [
        { filter: 'fltTahun_toko', table: 'listTransaksiToko' },
        { filter: 'fltTahun_guru', table: 'listTransaksiGuru' },
        { filter: 'fltTahun_tukang', table: 'listTransaksiTukang' },
        { filter: 'fltTahun_surat', table: 'tabelSuratBody' },
        { filter: 'fltTahun_tgl', table: 'tabelTanggalBody' },
        { filter: 'fltTahun_cetak_toko', table: 'tbody-cetak-toko' },
        { filter: 'fltTahun_cetak_guru', table: 'tbody-cetak-guru' },
        { filter: 'fltTahun_cetak_tukang', table: 'tbody-cetak-tukang' }
      ];

      function initFilterTahun() {
        FILTER_MAP.forEach(item => {
          const tbody = document.getElementById(item.table);
          const select = document.getElementById(item.filter);
          
          if (tbody && select) {
            // 1. Eksekusi langsung saat halaman dimuat (Tanpa Menunggu)
            updateOptionsTahun(tbody, select);

            // 2. Pasang Observer untuk memantau perubahan data tabel secara Realtime
            // Jika Anda input transaksi baru -> Tabel Berubah -> Filter Update otomatis
            const observer = new MutationObserver(() => {
              updateOptionsTahun(tbody, select);
            });
            
            observer.observe(tbody, { childList: true, subtree: true });
          }
        });
      }

      function updateOptionsTahun(tbody, select) {
        // A. AMBIL TAHUN ANGGARAN (Prioritas: LocalStorage > Cache > Tahun Komputer)
        // Kita ambil dari localStorage 'userYear' yang diset saat login. Ini pasti ada dan cepat.
        let tahunAnggaran = localStorage.getItem('userYear'); 
        
        if (!tahunAnggaran && typeof DATA_CACHE !== 'undefined' && DATA_CACHE.sekolah) {
          tahunAnggaran = DATA_CACHE.sekolah.tahunAnggaran;
        }
        
        // Jika masih tidak ketemu (sangat jarang), fallback ke tahun komputer
        let tahunDefault = tahunAnggaran ? parseInt(tahunAnggaran) : new Date().getFullYear();

        // B. KUMPULKAN TAHUN DARI TABEL
        const years = new Set();
        
        // Wajib masukkan Tahun Anggaran ke dalam list (walaupun tabel kosong)
        years.add(tahunDefault);

        // Scan baris tabel
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
          // Abaikan baris loading/kosong
          if (row.innerText.includes('Memuat') || row.cells.length < 2) return;

          // Cek teks di kolom awal (Tanggal biasanya di kolom 1 atau 2)
          let textCek = "";
          if(row.cells[0]) textCek += row.cells[0].innerText + " "; 
          if(row.cells[1]) textCek += row.cells[1].innerText;

          // Cari angka tahun 20xx
          const match = textCek.match(/\b(20\d{2})\b/);
          if (match) {
            years.add(parseInt(match[1]));
          }
        });

        // C. URUTKAN TAHUN (Terbaru di atas)
        const sortedYears = Array.from(years).sort((a, b) => b - a);

        // D. RENDER KE HTML
        // Simpan pilihan user sekarang agar tidak reset saat update realtime
        const currentSelection = select.value; 

        let html = '<option value="">Semua Tahun</option>';
        sortedYears.forEach(y => {
          html += `<option value="${y}">${y}</option>`;
        });
        
        // Hanya update innerHTML jika ada perubahan (Mencegah kedip/reset)
        if (select.innerHTML !== html) {
            select.innerHTML = html;
            
            // E. KEMBALIKAN POSISI PILIHAN
            // Jika user sudah memilih tahun, pertahankan. 
            // Jika belum (atau awal load), biarkan default "Semua Tahun" (value="").
            if (currentSelection && years.has(parseInt(currentSelection))) {
              select.value = currentSelection;
            } else {
              select.value = ""; // Default ke Semua Tahun
            }
        }
      }

      // 2. Fungsi Utama Filter
      function jalankanFilter(tabelBodyId, tahunSelectId, bulanSelectId) {
        const filterTahun = document.getElementById(tahunSelectId).value;
        const filterBulan = document.getElementById(bulanSelectId).value;
        
        const tbody = document.getElementById(tabelBodyId);
        const rows = tbody.getElementsByTagName('tr');

        // --- DETEKSI APAKAH SEDANG MODE HAPUS? ---
        // Kita perlu tahu tipe tabelnya (toko/guru/tukang) untuk cek STATE_HAPUS
        let tipe = '';
        if (tabelBodyId === 'listTransaksiToko') tipe = 'toko';
        else if (tabelBodyId === 'listTransaksiGuru') tipe = 'guru';
        else if (tabelBodyId === 'listTransaksiTukang') tipe = 'tukang';

        // Jika variable STATE_HAPUS ada (dari fitur sebelumnya) dan bernilai true,
        // maka Tanggal ada di kolom index 1. Jika tidak, di index 0.
        let indexTanggal = 0;
        if (typeof STATE_HAPUS !== 'undefined' && STATE_HAPUS[tipe] === true) {
          indexTanggal = 1; 
        }
        // ------------------------------------------
        
        // Loop semua baris
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          
          // Ambil sel tanggal berdasarkan index dinamis tadi
          const tdTanggal = row.cells[indexTanggal]; 
          
          if (tdTanggal) {
            const textTanggal = tdTanggal.textContent.trim();
            
            // Jika barisnya adalah "Memuat data..." atau kosong, skip
            if(textTanggal.includes('Memuat') || textTanggal.includes('Belum ada')) continue;
            
            // Pecah tanggal (dd-MM-yyyy)
            const parts = textTanggal.split('-');
            if(parts.length === 3) {
              const rowBulan = parts[1]; // MM
              const rowTahun = parts[2]; // yyyy
              
              // Logika Cek Match
              const matchTahun = (filterTahun === '') || (rowTahun === filterTahun);
              const matchBulan = (filterBulan === '') || (rowBulan === filterBulan);
              
              if (matchTahun && matchBulan) {
                row.style.display = ''; // Tampilkan
              } else {
                row.style.display = 'none'; // Sembunyikan
              }
            }
          }
        }
      }

      /* --- UPDATE: GUNAKAN DOMContentLoaded AGAR LEBIH CEPAT --- */
      document.addEventListener("DOMContentLoaded", function() {
        
        // 1. Pastikan Loading Overlay tertutup dulu agar tidak blank
        toggleLoading(false); 

        // 2. Jalankan fungsi dasar (dengan pengecekan error)
        try {
          if (typeof populateLoginYears === 'function') populateLoginYears();
          if (typeof initFilterTahun === 'function') initFilterTahun();
        } catch (e) {
          console.warn("Init Error:", e);
        }

        // 3. Cek Sesi (Aman untuk Incognito)
        let token = null;
        let sessionToken = null;
        let email = null;

        try {
          token = localStorage.getItem('userToken');
          sessionToken = localStorage.getItem('sessionToken');
          email = localStorage.getItem('userEmail');
        } catch (e) {
          console.log("Mode Incognito / Akses Storage Dibatasi.");
          // Abaikan error, biarkan variabel null agar lari ke Login
        }

        // 4. Logika Routing (Login vs Admin)
        if (token && sessionToken && email) {
          // A. Jika ada data sesi, Cek Validitas ke Server
          
          // Tampilkan loading HANYA jika yakin ada sesi
          toggleLoading(true, "Memeriksa Sesi..."); 

          google.script.run
            .withSuccessHandler(function(res) {
              toggleLoading(false); 
              
              if (res && res.valid) {
                // --- SESI VALID: Masuk ke Admin ---
                switchView('view-admin');
                
                // Restore Nama Sekolah di Header
                try {
                  const savedName = localStorage.getItem('userName');
                  if(savedName) {
                    const elName = document.getElementById('schoolNameDisplay');
                    if(elName) elName.innerText = "(" + savedName + ")";
                  }
                } catch(e) {}

                // Load Data Dashboard
                if(typeof updateTampilanTahun === 'function') updateTampilanTahun();
                if(typeof loadDashboardStats === 'function') loadDashboardStats();
                if(typeof startSessionMonitor === 'function') startSessionMonitor();

              } else {
                // --- SESI INVALID: Lempar ke Login ---
                forceLogoutLocal();
              }
            })
            .withFailureHandler(function(err) {
              // Jika Server Error (Koneksi/Incognito Block), Lempar ke Login
              console.error("Gagal cek sesi:", err);
              toggleLoading(false);
              forceLogoutLocal();
            })
            .checkSessionStatus(email, sessionToken);

        } else {
          // B. Jika tidak ada token (Incognito/Baru Buka) -> LANGSUNG TAMPILKAN LOGIN
          // Jangan pakai toggleLoading() disini agar tampilan instan
          switchView('view-login');
        }
      });

      // Helper Kecil untuk Logout Lokal Cepat
      function forceLogoutLocal() {
        try { localStorage.clear(); } catch(e) {}
        const formLogin = document.getElementById('formLogin');
        if(formLogin) formLogin.reset();
        switchView('view-login');
      }

      // Load Setting dari Server ke Form
      function loadSettingNomor() {
        const token = localStorage.getItem('userToken');
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          if(res.status === 'success' && res.data) {
            const s = res.data;
            globalAutoSettings = s; // Update Global Cache

            // Set Toko
            document.getElementById('toggleAutoToko').checked = s.toko.active;
            toggleFormSetting('toko');
            document.getElementById('fmtTokoPermintaan').value = s.toko.permintaan || '';
            document.getElementById('fmtTokoPenawaran').value = s.toko.penawaran || '';
            document.getElementById('fmtTokoPemeriksaan').value = s.toko.pemeriksaan || '';
            document.getElementById('fmtTokoBAST').value = s.toko.bast || '';
            document.getElementById('fmtTokoBayar').value = s.toko.bayar || '';

            // Set Tukang
            document.getElementById('toggleAutoTukang').checked = s.tukang.active;
            toggleFormSetting('tukang');
            document.getElementById('fmtTukangPermintaan').value = s.tukang.permintaan || '';
            document.getElementById('fmtTukangPemeriksaan').value = s.tukang.pemeriksaan || '';
            document.getElementById('fmtTukangBAST').value = s.tukang.bast || '';
            document.getElementById('fmtTukangBayar').value = s.tukang.bayar || '';
          }
        }).getSettingNomor(token);
      }

      // Helper Toggle UI
      function toggleFormSetting(tipe) {
        const isActive = document.getElementById(tipe === 'toko' ? 'toggleAutoToko' : 'toggleAutoTukang').checked;
        const formDiv = document.getElementById(tipe === 'toko' ? 'formAutoToko' : 'formAutoTukang');
        isActive ? formDiv.classList.remove('hidden') : formDiv.classList.add('hidden');
      }

      // Simpan Setting ke Server
      function simpanSettingNomor() {
        const token = localStorage.getItem('userToken');
        
        // Ambil data dari form
        const settings = {
          toko: {
            active: document.getElementById('toggleAutoToko').checked,
            permintaan: document.getElementById('fmtTokoPermintaan').value,
            penawaran: document.getElementById('fmtTokoPenawaran').value,
            pemeriksaan: document.getElementById('fmtTokoPemeriksaan').value,
            bast: document.getElementById('fmtTokoBAST').value,
            bayar: document.getElementById('fmtTokoBayar').value
          },
          tukang: {
            active: document.getElementById('toggleAutoTukang').checked,
            permintaan: document.getElementById('fmtTukangPermintaan').value,
            pemeriksaan: document.getElementById('fmtTukangPemeriksaan').value,
            bast: document.getElementById('fmtTukangBAST').value,
            bayar: document.getElementById('fmtTukangBayar').value
          }
        };

        // --- LOGIKA ANIMASI LOADING ---
        // Kita cari tombol yang memanggil fungsi ini
        // (Pastikan di HTML tombolnya: onclick="simpanSettingNomor()")
        const btn = document.querySelector('button[onclick="simpanSettingNomor()"]');
        const originalText = btn.innerHTML; // Simpan teks/icon asli

        // Ubah tombol jadi mode loading
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          // Kembalikan tombol ke semula
          btn.innerHTML = originalText;
          btn.disabled = false;

          if(res.status === 'success') {
            Swal.fire({
              icon: 'success', 
              title: 'Tersimpan',
              text: 'Pengaturan nomor otomatis berhasil disimpan!',
              timer: 1500,
              showConfirmButton: false
            });
            globalAutoSettings = settings; // Update cache global
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanSettingNomor(token, settings);
      }

      // Helper: Refresh Cache diam-diam saat buka tab list
      function refreshAutoSettingsCache() {
        const token = localStorage.getItem('userToken');
        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res){
          if(res.status === 'success' && res.data) globalAutoSettings = res.data;
        }).getSettingNomor(token);
      }

      /* --- FUNGSI NAVIGASI MOBILE --- */
      function toggleSidebar() {
        // Hanya jalankan jika di layar mobile (lebar < 768px)
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById('sidebarMenu');
          const overlay = document.getElementById('sidebarOverlay');
          
          // Toggle class 'show'
          sidebar.classList.toggle('show');
          overlay.classList.toggle('show');
        }
      }

      // Opsional: Perbaiki navigasiKe agar menutup sidebar di mobile
      // Update sedikit fungsi navigasiKe Anda:
      const originalNavigasiKe = navigasiKe; // Simpan fungsi lama
      navigasiKe = function(panelId, linkElement) {
          originalNavigasiKe(panelId, linkElement); // Jalankan logika lama
          
          // Logika tambahan: Tutup sidebar jika di mobile
          if (window.innerWidth < 768) {
              const sidebar = document.getElementById('sidebarMenu');
              const overlay = document.getElementById('sidebarOverlay');
              sidebar.classList.remove('show');
              overlay.classList.remove('show');
          }
      }

      function jalankanMaintenance() {
        const token = localStorage.getItem('userToken');
        
        Swal.fire({
          title: 'Perbaiki Database?',
          text: "Sistem akan mengecek dan menambahkan kolom yang hilang di Spreadsheet.",
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Ya, Jalankan'
        }).then((result) => {
          if (result.isConfirmed) {
            toggleLoading(true);
            
            google.script.run.withFailureHandler(handleServerError)
              .withSuccessHandler(function(res) {
                toggleLoading(false);
                if (res.status === 'success') {
                  // Tampilkan log perubahan agar user tahu apa yang terjadi
                  Swal.fire('Selesai', '<pre class="text-start" style="font-size:0.8rem">' + res.message + '</pre>', 'success');
                } else {
                  Swal.fire({ icon: 'error', title: 'Maintenance Gagal', html: res.message });
                }
              })
              .withFailureHandler(handleServerError) // Pastikan Anda sudah punya handler error ini
              .perbaikiSemuaHeader(token);
          }
        });
      }

      /* --- ERROR HANDLER GLOBAL --- */
      function handleServerError(err) {
        // Pastikan fungsi toggleLoading ada, jika tidak, bisa dihapus baris ini
        if (typeof toggleLoading === 'function') {
            toggleLoading(false);
        } else {
            // Fallback jika toggleLoading belum didefinisikan
            document.getElementById('loading').classList.add('hidden');
        }

        console.error("Server Error:", err);
        
        // Tampilkan pesan error ke user menggunakan SweetAlert
        Swal.fire({
          icon: 'error',
          title: 'Terjadi Kesalahan Server',
          text: err.message || 'Gagal menghubungi server Google Apps Script.',
          footer: '<small>Coba refresh halaman atau periksa koneksi internet.</small>',
          confirmButtonColor: '#d33'
        });

        // Reset tombol yang mungkin sedang disabled (loading state)
        const btns = document.querySelectorAll('button:disabled');
        btns.forEach(btn => {
          btn.disabled = false;
          // Kembalikan teks tombol jika sebelumnya ada spinner
          if(btn.innerHTML.includes('spinner-border')) {
            btn.innerHTML = '<i class="fas fa-redo"></i> Coba Lagi'; 
          }
        });
      }

      /* --- HELPER: SANITASI DATA (FIX TANDA KUTIP) --- */

      // 1. Untuk Tampilan di Tabel (Mencegah HTML Injection)
      function escapeHtml(text) {
        if (!text) return "";
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // 2. Untuk Parameter Tombol Edit (Mencegah JS Error)
      // Mengubah ' menjadi \' agar aman masuk ke fungsi onclick="edit('...')"
      // --- KODE BARU (PERBAIKAN) ---
      function escapeJsAttribute(text) {
        if (!text) return "";
        return String(text)
          .replace(/\\/g, "\\\\")       // 1. Escape backslash
          .replace(/\r?\n/g, "\\n")     // 2. Escape Enter/Newline (INI PERBAIKANNYA)
          .replace(/'/g, "\\'")         // 3. Escape kutip satu
          .replace(/"/g, "&quot;");     // 4. Escape kutip dua
      }

      /* --- TAMBAHKAN FUNGSI BARU INI DI BAWAH --- */

      // 1. Load Data ID Template dari Server
      // --- LOAD TEMPLATE SETTINGS (WITH CACHE) ---
      function loadTemplateSettings(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        const ids = ['tplIdToko', 'tplIdGuru', 'tplIdTukang'];
        
        // 1. CEK CACHE
        if (!forceRefresh && DATA_CACHE.template_settings) {
          const d = DATA_CACHE.template_settings;
          document.getElementById('tplIdToko').value = d.toko || '';
          document.getElementById('tplIdGuru').value = d.guru || '';
          document.getElementById('tplIdTukang').value = d.tukang || '';
          return;
        }

        // 2. FETCH SERVER
        ids.forEach(id => document.getElementById(id).placeholder = "Memuat...");

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          if (res.status === 'success') {
            const d = res.data;
            
            // Simpan ke Cache
            DATA_CACHE.template_settings = d;

            document.getElementById('tplIdToko').value = d.toko || '';
            document.getElementById('tplIdGuru').value = d.guru || '';
            document.getElementById('tplIdTukang').value = d.tukang || '';
            
            ids.forEach(id => document.getElementById(id).placeholder = "Contoh: 1Fl8Jaf4j6XI...");
          }
        }).getTemplateSettings(token);
      }

      // 2. Simpan Data Template
      // --- SIMPAN TEMPLATE (INVALIDATE CACHE) ---
      function simpanTemplate(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const payload = {
          toko: document.getElementById('tplIdToko').value.trim(),
          guru: document.getElementById('tplIdGuru').value.trim(),
          tukang: document.getElementById('tplIdTukang').value.trim()
        };

        const btn = document.getElementById('btnSimpanTemplate');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          
          if (res.status === 'success') {
            // --- UPDATE: INVALIDATE CACHE ---
            DATA_CACHE.template_settings = null;
            loadTemplateSettings(true); // Reload untuk memastikan data tersimpan
            // --------------------------------

            Swal.fire('Sukses', 'Pengaturan template berhasil disimpan!', 'success');
          } else {
            Swal.fire({ icon: 'error', title: 'Gagal Menyimpan', html: res.message });
          }
        }).simpanTemplateSettings(token, payload);
      }

      function loadMasterReferensi() {
        // Cek jika cache sudah ada isinya
        if (cacheRefUraian.length > 0) return;

        const token = localStorage.getItem('userToken');
        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // --- PERBAIKAN DISINI: Simpan ke cacheRefUraian ---
            cacheRefUraian = res.data;
            console.log("Referensi Master Loaded: " + cacheRefUraian.length + " items");
          }
        }).getReferensiUraianMaster(token);
      }

      /* --- UPDATE: LOGIKA PENCARIAN URAIAN BERDASARKAN KODE (SORTED) --- */
      function handleInputUraian(el) {
        const keyword = el.value.toLowerCase();
        const listEl = document.getElementById('listSaranUraian');
        
        // 1. Validasi: Minimal 2 karakter (termasuk titik) baru mencari
        if (keyword.length < 2) {
          listEl.style.display = 'none';
          return;
        }

        // 2. PERSIAPAN DATA
        // Data Riwayat Inputan User (biasanya belum punya kode, kita kasih string kosong)
        const userHistoryObjs = cacheUserUraian.map(u => ({ uraian: u, kode: '' }));
        
        // Gabungkan Data Master (ada kode) + Riwayat (tanpa kode)
        const rawCombined = [...cacheRefUraian, ...userHistoryObjs];

        // Hapus Duplikat
        const uniqueMap = new Map();
        rawCombined.forEach(item => {
          // Gunakan kombinasi uraian+kode sebagai key unik agar lebih presisi
          const key = item.uraian + "_" + item.kode;
          if(!uniqueMap.has(key)){
            uniqueMap.set(key, item);
          }
        });
        const uniqueSource = Array.from(uniqueMap.values());

        // Deteksi apakah user sedang mengetik pola Kode (diawali angka)
        const isCodeSearch = /^[0-9]/.test(keyword);

        // 3. FILTER
        let matches = uniqueSource.filter(item => {
          const u = String(item.uraian).toLowerCase();
          const k = String(item.kode).toLowerCase();

          if (isCodeSearch) {
            // JIKA KODE: Prioritaskan yang kodenya DIAWALI keyword user
            // Contoh: ketik "2." -> ambil "2.1", "2.2", tapi abaikan "1.2.1"
            if (k.startsWith(keyword)) return true;
            
            // Tetap ambil jika uraian mengandung angka tersebut (opsional)
            return u.includes(keyword) || k.includes(keyword);
          } else {
            // JIKA TEKS BIASA: Cari di uraian atau kode
            return u.includes(keyword) || k.includes(keyword);
          }
        });

        // 4. SORTING CERDAS (LOGIKA UTAMA DISINI)
        matches.sort((a, b) => {
          const codeA = String(a.kode).toLowerCase();
          const codeB = String(b.kode).toLowerCase();
          
          // Prioritas A: Persis Sama
          if (codeA === keyword && codeB !== keyword) return -1;
          if (codeB === keyword && codeA !== keyword) return 1;

          // Prioritas B: Diawali dengan Kode (Hierarchy)
          const startA = codeA.startsWith(keyword);
          const startB = codeB.startsWith(keyword);

          // Jika A diawali keyword (misal 2.1) dan B tidak (misal uraiannya ada angka 2.1 tapi kodenya beda)
          if (startA && !startB) return -1;
          if (!startA && startB) return 1;

          // Prioritas C: Jika keduanya kode, Urutkan Secara Natural (Numeric Sort)
          // Ini agar urutannya: 2.1, 2.2 ... 2.9, 2.10 (bukan 2.1, 2.10, 2.2)
          if (startA && startB) {
            return codeA.localeCompare(codeB, undefined, { numeric: true, sensitivity: 'base' });
          }

          // Fallback: Urutkan berdasarkan panjang teks uraian (yang pendek lebih relevan)
          return a.uraian.length - b.uraian.length;
        });

        // 5. RENDER TAMPILAN
        if (matches.length > 0) {
          let html = '';
          // Limit hasil agar tidak terlalu panjang
          const limit = matches.length > 30 ? 30 : matches.length;
          
          for(let i=0; i<limit; i++) {
            const item = matches[i];
            const valSafe = escapeJsAttribute(item.uraian); 
            
            let badgeHtml = '';
            if(item.kode && item.kode !== "") {
              // Tampilkan Kode dengan font monospace agar rapi
              badgeHtml = `<span class="badge bg-primary me-2 font-monospace" style="min-width:60px;">${item.kode}</span>`;
            } else {
              badgeHtml = `<i class="fas fa-history text-secondary me-3 opacity-50"></i>`;
            }
            
            html += `
              <div class="suggestion-item border-bottom py-2 px-2" style="cursor:pointer;" onclick="pilihSaranUraian('${valSafe}')">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    ${badgeHtml}
                  </div>
                  <div class="flex-grow-1 text-wrap" style="line-height: 1.3; font-size:0.9rem;">
                    ${item.uraian}
                  </div>
                </div>
              </div>`;
          }
          
          listEl.innerHTML = html;
          listEl.style.display = 'block';
          
        } else {
          listEl.innerHTML = '<div class="p-2 text-muted fst-italic small">Data tidak ditemukan.</div>';
          listEl.style.display = 'block';
        }
      }

      function pilihSaranUraian(text) {
        const input = document.getElementById('urNama');
        input.value = text;
        
        // Sembunyikan list setelah memilih
        document.getElementById('listSaranUraian').style.display = 'none';
      }

      // 1. Fungsi Handler saat mengetik atau klik input Satuan
      function handleInputSatuan(el) {
        const keyword = el.value.toLowerCase();
        
        // 1. Simpan referensi input ini ke variabel global agar nanti bisa diisi
        activeSatuanInput = el;

        // 2. Ambil elemen Global List
        const listEl = document.getElementById('global-satuan-list');

        // 3. Ambil data referensi
        let sourceData = cacheSatuan; 
        if (sourceData.length === 0 && cacheDataSatuanLengkap.length > 0) {
            sourceData = cacheDataSatuanLengkap.map(i => i.nama);
        }
        
        // 4. Filter data
        let matches = [];
        if (keyword === "") {
          matches = sourceData; 
        } else {
          matches = sourceData.filter(item => 
            String(item).toLowerCase().includes(keyword)
          );
        }

        // 5. Render Hasil & Posisikan
        if (matches.length > 0) {
          let html = '';
          const limit = matches.length > 50 ? 50 : matches.length;
          
          for(let i=0; i<limit; i++) {
            const valSafe = String(matches[i]).replace(/'/g, "\\'"); 
            // Perhatikan: onclick sekarang memanggil fungsi pilihSatuanGlobal
            html += `<div class="suggestion-item" onclick="pilihSatuanGlobal('${valSafe}')">
                      ${matches[i]}
                    </div>`;
          }
          
          listEl.innerHTML = html;
          
          // --- TEKNIK POSISI MANUAL (PORTAL) ---
          // Hitung posisi input saat ini di layar
          const rect = el.getBoundingClientRect();
          
          // Posisikan list global tepat di bawah input
          // Ditambah window.scrollY agar posisi tetap benar meski halaman discroll ke bawah
          listEl.style.top = (rect.bottom + window.scrollY) + 'px'; 
          listEl.style.left = (rect.left + window.scrollX) + 'px';
          listEl.style.width = rect.width + 'px'; // Samakan lebarnya dengan input
          listEl.style.display = 'block';

        } else {
          listEl.style.display = 'none';
        }
      }

      // Fungsi untuk memosisikan ulang list agar selalu menempel pada input
      function updateGlobalListPosition() {
        const listEl = document.getElementById('global-satuan-list');
        
        // Hanya jalankan jika list sedang tampil dan ada input yang aktif
        if (listEl && listEl.style.display === 'block' && activeSatuanInput) {
          const rect = activeSatuanInput.getBoundingClientRect();
          
          // Update posisi berdasarkan koordinat input saat ini
          listEl.style.top = (rect.bottom + window.scrollY) + 'px'; 
          listEl.style.left = (rect.left + window.scrollX) + 'px';
          listEl.style.width = rect.width + 'px';
        }
      }

      // Listener Scroll: Update posisi list (JANGAN DITUTUP)
      document.addEventListener('scroll', function(e) {
        // 1. Jika yang discroll adalah list saran itu sendiri, biarkan saja
        const listEl = document.getElementById('global-satuan-list');
        if (e.target === listEl) return;
        
        // 2. Jika yang discroll adalah halaman/tabel, IKUTI pergerakan inputnya
        updateGlobalListPosition();
      }, true); // Capture phase

      // Listener Resize: Update posisi jika layar diubah ukurannya
      window.addEventListener('resize', function() {
        updateGlobalListPosition();
      });

      // Tutup list jika klik di luar
      // Listener Global untuk Klik (Menutup Dropdown saat klik di luar)
      document.addEventListener('click', function(e) {
        
        // --- BAGIAN 1: MENANGANI LIST LOKAL (URAIAN & BARANG) ---
        // (Kode lama Anda: Menangani list yang ada di dalam .autocomplete-wrapper)
        const allWrappers = document.querySelectorAll('.autocomplete-wrapper');
        
        allWrappers.forEach(wrapper => {
            const listEl = wrapper.querySelector('.suggestion-list');
            
            // Cek jika list sedang tampil DAN klik terjadi di luar wrapper pembungkusnya
            if (listEl && listEl.style.display === 'block' && !wrapper.contains(e.target)) {
                listEl.style.display = 'none';
            }
        });

        // --- BAGIAN 2: MENANGANI LIST GLOBAL (SATUAN) ---
        // (Kode baru: Menangani list yang menempel di Body)
        const globalList = document.getElementById('global-satuan-list');
          if (globalList && globalList.style.display === 'block') {
              // Tutup HANYA jika klik terjadi di luar List DAN di luar Input
              if (!globalList.contains(e.target) && e.target !== activeSatuanInput) {
                  globalList.style.display = 'none';
              }
          }
      });

      function pilihSatuanGlobal(text) {
        if (activeSatuanInput) {
          activeSatuanInput.value = text;
          // Trigger event input (penting untuk perhitungan otomatis jika ada)
          activeSatuanInput.dispatchEvent(new Event('input'));
        }
        
        // Sembunyikan list global
        document.getElementById('global-satuan-list').style.display = 'none';
      }
      
      /* --- LOGIKA PENCARIAN REFERENSI BARANG (UPDATED: RICH UI & SMART SORTING) --- */
      
      let timeoutCariBarang = null;

      function handleCariBarang(inputEl, tipe) {
        const keyword = inputEl.value.toLowerCase();
        const listId = (tipe === 'toko') ? 'saran-barang-toko' : 'saran-barang-tukang';
        const listEl = document.getElementById(listId);

        // 1. Reset Tampilan
        listEl.style.display = 'none';
        listEl.innerHTML = '';

        // 2. Validasi Minimal Karakter
        if (keyword.length < 3) return;

        clearTimeout(timeoutCariBarang);

        // --- SKENARIO A: DATA SUDAH ADA DI CACHE (INSTANT SEARCH) ---
        if (cacheDataBarangLengkap && cacheDataBarangLengkap.length > 0) {
            
            timeoutCariBarang = setTimeout(() => {
                // A. Filter Data
                let matches = cacheDataBarangLengkap.filter(item => {
                    const nama = item.nama ? item.nama.toLowerCase() : '';
                    const kat = item.katNama ? item.katNama.toLowerCase() : '';
                    const kode = item.katKode ? item.katKode.toLowerCase() : '';
                    
                    return nama.includes(keyword) || kat.includes(keyword) || kode.includes(keyword);
                });

                // B. Sorting Cerdas (Agar urutan sama dengan Server/Logic Manusia)
                matches.sort((a, b) => {
                    const nameA = String(a.nama).toLowerCase();
                    const nameB = String(b.nama).toLowerCase();
                    
                    // Prioritas 1: Persis Sama
                    if (nameA === keyword && nameB !== keyword) return -1;
                    if (nameB === keyword && nameA !== keyword) return 1;
                    
                    // Prioritas 2: Diawali dengan Keyword (Starts With)
                    const startA = nameA.startsWith(keyword);
                    const startB = nameB.startsWith(keyword);
                    if (startA && !startB) return -1;
                    if (!startA && startB) return 1;
                    
                    // Prioritas 3: Abjad
                    return nameA.length - nameB.length; 
                });

                // Tampilkan Hasil (Limit 30 item)
                renderHasilPencarianBarang(matches.slice(0, 30), tipe, listEl);
            }, 200);

            return; 
        }

        // --- SKENARIO B: CACHE KOSONG -> CARI KE SERVER (FALLBACK) ---
        timeoutCariBarang = setTimeout(() => {
           const wrapper = inputEl.closest('.input-group');
           const icon = wrapper ? wrapper.querySelector('i') : null;
           const originalIconClass = 'fas fa-search'; 

           if(icon) icon.className = 'fas fa-spinner fa-spin text-primary';

           const token = localStorage.getItem('userToken');
           
           google.script.run.withSuccessHandler(function(res) {
             if(icon) icon.className = originalIconClass;

             if (res.status === 'success') {
                renderHasilPencarianBarang(res.data, tipe, listEl);
             } else {
                renderHasilPencarianBarang([], tipe, listEl);
             }
           }).cariBarangReferensi(token, keyword);

        }, 400); 
      }

      // --- HELPER BARU: RENDER HASIL PENCARIAN (TAMPILAN INFORMATIF / RICH UI) ---
      function renderHasilPencarianBarang(data, tipe, listEl) {
         if (data && data.length > 0) {
            let html = '';
            
            data.forEach(item => {
              const namaSafe = escapeJsAttribute(item.nama);
              const satSafe  = escapeJsAttribute(item.satuan);
              const harga    = item.harga || 0;
              
              // --- LOGIKA UI BADGE & KATEGORI ---
              // Menyiapkan tampilan Kategori (ikon tag) dan Satuan (badge)
              const katHtml = item.katNama 
                ? `<div class="text-muted small mt-1" style="font-size: 0.75rem;"><i class="fas fa-tag me-1 text-secondary opacity-50"></i>${item.katNama}</div>` 
                : '';
                
              html += `
                <div class="suggestion-item border-bottom py-2 px-3" 
                    style="cursor:pointer; transition: all 0.2s;"
                    onclick="pilihReferensiBarang('${namaSafe}', '${satSafe}', ${harga}, '${tipe}', this)">
                  
                  <div class="d-flex justify-content-between align-items-start">
                    
                    <div style="overflow:hidden; padding-right: 10px;">
                        <div class="fw-normal text-dark text-wrap" style="line-height: 1.2;">
                          ${item.nama}
                        </div>
                        ${katHtml}
                    </div>

                    <div class="text-end flex-shrink-0">
                        <div class="fw-bold text-success" style="font-size: 0.9rem;">
                          ${formatRupiahJS(harga)}
                        </div>
                        <div class="mt-1">
                          <span class="badge bg-light text-secondary border rounded-pill fw-normal" style="font-size: 0.7rem;">
                            ${item.satuan || '-'}
                          </span>
                        </div>
                    </div>

                  </div>
                </div>
              `;
            });
            
            listEl.innerHTML = html;
            listEl.style.display = 'block';
         } else {
            listEl.innerHTML = '<div class="p-3 text-muted fst-italic text-center small"><i class="fas fa-search me-1"></i> Data tidak ditemukan.</div>';
            listEl.style.display = 'block';
         }
      }

      // --- UPDATE FUNGSI PILIH DARI PENCARIAN REFERENSI (AUTOCOMPLETE) ---
      function pilihReferensiBarang(nama, satuan, harga, tipe, itemEl) {
        
        // 1. Tentukan Tabel Target
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 'tabelItemTukang';
        const tbody = document.getElementById(tableId).querySelector('tbody');
        
        // Ambil daftar baris saat ini
        let rows = tbody.querySelectorAll('tr');
        let targetRow = null;

        // 2. LOGIKA CEK BARIS (Mencegah Overwrite Data)
        if (rows.length > 0) {
          const lastRow = rows[rows.length - 1];
          const inputNama = lastRow.querySelector('.item-nama');
          
          // Cek apakah baris terakhir namanya MASIH KOSONG?
          // Jika kosong, kita pakai baris ini.
          if (inputNama && inputNama.value.trim() === '') {
            targetRow = lastRow;
          }
        }

        // 3. Jika tidak ada baris yang bisa dipakai (Tabel kosong ATAU Baris terakhir sudah penuh)
        // Maka Buat Baris Baru
        if (!targetRow) {
          tambahBaris(tipe); 
          // Update daftar rows dan ambil yang baru saja dibuat
          rows = tbody.querySelectorAll('tr');
          targetRow = rows[rows.length - 1];
        }

        // 4. Isi Data ke Input
        if (targetRow) {
          const inputNama = targetRow.querySelector('.item-nama');
          const inputSat = targetRow.querySelector('.item-sat');
          const inputHarga = targetRow.querySelector('.item-harga');

          if (inputNama) inputNama.value = unescapeHtml(nama);
          if (inputSat) inputSat.value = unescapeHtml(satuan);
          
          // Isi Harga & Hitung Otomatis
          if (inputHarga) {
            inputHarga.value = formatRibuanInput(harga); 
            hitungBaris(inputHarga, tipe); 
          }
          
          // Efek visual (Highlight Kuning sesaat)
          targetRow.classList.add('table-warning');
          setTimeout(() => targetRow.classList.remove('table-warning'), 500);
        }

        // 5. Bersihkan Tampilan Pencarian & Reset Fokus
        const wrapper = itemEl.closest('.autocomplete-wrapper');
        if (wrapper) {
          const list = wrapper.querySelector('.suggestion-list');
          const inputCari = wrapper.querySelector('input');
          
          if(list) list.style.display = 'none'; // Tutup saran
          
          if(inputCari) {
              inputCari.value = ''; // Kosongkan kotak pencarian
              inputCari.focus();    // Kembalikan kursor ke kotak pencarian agar bisa cari lagi
          }
        }
      }

      // Helper untuk decode string (jika diperlukan saat insert value)
      function unescapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'")
            .replace(/\\\\/g, "\\"); // Fix escape slash
      }

      /* --- LOGIKA INFO SATUAN (NEW) --- */
      let cacheDataSatuanLengkap = [];

      function bukaModalSatuan() {
        const modal = new bootstrap.Modal(document.getElementById('modalInfoSatuan'));
        modal.show();

        // Reset pencarian
        document.getElementById('cariSatuanInput').value = '';

        // Cek cache, jika kosong load dari server
        if (cacheDataSatuanLengkap.length === 0) {
          loadInfoSatuanFromServer();
        } else {
          renderTabelSatuan(cacheDataSatuanLengkap);
        }
      }

      function loadInfoSatuanFromServer() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('bodyInfoSatuan');
        
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="spinner-border text-info" role="status"></div><br>Sedang mengambil data...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            cacheDataSatuanLengkap = res.data;

            // --- PASTIKAN BARIS INI ADA ---
            saveCacheToLocal(); 
            // ------------------------------

            renderTabelSatuan(cacheDataSatuanLengkap);
          } else {
            tbody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Gagal: ${res.message}</td></tr>`;
          }
        }).getReferensiSatuanLengkap(token);
      }

      function renderTabelSatuan(data) {
        const tbody = document.getElementById('bodyInfoSatuan');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Belum ada data satuan.</td></tr>';
          return;
        }

        data.forEach(item => {
          // Logika warna badge kategori
          let badgeClass = 'bg-secondary';
          const kat = item.kategori.toLowerCase();
          if (kat.includes('berat') || kat.includes('kilo')) badgeClass = 'bg-primary';
          else if (kat.includes('panjang') || kat.includes('meter')) badgeClass = 'bg-success';
          else if (kat.includes('volume') || kat.includes('liter')) badgeClass = 'bg-info text-dark';
          else if (kat.includes('buah') || kat.includes('pcs') || kat.includes('unit')) badgeClass = 'bg-warning text-dark';

          const row = `
            <tr>
              <td class="fw-bold text-dark font-monospace" style="font-size: 1.1em;">${item.nama}</td>
              <td><span class="badge ${badgeClass} fw-normal px-3 py-2 rounded-pill">${item.kategori}</span></td>
              <td class="text-muted small">${item.contoh}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      function filterInfoSatuan() {
        const keyword = document.getElementById('cariSatuanInput').value.toLowerCase();
        const tbody = document.getElementById('bodyInfoSatuan');
        const rows = tbody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
          const nama = rows[i].cells[0]?.textContent.toLowerCase() || '';
          const kategori = rows[i].cells[1]?.textContent.toLowerCase() || '';
          const contoh = rows[i].cells[2]?.textContent.toLowerCase() || '';

          if (nama.includes(keyword) || kategori.includes(keyword) || contoh.includes(keyword)) {
            rows[i].style.display = "";
          } else {
            rows[i].style.display = "none";
          }
        }
      }

      // 1. Toggle Tampilan Input
      function toggleResetMethod(method) {
        const grpCode = document.getElementById('input-group-code');
        const grpQna = document.getElementById('input-group-qna');
        const inputCode = document.getElementById('resetCode');
        const inputAnswer = document.getElementById('resetAnswer');

        if (method === 'code') {
          grpCode.classList.remove('hidden');
          grpQna.classList.add('hidden');
          inputCode.required = true;
          inputAnswer.required = false;
        } else {
          grpCode.classList.add('hidden');
          grpQna.classList.remove('hidden');
          inputCode.required = false;
          inputAnswer.required = true;
        }
      }

      // 2. Handle Submit Reset (Modifikasi)
      function handleResetPassword(e) {
        e.preventDefault();
        
        // 1. Ambil Input Password & Email
        const p1 = document.getElementById('resetPassNew').value;
        const p2 = document.getElementById('resetPassConf').value;
        const email = document.getElementById('resetEmail').value;

        // 2. Validasi: Password Baru harus sama
        if(p1 !== p2) {
          Swal.fire('Password Tidak Cocok', 'Konfirmasi password baru tidak sama.', 'warning');
          return;
        }

        // 3. Tampilkan Loading
        toggleLoading(true);

        // 4. Cek Metode Mana yang Sedang Aktif (Radio Button)
        const isMethodCode = document.getElementById('methodCode').checked;

        if (isMethodCode) {
          // ============================================
          // OPSI A: Reset Menggunakan KODE PEMULIHAN
          // ============================================
          const form = {
            email: email,
            code: document.getElementById('resetCode').value, // Ambil Kode
            newPassword: p1
          };

          // Panggil fungsi server lama
          google.script.run
            .withFailureHandler(handleServerError)
            .withSuccessHandler(resetCallback) // Gunakan callback helper
            .resetPasswordWithCode(form);

        } else {
          // ============================================
          // OPSI B: Reset Menggunakan PERTANYAAN KEAMANAN (UPDATE)
          // ============================================
          
          // Ambil Value dari Dropdown Pertanyaan & Input Jawaban
          const questionVal = document.getElementById('resetQuestion').value;
          const answerVal = document.getElementById('resetAnswer').value;

          // Validasi: User wajib memilih pertanyaan dari dropdown
          if (!questionVal || questionVal === "") {
            toggleLoading(false);
            Swal.fire('Peringatan', 'Harap pilih Pertanyaan Keamanan terlebih dahulu.', 'warning');
            return;
          }

          const form = {
            email: email,
            question: questionVal, // Kirim ID Pertanyaan (misal: 'ibu', 'hewan')
            answer: answerVal,     // Kirim Jawaban User
            newPassword: p1
          };

          // Panggil fungsi server baru
          google.script.run
            .withFailureHandler(handleServerError)
            .withSuccessHandler(resetCallback) // Gunakan callback helper
            .resetPasswordByQuestion(form);
        }
      }

      // --- FUNGSI HELPER CALLBACK (Agar kode lebih rapi) ---
      function resetCallback(res) {
        toggleLoading(false); // Matikan loading
        
        if(res.status === 'success') {
          // Jika Berhasil: Reset Form & Kembali ke Login
          document.getElementById('formReset').reset();
          
          // Kembalikan tampilan ke default (Mode Kode)
          if(typeof toggleResetMethod === 'function') {
              toggleResetMethod('code'); 
              document.getElementById('methodCode').checked = true;
          }
          
          Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: res.message,
            confirmButtonText: 'Login Sekarang'
          }).then(() => {
            switchView('view-login');
          });

        } else {
          // Jika Gagal: Tampilkan Pesan Error
          Swal.fire({
            icon: 'error',
            title: 'Gagal',
            text: res.message
          });
        }
      }

      /* --- LOGIKA RESET PASSWORD BARU (OTP) --- */

      // 1. Handle Kirim OTP (Step 1)
      function handleSendOtp(e) {
        e.preventDefault();
        
        const email = document.getElementById('resetEmailInput').value;
        const btn = document.getElementById('btnSendOtp');
        
        // Loading State
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengecek...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (res.status === 'success') {
            // Jika Sukses: Sembunyikan Step 1, Tampilkan Step 2
            document.getElementById('formStep1').classList.add('hidden');
            document.getElementById('formStep2').classList.remove('hidden');
            
            // Kunci input email agar tidak diubah user saat input OTP
            document.getElementById('resetEmailInput').disabled = true; 
            
            Swal.fire({
              icon: 'success',
              title: 'Kode Terkirim',
              text: 'Silakan cek email Anda (Inbox/Spam) untuk mendapatkan kode OTP.',
              timer: 3000
            });

          } else {
            // Error (Email tidak ada atau Limit harian habis)
            Swal.fire({
              icon: 'error',
              title: 'Gagal',
              html: res.message // Menggunakan HTML agar bold/br terbaca
            });
          }
        }).requestResetOtp(email);
      }

      // 2. Handle Konfirmasi Ganti Password (Step 2)
      function handleConfirmReset(e) {
        e.preventDefault();

        const p1 = document.getElementById('resetPassNew').value;
        const p2 = document.getElementById('resetPassConf').value;

        // --- VALIDASI BARU: PANJANG PASSWORD ---
        if (p1.length < 6) {
          Swal.fire('Password Terlalu Pendek', 'Password baru minimal harus 6 karakter.', 'warning');
          return;
        }

        // Validasi Kecocokan
        if (p1 !== p2) {
          Swal.fire('Password Tidak Cocok', 'Konfirmasi password baru tidak sama.', 'warning');
          return;
        }

        const formData = {
          email: document.getElementById('resetEmailInput').value,
          otp: document.getElementById('resetOtpInput').value,
          newPassword: p1
        };

        const btn = document.getElementById('btnConfirmReset');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memverifikasi...';
        btn.disabled = true;

        google.script.run.withFailureHandler(handleServerError).withSuccessHandler(function(res) {
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (res.status === 'success') {
            Swal.fire({
              icon: 'success',
              title: 'Password Berhasil Diubah!',
              text: 'Silakan login menggunakan password baru Anda.',
              confirmButtonText: 'Login Sekarang'
            }).then(() => {
              resetViewReset(); 
              switchView('view-login');
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Gagal',
              text: res.message
            });
          }
        }).confirmResetOtp(formData);
      }

      // 3. Helper Reset Tampilan View Reset
      function resetViewReset() {
        document.getElementById('formStep1').reset();
        document.getElementById('formStep2').reset();
        
        document.getElementById('formStep1').classList.remove('hidden');
        document.getElementById('formStep2').classList.add('hidden');
        
        document.getElementById('resetEmailInput').disabled = false;
        switchView('view-login');
      }

      // --- [BARU] Fungsi Loncat ke Input OTP Manual ---
      function manualInputOtp() {
        const emailInput = document.getElementById('resetEmailInput');
        const emailVal = emailInput.value.trim();

        // 1. Validasi: User harus mengetik email dulu di Step 1
        // Karena saat verifikasi nanti, sistem butuh pasangan (Email + OTP)
        if (!emailVal) {
          Swal.fire({
            icon: 'warning',
            title: 'Email Diperlukan',
            text: 'Mohon ketik alamat Email Sekolah terlebih dahulu di kolom atas, lalu klik tombol ini lagi.',
            timer: 4000
          });
          emailInput.focus();
          return;
        }

        // 2. Jika email sudah diisi, kunci email dan pindah ke Step 2
        emailInput.disabled = true;
        
        document.getElementById('formStep1').classList.add('hidden');
        document.getElementById('formStep2').classList.remove('hidden');
        
        // Fokus ke input OTP
        document.getElementById('resetOtpInput').focus();
      }

      /* --- FUNGSI TOGGLE PASSWORD (MATA) --- */
      function togglePassword(inputId, iconSpan) {
        const input = document.getElementById(inputId);
        const icon = iconSpan.querySelector('i');
        
        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash'); // Ganti ikon jadi mata dicoret
        } else {
          input.type = "password";
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye'); // Kembali ke mata biasa
        }
      }

      // --- LOGIKA UBAH PASSWORD ---
      function submitUbahPassword(e) {
        e.preventDefault();

        const oldPass = document.getElementById('upOldPass').value;
        const newPass = document.getElementById('upNewPass').value;
        const confPass = document.getElementById('upConfPass').value;
        const email = localStorage.getItem('userEmail'); // Ambil email dari sesi login

        // 1. Validasi Kecocokan Password Baru
        if (newPass !== confPass) {
          Swal.fire('Password Tidak Cocok', 'Password baru dan konfirmasi harus sama.', 'warning');
          return;
        }

        // 2. Validasi Password Baru tidak boleh sama dengan Password Lama (Opsional tapi baik)
        if (oldPass === newPass) {
          Swal.fire('Password Sama', 'Password baru tidak boleh sama dengan password lama.', 'warning');
          return;
        }

        // 3. Proses Kirim ke Server
        const btn = document.getElementById('btnSubmitPass');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memproses...';
        btn.disabled = true;

        const formData = {
          email: email,
          oldPass: oldPass,
          newPass: newPass
        };

        google.script.run
          .withFailureHandler(handleServerError)
          .withSuccessHandler(function(res) {
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (res.status === 'success') {
              // Reset Form
              document.getElementById('formUbahPass').reset();
              
              Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: 'Password Anda telah diperbarui.',
                showConfirmButton: true
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Gagal',
                text: res.message
              });
            }
          })
          .changeUserPassword(formData);
      }

      document.getElementById('currentYear').innerText = new Date().getFullYear();

      // FIX: Mencegah loncat otomatis saat input di-tap di mobile
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', function(e) {
          // Mencegah browser melakukan scroll drastis
          // Biarkan keyboard muncul natural
          setTimeout(() => {
            // Opsional: Cek jika elemen tertutup keyboard baru scroll sedikit
          }, 300);
        }, { passive: true });
      });

      // FIX: Reset posisi scroll saat modal ditutup agar tidak loncat ke atas/bawah
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function () {
          // Kunci posisi body agar tidak loncat
          document.body.style.overflow = ''; 
        });
      });

      /* --- LOGIKA INFO REFERENSI URAIAN LENGKAP --- */

      function bukaModalReferensi() {
        const modal = new bootstrap.Modal(document.getElementById('modalReferensiUraian'));
        modal.show();

        // Reset Filter
        document.getElementById('refSearchInput').value = '';
        
        // Cek apakah data sudah ada di cacheRefUraian?
        // Karena cacheRefUraian di update sebelumnya sudah kita ubah strukturnya di Kode.gs,
        // kita perlu memuat ulang jika formatnya belum sesuai atau kosong.
        if (cacheRefLengkap.length === 0) {
          loadReferensiLengkapServer();
        } else {
          populasiFilterStandar(cacheRefLengkap);
          renderTabelRef(cacheRefLengkap);
        }
      }

      function loadReferensiLengkapServer() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('bodyTabelReferensi');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-info"></div><br>Mengambil Data Referensi...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            cacheRefLengkap = res.data;
            
            // Update juga cacheRefUraian global agar autocomplete di form input tetap jalan
            cacheRefUraian = res.data; 

            // --- TAMBAHAN PENTING: SIMPAN KE STORAGE ---
            saveCacheToLocal(); 
            // -------------------------------------------

            populasiFilterStandar(cacheRefLengkap);
            renderTabelRef(cacheRefLengkap);
          } else {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Gagal: ${res.message}</td></tr>`;
          }
        }).getReferensiUraianMaster(token);
      }

      function populasiFilterStandar(data) {
        const select = document.getElementById('refFilterStandar');
        const currentVal = select.value;
        
        // Ambil Data Unik Standar (Kolom C)
        // Gunakan Set untuk unique value
        const uniqueStandar = [...new Set(data.map(item => item.standar))].filter(s => s !== "").sort();

        let html = '<option value="">-- Semua Standar --</option>';
        uniqueStandar.forEach(s => {
          html += `<option value="${s}">${s}</option>`;
        });
        
        select.innerHTML = html;
        select.value = currentVal; // Restore value jika ada
      }

      function renderTabelRef(data) {
        const tbody = document.getElementById('bodyTabelReferensi');
        document.getElementById('refTotalData').innerText = data.length;
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Data tidak ditemukan.</td></tr>';
          return;
        }

        // Batasi render maksimal 100 baris awal agar browser tidak berat (karena data referensi bisa ribuan)
        // Data tetap bisa dicari via search box
        const limit = data.length > 200 ? 200 : data.length;
        let html = '';

        for(let i=0; i<limit; i++) {
          const item = data[i];
          
          // Escape quote untuk fungsi onclick
          const uraianSafe = String(item.uraian).replace(/"/g, '&quot;').replace(/'/g, "\\'");
          const kodeSafe = String(item.kode).replace(/"/g, '&quot;').replace(/'/g, "\\'");

          html += `
            <tr>
              <td>${item.standar}</td>
              <td>${item.kegiatan}</td>
              <td class="text-center"><span class="badge bg-light text-dark border font-monospace">${item.kode}</span></td>
              <td class="fw-bold text-primary">${item.uraian}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-success" onclick="pilihDariReferensi('${uraianSafe}', '${kodeSafe}')" title="Gunakan Data Ini">
                  <i class="fas fa-plus"></i> Tambah
                </button>
              </td>
            </tr>
          `;
        }

        if (data.length > 200) {
          html += `<tr><td colspan="5" class="text-center text-muted fst-italic bg-light">... Menampilkan 200 data pertama. Gunakan pencarian untuk hasil spesifik ...</td></tr>`;
        }
        
        tbody.innerHTML = html;
      }

      function filterTabelReferensi() {
        const filterStd = document.getElementById('refFilterStandar').value.toLowerCase();
        const keyword = document.getElementById('refSearchInput').value.toLowerCase();
        
        const filtered = cacheRefLengkap.filter(item => {
          const matchStd = (filterStd === "") || item.standar.toLowerCase() === filterStd;
          
          // Cari di semua kolom
          const matchKey = (keyword === "") || 
                          item.uraian.toLowerCase().includes(keyword) || 
                          item.kode.toLowerCase().includes(keyword) || 
                          item.kegiatan.toLowerCase().includes(keyword);

          return matchStd && matchKey;
        });

        renderTabelRef(filtered);
      }

      function pilihDariReferensi(uraian, kode) {
        // 1. Tutup Modal
        const modalEl = document.getElementById('modalReferensiUraian');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if(modalInstance) modalInstance.hide();

        // 2. Isi Form Tambah Uraian
        document.getElementById('urNama').value = uraian;
        // Jika Anda ingin mengisi No Bukti dengan Kode Kegiatan, uncomment baris ini:
        // document.getElementById('urNoBukti').value = kode;

        // 3. Scroll ke Form agar user sadar data sudah masuk
        setTimeout(() => {
          document.getElementById('formUraian').scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Beri efek highlight/fokus
          document.getElementById('urNama').focus();
          Swal.fire({
            toast: true, position: 'top-end', icon: 'success', 
            title: 'Data disalin ke form', showConfirmButton: false, timer: 1500
          });
        }, 300);
      }

      /* --- LOGIKA INFO BARANG DENGAN PAGINASI --- */

      // Variabel Global untuk Paginasi Barang
      let cacheDataBarangLengkap = []; // Menyimpan SEMUA data dari server
      let filteredBarangList = [];     // Menyimpan data hasil pencarian
      let currentPageBarang = 1;       // Halaman saat ini
      const ITEMS_PER_PAGE = 30;       // Batas baris per halaman

      // Cari fungsi ini di Index.html
      function bukaModalBarang() {
        const modal = new bootstrap.Modal(document.getElementById('modalInfoBarang'));
        modal.show();

        document.getElementById('cariBarangInput').value = '';
        
        // Reset Paginasi
        currentPageBarang = 1;
        
        // --- PERBAIKAN DISINI ---
        // Cek apakah cacheDataBarangLengkap sudah terisi (dari LocalStorage saat login)?
        if (cacheDataBarangLengkap.length === 0) {
          // Jika kosong, baru ambil dari server
          loadInfoBarangFromServer();
        } else {
          // Jika sudah ada, gunakan data cache tanpa loading
          console.log("Menggunakan data Barang dari Cache.");
          
          // Penting: Reset filtered list ke data penuh sebelum render
          filteredBarangList = [...cacheDataBarangLengkap];
          
          renderTabelBarang();
        }
      }

      function loadInfoBarangFromServer() {
        const token = localStorage.getItem('userToken');
        const tbody = document.getElementById('bodyInfoBarang');
        const paginasiEl = document.getElementById('paginationContainer');
        
        // Sembunyikan navigasi saat loading
        paginasiEl.classList.add('hidden');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-warning" role="status"></div><br>Mengambil data barang...</td></tr>';

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // 1. Simpan Data Mentah ke Cache
            cacheDataBarangLengkap = res.data;
            
            // 2. Set Data Filtered
            filteredBarangList = [...cacheDataBarangLengkap];

            // --- PASTIKAN BARIS INI ADA ---
            saveCacheToLocal(); 
            // ------------------------------
            
            renderTabelBarang();
            
          } else {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Gagal: ${res.message}</td></tr>`;
          }
        }).getReferensiBarangLengkap(token);
      }

      // --- UPDATE FUNGSI RENDER TABEL BARANG ---
      function renderTabelBarang() {
        const tbody = document.getElementById('bodyInfoBarang');
        const paginasiEl = document.getElementById('paginationContainer');
        
        tbody.innerHTML = '';

        if (filteredBarangList.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Data tidak ditemukan.</td></tr>';
          paginasiEl.classList.add('hidden');
          return;
        }

        // Logika Paginasi
        const totalItems = filteredBarangList.length;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        
        if (currentPageBarang > totalPages) currentPageBarang = 1;
        if (currentPageBarang < 1) currentPageBarang = 1;

        const startIndex = (currentPageBarang - 1) * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);
        const pageData = filteredBarangList.slice(startIndex, endIndex);

        // Render Baris
        pageData.forEach((item, index) => {
          // Generate ID Unik untuk DOM
          // Kita gunakan kombinasi timestamp + index loop agar benar-benar unik
          const uniqueKey = Date.now() + "_" + index; 
          const domId = `row-brg-${uniqueKey}`;

          const safeNama = escapeJsAttribute(item.nama);
          const safeSat = escapeJsAttribute(item.satuan);
          const hargaTampil = formatRupiahJS(item.harga);
          
          // 1. HARGA VIEW (Tampilan Biasa)
          const viewHarga = `
            <div id="view-harga-${domId}" class="d-flex justify-content-between align-items-center">
              <span class="fw-bold text-success text-truncate">${hargaTampil}</span>
              <i class="fas fa-pencil-alt text-muted cursor-pointer ms-2" onclick="enableEditHarga('${domId}', '${safeNama}', ${item.harga})" title="Edit Harga"></i>
            </div>
          `;

          // 2. HARGA EDIT (Input Form)
          // Input dibuat width 100% agar memenuhi kolom yang sudah diperlebar
          const editHarga = `
            <div id="edit-harga-${domId}" class="input-group input-group-sm hidden" style="width: 100%;">
              <input type="text" class="form-control form-control-sm px-1" value="${formatRibuanInput(item.harga)}" id="input-harga-${domId}" style="min-width: 80px;">
              <button class="btn btn-success px-2" onclick="saveEditHarga('${domId}', '${safeNama}')"><i class="fas fa-check"></i></button>
              <button class="btn btn-secondary px-2" onclick="cancelEditHarga('${domId}')"><i class="fas fa-times"></i></button>
            </div>
          `;

          const btnTambah = `
            <button class="btn btn-sm btn-primary w-100" onclick="pilihDariInfoBarang('${safeNama}', '${safeSat}', ${item.harga})">
              <i class="fas fa-plus"></i>
            </button>
          `;

          // --- STRUKTUR KOLOM DENGAN SCROLL ---
          const row = `
            <tr>
              <td class="text-start">
                <div class="cell-scroll" style="width: 100%;">
                  <span class="badge bg-light text-dark border">${item.katKode}</span>
                </div>
              </td>

              <td class="small">${item.katNama}</td>

              <td>
                <div class="cell-scroll fw-bold" style="width: 100%;">
                  ${item.nama}
                </div>
              </td>

              <td class="text-center small">${item.satuan}</td>

              <td>${viewHarga} ${editHarga}</td>

              <td class="text-center">${btnTambah}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });

        // Update Info Paginasi
        paginasiEl.classList.remove('hidden');
        document.getElementById('lblStart').innerText = startIndex + 1;
        document.getElementById('lblEnd').innerText = endIndex;
        document.getElementById('lblTotal').innerText = totalItems;
        document.getElementById('lblPageIndicator').innerText = `Hal ${currentPageBarang} / ${totalPages}`;

        document.getElementById('btnPrevPage').disabled = (currentPageBarang === 1);
        document.getElementById('btnNextPage').disabled = (currentPageBarang === totalPages);
      }

      // Fungsi Ganti Halaman
      function gantiHalaman(direction) {
        currentPageBarang += direction;
        renderTabelBarang(); // Render ulang dengan page baru
        
        // Scroll tabel ke atas sedikit agar nyaman
        document.querySelector('.table-responsive').scrollTop = 0;
      }

      // Fungsi Pencarian (Reset ke Halaman 1)
      function filterInfoBarang() {
        const keyword = document.getElementById('cariBarangInput').value.toLowerCase();
        
        // Filter dari Cache Master
        filteredBarangList = cacheDataBarangLengkap.filter(item => {
            return String(item.nama).toLowerCase().includes(keyword) ||
                  String(item.katNama).toLowerCase().includes(keyword) ||
                  String(item.katKode).toLowerCase().includes(keyword) ||
                  String(item.harga).includes(keyword);
        });

        // Reset ke halaman 1 setiap kali mencari
        currentPageBarang = 1;
        
        renderTabelBarang();
      }

      // --- LOGIKA EDIT HARGA (Disesuaikan dengan DOM ID baru) ---
      function enableEditHarga(domId, nama, hargaAsli) {
        document.getElementById(`view-harga-${domId}`).classList.add('hidden');
        document.getElementById(`edit-harga-${domId}`).classList.remove('hidden');
        
        const input = document.getElementById(`input-harga-${domId}`);
        input.focus();
        input.oninput = function() { this.value = formatRibuanInput(this.value); };
      }

      function cancelEditHarga(domId) {
        document.getElementById(`view-harga-${domId}`).classList.remove('hidden');
        document.getElementById(`edit-harga-${domId}`).classList.add('hidden');
      }

      function saveEditHarga(domId, namaBarang) {
        const token = localStorage.getItem('userToken');
        const inputVal = document.getElementById(`input-harga-${domId}`).value;
        const hargaBaru = cleanRibuan(inputVal);

        // Loading button
        const btn = document.querySelector(`#edit-harga-${domId} .btn-success`);
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        google.script.run.withSuccessHandler(function(res) {
          if (res.status === 'success') {
            // 1. Update di Cache Master (Memory)
            const itemMaster = cacheDataBarangLengkap.find(x => x.nama === namaBarang);
            if(itemMaster) itemMaster.harga = hargaBaru;

            // 2. Update di Filtered List
            const itemFiltered = filteredBarangList.find(x => x.nama === namaBarang);
            if(itemFiltered) itemFiltered.harga = hargaBaru;

            // --- TAMBAHAN BARU: Update Cache LocalStorage ---
            // Karena cacheDataBarangLengkap di memory sudah diupdate di langkah 1,
            // kita tinggal panggil saveCacheToLocal() untuk menimpa data lama di storage.
            saveCacheToLocal();
            // ------------------------------------------------

            renderTabelBarang();
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Harga disimpan', showConfirmButton: false, timer: 1500 });
          } else {
            Swal.fire('Gagal', res.message, 'error');
            // Kembalikan tombol jika gagal
            btn.innerHTML = originalHtml;
            btn.disabled = false;
          }
        }).updateHargaReferensi(token, namaBarang, hargaBaru);
      }

      // --- FUNGSI KLIK TOMBOL 'TAMBAH' DARI POPUP INFO BARANG ---
      function pilihDariInfoBarang(nama, satuan, harga) {
        // 1. Deteksi Tab mana yang sedang aktif (Toko atau Tukang)
        // Default ke toko
        let activeTab = 'toko'; 
        
        // Cek jika tombol tab tukang punya class 'active'
        const tabTukang = document.getElementById('tab-btn-tukang');
        if (tabTukang && tabTukang.classList.contains('active')) {
          activeTab = 'tukang';
        }

        // 2. Panggil fungsi helper untuk memasukkan data
        insertBarangToForm(activeTab, nama, satuan, harga);

        // 3. Tutup Modal
        const modalEl = document.getElementById('modalInfoBarang');
        if (modalEl) {
          const modalInstance = bootstrap.Modal.getInstance(modalEl);
          if(modalInstance) modalInstance.hide();
        }
        
        // 4. Notifikasi
        Swal.fire({ 
          toast: true, 
          position: 'top-end', 
          icon: 'success', 
          title: 'Item ditambahkan', 
          showConfirmButton: false, 
          timer: 1500 
        });
      }

      // --- FUNGSI HELPER: MASUKKAN DATA KE BARIS KOSONG ---
      function insertBarangToForm(tipe, nama, satuan, harga) {
        // Tentukan tabel target
        const tableId = (tipe === 'toko') ? 'tabelItemToko' : 'tabelItemTukang';
        const tbody = document.getElementById(tableId).querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');

        let targetRow = null;
        
        // 1. Cari baris paling bawah. Jika Nama Barangnya kosong, pakai baris itu.
        if (rows.length > 0) {
          const lastRow = rows[rows.length - 1];
          const inputNama = lastRow.querySelector('.item-nama');
          if (inputNama && inputNama.value.trim() === '') {
            targetRow = lastRow;
          }
        }

        // 2. Jika tidak ada baris kosong, buat baris baru
        if (!targetRow) {
          tambahBaris(tipe); // Memanggil fungsi tambahBaris bawaan yang sudah ada
          const newRows = tbody.querySelectorAll('tr');
          targetRow = newRows[newRows.length - 1];
        }

        // 3. Isi Data ke Input
        if (targetRow) {
          const inputNama = targetRow.querySelector('.item-nama');
          const inputSat = targetRow.querySelector('.item-sat');
          const inputHarga = targetRow.querySelector('.item-harga');

          // Decode karakter aneh jika ada (unescape)
          if (inputNama) inputNama.value = unescapeHtml(nama);
          if (inputSat) inputSat.value = unescapeHtml(satuan);
          
          // PENTING: Isi Harga dan Hitung
          if (inputHarga) {
            inputHarga.value = formatRibuanInput(harga); // Format jadi 10.000
            hitungBaris(inputHarga, tipe); // Trigger hitung total otomatis
          }

          // Efek kedip kuning
          targetRow.classList.add('table-warning');
          setTimeout(() => targetRow.classList.remove('table-warning'), 500);
        }
      }

      /* --- MANAJEMEN CACHE LOKAL (PERSISTENT) --- */
      const CACHE_STORAGE_KEY = 'APP_LPJ_CACHE_V1';

      // 1. Simpan Memory ke LocalStorage
      function saveCacheToLocal() {
        // Sinkronkan variabel terpisah ke dalam objek DATA_CACHE utama agar tersimpan semua
        DATA_CACHE.ref_barang = cacheDataBarangLengkap;
        DATA_CACHE.ref_satuan = cacheDataSatuanLengkap;
        DATA_CACHE.ref_uraian = cacheRefLengkap; // Referensi Master Uraian
        DATA_CACHE.ref_guru   = cacheDataGuru;
        
        // Simpan ke penyimpanan browser
        localStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify(DATA_CACHE));
      }

      // 2. Ambil dari LocalStorage ke Memory (Saat Refresh)
      function loadCacheFromLocal() {
        const saved = localStorage.getItem(CACHE_STORAGE_KEY);
        
        if (saved) {
          try {
            // 1. Restore objek utama DATA_CACHE
            DATA_CACHE = JSON.parse(saved);

            // 2. Restore variabel global terpisah agar fitur pencarian/modal berfungsi normal
            
            // Restore Info Barang (Modal Barang)
            if (DATA_CACHE.ref_barang && Array.isArray(DATA_CACHE.ref_barang)) {
                cacheDataBarangLengkap = DATA_CACHE.ref_barang;
            }

            // Restore Info Satuan (Modal Satuan)
            if (DATA_CACHE.ref_satuan && Array.isArray(DATA_CACHE.ref_satuan)) {
                cacheDataSatuanLengkap = DATA_CACHE.ref_satuan;
            }

            // Restore Info Referensi Uraian (Modal Referensi)
            if (DATA_CACHE.ref_uraian && Array.isArray(DATA_CACHE.ref_uraian)) {
                cacheRefLengkap = DATA_CACHE.ref_uraian;
                cacheRefUraian = DATA_CACHE.ref_uraian; // Sinkronkan kedua variabel ini
            }

            // Restore Data Guru (Untuk Dropdown Input Transaksi)
            if (DATA_CACHE.ref_guru && Array.isArray(DATA_CACHE.ref_guru)) {
                cacheDataGuru = DATA_CACHE.ref_guru;
            }
            
            console.log("Cache Lokal berhasil dimuat dari LocalStorage.");
            
          } catch (e) {
            console.error("Gagal memuat cache lokal:", e);
            localStorage.removeItem(CACHE_STORAGE_KEY); // Hapus cache jika korup/error
          }
        }
      }

      // 3. Hapus Cache (Saat Logout)
      function clearLocalCache() {
        localStorage.removeItem(CACHE_STORAGE_KEY);
        // Reset variabel global
        DATA_CACHE = {
              toko: null, tukang: null, guru: null, uraian: null, satuan: null,
              transaksi_toko: null, transaksi_tukang: null, transaksi_guru: null,
              sekolah: null, template_settings: null, dashboard: null
        };
        cacheDataBarangLengkap = [];
        cacheDataSatuanLengkap = [];
        cacheRefLengkap = [];
        cacheDataGuru = [];
      }

      /* --- [BARU] LOGIKA CETAK DOKUMEN PENDUKUNG (DOC TEMPLATE) --- */

      // Data Default Verifikasi
      const DEFAULT_VERIF_ITEMS = [
        "Surat Pengantar LPJ BOS",
        "Permohonan Pencairan Dana BOS (Formulir BOS-04)",
        "Surat Pernyataan Kebenaran Data Rekening Bank (Formulir BOS-05)",
        "Surat Perjanjian Kerja Sama (Formulir BOS-06)",
        "Surat Pernyataan Tanggung Jawab Belanja (Formulir BOS-07)",
        "Laporan Pertanggungjawaban Bantuan Operasional (Formulir BOS-08)",
        "Kuitansi Penerimaan Bantuan Operasional (Formulir BOS-10)",
        "Rencana Kegiatan dan Anggaran Madrasah (RKAM)",
        "Buku Kas Umum (BKU)",
        "Buku Pembantu Pajak",
        "Bukti Pengeluaran (Nota/Faktur/Kuitansi)",
        "Dokumentasi Kegiatan / Foto Barang"
      ];

      let verifItems = [...DEFAULT_VERIF_ITEMS];

      /* --- TAMBAHAN LOGIKA LOGO COVER --- */

      function bukaSubTab(tabName) {
        document.querySelectorAll('#panel-cetak-pendukung .nav-link').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.sub-view-section').forEach(el => el.classList.add('hidden'));

        document.getElementById('tab-sub-' + tabName).classList.add('active');
        document.getElementById('view-sub-' + tabName).classList.remove('hidden');

        const token = localStorage.getItem('userToken');
        
        // Cek Status File PDF (Sudah ada atau belum)
        cekStatusFilePendukung(); 

        if (tabName === 'sampul') {
            loadCoverData(token);    // Load Data Tersimpan (Teks & Logo)
            loadCoverOptions(token); // Load Dropdown Desain
        } else if (tabName === 'setting-doc') {
            loadSettingDoc(token);
        } else if (tabName === 'verifikasi') {
            renderVerifList();
            loadDataPejabatVerif(token); // Load Data Verifikator
        } else if (tabName === 'pengantar') {
            loadDataSP(token); // Load Data Surat Pengantar
        }
      }

      // 2. Fungsi Preview Gambar Lokal (Sebelum Upload)
      function previewLogoLocal(input, imgId) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById(imgId).src = e.target.result;
          }
          reader.readAsDataURL(input.files[0]);
        }
      }

      /* --- UPDATE FUNGSI UPLOAD LOGO (CACHE UPDATE) --- */
      function uploadLogoCover() {
        const fileInput = document.getElementById('fileLogoCover');
        if (fileInput.files.length === 0) {
          Swal.fire('Peringatan', 'Pilih file gambar terlebih dahulu!', 'warning');
          return;
        }

        const file = fileInput.files[0];
        // Validasi Ukuran 2MB
        if (file.size > 2 * 1024 * 1024) {
          Swal.fire('File Terlalu Besar', 'Maksimal ukuran file adalah 2MB', 'warning');
          return;
        }

        const token = localStorage.getItem('userToken');
        
        // Tampilkan Loading
        Swal.fire({
          title: 'Mengupload...', 
          html: 'Mohon tunggu sebentar...',
          allowOutsideClick: false, 
          didOpen: () => Swal.showLoading()
        });

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function() {
          const rawBase64 = reader.result.split(',')[1]; 
          const payload = { base64: rawBase64, mimeType: file.type };
          
          google.script.run
            .withFailureHandler(function(err) {
              Swal.fire('Gagal', err.message, 'error');
            })
            .withSuccessHandler(function(res) {
              if(res.status === 'success') {
                  
                  // [PERUBAHAN UTAMA] UPDATE CACHE LOKAL SECARA LANGSUNG
                  // Kita menyuntikkan ID Logo baru ke dalam memori cache
                  if (DATA_CACHE.pendukung) {
                      // Pastikan struktur objek ada
                      if (!DATA_CACHE.pendukung.cover) DATA_CACHE.pendukung.cover = {};
                      
                      // Update ID Logo
                      DATA_CACHE.pendukung.cover.logoId = res.fileId;
                  }

                  // Bersihkan input file agar sistem tahu proses upload sudah tuntas
                  // (Penting agar validasi generate tidak error)
                  document.getElementById('fileLogoCover').value = "";
                  
                  Swal.fire({
                    icon: 'success', 
                    title: 'Berhasil', 
                    text: 'Logo berhasil diupload dan disimpan!',
                    timer: 1500,
                    showConfirmButton: false
                  });

              } else {
                  Swal.fire('Gagal', res.message, 'error');
              }
            })
            .simpanLogoSampul(token, payload);
        };
      }

      /* --- TAMBAHKAN FUNGSI INI DI BAGIAN SCRIPT Index.html --- */

      function hapusLogoCover() {
        Swal.fire({
          title: 'Hapus Logo?',
          text: "Logo akan dihapus permanen dan kembali ke logo default (Kemenag).",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            
            // Tampilkan Loading
            Swal.fire({
              title: 'Menghapus...', 
              allowOutsideClick: false, 
              didOpen: () => Swal.showLoading()
            });

            google.script.run.withSuccessHandler(function(res) {
              if(res.status === 'success') {
                  document.getElementById('logoPreviewCover').src = "https://i.imgur.com/WqGSzFl.png";
                  document.getElementById('fileLogoCover').value = ""; 
                  
                  // UPDATE CACHE: Set logoId menjadi null
                  if (DATA_CACHE.pendukung && DATA_CACHE.pendukung.cover) {
                      DATA_CACHE.pendukung.cover.logoId = null;
                  }
                  
                  Swal.fire('Terhapus', 'Logo berhasil dihapus.', 'success');
              } else {
                  Swal.fire('Gagal', res.message, 'error');
              }
            }).hapusLogoSampul(token);
          }
        });
      }

      /* --- LOAD & SIMPAN DATA COVER (PERBAIKAN NULL CHECK) --- */
      function loadCoverData(token) {
        document.getElementById('logoPreviewCover').style.opacity = '0.5';
        document.getElementById('inpHeaderCover').placeholder = "Memuat...";
        
        const inputPeriode = document.getElementById('inpPeriodeCover');
        inputPeriode.value = ""; 
        inputPeriode.placeholder = "Memuat otomatis...";
        inputPeriode.readOnly = true; 
        inputPeriode.classList.add('bg-light');

        // 1. AMBIL DATA SEKOLAH
        google.script.run.withSuccessHandler(function(resSekolah) {
          
          // [FIX] Validasi resSekolah agar tidak crash jika null
          const dataSekolah = (resSekolah && resSekolah.status === 'success') ? resSekolah.data : {};
          const periodeOtomatis = dataSekolah.periodeAnggaran || "";

          // 2. SETELAH ITU BARU AMBIL PENGATURAN COVER
          google.script.run.withSuccessHandler(function(res) {
            document.getElementById('logoPreviewCover').style.opacity = '1';
            document.getElementById('inpHeaderCover').placeholder = "Contoh: YAYASAN...";

            // [FIX] Validasi res
            if (res && res.status === 'success') {
              const d = res.data;
              
              if (d.logoId) {
                const url = "https://drive.google.com/thumbnail?id=" + d.logoId + "&sz=w400";
                document.getElementById('logoPreviewCover').src = url;
              }

              if (d.headerText) document.getElementById('inpHeaderCover').value = d.headerText;
              if (d.titleText) document.getElementById('inpJudulCover').value = d.titleText;

              inputPeriode.value = periodeOtomatis;
              
              if (!periodeOtomatis) {
                  inputPeriode.placeholder = "Periode belum disetting di Menu Data Sekolah";
              }
            }
          }).getCoverSettings(token);

        }).getDataSekolah(token);
      }

      /* --- UPDATE FUNGSI simpanDataCover --- */

      /* --- UPDATE FUNGSI simpanDataCover (Support Callback) --- */
      function simpanDataCover(callbackSuccess = null) {
        const token = localStorage.getItem('userToken');
        const config = {
          header: document.getElementById('inpHeaderCover').value,
          title: document.getElementById('inpJudulCover').value,
          period: document.getElementById('inpPeriodeCover').value
        };

        // Cari tombol (bisa dipanggil dari event click atau generate)
        let btn = document.getElementById('btnSimpanCover'); 
        // Fallback jika dipanggil via kode (bukan klik langsung)
        if(!btn && event && event.target) btn = event.target.closest('button');
        
        const oriText = btn ? btn.innerHTML : 'Simpan Data';
        if(btn) { btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...'; btn.disabled = true; }

        google.script.run.withSuccessHandler(function(res) {
          if(btn) { btn.innerHTML = oriText; btn.disabled = false; }
          
          if(res.status === 'success') {
            // Update Cache Lokal
            if(DATA_CACHE.pendukung && DATA_CACHE.pendukung.cover) {
                DATA_CACHE.pendukung.cover.headerText = config.header;
                DATA_CACHE.pendukung.cover.titleText = config.title;
                DATA_CACHE.pendukung.cover.periodText = config.period;
            }
            
            // [PENTING] Set status jadi BERSIH
            setDirtyPendukung('COVER', false);

            // Jalankan Callback (Generate) jika ada
            if (typeof callbackSuccess === 'function') {
                callbackSuccess();
            } else {
                Swal.fire({toast:true, position:'top-end', icon:'success', title:'Data Cover Disimpan', showConfirmButton:false, timer:1500});
            }
          }
          else Swal.fire('Gagal', res.message, 'error');
        }).simpanDetailSampul(token, config);
      }

      // 2. Setting ID Template
      function loadSettingDoc(token) {
        const inputs = ['tplCoverCustom', 'tplSp', 'tplVerif'];
        inputs.forEach(id => document.getElementById(id).value = "Memuat...");

        google.script.run.withSuccessHandler(function(res){
          if(res.status === 'success' && res.data) {
            const d = res.data;
            // Mapping Data
            document.getElementById('tplCoverCustom').value = d.coverCustom || '';
            document.getElementById('tplSp').value = d.sp || '';
            document.getElementById('tplVerif').value = d.verif || '';
          }
        }).getSettingDokumenPendukung(token);
      }

      function simpanSettingDocPendukung(e) {
        e.preventDefault();
        const token = localStorage.getItem('userToken');
        const settings = {
          coverCustom: document.getElementById('tplCoverCustom').value.trim(),
          sp: document.getElementById('tplSp').value.trim(),
          verif: document.getElementById('tplVerif').value.trim()
        };

        const btn = document.getElementById('btnSimpanSetDoc');
        const txt = btn.innerHTML;
        btn.innerHTML = 'Menyimpan...'; btn.disabled = true;

        google.script.run.withSuccessHandler(function(res){
          btn.innerHTML = txt; btn.disabled = false;
          if(res.status === 'success') Swal.fire('Tersimpan', res.message, 'success');
          else Swal.fire('Gagal', res.message, 'error');
        }).simpanSettingDokumenPendukung(token, settings);
      }

      // 3. Logic Verifikasi List (CRUD)
      function renderVerifList() {
        const tbody = document.getElementById('verifListBody');
        tbody.innerHTML = '';
        
        verifItems.forEach((item, index) => {
          const row = `
            <tr>
              <td class="text-center">${index + 1}</td>
              <td>
                <input type="text" class="form-control form-control-sm border-0 bg-transparent" 
                  value="${item}" onchange="updateVerifItem(${index}, this.value)">
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-link text-danger p-0" onclick="removeVerifItem(${index})">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      }

      /* --- FUNGSI TAMBAH ITEM DENGAN AUTO FOCUS --- */
      function addVerifItem() {
        // Tambahkan item kosong atau default
        verifItems.push("Item Baru..."); 
        
        // Render ulang tabel
        renderVerifList();

        // Logic Auto Focus ke Baris Terakhir
        // Gunakan setTimeout agar menunggu tabel selesai digambar ulang oleh browser
        setTimeout(() => {
          const tbody = document.getElementById('verifListBody');
          const rows = tbody.querySelectorAll('tr');
          
          if (rows.length > 0) {
            // Ambil baris terakhir
            const lastRow = rows[rows.length - 1];
            // Cari elemen input di dalam baris tersebut
            const input = lastRow.querySelector('input');
            
            if (input) {
              input.focus();  // Fokuskan kursor
              input.select(); // Blok teks "Item Baru..." agar user tinggal ketik
              
              // Scroll ke bawah agar baris baru terlihat jika tabel panjang
              input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        }, 100);
      }

      function removeVerifItem(index) {
        verifItems.splice(index, 1);
        renderVerifList();
      }

      function updateVerifItem(index, val) {
        verifItems[index] = val;
      }

      // --- UPDATE: FUNGSI RESET VERIFIKASI DENGAN SWEETALERT ---
      function resetVerifList() {
        Swal.fire({
          title: 'Kembalikan ke Default?',
          text: "Daftar item verifikasi akan dikembalikan ke pengaturan awal sistem. Item tambahan manual akan hilang.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',   // Merah untuk peringatan
          cancelButtonColor: '#6c757d', // Abu-abu untuk batal
          confirmButtonText: '<i class="fas fa-sync-alt me-1"></i> Ya, Reset',
          cancelButtonText: 'Batal',
          reverseButtons: true
        }).then((result) => {
          if (result.isConfirmed) {
            // Logika Reset Data
            verifItems = [...DEFAULT_VERIF_ITEMS];
            renderVerifList();

            // Pesan Sukses Kecil (Toast)
            Swal.fire({
              icon: 'success',
              title: 'Berhasil Direset',
              text: 'Daftar verifikasi kembali ke pengaturan awal.',
              timer: 1500,
              showConfirmButton: false,
              toast: true,
              position: 'top-end'
            });
          }
        });
      }
      
      // Load Pejabat Verifikasi (Reuse function dari kode lama atau buat baru)
      function loadDataPejabatVerif(token) {
         google.script.run.withSuccessHandler(function(res){
            if(res.status==='success' && res.data) {
                // Isi input form jika ada data tersimpan
                const d = res.data;
                if(d.verifikator1) {
                    document.getElementById('vfNama1').value = d.verifikator1.nama;
                    document.getElementById('vfNip1').value = d.verifikator1.nip;
                }
                if(d.verifikator2) {
                    document.getElementById('vfNama2').value = d.verifikator2.nama;
                    document.getElementById('vfNip2').value = d.verifikator2.nip;
                }
                if(d.pengawas) {
                    document.getElementById('vfNamaPengawas').value = d.pengawas.nama;
                    document.getElementById('vfNipPengawas').value = d.pengawas.nip;
                }
                // Jika rows tersimpan, pakai itu
                if(d.rows && d.rows.length > 0) {
                    verifItems = d.rows;
                    renderVerifList();
                }
            }
         }).getDataVerifikasi(token);
      }

      /* --- FUNGSI UPDATE: GENERATE PDF DENGAN CEK STATUS SIMPAN --- */
      function generatePdfPendukung(tipe) {
        const token = localStorage.getItem('userToken');
        let formData = {};

        // === [A] CEK PERUBAHAN DATA (DIRTY CHECK) ===
        if (dirtyPendukung[tipe] === true) {
          Swal.fire({
            title: 'Data Belum Disimpan!',
            text: 'Ada perubahan data yang belum disimpan ke database. Sebaiknya simpan dulu agar data terbaru masuk ke PDF.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '<i class="fas fa-save me-1"></i> Simpan & Generate',
            cancelButtonText: 'Batal'
          }).then((result) => {
            if (result.isConfirmed) {
              // Panggil fungsi simpan yang sesuai, lalu callback ke fungsi ini lagi (executeGenerateCore)
              if (tipe === 'COVER') simpanDataCover(() => executeGenerateCore(tipe));
              else if (tipe === 'SP') simpanDataSP(() => executeGenerateCore(tipe));
              else if (tipe === 'VERIFIKASI') simpanDataVerif(() => executeGenerateCore(tipe));
            }
          });
          return; // Berhenti disini, jangan lanjut generate dulu
        }

        // Jika bersih, lanjut langsung
        executeGenerateCore(tipe);
      }

      // --- FUNGSI INTI GENERATE (DENGAN KONFIRMASI GANTI FILE) ---
      function executeGenerateCore(tipe) {
        const token = localStorage.getItem('userToken');
        let formData = {};

        // === 1. VALIDASI KHUSUS COVER (LOGO) ===
        if (tipe === 'COVER') {
          const inputLogo = document.getElementById('fileLogoCover');
          if (inputLogo && inputLogo.value !== "") {
            Swal.fire({
              icon: 'warning', title: 'Logo Belum Diupload!',
              html: 'Klik tombol <b>Upload</b> terlebih dahulu sebelum generate.',
              confirmButtonText: 'Oke'
            });
            return;
          }
        }

        // === 2. PERSIAPAN DATA FORM ===
        if (tipe === 'COVER') {
          formData.desain = document.getElementById('coverDesignSelect').value;
          formData.header = document.getElementById('inpHeaderCover').value;
          formData.judul = document.getElementById('inpJudulCover').value;
          formData.periode = document.getElementById('inpPeriodeCover').value;
        } else if (tipe === 'SP') {
          formData.nomor = document.getElementById('spNomor').value;
          formData.tempat = document.getElementById('spTempat').value;
          formData.tanggal = document.getElementById('spTanggal').value;
          if (!formData.nomor) return Swal.fire('Error', 'Nomor Surat wajib diisi', 'warning');
        } else if (tipe === 'VERIFIKASI') {
          formData.verifikator1 = { nama: document.getElementById('vfNama1').value, nip: document.getElementById('vfNip1').value };
          formData.verifikator2 = { nama: document.getElementById('vfNama2').value, nip: document.getElementById('vfNip2').value };
          formData.pengawas = { nama: document.getElementById('vfNamaPengawas').value, nip: document.getElementById('vfNipPengawas').value };
          formData.rows = verifItems;
        }

        // === 3. LOGIKA CEK FILE LAMA (KONFIRMASI TIMPA) ===
        let fileAda = false;
        let namaDokumen = "";
        
        // Cek tombol dan tentukan nama dokumen berdasarkan tipe
        if (tipe === 'COVER') {
          fileAda = !document.getElementById('btnViewCover').classList.contains('hidden');
          namaDokumen = "Cover/Sampul";
        } else if (tipe === 'SP') {
          fileAda = !document.getElementById('btnViewSp').classList.contains('hidden');
          namaDokumen = "Surat Pengantar";
        } else if (tipe === 'VERIFIKASI') {
          fileAda = !document.getElementById('btnViewVerif').classList.contains('hidden');
          namaDokumen = "Lembar Verifikasi";
        }

        // Default Konfigurasi (Jika belum ada file)
        let judulSwal = 'Generate PDF?';
        let htmlPesan = `Sistem akan membuat dokumen <b>${namaDokumen}</b>. Lanjutkan?`;
        let warnaTombol = '#0d6efd'; // Biru (Normal)
        let teksTombol = 'Generate';

        // Jika File Sudah Ada (Mode Ganti)
        if (fileAda) {
          judulSwal = 'Ganti File Lama?';
          htmlPesan = `File <b>${namaDokumen}</b> lama akan <b>DIHAPUS</b> dan diganti dengan yang baru. Lanjutkan?`;
          warnaTombol = '#dc3545'; // Merah (Warning)
          teksTombol = 'Ya, Ganti File';
        }

        // Tampilkan Popup Konfirmasi
        Swal.fire({
          title: judulSwal,
          html: htmlPesan,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: warnaTombol,
          cancelButtonColor: '#6c757d',
          confirmButtonText: teksTombol,
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            
            // Tampilkan Loading
            Swal.fire({
              title: 'Memproses...', 
              html: `Sedang menyusun ${namaDokumen}...`, 
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading()
            });

            // Kirim ke Server
            google.script.run
              .withFailureHandler((err) => { Swal.fire('Gagal', err.message, 'error'); })
              .withSuccessHandler((res) => {
                if (res.status === 'success') {
                  // Update Cache Lokal status file
                  if (DATA_CACHE.pendukung) {
                      if (!DATA_CACHE.pendukung.fileStatus) DATA_CACHE.pendukung.fileStatus = {};
                      DATA_CACHE.pendukung.fileStatus[tipe] = res.fileId;
                  }

                  // Update UI: Munculkan tombol Lihat PDF
                  if (tipe === 'COVER') updateBtnView('btnViewCover', 'urlPdfCover', res.fileId);
                  if (tipe === 'SP') updateBtnView('btnViewSp', 'urlPdfSp', res.fileId);
                  if (tipe === 'VERIFIKASI') updateBtnView('btnViewVerif', 'urlPdfVerif', res.fileId);

                  // Sukses Message & Buka Tab Baru
                  Swal.fire({
                    icon: 'success', 
                    title: 'Berhasil', 
                    text: `Dokumen ${namaDokumen} berhasil dibuat!`,
                    confirmButtonText: 'Buka PDF', 
                    showCancelButton: true, 
                    cancelButtonText: 'Tutup'
                  }).then((r) => { if (r.isConfirmed) window.open(res.url, '_blank'); });

                } else if (res.status === 'error_template') {
                  Swal.fire('Error Template', res.message, 'error');
                } else {
                  Swal.fire({ icon: 'error', title: 'Gagal', text: res.message });
                }
              })
              .generateDokumenPendukung(token, tipe, formData);
          }
        });
      }

      // Fungsi Load Pilihan Desain Cover (UPDATE: Hapus Custom)
      function loadCoverOptions(token) {
        const select = document.getElementById('coverDesignSelect');
        select.innerHTML = '<option value="" disabled selected>Memuat...</option>';
        select.disabled = true;

        google.script.run.withSuccessHandler(function(res) {
          select.innerHTML = '';
          select.disabled = false;

          if (res.status === 'success') {
            // 1. Render System Templates (Dari Sheet Cetak_Lainnya)
            if (res.system && res.system.length > 0) {
                res.system.forEach(tpl => {
                    const opt = document.createElement('option');
                    opt.value = tpl.id; // ID Dokumen
                    opt.text = tpl.name;
                    select.add(opt);
                });
            } else {
                // Fallback jika kosong
                const opt = document.createElement('option');
                opt.text = "-- Tidak ada template sistem --";
                select.add(opt);
            }

            // [HAPUS BAGIAN LOGIKA CUSTOM DISINI]
            // Dropdown sekarang hanya menampilkan template sistem.
            
            // Select default: item pertama
            if (select.options.length > 0) {
                select.selectedIndex = 0;
            }

          } else {
            select.innerHTML = '<option>Gagal memuat opsi</option>';
          }
        }).getCoverTemplateList(token);
      }

      /* --- FUNGSI CEK STATUS FILE DARI SERVER --- */
      function cekStatusFilePendukung() {
        const token = localStorage.getItem('userToken');
        
        google.script.run.withSuccessHandler(function(res) {
          if(res.status === 'success' && res.data) {
            const d = res.data;
            
            // Update Tombol COVER
            updateBtnView('btnViewCover', 'urlPdfCover', d.COVER);
            
            // Update Tombol SP
            updateBtnView('btnViewSp', 'urlPdfSp', d.SP);
            
            // Update Tombol VERIFIKASI
            updateBtnView('btnViewVerif', 'urlPdfVerif', d.VERIF);
          }
        }).getDokumenPendukungStatus(token);
      }

      // Helper Update Tombol
      function updateBtnView(btnId, inputUrlId, fileId) {
        const btn = document.getElementById(btnId);
        const input = document.getElementById(inputUrlId);
        
        if (fileId && fileId !== "") {
          const url = "https://drive.google.com/file/d/" + fileId + "/view?usp=sharing";
          input.value = url;
          btn.classList.remove('hidden'); // Munculkan tombol
        } else {
          input.value = "";
          btn.classList.add('hidden'); // Sembunyikan tombol
        }
      }

      /* --- FUNGSI BUKA PDF HASIL --- */
      function bukaPdfHasil(tipe) {
        let urlId = '';
        if (tipe === 'COVER') urlId = 'urlPdfCover';
        else if (tipe === 'SP') urlId = 'urlPdfSp';
        else urlId = 'urlPdfVerif';
        
        const url = document.getElementById(urlId).value;
        if(url) window.open(url, '_blank');
        else Swal.fire('Error', 'Link PDF tidak ditemukan. Silakan generate ulang.', 'error');
      }

      /* --- LOAD DATA SURAT PENGANTAR (PERBAIKAN NULL CHECK) --- */
      function loadDataSP(token) {
        const inputNomor = document.getElementById('spNomor');
        const inputTempat = document.getElementById('spTempat');

        inputNomor.placeholder = "Memuat...";
        inputTempat.value = ""; 
        inputTempat.placeholder = "Memuat otomatis...";
        inputTempat.readOnly = true; 
        inputTempat.classList.add('bg-light');

        google.script.run.withSuccessHandler(function(resSekolah) {
          
          // [FIX] Validasi resSekolah
          const dataSekolah = (resSekolah && resSekolah.status === 'success') ? resSekolah.data : {};
          const tempatDefault = dataSekolah.tempatTTD || "";

          inputTempat.value = tempatDefault;
          if (!tempatDefault) inputTempat.placeholder = "Belum disetting di Data Sekolah";

          google.script.run.withSuccessHandler(function(res) {
            // [FIX] Validasi res
            if (res && res.status === 'success') {
              const d = res.data;
              if (d.nomor) inputNomor.value = d.nomor;
              if (d.tanggal) {
                document.getElementById('spTanggal').value = d.tanggal;
              } else {
                document.getElementById('spTanggal').valueAsDate = new Date();
              }
            }
            inputNomor.placeholder = "Contoh: 001/MTs.../...";
            
          }).getDataSuratPengantar(token);

        }).getDataSekolah(token);
      }

      /* --- UPDATE FUNGSI simpanDataSP --- */

      /* --- UPDATE FUNGSI simpanDataSP (FIX LOADING) --- */
      function simpanDataSP(callbackSuccess = null) {
        const token = localStorage.getItem('userToken');
        const form = {
          nomor: document.getElementById('spNomor').value,
          tempat: document.getElementById('spTempat').value,
          tanggal: document.getElementById('spTanggal').value
        };

        let btn = document.getElementById('btnSimpanSP');
        const oriText = btn ? btn.innerHTML : 'Simpan Data';
        
        // PERBAIKAN DISINI: Menambahkan Spinner dan Teks "Menyimpan..."
        if(btn) { 
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Menyimpan...'; 
          btn.disabled = true; 
        }

        google.script.run.withSuccessHandler(function(res) {
          if(btn) { btn.innerHTML = oriText; btn.disabled = false; }
          
          if(res.status === 'success') {
            if(DATA_CACHE.pendukung && DATA_CACHE.pendukung.sp) {
                DATA_CACHE.pendukung.sp.nomor = form.nomor;
                DATA_CACHE.pendukung.sp.tempat = form.tempat;
                DATA_CACHE.pendukung.sp.tanggal = form.tanggal;
            }
            
            setDirtyPendukung('SP', false);

            if (typeof callbackSuccess === 'function') callbackSuccess();
            else Swal.fire({toast:true, position:'top-end', icon:'success', title:'Data Surat Disimpan', showConfirmButton:false, timer:1500});
          } else Swal.fire('Gagal', res.message, 'error');
        }).simpanDataSuratPengantar(token, form);
      }

      /* --- UPDATE FUNGSI simpanDataVerif --- */

      /* --- UPDATE FUNGSI simpanDataVerif (FIX LOADING) --- */
      function simpanDataVerif(callbackSuccess = null) {
        const token = localStorage.getItem('userToken');
        const formData = {
          verifikator1: { nama: document.getElementById('vfNama1').value, nip: document.getElementById('vfNip1').value },
          verifikator2: { nama: document.getElementById('vfNama2').value, nip: document.getElementById('vfNip2').value },
          pengawas: { nama: document.getElementById('vfNamaPengawas').value, nip: document.getElementById('vfNipPengawas').value },
          rows: verifItems
        };

        let btn = document.getElementById('btnSimpanVerif');
        const oriText = btn ? btn.innerHTML : 'Simpan Data';
        
        // PERBAIKAN DISINI: Menambahkan Spinner dan Teks "Menyimpan..."
        if(btn) { 
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Menyimpan...'; 
          btn.disabled = true; 
        }

        google.script.run.withSuccessHandler(function(res) {
          if(btn) { btn.innerHTML = oriText; btn.disabled = false; }
          
          if(res.status === 'success') {
            if(DATA_CACHE.pendukung) {
                if(!DATA_CACHE.pendukung.verif) DATA_CACHE.pendukung.verif = {};
                DATA_CACHE.pendukung.verif = formData;
            }

            setDirtyPendukung('VERIFIKASI', false);

            if (typeof callbackSuccess === 'function') callbackSuccess();
            else Swal.fire({toast:true, position:'top-end', icon:'success', title:'Data Verifikasi Disimpan', showConfirmButton:false, timer:1500});
          } else Swal.fire('Gagal', res.message, 'error');
        }).simpanDataVerifikasi(token, formData);
      }

      /* --- GANTI FUNGSI loadAllPendukungData DENGAN INI --- */

      // Fungsi Helper untuk Disable/Enable tombol Generate
      function setGenerateButtonsLoading(isLoading) {
        const ids = ['btnGenCover', 'btnGenSP', 'btnGenVerif'];
        
        ids.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.disabled = isLoading; // True = mati, False = hidup
            
            if (isLoading) {
              // Simpan teks asli jika belum disimpan
              if (!btn.dataset.originalText) {
                btn.dataset.originalText = btn.innerHTML;
              }
              // Ubah teks jadi loading
              btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sync...';
            } else {
              // Kembalikan teks asli
              if (btn.dataset.originalText) {
                btn.innerHTML = btn.dataset.originalText;
              }
            }
          }
        });
      }

      /* --- GANTI FUNGSI loadAllPendukungData DENGAN INI --- */

      function loadAllPendukungData(forceRefresh = false, targetTab = 'sampul') {
        // Cek Cache
        if (!forceRefresh && DATA_CACHE.pendukung) {
          bukaSubTab(targetTab);
          return;
        }

        const containerId = 'panel-cetak-pendukung';
        
        // 1. KUNCI UI & Tampilkan Loading
        toggleContainerInputs(containerId, true); 
        Swal.fire({
          toast: true, position: 'top-end', showConfirmButton: false,
          title: 'Sinkronisasi Data Pendukung...', didOpen: () => Swal.showLoading()
        });

        const token = localStorage.getItem('userToken');

        google.script.run
          .withFailureHandler((err) => {
            Swal.close();
            handleServerError(err);
            // BUKA KUNCI JIKA ERROR
            toggleContainerInputs(containerId, false);
          })
          .withSuccessHandler(function(res) {
            // 2. BUKA KUNCI UI
            toggleContainerInputs(containerId, false);
            Swal.close();

            if (res && res.status === 'success') {
              DATA_CACHE.pendukung = res.data;
              bukaSubTab(targetTab);
              
              const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 1500
              });
              Toast.fire({ icon: 'success', title: 'Data berhasil disinkronkan' });

            } else {
              const errMsg = (res && res.message) ? res.message : "Data tidak valid.";
              Swal.fire('Gagal', errMsg, 'error');
            }
          })
          .getAllPendukungData(token);
      }

      // 2. Fungsi Buka Tab (HANYA RENDER DARI CACHE, TIDAK ADA FETCH SERVER)
      function bukaSubTab(tabName) {
        // Reset UI Tab
        document.querySelectorAll('#panel-cetak-pendukung .nav-link').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.sub-view-section').forEach(el => el.classList.add('hidden'));

        document.getElementById('tab-sub-' + tabName).classList.add('active');
        document.getElementById('view-sub-' + tabName).classList.remove('hidden');

        // Pastikan Cache Ada (Safety check)
        if (!DATA_CACHE.pendukung) {
          loadAllPendukungData(); // Reload jika cache hilang/kosong
          return;
        }

        const d = DATA_CACHE.pendukung; // Ambil dari Cache

        // Update Tombol View PDF (Berlaku untuk semua tab)
        updateBtnView('btnViewCover', 'urlPdfCover', d.fileStatus.COVER);
        updateBtnView('btnViewSp', 'urlPdfSp', d.fileStatus.SP);
        updateBtnView('btnViewVerif', 'urlPdfVerif', d.fileStatus.VERIF);

        // --- RENDER SESUAI TAB ---
        if (tabName === 'sampul') {
          renderTabCover(d);
        } else if (tabName === 'pengantar') {
          renderTabSP(d);
        } else if (tabName === 'verifikasi') {
          renderTabVerif(d);
        } else if (tabName === 'setting-doc') {
          renderTabSetting(d);
        }
      }

      // 3. Render Tab Cover
      function renderTabCover(d) {
        // A. Logo
        if (d.cover.logoId) {
          document.getElementById('logoPreviewCover').src = "https://drive.google.com/thumbnail?id=" + d.cover.logoId + "&sz=w400";
        }

        // B. Dropdown Desain
        const select = document.getElementById('coverDesignSelect');
        select.innerHTML = '';
        
        // Opsi System
        if (d.desain.system && d.desain.system.length > 0) {
          d.desain.system.forEach(tpl => {
            const opt = document.createElement('option');
            opt.value = tpl.id;
            opt.text = tpl.name;
            select.add(opt);
          });
        } else {
          select.add(new Option("-- Tidak ada template sistem --", ""));
        }

        // --- KODE CUSTOM SUDAH DIHAPUS DISINI ---

        // Select default: item pertama
        if (select.options.length > 0) {
            select.selectedIndex = 0;
        }

        // C. Input Form
        document.getElementById('inpHeaderCover').value = d.cover.headerText || 'KEMENTERIAN AGAMA';
        document.getElementById('inpJudulCover').value = d.cover.titleText || 'LAPORAN PENGGUNAAN DANA BOS';
        
        // Periode (Terkunci, ambil dari data sekolah)
        const inputPeriode = document.getElementById('inpPeriodeCover');
        const periodeSekolah = d.sekolah.periodeAnggaran || "";
        inputPeriode.value = periodeSekolah;
        inputPeriode.readOnly = true;
        inputPeriode.classList.add('bg-light');
        if(!periodeSekolah) inputPeriode.placeholder = "Periode belum disetting di Data Sekolah";

        // [BARU] Reset status ke Bersih (Clean) setelah data server masuk
        setDirtyPendukung('COVER', false);
        // [BARU] Pasang monitor untuk mendeteksi ketikan user setelah ini
        monitorInputPendukung('COVER');
      }

      // 4. Render Tab SP
      function renderTabSP(d) {
        const inputNomor = document.getElementById('spNomor');
        const inputTempat = document.getElementById('spTempat');
        const inputTanggal = document.getElementById('spTanggal');

        // Nomor Surat (User Input)
        inputNomor.value = d.sp.nomor || '';
        
        // Tempat TTD (Terkunci, dari Data Sekolah)
        const tempatDefault = d.sekolah.tempatTTD || "";
        inputTempat.value = tempatDefault;
        inputTempat.readOnly = true;
        inputTempat.classList.add('bg-light');
        if(!tempatDefault) inputTempat.placeholder = "Belum disetting di Data Sekolah";

        // Tanggal
        if (d.sp.tanggal) {
          inputTanggal.value = d.sp.tanggal;
        } else {
          inputTanggal.valueAsDate = new Date();
        }

        // [BARU]
        setDirtyPendukung('SP', false);
        monitorInputPendukung('SP');
      }

      // 5. Render Tab Verifikasi
      function renderTabVerif(d) {
        const v = d.verif || {};
        
        // Verifikator 1
        if(v.verifikator1) {
          document.getElementById('vfNama1').value = v.verifikator1.nama || '';
          document.getElementById('vfNip1').value = v.verifikator1.nip || '';
        }
        // Verifikator 2
        if(v.verifikator2) {
          document.getElementById('vfNama2').value = v.verifikator2.nama || '';
          document.getElementById('vfNip2').value = v.verifikator2.nip || '';
        }
        // Pengawas
        if(v.pengawas) {
          document.getElementById('vfNamaPengawas').value = v.pengawas.nama || '';
          document.getElementById('vfNipPengawas').value = v.pengawas.nip || '';
        }

        // List Item (Global Variable `verifItems` dari kode lama)
        if(v.rows && v.rows.length > 0) {
          verifItems = v.rows;
        } else {
          // Jika data kosong, gunakan default
          verifItems = [...DEFAULT_VERIF_ITEMS];
        }
        renderVerifList(); // Panggil fungsi render tabel list yang sudah ada

        // [BARU]
        setDirtyPendukung('VERIFIKASI', false);
        monitorInputPendukung('VERIFIKASI');
      }

      // 6. Render Tab Setting
      function renderTabSetting(d) {
        document.getElementById('tplCoverCustom').value = d.docSettings.coverCustom || '';
        document.getElementById('tplSp').value = d.docSettings.sp || '';
        document.getElementById('tplVerif').value = d.docSettings.verif || '';
      }

      /* --- LOGIKA BERKAS PENCAIRAN --- */

      function bukaTabPencairan(tabName) {
        // 1. Reset Tampilan
        document.querySelectorAll('#panel-berkas-pencairan .nav-link').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.view-pencairan').forEach(el => el.classList.add('hidden'));

        // 2. Aktifkan Tombol & View
        const btnId = 'tab-pencairan-' + tabName;
        const viewId = 'view-pencairan-' + tabName;
        const btn = document.getElementById(btnId);
        const view = document.getElementById(viewId);
        if (btn) btn.classList.add('active');
        if (view) view.classList.remove('hidden');

        // 3. Load Data Terpusat (SOLUSI)
        // Ubah parameter menjadi 'true' agar selalu Force Refresh / Sinkron Ulang
        loadAllPencairanData(false, tabName); 
      }

      /* --- LOGIKA BERKAS PENCAIRAN (UPDATED: DIRTY CHECK & SYNC) --- */

      // Variabel Global untuk melacak perubahan data
      let isPksDirty = false;

      // 1. Fungsi Menandai Ada Perubahan (Mode Edit / Belum Disimpan)
      function markPksDirty() {
        isPksDirty = true;
        const btn = document.getElementById('btnSimpanPks');
        if(btn) {
          btn.innerHTML = '<i class="fas fa-save me-2"></i> Simpan Perubahan*';
          
          // Hapus kelas biru solid dan outline
          btn.classList.remove('btn-primary'); 
          btn.classList.remove('btn-outline-primary');
          
          // Tambahkan warna KUNING (Peringatan belum disimpan)
          btn.classList.add('btn-warning');
        }
      }

      // 2. Fungsi Menandai Data Sudah Bersih/Disimpan (Mode Standar)
      function markPksClean() {
        isPksDirty = false;
        const btn = document.getElementById('btnSimpanPks');
        if(btn) {
          btn.innerHTML = '<i class="fas fa-save me-2"></i> Simpan Data';
          
          // Hapus kelas kuning dan outline
          btn.classList.remove('btn-warning');
          btn.classList.remove('btn-outline-primary');
          
          // UBAH DI SINI: Gunakan 'btn-primary' agar Biru Penuh (Solid)
          btn.classList.add('btn-primary');
        }
      }

      // 3. Pasang Listener ke Semua Input PKS
      function attachPksListeners() {
        const inputs = document.querySelectorAll('#formPks input, #formPks textarea');
        inputs.forEach(input => {
          // Hapus listener lama biar gak dobel (re-clone node trick)
          // Atau cukup set oninput langsung
          input.oninput = function() {
             markPksDirty();
          };
        });
      }

      /* --- LOAD DATA PKS (FIXED: Prioritas Data Tersimpan) --- */
      function loadPksData(forceRefresh = false) {
        const token = localStorage.getItem('userToken');
        
        // Kunci Tombol saat Loading
        const btnSimpan = document.getElementById('btnSimpanPks');
        const btnGen = document.getElementById('btnGenPks');
        
        if(btnSimpan) btnSimpan.disabled = true;
        if(btnGen) {
          btnGen.disabled = true;
          btnGen.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sinkronisasi...';
        }

        // Reset UI Tombol Hasil
        resetTombolPks();

        // Callback sukses load data
        const onDataLoaded = (savedData, sekolahData) => {
            // Gabungkan data: Saved > Sekolah > Default
            applyPksData(savedData, sekolahData);
            
            // Restore status tombol hasil file jika ada ID nya
            if (savedData.pdfId && savedData.pdfId !== "") {
               tampilkanTombolHasilPks(savedData.pdfId, savedData.docId);
            } else {
               // Kembalikan tombol generate ke default
               if(btnGen) {
                 btnGen.innerHTML = '<i class="fas fa-cog me-2"></i> Generate PDF';
                 btnGen.className = 'btn btn-success flex-grow-1';
               }
            }

            // Unlock tombol
            if(btnSimpan) btnSimpan.disabled = false;
            if(btnGen) btnGen.disabled = false;
            
            // Set status bersih karena baru diload dari server
            markPksClean();
            
            // Pasang listener untuk mendeteksi ketikan user setelah data dimuat
            attachPksListeners();
            
            Swal.close();
        };

        // CEK CACHE DULU
        if (!forceRefresh && DATA_CACHE.pks && DATA_CACHE.sekolah) {
            onDataLoaded(DATA_CACHE.pks, DATA_CACHE.sekolah);
            return;
        }

        Swal.fire({
          toast: true, position: 'top-end', showConfirmButton: false,
          title: 'Sinkronisasi Data...', didOpen: () => Swal.showLoading()
        });

        // FETCH KE SERVER
        google.script.run
          .withFailureHandler((err) => {
             Swal.close();
             handleServerError(err);
             if(btnSimpan) btnSimpan.disabled = false;
             if(btnGen) { btnGen.disabled = false; btnGen.innerHTML = 'Generate PDF'; }
          })
          .withSuccessHandler(function(resPks){
            const saved = (resPks && resPks.status === 'success') ? resPks.data : {};
            DATA_CACHE.pks = saved;

            // Cek Data Sekolah di Cache
            if(DATA_CACHE.sekolah) {
              onDataLoaded(saved, DATA_CACHE.sekolah);
            } else {
              // Jika data sekolah belum ada, fetch juga
              google.script.run.withSuccessHandler(function(resSekolah){
                if(resSekolah && resSekolah.status === 'success') {
                  DATA_CACHE.sekolah = resSekolah.data; 
                  onDataLoaded(saved, resSekolah.data);
                }
              }).getDataSekolah(token);
            }
          })
          .getDataPKS(token);
      }

      /* --- 2. UPDATE: APPLY DATA & SYNC KE TAB LAIN --- */
      function applyPksData(saved, defaults) {
        const valNama = (saved.namaLengkap && saved.namaLengkap !== "") ? saved.namaLengkap : (defaults.namaSekolah || "");
        document.getElementById('pksNamaLengkap').value = valNama;

        const valBos = (saved.danaBos && saved.danaBos !== "") ? saved.danaBos : (defaults.danaBOS || "");
        document.getElementById('pksDanaBos').value = valBos;

        let defaultAlamat = `${defaults.alamat || ''}, ${defaults.kelurahan || ''}, ${defaults.kecamatan || ''}, ${defaults.kabupaten || ''}, ${defaults.provinsi || ''}`;
        defaultAlamat = defaultAlamat.replace(/^, |, $/g, '').replace(/, ,/g, ',').replace(/, ,/g, ',');
        const valAlamat = (saved.alamat && saved.alamat !== "") ? saved.alamat : defaultAlamat;
        document.getElementById('pksAlamat').value = valAlamat;

        // LOGIKA TAHUN & JUMLAH (Update agar bisa diedit & diprioritaskan)
        const valTahun = (saved.tahun && saved.tahun !== "") ? saved.tahun : (defaults.tahunAnggaran || "");
        document.getElementById('pksTahun').value = valTahun; // Hapus atribut readonly di HTML jika masih ada

        const rawJumlah = (saved.jumlah && saved.jumlah !== "") ? saved.jumlah : (defaults.jumlahAnggaran || 0);
        document.getElementById('pksJumlah').value = formatRupiahJS(rawJumlah);

        // Isi data inputan manual PKS
        document.getElementById('pksNamaSingkat').value = saved.namaSingkat || '';
        document.getElementById('pksNomorPks').value = saved.nomorPks || '';
        document.getElementById('pksNomorSurat').value = saved.nomorSurat || '';
        document.getElementById('pksTanggal').value = saved.tanggalPks || '';
        document.getElementById('pksNoRek').value = saved.noRek || '';
        document.getElementById('pksNamaRek').value = saved.namaRek || '';
        document.getElementById('pksKamad').value = defaults.namaKepala || '';

        // [BARU] SINKRONISASI KE TAB LAIN (PERMOHONAN, KUITANSI, SPTJM)
        syncPksToOthers();
      }

      /* --- FUNGSI TRIGGER SYNC (Panggil ini saat mengetik) --- */
      function triggerSyncPKS() {
        const tahun = document.getElementById('pksTahun').value;
        // Ambil raw value (hapus Rp dan titik) untuk logika, tapi tetap format untuk tampilan
        const jumlahRaw = cleanRibuan(document.getElementById('pksJumlah').value);
        
        syncPksToOthers();
      }

      /* --- FIX FINAL: GENERATE PKS (ID SUDAH SESUAI) --- */
      function generatePks(e) {
        if (e) e.preventDefault(); // Mencegah reload halaman
        
        // 1. AMBIL DATA FORM (Gunakan fungsi helper yang ID-nya sudah pasti benar)
        // Ini perbaikan utamanya: menggunakan ambilFormPks() mencegah error null
        const form = ambilFormPks(); 
        
        const token = localStorage.getItem('userToken');

        // 2. Cek apakah file lama sudah ada (untuk konfirmasi timpa)
        // Pastikan ID 'valPksPdfId' ada di HTML (biasanya input hidden)
        const elFileLama = document.getElementById('valPksPdfId');
        const fileLamaAda = elFileLama && elFileLama.value !== "";
        
        let judul = 'Generate PKS?';
        let pesan = "Pastikan data PKS sudah benar sebelum membuat dokumen.";
        let warna = '#198754'; // Hijau
        let teksTombol = 'Ya, Buat PKS';

        if (fileLamaAda) {
          judul = 'Generate Ulang?';
          pesan = "File <b>PKS</b> lama akan <b>DIHAPUS</b> dan diganti dengan yang baru. Lanjutkan?";
          warna = '#dc3545'; // Kuning
          teksTombol = 'Ya, Ganti File';
        }

        // 3. Tampilkan Popup Konfirmasi Awal
        Swal.fire({
          title: judul,
          html: pesan,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: teksTombol,
          confirmButtonColor: warna,
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            
            // 4. Tampilkan Loading Overlay (Layar Penuh)
            Swal.fire({
              title: 'Sedang Memproses...',
              html: 'Sedang membuat dokumen PKS...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // 5. Jalankan Script Google
            google.script.run
              .withFailureHandler(function(err){
                Swal.fire('Gagal', err.message, 'error');
              })
              .withSuccessHandler(function(res){
                if(res.status === 'success') {
                  
                  // Simpan ke Cache Lokal (Agar data tidak hilang saat pindah menu)
                  if (typeof DATA_CACHE !== 'undefined') {
                    if (!DATA_CACHE.pks) DATA_CACHE.pks = {};
                    DATA_CACHE.pks = { ...DATA_CACHE.pks, ...form, pdfId: res.pdfId, docId: res.docId };
                  }
                  
                  // Update UI: Isi Hidden Input & Munculkan Tombol Hasil
                  // Fungsi ini (tampilkanTombolHasilPks) sudah ada di kode asli Anda
                  if (typeof tampilkanTombolHasilPks === 'function') {
                      tampilkanTombolHasilPks(res.pdfId, res.docId);
                  }

                  // Tampilkan Pesan Sukses
                  Swal.fire({
                    icon: 'success', 
                    title: 'Berhasil!', 
                    text: 'Dokumen PKS telah selesai dibuat.', 
                    confirmButtonText: 'Buka PDF',
                    showCancelButton: true,
                    cancelButtonText: 'Tutup'
                  }).then((r) => {
                    if(r.isConfirmed) window.open(res.url, '_blank');
                  });

                } else {
                  Swal.fire('Gagal', res.message, 'error');
                }
              })
              // PENTING: Parameter ke-2 'PKS' dan ke-3 'form' harus sesuai urutan
              .generateBerkasPencairan(token, 'PKS', form);
          }
        });
      }

      /* --- UPDATE: GENERATE PKS DENGAN SWAL LOADING --- */
      function jalankanProsesGenerate(token, form) {
        // Cek ID File lama
        const fileLamaAda = document.getElementById('valPksPdfId').value !== "";
        
        let judul = 'Generate PKS?';
        let pesan = "Pastikan data sudah benar. File PDF akan dibuat.";
        let warna = '#198754';
        let teksTombol = 'Ya, Buat PDF';

        if (fileLamaAda) {
          judul = 'Generate Ulang?';
          pesan = "File PKS lama akan <b>DIHAPUS</b> dan diganti dengan yang baru. Lanjutkan?";
          warna = '#ffc107'; 
          teksTombol = 'Ya, Ganti File';
        }

        Swal.fire({
          title: judul,
          html: pesan,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: teksTombol,
          confirmButtonColor: warna,
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            
            // [PERBAIKAN] Tampilkan Loading Box seperti Cetak PDF
            Swal.fire({
              title: 'Sedang Memproses...',
              html: 'Sedang membuat dokumen PKS...',
              allowOutsideClick: false,
              didOpen: () => { Swal.showLoading() }
            });

            google.script.run
              .withFailureHandler(function(err){
                // Pesan Loading akan tertimpa otomatis oleh Swal Error
                Swal.fire('Gagal', err.message, 'error');
              })
              .withSuccessHandler(function(res){
                if(res.status === 'success') {
                  
                  // Update Cache Lokal
                  if (!DATA_CACHE.pks) DATA_CACHE.pks = {};
                  DATA_CACHE.pks = { ...DATA_CACHE.pks, ...form, pdfId: res.pdfId, docId: res.docId };

                  // Update UI
                  tampilkanTombolHasilPks(res.pdfId, res.docId);

                  // Tampilkan Pesan Sukses (Menimpa Loading)
                  Swal.fire({
                    icon: 'success', title: 'Berhasil!',
                    text: 'Dokumen PKS telah selesai dibuat.',
                    confirmButtonText: 'Buka PDF',
                    showCancelButton: true,
                    cancelButtonText: 'Tutup'
                  }).then((r) => {
                    if(r.isConfirmed) window.open(res.url, '_blank');
                  });

                } else {
                  Swal.fire('Gagal', res.message, 'error');
                }
              })
              .generateBerkasPencairan(token, 'PKS', form);
          }
        });
      }

      /* --- UTILS --- */
      /* --- 1. UPDATE: AMBIL FORM PKS (Tambahkan tahun & jumlah) --- */
      function ambilFormPks() {
        return {
          namaLengkap: document.getElementById('pksNamaLengkap').value,
          danaBos: document.getElementById('pksDanaBos').value,
          alamat: document.getElementById('pksAlamat').value,
          
          // [BARU] Ambil Tahun & Jumlah (Bersihkan format Rp)
          tahun: document.getElementById('pksTahun').value,
          jumlah: cleanRibuan(document.getElementById('pksJumlah').value),

          namaSingkat: document.getElementById('pksNamaSingkat').value,
          nomorPks: document.getElementById('pksNomorPks').value,
          nomorSurat: document.getElementById('pksNomorSurat').value,
          tanggalPks: document.getElementById('pksTanggal').value,
          noRek: document.getElementById('pksNoRek').value,
          namaRek: document.getElementById('pksNamaRek').value
        };
      }

      function resetTombolPks() {
        document.getElementById('btnLihatPksPdf').classList.add('hidden');
        document.getElementById('btnUnduhPksWord').classList.add('hidden');
        document.getElementById('valPksPdfId').value = "";
        document.getElementById('valPksDocId').value = "";
        
        const btnGen = document.getElementById('btnGenPks');
        if(btnGen) {
            btnGen.innerHTML = '<i class="fas fa-cog me-2"></i> Generate PDF';
            btnGen.className = 'btn btn-success flex-grow-1';
        }
      }

      function tampilkanTombolHasilPks(pdfId, docId) {
        document.getElementById('valPksPdfId').value = pdfId;
        document.getElementById('valPksDocId').value = docId;

        document.getElementById('btnLihatPksPdf').classList.remove('hidden');
        document.getElementById('btnUnduhPksWord').classList.remove('hidden');

        const btnGen = document.getElementById('btnGenPks');
        if(btnGen) {
            btnGen.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Generate Ulang';
            btnGen.className = 'btn btn-warning flex-grow-1';
        }
      }

      /* --- FUNGSI GENERATE PERMOHONAN (DENGAN KONFIRMASI) --- */
      function generatePermohonan(e) {
        e.preventDefault();

        // 1. Cek apakah File Lama sudah ada? (Cek visibilitas tombol PDF)
        const btnLihat = document.getElementById('btnLihatPmPdf');
        const fileAda = !btnLihat.classList.contains('hidden');

        // Definisi Proses Inti Generate
        const prosesGenerate = () => {
          const token = localStorage.getItem('userToken');
          
          // Ambil Data dari Form
          const formData = {
            nomorPks: document.getElementById('pmNomorPks').value,
            namaSekolah: document.getElementById('pmNamaSekolah').value,
            danaBos: document.getElementById('pmDanaBos').value,
            tahun: document.getElementById('pmTahun').value,
            jumlah: document.getElementById('pmJumlahVal').value, // Ambil value angka murni
            nomorSurat: document.getElementById('pmNomorSurat').value,
            tempat: document.getElementById('pmTempat').value,
            tanggal: document.getElementById('pmTanggal').value
          };

          // Validasi Input
          if (!formData.nomorSurat || !formData.tempat || !formData.tanggal) {
            Swal.fire('Data Belum Lengkap', 'Nomor Surat, Tempat, dan Tanggal wajib diisi.', 'warning');
            return;
          }

          // Tampilkan Loading
          Swal.fire({ 
            title: 'Memproses...', 
            html: 'Sedang membuat dokumen Permohonan...', 
            allowOutsideClick: false, 
            didOpen: () => Swal.showLoading() 
          });

          // Kirim ke Server
          google.script.run
            .withFailureHandler((err) => { Swal.fire('Gagal', err.message, 'error'); })
            .withSuccessHandler((res) => {
              if (res.status === 'success') {
                // Update UI: Simpan ID File & Munculkan Tombol Lihat
                document.getElementById('valPmPdfId').value = res.pdfId;
                document.getElementById('valPmDocId').value = res.docId;
                
                // Helper manual untuk menampilkan tombol (jika updateBtnView tdk tersedia untuk ID ini)
                const btnView = document.getElementById('btnLihatPmPdf');
                btnView.classList.remove('hidden');
                
                Swal.fire({ 
                  icon: 'success', 
                  title: 'Berhasil', 
                  text: 'Surat Permohonan berhasil dibuat!',
                  confirmButtonText: 'Buka PDF',
                  showCancelButton: true,
                  cancelButtonText: 'Tutup'
                }).then((r) => {
                  if (r.isConfirmed) window.open(res.url, '_blank');
                });
              } else {
                Swal.fire('Gagal', res.message, 'error');
              }
            })
            .generateBerkasPencairan(token, 'PERMOHONAN', formData);
        };

        // 2. Logika Konfirmasi
        if (fileAda) {
          Swal.fire({
            title: 'Ganti File Lama?',
            html: "File <b>Permohonan</b> lama akan <b>DIHAPUS</b> dan diganti dengan yang baru. Lanjutkan?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545', // Merah
            cancelButtonColor: '#6c757d', // Abu-abu
            confirmButtonText: 'Ya, Ganti File',
            cancelButtonText: 'Batal'
          }).then((result) => {
            if (result.isConfirmed) {
              prosesGenerate();
            }
          });
        } else {
          // Jika belum ada file, langsung gas
          prosesGenerate();
        }
      }

      /* --- UPDATE: FUNGSI CEK STATUS FILE PERMOHONAN --- */
      function cekStatusFilePermohonan() {
        const token = localStorage.getItem('userToken');
        const btnGen = document.getElementById('btnGenPermohonan');
        
        // Set default state tombol generate (jika loading)
        // btnGen.disabled = true; 
        
        google.script.run
          .withSuccessHandler(function(res) {
            // btnGen.disabled = false;
            if (res.status === 'success') {
              const d = res.data;
              
              // Cek apakah PDF Permohonan sudah ada
              if (d.PERMOHONAN_PDF && d.PERMOHONAN_PDF !== "") {
                // 1. Simpan ID ke Hidden Input
                document.getElementById('valPmPdfId').value = d.PERMOHONAN_PDF;
                document.getElementById('valPmDocId').value = d.PERMOHONAN_DOC; // Opsional
                
                // 2. Munculkan Tombol Lihat & Unduh
                document.getElementById('btnLihatPmPdf').classList.remove('hidden');
                document.getElementById('btnUnduhPmWord').classList.remove('hidden');
                
                // 3. Ubah Tombol Generate menjadi "Generate Ulang" (Kuning)
                btnGen.className = 'btn btn-warning flex-grow-1';
                btnGen.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Generate Ulang';
              } else {
                // Jika belum ada, pastikan tombol hidden & Generate Hijau
                document.getElementById('btnLihatPmPdf').classList.add('hidden');
                document.getElementById('btnUnduhPmWord').classList.add('hidden');
                btnGen.className = 'btn btn-success flex-grow-1';
                btnGen.innerHTML = '<i class="fas fa-cog me-2"></i> Generate PDF';
              }
            }
          })
          .getDokumenPendukungStatus(token);
      }

      function bukaFilePermohonan(tipe) {
        const id = (tipe === 'PDF') ? document.getElementById('valPmPdfId').value : document.getElementById('valPmDocId').value;
        if(id) {
          window.open("https://drive.google.com/file/d/" + id + "/view?usp=sharing", "_blank");
        } else {
          Swal.fire('Error', 'File belum digenerate.', 'error');
        }
      }

      // 1. Tambahkan Fungsi Simpan Manual
      // Cari fungsi simpanPermohonan() dan GANTI dengan kode ini:
      function simpanPermohonan() {
        const token = localStorage.getItem('userToken');
        
        // 1. Ambil Data dari Form
        const form = {
          nomorSurat: document.getElementById('pmNomorSurat').value,
          tempat: document.getElementById('pmTempat').value,
          tanggal: document.getElementById('pmTanggal').value
        };

        // 2. Validasi Sederhana
        if (!form.nomorSurat || !form.tempat || !form.tanggal) {
          Swal.fire('Peringatan', 'Mohon lengkapi Nomor Surat, Tempat, dan Tanggal.', 'warning');
          return;
        }

        // 3. Efek Loading Tombol (Menampilkan "Menyimpan...")
        const btn = document.getElementById('btnSimpanPermohonan');
        const txtAsli = btn.innerHTML; // Simpan teks asli ("Simpan Data")
        
        // Ubah jadi Spinner + Teks Menyimpan
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true; // Matikan tombol agar tidak bisa diklik lagi

        // 4. Kirim ke Server
        google.script.run
          .withFailureHandler(function(err) {
            // Jika Gagal: Kembalikan tombol & Munculkan Error
            btn.innerHTML = txtAsli;
            btn.disabled = false;
            Swal.fire('Gagal', err.message, 'error');
          })
          .withSuccessHandler(function(res) {
            // Jika Sukses: Kembalikan tombol & Munculkan Notifikasi
            btn.innerHTML = txtAsli;
            btn.disabled = false;
            
            if (res.status === 'success') {
              // Optional: Update Cache jika diperlukan
              if (typeof DATA_CACHE !== 'undefined' && DATA_CACHE.pencairan_lengkap && DATA_CACHE.pencairan_lengkap.permohonan) {
                  DATA_CACHE.pencairan_lengkap.permohonan.nomorSurat = form.nomorSurat;
                  DATA_CACHE.pencairan_lengkap.permohonan.tempat = form.tempat;
                  DATA_CACHE.pencairan_lengkap.permohonan.tanggal = form.tanggal;
              }
              
              Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Data Permohonan Disimpan',
                showConfirmButton: false,
                timer: 1500
              });
            } else {
              Swal.fire('Gagal', res.message, 'error');
            }
          })
          .simpanDataPermohonan(token, form);
      }

      // 2. Tambahkan Fungsi Load Data
      function loadPermohonanData() {
        const token = localStorage.getItem('userToken');
        
        // Set loading state ringan (opsional) atau biarkan silent
        google.script.run
          .withSuccessHandler(function(res) {
            if(res.status === 'success') {
              const d = res.data;
              // Hanya isi jika field masih kosong (agar tidak menimpa ketikan user saat refresh cepat)
              // Atau timpa saja karena ini load awal tab
              if(d.nomorSurat) document.getElementById('pmNomorSurat').value = d.nomorSurat;
              if(d.tempat) document.getElementById('pmTempat').value = d.tempat;
              if(d.tanggal) document.getElementById('pmTanggal').value = d.tanggal;
            }
          })
          .getDataPermohonan(token);
      }

      /* --- FUNGSI JAVASCRIPT KUITANSI --- */

      // 1. Load Data Tersimpan
      function loadKuitansiData() {
        const token = localStorage.getItem('userToken');
        google.script.run.withSuccessHandler(function(res) {
            if(res.status === 'success') {
              const d = res.data;
              if(d.nomorSurat) document.getElementById('kwNomorSurat').value = d.nomorSurat;
              if(d.tempat) document.getElementById('kwTempat').value = d.tempat;
              if(d.tanggal) document.getElementById('kwTanggal').value = d.tanggal;
            }
          }).getDataKuitansi(token);
      }

      // 2. Simpan Data Manual
      // Cari fungsi simpanKuitansi() dan GANTI dengan kode ini:
      function simpanKuitansi() {
        const token = localStorage.getItem('userToken');
        
        // 1. Ambil Data dari Form
        const form = {
          nomorSurat: document.getElementById('kwNomorSurat').value,
          tempat: document.getElementById('kwTempat').value,
          tanggal: document.getElementById('kwTanggal').value
        };

        // 2. Validasi Sederhana
        if (!form.nomorSurat || !form.tempat || !form.tanggal) {
          Swal.fire('Peringatan', 'Mohon lengkapi Nomor Kuitansi, Tempat, dan Tanggal.', 'warning');
          return;
        }

        // 3. Efek Loading Tombol (Menampilkan "Menyimpan...")
        const btn = document.getElementById('btnSimpanKuitansi');
        const txtAsli = btn.innerHTML; // Simpan teks asli
        
        // Ubah jadi Spinner + Teks Menyimpan
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        // 4. Kirim ke Server
        google.script.run
          .withFailureHandler(function(err) {
            btn.innerHTML = txtAsli;
            btn.disabled = false;
            Swal.fire('Gagal', err.message, 'error');
          })
          .withSuccessHandler(function(res) {
            btn.innerHTML = txtAsli;
            btn.disabled = false;
            
            if (res.status === 'success') {
              // Optional: Update Cache
              if (typeof DATA_CACHE !== 'undefined' && DATA_CACHE.pencairan_lengkap && DATA_CACHE.pencairan_lengkap.kuitansi) {
                  DATA_CACHE.pencairan_lengkap.kuitansi.nomorSurat = form.nomorSurat;
                  DATA_CACHE.pencairan_lengkap.kuitansi.tempat = form.tempat;
                  DATA_CACHE.pencairan_lengkap.kuitansi.tanggal = form.tanggal;
              }
              
              Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Data Kuitansi Disimpan',
                showConfirmButton: false,
                timer: 1500
              });
            } else {
              Swal.fire('Gagal', res.message, 'error');
            }
          })
          .simpanDataKuitansi(token, form);
      }

      /* --- FUNGSI GENERATE KUITANSI (DENGAN KONFIRMASI) --- */
      function generateKuitansi(e) {
        e.preventDefault();

        // 1. Cek apakah File Lama sudah ada?
        const btnLihat = document.getElementById('btnLihatKwPdf');
        const fileAda = !btnLihat.classList.contains('hidden');

        // Definisi Proses Inti Generate
        const prosesGenerate = () => {
          const token = localStorage.getItem('userToken');
          
          // Ambil Data dari Form
          const formData = {
            nomorPks: document.getElementById('kwNomorPks').value,
            tanggalPks: document.getElementById('kwTanggalPksVal').value, // Value raw date
            tahun: document.getElementById('kwTahun').value,
            jumlah: document.getElementById('kwJumlahVal').value, // Value angka murni
            nomorSurat: document.getElementById('kwNomorSurat').value,
            tempat: document.getElementById('kwTempat').value,
            tanggal: document.getElementById('kwTanggal').value
          };

          // Validasi Input
          if (!formData.nomorSurat || !formData.tempat || !formData.tanggal) {
            Swal.fire('Data Belum Lengkap', 'Nomor Kuitansi, Tempat, dan Tanggal wajib diisi.', 'warning');
            return;
          }

          // Tampilkan Loading
          Swal.fire({ 
            title: 'Memproses...', 
            html: 'Sedang membuat Kuitansi...', 
            allowOutsideClick: false, 
            didOpen: () => Swal.showLoading() 
          });

          // Kirim ke Server
          google.script.run
            .withFailureHandler((err) => { Swal.fire('Gagal', err.message, 'error'); })
            .withSuccessHandler((res) => {
              if (res.status === 'success') {
                // Update UI: Simpan ID File & Munculkan Tombol Lihat
                document.getElementById('valKwPdfId').value = res.pdfId;
                document.getElementById('valKwDocId').value = res.docId;
                
                const btnView = document.getElementById('btnLihatKwPdf');
                btnView.classList.remove('hidden');
                
                Swal.fire({ 
                  icon: 'success', 
                  title: 'Berhasil', 
                  text: 'Kuitansi berhasil dibuat!',
                  confirmButtonText: 'Buka PDF',
                  showCancelButton: true,
                  cancelButtonText: 'Tutup'
                }).then((r) => {
                  if (r.isConfirmed) window.open(res.url, '_blank');
                });
              } else {
                Swal.fire('Gagal', res.message, 'error');
              }
            })
            .generateBerkasPencairan(token, 'KUITANSI', formData);
        };

        // 2. Logika Konfirmasi
        if (fileAda) {
          Swal.fire({
            title: 'Ganti File Lama?',
            html: "File <b>Kuitansi</b> lama akan <b>DIHAPUS</b> dan diganti dengan yang baru. Lanjutkan?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Ya, Ganti File',
            cancelButtonText: 'Batal'
          }).then((result) => {
            if (result.isConfirmed) {
              prosesGenerate();
            }
          });
        } else {
          prosesGenerate();
        }
      }

      // 4. Buka File
      function bukaFileKuitansi(tipe) {
        const id = (tipe === 'PDF') ? document.getElementById('valKwPdfId').value : document.getElementById('valKwDocId').value;
        if(id) window.open("https://drive.google.com/file/d/" + id + "/view?usp=sharing", "_blank");
        else Swal.fire('Error', 'File belum digenerate.', 'error');
      }

      /* --- UPDATE: FUNGSI CEK STATUS FILE KUITANSI --- */
      function cekStatusFileKuitansi() {
        const token = localStorage.getItem('userToken');
        const btnGen = document.getElementById('btnGenKuitansi');
        
        google.script.run
          .withSuccessHandler(function(res) {
            if (res.status === 'success') {
              const d = res.data;
              
              // Cek apakah PDF Kuitansi sudah ada
              if (d.KUITANSI_PDF && d.KUITANSI_PDF !== "") {
                // 1. Simpan ID
                document.getElementById('valKwPdfId').value = d.KUITANSI_PDF;
                document.getElementById('valKwDocId').value = d.KUITANSI_DOC;
                
                // 2. Munculkan Tombol
                document.getElementById('btnLihatKwPdf').classList.remove('hidden');
                document.getElementById('btnUnduhKwWord').classList.remove('hidden');
                
                // 3. Ubah Style Tombol Generate
                btnGen.className = 'btn btn-warning flex-grow-1';
                btnGen.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Generate Ulang';
              } else {
                // Reset Default
                document.getElementById('btnLihatKwPdf').classList.add('hidden');
                document.getElementById('btnUnduhKwWord').classList.add('hidden');
                btnGen.className = 'btn btn-success flex-grow-1';
                btnGen.innerHTML = '<i class="fas fa-cog me-2"></i> Generate PDF';
              }
            }
          })
          .getDokumenPendukungStatus(token);
      }

      /* --- [FIX] PERBAIKAN FUNGSI TOMBOL PKS --- */

      // 1. Fungsi Wrapper untuk Tombol Simpan
      function simpanPks() {
        // Memanggil fungsi simpanDataPksSaja yang sudah ada di logika script
        if (typeof simpanDataPksSaja === 'function') {
          simpanDataPksSaja();
        } else {
          Swal.fire('Error', 'Fungsi penyimpanan data PKS tidak ditemukan (simpanDataPksSaja).', 'error');
        }
      }

      // 2. Fungsi untuk Membuka File PDF/Word (Mengatasi ReferenceError)
      function bukaFilePks(tipe) {
        let id = "";
        
        // Ambil ID dari input hidden sesuai tipe
        if (tipe === 'PDF') {
          id = document.getElementById('valPksPdfId').value;
        } else if (tipe === 'WORD') {
          id = document.getElementById('valPksDocId').value;
        }

        // Validasi ID
        if (id && id.trim() !== "") {
          // Buka file di tab baru
          window.open("https://drive.google.com/file/d/" + id + "/view?usp=sharing", "_blank");
        } else {
          Swal.fire({
            icon: 'warning',
            title: 'File Tidak Ditemukan',
            text: 'Dokumen belum dibuat. Silakan klik tombol "Generate PKS" terlebih dahulu.'
          });
        }
      }

      /* --- FUNGSI AGREGATOR PENCAIRAN (NEW) --- */
      function loadAllPencairanData(forceRefresh = false, targetTab = 'pks') {
        // Cek apakah data pencairan sudah ada di cache global?
        // Kita cek properti khusus 'pencairan_lengkap' agar tidak bentrok dengan cache parsial lama
        if (!forceRefresh && DATA_CACHE.pencairan_lengkap) {
          renderTabPencairan(targetTab);
          return;
        }

        const containerId = 'panel-berkas-pencairan';

        // 1. KUNCI UI
        toggleContainerInputs(containerId, true);
        Swal.fire({
          toast: true, position: 'top-end', showConfirmButton: false,
          title: 'Sinkronisasi Berkas Pencairan...', didOpen: () => Swal.showLoading()
        });

        const token = localStorage.getItem('userToken');

        google.script.run
          .withFailureHandler((err) => {
            Swal.close();
            handleServerError(err);
            toggleContainerInputs(containerId, false);
          })
          .withSuccessHandler(function(res) {
            // 2. BUKA KUNCI UI
            toggleContainerInputs(containerId, false);
            Swal.close();

            if (res && res.status === 'success') {
              // SIMPAN KE CACHE GLOBAL
              // Kita simpan strukturnya agar mudah diakses
              DATA_CACHE.pencairan_lengkap = res.data;
              
              // Simpan juga ke cache spesifik untuk kompatibilitas fungsi lama
              DATA_CACHE.sekolah = res.data.sekolah;
              DATA_CACHE.pks = res.data.pks; 
              // Tambahkan ID file PKS ke objek PKS di cache agar tombol muncul
              DATA_CACHE.pks.pdfId = res.data.fileStatus.PKS_PDF; 
              DATA_CACHE.pks.docId = res.data.fileStatus.PKS_DOC;

              // Render tab yang diminta
              renderTabPencairan(targetTab);

              const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 1500
              });
              Toast.fire({ icon: 'success', title: 'Data Pencairan Siap' });

            } else {
              Swal.fire('Gagal', res.message || 'Gagal memuat data pencairan', 'error');
            }
          })
          .getAllPencairanData(token);
      }

      function renderTabPencairan(tabName) {
        const d = DATA_CACHE.pencairan_lengkap;
        if (!d) return;
        const files = d.fileStatus || {};

        // [LOGIC BARU] Prioritas Data dari PKS (d.pks.tahun / d.pks.jumlah)
        // Jika PKS belum disetting, baru ambil dari Data Sekolah
        const pksTahun = d.pks.tahun || d.sekolah.tahunAnggaran || "";
        const pksJumlah = (d.pks.jumlah !== undefined && d.pks.jumlah !== "") ? d.pks.jumlah : (d.sekolah.jumlahAnggaran || 0);

        // --- RENDER SESUAI TAB ---
        if (tabName === 'pks') {
          if (files.PKS_PDF) tampilkanTombolHasilPks(files.PKS_PDF, files.PKS_DOC);
          else resetTombolPks();
          applyPksData(d.pks, d.sekolah);
          
          // Pastikan input PKS terisi data yang benar
          document.getElementById('pksTahun').value = pksTahun;
          document.getElementById('pksJumlah').value = formatRupiahJS(pksJumlah);
          
          attachPksListeners(); 

        } else if (tabName === 'permohonan') {
          updateBtnViewPencairan('btnLihatPmPdf', 'btnUnduhPmWord', 'btnGenPermohonan', 'valPmPdfId', 'valPmDocId', files.PERMOHONAN_PDF, files.PERMOHONAN_DOC);
          
          // Data Read-Only (Update disini agar mengikuti PKS)
          document.getElementById('pmNomorPks').value = d.pks.nomorPks || '';
          document.getElementById('pmNamaSekolah').value = d.pks.namaLengkap || d.sekolah.namaSekolah || '';
          document.getElementById('pmDanaBos').value = d.pks.danaBos || d.sekolah.danaBOS || '';
          
          // [UPDATE] Gunakan data dari PKS
          document.getElementById('pmTahun').value = pksTahun; 
          document.getElementById('pmJumlah').value = formatRupiahJS(pksJumlah);
          document.getElementById('pmJumlahVal').value = pksJumlah;

          // Data User Input
          const pm = d.permohonan || {};
          if(pm.nomorSurat) document.getElementById('pmNomorSurat').value = pm.nomorSurat;
          if(pm.tempat) document.getElementById('pmTempat').value = pm.tempat;
          if(pm.tanggal) document.getElementById('pmTanggal').value = pm.tanggal;

        } else if (tabName === 'kuitansi') {
          updateBtnViewPencairan('btnLihatKwPdf', 'btnUnduhKwWord', 'btnGenKuitansi', 'valKwPdfId', 'valKwDocId', files.KUITANSI_PDF, files.KUITANSI_DOC);
          
          // Data Referensi PKS
          document.getElementById('kwNomorPks').value = d.pks.nomorPks || '';
          document.getElementById('kwTanggalPks').value = formatTanggalIndo(d.pks.tanggalPks);
          document.getElementById('kwTanggalPksVal').value = d.pks.tanggalPks;
          
          // [UPDATE] Gunakan data dari PKS
          document.getElementById('kwTahun').value = pksTahun;
          document.getElementById('kwJumlah').value = formatRupiahJS(pksJumlah);
          document.getElementById('kwJumlahVal').value = pksJumlah;

          // Data User Input
          const kw = d.kuitansi || {};
          if(kw.nomorSurat) document.getElementById('kwNomorSurat').value = kw.nomorSurat;
          if(kw.tempat) document.getElementById('kwTempat').value = kw.tempat;
          if(kw.tanggal) document.getElementById('kwTanggal').value = kw.tanggal;

        } else if (tabName === 'sptjm') {
            
            // SETUP TOMBOL
            const pdfId = files.SPTJM_PDF || d.sptjm.pdfId;
            const docId = files.SPTJM_DOC || d.sptjm.docId;
            updateBtnViewPencairan('btnLihatSptjmPdf', 'btnUnduhSptjmWord', 'btnGenSptjm', 'valSptjmPdfId', 'valSptjmDocId', pdfId, docId);

            // --- [LOGIKA BARU: PRIORITAS DATA PKS] ---
            
            // 1. Nama Sekolah: Ambil dari PKS jika ada, jika tidak ambil dari Data Sekolah
            const namaSekolahPks = d.pks ? (d.pks.namaLengkap || d.pks.namaSekolah) : '';
            const namaSekolahDef = d.sekolah.namaSekolah || '';
            // Isi ke input form (pastikan ID input di HTML adalah 'sptjmNamaSekolah')
            document.getElementById('sptjmNamaSekolah').value = namaSekolahPks || namaSekolahDef;

            // 2. Alamat Lengkap: Ambil dari PKS jika ada
            let alamatLengkap = '';
            if (d.pks && d.pks.alamat && d.pks.alamat !== "") {
                alamatLengkap = d.pks.alamat;
            } else {
                // Fallback ke Data Sekolah
                alamatLengkap = d.sekolah.alamat || '';
                if (d.sekolah.kecamatan) alamatLengkap += ', ' + d.sekolah.kecamatan;
                if (d.sekolah.kabupaten) alamatLengkap += ', ' + d.sekolah.kabupaten;
            }
            document.getElementById('sptjmAlamat').value = alamatLengkap;

            // 3. Nama Kepala (Read Only / Default)
            document.getElementById('sptjmNamaKepala').value = d.sekolah.namaKepala || '';
            document.getElementById('sptjmTahun').value = pksTahun || new Date().getFullYear();

            // 4. Data Isian User (NIK, Tempat, Tanggal) - Ambil dari cache tersimpan
            const sp = d.sptjm || {};
            document.getElementById('sptjmNik').value = sp.nik || '';
            document.getElementById('sptjmTempat').value = sp.tempat || d.sekolah.tempatTTD || ''; // Default tempat
            
            if (sp.tanggal) document.getElementById('sptjmTanggal').value = sp.tanggal;
            else document.getElementById('sptjmTanggal').valueAsDate = new Date(); // Default hari ini
        }
      }

      // Helper kecil untuk update tombol view/download di pencairan
      function updateBtnViewPencairan(btnLihatId, btnUnduhId, btnGenId, inputPdfId, inputDocId, filePdfId, fileDocId) {
          const btnGen = document.getElementById(btnGenId);
          
          if (filePdfId && filePdfId !== "") {
              document.getElementById(inputPdfId).value = filePdfId;
              document.getElementById(inputDocId).value = fileDocId;
              document.getElementById(btnLihatId).classList.remove('hidden');
              document.getElementById(btnUnduhId).classList.remove('hidden');
              
              if(btnGen) {
                  btnGen.className = 'btn btn-warning flex-grow-1';
                  btnGen.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Generate Ulang';
              }
          } else {
              document.getElementById(btnLihatId).classList.add('hidden');
              document.getElementById(btnUnduhId).classList.add('hidden');
              if(btnGen) {
                  btnGen.className = 'btn btn-success flex-grow-1';
                  btnGen.innerHTML = '<i class="fas fa-cog me-2"></i> Generate PDF';
              }
          }
      }

      // --- LOGIKA BARU: SPTJM ---

      // 1. LOAD DATA
      function loadDataSptjm(token) {
        document.getElementById('sptjmNamaKepala').value = "Sinkronisasi...";
        
        // A. Ambil Data Sekolah (Otomatis)
        google.script.run.withSuccessHandler(function(resSekolah) {
          const ds = (resSekolah && resSekolah.status === 'success') ? resSekolah.data : {};
          
          document.getElementById('sptjmNamaKepala').value = ds.namaKepala || '-';
          // CATATAN: NIK tidak lagi diambil dari sini
          document.getElementById('sptjmNamaSekolah').value = ds.namaSekolah || '-';
          
          let alamatLengkap = ds.alamat || '';
          if (ds.kelurahan) alamatLengkap += ', ' + ds.kelurahan;
          if (ds.kecamatan) alamatLengkap += ', ' + ds.kecamatan;
          if (ds.kabupaten) alamatLengkap += ', ' + ds.kabupaten;
          document.getElementById('sptjmAlamat').value = alamatLengkap;
          
          document.getElementById('sptjmTahun').value = ds.tahunAnggaran || new Date().getFullYear();
          
          // Default Tempat TTD
          const inputTempat = document.getElementById('sptjmTempat');
          if(inputTempat.value === "") inputTempat.value = ds.tempatTTD || "";

          // B. Ambil Data Tersimpan (Termasuk NIK Manual)
          google.script.run.withSuccessHandler(function(res) {
            if (res && res.status === 'success') {
              const d = res.data;
              // Isi kembali input manual
              if (d.nik) document.getElementById('sptjmNik').value = d.nik; // <--- ISI NIK DARI DATABASE
              if (d.tempat) document.getElementById('sptjmTempat').value = d.tempat;
              if (d.tanggal) document.getElementById('sptjmTanggal').value = d.tanggal;
              
              updateBtnView('btnLihatSptjmPdf', 'valSptjmPdfId', d.pdfId);
              updateBtnView('btnUnduhSptjmWord', 'valSptjmDocId', d.docId);
            }
          }).getDataSptjm(token);

        }).getDataSekolah(token);
      }

      // 2. SIMPAN DATA (Update NIK)
      function simpanSptjm() {
        const token = localStorage.getItem('userToken');
        const form = {
          nik: document.getElementById('sptjmNik').value, // <--- SIMPAN NIK
          tempat: document.getElementById('sptjmTempat').value,
          tanggal: document.getElementById('sptjmTanggal').value
        };
        
        // Validasi sederhana
        if(!form.nik) { Swal.fire('Error', 'NIK wajib diisi!', 'warning'); return; }

        const btn = document.getElementById('btnSimpanSptjm');
        const txtAsli = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(function(res) {
          btn.innerHTML = txtAsli;
          btn.disabled = false;
          if (res.status === 'success') {
            Swal.fire({toast:true, position:'top-end', icon:'success', title:'Data Tersimpan', showConfirmButton:false, timer:1500});
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).simpanDataSptjm(token, form);
      }

      function generateSptjm(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('userToken');
        const nikVal = document.getElementById('sptjmNik').value;
        
        if(!nikVal) {
          Swal.fire('Peringatan', 'Mohon isi NIK Kepala Madrasah terlebih dahulu.', 'warning');
          return;
        }

        Swal.fire({
          title: 'Generate SPTJM?',
          text: 'Pastikan data NIK, Tempat, dan Tanggal sudah benar.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Ya, Generate',
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            
            Swal.fire({
              title: 'Memproses...',
              html: 'Sedang membuat dokumen...',
              didOpen: () => Swal.showLoading()
            });

            const formData = {
              nik: nikVal,
              tempat: document.getElementById('sptjmTempat').value,
              tanggal: document.getElementById('sptjmTanggal').value
            };

            google.script.run
              .withFailureHandler(function(err) {
                Swal.fire('Gagal', err.message, 'error');
              })
              .withSuccessHandler(function(res) {
                if (res.status === 'success') {
                  
                  // 1. UPDATE UI: Munculkan Tombol (Seperti sebelumnya)
                  updateBtnViewPencairan(
                    'btnLihatSptjmPdf',
                    'btnUnduhSptjmWord',
                    'btnGenSptjm',
                    'valSptjmPdfId',
                    'valSptjmDocId',
                    res.pdfId,
                    res.docId
                  );

                  // 2. UPDATE CACHE (INI PERBAIKANNYA)
                  // Agar saat pindah tab & kembali, data tidak hilang
                  if (typeof DATA_CACHE !== 'undefined' && DATA_CACHE.pencairan_lengkap) {
                      // Inisialisasi jika belum ada
                      if (!DATA_CACHE.pencairan_lengkap.fileStatus) {
                          DATA_CACHE.pencairan_lengkap.fileStatus = {};
                      }
                      
                      // Simpan ID File Baru ke Memory Cache
                      DATA_CACHE.pencairan_lengkap.fileStatus.SPTJM_PDF = res.pdfId;
                      DATA_CACHE.pencairan_lengkap.fileStatus.SPTJM_DOC = res.docId;
                      
                      // Update juga object SPTJM spesifik jika ada
                      if(DATA_CACHE.pencairan_lengkap.sptjm) {
                          DATA_CACHE.pencairan_lengkap.sptjm.pdfId = res.pdfId;
                          DATA_CACHE.pencairan_lengkap.sptjm.docId = res.docId;
                      }
                  }

                  // 3. Tampilkan Pesan Sukses
                  Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: 'Dokumen SPTJM berhasil dibuat.',
                    confirmButtonText: 'Buka PDF',
                    showCancelButton: true,
                    cancelButtonText: 'Tutup'
                  }).then((r) => {
                    if (r.isConfirmed) window.open(res.url, '_blank');
                  });

                } else {
                  Swal.fire('Gagal', res.message, 'error');
                }
              })
              .generateSptjm(token, formData);
          }
        });
      }

      // 4. Buka File Hasil
      /* --- PERBAIKAN FUNGSI BUKA FILE SPTJM --- */
      function bukaFileSptjm(tipe) {
        let val = "";
        
        // 1. Ambil Value dari Hidden Input yang Sesuai
        if (tipe === 'PDF') {
          val = document.getElementById('valSptjmPdfId').value;
        } else if (tipe === 'WORD') {
          val = document.getElementById('valSptjmDocId').value;
        }
        
        // 2. Validasi & Buka Link
        if (val && val.trim() !== "") {
          // Cek apakah value sudah berupa Link (URL) atau masih ID
          if (val.startsWith('http')) {
            // Jika sudah berupa URL (karena diset oleh updateBtnView), buka langsung
            window.open(val, '_blank');
          } else {
            // Jika masih berupa ID, rangkai URL-nya
            window.open("https://drive.google.com/file/d/" + val + "/view?usp=sharing", "_blank");
          }
        } else {
          Swal.fire({
            icon: 'warning',
            title: 'File Belum Ada',
            text: 'Silakan klik tombol "Generate SPTJM" terlebih dahulu.'
          });
        }
      }

      /* --- CARI KODE EVENT LISTENER UNTUK SPTJM --- */

      document.getElementById('btnLihatSptjm').addEventListener('click', function(e) {
          e.preventDefault();
          
          // --- CEK BAGIAN INI ---
          // Apakah mengambil dari 'valSptjmPdfId'?
          // Jika tertulis 'valPksPdfId', maka dia akan error atau membuka file yang salah.
          
          const pdfId = document.getElementById('valSptjmPdfId').value; 
          
          if (pdfId) {
              // Jika menggunakan window.open langsung (jika URL sudah ada)
              // window.open(url, '_blank'); 

              // ATAU jika memanggil server untuk mendapatkan URL (kemungkinan yang Anda pakai)
              google.script.run
                  .withFailureHandler(function(err) { Swal.fire('Gagal', err.message, 'error'); })
                  .withSuccessHandler(function(url) {
                      window.open(url, '_blank');
                  })
                  .getDownloadUrl(pdfId); // <--- Pastikan fungsi ini ada di Server
          } else {
              // Ini yang memicu error jika ID kosong karena langkah 1 salah
              Swal.fire('Gagal', 'File belum digenerate atau ID tidak ditemukan.', 'error');
          }
      });

      /* --- FUNGSI BARU: SINKRONISASI REALTIME PKS KE FORM LAIN --- */
      function syncPksToOthers() {
        // 1. Ambil Nilai dari Input PKS
        const tahun = document.getElementById('pksTahun').value;
        // Bersihkan format Rp untuk dapat angka murni
        const jumlahRaw = cleanRibuan(document.getElementById('pksJumlah').value); 
        const jumlahFmt = formatRupiahJS(jumlahRaw); // Format ulang ke Rp ...

        // 2. Tembak ke Input Permohonan (Jika elemen ada)
        const pmTahun = document.getElementById('pmTahun');
        const pmJumlah = document.getElementById('pmJumlah');
        const pmJumlahVal = document.getElementById('pmJumlahVal');
        
        if (pmTahun) pmTahun.value = tahun;
        if (pmJumlah) pmJumlah.value = jumlahFmt;
        if (pmJumlahVal) pmJumlahVal.value = jumlahRaw;

        // 3. Tembak ke Input Kuitansi
        const kwTahun = document.getElementById('kwTahun');
        const kwJumlah = document.getElementById('kwJumlah');
        const kwJumlahVal = document.getElementById('kwJumlahVal'); // Pastikan hidden input ini ada

        if (kwTahun) kwTahun.value = tahun;
        if (kwJumlah) kwJumlah.value = jumlahFmt;
        if (kwJumlahVal) kwJumlahVal.value = jumlahRaw;

        // 4. Tembak ke Input SPTJM
        const sptjmTahun = document.getElementById('sptjmTahun');
        if (sptjmTahun) sptjmTahun.value = tahun;
      }

      function simpanDataPksSaja() {
        const btn = document.getElementById('btnSimpanPks');
        const txt = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        const formData = {
          namaLengkap: document.getElementById('pksNamaLengkap').value,
          kamad: document.getElementById('pksKamad').value,
          danaBos: document.getElementById('pksDanaBos').value,
          
          // [PENTING] AMBIL DATA TAHUN & JUMLAH DARI INPUT PKS
          tahun: document.getElementById('pksTahun').value,
          jumlah: cleanRibuan(document.getElementById('pksJumlah').value),
          
          alamat: document.getElementById('pksAlamat').value,
          namaSingkat: document.getElementById('pksNamaSingkat').value,
          nomorPks: document.getElementById('pksNomorPks').value,
          nomorSurat: document.getElementById('pksNomorSurat').value,
          tanggalPks: document.getElementById('pksTanggal').value,
          noRek: document.getElementById('pksNoRek').value,
          namaRek: document.getElementById('pksNamaRek').value
        };

        const token = localStorage.getItem('userToken');
        google.script.run
          .withFailureHandler(function(err) {
            btn.innerHTML = txt; 
            btn.disabled = false;
            Swal.fire('Gagal', err.message, 'error');
          })
          .withSuccessHandler(function(res) {
            btn.innerHTML = txt;
            btn.disabled = false;
            if(res.status === 'success') {
              markPksClean();
              // [PENTING] Hapus Cache agar data tahun/jumlah terbaru terbaca di tab lain
              DATA_CACHE.pencairan_lengkap = null; 
              DATA_CACHE.pks = null;
              
              Swal.fire({
                toast: true, position: 'top-end', icon: 'success', 
                title: 'Data PKS Disimpan', showConfirmButton: false, timer: 1500
              });
            } else {
              Swal.fire('Gagal', res.message, 'error');
            }
          })
          .simpanDataPKS(token, formData);
      }

      /* --- TAMBAHAN FIX: FORMAT TANGGAL INDONESIA (CLIENT SIDE) --- */
      function formatTanggalIndo(dateString) {
        if (!dateString || dateString === "" || dateString === "-") return "-";
        
        // Konversi string tanggal
        var date = new Date(dateString);
        
        // Jika format input YYYY-MM-DD, parse manual agar tidak kena pergeseran Timezone
        if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            var parts = dateString.split('-');
            date = new Date(parts[0], parts[1] - 1, parts[2]);
        }
        
        // Validasi tanggal valid
        if (isNaN(date.getTime())) return "-";

        var bulanIndo = [
          "Januari", "Februari", "Maret", "April", "Mei", "Juni", 
          "Juli", "Agustus", "September", "Oktober", "November", "Desember"
        ];

        var tgl = date.getDate();
        var bln = date.getMonth();
        var thn = date.getFullYear();

        // Tambahkan 0 di depan jika tanggal < 10 (Contoh: 01 Januari 2025)
        var tglStr = (tgl < 10 ? '0' : '') + tgl;
        
        return tglStr + " " + bulanIndo[bln] + " " + thn;
      }

      // --- FUNGSI BUKA MODAL UTAMA ---
      function bukaModalImport(type) {
        console.log("Membuka modal import untuk: " + type); // Debugging
        
        // 1. Reset UI ke kondisi awal
        var inputTarget = document.getElementById('importTypeTarget');
        var lblTitle = document.getElementById('lblImportTitle');
        var fileInput = document.getElementById('fileImportInput');
        var progress = document.getElementById('importProgress');

        // --- [TAMBAHAN BARU] LOGIKA TAMPILKAN TOMBOL SINKRONISASI ---
        // Hanya tampil jika tipe adalah TRANSAKSI
        var blockSync = document.getElementById('blockSyncRef');
        if (blockSync) {
          if (type === 'TRANSAKSI') {
            blockSync.classList.remove('hidden'); // Tampilkan
          } else {
            blockSync.classList.add('hidden');    // Sembunyikan
          }
        }
        
        // Pastikan elemen ditemukan sebelum diakses
        if(inputTarget) inputTarget.value = type;
        if(lblTitle) lblTitle.innerText = type;
        if(fileInput) fileInput.value = "";
        if(progress) progress.classList.add('hidden');
        
        // 2. Sembunyikan dulu kedua tombol Langkah 1 (Loading State)
        var areaGen = document.getElementById('areaGenerateBtn');
        var areaView = document.getElementById('areaViewBtn');
        var btnOnline = document.getElementById('btnImportOnline');

        if(areaGen) areaGen.classList.add('hidden');
        if(areaView) areaView.classList.add('hidden');
        
        // 3. Set tombol Import Online ke mode loading
        if(btnOnline) {
          btnOnline.classList.add('disabled');
          btnOnline.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Cek Template...';
        }

        // 4. Tampilkan Modal
        var elModal = document.getElementById('modalImport');
        if(elModal) {
          var modal = new bootstrap.Modal(elModal);
          modal.show();
        }

        // 5. Cek Status Template ke Server
        var token = localStorage.getItem('userToken');
        
        google.script.run.withSuccessHandler(function(res) {
          console.log("Hasil Cek Template:", res); // Debugging
          
          // Kembalikan Teks Tombol Import
          var btnOnline = document.getElementById('btnImportOnline');
          var areaGen = document.getElementById('areaGenerateBtn');
          var areaView = document.getElementById('areaViewBtn');

          if(btnOnline) {
              btnOnline.innerHTML = '<i class="fas fa-cloud-download-alt me-2"></i> Ambil Data dari Spreadsheet Online';
          }

          if (res.status === 'success' && res.exists) {
              // KONDISI A: Template SUDAH ADA
              currentTemplateId = res.id; // Simpan ID ke variabel global
              
              if(areaGen) areaGen.classList.add('hidden');
              if(areaView) areaView.classList.remove('hidden');
              
              // Aktifkan tombol import online
              if(btnOnline) btnOnline.classList.remove('disabled'); 
              
          } else {
              // KONDISI B: Template BELUM ADA
              currentTemplateId = "";
              
              if(areaGen) areaGen.classList.remove('hidden'); // TAMPILKAN TOMBOL GENERATE
              if(areaView) areaView.classList.add('hidden');
              
              // Disable tombol import online
              if(btnOnline) btnOnline.classList.add('disabled');
          }
        }).withFailureHandler(function(err){
            // Jika error koneksi, tampilkan tombol generate agar tidak blank
            console.error("Error Cek Template:", err);
            var areaGen = document.getElementById('areaGenerateBtn');
            if(areaGen) areaGen.classList.remove('hidden');
            alert("Gagal mengecek template: " + err);
        }).checkSpreadsheetTemplate(token, type);
      }

      // --- FUNGSI GENERATE TEMPLATE ---
      function handleGenerateTemplate() {
        var type = document.getElementById('importTypeTarget').value;
        var token = localStorage.getItem('userToken');
        
        var btn = document.querySelector('#areaGenerateBtn button');
        var orgHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Membuat File...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(function(res) {
          btn.innerHTML = orgHtml;
          btn.disabled = false;
          
          if(res.status === 'success') {
            currentTemplateId = res.id;
            
            // Ubah UI menjadi Mode "Lihat Template"
            document.getElementById('areaGenerateBtn').classList.add('hidden');
            document.getElementById('areaViewBtn').classList.remove('hidden');
            document.getElementById('btnImportOnline').classList.remove('disabled');
            
            Swal.fire({
              icon: 'success',
              title: 'Template Berhasil Dibuat!',
              text: 'Silakan klik "Lihat Template", isi data disana, lalu kembali kesini untuk klik "Ambil Data".',
              confirmButtonText: 'Oke, Paham'
            });
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).generateSpreadsheetTemplate(token, type);
      }

      // --- FUNGSI LIHAT & DOWNLOAD ---
      function handleLihatTemplate() {
        if(currentTemplateId) {
          window.open("https://docs.google.com/spreadsheets/d/" + currentTemplateId + "/edit", "_blank");
        } else {
          Swal.fire('Error', 'ID Template tidak ditemukan. Coba refresh halaman.', 'error');
        }
      }

      /* --- UPDATE: DOWNLOAD TEMPLATE (VIA OFFLINE FILE UPDATE) --- */
      function handleDownloadTemplate() {
        var type = document.getElementById('importTypeTarget').value;
        var token = localStorage.getItem('userToken');

        // Tampilkan Pop-up Loading
        Swal.fire({
          title: 'Menyiapkan Template',
          html: 'Mengupdate data referensi terbaru ke dalam template Excel...<br>Mohon tunggu sebentar.',
          icon: 'info',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // 1. Ambil Data Referensi Terbaru
        google.script.run
          .withFailureHandler(function(err) {
            Swal.fire('Gagal', 'Koneksi error: ' + err.message, 'error');
          })
          .withSuccessHandler(function(resRef) {
            if (resRef.status === 'success') {
              var refData = resRef.data;

              // 2. Request Server: Update File Offline Existing (Bukan Buat Baru)
              google.script.run
                .withFailureHandler(function(err) {
                  Swal.fire('Gagal', 'Gagal update template: ' + err.message, 'error');
                })
                .withSuccessHandler(function(resGen) {
                  if (resGen.status === 'success') {
                    
                    // 3. Download File (Export URL)
                    var downloadUrl = "https://docs.google.com/spreadsheets/d/" + resGen.id + "/export?format=xlsx";
                    window.open(downloadUrl, "_blank");

                    // 4. Update Pop-up
                    Swal.fire({
                      icon: 'success',
                      title: 'Download Berjalan',
                      text: 'Template Excel dengan data terbaru sedang didownload.',
                      timer: 2000,
                      showConfirmButton: false
                    });

                  } else {
                    Swal.fire('Gagal', resGen.message, 'error');
                  }
                })
                .prepareOfflineTemplate(token, type, refData); // <-- PANGGIL FUNGSI BARU

            } else {
              Swal.fire('Gagal', resRef.message, 'error');
            }
          })
          .getTemplateRefData(token);
      }

      /* --- PERBAIKAN IMPORT ONLINE (SINKRONISASI & REFRESH) --- */
      function handleImportOnline() {
        var type = document.getElementById('importTypeTarget').value;
        var token = localStorage.getItem('userToken');

        // Validasi ID Template
        if (!currentTemplateId) {
          Swal.fire('Error', 'ID Template tidak ditemukan. Silakan klik "Generate Template" atau "Lihat Template" terlebih dahulu.', 'error');
          return;
        }

        Swal.fire({
          title: 'Ambil Data Online?',
          text: "Sistem akan membaca data dari Spreadsheet Template Anda dan menyimpannya ke database aplikasi.",
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#0d6efd',
          confirmButtonText: '<i class="fas fa-cloud-download-alt me-1"></i> Ya, Ambil Data',
          cancelButtonText: 'Batal'
        }).then((result) => {
          if (result.isConfirmed) {
            // 1. Tampilkan Loading Bar
            document.getElementById('importProgress').classList.remove('hidden');
            document.getElementById('btnImportOnline').disabled = true;

            // 2. Panggil Server
            google.script.run
              .withFailureHandler(function(err) {
                document.getElementById('importProgress').classList.add('hidden');
                document.getElementById('btnImportOnline').disabled = false;
                Swal.fire('Gagal', err.message, 'error');
              })
              .withSuccessHandler(function(res) {
                document.getElementById('importProgress').classList.add('hidden');
                document.getElementById('btnImportOnline').disabled = false;

                if(res.status === 'success') {
                  
                  // A. [PENTING] Hapus Cache Lama
                  invalidateCacheByType(type);

                  // B. Tutup Modal
                  var elModal = document.getElementById('modalImport');
                  if(typeof bootstrap !== 'undefined' && elModal) {
                    var modal = bootstrap.Modal.getInstance(elModal);
                    if(modal) modal.hide();
                  }

                  // C. Tampilkan Pesan Sukses & Refresh UI
                  Swal.fire({ 
                    icon: 'success', 
                    title: 'Berhasil Diambil!', 
                    html: res.message || `Data ${type} dari template online berhasil disimpan.`,
                    timer: 2000,
                    showConfirmButton: false
                  }).then(() => {
                    // D. Refresh Dashboard jika Transaksi
                    if(type === 'TRANSAKSI') {
                        loadDashboardStats(true);
                    }
                    
                    // E. Opsional: Jika Anda ingin langsung melihat datanya,
                    // Anda bisa memanggil navigasiKe('panel-toko') misal, tapi
                    // membiarkan user tetap di halaman Import biasanya lebih baik.
                  });

                } else {
                  Swal.fire({ icon: 'error', title: 'Gagal', html: res.message });
                }
              })
              .processExcelData(token, "ONLINE_TEMPLATE", currentTemplateId, type); 
              // Catatan: Pastikan di Google Apps Script (Kode.gs), fungsi processExcelData 
              // sudah mendukung logika jika parameter ke-2 (data) adalah "ONLINE_TEMPLATE".
              // ATAU gunakan fungsi khusus importDataFromSpreadsheet jika Anda memilikinya.
          }
        });
      }

      /* --- FUNGSI SINKRONISASI REFERENSI --- */
      function jalankanSyncRef() {
        const token = localStorage.getItem('userToken');
        const btn = document.getElementById('btnSyncRef');
        const originalText = btn.innerHTML;
        
        // Ubah tombol jadi loading
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Proses...';
        btn.disabled = true;
        
        google.script.run
          .withFailureHandler(function(err) {
            handleServerError(err);
            btn.innerHTML = originalText;
            btn.disabled = false;
          })
          .withSuccessHandler(function(res) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            if (res.status === 'success') {
              Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: res.message,
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Gagal',
                text: res.message
              });
            }
          })
          .sinkronisasiRef(token);
      }

      /* --- FUNGSI BARU: POPULASI TAHUN ANGGARAN (DIPERBAIKI & AMAN INCOGNITO) --- */
      function populateLoginYears() {
        const select = document.getElementById('loginTahun');
        if (!select) return;

        const now = new Date();
        const currentYear = now.getFullYear(); // Tahun Komputer (misal: 2026)
        const currentMonth = now.getMonth() + 1; // 1-12

        // 1. Tentukan batas tahun maksimal
        // Logika: Start 2025. Jika masuk bulan 7 (Juli) ke atas, munculkan opsi tahun depan (RKAM).
        let maxYear = currentYear;
        if (currentMonth >= 7) {
          maxYear = currentYear + 1;
        }
        
        const startYear = 2025;
        if (maxYear < startYear) maxYear = startYear; // Validasi safety

        // 2. Ambil Tahun Terakhir Login dari Cache (Dengan Penanganan Error Incognito)
        let savedYear = null;
        try {
          savedYear = localStorage.getItem('userYear');
        } catch (e) {
          console.warn("Akses LocalStorage diblokir (Mode Incognito/Privasi):", e);
          // Abaikan error, biarkan savedYear null
        }

        // Bersihkan opsi lama
        select.innerHTML = '';

        // 3. Loop membuat opsi dropdown (2025, 2026, dst)
        for (let y = startYear; y <= maxYear; y++) {
          const opt = document.createElement('option');
          opt.value = y;
          opt.text = y;

          // --- LOGIKA PEMILIHAN (DEFAULT SELECTION) ---
          // Skenario A: Jika ada data di cache & cocok dengan opsi ini -> Pilih itu
          if (savedYear && parseInt(savedYear) === y) {
            opt.selected = true;
          } 
          // Skenario B: Jika cache kosong (Incognito/Login Pertama) -> Pilih Tahun Berjalan (currentYear)
          // Pastikan hanya terset jika savedYear tidak valid/tidak ada
          else if (!savedYear && y === currentYear) {
            opt.selected = true;
          }

          select.appendChild(opt);
        }
        
        // Fallback Terakhir: Jika tidak ada yang terpilih sama sekali (misal tahun komputer < 2025), 
        // pilih opsi terakhir (tahun terbaru)
        if (select.selectedIndex === -1 && select.options.length > 0) {
          select.selectedIndex = select.options.length - 1;
        }
      }

      /* --- FUNGSI UPDATE TAMPILAN TAHUN DI SIDEBAR --- */
      function updateTampilanTahun() {
        const year = localStorage.getItem('userYear'); // Ambil tahun dari login
        const el = document.getElementById('sidebarLabelTahun');
        
        if (el) {
          if (year && year !== 'undefined') {
            el.innerText = "Tahun " + year;
          } else {
            el.innerText = "Versi 1.0"; // Fallback jika tahun tidak ditemukan
          }
        }
      }

      /* --- PERBAIKAN LOGIKA IMPORT & REFRESH DATA OTOMATIS --- */

      function handleImportFile() {
        // 1. Ambil Elemen Input
        const fileInput = document.getElementById('fileImportInput');
        const typeEl = document.getElementById('importTypeTarget');
        
        if (!fileInput || !typeEl) return;
        
        const type = typeEl.value; // Tipe: 'TRANSAKSI', 'TOKO', dll
        const token = localStorage.getItem('userToken');

        // 2. Validasi File
        if (fileInput.files.length === 0) {
          Swal.fire('Peringatan', 'Silakan pilih file Excel (.xlsx) terlebih dahulu.', 'warning');
          return;
        }

        const file = fileInput.files[0];
        
        // 3. Tampilkan Loading Bar
        const progressEl = document.getElementById('importProgress');
        if(progressEl) progressEl.classList.remove('hidden');

        // 4. Baca File Excel
        const reader = new FileReader();
        reader.onload = function(e) {
          const rawBase64 = e.target.result.split(',')[1]; // Ambil konten base64 murni
          
          // 5. Kirim ke Backend (Google Apps Script)
          google.script.run
            .withFailureHandler(function(err) {
              if(progressEl) progressEl.classList.add('hidden');
              Swal.fire('Error Server', err.message, 'error');
            })
            .withSuccessHandler(function(res) {
              if(progressEl) progressEl.classList.add('hidden');
              
              if (res.status === 'success') {
                // A. Reset Input File agar bersih
                fileInput.value = '';

                // B. [PENTING] HAPUS CACHE LAMA AGAR DATA TERBARU MUNCUL
                invalidateCacheByType(type);

                // C. Tutup Modal Import
                const elModal = document.getElementById('modalImport');
                if(typeof bootstrap !== 'undefined' && elModal) {
                  const modal = bootstrap.Modal.getInstance(elModal);
                  if(modal) modal.hide();
                }

                // D. Tampilkan Pesan Sukses
                Swal.fire({ 
                  icon: 'success', 
                  title: 'Import Berhasil!', 
                  html: res.message || `Data ${type} berhasil disimpan ke database.`,
                  timer: 2000,
                  showConfirmButton: false
                }).then(() => {
                  // E. Opsional: Jika Transaksi, langsung refresh Dashboard angka-angkanya
                  if(type === 'TRANSAKSI') {
                      loadDashboardStats(true); // true = paksa ambil dari server
                  }
                });

              } else {
                Swal.fire({ icon: 'error', title: 'Gagal Import', html: res.message });
              }
            })
            .processExcelData(token, rawBase64, file.name, type);
        };
        
        reader.readAsDataURL(file);
      }

      /* --- FUNGSI BARU: PENGHAPUS CACHE CERDAS --- */
      // Fungsi ini bertugas mengosongkan variabel penyimpanan sementara
      // sehingga saat menu diklik, aplikasi terpaksa mengambil data baru dari server.
      function invalidateCacheByType(type) {
        // 1. Dashboard selalu direfresh karena jumlah data/anggaran pasti berubah
        DATA_CACHE.dashboard = null; 

        // 2. Refresh Sesuai Tipe yang Diupload
        if (type === 'TOKO') {
          DATA_CACHE.toko = null;           // List Toko Master
          DATA_CACHE.transaksi_toko = null; // Riwayat Transaksi Toko (karena nama toko mungkin update)
        } 
        else if (type === 'TUKANG') {
          DATA_CACHE.tukang = null;
          DATA_CACHE.transaksi_tukang = null;
        } 
        else if (type === 'GURU') {
          DATA_CACHE.guru = null;
          DATA_CACHE.transaksi_guru = null;
          cacheDataGuru = []; // Reset variabel global legacy (jika masih dipakai)
        }
        else if (type === 'URAIAN') {
          DATA_CACHE.uraian = null;
          cacheUserUraian = []; // Reset autocomplete uraian
        }
        else if (type === 'TRANSAKSI') {
          // Jika import Transaksi, maka SEMUA riwayat belanja berubah
          DATA_CACHE.transaksi_toko = null;
          DATA_CACHE.transaksi_tukang = null;
          DATA_CACHE.transaksi_guru = null;
          
          // Surat & Tanggal juga ikut berubah karena data transaksi bertambah
          // (Asumsi: Anda mungkin ingin reset ini juga jika ada cache-nya)
        }
      }

      // --- FUNGSI POPUP KHUSUS STATUS DOKUMEN (UPDATE: TOMBOL KELOLA TANGGAL) ---
      function lihatStatusDokumen(encodedData) {
        const data = JSON.parse(decodeURIComponent(encodedData));
        const s = data.dataSurat || {};
        const t = data.dataTanggal || {};

        // Helper Format Tanggal
        const fmtDate = (dStr) => {
          if(!dStr) return '<span class="badge bg-light text-muted fw-normal border">Kosong</span>';
          const d = new Date(dStr);
          if(isNaN(d.getTime())) return '-';
          const dd = String(d.getDate()).padStart(2, '0');
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const yyyy = d.getFullYear();
          return `<span class="fw-bold text-dark font-monospace">${dd}-${mm}-${yyyy}</span>`;
        };

        // Helper Format Nomor
        const fmtNo = (val) => {
          return val ? `<span class="fw-bold text-primary font-monospace">${val}</span>` 
                    : '<span class="badge bg-secondary bg-opacity-10 text-secondary fw-normal border">Belum diisi</span>';
        };

        // Helper Cek Status Baris (Icon Checklist)
        const cekIcon = (no, tgl) => {
          if(no && tgl) return '<i class="fas fa-check-circle text-success"></i>';
          if(!no && !tgl) return '<i class="fas fa-times-circle text-secondary opacity-25"></i>';
          return '<i class="fas fa-exclamation-circle text-warning"></i>';
        };

        // List Dokumen
        let docs = [
          { label: 'Surat Permintaan', key: 'permintaan' },
          ...(data.tipe === 'TOKO' ? [{ label: 'Surat Penawaran', key: 'penawaran' }] : []),
          { label: 'BA Pemeriksaan', key: 'baPemeriksaan' },
          { label: 'BA Serah Terima', key: 'baSerahTerima' },
          { label: 'BA Pembayaran', key: 'baPembayaran' }
        ];

        let htmlTable = `
          <div class="mb-2 text-start">
            <small class="text-muted fw-bold">TRANSAKSI:</small><br>
            <span class="fw-bold text-dark">${data.uraian}</span>
          </div>
          <div class="table-responsive border rounded">
            <table class="table table-bordered table-sm align-middle mb-0" style="font-size: 0.85rem;">
              <thead class="bg-light text-center">
                <tr>
                  <th width="5%">Sts</th>
                  <th class="text-start">Jenis Dokumen</th>
                  <th>Tanggal</th>
                  <th>Nomor Surat</th>
                </tr>
              </thead>
              <tbody>
        `;

        let totalLengkap = 0;

        docs.forEach(doc => {
          const noVal = s[doc.key];
          const tglVal = t[doc.key];
          const isOk = (noVal && tglVal);
          if(isOk) totalLengkap++;

          htmlTable += `
            <tr>
              <td class="text-center">${cekIcon(noVal, tglVal)}</td>
              <td class="fw-bold text-secondary text-start">${doc.label}</td>
              <td class="text-center">${fmtDate(tglVal)}</td>
              <td class="text-start">${fmtNo(noVal)}</td>
            </tr>
          `;
        });

        htmlTable += `</tbody></table></div>`;

        // Status Summary Alert
        let alertHtml = '';
        if (totalLengkap === docs.length) {
          alertHtml = `<div class="alert alert-success py-2 px-3 mb-3 d-flex align-items-center"><i class="fas fa-check-circle fa-2x me-3"></i><div><strong>Dokumen Lengkap!</strong><br><small>Semua nomor dan tanggal telah terisi.</small></div></div>`;
        } else if (totalLengkap === 0) {
          alertHtml = `<div class="alert alert-secondary py-2 px-3 mb-3 d-flex align-items-center"><i class="fas fa-info-circle fa-2x me-3"></i><div><strong>Belum Ada Data</strong><br><small>Silakan atur nomor dan tanggal surat.</small></div></div>`;
        } else {
          alertHtml = `<div class="alert alert-warning py-2 px-3 mb-3 d-flex align-items-center"><i class="fas fa-exclamation-triangle fa-2x me-3"></i><div><strong>Data Belum Lengkap</strong><br><small>${totalLengkap} dari ${docs.length} dokumen terisi.</small></div></div>`;
        }

        Swal.fire({
          title: 'Status Dokumen',
          html: alertHtml + htmlTable,
          width: '650px',
          showCloseButton: true,
          showConfirmButton: true,
          confirmButtonText: '<i class="fas fa-edit me-1"></i> Kelola Surat', // Tombol 1
          showDenyButton: true,
          denyButtonText: '<i class="fas fa-calendar-alt me-1"></i> Kelola Tanggal', // Tombol 2 (Baru)
          denyButtonColor: '#198754', // Warna Hijau agar beda
          showCancelButton: true,
          cancelButtonText: 'Tutup',
          focusConfirm: false
        }).then((result) => {
          // Tentukan Tab Target (Toko/Tukang)
          const targetTab = (data.tipe === 'TOKO') ? 'toko' : 'tukang';

          if (result.isConfirmed) {
            // --- AKSI: KELOLA SURAT ---
            navigasiKe('panel-nomor-surat', document.querySelector("a[onclick*='panel-nomor-surat']"));
            setTimeout(() => {
              bukaTabSurat(targetTab);
            }, 500);

          } else if (result.isDenied) {
            // --- AKSI: KELOLA TANGGAL (BARU) ---
            navigasiKe('panel-tanggal-surat', document.querySelector("a[onclick*='panel-tanggal-surat']"));
            setTimeout(() => {
              bukaTabTanggal(targetTab);
            }, 500);
          }
        });
      }

      // 2. Update Fungsi Toggle Mode Hapus
      function toggleModeHapus(tipe) {
        STATE_HAPUS[tipe] = !STATE_HAPUS[tipe];
        
        // Jika keluar mode hapus, reset pilihan
        if (!STATE_HAPUS[tipe]) {
          SELECTED_IDS[tipe].clear();
          updateTombolHapus(tipe);
        }

        // Render Ulang Tabel menggunakan Cache (Cepat)
        const cacheKey = 'transaksi_' + tipe;
        const tbodyId = (tipe === 'toko') ? 'listTransaksiToko' : (tipe === 'tukang') ? 'listTransaksiTukang' : 'listTransaksiGuru';
        const tbody = document.getElementById(tbodyId);

        if (DATA_CACHE[cacheKey]) {
          renderRiwayatTransaksi(DATA_CACHE[cacheKey], tipe, tbody);
        } else {
          // Jika cache hilang, load ulang dari server
          loadTransaksiData(tipe.toUpperCase()); 
        }
      }

      // 3. Fungsi Select All (Pilih Semua di Header)
      function toggleSelectAll(tipe, el) {
        const isChecked = el.checked;
        const data = DATA_CACHE['transaksi_' + tipe];
        
        if (!data) return;
        
        if (isChecked) {
          data.forEach(item => SELECTED_IDS[tipe].add(item.id));
        } else {
          SELECTED_IDS[tipe].clear();
        }
        
        // Refresh UI
        updateTombolHapus(tipe);
        
        // Re-render body saja untuk update centang (Header tidak perlu dirender ulang)
        const tbodyId = (tipe === 'toko') ? 'listTransaksiToko' : (tipe === 'tukang') ? 'listTransaksiTukang' : 'listTransaksiGuru';
        const tbody = document.getElementById(tbodyId);
        renderRiwayatTransaksi(data, tipe, tbody);
        
        // Kembalikan status checkbox header (karena re-render akan me-resetnya)
        setTimeout(() => {
            const headerCheck = tbody.parentElement.querySelector('thead input[type="checkbox"]');
            if(headerCheck) headerCheck.checked = isChecked;
        }, 50);
      }

      // 4. (Opsional) Mapping fungsi lama agar tidak error jika ada sisa panggilan
      const renderTabelRiwayat = renderRiwayatTransaksi;

      // 2. Fungsi Handle Klik Checkbox
      function handleCheck(tipe, id) {
        const set = SELECTED_IDS[tipe];
        if (set.has(id)) {
          set.delete(id);
        } else {
          set.add(id);
        }
        updateTombolHapus(tipe);
      }

      // 3. Update Tampilan Tombol Hapus Merah
      function updateTombolHapus(tipe) {
        const count = SELECTED_IDS[tipe].size;
        const btn = document.getElementById('btnAksiHapus_' + tipe);
        const span = document.getElementById('count_' + tipe);
        
        if (count > 0) {
          btn.classList.remove('hidden');
          span.innerText = count;
        } else {
          btn.classList.add('hidden');
        }
      }

      // 4. Eksekusi Hapus ke Server
      /* --- FUNGSI EKSEKUSI HAPUS BANYAK (UPDATE) --- */
      function eksekusiHapusBanyak(tipe) {
        const listId = Array.from(SELECTED_IDS[tipe]);
        
        if (listId.length === 0) return;

        Swal.fire({
          title: 'Hapus ' + listId.length + ' Data?',
          text: "Data yang dihapus tidak dapat dikembalikan!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: 'Ya, Hapus'
        }).then((result) => {
          if (result.isConfirmed) {
            const token = localStorage.getItem('userToken');
            
            toggleLoading(true, "Menghapus data..."); // Tampilkan loading overlay

            google.script.run
              .withFailureHandler(handleServerError)
              .withSuccessHandler(function(res) {
                toggleLoading(false); // Sembunyikan loading
                
                if (res.status === 'success') {
                  // 1. Bersihkan daftar pilihan (Centang)
                  SELECTED_IDS[tipe].clear();
                  
                  // 2. Matikan mode hapus (Opsional, agar kembali bersih)
                  STATE_HAPUS[tipe] = false;
                  updateTombolHapus(tipe); // Sembunyikan tombol hapus merah di header

                  // 3. PENTING: Kosongkan Cache agar sistem tidak memuat data lama
                  DATA_CACHE['transaksi_' + tipe] = null; 

                  // 4. Tampilkan pesan sukses
                  Swal.fire('Berhasil', res.message, 'success');

                  // 5. PENTING: Muat Ulang Data Tabel dari Server
                  // Fungsi ini akan mengambil data terbaru dan merender ulang tabel
                  if (typeof loadTransaksiData === 'function') {
                      loadTransaksiData(tipe.toUpperCase()); 
                  } else {
                      console.error("Fungsi loadTransaksiData tidak ditemukan");
                      // Fallback reload halaman jika fungsi tidak ada
                      location.reload(); 
                  }
                  
                } else {
                  Swal.fire('Gagal', res.message, 'error');
                }
              })
              .hapusBanyakTransaksi(token, JSON.stringify(listId));
          }
        });
      }

      // [FUNGSI BARU] Logika Pengecekan Pop-up
      function cekPopUpAnggaran(nilaiAnggaran) {
        // Hanya jalankan jika:
        // 1. User baru saja login (isLoginFlow == true)
        // 2. Anggaran kosong, null, atau 0
        if (isLoginFlow && (!nilaiAnggaran || nilaiAnggaran === 0)) {
          
          // Tampilkan Modal
          const modal = new bootstrap.Modal(document.getElementById('modalInputAnggaran'));
          modal.show();
          
          // Reset flag agar pop-up tidak muncul lagi saat reload halaman / pindah menu
          isLoginFlow = false; 
        } else {
          // Jika anggaran sudah ada, pastikan flag dimatikan juga
          isLoginFlow = false;
        }
      }

      // [FUNGSI BARU] Simpan dari Pop-up
      function submitAnggaranPopup() {
        const token = localStorage.getItem('userToken');
        const inputVal = document.getElementById('inputAnggaranPopup').value;
        const jumlah = cleanRibuan(inputVal); // Menggunakan helper cleanRibuan yg sudah ada

        if (jumlah <= 0) {
          Swal.fire('Warning', 'Mohon masukkan jumlah anggaran yang valid.', 'warning');
          return;
        }

        // Efek Loading Tombol
        const btn = document.getElementById('btnSimpanAnggaranPopup');
        const oriHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
        btn.disabled = true;

        google.script.run
          .withFailureHandler(function(err){
            btn.innerHTML = oriHtml; btn.disabled = false;
            Swal.fire('Error', err.message, 'error');
          })
          .withSuccessHandler(function(res){
            btn.innerHTML = oriHtml; btn.disabled = false;
            
            if(res.status === 'success') {
              // 1. Tutup Modal
              const el = document.getElementById('modalInputAnggaran');
              const modal = bootstrap.Modal.getInstance(el);
              if(modal) modal.hide();

              // 2. Refresh Data Dashboard & Data Sekolah (Cache Invalidate)
              DATA_CACHE.dashboard = null;
              DATA_CACHE.sekolah = null;
              
              // 3. Muat Ulang Dashboard untuk update tampilan angka
              loadDashboardStats(true);
              
              Swal.fire({
                icon: 'success', 
                title: 'Berhasil', 
                text: 'Anggaran berhasil disimpan!',
                timer: 1500,
                showConfirmButton: false
              });
            } else {
              Swal.fire('Gagal', res.message, 'error');
            }
          })
          .updateAnggaranCepat(token, jumlah);
      }

    </script>
  </body>
</html>
